<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ğŸ¶äº’å‹•éŸ³ç¬¦</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700&display=swap" rel="stylesheet">

  <style>
    /* ====================== å¤–è§€æ¨£å¼ï¼ˆä½ èƒ½æ”¹çš„æˆ‘éƒ½æœ‰è¨»è¨˜ï¼‰ ====================== */
    :root{
      --brand:#D4BFAA; --title:#A68A7C; --neutral:#E4E4E4; --soft:#F5F1EC; --accent:#BFA5A0; --rim:#E4E4E4; --ink:#0f172a;
      --w-displayName: 220px; --w-instrument:96px; --w-lastNote:160px; --w-lastNote-m:180px;
      --label-w:88px; --gap:10px; --kb-h:280px; --sep:2px;
      --stroke:rgba(0,0,0,.18); --glow:rgba(255,255,255,.65);
      --w-hintbtn:160px; --hint-fz:12px; --hint-maxw:520px;
      --action-w-desk:108px; --action-h:38px; --action-gap-narrow:6px;
    }

    *{ box-sizing:border-box; font-family:"Zen Maru Gothic","Noto Sans TC",system-ui,-apple-system,sans-serif !important; -webkit-text-stroke:.35px var(--stroke); text-shadow:0 1px 0 var(--glow); }
    html,body{ margin:0; color:var(--ink); background:var(--brand); font-weight:700; }
    #guideOverlay .dialog, #guideOverlay .dialog *{ font-weight:500 !important; -webkit-text-stroke:0 !important; text-shadow:none !important; }

    .bg-notes{ position:fixed; inset:0; width:100%; height:100%; object-fit:cover; opacity:.60; mix-blend-mode:multiply; filter:contrast(1.1); pointer-events:none; z-index:0; }
    .panel{ position:relative; z-index:1; max-width:1060px; margin:22px auto; background:var(--neutral); border:1px solid var(--neutral);
            border-radius:16px; padding:18px 18px 26px; box-shadow:0 10px 26px rgba(0,0,0,.10); backdrop-filter:blur(8px) saturate(115%); }
    h2{ margin:4px 0 20px; text-align:center; font-size:2.8rem; font-weight:700; letter-spacing:1px; color:var(--title);
        -webkit-text-stroke:.6px rgba(0,0,0,.12); text-shadow:0 3px 4px rgba(255,255,255,.75); }

    .row{ display:flex; gap:var(--gap); align-items:center; flex-wrap:wrap; margin-top:10px; }
    .row label{ width:var(--label-w); opacity:.92; white-space:nowrap; font-weight:700; -webkit-text-stroke:0; text-shadow:none; }
    .row input,.row select,.row button{
      height:38px; font-size:14px; background:#fff; padding:8px 10px; border:1px solid var(--rim); border-radius:10px;
      -webkit-text-stroke:.25px rgba(0,0,0,.12); text-shadow:0 1px 0 rgba(255,255,255,.5);
    }
    .row input,.row select{ box-shadow: 0 2px 0 rgba(0,0,0,.08), 0 2px 8px rgba(0,0,0,.04); }

    #displayName{ width:var(--w-displayName); }
    #instrument{  width:var(--w-instrument); }
    #lastNote{ width:var(--w-lastNote); text-align:center; letter-spacing:.3px; }
    #lastNote::placeholder{ text-align:center; }

    @media (min-width: 861px){ .align-to-email{ margin-left: 0; } }

    .row button{ width:120px; cursor:pointer; font-weight:700; transition: transform .08s ease, box-shadow .08s ease, filter .08s ease;
                 box-shadow: 0 2px 0 rgba(0,0,0,.15), 0 2px 8px rgba(0,0,0,.06); }
    .btn-compact{ width:60px !important; }
    #hintBtn{ width: var(--w-hintbtn) !important; }
    #helpBtn{ width: var(--w-hintbtn) !important; }

    .row button:disabled{ opacity:.55; cursor:not-allowed; }
    .row button:active, .row button.pressed{ transform: translateY(1px) scale(.99); box-shadow: 0 1px 0 rgba(0,0,0,.18), 0 1px 4px rgba(0,0,0,.06); filter: brightness(.98); }

    #status{
      background: var(--soft); border:1px solid var(--neutral); border-radius:12px; padding:10px; margin-top:10px; font-size:14px; white-space:pre-wrap;
      text-align:center; color: var(--accent) !important; font-weight:700; -webkit-text-stroke:.35px rgba(0,0,0,.10);
      text-shadow:0 1px 0 rgba(255,255,255,.85), 0 3px 6px rgba(0,0,0,.04);
    }
    #status.ok,#status.busy,#status.err{ color: var(--accent) !important; font-weight:700; -webkit-text-stroke:.35px rgba(0,0,0,.10);
                                         text-shadow:0 1px 0 rgba(255,255,255,.85), 0 3px 6px rgba(0,0,0,.04); }

    .actions-inline{ display:flex; gap:var(--gap); position:relative; }
    .hint-popover{ position:absolute; right:0; top:44px; z-index:50; max-width: var(--hint-maxw); min-width: 260px; padding:10px 12px; font-size:var(--hint-fz);
                   line-height:1.45; color:var(--accent); background:#fff; border:1px solid var(--accent); border-radius:12px;
                   box-shadow:0 8px 24px rgba(0,0,0,.10), 0 2px 8px rgba(0,0,0,.06); display:none; white-space:normal; --arrow-x: calc(100% - 24px); }
    .hint-popover.show{ display:block; }
    .hint-popover::before{ content:""; position:absolute; left:var(--arrow-x); top:-8px; transform:translateX(-50%); width:0; height:0;
      border-left:8px solid transparent; border-right:8px solid transparent; border-bottom:8px solid var(--accent); }
    .hint-popover::after{ content:""; position:absolute; left:var(--arrow-x); top:-7px; transform:translateX(-50%); width:0; height:0;
      border-left:7px solid transparent; border-right:7px solid transparent; border-bottom:7px solid #fff; }

    .kb-wrap{ overflow-x:auto; -webkit-overflow-scrolling:touch; background:var(--soft); border:1px solid var(--rim); border-radius:14px; margin-top:14px; }
    #keyboard{ position:relative; height:var(--kb-h); user-select:none; -webkit-user-select:none; touch-action: pan-x pan-y; }

    .white{ position:absolute; bottom:0; height:100%; background:linear-gradient(#ffffff,#eceef3 72%,#d9dde5);
      border-radius:0 0 12px 12px; box-shadow:inset 0 -12px 16px rgba(0,0,0,.12), inset 0 1px 0 rgba(255,255,255,.9), 0 1px 0 rgba(0,0,0,.04); }
    .white::after{ content:""; position:absolute; top:0; bottom:0; right:0; width:var(--sep); background:linear-gradient(transparent,#cfd3dc 50%,transparent); }
    .white:first-child::before{ content:""; position:absolute; top:0; bottom:0; left:0; width:var(--sep); background:linear-gradient(transparent,#cfd3dc 50%,transparent); }
    .white.active{ filter:brightness(1.06); }

    .black{ position:absolute; bottom:38%; height:62%; background:linear-gradient(#2d2f36,#0e0f13);
      border:1px solid #0b0d11; border-top:none; border-radius:0 0 10px 10px; z-index:5; box-shadow:inset 0 -6px 10px rgba(0,0,0,.45), 0 3px 10px rgba(0,0,0,.35);
      transform: translateX(-50%); }
    .black.active{ filter:brightness(1.22); }

    .fretboard{ position:relative; display:grid; grid-template-columns: repeat(13, 1fr);
      width:100%; height:var(--kb-h); background:linear-gradient(180deg,#6b4f2e 0%, #5b4429 50%, #533c24 100%);
      border-radius:12px; box-shadow:inset 0 10px 20px rgba(0,0,0,.25), inset 0 -8px 16px rgba(0,0,0,.2); }
    .head{ position:absolute; left:0; top:0; bottom:0; width:86px; z-index:2; background:linear-gradient(180deg, rgba(0,0,0,.12), transparent 40%),linear-gradient(180deg,#7a5534 0%, #6b4f2e 55%, #5a3f24 100%); box-shadow: inset -8px 0 16px rgba(0,0,0,.18); border-radius:12px 0 0 12px; pointer-events:none; }
    .nut{ position:absolute; left:86px; top:0; bottom:0; width:8px; z-index:3; background:linear-gradient(180deg,#e5e1d6,#c9c5ba); box-shadow: inset -1px 0 0 rgba(0,0,0,.35), inset 1px 0 0 rgba(255,255,255,.6); border-right:2px solid rgba(120,120,120,.5); pointer-events:none; }
    .bridge{ position:absolute; right:0; top:0; bottom:0; width:10px; z-index:2; background:linear-gradient(180deg,#b9b6ad,#8f8c83); box-shadow: inset 1px 0 0 rgba(255,255,255,.5), inset -1px 0 0 rgba(0,0,0,.25); pointer-events:none; border-left:1px solid rgba(0,0,0,.18); }
    .fret-col{ position:relative; background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.02)); box-shadow: inset -2px 0 0 rgba(255,255,255,.18), inset -4px 0 0 rgba(0,0,0,.28); }

    .string{ --sw:2px; position:absolute; left:94px; right:0; height:0; z-index:3; border-top: var(--sw) solid transparent; transform-origin:center; filter:drop-shadow(0 1px 0 rgba(0,0,0,.18));
      background: linear-gradient(90deg, rgba(255,255,255,0) 0%, rgba(255,255,255,.45) 50%, rgba(255,255,255,0) 100%); background-size:160px 1px; background-repeat:no-repeat; background-position:-160px 0; }
    .string::before{ content:""; position:absolute; left:0; right:0; top: calc(var(--sw) * -0.5); height: var(--sw);
      background: repeating-linear-gradient(90deg, #caa56b 0 2.4px, #906a3d 2.4px 3.1px), repeating-linear-gradient(90deg, rgba(255,255,255,.08) 0 2.4px, rgba(0,0,0,.10) 2.4px 3.1px), linear-gradient(180deg, rgba(255,255,255,.70), rgba(255,255,255,.15) 55%, rgba(0,0,0,.18) 100%);
      border-radius:999px; opacity:.98; pointer-events:none; }
    .string::after{ content:""; position:absolute; left:0; right:0; top: calc(var(--sw) * -0.5 + 0.2px); height: calc(var(--sw) * .25);
      background: linear-gradient(180deg, rgba(255,255,255,.55), rgba(255,255,255,0)); pointer-events:none; border-radius:999px; opacity:.9; }
    .string[data-s="2"]{ --sw:2.5px; } .string[data-s="3"]{ --sw:3px; } .string[data-s="4"]{ --sw:3.5px; } .string[data-s="5"]{ --sw:4px; }

    .head-line{ --sw:2px; position:absolute; left:0; width:86px; height:0; z-index:2; border-top: var(--sw) solid transparent; filter:drop-shadow(0 1px 0 rgba(0,0,0,.06)); pointer-events:none; }
    .head-line::before{ content:""; position:absolute; left:0; right:0; top: calc(var(--sw) * -0.5); height: var(--sw);
      background: repeating-linear-gradient(90deg, #caa56b 0 2.4px, #906a3d 2.4px 3.1px), repeating-linear-gradient(90deg, rgba(255,255,255,.08) 0 2.4px, rgba(0,0,0,.10) 2.4px 3.1px), linear-gradient(180deg, rgba(255,255,255,.55), rgba(255,255,255,0));
      border-radius:999px; opacity:.98; }
    .head-line::after{ content:""; position:absolute; left:0; right:0; top: calc(var(--sw) * -0.5 + 0.2px); height: calc(var(--sw) * .25); background: linear-gradient(180deg, rgba(255,255,255,.55), rgba(255,255,255,0)); border-radius:999px; opacity:.9; }
    .head-line[data-s="2"]{ --sw:2.5px; } .head-line[data-s="3"]{ --sw:3px; } .head-line[data-s="4"]{ --sw:3.5px; } .head-line[data-s="5"]{ --sw:4px; }

    .hit-row{ position:absolute; left:0; right:0; height:28px; transform:translateY(-50%); background:transparent; cursor:pointer; z-index:4; }
    @media (pointer:coarse){ .hit-row{ height:34px; } }
    .string.vibrate{ animation: vibrCurve 360ms ease-out, shine 360ms ease-out; }
    @keyframes vibrCurve{ 0%{transform:translateY(0)} 10%{transform:translateY(-3.2px)} 20%{transform:translateY(0)} 30%{transform:translateY(2.6px)} 45%{transform:translateY(0)} 60%{transform:translateY(-1.8px)} 75%{transform:translateY(0.6px)} 100%{transform:translateY(0)} }
    @keyframes shine{ 0%{ background-position:-160px 0; opacity:.95 } 100%{ background-position:160px 0; opacity:.96 } }

    .overlay{ position:fixed; inset:0; z-index:9999; display:flex; align-items:center; justify-content:center; background:rgba(17,24,39,.35); backdrop-filter:blur(3px); pointer-events:auto; }
    .overlay.hidden{ display:none; }
    .dialog{ min-width:300px; max-width:92vw; background:var(--soft); border:1px solid var(--neutral); border-radius:14px; padding:18px;
             box-shadow:0 18px 44px rgba(0,0,0,.18); text-align:center; pointer-events:auto; }
    .dialog h3{ margin:0 0 8px; font-size:18px; color:#6b5e52; }
    .dialog .actions{ display:flex; gap:10px; justify-content:center; margin-top:12px; }
    .dialog button{ width:120px; height:38px; border-radius:10px; border:1px solid var(--rim); background:#fff; cursor:pointer; font-weight:700; font-size:16px; }
    .dialog button.primary{ background:#fff; }

    #lockScreen{ position:fixed; inset:0; z-index:9998; display:none; background:transparent; }
    footer{ max-width:1060px;margin:8px auto 22px; text-align:center; color:#6b5e52; font-size:12px; opacity:.9; }

    /* ====================== æ‰‹æ©Ÿç›´å‘ï¼ˆä¸æ›´å‹•ï¼‰ ====================== */
    @media (orientation:portrait){
      .row-line2{
        display:grid;
        grid-template-areas:
          "nick nick"
          "inst note"
          "acts acts";
        grid-template-columns: 1fr 1fr;
        gap:12px;
        width:100%;
      }
      .row-line2 > .pair:nth-child(1){ grid-area: nick; }
      .row-line2 > .pair:nth-child(2){ grid-area: inst; }
      .row-line2 > .pair:nth-child(3){ grid-area: note; }
      .row-line2 > .actions-inline{ grid-area: acts; }

      .pair{ display:grid; grid-template-columns: auto 1fr; align-items:center; column-gap:8px; width:100%; }
      .row label{ width:auto; }
      #displayName,#instrument,#lastNote{ width:100%; }

      .actions-inline{
        display:grid; grid-template-columns: repeat(4, 1fr);
        gap: var(--action-gap-narrow); justify-items: stretch; align-items: stretch;
      }
      .actions-inline > button{ width: 100% !important; height: var(--action-h); }
      #helpBtn, #hintBtn{ width:100% !important; }

      .align-to-email{ margin-left:0 !important; }
      #lastNote{ width:var(--w-lastNote-m); }
    }

    .hint-popover{ max-width: clamp(320px, 48vw, 680px); }

    /* ====================== é›»è…¦ç‰ˆï¼ˆèª¿æ•´ç‚ºä¸‰çµ„ç­‰è·ä¸¦æ’ï¼šæš±ç¨±ï¼šæ¡†æ¡†  æ¨‚å™¨ï¼šæ¡†æ¡†  éŸ³ç¬¦ï¼šæ¡†æ¡†ï¼‰ ====================== */
    @media (min-width: 861px){
      .row-line2{
        display:grid;
        grid-template-areas: "nick inst note acts";
        grid-template-columns: 1fr 1fr 1fr auto;   /* ä¸‰çµ„ç­‰å¯¬ */
        align-items:center;
        gap: var(--gap);
        width:100%;
      }
      .row-line2 > .pair:nth-child(1){ grid-area: nick; }
      .row-line2 > .pair:nth-child(2){ grid-area: inst; }
      .row-line2 > .pair:nth-child(3){ grid-area: note; }
      .row-line2 > .actions-inline{ grid-area: acts; }

      /* è®“æ¯çµ„ã€Œæ¨™ç±¤+æ¡†æ¡†ã€ç·Šé„°ï¼Œä¸¦åœ¨å„è‡ªçš„ 1fr æ¬„ä½å…§è‡ªé©æ‡‰ */
      .pair{ display:grid; grid-template-columns: auto 1fr; align-items:center; column-gap:8px; width:100%; }
      .row label{ width:auto; }                /* ä¸å›ºå®šæ¨™ç±¤å¯¬ */
      #displayName,#instrument,#lastNote{ width:100%; } /* æ¡†æ¡†åƒæ»¿å„è‡ªæ¬„ä½ */

      .actions-inline{
        display:flex; flex-wrap: nowrap; justify-content: flex-end; align-items: center;
        gap: var(--action-gap-narrow);
      }
      .actions-inline > button{ flex: 0 0 auto; width: var(--action-w-desk); height: var(--action-h); }
      #helpBtn, #hintBtn{ width: var(--action-w-desk) !important; }

      .hint-popover{ max-width: min(720px, calc(100vw - 96px)); }
    }

    /* ====================== æ‰‹æ©Ÿæ©«å‘ï¼ˆç¬¬ä¸€è¡Œä¸‰çµ„ç­‰è·ã€çµ„å…§ label ç·Šè²¼ inputï¼›ç¬¬äºŒè¡Œå››é¡†ç½®ä¸­ï¼‰ ====================== */
    @media (max-width: 860.98px) and (orientation: landscape){
      .row-line2{
        display:grid;
        grid-template-areas:
          "nick inst note"
          "acts acts acts";
        grid-template-columns: 1fr 1fr 1fr;     /* ä¸‰çµ„ç­‰å¯¬ */
        align-items:center;
        gap: var(--gap);
        width:100%;
      }
      .row-line2 > .pair:nth-child(1){ grid-area: nick; }
      .row-line2 > .pair:nth-child(2){ grid-area: inst; }
      .row-line2 > .pair:nth-child(3){ grid-area: note; }
      .row-line2 > .actions-inline{ grid-area: acts; }

      /* ä¸‰çµ„ã€Œæ¨™ç±¤+æ¡†æ¡†ã€ç·Šé„°ï¼Œå¯¬åº¦è‡ªé©æ‡‰å¡«æ»¿å„è‡ªæ¬„ä½ */
      .pair{ display:grid; grid-template-columns: auto 1fr; align-items:center; column-gap:8px; width:100%; }
      .row label{ width:auto; }
      #displayName,#instrument,#lastNote{ width:100%; } /* æ”¹ç‚ºå¡«æ»¿ï¼šæš±ç¨±ï¼šæ¡†æ¡†  æ¨‚å™¨ï¼šæ¡†æ¡†  éŸ³ç¬¦ï¼šæ¡†æ¡† */

      .actions-inline{
        display:grid;
        grid-template-columns: repeat(4, 1fr);
        gap: var(--action-gap-narrow);
        width:100%;
        max-width: 560px;       /* èˆ‡ç›´å‘ä¸€è‡´çš„è¦–è¦ºå¯¬åº¦ */
        margin: 0 auto;         /* ç½®ä¸­æ•´çµ„æŒ‰éˆ• */
        justify-items: stretch;
      }
      .actions-inline > button{ width: 100% !important; height: var(--action-h); }
      #helpBtn, #hintBtn{ width:100% !important; }

      .hint-popover{ max-width: min(80vw, 680px); }
    }

    @media (max-width: 860.98px) and (orientation: portrait){
      .hint-popover{ max-width: min(92vw, 620px); }
    }
  </style>
</head>

<body>
  <img class="bg-notes" src="./assets/notes.png" alt="">
  <div class="panel">
    <h2>ğŸµäº’å‹•éŸ³ç¬¦ğŸµ</h2>

    <div class="row row-line2">
      <div class="pair">
        <label for="displayName">æš±ç¨±ï¼š</label>
        <input id="displayName" readonly aria-readonly="true" placeholder="ç­‰å¾…è¼‰å…¥â€¦" />
      </div>
      <div class="pair">
        <label for="instrument">æ¨‚å™¨ï¼š</label>
        <select id="instrument">
          <option value="piano" selected>é‹¼ç´</option>
          <option value="guitar">å‰ä»–</option>
        </select>
      </div>
      <div class="pair">
        <label for="lastNote" class="align-to-email">éŸ³ç¬¦ï¼š</label>
        <input id="lastNote" placeholder="â€” , â€” , â€”" readonly />
      </div>

      <!-- ç¬¬ä¸‰è¡Œï¼šå››é¡†æŒ‰éˆ• -->
      <div class="actions-inline">
        <button id="resetBtn" type="button" class="btn-compact">é‡è¨­</button>
        <button id="lockBtn"  type="button" class="btn-compact" disabled>é–å®š</button>

        <button id="helpBtn"  type="button" class="btn-compact" aria-expanded="false" aria-controls="helpPopover" title="âš™ï¸æ“ä½œèªªæ˜">æ“ä½œèªªæ˜</button>
        <div id="helpPopover" class="hint-popover" role="note" aria-live="polite">
          æŒ‰ã€Œé–å®šã€å¾Œè«‹ç¨å€™ï¼Œæœ¬äººæœ‰ç¼ºé™·å°è‡´é€Ÿåº¦è¼ƒæ…¢ğŸ¥²<br>ç¢ºèªé€å‡ºæˆåŠŸï¼Œä¸‹æ–¹ã€Œç‹€æ…‹åˆ—ã€æœƒç«‹å³é€šçŸ¥æ‚¨æºœğŸ‰
        </div>

        <button id="hintBtn"  type="button" class="btn-compact" aria-expanded="false" aria-controls="hintPopover" title="ğŸ¥º æŸ¥çœ‹å‚™è¨»">æŸ¥çœ‹å‚™æ³¨</button>
        <div id="hintPopover" class="hint-popover" role="note" aria-live="polite">
          æŒ‰ã€Œé–å®šã€å¾Œè«‹ç¨å€™ï¼Œæœ¬äººæœ‰ç¼ºé™·å°è‡´é€Ÿåº¦è¼ƒæ…¢ğŸ¥²<br>ç¢ºèªé€å‡ºæˆåŠŸï¼Œä¸‹æ–¹ã€Œç‹€æ…‹åˆ—ã€æœƒç«‹å³é€šçŸ¥æ‚¨æºœğŸ‰
        </div>
      </div>
    </div>

    <p id="status">å°šæœªåˆå§‹åŒ–</p>
    <div class="kb-wrap"><div id="keyboard"></div></div>
  </div>

  <!-- æ“ä½œèªªæ˜ -->
  <div id="guideOverlay" class="overlay" role="dialog" aria-modal="true" aria-labelledby="guideTitle">
    <div class="dialog">
      <h3 id="guideTitle">ğŸ“æ“ä½œèªªæ˜ğŸ“</h3>
      <p>ğŸ”»å¯é¸æ“‡é‹¼ç´æˆ–å‰ä»–ä¸­çš„ä¸‰å€‹éŸ³éš</p><p>â†“</p>
      <p>ğŸ”»ä¸‰å€‹éŸ³éšç¢ºèªå¾Œï¼Œä¸€å®šè¦æŒ‰é–å®š</p><p>â†“</p>
      <p>ğŸ”»é–å®šå®Œæˆå¾Œï¼Œæœƒæœ‰é€šçŸ¥æ˜¯å¦æˆåŠŸ</p><p>â†“</p>
      <p>ğŸ”ºè‹¥æˆåŠŸå³å¯é€€å‡ºä»‹é¢ï¼›åä¹‹å†è©¦</p><p>â†“</p>
      <p>â—ï¸æ²’æŒ‰é–å®šå°±æ˜¯æ²’æœ‰é€å‡ºå°±æ˜¯å½ˆå€‹å¯‚å¯</p>
      <div class="actions"><button id="guideOk" class="primary">äº†è§£</button></div>
    </div>
  </div>

  <!-- å•ŸéŸ³ -->
  <div id="unlockOverlay" class="overlay hidden" role="dialog" aria-modal="true" aria-labelledby="unlockTitle">
    <div class="dialog">
      <h3 id="unlockTitle">å•Ÿç”¨è²éŸ³</h3>
      <p class="ios-hint">iPhoneè«‹ç¢ºä¿å´é‚Šã€ŒéœéŸ³éµã€æœ‰é–‹å•ŸéŸ¿éˆ´æ¨¡å¼</p>
      <div class="actions">
        <button id="cancelUnlock">å–æ¶ˆ</button>
        <button id="confirmUnlock" class="primary">ç¢ºå®š</button>
      </div>
    </div>
  </div>

  <div id="lockScreen" aria-hidden="true"></div>
  <footer>Â© Copyright 2025 MYâ€˜s System</footer>

  <!-- ====================== å¤–éƒ¨è…³æœ¬ï¼ˆCDNï¼‰ ====================== -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tone@14.8.49/build/Tone.min.js"></script>

  <script>
    /* ====================== å‰ç«¯è¨­å®šï¼ˆè«‹å¡«ï¼‰ ====================== */
    const LIFF_ID = '2008149060-ZGVdAvGo';
    const WEBHOOK = 'https://script.google.com/macros/s/AKfycbzXgrFaprA9nUzq7JKGkZ8_VToVcEX6dvffblYO9TlIfx2dmbwQWmPKB1Wcp4cydgOK/exec';

    /* ===== æé†’ï¼ˆåƒ…è¨»è§£ï¼‰ =====
       // const SPREADSHEET_ID_MAIN   = '1loTbnXfQ90AN3tGUdpEsR3AGZUFHvaijBSctOUSZQFs';
       // const SPREADSHEET_ID_PUBLIC = '18hxRoLU_TFV6Dc4fNAxQFEv9VAYoSbeVZvfIZ17MHPQ';
       // const LIFF_URL = 'https://meiyang0819.github.io/SSS/line.html';
    ============================================================== */

    const TIMEOUT_MS = 40000;
    let extraMessage = '';

    const $ = s => document.querySelector(s);

    function setStatus(m){
      const el = $('#status');
      el.textContent = m;
      el.classList.remove('ok','busy','err');
      if(/å·²é€å‡ºæˆåŠŸ/.test(m)) el.classList.add('ok');
      else if(/å¿™ç¢Œ|ç­‰å¾…|é€å‡ºä¸­|è™•ç†ä¸­/i.test(m)) el.classList.add('busy');
      else if(/å·²å¡«å¯«é|æˆªæ­¢|å¤±æ•—|é€¾æ™‚|not found|ç„¡æ³•|è¶…æ™‚|ç¶²è·¯/i.test(m)) el.classList.add('err');
    }

    let audioCtx=null, sampler=null, samplerReady=false, unlocked=false, hardLocked=false;
    let currentInstrument='piano';
    let selectedNotes=[], selectedInsts=[];

    const PIANO_BASE = new URL('./piano/', location.href).href;
    const GUITAR_BASE = new URL('./guitar/', location.href).href;
    const PIANO_URLS = {'A1':'A1.mp3','C2':'C2.mp3','D#2':'Ds2.mp3','F#2':'Fs2.mp3','A2':'A2.mp3','C3':'C3.mp3','D#3':'Ds3.mp3','F#3':'Fs3.mp3','A3':'A3.mp3','C4':'C4.mp3','D#4':'Ds4.mp3','F#4':'Fs4.mp3','A4':'A4.mp3','C5':'C5.mp3'};
    const GUITAR_URLS = {'E2':'E2.wav','A2':'A2.wav','D3':'D3.wav','G3':'G3.wav','B3':'B3.wav','E4':'E4.wav'};

    const WHITE=["C3","D3","E3","F3","G3","A3","B3","C4","D4","E4","F4","G4","A4","B4"];
    const BLACK_AFTER={ 'C':'C#','D':'D#','F':'F#','G':'G#','A':'A#' };
    const MIN_WHITE_PX=64, TOTAL_WHITE=WHITE.length;

    const TUNING_MIDI = [40,45,50,55,59,64];
    const NOTE_NAMES = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];

    function unlockAudioInit(){
      const Ctx=window.webkitAudioContext||window.AudioContext;
      if(!audioCtx) audioCtx=new Ctx({latencyHint:'interactive'});
      Tone.setContext(new Tone.Context(audioCtx));
    }
    async function unlockAudio(){
      try{
        unlockAudioInit();
        if(audioCtx.state!=='running') await audioCtx.resume();
        await Tone.start();
        loadSampler(currentInstrument);
        unlocked=true;
        $('#unlockOverlay').classList.add('hidden');
      }catch(e){ setStatus('âŒ å•Ÿç”¨å¤±æ•—ï¼Œè«‹é€šçŸ¥ç®¡ç†å“¡'); }
    }
    function loadSampler(inst='piano'){
      sampler?.dispose?.(); sampler=null; samplerReady=false;
      let urls=PIANO_URLS, base=PIANO_BASE, label='ğŸ¹ ';
      if(inst==='guitar'){ urls=GUITAR_URLS; base=GUITAR_BASE; label='ğŸ¸ '; }
      setStatus(label+'è¼‰å…¥ä¸­â€¦');
      try{
        sampler=new Tone.Sampler({ urls, release:1, baseUrl:base, onload:()=>{ samplerReady=true; setStatus(label+'å·²è¼‰å…¥ âœ…'); } }).toDestination();
      }catch(e){ setStatus('âŒ éŸ³è‰²åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹é€šçŸ¥ç®¡ç†å“¡'); }
    }

    function trigger(note){
      if(hardLocked) return;
      if(!samplerReady){ setStatus('â³ éŸ³è‰²è¼‰å…¥ä¸­â€¦'); return; }
      sampler.triggerAttackRelease(note,'8n');
      if(selectedNotes.length<3){ selectedNotes.push(note); selectedInsts.push(currentInstrument); }
      else { selectedNotes[2]=note; selectedInsts[2]=currentInstrument; }
      refreshNotesDisplay(); validateLockBtn();
    }
    function refreshNotesDisplay(){ $('#lastNote').value = [selectedNotes[0]||'â€”', selectedNotes[1]||'â€”', selectedNotes[2]||'â€”'].join(' , '); }
    function validateLockBtn(){ $('#lockBtn').disabled = !(selectedNotes.length===3); }

    function renderPiano(){
      const kb=$('#keyboard'); kb.innerHTML=''; kb.className=''; sizePiano();
      const keyW=100/TOTAL_WHITE;
      WHITE.forEach((note,i)=>{
        const w=document.createElement('div'); w.className='white'; w.dataset.note=note;
        w.style.left=(i*keyW)+'%'; w.style.width=keyW+'%';
        w.addEventListener('pointerdown', ()=>{ if(hardLocked) return; if(!unlocked){ $('#unlockOverlay').classList.remove('hidden'); return; } trigger(note); w.classList.add('active'); });
        w.addEventListener('pointerup', ()=>w.classList.remove('active'));
        kb.appendChild(w);
      });
      WHITE.forEach((note,i)=>{
        const l=note[0], sharp = BLACK_AFTER[l]? (BLACK_AFTER[l]+note.slice(1)) : null;
        if(!sharp || (l==='A' && i===TOTAL_WHITE-1)) return;
        const b=document.createElement('div'); b.className='black'; b.dataset.note=sharp;
        const blackWidthPct = keyW*0.62; b.style.width = blackWidthPct+'%'; b.style.left=((i+1)*keyW)+'%';
        b.addEventListener('pointerdown', ()=>{ if(hardLocked) return; if(!unlocked){ $('#unlockOverlay').classList.remove('hidden'); return; } trigger(sharp); b.classList.add('active'); });
        b.addEventListener('pointerup', ()=>b.classList.remove('active'));
        kb.appendChild(b);
      });
    }
    function sizePiano(){
      const wrap=document.querySelector('.kb-wrap');
      const kb=document.querySelector('#keyboard');
      const wrapW=wrap.clientWidth;
      const sep=parseInt(getComputedStyle(kb).getPropertyValue('--sep')||'2',10);
      const minW=WHITE.length*(MIN_WHITE_PX+sep);
      kb.style.width=(wrapW>=minW?wrapW-1:minW)+'px';
      kb.style.height='var(--kb-h)';
    }

    function renderGuitar(){
      const kb=$('#keyboard'); kb.innerHTML=''; kb.className='fretboard'; kb.style.height='var(--kb-h)';

      const head=document.createElement('div'); head.className='head'; kb.appendChild(head);
      const nut =document.createElement('div');  nut.className='nut';  kb.appendChild(nut);
      const bridge=document.createElement('div'); bridge.className='bridge'; kb.appendChild(bridge);

      for(let s=0;s<6;s++){
        const y=(s+1)*(100/7);
        const str=document.createElement('div'); str.className='string'; str.dataset.s=String(s); str.style.top = `${y}%`; kb.appendChild(str);
        const hline=document.createElement('div'); hline.className='head-line'; hline.dataset.s=String(s); hline.style.top = `${y}%`; kb.appendChild(hline);
      }

      for(let f=1; f<=13; f++){
        const col=document.createElement('div'); col.className='fret-col';

        for(let s=0; s<6; s++){
          const y=(s+1)*(100/7);
          const hit=document.createElement('div'); hit.className='hit-row'; hit.style.top = `${y}%`; col.appendChild(hit);
        }

        if([4,6,8,10].includes(f)){
          const dot=document.createElement('div');
          dot.style.cssText='position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:16px;height:16px;border-radius:50%;background:#dbc6a4;opacity:.9;box-shadow:0 1px 0 rgba(0,0,0,.35);pointer-events:none;';
          col.appendChild(dot);
        }else if(f===13){
          const dot1=document.createElement('div'); dot1.style.cssText='position:absolute;left:50%;top:38%;transform:translate(-50%,-50%);width:14px;height:14px;border-radius:50%;background:#dbc6a4;opacity:.9;box-shadow:0 1px 0 rgba(0,0,0,.35);pointer-events:none;';
          const dot2=document.createElement('div'); dot2.style.cssText='position:absolute;left:50%;top:62%;transform:translate(-50%,-50%);width:14px;height:14px;border-radius:50%;background:#dbc6a4;opacity:.9;box-shadow:0 1px 0 rgba(0,0,0,.35);pointer-events:none;';
          col.appendChild(dot1); col.appendChild(dot2);
        }

        col.addEventListener('pointerdown',(ev)=>{
          if(hardLocked) return;
          if(!unlocked){ $('#unlockOverlay').classList.remove('hidden'); return; }
          const rect = col.getBoundingClientRect();
          const y = ev.clientY - rect.top;
          const slot = rect.height/7;
          let idx = Math.round(y/slot - 1);
          idx = Math.max(0, Math.min(5, idx));

          if(f<=12){
            const midi = TUNING_MIDI[5-idx] + f;
            const note = NOTE_NAMES[midi % 12] + (Math.floor(midi/12) - 1);
            trigger(note);
          }

          const target = kb.querySelector(`.string[data-s="${idx}"]`);
          if(target){
            target.classList.remove('vibrate'); void target.offsetWidth; target.classList.add('vibrate');
            setTimeout(()=>target.classList.remove('vibrate'), 380);
          }
        });

        kb.appendChild(col);
      }
    }

    window.addEventListener('resize', ()=>{ if(currentInstrument==='piano') sizePiano(); });
    window.addEventListener('orientationchange', ()=>{ if(currentInstrument==='piano') sizePiano(); });

    $('#instrument').addEventListener('change', ()=>{
      if(hardLocked) return;
      currentInstrument=$('#instrument').value;
      loadSampler(currentInstrument);
      if(currentInstrument==='guitar') renderGuitar(); else renderPiano();
      validateLockBtn();
    });

    $('#resetBtn').addEventListener('click', ()=>{
      if(hardLocked) return;
      if(selectedNotes.length>0){ selectedNotes.pop(); selectedInsts.pop(); refreshNotesDisplay(); validateLockBtn(); }
    });

    const hintBtn=$('#hintBtn'), hintPop=$('#hintPopover');
    const helpBtn=$('#helpBtn'), helpPop=$('#helpPopover');

    function positionArrow(pop, btn){
      const popRect=pop.getBoundingClientRect(), btnRect=btn.getBoundingClientRect();
      const x=(btnRect.left+btnRect.width/2)-popRect.left;
      const clamped=Math.max(16, Math.min(popRect.width-16, x));
      pop.style.setProperty('--arrow-x', clamped+'px');
    }
    function closePop(pop, btn){ pop.classList.remove('show'); btn.setAttribute('aria-expanded','false'); }

    hintBtn.addEventListener('click', (e)=>{
      const showing=hintPop.classList.toggle('show');
      hintBtn.setAttribute('aria-expanded', showing?'true':'false');
      if(showing){ positionArrow(hintPop, hintBtn); }
      e.stopPropagation();
    });
    helpBtn.addEventListener('click', (e)=>{
      const showing=helpPop.classList.toggle('show');
      helpBtn.setAttribute('aria-expanded', showing?'true':'false');
      if(showing){ positionArrow(helpPop, helpBtn); }
      e.stopPropagation();
    });

    document.addEventListener('click', (e)=>{
      if(hintPop.classList.contains('show')){
        const within=hintPop.contains(e.target)||hintBtn.contains(e.target);
        if(!within) closePop(hintPop, hintBtn);
      }
      if(helpPop.classList.contains('show')){
        const within2=helpPop.contains(e.target)||helpBtn.contains(e.target);
        if(!within2) closePop(helpPop, helpBtn);
      }
    });

    window.addEventListener('resize', ()=>{
      if(hintPop.classList.contains('show')) positionArrow(hintPop, hintBtn);
      if(helpPop.classList.contains('show')) positionArrow(helpPop, helpBtn);
    });
    window.addEventListener('orientationchange', ()=>{
      setTimeout(()=>{
        if(hintPop.classList.contains('show')) positionArrow(hintPop, hintBtn);
        if(helpPop.classList.contains('show')) positionArrow(helpPop, helpBtn);
      }, 250);
    });
    window.addEventListener('keydown', (e)=>{ if(e.key==='Escape'){ closePop(hintPop, hintBtn); closePop(helpPop, helpBtn); } });

    let lineId='', displayName='', pictureUrl='';
    $('#lockBtn').addEventListener('click', async ()=>{
      if(hardLocked) return;
      if(selectedNotes.length!==3){ alert('è«‹å½ˆæ»¿ 3 å€‹éŸ³å†é–å®š'); return; }

      try {
        const ping = await fetch(WEBHOOK + '?action=ping', { method:'GET', cache:'no-store' });
        const t = await ping.text().catch(()=> '');
        if (String(t).trim().toLowerCase() !== 'ok') {
          setStatus('âš ï¸ å¾Œç«¯æœªå›æ‡‰æ­£å¸¸ï¼Œè«‹é€šçŸ¥ç®¡ç†å“¡æª¢æŸ¥GASéƒ¨ç½²èˆ‡æ¬Šé™');
          return;
        }
      } catch (_) {
        setStatus('âš ï¸ ç„¡æ³•é€£åˆ°å¾Œç«¯ï¼Œè«‹é€šçŸ¥ç®¡ç†å“¡æª¢æŸ¥GASURL/æ¬Šé™/ç¶²è·¯');
        return;
      }

      setStatus('â³ é€å‡ºä¸­â€¦');
      const payload = {
        action: 'submitNotes',
        lineId, displayName, pictureUrl,
        instrumentsCSV: selectedInsts.join(','),
        notesCSV:       selectedNotes.join(','),
        extraMessage
      };

      const controller=new AbortController();
      const timer=setTimeout(()=>controller.abort(), TIMEOUT_MS);

      try{
        const r=await fetch(WEBHOOK + '?_t=' + Date.now(),{
          method:'POST',
          headers:{'Content-Type':'text/plain;charset=UTF-8'},
          body: JSON.stringify(payload),
          keepalive: true,
          signal: controller.signal
        });

        clearTimeout(timer);

        const ct = (r.headers.get('content-type')||'').toLowerCase();
        let j = null;
        if(ct.includes('application/json')){
          j = await r.json().catch(()=>null);
        }else{
          const t = await r.text().catch(()=> '');
          if(/^\s*\{/.test(t)){ try{ j = JSON.parse(t); }catch(_){} }
          if(!j && r.ok) j = { ok:true };
        }

        if(j && j.ok){
          setStatus('âœ… å·²é€å‡ºæˆåŠŸï¼Œå¯é€€å®‰å›‰');
          enterHardLock();
        }else{
          const err = String(j?.error||'');
          if(err==='duplicate') setStatus('âš ï¸ å·²å¡«å¯«éäº†ï¼Œæƒ³è¦æ›´æ›éŸ³éšè«‹æ´½ç®¡ç†å“¡å‘¢ğŸ™');
          else if(err==='deadline_passed') setStatus('âŒ å·²éæˆªæ­¢æ—¥ï¼Œä½†é‚„å¯åœ¨é€™ç©è€å”·ğŸ‘£');
          else if(err==='busy') setStatus('âš ï¸ ç³»çµ±å¿™ç¢Œï¼Œç¨å¾Œå†è©¦ğŸŒ€');
          else setStatus(`âš ï¸ é€å‡ºå¤±æ•—ï¼Œè«‹é€šçŸ¥ç®¡ç†å“¡æª¢æŸ¥GASéƒ¨ç½²èˆ‡æ¬Šé™`);
        }
      }catch(e){
        clearTimeout(timer);
        try {
          setStatus('â³ ç¶²è·¯é–ƒæ–·ï¼Œå˜—è©¦é‡é€ä¸­â€¦');
          const r2 = await fetch(WEBHOOK + '?_t=' + Date.now(), {
            method:'POST',
            headers:{'Content-Type':'text/plain;charset=UTF-8'},
            body: JSON.stringify(payload),
            keepalive: true,
            cache: 'no-store'
          });

          const ct2 = (r2.headers.get('content-type')||'').toLowerCase();
          let j2 = null;
          if (ct2.includes('application/json')) j2 = await r2.json().catch(()=>null);
          else {
            const t2 = await r2.text().catch(()=> '');
            if (/^\s*\{/.test(t2)) { try{ j2 = JSON.parse(t2); }catch(_){} }
            if (!j2 && r2.ok) j2 = { ok:true };
          }
          if (j2 && j2.ok) {
            setStatus('âœ… å·²é€å‡ºæˆåŠŸï¼Œå¯é€€å®‰å›‰');
            enterHardLock();
          } else {
            const err = String(j2?.error||'');
            if(err==='duplicate') setStatus('âš ï¸ å·²å¡«å¯«éäº†ï¼Œæƒ³è¦æ›´æ›éŸ³éšè«‹æ´½ç®¡ç†å“¡å‘¢ğŸ™');
            else if(err==='deadline_passed') setStatus('âŒ å·²éæˆªæ­¢æ—¥ï¼Œä½†é‚„å¯åœ¨é€™ç©è€å”·ğŸ‘£');
            else if(err==='busy') setStatus('âš ï¸ ç³»çµ±å¿™ç¢Œï¼Œç¨å¾Œå†è©¦ğŸŒ€');
            else setStatus(`âš ï¸ é€å‡ºå¤±æ•—ï¼Œè«‹é€šçŸ¥ç®¡ç†å“¡æª¢æŸ¥GASéƒ¨ç½²èˆ‡æ¬Šé™`);
          }

        } catch (e2) {
          setStatus('âš ï¸ ç¶²è·¯ç•°å¸¸æˆ–é€£ç·šä¸­æ–·ï¼Œè«‹ç¢ºèªç¶²è·¯å¾Œå†è©¦ä¸€æ¬¡');
        }
      }
    });

    function enterHardLock(){
      hardLocked=true;
      $('#displayName').disabled=true;
      $('#instrument').disabled=true;
      $('#resetBtn').disabled=true;
      $('#lockBtn').disabled=true;
      $('#lockScreen').style.display='block';
    }

    ['click','touchend'].forEach(evt=>{
      document.addEventListener(evt,(e)=>{
        const t=e.target;
        if(t.id==='guideOk'){
          document.getElementById('guideOverlay').classList.add('hidden');
          document.getElementById('unlockOverlay').classList.remove('hidden');
          e.preventDefault();
        }else if(t.id==='cancelUnlock'){
          document.getElementById('unlockOverlay').classList.add('hidden');
          e.preventDefault();
        }else if(t.id==='confirmUnlock'){
          unlockAudio();
          document.getElementById('unlockOverlay').classList.add('hidden');
          e.preventDefault();
        }
      }, {passive:true});
    });

    function sanitizeName(name){
      return String(name||'').replace(/^[\s:ï¼š]+/, '');
    }

    async function init(){
      renderPiano();
      setStatus('â³ ç­‰å¾…å•Ÿç”¨è²éŸ³â€¦');
      validateLockBtn();
      $('#guideOverlay').classList.remove('hidden');

      try{
        setStatus('åˆå§‹åŒ– LIFFâ€¦');
        await liff.init({ liffId: LIFF_ID, withLoginOnExternalBrowser: true });

        if(!liff.isLoggedIn()){
          liff.login({ scope: ['openid','profile'] });
          return;
        }
        if(liff.ready){ await liff.ready; }

        let prof = null, idt = null;
        try{ prof = await liff.getProfile(); }catch(_){}
        try{ idt  = await liff.getDecodedIDToken(); }catch(_){}

        lineId      = (prof && prof.userId) || (idt && idt.sub) || '';
        displayName = sanitizeName( (prof && prof.displayName) || (idt && (idt.name || idt.nickname)) || '' );
        pictureUrl  = (prof && prof.pictureUrl) || '';

        if(!lineId){
          setStatus('âš ï¸ ç„¡æ³•å–å¾—IDï¼Œè«‹æ–¼LineAppå…§é–‹å•Ÿæ­¤é€£çµé‡è©¦');
          return;
        }
        $('#displayName').value = displayName || 'ï¼ˆåŒ¿åï¼‰';
        setStatus('å·²å°±ç·’');
      }catch(e){
        setStatus('âŒ LIFFåˆå§‹åŒ–å¤±æ•—ï¼Œè«‹é€šçŸ¥ç®¡ç†å“¡');
      }
    }
    window.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
