/**** äº’å‹•éŸ³ç¬¦ v2 â€“ å¾Œç«¯å®Œæ•´ç‰ˆï¼ˆFlex äºŒé¸ä¸€å¡ï¼†é…è‰²çµ±ä¸€ + æ°¸ä¹…ä¿ç•™é ­è²¼æš±ç¨± + LINE ç«¯é˜»æ“‹ï¼‰ ********
 * è¡¨çµæ§‹ï¼ˆä¸»æœ¬ / å‰¯æœ¬çµæ§‹ç›¸åŒï¼‰
 *  - guests: A=man, B=woman, C=deadline
 *  - logs  : A=time, B=lineId, C=pictureUrl, D=é€™æ˜¯è¦ªå‹(ç”·æ–¹æˆ–å¥³æ–¹)=role,
 *            E=displayName, F=instruments, G=notes, H=message
 ******************************************************************************/

/* ==================== å¯èª¿åƒæ•¸ ==================== */
const SPREADSHEET_ID_MAIN   = '1loTbnXfQ90AN3tGUdpEsR3AGZUFHvaijBSctOUSZQFs';
const SPREADSHEET_ID_PUBLIC = '18hxRoLU_TFV6Dc4fNAxQFEv9VAYoSbeVZvfIZ17MHPQ';
const LIFF_URL              = 'https://meiyang0819.github.io/SSS/line.html';

const KWS_PORTAL = ['éŸ³ç¬¦','äº’å‹•éŸ³ç¬¦','å‰ä»–','é‹¼ç´','ğŸµ'];

const WELCOME_AUDIO_URL = 'https://drive.google.com/file/d/1Voif_FluZuNUMSjVeA6NitAb6skxnnFp/view?usp=drive_link';
const WELCOME_AUDIO_MS  = 6000;

/* å…¨å±€æˆªæ­¢æ—¥ï¼ˆåˆ°ç•¶æ—¥ 23:59:59 æ‰ç®—éæœŸï¼Œå°åŒ—æ™‚å€ï¼‰ */
const GLOBAL_DEADLINE_ISO = '2025-08-31';

/* Flex è¦–è¦ºæ§åˆ¶ */
const FLEX_SIZE_LEVEL    = 2;  // 1 micro / 2 kilo / 3 mega
const GAP_LEVEL          = 2;  // 1 sm / 2 md / 3 lg
const LINK_FONT_LEVEL    = 2;  // 1 sm / 2 md / 3 lg
const LINK_WIDTH_PERCENT = 62;

const LINK_CORNER_PX     = 18;
const LINK_BORDER_PX     = 1;
const LINK_PAD_V_PX      = 12;
const LINK_PAD_H_PX      = 18;

const FLEX_COLORS = {
  body:   '#E4E4E4',
  footer: '#E4E4E4',
  title:  '#0f172a',
  accent: '#A68A7C',
  linkBg: '#F5F1EC'
};

const KEYWORD_THEME = { body:'#E4E4E4', footer:'#E4E4E4', title:'#0f172a', text:'#A68A7C' };

const SHEET_GUESTS = 'guests';
const SHEET_LOGS   = 'logs';
const TZ           = 'Asia/Taipei';
const TIME_FMT     = 'yyyy-MM-dd HH:mm:ss';
const HEADER_ROWS  = 1;

const ROLE_MALE_FRIEND   = 'MALE_FRIEND';
const ROLE_FEMALE_FRIEND = 'FEMALE_FRIEND';

/* å°å·¥å…· */
const J = (o)=>ContentService.createTextOutput(JSON.stringify(o)).setMimeType(ContentService.MimeType.JSON);
const T = (s)=>ContentService.createTextOutput(String(s||'')).setMimeType(ContentService.MimeType.TEXT);
const nowStr = ()=>Utilities.formatDate(new Date(), TZ, TIME_FMT);

/* ---------- é¡è‰²/å°ºå¯¸å·¥å…· ---------- */
function mapSizeLevel_(n){ return ({1:'micro',2:'kilo',3:'mega'})[n] || 'kilo'; }
function mapGap_(n){ return ({1:'sm',2:'md',3:'lg'})[n] || 'md'; }
function mapFont_(n){ return ({1:'sm',2:'md',3:'lg'})[n] || 'md'; }
function hexToRgb_(hex){ const m=/^#?([a-fA-F0-9]{6})$/.exec((hex||'').trim()); const n=m?parseInt(m[1],16):0xE4E4E4; return {r:(n>>16)&255,g:(n>>8)&255,b:n&255}; }
function blendHex_(fgHex,bgHex,alpha){ const f=hexToRgb_(fgHex), b=hexToRgb_(bgHex); const r=Math.round(f.r*alpha+b.r*(1-alpha)), g=Math.round(f.g*alpha+b.g*(1-alpha)), bl=Math.round(f.b*alpha+b.b*(1-alpha)); return '#'+[r,g,bl].map(v=>v.toString(16).padStart(2,'0')).join(''); }

/* ---------- Flex å»ºæ§‹ ---------- */
function buildLinkChip_(uri, label){
  const w = Math.max(0, Math.min(100, Number(LINK_WIDTH_PERCENT)||0));
  const side = Math.max(0, Math.floor((100 - w)/2));
  const leftFlex  = side;
  const midFlex   = Math.max(1, w);
  const rightFlex = Math.max(0, 100 - leftFlex - midFlex);

  return {
    type:'box', layout:'horizontal',
    contents:[
      { type:'filler', flex:leftFlex },
      {
        type:'box', layout:'vertical', flex:midFlex,
        backgroundColor:FLEX_COLORS.linkBg,
        cornerRadius:String(LINK_CORNER_PX)+'px',
        borderColor:FLEX_COLORS.accent, borderWidth:String(LINK_BORDER_PX)+'px',
        paddingTop:String(LINK_PAD_V_PX)+'px', paddingBottom:String(LINK_PAD_V_PX)+'px',
        paddingStart:String(LINK_PAD_H_PX)+'px', paddingEnd:String(LINK_PAD_H_PX)+'px',
        action:{ type:'uri', uri:String(uri||LIFF_URL) },
        contents:[{
          type:'text', text:String(label||'ğŸ›ï¸ è³œäºˆæœ€å®Œç¾çš„æ—‹å¾‹'), size:mapFont_(LINK_FONT_LEVEL),
          weight:'bold', color:FLEX_COLORS.accent, align:'center'
        }]
      },
      { type:'filler', flex:rightFlex }
    ]
  };
}

/* Chip æŒ‰éˆ•ï¼ˆpostback ç‰ˆï¼‰ */
function buildChoiceChip_(label, data){
  return {
    type:'box', layout:'vertical', flex:1,
    backgroundColor:FLEX_COLORS.linkBg,
    cornerRadius:String(LINK_CORNER_PX)+'px',
    borderColor:FLEX_COLORS.accent, borderWidth:String(LINK_BORDER_PX)+'px',
    paddingTop:String(LINK_PAD_V_PX)+'px', paddingBottom:String(LINK_PAD_V_PX)+'px',
    paddingStart:String(LINK_PAD_H_PX)+'px', paddingEnd:String(LINK_PAD_H_PX)+'px',
    action:{ type:'postback', data:data, displayText:label },
    contents:[{ type:'text', text:label, size:mapFont_(LINK_FONT_LEVEL), weight:'bold', color:FLEX_COLORS.accent, align:'center' }]
  };
}

function buildThemedTextCard_(lines, theme){
  const bubbleSize = mapSizeLevel_(FLEX_SIZE_LEVEL);
  const gapToken   = mapGap_(GAP_LEVEL);
  const padAll     = '15px';
  const sepColor   = blendHex_(theme.text, theme.body, 0.5);

  const bodyContents = [
    { type:'text', text:'ğŸ¤µğŸ»æ–°äººğŸ‘°ğŸ»â€â™€ï¸', weight:'bold', size:'lg', color:theme.title, align:'center', wrap:true },
    { type:'separator', color:sepColor, margin:'md' },
    ...lines.map((t,i)=>({
      type:'text', text:t, size:'md', weight:'bold', color:theme.text, align:'center', wrap:true,
      margin: i===0 ? 'md' : gapToken
    }))
  ];

  return { type:'flex', altText:'é€šçŸ¥', contents:{
    type:'bubble', size:bubbleSize,
    styles:{ body:{backgroundColor:theme.body}, footer:{backgroundColor:theme.footer} },
    body:{ type:'box', layout:'vertical', paddingAll:padAll, spacing:gapToken, contents:bodyContents }
  }};
}

/* å…¥å£/ç‹€æ…‹å¡ */
function buildCard_Entrance_(){ 
  return { type:'flex', altText:'ğŸ›ï¸ è³œäºˆæœ€å®Œç¾çš„æ—‹å¾‹', contents:{
    type:'bubble', size:mapSizeLevel_(FLEX_SIZE_LEVEL),
    styles:{ body:{backgroundColor:FLEX_COLORS.body}, footer:{backgroundColor:FLEX_COLORS.footer} },
    body:{ type:'box', layout:'vertical', paddingAll:'15px', spacing:mapGap_(GAP_LEVEL), contents:[
      { type:'text', text:'ğŸ¤µğŸ»æ–°äººğŸ‘°ğŸ»â€â™€ï¸', weight:'bold', size:'lg', color:FLEX_COLORS.title, align:'center', wrap:true },
      { type:'separator', color:blendHex_(FLEX_COLORS.accent, FLEX_COLORS.body,0.5), margin:'md' },
      { type:'text', text:'è³œäºˆæœ€å®Œç¾çš„æ—‹å¾‹', size:'md', weight:'bold', color:FLEX_COLORS.accent, align:'center', wrap:true, margin:'md' }
    ]},
    footer:{ type:'box', layout:'vertical', contents:[ buildLinkChip_(LIFF_URL, 'ğŸ›ï¸ è³œäºˆæœ€å®Œç¾çš„æ—‹å¾‹') ], backgroundColor:FLEX_COLORS.footer }
  }}; 
}
function buildCard_Submitted_(){ return buildThemedTextCard_(['æ¬¸ï¼Œå…„å¼Ÿï¼å§Šå¦¹å·²å¡«å½ˆéäº†ğŸ«¶ğŸ»','æƒ³è¦æ›´æ›éŸ³éšè«‹å‘¼å«ç®¡ç†å“¡ğŸ™'], KEYWORD_THEME); }
function buildCard_Expired_(){ return buildThemedTextCard_(['æ¬¸ï¼Œå…„å¼Ÿï¼å§Šå¦¹å·²éæˆªæ­¢æ—¥ğŸ•’','ä½†é‚„å¯é»åœ–æ–‡é¸å–®ç©ç©å‘¢ğŸ‘£'], KEYWORD_THEME); }
function buildCard_Reminder_(){ return buildThemedTextCard_(['ğŸ“æé†’ğŸ“','å› å¾Œå°è³‡æ–™éæ–¼é¾å¤§','å›è¦†æœƒæœ‰é»ç•¥æ…¢å‡ºä¾†','å†éº»ç…©è¦ªå‹å€‘å¤šæ“”å¾…'], KEYWORD_THEME); }

/* Flex äºŒé¸ä¸€å¡ï¼šä½ /å¦³æ˜¯â€¦æˆ‘çš„ï¼Ÿï¼ˆchip é¢¨æ ¼ï¼‹çµ±ä¸€é…è‰²ï¼‰ */
function buildCard_RoleSelect_(){
  const bubbleSize = mapSizeLevel_(FLEX_SIZE_LEVEL);
  const gapToken   = mapGap_(GAP_LEVEL);
  const padAll     = '15px';
  const sepColor   = blendHex_(KEYWORD_THEME.text, KEYWORD_THEME.body, 0.5);

  return {
    type: 'flex',
    altText: 'ä½ /å¦³æ˜¯â€¦æˆ‘çš„ï¼Ÿ',
    contents: {
      type: 'bubble',
      size: bubbleSize,
      styles: { body:{backgroundColor:KEYWORD_THEME.body}, footer:{backgroundColor:KEYWORD_THEME.footer} },
      body: {
        type: 'box', layout: 'vertical', paddingAll: padAll, spacing: gapToken,
        contents: [
          { type:'text', text:'ğŸ¤µğŸ»æ–°äººğŸ‘°ğŸ»â€â™€ï¸', weight:'bold', size:'lg', color:KEYWORD_THEME.title, align:'center', wrap:true },
          { type:'separator', color:sepColor, margin:'md' },
          { type:'text', text:'ä½ /å¦³æ˜¯â€¦æˆ‘çš„ï¼Ÿ', size:'md', weight:'bold', color:KEYWORD_THEME.text, align:'center', wrap:true, margin:'md' }
        ]
      },
      footer: {
        type: 'box', layout: 'horizontal', spacing: 'md', backgroundColor: KEYWORD_THEME.footer,
        contents: [
          buildChoiceChip_('ğŸ¤µğŸ»è¦ªå‹','role=male'),
          buildChoiceChip_('ğŸ‘°ğŸ»â€â™€ï¸è¦ªå‹','role=female')
        ]
      }
    }
  };
}

/* ---------- Reply ---------- */
function replyFlex_(token, replyToken, flexMsg){
  const url='https://api.line.me/v2/bot/message/reply';
  const payload={ replyToken, messages:[ flexMsg ] };
  const opt={ method:'post', contentType:'application/json', headers:{Authorization:'Bearer '+token}, payload:JSON.stringify(payload), muteHttpExceptions:true };
  try{ UrlFetchApp.fetch(url,opt); }catch(_){}
}
function replyAudio_(token, replyToken, audioUrl, durationMs){
  const url='https://api.line.me/v2/bot/message/reply';
  const payload={ replyToken, messages:[{ type:'audio', originalContentUrl:String(audioUrl), duration:Number(durationMs)||1000 }] };
  const opt={ method:'post', contentType:'application/json', headers:{Authorization:'Bearer '+token}, payload:JSON.stringify(payload), muteHttpExceptions:true };
  try{ UrlFetchApp.fetch(url,opt); }catch(_){}
}
function replyMulti_(token, replyToken, messages){
  const url='https://api.line.me/v2/bot/message/reply';
  const payload={ replyToken, messages };
  const opt={ method:'post', contentType:'application/json', headers:{Authorization:'Bearer '+token}, payload:JSON.stringify(payload), muteHttpExceptions:true };
  try{ UrlFetchApp.fetch(url,opt); }catch(_){}
}

/* ---------- LINE Profile å–å¾—ï¼ˆç”¨æ–¼æ°¸ä¹…ä¿ç•™é ­è²¼/æš±ç¨±ï¼‰ ---------- */
function fetchUserProfile_(channelToken, userId){
  if(!channelToken || !userId) return { displayName:'', pictureUrl:'' };
  const url = 'https://api.line.me/v2/bot/profile/' + encodeURIComponent(userId);
  const opt = { method:'get', headers:{ Authorization:'Bearer '+channelToken }, muteHttpExceptions:true };
  try{
    const r = UrlFetchApp.fetch(url,opt);
    if(r.getResponseCode()===200){
      const j = JSON.parse(r.getContentText()||'{}');
      return {
        displayName: String(j.displayName||''),
        pictureUrl : String(j.pictureUrl||'')
      };
    }
  }catch(_){}
  return { displayName:'', pictureUrl:'' };
}

/* ---------- Spreadsheet helpers ---------- */
function openMain_(){ return SpreadsheetApp.openById(SPREADSHEET_ID_MAIN); }
function openPublic_(){ return SpreadsheetApp.openById(SPREADSHEET_ID_PUBLIC); }

function ensureHeaderAtRow1_(sh, expectedHeader){
  const last=sh.getLastRow();
  if(last===0){ sh.getRange(1,1,1,expectedHeader.length).setValues([expectedHeader]); return; }
  const vals=sh.getRange(1,1,1,expectedHeader.length).getValues()[0];
  const same=expectedHeader.every((h,i)=>String(vals[i]||'').toLowerCase()===String(h).toLowerCase());
  if(!same){ sh.getRange(1,1,1,expectedHeader.length).setValues([expectedHeader]); }
}
function ensureLogs_(ss){
  let sh=ss.getSheetByName(SHEET_LOGS); if(!sh) sh=ss.insertSheet(SHEET_LOGS);
  /* >>> è¡¨é ­ä¾ä½ æŒ‡å®šçš„æ–°é †åº <<< */
  const header = ['time','lineId','pictureUrl','é€™æ˜¯è¦ªå‹(ç”·æ–¹æˆ–å¥³æ–¹)','displayName','instruments','notes','message'];
  ensureHeaderAtRow1_(sh, header);
  return sh;
}

/* ---------- logs æ“ä½œï¼ˆä¾æ–°æ¬„ä½é †åºï¼‰ ---------- */
function findLogRowByLineId_(sh, lineId){
  const last=sh.getLastRow(); if(last<=HEADER_ROWS) return -1;
  const vals=sh.getRange(HEADER_ROWS+1,2,last-HEADER_ROWS,1).getValues(); // B æ¬„ lineId
  for(let i=0;i<vals.length;i++){ if(String(vals[i][0]||'')===String(lineId)) return i+HEADER_ROWS+1; }
  return -1;
}
/* åƒ…åœ¨æä¾›éç©ºå€¼æ™‚æ‰è¦†è“‹ï¼Œæ°¸ä¹…ä¿ç•™æ­·å²ï¼›æ–°é †åºï¼šA=time, B=lineId, C=pictureUrl, D=role, E=displayName, F=instruments, G=notes, H=message */
function bindLineIdEnsureRow_(ss, lineId, displayName, pictureUrl){
  const sh = ensureLogs_(ss);
  const r = findLogRowByLineId_(sh, lineId);
  if(r === -1){
    sh.appendRow([ nowStr(), lineId, String(pictureUrl||''), '', String(displayName||''), '', '', '' ]);
  }else{
    const row = sh.getRange(r, 1, 1, 8).getValues()[0];
    row[0] = nowStr();
    row[1] = lineId;
    /* åªæœ‰åœ¨å‚³å…¥éç©ºæ™‚ï¼Œæ‰è¦†è“‹æ—¢æœ‰å€¼ï¼Œé¿å…é€€å‡º/å›ä¾†å¾Œè¢«æ¸…ç©º */
    row[2] = String(pictureUrl||'')  ? String(pictureUrl)  : String(row[2]||''); // pictureUrl â†’ C
    // row[3] (=role) ä¸åœ¨é€™è£¡è¦†è“‹ï¼Œäº¤ç”± setRole_ æ§åˆ¶
    row[4] = String(displayName||'') ? String(displayName) : String(row[4]||''); // displayName â†’ E
    sh.getRange(r, 1, 1, 8).setValues([row]);
  }
}
function alreadySubmitted_(sh,lineId){
  const r=findLogRowByLineId_(sh,lineId); if(r===-1) return false;
  const e=String(sh.getRange(r,6).getValue()||'').trim(); // F=instruments
  const f=String(sh.getRange(r,7).getValue()||'').trim(); // G=notes
  return !!(e||f);
}
function getRole_(sh,lineId){
  const r=findLogRowByLineId_(sh,lineId); if(r===-1) return '';
  return String(sh.getRange(r,4).getValue()||'').trim(); // D=role
}
function setRole_(sh,lineId,role){
  const r=findLogRowByLineId_(sh,lineId); if(r===-1) return;
  sh.getRange(r,4).setValue(String(role||'')); // D=role
}
function isFirstInteraction_(sh, lineId){
  const r = findLogRowByLineId_(sh, lineId);
  if(r === -1) return true;
  const role = String(sh.getRange(r,4).getValue()||'').trim(); // D
  const e=String(sh.getRange(r,6).getValue()||'').trim();      // F
  const f=String(sh.getRange(r,7).getValue()||'').trim();      // G
  return !role && !e && !f;
}

/* ---------- æˆªæ­¢åˆ¤æ–· ---------- */
function getGlobalDeadline_(){
  // è½‰ç‚ºå°åŒ—æ™‚å€ç•¶æ—¥ 23:59:59
  const d = new Date(GLOBAL_DEADLINE_ISO+'T23:59:59+08:00');
  return d;
}
function isExpired_(){
  return new Date() > getGlobalDeadline_();
}

/* ---------- HTTP å…¥å£ ---------- */
function doGet(e){
  const p=e?.parameter||{}; const action=String(p.action||'').toLowerCase();
  if(action==='ping') return T('ok');
  if(action==='config') return J({ok:true});
  return T('ok');
}
function doPost(e){
  let body={}; try{ body=JSON.parse(e?.postData?.contents||'{}'); }catch(_){ body={}; }
  if(body && Array.isArray(body.events)) return handleLineWebhook_(body);
  return handleLiffSubmit_(body);
}

/* ---------- ç‹€æ…‹åˆ¤æ–·ï¼ˆLINE ç«¯å…ˆæ“‹ï¼‰ ---------- */
function respondByState_(channelToken, replyToken, shLogs, lineId){
  if(!channelToken) return;
  const submitted = alreadySubmitted_(shLogs, lineId);
  const expired   = isExpired_();

  if(!submitted && !expired){
    replyFlex_(channelToken, replyToken, buildCard_Entrance_());
  }else if(submitted){
    replyFlex_(channelToken, replyToken, buildCard_Submitted_());
  }else if(expired){
    replyFlex_(channelToken, replyToken, buildCard_Expired_());
  }
}

/* ---------- Webhook ---------- */
function handleLineWebhook_(body){
  const events=body.events||[];
  const ssM=openMain_(); const ssP=openPublic_();
  const shM=ensureLogs_(ssM);
  const shP=ensureLogs_(ssP);
  const channelToken=(PropertiesService.getScriptProperties().getProperty('CHANNEL_TOKEN')||'').trim();

  events.forEach(ev=>{
    try{
      const userId = ev.source?.userId || '';
      if(!userId) return;

      /* followï¼šç¬¬ä¸€æ™‚é–“å°±æŠ“ä¸€æ¬¡ profileï¼Œæ°¸ä¹…ä¿ç•™ï¼›å›æ­¡è¿éŸ³æª”ï¼ˆç¶­æŒåŸæ¨£ï¼‰ */
      if(ev.type==='follow'){
        if(channelToken){
          const prof = fetchUserProfile_(channelToken, userId);
          bindLineIdEnsureRow_(ssM, userId, prof.displayName, prof.pictureUrl);
          bindLineIdEnsureRow_(ssP, userId, prof.displayName, prof.pictureUrl);
          replyAudio_(channelToken, ev.replyToken, WELCOME_AUDIO_URL, WELCOME_AUDIO_MS);
        }
        return;
      }

      /* postbackï¼šè§’è‰²ç¶å®šï¼Œå®Œæˆå¾Œä¹Ÿè¦æŒ‰ç‹€æ…‹åˆ¤æ–·é˜»æ“‹ï¼ˆä¸æ˜¯ä¸€å¾‹å…¥å£å¡ï¼‰
         â˜…â˜…â˜… åŒæ­¥å¯«å…¥ä¸»æœ¬èˆ‡å‰¯æœ¬çš„ D æ¬„ï¼ˆé€™æ˜¯è¦ªå‹ï¼‰ â˜…â˜…â˜… */
      if(ev.type==='postback'){
        const data = String(ev.postback?.data||'');
        if(/role=male/.test(data)){        setRole_(shM, userId, ROLE_MALE_FRIEND);   setRole_(shP, userId, ROLE_MALE_FRIEND); }
        else if(/role=female/.test(data)){ setRole_(shM, userId, ROLE_FEMALE_FRIEND); setRole_(shP, userId, ROLE_FEMALE_FRIEND); }

        if(channelToken) respondByState_(channelToken, ev.replyToken, shM, userId);
        return;
      }

      /* messageï¼ˆæ–‡å­—ï¼‰ï¼šå…¥å£é—œéµå­—æ‰å›å¡ç‰‡ï¼›åŒæ™‚è£œæŠ“ profileï¼ˆè‹¥ç¼ºï¼‰ */
      if(ev.type==='message' && ev.message?.type==='text'){
        const rawInput=String(ev.message.text||'').trim();
        const isPortal = KWS_PORTAL.some(k=>rawInput.includes(k));

        // å»ºç«‹ / è£œé½Šä½¿ç”¨è€…åˆ—
        if(channelToken){
          const prof = fetchUserProfile_(channelToken, userId);
          bindLineIdEnsureRow_(ssM, userId, prof.displayName, prof.pictureUrl);
          bindLineIdEnsureRow_(ssP, userId, prof.displayName, prof.pictureUrl);
        }else{
          bindLineIdEnsureRow_(ssM, userId, '', '');
          bindLineIdEnsureRow_(ssP, userId, '', '');
        }

        // æŒ‡ä»¤ã€Œé–‹å§‹ã€ç¶­æŒåŸé‚è¼¯
        if(rawInput==='é–‹å§‹'){
          if(channelToken) replyMulti_(channelToken, ev.replyToken, [ buildCard_Reminder_(), buildCard_Entrance_() ]);
          return;
        }

        // æœªç¶å®šä¸”é¦–æ¬¡äº’å‹• / å…¥å£é—œéµå­— â†’ å…ˆåšèº«åˆ†äºŒé¸ä¸€
        const isBound  = !!getRole_(shM,userId);
        if(!isBound && (isPortal || isFirstInteraction_(shM, userId))){
          if(channelToken) replyFlex_(channelToken, ev.replyToken, buildCard_RoleSelect_());
          return;
        }

        // å…¥å£é—œéµå­— â†’ ä¾ç‹€æ…‹é˜»æ“‹ï¼ˆå·²å¡« or éæœŸï¼‰ï¼Œå¦å‰‡çµ¦å…¥å£å¡
        if(isPortal){
          respondByState_(channelToken, ev.replyToken, shM, userId);
          return;
        }
      }
    }catch(_){}
  });
  return J({status:'ok'});
}

/* ---------- LIFF é€å–®ï¼ˆèˆ‡å‰ç«¯ payload å°é½Šï¼›é›™é‡ä¿è­· duplicate/deadlineï¼‰ ----------
   â˜…â˜…â˜… ä¾æ–°æ¬„ä½é †åºå¯«å…¥ï¼šA=time, B=lineId, C=pictureUrl, D=role, E=displayName, F=instruments, G=notes, H=message â˜…â˜…â˜… */
function handleLiffSubmit_(body){
  const ssM=openMain_(); const ssP=openPublic_();
  const shM=ensureLogs_(ssM); const shP=ensureLogs_(ssP);

  const lineId=String(body.lineId||'').trim();
  const displayName=String(body.displayName||'').trim();
  const pictureUrl=String(body.pictureUrl||'').trim();
  const instruments=String(body.instrumentsCSV||'').trim();
  const notes=String(body.notesCSV||'').trim();
  const msg=String(body.extraMessage||'').trim();
  if(!lineId) return J({ok:false, error:'missing_line_id'});

  // å…ˆç¢ºä¿ row å­˜åœ¨ä¸¦è£œé½Šé ­è²¼/æš±ç¨±ï¼ˆåƒ…éç©ºè¦†è“‹ï¼‰
  bindLineIdEnsureRow_(ssM, lineId, displayName, pictureUrl);
  bindLineIdEnsureRow_(ssP, lineId, displayName, pictureUrl);

  // æˆªæ­¢ä¿è­·
  if(isExpired_()) return J({ok:false, error:'deadline_passed'});

  // é‡è¦†ä¿è­·
  if(alreadySubmitted_(shM, lineId)) return J({ok:false, error:'duplicate'});

  // å–å¾—è§’è‰²ï¼ˆåˆ†åˆ¥å¾ä¸»æœ¬/å‰¯æœ¬ï¼‰
  const roleM = getRole_(shM, lineId);
  const roleP = getRole_(shP, lineId);

  // æ­£å¸¸å¯«å…¥ï¼ˆåŒæ™‚å¯«ä¸»æœ¬/å‰¯æœ¬ï¼›æ–°é †åºï¼‰
  const rM=findLogRowByLineId_(shM,lineId);
  if(rM===-1){
    shM.appendRow([ nowStr(), lineId, pictureUrl, roleM, displayName, instruments, notes, msg ]);
  }else{
    shM.getRange(rM,1,1,8).setValues([[ nowStr(), lineId, pictureUrl, roleM, displayName, instruments, notes, msg ]]);
  }

  const rP=findLogRowByLineId_(shP,lineId);
  if(rP===-1){
    shP.appendRow([ nowStr(), lineId, pictureUrl, roleP, displayName, instruments, notes, msg ]);
  }else{
    shP.getRange(rP,1,1,8).setValues([[ nowStr(), lineId, pictureUrl, roleP, displayName, instruments, notes, msg ]]);
  }

  return J({ok:true});
}
