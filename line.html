<!doctype html>
<html lang="zh-Hant">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ğŸ¶äº’å‹•éŸ³ç¬¦</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700&display=swap" rel="stylesheet">

<style>
/* ====================== å¤–è§€æ¨£å¼ï¼ˆä½ èƒ½æ”¹çš„æˆ‘éƒ½æœ‰è¨»è¨˜ï¼‰ ====================== */
/* âœ… å¯æ›´æ”¹ï¼šç«™å…§é…è‰²ã€æ¬„å¯¬ã€å­—ç´šã€é™°å½±ç­‰ */
:root{
  --brand:#D4BFAA;   /* âœ… å¯æ›´æ”¹ï¼šé é¢ä¸»è‰² */
  --title:#A68A7C;   /* âœ… å¯æ›´æ”¹ï¼šæ¨™é¡Œè‰² */
  --neutral:#E4E4E4; /* âœ… å¯æ›´æ”¹ï¼šé¢æ¿åº•è‰²/é‚Šæ¡†è‰² */
  --soft:#F5F1EC;    /* âœ… å¯æ›´æ”¹ï¼šç‹€æ…‹åˆ—/éµç›¤åº•è‰² */
  --accent:#BFA5A0;  /* âœ… å¯æ›´æ”¹ï¼šé‡é»æ–‡å­—é¡è‰² */
  --rim:#E4E4E4;     /* âœ… å¯æ›´æ”¹ï¼šè¼¸å…¥æ¡†é‚Šæ¡†è‰² */
  --ink:#0f172a;     /* âœ… å¯æ›´æ”¹ï¼šæ­£æ–‡å­—è‰² */

  --w-displayName: 220px; /* âœ… å¯æ›´æ”¹ï¼šæš±ç¨±æ¬„å¯¬ï¼ˆå”¯è®€ï¼‰ */
  --w-instrument:  96px;  /* âœ… å¯æ›´æ”¹ï¼šæ¨‚å™¨é¸å–®å¯¬ */
  --w-lastNote:    160px; /* âœ… å¯æ›´æ”¹ï¼šä¸‰éŸ³é¡¯ç¤ºå¯¬ */
  --w-lastNote-m:  180px; /* âœ… å¯æ›´æ”¹ï¼šæ‰‹æ©Ÿå¯¬ */

  --label-w:88px; /* âœ… å¯æ›´æ”¹ï¼šå·¦å´æ¨™ç±¤å¯¬ */
  --gap:10px;     /* âœ… å¯æ›´æ”¹ï¼šæ¬„ä½é–“è· */
  --kb-h:280px;   /* âœ… å¯æ›´æ”¹ï¼šæ¨‚å™¨é«˜åº¦ï¼ˆpiano/guitar åŒæ­¥ï¼‰ */
  --sep:2px;      /* âœ… å¯æ›´æ”¹ï¼šç™½éµåˆ†éš”ç·šå¯¬ */

  --stroke:rgba(0,0,0,.18);   /* âœ… å¯æ›´æ”¹ï¼šå­—æé‚Š */
  --glow:rgba(255,255,255,.65); /* âœ… å¯æ›´æ”¹ï¼šå­—é«˜å…‰ */

  --w-hintbtn: 160px; /* âœ… å¯æ›´æ”¹ï¼šå‚™è¨»æŒ‰éˆ•å¯¬ */
  --hint-fz: 12px;    /* âœ… å¯æ›´æ”¹ï¼šå‚™è¨»å­—ç´š */
  --hint-maxw: 520px; /* âœ… å¯æ›´æ”¹ï¼šå‚™è¨»æœ€å¤§å¯¬ */
}

*{
  box-sizing:border-box;
  font-family:"Zen Maru Gothic","Noto Sans TC",system-ui,-apple-system,sans-serif !important;
  -webkit-text-stroke:.35px var(--stroke);
  text-shadow:0 1px 0 var(--glow);
}
html,body{ margin:0; color:var(--ink); background:var(--brand); font-weight:700; }
#guideOverlay .dialog, #guideOverlay .dialog *{ font-weight:500 !important; -webkit-text-stroke:0 !important; text-shadow:none !important; }

/* å®¹å™¨èˆ‡æ¨™é¡Œï¼ˆå¤–æ¡†/é™°å½±/åœ“è§’ï¼‰ */
.bg-notes{ position:fixed; inset:0; width:100%; height:100%; object-fit:cover; opacity:.60; mix-blend-mode:multiply; filter:contrast(1.1); pointer-events:none; z-index:0; }
.panel{ position:relative; z-index:1; max-width:1060px; margin:22px auto; background:var(--neutral); border:1px solid var(--neutral);
        border-radius:16px; padding:18px 18px 26px; box-shadow:0 10px 26px rgba(0,0,0,.10); backdrop-filter:blur(8px) saturate(115%); }
h2{ margin:4px 0 20px; text-align:center; font-size:2.8rem; font-weight:700; letter-spacing:1px; color:var(--title);
    -webkit-text-stroke:.6px rgba(0,0,0,.12); text-shadow:0 3px 4px rgba(255,255,255,.75); }

/* è¡¨å–®åˆ— */
.row{ display:flex; gap:var(--gap); align-items:center; flex-wrap:wrap; margin-top:10px; }
.row label{ width:var(--label-w); opacity:.92; white-space:nowrap; font-weight:700; -webkit-text-stroke:0; text-shadow:none; }
.row input,.row select,.row button{
  height:38px; font-size:14px; background:#fff; padding:8px 10px; border:1px solid var(--rim); border-radius:10px;
  -webkit-text-stroke:.25px rgba(0,0,0,.12); text-shadow:0 1px 0 rgba(255,255,255,.5);
}
.row input,.row select{ box-shadow: 0 2px 0 rgba(0,0,0,.08), 0 2px 8px rgba(0,0,0,.04); }

#displayName{ width:var(--w-displayName); } /* æš±ç¨±å”¯è®€ */
#instrument{  width:var(--w-instrument); }
#lastNote{ width:var(--w-lastNote); text-align:center; letter-spacing:.3px; }
#lastNote::placeholder{ text-align:center; }

@media (min-width: 861px){ .align-to-email{ margin-left: 0; } }

/* æŒ‰éˆ• */
.row button{ width:120px; cursor:pointer; font-weight:700; transition: transform .08s ease, box-shadow .08s ease, filter .08s ease;
             box-shadow: 0 2px 0 rgba(0,0,0,.15), 0 2px 8px rgba(0,0,0,.06); }
.btn-compact{ width:60px !important; } /* âœ… å¯æ›´æ”¹ï¼šç¸®ç‰ˆæŒ‰éˆ•å¯¬ */
#hintBtn{ width: var(--w-hintbtn) !important; } /* å‚™è¨»æŒ‰éˆ•å¯¬ */

.row button:disabled{ opacity:.55; cursor:not-allowed; }
.row button:active, .row button.pressed{ transform: translateY(1px) scale(.99); box-shadow: 0 1px 0 rgba(0,0,0,.18), 0 1px 4px rgba(0,0,0,.06); filter: brightness(.98); }

/* ç‹€æ…‹åˆ—ï¼ˆæ–‡æ¡ˆä¿æŒä½ è¦çš„å››ç¨®ï¼‰ */
#status{
  background: var(--soft); border:1px solid var(--neutral); border-radius:12px; padding:10px; margin-top:10px; font-size:14px; white-space:pre-wrap;
  text-align:center; color: var(--accent) !important; font-weight:700; -webkit-text-stroke:.35px rgba(0,0,0,.10);
  text-shadow:0 1px 0 rgba(255,255,255,.85), 0 3px 6px rgba(0,0,0,.04);
}
#status.ok,#status.busy,#status.err{ color: var(--accent) !important; font-weight:700; -webkit-text-stroke:.35px rgba(0,0,0,.10);
                                     text-shadow:0 1px 0 rgba(255,255,255,.85), 0 3px 6px rgba(0,0,0,.04); }

/* å‚™è¨»å°æµ®å±¤ */
.actions-inline{ display:flex; gap:var(--gap); position:relative; }
.hint-popover{ position:absolute; right:0; top:44px; z-index:50; max-width: var(--hint-maxw); min-width: 260px; padding:10px 12px; font-size:var(--hint-fz);
               line-height:1.45; color:var(--accent); background:#fff; border:1px solid var(--accent); border-radius:12px;
               box-shadow:0 8px 24px rgba(0,0,0,.10), 0 2px 8px rgba(0,0,0,.06); display:none; white-space:normal; --arrow-x: calc(100% - 24px); }
.hint-popover.show{ display:block; }
.hint-popover::before{ content:""; position:absolute; left:var(--arrow-x); top:-8px; transform:translateX(-50%); width:0; height:0;
  border-left:8px solid transparent; border-right:8px solid transparent; border-bottom:8px solid var(--accent); }
.hint-popover::after{ content:""; position:absolute; left:var(--arrow-x); top:-7px; transform:translateX(-50%); width:0; height:0;
  border-left:7px solid transparent; border-right:7px solid transparent; border-bottom:7px solid #fff; }

/* éµç›¤å®¹å™¨ */
.kb-wrap{ overflow-x:auto; -webkit-overflow-scrolling:touch; background:var(--soft); border:1px solid var(--rim); border-radius:14px; margin-top:14px; }
#keyboard{ position:relative; height:var(--kb-h); user-select:none; -webkit-user-select:none; touch-action: pan-x pan-y; }

/* ========== é‹¼ç´å¤–è§€ï¼ˆç¶­æŒä½ çš„åŸæ¨£å¼ï¼‰ ========== */
.white{
  position:absolute; bottom:0; height:100%;
  background:linear-gradient(#ffffff,#eceef3 72%,#d9dde5);
  border-radius:0 0 12px 12px;
  box-shadow:inset 0 -12px 16px rgba(0,0,0,.12), inset 0 1px 0 rgba(255,255,255,.9), 0 1px 0 rgba(0,0,0,.04);
}
.white::after{ content:""; position:absolute; top:0; bottom:0; right:0; width:var(--sep); background:linear-gradient(transparent,#cfd3dc 50%,transparent); }
.white:first-child::before{ content:""; position:absolute; top:0; bottom:0; left:0; width:var(--sep); background:linear-gradient(transparent,#cfd3dc 50%,transparent); }
.white.active{ filter:brightness(1.06); }
.black{
  position:absolute; bottom:38%; height:62%;
  background:linear-gradient(#2d2f36,#0e0f13);
  border:1px solid #0b0d11; border-top:none; border-radius:0 0 10px 10px;
  z-index:5; box-shadow:inset 0 -6px 10px rgba(0,0,0,.45), 0 3px 10px rgba(0,0,0,.35);
  transform: translateX(-50%);
}
.black.active{ filter:brightness(1.22); }

/* ========== å‰ä»–å¤–è§€ï¼ˆå®Œæ•´ç‰ˆè¦–è¦ºï¼‰ ========== */
.fretboard{
  position:relative; width:100%; height:var(--kb-h);
  background:linear-gradient(90deg,#6b4a2e,#835b3a 45%,#7b5233 55%,#6f472c); /* æŒ‡æ¿æœ¨ç´‹ */
  border-radius:14px; box-shadow:inset 0 0 30px rgba(0,0,0,.25);
  overflow:hidden;
}
.fretboard::before{ /* ä¸Šæ• (nut) */
  content:""; position:absolute; left:0; top:0; bottom:0; width:10px;
  background:linear-gradient(#eee,#d9d9d9); box-shadow:2px 0 6px rgba(0,0,0,.25);
}
.fretboard::after{ /* æŒ‡æ¿å…‰æšˆ */
  content:""; position:absolute; inset:0; pointer-events:none;
  background:radial-gradient(ellipse at 50% -30%, rgba(255,255,255,.18), transparent 60%);
}

/* å“ï¼ˆfretï¼‰ */
.fret{
  position:absolute; top:0; bottom:0; width:2px; background:linear-gradient(#cfcfcf,#b1b1b1);
  box-shadow:0 0 8px rgba(0,0,0,.25);
}
.fret.mark{ background:linear-gradient(#e5e5e5,#cfcfcf); }

/* å“è¨˜è™Ÿï¼ˆinlayï¼‰ */
.inlay{
  position:absolute; transform:translate(-50%,-50%); width:10px; height:10px; border-radius:50%;
  background:radial-gradient(#fafafa,#dcdcdc);
  box-shadow:0 2px 4px rgba(0,0,0,.25);
}

/* å‰ä»–å¼¦ */
.string{
  position:absolute; left:0; right:0; height:2px;
  background:linear-gradient(#bfbfbf,#9d9d9d);
  box-shadow:0 1px 0 rgba(0,0,0,.25);
}
.string:nth-child(1){ height:3px; }
.string:nth-child(2){ height:3px; }

/* å¯é»æ“ŠéŸ³ä½ */
.note-hotspot{
  position:absolute; width:2.8%; height:14.5%; transform:translate(-50%,-50%);
  border-radius:10px; cursor:pointer;
}
.note-hotspot:hover{ outline:2px solid rgba(255,255,255,.25); }
.note-hotspot.active{ outline:3px solid rgba(255,255,255,.6); }

/* Dialog / Footer */
.overlay{ position:fixed; inset:0; z-index:9999; display:flex; align-items:center; justify-content:center; background:rgba(17,24,39,.35); backdrop-filter:blur(3px); pointer-events:auto; }
.overlay.hidden{ display:none; }
.dialog{ min-width:300px; max-width:92vw; background:var(--soft); border:1px solid var(--neutral); border-radius:14px; padding:18px;
         box-shadow:0 18px 44px rgba(0,0,0,.18); text-align:center; pointer-events:auto; }
.dialog h3{ margin:0 0 8px; font-size:18px; color:#6b5e52; }
.dialog .actions{ display:flex; gap:10px; justify-content:center; margin-top:12px; }
.dialog button{ width:120px; height:38px; border-radius:10px; border:1px solid var(--rim); background:#fff; cursor:pointer; font-weight:700; }
.dialog button.primary{ background:#fff; }

#lockScreen{ position:fixed; inset:0; z-index:9998; display:none; background:transparent; }
footer{ max-width:1060px;margin:8px auto 22px; text-align:center; color:#6b5e52; font-size:12px; opacity:.9; }

@media (orientation:portrait){
  .row-line2,.row-line3{ width:100%; gap:12px; }
  .pair{ display:flex; align-items:center; gap:var(--gap); width:100%; }
  .actions-inline{ display:flex; gap:var(--gap); }
  .row-line2 .pair, .row-line3 .pair, .row-line3 .actions-inline{ flex:0 0 100%; }
  .align-to-email{ margin-left:0 !important; }
  #lastNote{ width:var(--w-lastNote-m); }
}
</style>

<body>
<img class="bg-notes" src="./assets/notes.png" alt="">
<div class="panel">
  <h2>ğŸ¼äº’å‹•éŸ³ç¬¦ğŸµ</h2>

  <div class="row row-line2">
    <div class="pair">
      <label for="displayName">æš±ç¨±ï¼ˆLINEï¼‰ï¼š</label>
      <input id="displayName" readonly aria-readonly="true" placeholder="ç­‰å¾…è¼‰å…¥â€¦" />
    </div>
    <div class="pair">
      <label for="instrument">æ¨‚å™¨è½‰æ›ï¼š</label>
      <select id="instrument">
        <option value="piano" selected>é‹¼ç´</option>
        <option value="guitar">å‰ä»–</option>
      </select>
    </div>
    <div class="pair">
      <label for="lastNote" class="align-to-email">éŸ³ç¬¦ç´€éŒ„ï¼š</label>
      <input id="lastNote" placeholder="â€” , â€” , â€”" readonly />
    </div>
    <div class="actions-inline">
      <button id="resetBtn" type="button" class="btn-compact">é‡è¨­</button>
      <button id="lockBtn"  type="button" class="btn-compact" disabled>é–å®š</button>
      <button id="hintBtn"  type="button" class="btn-compact" aria-expanded="false" aria-controls="hintPopover" title="é»æˆ‘æŸ¥çœ‹å‚™è¨»">å…ˆé»æˆ‘æŸ¥çœ‹å¥½å’ªğŸ¥º</button>
      <div id="hintPopover" class="hint-popover" role="note" aria-live="polite">
        æŒ‰ã€Œé–å®šã€å¾Œè«‹ç¨å€™ï¼Œæœ¬äººæœ‰ç¼ºé™·å°è‡´é€Ÿåº¦è¼ƒæ…¢ğŸ¥²<br>ç¢ºèªé€å‡ºæˆåŠŸï¼Œä¸‹æ–¹ã€Œç‹€æ…‹åˆ—ã€æœƒç«‹å³é€šçŸ¥æ‚¨æºœğŸ‰
      </div>
    </div>
  </div>

  <p id="status">å°šæœªåˆå§‹åŒ–</p>
  <div class="kb-wrap"><div id="keyboard"></div></div>
</div>

<!-- æ“ä½œèªªæ˜ -->
<div id="guideOverlay" class="overlay" role="dialog" aria-modal="true" aria-labelledby="guideTitle">
  <div class="dialog">
    <h3 id="guideTitle">ğŸ“æ“ä½œèªªæ˜ğŸ“</h3>
    <p>ğŸ”»æœ¬é æœƒè‡ªå‹•è®€å–ä½ çš„ LINE æš±ç¨±</p><p>â†“</p>
    <p>ğŸ”»å¯é¸æ“‡é‹¼ç´æˆ–å‰ä»–ä¸­çš„ä¸‰å€‹éŸ³éš</p><p>â†“</p>
    <p>ğŸ”»ä¸‰å€‹éŸ³éšç¢ºèªå¾Œï¼Œä¸€å®šè¦æŒ‰é–å®š</p><p>â†“</p>
    <p>ğŸ”»é–å®šå®Œæˆå¾Œï¼Œæœƒæœ‰é€šçŸ¥æ˜¯å¦æˆåŠŸ</p><p>â†“</p>
    <p>ğŸ”ºè‹¥æˆåŠŸå³å¯é€€å‡ºä»‹é¢ï¼›åä¹‹å†è©¦</p><p>â†“</p>
    <p>â—ï¸æ²’æŒ‰é–å®šå°±æ˜¯æ²’æœ‰é€å‡ºå°±æ˜¯å½ˆå€‹å¯‚å¯</p>
    <div class="actions"><button id="guideOk" class="primary">äº†è§£</button></div>
  </div>
</div>

<!-- å•ŸéŸ³ -->
<div id="unlockOverlay" class="overlay hidden" role="dialog" aria-modal="true" aria-labelledby="unlockTitle">
  <div class="dialog">
    <h3 id="unlockTitle">å•Ÿç”¨è²éŸ³</h3>
    <p class="ios-hint">iPhoneè«‹ç¢ºä¿å´é‚Šã€ŒéœéŸ³éµã€æœ‰é–‹å•ŸéŸ¿éˆ´æ¨¡å¼</p>
    <div class="actions">
      <button id="cancelUnlock">å–æ¶ˆ</button>
      <button id="confirmUnlock" class="primary">ç¢ºå®š</button>
    </div>
  </div>
</div>

<div id="lockScreen" aria-hidden="true"></div>
<footer>Â© Copyright 2025 MYâ€˜s System</footer>

<!-- ====================== å¤–éƒ¨è…³æœ¬ï¼ˆCDNï¼‰ ======================
  âœ… å¯æ›´æ”¹ï¼šå¦‚éœ€é–ç‰ˆæœ¬å¯å›ºå®šç‰ˆè™Ÿ
  1) LIFF SDKï¼ˆLINE Front-end Frameworkï¼‰
     ä¾†æºï¼šLINE å®˜æ–¹ CDNï¼ˆhttps://static.line-scdn.netï¼‰
  2) Tone.jsï¼ˆWeb Audio åˆæˆï¼å–æ¨£æ’­æ”¾ï¼‰
     ä¾†æºï¼šjsDelivr CDNï¼ˆhttps://cdn.jsdelivr.netï¼‰
============================================================== -->
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script> <!-- LIFF å®˜æ–¹ SDKï¼ˆLINEï¼‰ -->
<script src="https://cdn.jsdelivr.net/npm/tone@14.8.49/build/Tone.min.js"></script> <!-- Tone.js éŸ³è¨Šåº«ï¼ˆjsDelivrï¼‰ -->

<script>
/* ====================== å‰ç«¯è¨­å®šï¼ˆè«‹å¡«ï¼‰ ====================== */
/* âœ… å¯æ›´æ”¹ï¼šLIFF ID èˆ‡å¾Œç«¯ç¶²å€ */
const LIFF_ID = '2008149060-ZGVdAvGo';  // ä¾‹ï¼š'2008149060-xxxxxxx'
const WEBHOOK = 'https://script.google.com/macros/s/AKfycbxJRuBRCcdJC8v32t-BJVh6jiP7lECUMFoF-sw1ywBekkd5OxLxuWh4-_mBDushopJl/exec';

/* âœ… å¯æ›´æ”¹ï¼šé€¾æ™‚æ¯«ç§’ï¼ˆæé«˜åˆ° 20 ç§’ï¼‰ */
const TIMEOUT_MS = 20000;

/* ï¼ˆé ç•™ï¼‰ä¸€æ®µè©±ï¼šæœƒä¸€ä½µé€åˆ°å¾Œç«¯ logs G æ¬„ï¼ˆç›®å‰ä¸é¡¯ç¤ºè¼¸å…¥æ¡†ï¼Œä¹‹å¾Œä½ è¦ç”¨å†æ¥UIï¼‰ */
let extraMessage = ''; // âœ… å¯æ›´æ”¹ï¼šä¹‹å¾Œè‹¥åšè¼¸å…¥æ¡†ï¼Œæ”¹å¯«é€™å€‹è®Šæ•¸å³å¯ä¸€ä½µé€å‡º

const $ = s => document.querySelector(s);

/* ç‹€æ…‹åˆ—ï¼ˆå›ºå®šå››ç¨®èªæ„ï¼‰ */
function setStatus(m){
  const el = $('#status');
  el.textContent = m;
  el.classList.remove('ok','busy','err');
  if(/å·²é€å‡ºæˆåŠŸ/.test(m)) el.classList.add('ok');
  else if(/å¿™ç¢Œ|ç­‰å¾…|é€å‡ºä¸­/i.test(m)) el.classList.add('busy');
  else if(/å·²å¡«å¯«é|æˆªæ­¢|å¤±æ•—|é€¾æ™‚|not found/i.test(m)) el.classList.add('err');
}

/* æ–‡å­—æ¸…æ´—ï¼šæŠŠæš±ç¨±é–‹é ­çš„å†’è™Ÿã€é»ã€ç ´æŠ˜ç­‰æ‹¿æ‰ */
function sanitizeName(s){
  return String(s||'').replace(/^[\s:ï¼šÂ·â€¢-]+/, '');
}

/* ====================== éŸ³è¨Šèˆ‡é¸éŸ³ ====================== */
let audioCtx=null, sampler=null, samplerReady=false, unlocked=false, hardLocked=false;
let currentInstrument='piano';
let selectedNotes=[], selectedInsts=[];

/* âœ… å¯æ›´æ”¹ï¼šéŸ³è‰²æª”è·¯å¾‘èˆ‡æª”åè¡¨ï¼ˆè«‹æŠŠæª”æ¡ˆæ”¾åœ¨ä½ çš„ç«™é»è·¯å¾‘ä¸‹ï¼‰ */
const PIANO_BASE = new URL('./piano/', location.href).href;   /* âœ… å¯æ›´æ”¹ï¼šé‹¼ç´éŸ³è‰²è³‡æ–™å¤¾ */
const GUITAR_BASE = new URL('./guitar/', location.href).href; /* âœ… å¯æ›´æ”¹ï¼šå‰ä»–éŸ³è‰²è³‡æ–™å¤¾ */
const PIANO_URLS = { /* âœ… å¯æ›´æ”¹ï¼šé‹¼ç´æ¡æ¨£æ˜ å°„ */
  'A1':'A1.mp3','C2':'C2.mp3','D#2':'Ds2.mp3','F#2':'Fs2.mp3',
  'A2':'A2.mp3','C3':'C3.mp3','D#3':'Ds3.mp3','F#3':'Fs3.mp3',
  'A3':'A3.mp3','C4':'C4.mp3','D#4':'Ds4.mp3','F#4':'Fs4.mp3',
  'A4':'A4.mp3','C5':'C5.mp3'
};
/* âœ… å¯æ›´æ”¹ï¼šå‰ä»–è‹¥æœ‰å¤šæ¡æ¨£å¯è£œé½Šå°æ˜ ï¼Œæ²’æœ‰å°±ä»¥é–‹æ”¾å¼¦è¿‘ä¼¼ */
const GUITAR_URLS = {'E2':'E2.wav','A2':'A2.wav','D3':'D3.wav','G3':'G3.wav','B3':'B3.wav','E4':'E4.wav'};
const GUITAR_OPEN = ['E2','A2','D3','G3','B3','E4']; // 1~6 å¼¦é–‹æ”¾éŸ³

/* é‹¼ç´ç™½éµåºåˆ—èˆ‡é»‘éµå°æ‡‰ */
const WHITE=["C3","D3","E3","F3","G3","A3","B3","C4","D4","E4","F4","G4","A4","B4"];
const BLACK_AFTER={ 'C':'C#','D':'D#','F':'F#','G':'G#','A':'A#' };
const MIN_WHITE_PX=64, TOTAL_WHITE=WHITE.length;

/* å‰ä»–åŠéŸ³æ˜ å°„ï¼šæŸå¼¦ç¬¬ f å“ = é–‹æ”¾éŸ³ + f åŠéŸ³ */
const SEMI_MAP = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
function addSemitone(noteName, semis){
  const m = /^([A-G]#?)(\d)$/.exec(noteName);
  if(!m) return noteName;
  const base = m[1], oct = parseInt(m[2],10);
  let idx = SEMI_MAP.indexOf(base);
  if(idx<0) return noteName;
  let total = (oct*12) + idx + semis;
  const newOct = Math.floor(total/12);
  const newIdx = ((total%12)+12)%12;
  return SEMI_MAP[newIdx] + newOct;
}

/* éŸ³è¨Šåˆå§‹åŒ–èˆ‡æ¡æ¨£è¼‰å…¥ */
function unlockAudioInit(){
  const Ctx=window.webkitAudioContext||window.AudioContext;
  if(!audioCtx) audioCtx=new Ctx({latencyHint:'interactive'});
  Tone.setContext(new Tone.Context(audioCtx));
}
async function unlockAudio(){
  try{
    unlockAudioInit();
    if(audioCtx.state!=='running') await audioCtx.resume();
    await Tone.start();
    loadSampler(currentInstrument);
    unlocked=true;
    $('#unlockOverlay').classList.add('hidden');
  }catch(e){ setStatus('å•Ÿç”¨å¤±æ•—ï¼š'+e.message); }
}
function loadSampler(inst='piano'){
  sampler?.dispose?.(); sampler=null; samplerReady=false;
  let urls=PIANO_URLS, base=PIANO_BASE, label='ğŸ¹ ';
  if(inst==='guitar'){ urls=GUITAR_URLS; base=GUITAR_BASE; label='ğŸ¸ '; }
  setStatus(label+'è¼‰å…¥ä¸­â€¦');
  try{
    sampler=new Tone.Sampler({ urls, release:1, baseUrl:base, onload:()=>{ samplerReady=true; setStatus(label+'å·²è¼‰å…¥ âœ…'); } }).toDestination();
  }catch(e){ setStatus('âŒ éŸ³è‰²åˆå§‹åŒ–å¤±æ•—ï¼š'+e.message); }
}

/* å½ˆéŸ³é‚è¼¯ï¼ˆåƒ…å– 3 é¡†ï¼›ç¬¬ 4 é¡†è¦†è“‹ç¬¬ 3 é¡†ï¼‰ */
function trigger(note){
  if(hardLocked) return;
  if(!samplerReady){ setStatus('éŸ³è‰²è¼‰å…¥ä¸­â€¦'); return; }
  sampler.triggerAttackRelease(note,'8n');
  if(selectedNotes.length<3){ selectedNotes.push(note); selectedInsts.push(currentInstrument); }
  else { selectedNotes[2]=note; selectedInsts[2]=currentInstrument; }
  refreshNotesDisplay();
  validateLockBtn();
}
function refreshNotesDisplay(){
  const parts=[selectedNotes[0]||'â€”', selectedNotes[1]||'â€”', selectedNotes[2]||'â€”'];
  $('#lastNote').value = parts.join(' , ');
}
function validateLockBtn(){
  $('#lockBtn').disabled = !(selectedNotes.length===3);
}

/* ========== é‹¼ç´ç¹ªè£½ ========== */
function renderPiano(){
  const kb=$('#keyboard'); kb.innerHTML=''; kb.className=''; sizePiano();
  const keyW=100/TOTAL_WHITE;
  WHITE.forEach((note,i)=>{
    const w=document.createElement('div'); w.className='white'; w.dataset.note=note;
    w.style.left=(i*keyW)+'%'; w.style.width=keyW+'%';
    w.addEventListener('pointerdown', ()=>{ if(hardLocked) return; if(!unlocked){ $('#unlockOverlay').classList.remove('hidden'); return; } trigger(note); w.classList.add('active'); });
    w.addEventListener('pointerup', ()=>w.classList.remove('active'));
    kb.appendChild(w);
  });
  WHITE.forEach((note,i)=>{
    const l=note[0], sharp = BLACK_AFTER[l]? (BLACK_AFTER[l]+note.slice(1)) : null;
    if(!sharp || (l==='A' && i===TOTAL_WHITE-1)) return;
    const b=document.createElement('div'); b.className='black'; b.dataset.note=sharp;
    const blackWidthPct = keyW*0.62; b.style.width = blackWidthPct+'%'; b.style.left=((i+1)*keyW)+'%';
    b.addEventListener('pointerdown', ()=>{ if(hardLocked) return; if(!unlocked){ $('#unlockOverlay').classList.remove('hidden'); return; } trigger(sharp); b.classList.add('active'); });
    b.addEventListener('pointerup', ()=>b.classList.remove('active'));
    kb.appendChild(b);
  });
}
function sizePiano(){
  const wrap=document.querySelector('.kb-wrap');
  const kb=document.querySelector('#keyboard');
  const wrapW=wrap.clientWidth;
  const sep=parseInt(getComputedStyle(kb).getPropertyValue('--sep')||'2',10);
  const minW=WHITE.length*(MIN_WHITE_PX+sep);
  kb.style.width=(wrapW>=minW?wrapW-1:minW)+'px';
  kb.style.height='var(--kb-h)';
}

/* ========== å‰ä»–ç¹ªè£½ï¼ˆå®Œæ•´ç‰ˆå¤–è§€ï¼‰ ========== */
function renderGuitar(){
  const kb=$('#keyboard'); kb.innerHTML=''; kb.className='fretboard';

  const FRETS = 13;       // 0~12 å“
  const STRINGS = 6;      // å…­æ¢å¼¦ï¼ˆä¸‹åˆ°ä¸Šï¼‰

  // å“
  for(let f=1; f<=FRETS; f++){
    const x = (f/(FRETS))*100;
    const v = document.createElement('div');
    v.className='fret' + ((f%2===0)?' mark':'');
    v.style.left = `calc(${x}% - 1px)`;
    kb.appendChild(v);

    // å“è¨˜è™Ÿ
    if([3,5,7,9].includes(f)){
      const dot = document.createElement('div');
      dot.className='inlay';
      dot.style.left = `calc(${( (f-0.5)/FRETS )*100}% )`;
      dot.style.top  = '50%';
      kb.appendChild(dot);
    }
    if(f===12){
      const d1=document.createElement('div'); d1.className='inlay'; d1.style.left=`calc(${( (f-0.5)/FRETS )*100}% )`; d1.style.top='38%';
      const d2=document.createElement('div'); d2.className='inlay'; d2.style.left=`calc(${( (f-0.5)/FRETS )*100}% )`; d2.style.top='62%';
      kb.appendChild(d1); kb.appendChild(d2);
    }
  }
  // å¼¦
  for(let s=1; s<=STRINGS; s++){
    const y = (s/(STRINGS+1))*100;
    const h = document.createElement('div');
    h.className='string';
    h.style.top = `calc(${y}% - 1px)`;
    kb.appendChild(h);
  }
  // é»æ“Šå€ï¼ˆ0~12 å“ï¼‰
  for(let s=1; s<=STRINGS; s++){
    const base = GUITAR_OPEN[s-1];
    const yPct = (s/(STRINGS+1))*100;
    for(let f=0; f<=12; f++){
      const xPct = ((f+0.5)/FRETS)*100;
      const note = addSemitone(base, f);
      const spot = document.createElement('div');
      spot.className='note-hotspot';
      spot.style.left = `calc(${xPct}% + 5px)`;
      spot.style.top  = `calc(${yPct}% )`;
      spot.addEventListener('pointerdown', ()=>{
        if(hardLocked) return;
        if(!unlocked){ $('#unlockOverlay').classList.remove('hidden'); return; }
        spot.classList.add('active');
        trigger(note);
      });
      spot.addEventListener('pointerup', ()=>spot.classList.remove('active'));
      kb.appendChild(spot);
    }
  }
}

/* å°ºå¯¸è®Šæ›´æ™‚é‡ç¹ª */
window.addEventListener('resize', ()=>{ if(currentInstrument==='piano') sizePiano(); });
window.addEventListener('orientationchange', ()=>{ if(currentInstrument==='piano') sizePiano(); });

/* æ¨‚å™¨åˆ‡æ› */
$('#instrument').addEventListener('change', ()=>{
  if(hardLocked) return;
  currentInstrument=$('#instrument').value;
  loadSampler(currentInstrument);
  if(currentInstrument==='guitar') renderGuitar(); else renderPiano();
  validateLockBtn();
});

/* é‡è¨­ä¸€é¡†ï¼ˆå¾å°¾ç«¯é€€ä¸€æ ¼ï¼‰ */
$('#resetBtn').addEventListener('click', ()=>{
  if(hardLocked) return;
  if(selectedNotes.length>0){ selectedNotes.pop(); selectedInsts.pop(); refreshNotesDisplay(); validateLockBtn(); }
});

/* å‚™è¨»å°æµ®å±¤ */
const hintBtn=$('#hintBtn'), hintPop=$('#hintPopover');
function positionArrow(){
  const popRect=hintPop.getBoundingClientRect(), btnRect=hintBtn.getBoundingClientRect();
  const x=(btnRect.left+btnRect.width/2)-popRect.left;
  const clamped=Math.max(16, Math.min(popRect.width-16, x));
  hintPop.style.setProperty('--arrow-x', clamped+'px');
}
function closeHint(){ hintPop.classList.remove('show'); hintBtn.setAttribute('aria-expanded','false'); }
hintBtn.addEventListener('click', (e)=>{
  const showing=hintPop.classList.toggle('show');
  hintBtn.setAttribute('aria-expanded', showing?'true':'false');
  if(showing){ positionArrow(); }
  e.stopPropagation();
});
document.addEventListener('click', (e)=>{ if(!hintPop.classList.contains('show')) return;
  const within=hintPop.contains(e.target)||hintBtn.contains(e.target);
  if(!within) closeHint(); });
window.addEventListener('resize', ()=>{ if(hintPop.classList.contains('show')) positionArrow(); });
window.addEventListener('orientationchange', ()=>{ setTimeout(()=>{ if(hintPop.classList.contains('show')) positionArrow(); }, 250); });
window.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeHint(); });

/* ====================== é–å®šé€å‡º ====================== */
let lineId='', displayName='', pictureUrl='';
$('#lockBtn').addEventListener('click', async ()=>{
  if(hardLocked) return;
  if(selectedNotes.length!==3){ alert('è«‹å½ˆæ»¿ 3 å€‹éŸ³å†é–å®š'); return; }

  // é€å‡ºå‰ä¿éšªæ¸…æ´—æš±ç¨±ï¼ˆç§»é™¤é–‹é ­å†’è™Ÿç­‰ï¼‰
  displayName = sanitizeName(displayName);

  setStatus('â³ é€å‡ºä¸­â€¦');
  const payload = {
    action: 'submitNotes',
    lineId, displayName, pictureUrl,          // B, D æœƒç”¨åˆ°ï¼›C=é ­è²¼ç”±å¾Œç«¯å¯«å…¥
    instrumentsCSV: selectedInsts.join(','),  // E æ¬„
    notesCSV:       selectedNotes.join(','),  // F æ¬„
    extraMessage                               // G æ¬„ï¼ˆé ç•™ï¼‰
  };

  const controller=new AbortController();
  const timer=setTimeout(()=>controller.abort(), TIMEOUT_MS);

  try{
    const r=await fetch(WEBHOOK,{
      method:'POST',
      // âœ… ç”¨ text/plain é¿å… CORS é æª¢ï¼ˆOPTIONSï¼‰
      headers:{ 'Content-Type':'text/plain; charset=utf-8' },
      body:JSON.stringify(payload),
      signal:controller.signal
    });
    clearTimeout(timer);

    let j={}; try{ j=await r.json(); }catch(_){ j={}; }

    if(j.ok){
      setStatus('âœ… å·²é€å‡ºæˆåŠŸï¼Œå¯é€€å®‰å›‰');
      enterHardLock();
    }else{
      const err=String(j.error||'');
      if(err==='duplicate') setStatus('å·²å¡«å¯«éäº†ï¼Œæƒ³è¦æ›´æ›éŸ³éšè«‹æ´½ã„Ÿå’ªğŸ™');
      else if(err==='deadline_passed') setStatus('å·²éæˆªæ­¢æ—¥ï¼Œä½†é‚„å¯åœ¨é€™ç©è€å”·ğŸ‘£');
      else if(err==='busy') setStatus('âš ï¸ ç³»çµ±å¿™ç¢Œï¼Œç¨å¾Œå†è©¦ğŸŒ€');
      else setStatus('âš ï¸ é€å‡ºé€¾æ™‚æˆ–ç¶²è·¯ç•°å¸¸ï¼Œè«‹é‡æ–°å†è©¦');
    }
  }catch(e){
    setStatus('âš ï¸ é€å‡ºé€¾æ™‚æˆ–ç¶²è·¯ç•°å¸¸ï¼Œè«‹é‡æ–°å†è©¦');
  }
});

function enterHardLock(){
  hardLocked=true;
  $('#displayName').disabled=true;
  $('#instrument').disabled=true;
  $('#resetBtn').disabled=true;
  $('#lockBtn').disabled=true;
  $('#lockScreen').style.display='block';
}

/* ====================== å°è©±æ¡†æµç¨‹ ====================== */
['click','touchend'].forEach(evt=>{
  document.addEventListener(evt,(e)=>{
    const t=e.target;
    if(t.id==='guideOk'){
      document.getElementById('guideOverlay').classList.add('hidden');
      document.getElementById('unlockOverlay').classList.remove('hidden');
      e.preventDefault();
    }else if(t.id==='cancelUnlock'){
      document.getElementById('unlockOverlay').classList.add('hidden');
      e.preventDefault();
    }else if(t.id==='confirmUnlock'){
      unlockAudio();
      document.getElementById('unlockOverlay').classList.add('hidden');
      e.preventDefault();
    }
  }, {passive:true});
});

/* ====================== åˆå§‹åŒ–ï¼ˆç•«é¢ / LIFF / Profileï¼‰ ====================== */
async function init(){
  renderPiano();                 // é è¨­å…ˆç•«é‹¼ç´
  setStatus('ç­‰å¾…å•Ÿç”¨è²éŸ³â€¦');
  validateLockBtn();
  $('#guideOverlay').classList.remove('hidden');

  try{
    setStatus('åˆå§‹åŒ– LIFFâ€¦');
    await liff.init({ liffId: LIFF_ID, withLoginOnExternalBrowser: true });

    if(!liff.isLoggedIn()){
      // âœ… è¦æ±‚ openid + profile scopeï¼Œé¿å…å–ä¸åˆ° userId / displayName
      liff.login({ scope: ['openid','profile'] });
      return; // æœƒé‡æ–°å°å›æœ¬é 
    }
    if(liff.ready){ await liff.ready; } // æŸäº›ç€è¦½å™¨éœ€è¦ç­‰ ready

    let prof = null, idt = null;
    try{ prof = await liff.getProfile(); }catch(_){}
    try{ idt  = liff.getDecodedIDToken(); }catch(_){}

    // å…©æ¢è·¯éƒ½è©¦ï¼šgetProfile èˆ‡ ID Token
    lineId      = (prof && prof.userId) || (idt && idt.sub) || '';
    displayName = (prof && prof.displayName) || (idt && (idt.name || idt.nickname)) || '';
    pictureUrl  = (prof && prof.pictureUrl) || '';

    displayName = sanitizeName(displayName);              // â† æ¸…æ‰é–‹é ­å†’è™Ÿ/ç¬¦è™Ÿ
    if(!lineId){
      setStatus('è«‹æ–¼ LINE App å…§é–‹å•Ÿæ­¤é€£çµé‡è©¦ï¼ˆç„¡æ³•å–å¾— LINE IDï¼‰');
      return;
    }
    $('#displayName').value = displayName || 'ï¼ˆåŒ¿åï¼‰';
    setStatus('å·²å°±ç·’');
  }catch(e){
    setStatus('LIFF åˆå§‹åŒ–å¤±æ•—ï¼š'+e.message);
  }
}
window.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
