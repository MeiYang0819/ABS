<!doctype html> <html lang="zh-Hant"> <meta charset="utf-8" /> <meta name="viewport" content="width=device-width, initial-scale=1" /> <title>🎶互動音符</title> <link rel="preconnect" href="https://fonts.googleapis.com"> <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin> <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700&display=swap" rel="stylesheet"> <style> /* === 站內配色與欄寬（最常改）=== */ /* ✅ 可調整：主配色、欄寬、陰影、間距 */ :root{ --brand:#D4BFAA; /* ✅ 可調整：頁面背景主色 */ --title:#A68A7C; /* ✅ 可調整：標題字色 */ --neutral:#E4E4E4; /* ✅ 可調整：面板底色/邊框色 */ --soft:#F5F1EC; /* ✅ 可調整：狀態列/鍵盤底色 */ --accent:#BFA5A0; /* ✅ 可調整：重點文字顏色 */ --rim:#E4E4E4; /* ✅ 可調整：輸入框邊框色 */ --ink:#0f172a; /* ✅ 可調整：內文字色 */ /* ✅ 可調整：各欄位寬度（桌機） */ --w-displayName: 96px; --w-email: 261px; --w-code: 96px; --w-instrument: 96px; --w-lastNote: 125px; --w-lastNote-m: 160px; /* ✅ 可調整：排版間距 */ --label-w:88px; /* 標籤寬 */ --gap:10px; /* 欄間距 */ --kb-h:280px; /* 樂器高度 */ --sep:2px; /* 白鍵分隔線寬 */ /* 🧩 進階可調：整體描邊/高光（改了會影響全站視覺） */ --stroke:rgba(0,0,0,.18); --glow:rgba(255,255,255,.65); /* ✅ 可調整：提示按鈕與備註字級 */ --w-hintbtn: 160px; /* 說明按鈕寬度 */ --hint-fz: 12px; /* 備註字體大小 */ --hint-maxw: 520px; /* 備註最大寬度 */ } /* === 全站字體與粗細（常改）=== */ /* 🧩 進階可調：若想關閉整站粗體/描邊，改這裡 */ *{ box-sizing:border-box; font-family:"Zen Maru Gothic","Noto Sans TC",system-ui,-apple-system,sans-serif !important; -webkit-text-stroke:.35px var(--stroke); text-shadow:0 1px 0 var(--glow); } html,body{ margin:0; color:var(--ink); background:var(--brand); font-weight:700; } /* 🔒 請勿更動流程：操作說明維持原樣（不粗體） */ #guideOverlay .dialog, #guideOverlay .dialog *{ font-weight:500 !important; -webkit-text-stroke:0 !important; text-shadow:none !important; } /* === 版面容器（次常改）=== */ /* ✅ 可調整：外框、圓角、陰影 */ .bg-notes{ position:fixed; inset:0; width:100%; height:100%; object-fit:cover; opacity:.60; mix-blend-mode:multiply; filter:contrast(1.1); pointer-events:none; z-index:0; } .panel{ position:relative; z-index:1; max-width:1060px; margin:22px auto; background:var(--neutral); border:1px solid var(--neutral); border-radius:16px; padding:18px 18px 26px; box-shadow:0 10px 26px rgba(0,0,0,.10); backdrop-filter:blur(8px) saturate(115%); } /* === 標題（次常改）=== */ /* ✅ 可調整：字級、陰影、描邊 */ h2{ margin:4px 0 20px; text-align:center; font-size:2.8rem; font-weight:700; letter-spacing:1px; color:var(--title); -webkit-text-stroke:.6px rgba(0,0,0,.12); text-shadow:0 3px 4px rgba(255,255,255,.75); } /* === 表單列（常改）=== */ /* ✅ 可調整：欄位高度、圓角、陰影 */ .row{ display:flex; gap:var(--gap); align-items:center; flex-wrap:wrap; margin-top:10px; } .row label{ width:var(--label-w); opacity:.92; white-space:nowrap; font-weight:700; -webkit-text-stroke:0; text-shadow:none; } .row input,.row select,.row button{ height:38px; font-size:14px; background:#fff; padding:8px 10px; border:1px solid var(--rim); border-radius:10px; -webkit-text-stroke:.25px rgba(0,0,0,.12); text-shadow:0 1px 0 rgba(255,255,255,.5); } /* ✅ 可調整：微立體陰影 */ .row input,.row select{ box-shadow: 0 2px 0 rgba(0,0,0,.08), 0 2px 8px rgba(0,0,0,.04); } /* 欄位寬度（常改）*/ #displayName{ width:var(--w-displayName); } /* ✅ 可調整 */ #email{ width:var(--w-email); } /* ✅ 可調整 */ #code{ width:var(--w-code); } /* ✅ 可調整 */ #instrument{ width:var(--w-instrument); } /* ✅ 可調整 */ #lastNote{ width:var(--w-lastNote); text-align:center; letter-spacing:.3px; } /* ✅ 可調整 */ #lastNote::placeholder{ text-align:center; } /* 「音符紀錄」與上方「電子郵件」左緣對齊（桌機） */ @media (min-width: 861px){ .align-to-email{ margin-left: calc(var(--w-displayName) - var(--w-instrument)); } } /* ✅ 可調整 */ /* === 按鈕（常改）=== */ .row select option{text-align:center} .row button{ width:120px; cursor:pointer; font-weight:700; transition: transform .08s ease, box-shadow .08s ease, filter .08s ease; box-shadow: 0 2px 0 rgba(0,0,0,.15), 0 2px 8px rgba(0,0,0,.06); } .btn-compact{ width:60px !重要; } /* ✅ 可調整：縮版按鈕寬度 */ /* NEW: 說明按鈕（請點我）可自訂寬度，維持同高度 */ #hintBtn{ width: var(--w-hintbtn) !important; } /* ✅ 可調整 */ /* 互動狀態 */ .row button:disabled{ opacity:.55; cursor:not-allowed; } .row button:active, .row button.pressed{ transform: translateY(1px) scale(.99); box-shadow: 0 1px 0 rgba(0,0,0,.18), 0 1px 4px rgba(0,0,0,.06); filter: brightness(.98); } /* === 狀態列（常改）=== */ #status{ background: var(--soft); border:1px solid var(--neutral); border-radius:12px; padding:10px; margin-top:10px; font-size:14px; white-space:pre-wrap; text-align:center; color: var(--accent) !important; font-weight:700; -webkit-text-stroke:.35px rgba(0,0,0,.10); text-shadow:0 1px 0 rgba(255,255,255,.85), 0 3px 6px rgba(0,0,0,.04); } #status.ok,#status.busy,#status.err{ color: var(--accent) !important; font-weight:700; -webkit-text-stroke:.35px rgba(0,0,0,.10); text-shadow:0 1px 0 rgba(255,255,255,.85), 0 3px 6px rgba(0,0,0,.04); } /* === NEW: 備註小浮層 === */ .actions-inline{ display:flex; gap:var(--gap); position:relative; } .hint-popover{ position:absolute; right:0; top:44px; z-index:50; max-width: var(--hint-maxw); min-width: 260px; padding:10px 12px; font-size:var(--hint-fz); line-height:1.45; color:var(--accent); background:#fff; border:1px solid var(--accent); border-radius:12px; box-shadow:0 8px 24px rgba(0,0,0,.10), 0 2px 8px rgba(0,0,0,.06); display:none; white-space:normal; --arrow-x: calc(100% - 24px); } .hint-popover.show{ display:block; } .hint-popover::before{ content:""; position:absolute; left:var(--arrow-x); top:-8px; transform:translateX(-50%); width:0; height:0; border-left:8px solid transparent; border-right:8px solid transparent; border-bottom:8px solid var(--accent); } .hint-popover::after{ content:""; position:absolute; left:var(--arrow-x); top:-7px; transform:translateX(-50%); width:0; height:0; border-left:7px solid transparent; border-right:7px solid transparent; border-bottom:7px solid #fff; } /* === 鍵盤容器 === */ .kb-wrap{ overflow-x:auto; -webkit-overflow-scrolling:touch; background:var(--soft); border:1px solid var(--rim); border-radius:14px; margin-top:14px; } #keyboard{ position:relative; height:var(--kb-h); user-select:none; -webkit-user-select:none; touch-action: pan-x pan-y; } /* === 鋼琴樣式 === */ .white{ position:absolute; bottom:0; height:100%; background:linear-gradient(#ffffff,#eceef3 72%,#d9dde5); border-radius:0 0 12px 12px; box-shadow:inset 0 -12px 16px rgba(0,0,0,.12), inset 0 1px 0 rgba(255,255,255,.9), 0 1px 0 rgba(0,0,0,.04); } .white::after{ content:""; position:absolute; top:0; bottom:0; right:0; width:var(--sep); background:linear-gradient(transparent,#cfd3dc 50%,transparent); } .white:first-child::before{ content:""; position:absolute; top:0; bottom:0; left:0; width:var(--sep); background:linear-gradient(transparent,#cfd3dc 50%,transparent); } .white.active{ filter:brightness(1.06); } .black{ position:absolute; bottom:38%; height:62%; background:linear-gradient(#2d2f36,#0e0f13); border:1px solid #0b0d11; border-top:none; border-radius:0 0 10px 10px; z-index:5; box-shadow:inset 0 -6px 10px rgba(0,0,0,.45), 0 3px 10px rgba(0,0,0,.35); transform: translateX(-50%); } .black.active{ filter:brightness(1.22); } /* === 吉他樣式（幾乎不改）=== */ .fretboard{ position:relative; display:grid; grid-template-columns: repeat(13, 1fr); width:100%; height:var(--kb-h); background:linear-gradient(180deg,#6b4f2e 0%, #5b4429 50%, #533c24 100%); border-radius:12px; box-shadow:inset 0 10px 20px rgba(0,0,0,.25), inset 0 -8px 16px rgba(0,0,0,.2); } .head{ position:absolute; left:0; top:0; bottom:0; width:86px; z-index:2; background:linear-gradient(180deg, rgba(0,0,0,.12), transparent 40%),linear-gradient(180deg,#7a5534 0%, #6b4f2e 55%, #5a3f24 100%); box-shadow: inset -8px 0 16px rgba(0,0,0,.18); border-radius:12px 0 0 12px; pointer-events:none; } .nut{ position:absolute; left:86px; top:0; bottom:0; width:8px; z-index:3; background:linear-gradient(180deg,#e5e1d6,#c9c5ba); box-shadow: inset -1px 0 0 rgba(0,0,0,.35), inset 1px 0 0 rgba(255,255,255,.6); border-right:2px solid rgba(120,120,120,.5); pointer-events:none; } .bridge{ position:absolute; right:0; top:0; bottom:0; width:10px; z-index:2; background:linear-gradient(180deg,#b9b6ad,#8f8c83); box-shadow: inset 1px 0 0 rgba(255,255,255,.5), inset -1px 0 0 rgba(0,0,0,.25); pointer-events:none; border-left:1px solid rgba(0,0,0,.18); } .fret-col{ position:relative; background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.02)); box-shadow: inset -2px 0 0 rgba(255,255,255,.18), inset -4px 0 0 rgba(0,0,0,.28); } /* 弦繞紋與高光 */ .string{ --sw:2px; position:absolute; left:94px; right:0; height:0; z-index:3; border-top: var(--sw) solid transparent; transform-origin:center; filter:drop-shadow(0 1px 0 rgba(0,0,0,.18)); background: linear-gradient(90deg, rgba(255,255,255,0) 0%, rgba(255,255,255,.45) 50%, rgba(255,255,255,0) 100%); background-size:160px 1px; background-repeat:no-repeat; background-position:-160px 0; } .string::before{ content:""; position:absolute; left:0; right:0; top: calc(var(--sw) * -0.5); height: var(--sw); background: repeating-linear-gradient(90deg, #caa56b 0 2.4px, #906a3d 2.4px 3.1px), repeating-linear-gradient(90deg, rgba(255,255,255,.08) 0 2.4px, rgba(0,0,0,.10) 2.4px 3.1px), linear-gradient(180deg, rgba(255,255,255,.70), rgba(255,255,255,.15) 55%, rgba(0,0,0,.18) 100%); border-radius:999px; opacity:.98; pointer-events:none; } .string::after{ content:""; position:absolute; left:0; right:0; top: calc(var(--sw) * -0.5 + 0.2px); height: calc(var(--sw) * .25); background: linear-gradient(180deg, rgba(255,255,255,.55), rgba(255,255,255,0)); pointer-events:none; border-radius:999px; opacity:.9; } .string[data-s="2"]{ --sw:2.5px; } .string[data-s="3"]{ --sw:3px; } .string[data-s="4"]{ --sw:3.5px; } .string[data-s="5"]{ --sw:4px; } /* 觸控區與震動動畫（幾乎不改） */ .hit-row{ position:absolute; left:0; right:0; height:28px; transform:translateY(-50%); background:transparent; cursor:pointer; z-index:4; } @media (pointer:coarse){ .hit-row{ height:34px; } } .string.vibrate{ animation: vibrCurve 360ms ease-out, shine 360ms ease-out; } @keyframes vibrCurve{ 0%{transform:translateY(0)} 10%{transform:translateY(-3.2px)} 20%{transform:translateY(0)} 30%{transform:translateY(2.6px)} 45%{transform:translateY(0)} 60%{transform:translateY(-1.8px)} 75%{transform:translateY(0.6px)} 100%{transform:translateY(0)} } @keyframes shine{ 0%{ background-position:-160px 0; opacity:.95 } 100%{ background-position:160px 0; opacity:.96 } } .overlay{ position:fixed; inset:0; z-index:9999; display:flex; align-items:center; justify-content:center; background:rgba(17,24,39,.35); backdrop-filter:blur(3px); pointer-events:auto; } .overlay.hidden{ display:none; } .dialog{ min-width:300px; max-width:92vw; background:var(--soft); border:1px solid var(--neutral); border-radius:14px; padding:18px; box-shadow:0 18px 44px rgba(0,0,0,.18); text-align:center; pointer-events:auto; } .dialog h3{ margin:0 0 8px; font-size:18px; color:#6b5e52; } .dialog p.ios-hint{ margin:6px 0; line-height:1.6; font-size:13px; color:#d11; } .dialog .actions{ display:flex; gap:10px; justify-content:center; margin-top:12px; } .dialog button{ width:120px; height:38px; border-radius:10px; border:1px solid var(--rim); background:#fff; cursor:pointer; font-weight:700; } .dialog button.primary{ background:#fff; } #lockScreen{ position:fixed; inset:0; z-index:9998; display:none; background:transparent; } footer{ max-width:1060px;margin:8px auto 22px; text-align:center; color:#6b5e52; font-size:12px; opacity:.9; } /* 手機直向 */ @media (orientation:portrait){ .row-line2, .row-line3{ width:100%; gap:12px; } .pair{ display:flex; align-items:center; gap:var(--gap); width:100%; } .actions-inline{ display:flex; gap:var(--gap); } .row-line2 .pair, .row-line3 .pair, .row-line3 .actions-inline{ flex: 0 0 100%; } .align-to-email{ margin-left:0 !important; } #lastNote{ width:var(--w-lastNote-m); } } </style> <body> <img class="bg-notes" src="./assets/notes.png?v=4" alt=""> <div class="panel"> <h2>🎼互動音符🎵</h2> <div class="row row-line2"> <div class="pair"> <label for="displayName">親友姓名：</label> <input id="displayName" placeholder="例：張咩揚" /> </div> <div class="pair"> <label for="email">電子郵件：</label> <input id="email" placeholder="hey fill in your@email" inputmode="email" /> <datalist id="emailDomains"></datalist> </div> <div class="pair"> <label for="code">取得代號：</label> <input id="code" placeholder="會自動帶入" /> </div> </div> <div class="row row-line3"> <div class="pair"> <label for="instrument">樂器轉換：</label> <select id="instrument"> <option value="piano" selected>鋼琴</option> <option value="guitar">吉他</option> </select> </div> <div class="pair"> <label for="lastNote" class="align-to-email">音符紀錄：</label> <input id="lastNote" placeholder="— , — , —" readonly /> </div> <div class="actions-inline"> <button id="resetBtn" type="button" class="btn-compact">重設</button> <button id="lockBtn" type="button" class="btn-compact" disabled>鎖定</button> <button id="hintBtn" type="button" class="btn-compact" aria-expanded="false" aria-controls="hintPopover" title="點我查看備註">先點我查看好咪🥺</button> <div id="hintPopover" class="hint-popover" role="note" aria-live="polite"> 按「鎖定」後請稍候，本人有缺陷導致速度較慢🥲<br> 確認送出成功，下方「狀態列」會立即通知您溜🎉 </div> </div> </div> <p id="status">尚未初始化</p> <div class="kb-wrap"><div id="keyboard"></div></div> </div> <!-- 操作說明 --> <div id="guideOverlay" class="overlay" role="dialog" aria-modal="true" aria-labelledby="guideTitle"> <div class="dialog"> <h3 id="guideTitle">📍操作說明📍</h3> <p>🔻填入姓名、Email與取得的代號</p><p>↓</p> <p>🔻可選擇鋼琴或吉他中的三個音階</p><p>↓</p> <p>🔻三個音階確認後，一定要按鎖定</p><p>↓</p> <p>🔻鎖定完成後，會有通知是否成功</p><p>↓</p> <p>🔺若成功即可退出介面；反之再試</p><p>↓</p> <p>❗️沒按鎖定就是沒有送出就是彈個寂寞</p> <div class="actions"><button id="guideOk" class="primary">了解</button></div> </div> </div> <!-- 啟音 --> <div id="unlockOverlay" class="overlay hidden" role="dialog" aria-modal="true" aria-labelledby="unlockTitle"> <div class="dialog"> <h3 id="unlockTitle">啟用聲音</h3> <p class="ios-hint">iPhone請確保側邊「靜音鍵」有開啟響鈴模式</p> <div class="actions"> <button id="cancelUnlock">取消</button> <button id="confirmUnlock" class="primary">確定</button> </div> </div> </div> <div id="lockScreen" aria-hidden="true"></div> <footer>© Copyright 2025 MY‘s System Version:b1.0.227</footer> <!-- LIFF SDK --> <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script> <!-- Tone.js --> <script src="https://cdn.jsdelivr.net/npm/tone@14.8.49/build/Tone.min.js"></script> <script> /***** 你只要改這兩個常數 *****/ const LIFF_ID = '2008149060-ZGVdAvGo'; // ← 你的 LIFF ID（你已提供） const WEBHOOK = 'https://script.google.com/macros/s/AKfycbwlkCLxnil8psv0URgXQgvBnjO63-uUxxalQNr93EuQJynUliRUGsXBuNM1VzzOoRu8/exec'; const TIMEOUT_MS = 10000; // ✅ 可調整：POST 逾時（毫秒） const PRECHECK = true; // ✅ 可調整：送出前是否先撞 /status const $ = s => document.querySelector(s); // 🔒 請勿更動流程：便捷選擇器 /* ✅ 可調整：常見 Email 網域（會用來產生 datalist 補全） */ const COMMON_DOMAINS = [ 'gmail.com','hotmail.com','outlook.com','icloud.com', 'msn.com','live.com','yahoo.com.tw' ]; /* === 一次性信箱黑名單 === */ /* ✅ 可調整：想放寬可刪/減；想更嚴可新增 */ const DISPOSABLE_DOMAINS = new Set([ 'mailinator.com','guerrillamail.com','sharklasers.com','10minutemail.com', 'tempmail.com','tempmail.dev','temp-mail.org','moakt.com','yopmail.com', 'throwawaymail.com','trashmail.com','maildrop.cc','dispostable.com','mail-temp.com' ]); /* === Email 檢核 === */ /* 🔒 請勿更動流程：這段和後端對應，影響鎖定鍵可用性 */ function validEmail(v){ const s=(v||'').trim(); if(!/^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/.test(s)) return false; if(/\.\./.test(s)) return false; const [local,domain] = s.split('@'); if(/^[0-9]+$/.test(local)) return false; if(/[._%+-]$/.test(local)) return false; const labels = (domain||'').split('.'); if(labels.some(l=>!l || l.length>63 || /^-/.test(l) || /-$/.test(l))) return false; const tld = labels[labels.length-1]||''; if(!/^[A-Za-z]{2,24}$/.test(tld)) return false; const d = (domain||'').toLowerCase(); for(const bad of DISPOSABLE_DOMAINS){ if(d===bad || d.endsWith('.'+bad)) return false; } return true; } /* === 狀態列 === */ /* 🧩 進階可調：要改判斷關鍵字/樣式，可改這裡與上方 CSS */ const setStatus = m => { const el = $('#status'); el.textContent = m; el.classList.remove('ok','busy','err'); if(/已載入|就緒|已找到|找到代號/.test(m)) el.classList.add('ok'); else if(/送出中|查詢|載入中|等待/.test(m)) el.classList.add('busy'); else if(/❌|失敗|逾時|找尋不到|已過|格式不正確|忙碌|not found/i.test(m)) el.classList.add('err'); }; /* === 全域變數 === */ /* 🔒 請勿更動流程：音源/鎖定/選音邏輯 */ let audioCtx=null, sampler=null, samplerReady=false, unlocked=false, hardLocked=false; let currentInstrument='piano'; let selectedNotes = []; let selectedInsts = []; /* === 新增（只新增）：LIFF Profile 暫存與讀網址參數 === */ let liffDisplayName = ''; let liffPictureUrl = ''; function getQueryParam(name){ const m = new URL(location.href).searchParams.get(name); return m ? decodeURIComponent(m) : ''; } /* === 音色路徑 === */ /* ✅ 可調整：如音色檔存放路徑不同，可改 baseUrl 或檔名表 */ const PIANO_BASE = new URL('./piano/', location.href).href; const GUITAR_BASE = new URL('./guitar/', location.href).href; const PIANO_URLS = {'A1':'A1.mp3','C2':'C2.mp3','D#2':'Ds2.mp3','F#2':'Fs2.mp3','A2':'A2.mp3','C3':'C3.mp3','D#3':'Ds3.mp3','F#3':'Fs3.mp3','A3':'A3.mp3','C4':'C4.mp3','D#4':'Ds4.mp3','F#4':'Fs4.mp3','A4':'A4.mp3','C5':'C5.mp3'}; const GUITAR_URLS = {'E2':'E2.wav','A2':'A2.wav','D3':'D3.wav','G3':'G3.wav','B3':'B3.wav','E4':'E4.wav'}; /* === 鋼琴音階 === */ /* 🔒 請勿更動流程：鍵位計算依賴這些設定 */ const WHITE=["C3","D3","E3","F3","G3","A3","B3","C4","D4","E4","F4","G4","A4","B4"]; const BLACK_AFTER={ 'C':'C#','D':'D#','F':'F#','G':'G#','A':'A#' }; const MIN_WHITE_PX=64, TOTAL_WHITE=WHITE.length; /* === 吉他音名計算 === */ /* 🔒 請勿更動流程：音高轉換依賴這些設定 */ const TUNING_MIDI = [40,45,50,55,59,64]; const NOTE_NAMES = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"]; /* === 快速查詢 === */ /* 🔒 請勿更動流程：與後端 /status 對應 */ async function getStatusFast(code, email, signal){ try{ const url = WEBHOOK + '?action=status&code=' + encodeURIComponent(code) + '&email=' + encodeURIComponent(email); const r = await fetch(url, { method:'GET', cache:'no-store', signal }); if(!r.ok) return { ok:false }; const j = await r.json(); return { ok:true, status: j.status || 'none' }; }catch(_){ return { ok:false }; } } /* === 啟用音訊 === */ async function unlockAudio(){ try{ const Ctx=window.webkitAudioContext||window.AudioContext; if(!audioCtx) audioCtx=new Ctx({latencyHint:'interactive'}); if(audioCtx.state!=='running') await audioCtx.resume(); Tone.setContext(new Tone.Context(audioCtx)); await Tone.start(); loadSampler(currentInstrument); unlocked=true; $('#unlockOverlay').classList.add('hidden'); }catch(e){ setStatus('啟用失敗：'+e.message); } } // === 音色檔存在性探測（進階偵錯） ================================ async function probeAsset(url, timeoutMs=6000){ try{ const ctl = new AbortController(); const t = setTimeout(()=>ctl.abort(), timeoutMs); let r = await fetch(url, { method:'HEAD', cache:'no-store', signal:ctl.signal }); if(!r.ok || Number(r.headers.get('content-length'))===0){ r = await fetch(url, { method:'GET', cache:'no-store', signal:ctl.signal }); } clearTimeout(t); return r.ok; }catch(_){ return false; } } /* === 切換音色 === */ function loadSampler(inst='piano'){ sampler?.dispose?.(); sampler=null; samplerReady=false; let urls=PIANO_URLS, base=PIANO_BASE, label='🎹 '; if(inst==='guitar'){ urls=GUITAR_URLS; base=GUITAR_BASE; label='🎸 '; } setStatus(label+'載入中…'); const firstKey = Object.keys(urls)[0]; const testUrl = base + urls[firstKey]; probeAsset(testUrl, 5000).then(ok=>{ if(!ok){ setStatus('⚠️ 無法讀取音色檔\n'+testUrl+'（目錄需與此頁同層；檔名表需與實檔一致：如 D#4→Ds4.mp3）'); } }); try{ sampler=new Tone.Sampler({ urls, release:1, baseUrl:base, onload:()=>{ samplerReady=true; setStatus(label+'已載入 ✅'); } }).toDestination(); }catch(e){ setStatus('❌ 音色初始化失敗：'+e.message); return; } const WATCH_MS=9000; setTimeout(()=>{ if(!samplerReady){ setStatus('⏱️ 載入超時\n可能原因：路徑/大小寫/CORS/檔名表不一致（目前 baseUrl：'+base+'）'); } }, WATCH_MS); } /* === 三音顯示 === */ function refreshNotesDisplay(){ const parts=[selectedNotes[0]||'—', selectedNotes[1]||'—', selectedNotes[2]||'—']; $('#lastNote').value = parts.join(' , '); } /* === 播音 === */ function trigger(note){ if(hardLocked) return; if(!samplerReady){ setStatus('音色載入中…'); return; } sampler.triggerAttackRelease(note,'8n'); if(selectedNotes.length<3){ selectedNotes.push(note); selectedInsts.push(currentInstrument); } else { selectedNotes[2]=note; selectedInsts[2]=currentInstrument; } refreshNotesDisplay(); validateLockBtn(); } /* === 鎖定鍵可用性 === */ function validateLockBtn(){ const nameOk = ($('#displayName').value||'').trim().length>0; // 姓名由使用者手填 const codeOk = ($('#code').value||'').trim().length>0; // 代號自動帶入或人工補 const emailOk = validEmail($('#email').value); const notesOk = selectedNotes.length===3; $('#lockBtn').disabled = !(nameOk && codeOk && emailOk && notesOk); } /* === 事件綁定（表單） === */ $('#instrument').addEventListener('change', ()=>{ if(hardLocked) return; currentInstrument=$('#instrument').value; loadSampler(currentInstrument); if(currentInstrument==='guitar') renderGuitar(); else renderPiano(); validateLockBtn(); }); $('#displayName').addEventListener('input', validateLockBtn); $('#code').addEventListener('input', validateLockBtn); /* ✅ Email 輸入：含 @ 時動態建立「完整 email」候選清單；否則移除 list */ const emailInput = $('#email'); const emailList = $('#emailDomains'); $('#email').addEventListener('input', ()=>{ const v = emailInput.value; if(v.includes('@')){ const [local,frag=''] = v.split('@'); const lowerFrag = frag.toLowerCase(); const options = (local ? COMMON_DOMAINS : []) .filter(d => d.startsWith(lowerFrag)) .map(d => <option value="${local}@${d}"></option>).join(''); emailList.innerHTML = options || (local ? COMMON_DOMAINS.map(d=><option value="${local}@${d}"></option>).join('') : ''); emailInput.setAttribute('list','emailDomains'); }else{ emailInput.removeAttribute('list'); emailList.innerHTML = ''; } validateLockBtn(); }); /* === 重設 === */ $('#resetBtn').addEventListener('click', ()=>{ if(hardLocked) return; if(selectedNotes.length>0){ selectedNotes.pop(); selectedInsts.pop(); refreshNotesDisplay(); validateLockBtn(); } }); /* === 說明按鈕 → 小浮層 === */ const hintBtn = $('#hintBtn'); const hintPop = $('#hintPopover'); function positionArrow(){ const popRect = hintPop.getBoundingClientRect(); const btnRect = hintBtn.getBoundingClientRect(); const x = (btnRect.left + btnRect.width/2) - popRect.left; const clamped = Math.max(16, Math.min(popRect.width-16, x)); hintPop.style.setProperty('--arrow-x', clamped + 'px'); } function closeHint(){ hintPop.classList.remove('show'); hintBtn.setAttribute('aria-expanded','false'); } hintBtn.addEventListener('click', (e)=>{ const showing = hintPop.classList.toggle('show'); hintBtn.setAttribute('aria-expanded', showing ? 'true' : 'false'); if(showing){ positionArrow(); } e.stopPropagation(); }); document.addEventListener('click', (e)=>{ if(!hintPop.classList.contains('show')) return; const within = hintPop.contains(e.target) || hintBtn.contains(e.target); if(!within) closeHint(); }); window.addEventListener('resize', ()=>{ if(hintPop.classList.contains('show')) positionArrow(); }); window.addEventListener('orientationchange', ()=>{ setTimeout(()=>{ if(hintPop.classList.contains('show')) positionArrow(); }, 250); }); window.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeHint(); }); /* === 兩個彈跳視窗（事件委派＋touchend 支援）=== */ function hide(el){ el.classList.add('hidden'); } function show(el){ el.classList.remove('hidden'); } ['click','touchend'].forEach(evt=>{ document.addEventListener(evt,(e)=>{ const t = e.target; if(t.id==='guideOk'){ hide(document.getElementById('guideOverlay')); show(document.getElementById('unlockOverlay')); e.preventDefault(); }else if(t.id==='cancelUnlock'){ hide(document.getElementById('unlockOverlay')); e.preventDefault(); }else if(t.id==='confirmUnlock'){ unlockAudio(); hide(document.getElementById('unlockOverlay')); e.preventDefault(); } }, {passive:true}); }); /* === 送出（鎖定） === */ $('#lockBtn').addEventListener('click', async ()=>{ if(hardLocked) return; const name=($('#displayName').value||'').trim(); const code=($('#code').value||'').trim(); const email=($('#email').value||'').trim(); if(!name||!code||!validEmail(email)||selectedNotes.length!==3){ alert('請填姓名、代號、Email 並彈滿 3 個音再鎖定'); return; } if(PRECHECK){ try{ const pre = await getStatusFast(code, email); if(pre.ok){ if(pre.status==='used'){ setStatus('📝 已填寫過，正在確認是否已過期或代號問題…'); }else if(pre.status==='inflight'){ setStatus('🕒 資料處理中，請勿重複送出⛔'); return; } } }catch(_e){} } setStatus('⏳ 送出中…'); const instrumentField = selectedInsts.length ? selectedInsts.join(',') : currentInstrument; const payload={ userId:code, displayName:name, instrument:instrumentField, note:selectedNotes.join(','), velocity:1, sessionId:'demo', email, /* === 新增（只新增）：把 LINE 名稱與頭像也送給後端寫進 profiles === */ lineDisplayName: liffDisplayName, linePictureUrl: liffPictureUrl }; const controller=new AbortController(); const timer=setTimeout(()=>controller.abort(),TIMEOUT_MS); try{ const r=await fetch(WEBHOOK,{ method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload), signal:controller.signal }); clearTimeout(timer); if(r.headers.get('content-type')?.includes('application/json')){ const data = await r.json(); if(data.ok){ setStatus('✅ 已送出成功，可退安囉'); enterHardLock(); } else{ let msg='❌ 送出失敗'; const err=String(data.error||''); if(err.includes('duplicate+deadline_passed')) msg='📅 已填寫過囉，且已過截止日💔'; else if(err.includes('duplicate+code_not_found')) msg='🔎 已填寫過囉，且代號不存在👀'; else if(err==='duplicate') msg='📝 已填寫過囉，想要更換音階請洽ㄟ咪🙏'; else if(err==='email_required') msg='⚠️ Email缺少或格式不正確，跪求真正的mail🙇‍♂️'; else if(err==='email_domain_invalid') msg='🌐 Email網域無法收信，請確認拼字或更換📮'; else if(err==='deadline_passed') msg='📣 已過填寫截止日，但還可在這玩耍唷👣'; else if(err==='code_not_found') msg='🔎 找尋不到代號，請洽新人🤵🏻‍♂️👰🏻‍♀️'; else if(err==='busy') msg='⚠️ 系統忙碌，稍後再試🌀'; setStatus(msg); } }else{ if(r.ok){ setStatus('✅ 已送出成功，可退安囉'); enterHardLock(); } else{ setStatus('❌ 送出失敗'); } } }catch(e){ try{ const post = await getStatusFast(code, email); if(post.ok){ if(post.status==='used'){ setStatus('✅ 已送出成功，可退安唷'); enterHardLock(); return; } if(post.status==='inflight'){ setStatus('⏳ 可能已送達，伺服器處理中，請勿重複送出⛔'); return; } } }catch(_e){} setStatus('❌ 送出逾時或失敗'); } }); /* === 成功後凍結畫面 === */ function enterHardLock(){ hardLocked=true; $('#displayName').disabled=true; $('#code').disabled=true; $('#email').disabled=true; $('#instrument').disabled=true; $('#resetBtn').disabled=true; $('#lockBtn').disabled=true; $('#lockScreen').style.display='block'; } /* === 鋼琴繪製（移除鍵帽標籤）=== */ function renderPiano(){ const kb=$('#keyboard'); kb.innerHTML=''; kb.className=''; sizePiano(); const keyW=100/TOTAL_WHITE; WHITE.forEach((note,i)=>{ const w=document.createElement('div'); w.className='white'; w.dataset.note=note; w.style.left=(i*keyW)+'%'; w.style.width=keyW+'%'; w.addEventListener('pointerdown', ()=>{ if(hardLocked) return; if(!unlocked){ $('#unlockOverlay').classList.remove('hidden'); return; } trigger(note); w.classList.add('active'); }); w.addEventListener('pointerup', ()=>w.classList.remove('active')); kb.appendChild(w); }); WHITE.forEach((note,i)=>{ const l=note[0], sharp = BLACK_AFTER[l]? (BLACK_AFTER[l]+note.slice(1)) : null; if(!sharp || (l==='A' && i===TOTAL_WHITE-1)) return; const b=document.createElement('div'); b.className='black'; b.dataset.note=sharp; const blackWidthPct = keyW*0.62; b.style.width = blackWidthPct+'%'; b.style.left=((i+1)*keyW)+'%'; b.addEventListener('pointerdown', ()=>{ if(hardLocked) return; if(!unlocked){ $('#unlockOverlay').classList.remove('hidden'); return; } trigger(sharp); b.classList.add('active'); }); b.addEventListener('pointerup', ()=>b.classList.remove('active')); kb.appendChild(b); }); } /* === 鋼琴尺寸 === */ function sizePiano(){ const wrap=document.querySelector('.kb-wrap'); const kb=document.querySelector('#keyboard'); const wrapW=wrap.clientWidth; const sep=parseInt(getComputedStyle(kb).getPropertyValue('--sep')||'2',10); const minW=WHITE.length*(MIN_WHITE_PX+sep); kb.style.width=(wrapW>=minW?wrapW-1:minW)+'px'; kb.style.height='var(--kb-h)'; } /* === 吉他繪製 === */ function renderGuitar(){ const kb=$('#keyboard'); kb.innerHTML=''; kb.className='fretboard'; kb.style.height='var(--kb-h)'; const head=document.createElement('div'); head.className='head'; kb.appendChild(head); const nut =document.createElement('div'); nut.className='nut'; kb.appendChild(nut); const bridge=document.createElement('div'); bridge.className='bridge'; kb.appendChild(bridge); for(let s=0;s<6;s++){ const y=(s+1)*(100/7); const str=document.createElement('div'); str.className='string'; str.dataset.s=String(s); str.style.top = ${y}%; kb.appendChild(str); const hline=document.createElement('div'); hline.className='head-line'; hline.dataset.s=String(s); hline.style.top = ${y}%; kb.appendChild(hline); } for(let f=1; f<=13; f++){ const col=document.createElement('div'); col.className='fret-col'; for(let s=0; s<6; s++){ const y=(s+1)*(100/7); const hit=document.createElement('div'); hit.className='hit-row'; hit.style.top = ${y}%; col.appendChild(hit); } if([4,6,8,10].includes(f)){ const dot=document.createElement('div'); dot.style.cssText='position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:16px;height:16px;border-radius:50%;background:#dbc6a4;opacity:.9;box-shadow:0 1px 0 rgba(0,0,0,.35);pointer-events:none;'; col.appendChild(dot); }else if(f===13){ const dot1=document.createElement('div'); dot1.style.cssText='position:absolute;left:50%;top:38%;transform:translate(-50%,-50%);width:14px;height:14px;border-radius:50%;background:#dbc6a4;opacity:.9;box-shadow:0 1px 0 rgba(0,0,0,.35);pointer-events:none;'; const dot2=document.createElement('div'); dot2.style.cssText='position:absolute;left:50%;top:62%;transform:translate(-50%,-50%);width:14px;height:14px;border-radius:50%;background:#dbc6a4;opacity:.9;box-shadow:0 1px 0 rgba(0,0,0,.35);pointer-events:none;'; col.appendChild(dot1); col.appendChild(dot2); } col.addEventListener('pointerdown',(ev)=>{ if(hardLocked) return; if(!unlocked){ $('#unlockOverlay').classList.remove('hidden'); return; } const rect = col.getBoundingClientRect(); const y = ev.clientY - rect.top; const slot = rect.height/7; let idx = Math.round(y/slot - 1); idx = Math.max(0, Math.min(5, idx)); if(f<=12){ const midi = TUNING_MIDI[5-idx] + f; const note = NOTE_NAMES[midi % 12] + (Math.floor(midi/12) - 1); trigger(note); } const target = kb.querySelector(.string[data-s="${idx}"]); if(target){ target.classList.remove('vibrate'); void target.offsetWidth; target.classList.add('vibrate'); setTimeout(()=>target.classList.remove('vibrate'), 380); } }); kb.appendChild(col); } } /* === 視窗尺寸 === */ window.addEventListener('resize', ()=>{ if(currentInstrument==='piano') sizePiano(); }); window.addEventListener('orientationchange', ()=>{ if(currentInstrument==='piano') sizePiano(); }); /* ====== 新增：LIFF 啟動 → 取 LINE Profile → 查 guests 代號 → 鎖定輸入框 ====== */ async function initLIFFAndPrefill(){ try{ setStatus('初始化 LIFF…'); await liff.init({ liffId: LIFF_ID, withLoginOnExternalBrowser: true }); if(!liff.isLoggedIn()) liff.login(); /* 新增：網址 ?code= 帶入並鎖定 */ const urlCode = getQueryParam('code'); if(urlCode){ const codeInput = $('#code'); codeInput.value = urlCode; codeInput.readOnly = true; codeInput.setAttribute('aria-readonly','true'); setStatus('已從網址帶入代號 ✔'); } const prof = await liff.getProfile(); // {displayName, pictureUrl, userId} /* 新增：暫存 LINE 名稱/頭像，並寫入 profiles（code 先空字串也可） */ liffDisplayName = prof?.displayName || ''; liffPictureUrl = prof?.pictureUrl || ''; try{ await fetch(WEBHOOK, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ action:'profile', code: urlCode || '', displayName: liffDisplayName, pictureUrl: liffPictureUrl }) }); }catch(_){} /* 若網址沒有 code，才用 LINE 名稱去 guests 查代號 */ if(!urlCode){ setStatus('查詢代號中…'); const u = WEBHOOK + '?action=lookup&name=' + encodeURIComponent(liffDisplayName||''); const r = await fetch(u, {method:'GET', cache:'no-store'}); const j = await r.json(); if(j.ok && j.code){ const codeInput = $('#code'); codeInput.value = j.code; codeInput.readOnly = true; // 鎖定不給改 codeInput.setAttribute('aria-readonly','true'); setStatus('已找到代號並帶入 ✔'); }else{ setStatus('🔎 找不到代號，請動動指頭輸入代號或聯繫新人🤵🏻‍♂️👰🏻‍♀️'); } } }catch(e){ setStatus('LIFF 初始化失敗：'+ e.message); } } /* === 初始化 === */ window.addEventListener('DOMContentLoaded', async ()=>{ renderPiano(); setStatus('等待啟用聲音…'); validateLockBtn(); $('#guideOverlay').classList.remove('hidden'); await initLIFFAndPrefill(); // 啟動 LIFF 並自動帶入代號 }); </script> </body> </html> /**** Code.gs – 互動音符（樣式 B：代號為唯一鍵；完整版） ************************* ✅ 前端錯誤碼（與你前端對應） - duplicate+deadline_passed - duplicate+code_not_found - duplicate - deadline_passed - code_not_found - email_required - email_domain_invalid - busy / server_error / logs_sheet_not_found 等 ✅ 寫入欄位（固定版） logs 只寫 A~E： [timestamp, userId(code), displayName, instrument, note] locks 只寫 A~D： [usedAt, email, code, status(used)] ✅ 對刪模式（全部「以代號為主」，不再看時間） - onEdit：在刪除標記欄輸入 "-"（logs=G 欄、locks=F 欄）→ 兩表一起刪 - 單筆：選單「刪除單筆選取列」 - 批次：選單「刪除多筆選取列」（支援濾鏡＋多段） - 掃描標記：選單「刪除『-』所有列」 ✅ 其他 - /status 以當前活頁簿的 locks 判斷 used / inflight / none - email 網域 MX/A 檢查（可關） *******************************************************************************/ /* === 你平常會改的設定（其餘請勿更動流程） ================================== */ const SHEET_LOGS = 'logs'; // logs 工作表名稱 const SHEET_LOCKS = 'locks'; // locks 工作表名稱 const SHEET_GUESTS = 'guests'; // guests：C=code；E=deadline const TZ = 'Asia/Taipei'; const TIME_FMT = 'yyyy-MM-dd HH:mm:ss'; const HEADER_ROWS = 1; // 刪除標記欄位（兩表不同欄） const DELETE_MARK_COL_LOGS = 7; // logs 的 G 欄 const DELETE_MARK_COL_LOCKS = 6; // locks 的 F 欄 const DELETE_TOKEN = '-'; // 半形減號才觸發 // 批次刪除上限（以「代號個數」計） const BATCH_CODES_LIMIT = 1000; // （選用）後台管理 const ADMIN_TOKEN = 'CHANGE_ME_SECRET_TOKEN'; const UI_CONFIG_KEY = 'ui.config'; const UI_DEFAULTS = { widths: { displayName:152, email:304, lastNote:170, code:152 }, titleText: '互動音符', titleColor: '#A68A7C' }; /* === 共用小工具 ============================================================ */ function json_(o){ return ContentService.createTextOutput(JSON.stringify(o)).setMimeType(ContentService.MimeType.JSON); } function text_(s){ return ContentService.createTextOutput(String(s||'')).setMimeType(ContentService.MimeType.TEXT); } function formatNow_(){ return Utilities.formatDate(new Date(), TZ, TIME_FMT); } function makeKey_(code,email){ return ${code}||${email}; } function normalizeEmail_(v){ if(!v) return ''; v=String(v).trim().toLowerCase(); return /^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/.test(v) ? v : ''; } function normalizeCode_(s){ return String(s||'').replace(/\u200B|\u200C|\u200D|\uFEFF/g,'').trim(); } /* === UI 設定（選用） ======================================================= */ function getUiConfig_(){ const sp = PropertiesService.getScriptProperties(); const raw = sp.getProperty(UI_CONFIG_KEY); if(!raw) return UI_DEFAULTS; try{ const obj = JSON.parse(raw); const out = { ...UI_DEFAULTS, ...obj }; out.widths = { ...UI_DEFAULTS.widths, ...(obj.widths||{}) }; return out; }catch(_){ return UI_DEFAULTS; } } function saveUiConfig_(obj){ const sp = PropertiesService.getScriptProperties(); const cfg = getUiConfig_(); const next = { ...cfg, ...obj }; if (obj.widths) next.widths = { ...cfg.widths, ...obj.widths }; sp.setProperty(UI_CONFIG_KEY, JSON.stringify(next)); return next; } /* === Web 入口（GET） ======================================================= */ function doGet(e){ const p=e?.parameter||{}; const action=String(p.action||'').toLowerCase(); if(action==='config'){ const cfg=getUiConfig_(); return json_({ ok:true, widths: cfg.widths, title:{ text: cfg.titleText, color: cfg.titleColor } }); } if(action==='title_svg'){ return text_(''); } if(action==='status'){ // 供前端 PRECHECK：以當前活頁簿 locks 為準 const code=String(p.code||'').trim(); const email=normalizeEmail_(p.email); if(!code||!email) return json_({ok:false,error:'missing_params'}); const ss=SpreadsheetApp.getActive(); const locks=getOrCreateLocksSheet_(ss); const used=hasUsed_(locks, code, email); const sp=PropertiesService.getScriptProperties(); const inflight=!!sp.getProperty('inflight.'+makeKey_(code,email)); return json_({ ok:true, status: used?'used':(inflight?'inflight':'none') }); } return text_('ok'); } /* === Web 入口（POST） ====================================================== */ function doPost(e){ const params=e?.parameter||{}; // 可選管理口：儲存 UI 設定 if((params.action||'').toLowerCase()==='config_save'){ if(params.token!==ADMIN_TOKEN) return json_({ok:false,error:'unauthorized'}); let body={}; try{ body=JSON.parse(e?.postData?.contents||'{}'); }catch(_){ return json_({ok:false,error:'invalid_json'}); } const next=saveUiConfig_(body||{}); return json_({ok:true,widths:next.widths}); } return handleFormPost_(e); } /* === 送單主流程（寫 logs / locks；錯誤碼對應前端） ========================== */ function handleFormPost_(e){ const out = (o)=>json_(o); let data={}; try{ data=JSON.parse(e?.postData?.contents||'{}'); }catch(_){ return out({ok:false,error:'invalid_json'}); } const code = String(data.userId||'').trim(); const email = normalizeEmail_(data.email); if(!email) return out({ok:false,error:'email_required'}); // MX/A 檢查（不想檢查可註解掉下一行） try{ if(!checkEmailDomain_(email)) return out({ok:false,error:'email_domain_invalid'}); }catch(_){} try{ const ss = SpreadsheetApp.getActive(); const logs = ss.getSheetByName(SHEET_LOGS); if(!logs) return out({ok:false,error:'logs_sheet_not_found'}); const locks = getOrCreateLocksSheet_(ss); const guest = getGuestStatus_(ss, code); // inflight / duplicate 判斷 const sp = PropertiesService.getScriptProperties(); const key = makeKey_(code, email); const isInflight = !!sp.getProperty('inflight.'+key); const isUsed = hasUsed_(locks, code, email); const duplicate = isInflight || isUsed; // 錯誤優先序（樣式 B 與前端對應） let error=''; if(duplicate && guest.deadlinePassed) error='duplicate+deadline_passed'; else if(duplicate && !guest.exists) error='duplicate+code_not_found'; else if(!guest.exists) error='code_not_found'; else if(guest.deadlinePassed) error='deadline_passed'; else if(duplicate) error='duplicate'; if(error) return out({ok:false,error}); // 準備資料（logs A~E / locks A~D） const nowStr = formatNow_(); const instrument = String(data.instrument||'piano').trim(); const noteStr = String(data.note||'').split(',').map(s=>String(s).trim()).filter(Boolean).join(','); const rowLogs = [ nowStr, data.userId||'', data.displayName||'', instrument, noteStr ]; const rowLocks = [ nowStr, email, code, 'used' ]; // 加鎖 + inflight 記號（避免重複） const lock = LockService.getScriptLock(); if(!lock.tryLock(3000)) return out({ok:false,error:'busy'}); try{ sp.setProperty('inflight.'+key, String(Date.now())); logs.appendRow(rowLogs); locks.appendRow(rowLocks); }finally{ try{ lock.releaseLock(); }catch(_){} sp.deleteProperty('inflight.'+key); } return out({ok:true}); }catch(err){ Logger.log('handleFormPost_ error: '+err); return out({ok:false,error:'server_error'}); } } /* === 對刪（樣式 B：完全以代號為鍵） ======================================== */ /** 依所在表，取該列的代號（logs:B=2 / locks:C=3） */ function getCodeFromRow_(sh, row){ const name = sh.getName(); const col = (name===SHEET_LOGS) ? 2 : 3; return normalizeCode_(sh.getRange(row, col).getValue()); } /** 取得可見選取列（支援濾鏡＋多段）→ 回傳實際列號陣列（升冪） */ function collectSelectedRows_(ss){ const sh = ss.getActiveSheet(); if(!sh) return []; const rows = new Set(); const rl = ss.getActiveRangeList(); if(rl){ rl.getRanges().forEach(r=>{ const s=r.getRow(), e=s+r.getNumRows()-1; for(let i=s;i<=e;i++) if(i>HEADER_ROWS) rows.add(i); }); }else{ const r=sh.getActiveRange(); if(r){ const s=r.getRow(), e=s+r.getNumRows()-1; for(let i=s;i<=e;i++) if(i>HEADER_ROWS) rows.add(i); } } return [...rows].sort((a,b)=>a-b); } /** 在指定表找出「code 欄等於 codes 任一值」的所有列號 */ function rowsWithCodes_(sh, isLocks, codeSet){ if(!sh || !codeSet || codeSet.size===0) return []; const last = sh.getLastRow(); if(last<=HEADER_ROWS) return []; const codeCol = isLocks ? 3 : 2; // locks:C / logs:B const vals = sh.getRange(HEADER_ROWS+1, codeCol, last-HEADER_ROWS, 1).getValues(); const out = []; for(let i=0;i<vals.length;i++){ const c = normalizeCode_(vals[i][0]); if(codeSet.has(c)) out.push(i+HEADER_ROWS+1); } return out; } /** 對刪核心：用「代號集合」同時刪 logs / locks（降冪避免位移） */ function deleteByCodes_(ss, codeSet){ if(!codeSet || codeSet.size===0) return { logsDel:0, locksDel:0 }; const logs = ss.getSheetByName(SHEET_LOGS); const locks = ss.getSheetByName(SHEET_LOCKS); let rowsL=[], rowsK=[]; if(logs) rowsL = rowsWithCodes_(logs, /*isLocks=*/false, codeSet); if(locks) rowsK = rowsWithCodes_(locks, /*isLocks=*/true, codeSet); rowsL.sort((a,b)=>b-a).forEach(r=>{ try{ logs.deleteRow(r); }catch(_){} }); rowsK.sort((a,b)=>b-a).forEach(r=>{ try{ locks.deleteRow(r); }catch(_){} }); return { logsDel: rowsL.length, locksDel: rowsK.length }; } /* === onOpen / onEdit 與選單動作 ============================================ */ function onOpen(){ SpreadsheetApp.getUi().createMenu('資料一致性') .addItem('刪除單筆選取列', 'deleteSelectedRowWithPair_') .addItem('刪除多筆選取列', 'deleteSelectedRangeWithPair_') .addItem('刪除「-」所有列', 'deleteMarkedRowsWithPair_') .addToUi(); } /** 在刪除標記欄輸入 "-" 即對刪（兩表皆適用） */ function onEdit(e){ try{ const sh=e?.range?.getSheet(); if(!sh) return; const name=sh.getName(); if(name!==SHEET_LOGS && name!==SHEET_LOCKS) return; const markCol=(name===SHEET_LOGS)?DELETE_MARK_COL_LOGS:DELETE_MARK_COL_LOCKS; if(e.range.getColumn()!==markCol || e.range.getRow()<=HEADER_ROWS) return; const v=String(e.value||'').trim(); if(v!==DELETE_TOKEN) return; const code = getCodeFromRow_(sh, e.range.getRow()); if(!code) return; const ss=SpreadsheetApp.getActive(); const lock=LockService.getScriptLock(); if(!lock.tryLock(20000)) return; try{ deleteByCodes_(ss, new Set([code])); // 清掉標記，避免重複觸發 try{ sh.getRange(e.range.getRow(), markCol).clearContent(); }catch(_){} }finally{ try{ lock.releaseLock(); }catch(_){} } }catch(err){ Logger.log('onEdit error: '+err); } } /** 單筆：以當前列代號為鍵對刪 */ function deleteSelectedRowWithPair_(){ const ss=SpreadsheetApp.getActive(); const sh=ss.getActiveSheet(); if(!sh) return; const name=sh.getName(); if(name!==SHEET_LOGS && name!==SHEET_LOCKS){ SpreadsheetApp.getUi().alert('請在logs或locks表上執行。'); return; } const row=sh.getActiveRange().getRow(); if(row<=HEADER_ROWS){ SpreadsheetApp.getUi().alert('請選資料列。'); return; } const code=getCodeFromRow_(sh, row); if(!code){ SpreadsheetApp.getUi().alert('此列沒有代號，無法對刪。'); return; } const lock=LockService.getScriptLock(); if(!lock.tryLock(20000)) return; try{ const res=deleteByCodes_(ss, new Set([code])); SpreadsheetApp.getUi().alert(已刪除代號${code}）。); }finally{ try{ lock.releaseLock(); }catch(_){} } } /** 批次：支援濾鏡＋多段；以代號集合為鍵對刪 */ function deleteSelectedRangeWithPair_(){ const ss=SpreadsheetApp.getActive(); const sh=ss.getActiveSheet(); if(!sh) return; const activeName=sh.getName(); if(activeName!==SHEET_LOGS && activeName!==SHEET_LOCKS){ SpreadsheetApp.getUi().alert('請在logs或locks表上執行。'); return; } const rows=collectSelectedRows_(ss); if(rows.length===0){ SpreadsheetApp.getUi().alert('沒有可刪的資料列。'); return; } const codes=new Set(); rows.forEach(r=>{ const c=getCodeFromRow_(sh, r); if(c) codes.add(c); }); if(codes.size===0){ SpreadsheetApp.getUi().alert('選取列沒有代號。'); return; } if(codes.size>BATCH_CODES_LIMIT){ SpreadsheetApp.getUi().alert(一次最多刪${BATCH_CODES_LIMIT}個代號，目前為${codes.size}個。請分批執行。); return; } const lock=LockService.getScriptLock(); if(!lock.tryLock(20000)) return; try{ const res=deleteByCodes_(ss, codes); SpreadsheetApp.getUi().alert(批次完成刪除代號${codes.size}個。); }finally{ try{ lock.releaseLock(); }catch(_){} } } /** 掃描兩表「刪除標記欄為 '-'」→ 以代號集合為鍵對刪 */ function deleteMarkedRowsWithPair_(){ const ss=SpreadsheetApp.getActive(); const logs=ss.getSheetByName(SHEET_LOGS); const locks=ss.getSheetByName(SHEET_LOCKS); if(!logs && !locks){ SpreadsheetApp.getUi().alert('找不到logs/locks工作表'); return; } function collectCodes_(sh, markCol, isLocks){ if(!sh) return []; const last=sh.getLastRow(); if(last<=HEADER_ROWS) return []; const vals=sh.getRange(HEADER_ROWS+1, markCol, last-HEADER_ROWS, 1).getValues(); const out=[]; for(let i=0;i<vals.length;i++){ const v=String(vals[i][0]||'').trim(); if(v===DELETE_TOKEN){ const row = i+HEADER_ROWS+1; const codeCol = isLocks ? 3 : 2; const code = normalizeCode_(sh.getRange(row, codeCol).getValue()); if(code) out.push({row,code}); } } return out; } const markedL = collectCodes_(logs, DELETE_MARK_COL_LOGS, false); const markedK = collectCodes_(locks, DELETE_MARK_COL_LOCKS, true); const codes = new Set([...markedL, ...markedK].map(x=>x.code)); if(codes.size===0){ SpreadsheetApp.getUi().alert(沒有標記為${DELETE_TOKEN}的列。); return; } if(codes.size>BATCH_CODES_LIMIT){ SpreadsheetApp.getUi().alert(一次最多刪${BATCH_CODES_LIMIT}個代號，目前為${codes.size}個。請分批執行。); return; } const lock=LockService.getScriptLock(); if(!lock.tryLock(20000)) return; try{ const res=deleteByCodes_(ss, codes); // 清空原表上的標記（被刪掉的列自然也沒了） try{ markedL.forEach(x=>{ try{ logs.getRange(x.row, DELETE_MARK_COL_LOGS ).clearContent(); }catch(_){ } }); markedK.forEach(x=>{ try{ locks.getRange(x.row, DELETE_MARK_COL_LOCKS).clearContent(); }catch(_){ } }); }catch(_){} SpreadsheetApp.getUi().alert(已刪除代號${codes.size}個。); }finally{ try{ lock.releaseLock(); }catch(_){} } } /* === 其他工具（鎖定 / 名單 / DNS 檢查） ==================================== */ function getOrCreateLocksSheet_(ss){ let sh=ss.getSheetByName(SHEET_LOCKS); if(!sh){ sh=ss.insertSheet(SHEET_LOCKS); sh.appendRow(['usedAt','email','code','status']); }else{ const head=sh.getRange(1,1,1,4).getValues()[0]; if((head[0]+'').toLowerCase()!=='usedat' || (head[1]+'').toLowerCase()!=='email'){ sh.getRange(1,1,1,4).setValues([['usedAt','email','code','status']]); } } return sh; } function hasUsed_(locksSheet, code, email){ const last=locksSheet.getLastRow(); if(last<=HEADER_ROWS) return false; const emailRange=locksSheet.getRange(HEADER_ROWS+1,2,last-HEADER_ROWS,1); const hits=emailRange.createTextFinder(email).findAll(); if(!hits||!hits.length) return false; for(const m of hits){ const r=m.getRow(); const c=String(locksSheet.getRange(r,3).getValue()).trim(); const st=String(locksSheet.getRange(r,4).getValue()||'').toLowerCase(); if(c===code && st!=='revoked') return true; } return false; } function getGuestStatus_(ss, code){ const result={exists:false,deadlinePassed:false}; if(!code) return result; const sh=ss.getSheetByName(SHEET_GUESTS); if(!sh) return result; const last=sh.getLastRow(); if(last<HEADER_ROWS+1) return result; const rng=sh.getRange(HEADER_ROWS+1,3,last-HEADER_ROWS,3).getValues(); // C:code, D:date, E:deadline let found=null; for(let i=0;i<rng.length;i++){ if(String(rng[i][0]||'').trim()===code){ found=rng[i]; break; } } if(!found) return result; result.exists=true; const dl=found[2]; let deadline=(dl instanceof Date)?dl:new Date(dl); if(isNaN(deadline.getTime())) return result; if(deadline.getHours()===0 && deadline.getMinutes()===0 && deadline.getSeconds()===0){ deadline=new Date(deadline.getFullYear(),deadline.getMonth(),deadline.getDate(),23,59,59); } if(new Date().getTime()>deadline.getTime()) result.deadlinePassed=true; return result; } /* MX/A 檢查（選用；不需可讓 checkEmailDomain_ 直接 return true） */ function checkEmailDomain_(email){ const domain=String(email).split('@')[1]||''; if(!domain) return false; const sp=PropertiesService.getScriptProperties(); const key='mxcache.'+domain; const raw=sp.getProperty(key); const now=Date.now(), TTL=24*60*60*1000; if(raw){ const [flag,ts]=raw.split('@'); if(Number(ts) && (now-Number(ts)<TTL)) return flag==='1'; } const hasMX=hasDnsRecord_(domain,'MX'); const ok=hasMX || hasDnsRecord_(domain,'A'); sp.setProperty(key,(ok?'1':'0')+'@'+String(now)); return ok; } function hasDnsRecord_(name,type){ try{ const url='https://dns.google/resolve?name='+encodeURIComponent(name)+'&type='+encodeURIComponent(type); const res=UrlFetchApp.fetch(url,{ muteHttpExceptions:true, followRedirects:true, validateHttpsCertificates:true }); const body=JSON.parse(res.getContentText()||'{}'); if(body.Status!==0) return false; const answers=body.Answer||[]; if(!answers.length) return false; if(type==='MX') return answers.some(a=>Number(a.type)===15); if(type==='A') return answers.some(a=>Number(a.type)===1); return false; }catch(_){ return false; } }
