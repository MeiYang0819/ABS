<!doctype html>
<html lang="zh-Hant">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>🎵互動音符🎵</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700&display=swap" rel="stylesheet">

<style>
/* ====================== 外觀樣式（你能改的我都有註記） ====================== */
/* ✅ 可更改：站內配色、欄寬、字級、陰影等 */
:root{
  --brand:#D4BFAA;   /* ✅ 可更改：頁面主色 */
  --title:#A68A7C;   /* ✅ 可更改：標題色 */
  --neutral:#E4E4E4; /* ✅ 可更改：面板底色/邊框色 */
  --soft:#F5F1EC;    /* ✅ 可更改：狀態列/鍵盤底色 */
  --accent:#BFA5A0;  /* ✅ 可更改：重點文字顏色 */
  --rim:#E4E4E4;     /* ✅ 可更改：輸入框邊框色 */
  --ink:#0f172a;     /* ✅ 可更改：正文字色 */

  --w-displayName: 220px; /* ✅ 可更改：暱稱欄寬（唯讀） */
  --w-instrument:  96px;  /* ✅ 可更改：樂器選單寬 */
  --w-lastNote:    160px; /* ✅ 可更改：三音顯示寬 */
  --w-lastNote-m:  180px; /* ✅ 可更改：手機寬 */

  --label-w:88px; /* ✅ 可更改：左側標籤寬 */
  --gap:10px;     /* ✅ 可更改：欄位間距 */
  --kb-h:280px;   /* ✅ 可更改：樂器高度（piano/guitar 同步） */
  --sep:2px;      /* ✅ 可更改：白鍵分隔線寬 */

  --stroke:rgba(0,0,0,.18);   /* ✅ 可更改：字描邊 */
  --glow:rgba(255,255,255,.65); /* ✅ 可更改：字高光 */

  --w-hintbtn: 160px; /* ✅ 可更改：備註按鈕寬 */
  --hint-fz: 12px;    /* ✅ 可更改：備註字級 */
  --hint-maxw: 520px; /* ✅ 可更改：備註最大寬 */
}

*{
  box-sizing:border-box;
  font-family:"Zen Maru Gothic","Noto Sans TC",system-ui,-apple-system,sans-serif !important;
  -webkit-text-stroke:.35px var(--stroke);
  text-shadow:0 1px 0 var(--glow);
}
html,body{ margin:0; color:var(--ink); background:var(--brand); font-weight:700; }
#guideOverlay .dialog, #guideOverlay .dialog *{ font-weight:500 !important; -webkit-text-stroke:0 !important; text-shadow:none !important; }

/* 容器與標題（外框/陰影/圓角） */
.bg-notes{ position:fixed; inset:0; width:100%; height:100%; object-fit:cover; opacity:.60; mix-blend-mode:multiply; filter:contrast(1.1); pointer-events:none; z-index:0; }
.panel{ position:relative; z-index:1; max-width:1060px; margin:22px auto; background:var(--neutral); border:1px solid var(--neutral);
        border-radius:16px; padding:18px 18px 26px; box-shadow:0 10px 26px rgba(0,0,0,.10); backdrop-filter:blur(8px) saturate(115%); }
h2{ margin:4px 0 20px; text-align:center; font-size:2.8rem; font-weight:700; letter-spacing:1px; color:var(--title);
    -webkit-text-stroke:.6px rgba(0,0,0,.12); text-shadow:0 3px 4px rgba(255,255,255,.75); }

/* 表單列 */
.row{ display:flex; gap:var(--gap); align-items:center; flex-wrap:wrap; margin-top:10px; }
.row label{ width:var(--label-w); opacity:.92; white-space:nowrap; font-weight:700; -webkit-text-stroke:0; text-shadow:none; }
.row input,.row select,.row button{
  height:38px; font-size:14px; background:#fff; padding:8px 10px; border:1px solid var(--rim); border-radius:10px;
  -webkit-text-stroke:.25px rgba(0,0,0,.12); text-shadow:0 1px 0 rgba(255,255,255,.5);
}
.row input,.row select{ box-shadow: 0 2px 0 rgba(0,0,0,.08), 0 2px 8px rgba(0,0,0,.04); }

#displayName{ width:var(--w-displayName); } /* 暱稱唯讀 */
#instrument{  width:var(--w-instrument); }
#lastNote{ width:var(--w-lastNote); text-align:center; letter-spacing:.3px; }
#lastNote::placeholder{ text-align:center; }

@media (min-width: 861px){ .align-to-email{ margin-left: 0; } }

/* 按鈕 */
.row button{ width:120px; cursor:pointer; font-weight:700; transition: transform .08s ease, box-shadow .08s ease, filter .08s ease;
             box-shadow: 0 2px 0 rgba(0,0,0,.15), 0 2px 8px rgba(0,0,0,.06); }
.btn-compact{ width:60px !important; } /* ✅ 可更改：縮版按鈕寬 */
#hintBtn{ width: var(--w-hintbtn) !important; } /* 備註按鈕寬 */

.row button:disabled{ opacity:.55; cursor:not-allowed; }
.row button:active, .row button.pressed{ transform: translateY(1px) scale(.99); box-shadow: 0 1px 0 rgba(0,0,0,.18), 0 1px 4px rgba(0,0,0,.06); filter: brightness(.98); }

/* 狀態列（文案保持你要的四種） */
#status{
  background: var(--soft); border:1px solid var(--neutral); border-radius:12px; padding:10px; margin-top:10px; font-size:14px; white-space:pre-wrap;
  text-align:center; color: var(--accent) !important; font-weight:700; -webkit-text-stroke:.35px rgba(0,0,0,.10);
  text-shadow:0 1px 0 rgba(255,255,255,.85), 0 3px 6px rgba(0,0,0,.04);
}
#status.ok,#status.busy,#status.err{ color: var(--accent) !important; font-weight:700; -webkit-text-stroke:.35px rgba(0,0,0,.10);
                                     text-shadow:0 1px 0 rgba(255,255,255,.85), 0 3px 6px rgba(0,0,0,.04); }

/* 備註小浮層 */
.actions-inline{ display:flex; gap:var(--gap); position:relative; }
.hint-popover{ position:absolute; right:0; top:44px; z-index:50; max-width: var(--hint-maxw); min-width: 260px; padding:10px 12px; font-size:var(--hint-fz);
               line-height:1.45; color:var(--accent); background:#fff; border:1px solid var(--accent); border-radius:12px;
               box-shadow:0 8px 24px rgba(0,0,0,.10), 0 2px 8px rgba(0,0,0,.06); display:none; white-space:normal; --arrow-x: calc(100% - 24px); }
.hint-popover.show{ display:block; }
.hint-popover::before{ content:""; position:absolute; left:var(--arrow-x); top:-8px; transform:translateX(-50%); width:0; height:0;
  border-left:8px solid transparent; border-right:8px solid transparent; border-bottom:8px solid var(--accent); }
.hint-popover::after{ content:""; position:absolute; left:var(--arrow-x); top:-7px; transform:translateX(-50%); width:0; height:0;
  border-left:7px solid transparent; border-right:7px solid transparent; border-bottom:7px solid #fff; }

/* 鍵盤容器 */
.kb-wrap{ overflow-x:auto; -webkit-overflow-scrolling:touch; background:var(--soft); border:1px solid var(--rim); border-radius:14px; margin-top:14px; }
#keyboard{ position:relative; height:var(--kb-h); user-select:none; -webkit-user-select:none; touch-action: pan-x pan-y; }

/* ========== 鋼琴外觀（維持你的原樣式） ========== */
.white{
  position:absolute; bottom:0; height:100%;
  background:linear-gradient(#ffffff,#eceef3 72%,#d9dde5);
  border-radius:0 0 12px 12px;
  box-shadow:inset 0 -12px 16px rgba(0,0,0,.12), inset 0 1px 0 rgba(255,255,255,.9), 0 1px 0 rgba(0,0,0,.04);
}
.white::after{ content:""; position:absolute; top:0; bottom:0; right:0; width:var(--sep); background:linear-gradient(transparent,#cfd3dc 50%,transparent); }
.white:first-child::before{ content:""; position:absolute; top:0; bottom:0; left:0; width:var(--sep); background:linear-gradient(transparent,#cfd3dc 50%,transparent); }
.white.active{ filter:brightness(1.06); }
.black{
  position:absolute; bottom:38%; height:62%;
  background:linear-gradient(#2d2f36,#0e0f13);
  border:1px solid #0b0d11; border-top:none; border-radius:0 0 10px 10px;
  z-index:5; box-shadow:inset 0 -6px 10px rgba(0,0,0,.45), 0 3px 10px rgba(0,0,0,.35);
  transform: translateX(-50%);
}
.black.active{ filter:brightness(1.22); }

/* ========== 吉他外觀（採你提供的視覺：粗弦在下方） ========== */
.fretboard{
  position:relative; display:grid; grid-template-columns: repeat(13, 1fr);
  width:100%; height:var(--kb-h);
  background:linear-gradient(180deg,#6b4f2e 0%, #5b4429 50%, #533c24 100%);
  border-radius:12px; box-shadow:inset 0 10px 20px rgba(0,0,0,.25), inset 0 -8px 16px rgba(0,0,0,.2);
}
.head{ position:absolute; left:0; top:0; bottom:0; width:86px; z-index:2; background:linear-gradient(180deg, rgba(0,0,0,.12), transparent 40%),linear-gradient(180deg,#7a5534 0%, #6b4f2e 55%, #5a3f24 100%); box-shadow: inset -8px 0 16px rgba(0,0,0,.18); border-radius:12px 0 0 12px; pointer-events:none; }
.nut{ position:absolute; left:86px; top:0; bottom:0; width:8px; z-index:3; background:linear-gradient(180deg,#e5e1d6,#c9c5ba); box-shadow: inset -1px 0 0 rgba(0,0,0,.35), inset 1px 0 0 rgba(255,255,255,.6); border-right:2px solid rgba(120,120,120,.5); pointer-events:none; }
.bridge{ position:absolute; right:0; top:0; bottom:0; width:10px; z-index:2; background:linear-gradient(180deg,#b9b6ad,#8f8c83); box-shadow: inset 1px 0 0 rgba(255,255,255,.5), inset -1px 0 0 rgba(0,0,0,.25); pointer-events:none; border-left:1px solid rgba(0,0,0,.18); }
.fret-col{ position:relative; background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.02)); box-shadow: inset -2px 0 0 rgba(255,255,255,.18), inset -4px 0 0 rgba(0,0,0,.28); }

/* 弦＋高光（粗→細：底部到頂部） */
.string{ --sw:2px; position:absolute; left:94px; right:0; height:0; z-index:3; border-top: var(--sw) solid transparent; transform-origin:center; filter:drop-shadow(0 1px 0 rgba(0,0,0,.18)); background: linear-gradient(90deg, rgba(255,255,255,0) 0%, rgba(255,255,255,.45) 50%, rgba(255,255,255,0) 100%); background-size:160px 1px; background-repeat:no-repeat; background-position:-160px 0; }
.string::before{ content:""; position:absolute; left:0; right:0; top: calc(var(--sw) * -0.5); height: var(--sw); background: repeating-linear-gradient(90deg, #caa56b 0 2.4px, #906a3d 2.4px 3.1px), repeating-linear-gradient(90deg, rgba(255,255,255,.08) 0 2.4px, rgba(0,0,0,.10) 2.4px 3.1px), linear-gradient(180deg, rgba(255,255,255,.70), rgba(255,255,255,.15) 55%, rgba(0,0,0,.18) 100%); border-radius:999px; opacity:.98; pointer-events:none; }
.string::after{ content:""; position:absolute; left:0; right:0; top: calc(var(--sw) * -0.5 + 0.2px); height: calc(var(--sw) * .25); background: linear-gradient(180deg, rgba(255,255,255,.55), rgba(255,255,255,0)); pointer-events:none; border-radius:999px; opacity:.9; }
.string[data-s="2"]{ --sw:2.5px; }
.string[data-s="3"]{ --sw:3px; }
.string[data-s="4"]{ --sw:3.5px; }
.string[data-s="5"]{ --sw:4px; }

/* 弦在琴頭區 */
.head-line{ --sw:2px; position:absolute; left:0; width:86px; height:0; z-index:2; border-top: var(--sw) solid transparent; filter:drop-shadow(0 1px 0 rgba(0,0,0,.06)); pointer-events:none; }
.head-line::before{ content:""; position:absolute; left:0; right:0; top: calc(var(--sw) * -0.5); height: var(--sw); background: repeating-linear-gradient(90deg, #caa56b 0 2.4px, #906a3d 2.4px 3.1px), repeating-linear-gradient(90deg, rgba(255,255,255,.08) 0 2.4px, rgba(0,0,0,.10) 2.4px 3.1px), linear-gradient(180deg, rgba(255,255,255,.55), rgba(255,255,255,0)); border-radius:999px; opacity:.98; }
.head-line::after{ content:""; position:absolute; left:0; right:0; top: calc(var(--sw) * -0.5 + 0.2px); height: calc(var(--sw) * .25); background: linear-gradient(180deg, rgba(255,255,255,.55), rgba(255,255,255,0)); border-radius:999px; opacity:.9; }
.head-line[data-s="2"]{ --sw:2.5px; }
.head-line[data-s="3"]{ --sw:3px; }
.head-line[data-s="4"]{ --sw:3.5px; }
.head-line[data-s="5"]{ --sw:4px; }

/* 可點擊行（每弦一列），含震動動畫 */
.hit-row{ position:absolute; left:0; right:0; height:28px; transform:translateY(-50%); background:transparent; cursor:pointer; z-index:4; }
@media (pointer:coarse){ .hit-row{ height:34px; } }
.string.vibrate{ animation: vibrCurve 360ms ease-out, shine 360ms ease-out; }
@keyframes vibrCurve{ 0%{transform:translateY(0)} 10%{transform:translateY(-3.2px)} 20%{transform:translateY(0)} 30%{transform:translateY(2.6px)} 45%{transform:translateY(0)} 60%{transform:translateY(-1.8px)} 75%{transform:translateY(0.6px)} 100%{transform:translateY(0)} }
@keyframes shine{ 0%{ background-position:-160px 0; opacity:.95 } 100%{ background-position:160px 0; opacity:.96 } }

/* Dialog / Footer */
.overlay{ position:fixed; inset:0; z-index:9999; display:flex; align-items:center; justify-content:center; background:rgba(17,24,39,.35); backdrop-filter:blur(3px); pointer-events:auto; }
.overlay.hidden{ display:none; }
.dialog{ min-width:300px; max-width:92vw; background:var(--soft); border:1px solid var(--neutral); border-radius:14px; padding:18px;
         box-shadow:0 18px 44px rgba(0,0,0,.18); text-align:center; pointer-events:auto; }
.dialog h3{ margin:0 0 8px; font-size:18px; color:#6b5e52; }
.dialog .actions{ display:flex; gap:10px; justify-content:center; margin-top:12px; }
.dialog button{ width:120px; height:38px; border-radius:10px; border:1px solid var(--rim); background:#fff; cursor:pointer; font-weight:700;
                /* 放大彈窗按鈕字：了解／取消／確定 */ font-size:16px; }
.dialog button.primary{ background:#fff; }

#lockScreen{ position:fixed; inset:0; z-index:9998; display:none; background:transparent; }
footer{ max-width:1060px;margin:8px auto 22px; text-align:center; color:#6b5e52; font-size:12px; opacity:.9; }

@media (orientation:portrait){
  .row-line2,.row-line3{ width:100%; gap:12px; }
  .pair{ display:flex; align-items:center; gap:var(--gap); width:100%; }
  .actions-inline{ display:flex; gap:var(--gap); }
  .row-line2 .pair, .row-line3 .pair, .row-line3 .actions-inline{ flex:0 0 100%; }
  .align-to-email{ margin-left:0 !important; }
  #lastNote{ width:var(--w-lastNote-m); }
}
</style>

<body>
<img class="bg-notes" src="./assets/notes.png" alt="">
<div class="panel">
  <h2>🎵互動音符🎵</h2>

  <div class="row row-line2">
    <div class="pair">
      <label for="displayName">偶的暱稱：</label>
      <input id="displayName" readonly aria-readonly="true" placeholder="等待載入…" />
    </div>
    <div class="pair">
      <label for="instrument">樂器轉換：</label>
      <select id="instrument">
        <option value="piano" selected>鋼琴</option>
        <option value="guitar">吉他</option>
      </select>
    </div>
    <div class="pair">
      <label for="lastNote" class="align-to-email">音符紀錄：</label>
      <input id="lastNote" placeholder="— , — , —" readonly />
    </div>
    <div class="actions-inline">
      <button id="resetBtn" type="button" class="btn-compact">重設</button>
      <button id="lockBtn"  type="button" class="btn-compact" disabled>鎖定</button>
      <button id="hintBtn"  type="button" class="btn-compact" aria-expanded="false" aria-controls="hintPopover" title="點我查看備註">先點我查看好咪🥺</button>
      <div id="hintPopover" class="hint-popover" role="note" aria-live="polite">
        按「鎖定」後請稍候，本人有缺陷導致速度較慢🥲<br>確認送出成功，下方「狀態列」會立即通知您溜🎉
      </div>
    </div>
  </div>

  <p id="status">尚未初始化</p>
  <div class="kb-wrap"><div id="keyboard"></div></div>
</div>

<!-- 操作說明 -->
<div id="guideOverlay" class="overlay" role="dialog" aria-modal="true" aria-labelledby="guideTitle">
  <div class="dialog">
    <h3 id="guideTitle">📍操作說明📍</h3>   
    <p>🔻可選擇鋼琴或吉他中的三個音階</p><p>↓</p>
    <p>🔻三個音階確認後，一定要按鎖定</p><p>↓</p>
    <p>🔻鎖定完成後，會有通知是否成功</p><p>↓</p>
    <p>🔺若成功即可退出介面；反之再試</p><p>↓</p>
    <p>❗️沒按鎖定就是沒有送出就是彈個寂寞</p>
    <div class="actions"><button id="guideOk" class="primary">了解</button></div>
  </div>
</div>

<!-- 啟音 -->
<div id="unlockOverlay" class="overlay hidden" role="dialog" aria-modal="true" aria-labelledby="unlockTitle">
  <div class="dialog">
    <h3 id="unlockTitle">啟用聲音</h3>
    <p class="ios-hint">iPhone請確保側邊「靜音鍵」有開啟響鈴模式</p>
    <div class="actions">
      <button id="cancelUnlock">取消</button>
      <button id="confirmUnlock" class="primary">確定</button>
    </div>
  </div>
</div>

<div id="lockScreen" aria-hidden="true"></div>
<footer>© Copyright 2025 MY‘s System</footer>

<!-- ====================== 外部腳本（CDN） ====================== -->
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script src="https://cdn.jsdelivr.net/npm/tone@14.8.49/build/Tone.min.js"></script>

<script>
/* ====================== 前端設定（請填） ====================== */
/* ✅ 可更改：LIFF ID 與後端網址 */
const LIFF_ID = '2008149060-ZGVdAvGo';  // ← 你的 LIFF ID
const WEBHOOK = 'https://script.google.com/macros/s/AKfycbwZ3rsTZjJEesMwBvE6ATogGyXdRiIwvS8dVhD6WtsEjw3qgbxna4wOuZzLQxAX7czv/exec'; // ← 你的 GAS 網址

/* ===== 提醒（僅註解，幫你記得要去 GAS 也更新） =====
   // ✅ 主本/副本 試算表 ID（兩本結構相同）
   // const SPREADSHEET_ID_MAIN   = '1loTbnXfQ90AN3tGUdpEsR3AGZUFHvaijBSctOUSZQFs';
   // const SPREADSHEET_ID_PUBLIC = '18hxRoLU_TFV6Dc4fNAxQFEv9VAYoSbeVZvfIZ17MHPQ';
   // ✅ LIFF 頁面網址（按鈕訊息會開這個網址）
   // const LIFF_URL = 'https://meiyang0819.github.io/SSS/line.html';
============================================================== */

/* ✅ 可更改：逾時毫秒（提高到 40 秒，降低假性逾時） */
const TIMEOUT_MS = 40000;

/* （預留）一段話：會一併送到後端 logs G 欄（目前不顯示輸入框，之後你要用再接UI） */
let extraMessage = ''; // ✅ 可更改：之後若做輸入框，改寫這個變數即可一併送出

const $ = s => document.querySelector(s);

/* 狀態列（固定四種語意） */
function setStatus(m){
  const el = $('#status');
  el.textContent = m;
  el.classList.remove('ok','busy','err');
  if(/已送出成功/.test(m)) el.classList.add('ok');
  else if(/忙碌|等待|送出中|處理中/i.test(m)) el.classList.add('busy');
  else if(/已填寫過|截止|失敗|逾時|not found|無法|超時|網路/i.test(m)) el.classList.add('err');
}

/* ====================== 音訊與選音 ====================== */
let audioCtx=null, sampler=null, samplerReady=false, unlocked=false, hardLocked=false;
let currentInstrument='piano';
let selectedNotes=[], selectedInsts=[];

/* ✅ 可更改：音色檔路徑與檔名表 */
const PIANO_BASE = new URL('./piano/', location.href).href;   // ✅ 可更改
const GUITAR_BASE = new URL('./guitar/', location.href).href; // ✅ 可更改
const PIANO_URLS = {'A1':'A1.mp3','C2':'C2.mp3','D#2':'Ds2.mp3','F#2':'Fs2.mp3','A2':'A2.mp3','C3':'C3.mp3','D#3':'Ds3.mp3','F#3':'Fs3.mp3','A3':'A3.mp3','C4':'C4.mp3','D#4':'Ds4.mp3','F#4':'Fs4.mp3','A4':'A4.mp3','C5':'C5.mp3'};
/* ✅ 可更改：吉他若有多採樣可補齊對映，沒有就以開放弦近似 */
const GUITAR_URLS = {'E2':'E2.wav','A2':'A2.wav','D3':'D3.wav','G3':'G3.wav','B3':'B3.wav','E4':'E4.wav'};

/* 鋼琴白鍵序列與黑鍵對應 */
const WHITE=["C3","D3","E3","F3","G3","A3","B3","C4","D4","E4","F4","G4","A4","B4"];
const BLACK_AFTER={ 'C':'C#','D':'D#','F':'F#','G':'G#','A':'A#' };
const MIN_WHITE_PX=64, TOTAL_WHITE=WHITE.length;

/* 吉他音名計算（採你原本：最粗弦在畫面底部） */
const TUNING_MIDI = [40,45,50,55,59,64]; // E2 A2 D3 G3 B3 E4（由粗到細）
const NOTE_NAMES = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];

function unlockAudioInit(){
  const Ctx=window.webkitAudioContext||window.AudioContext;
  if(!audioCtx) audioCtx=new Ctx({latencyHint:'interactive'});
  Tone.setContext(new Tone.Context(audioCtx));
}
async function unlockAudio(){
  try{
    unlockAudioInit();
    if(audioCtx.state!=='running') await audioCtx.resume();
    await Tone.start();
    loadSampler(currentInstrument);
    unlocked=true;
    $('#unlockOverlay').classList.add('hidden');
  }catch(e){ setStatus('啟用失敗：'+e.message); }
}
function loadSampler(inst='piano'){
  sampler?.dispose?.(); sampler=null; samplerReady=false;
  let urls=PIANO_URLS, base=PIANO_BASE, label='🎹 ';
  if(inst==='guitar'){ urls=GUITAR_URLS; base=GUITAR_BASE; label='🎸 '; }
  setStatus(label+'載入中…');
  try{
    sampler=new Tone.Sampler({ urls, release:1, baseUrl:base, onload:()=>{ samplerReady=true; setStatus(label+'已載入 ✅'); } }).toDestination();
  }catch(e){ setStatus('❌ 音色初始化失敗：'+e.message); }
}

/* 播音 + 三音紀錄 */
function trigger(note){
  if(hardLocked) return;
  if(!samplerReady){ setStatus('音色載入中…'); return; }
  sampler.triggerAttackRelease(note,'8n');
  if(selectedNotes.length<3){ selectedNotes.push(note); selectedInsts.push(currentInstrument); }
  else { selectedNotes[2]=note; selectedInsts[2]=currentInstrument; }
  refreshNotesDisplay(); validateLockBtn();
}
function refreshNotesDisplay(){ $('#lastNote').value = [selectedNotes[0]||'—', selectedNotes[1]||'—', selectedNotes[2]||'—'].join(' , '); }
function validateLockBtn(){ $('#lockBtn').disabled = !(selectedNotes.length===3); }

/* ========== 鋼琴繪製 ========== */
function renderPiano(){
  const kb=$('#keyboard'); kb.innerHTML=''; kb.className=''; sizePiano();
  const keyW=100/TOTAL_WHITE;
  WHITE.forEach((note,i)=>{
    const w=document.createElement('div'); w.className='white'; w.dataset.note=note;
    w.style.left=(i*keyW)+'%'; w.style.width=keyW+'%';
    w.addEventListener('pointerdown', ()=>{ if(hardLocked) return; if(!unlocked){ $('#unlockOverlay').classList.remove('hidden'); return; } trigger(note); w.classList.add('active'); });
    w.addEventListener('pointerup', ()=>w.classList.remove('active'));
    kb.appendChild(w);
  });
  WHITE.forEach((note,i)=>{
    const l=note[0], sharp = BLACK_AFTER[l]? (BLACK_AFTER[l]+note.slice(1)) : null;
    if(!sharp || (l==='A' && i===TOTAL_WHITE-1)) return;
    const b=document.createElement('div'); b.className='black'; b.dataset.note=sharp;
    const blackWidthPct = keyW*0.62; b.style.width = blackWidthPct+'%'; b.style.left=((i+1)*keyW)+'%';
    b.addEventListener('pointerdown', ()=>{ if(hardLocked) return; if(!unlocked){ $('#unlockOverlay').classList.remove('hidden'); return; } trigger(sharp); b.classList.add('active'); });
    b.addEventListener('pointerup', ()=>b.classList.remove('active'));
    kb.appendChild(b);
  });
}
function sizePiano(){
  const wrap=document.querySelector('.kb-wrap');
  const kb=document.querySelector('#keyboard');
  const wrapW=wrap.clientWidth;
  const sep=parseInt(getComputedStyle(kb).getPropertyValue('--sep')||'2',10);
  const minW=WHITE.length*(MIN_WHITE_PX+sep);
  kb.style.width=(wrapW>=minW?wrapW-1:minW)+'px';
  kb.style.height='var(--kb-h)';
}

/* ========== 吉他繪製（照你的版本：粗弦在下方） ========== */
function renderGuitar(){
  const kb=$('#keyboard'); kb.innerHTML=''; kb.className='fretboard'; kb.style.height='var(--kb-h)';
  // 頭、上枕、橋
  const head=document.createElement('div'); head.className='head'; kb.appendChild(head);
  const nut =document.createElement('div');  nut.className='nut';  kb.appendChild(nut);
  const bridge=document.createElement('div'); bridge.className='bridge'; kb.appendChild(bridge);

  // 6 條弦（由上→下為細→粗；我們的點擊邏輯會把 index 轉為 5-idx 取音高，確保「粗弦在下方」）
  for(let s=0;s<6;s++){
    const y=(s+1)*(100/7);
    const str=document.createElement('div'); str.className='string'; str.dataset.s=String(s); str.style.top = `${y}%`; kb.appendChild(str);
    const hline=document.createElement('div'); hline.className='head-line'; hline.dataset.s=String(s); hline.style.top = `${y}%`; kb.appendChild(hline);
  }

  // 13 個欄位（0~12 品；我們畫 13 個分段，點在第 f 段即彈第 f 品）
  for(let f=1; f<=13; f++){
    const col=document.createElement('div'); col.className='fret-col';

    // 每欄 6 條點擊列
    for(let s=0; s<6; s++){
      const y=(s+1)*(100/7);
      const hit=document.createElement('div'); hit.className='hit-row'; hit.style.top = `${y}%`; col.appendChild(hit);
    }

    // 品記號（4,6,8,10 單點；13 雙點 = 第 12 品）
    if([4,6,8,10].includes(f)){
      const dot=document.createElement('div');
      dot.style.cssText='position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:16px;height:16px;border-radius:50%;background:#dbc6a4;opacity:.9;box-shadow:0 1px 0 rgba(0,0,0,.35);pointer-events:none;';
      col.appendChild(dot);
    }else if(f===13){
      const dot1=document.createElement('div'); dot1.style.cssText='position:absolute;left:50%;top:38%;transform:translate(-50%,-50%);width:14px;height:14px;border-radius:50%;background:#dbc6a4;opacity:.9;box-shadow:0 1px 0 rgba(0,0,0,.35);pointer-events:none;';
      const dot2=document.createElement('div'); dot2.style.cssText='position:absolute;left:50%;top:62%;transform:translate(-50%,-50%);width:14px;height:14px;border-radius:50%;background:#dbc6a4;opacity:.9;box-shadow:0 1px 0 rgba(0,0,0,.35);pointer-events:none;';
      col.appendChild(dot1); col.appendChild(dot2);
    }

    // 點擊事件：算出弦 index → 轉成 5-idx 取得對應開放弦，再 + f（最多 12 品）
    col.addEventListener('pointerdown',(ev)=>{
      if(hardLocked) return;
      if(!unlocked){ $('#unlockOverlay').classList.remove('hidden'); return; }
      const rect = col.getBoundingClientRect();
      const y = ev.clientY - rect.top;
      const slot = rect.height/7;
      let idx = Math.round(y/slot - 1); // 0=最上細弦, 5=最下粗弦（視覺）
      idx = Math.max(0, Math.min(5, idx));
      if(f<=12){
        const midi = TUNING_MIDI[5-idx] + f; // 轉為音高索引：5-idx 才是 E2..E4
        const note = NOTE_NAMES[midi % 12] + (Math.floor(midi/12) - 1);
        trigger(note);
      }
      const target = kb.querySelector(`.string[data-s="${idx}"]`);
      if(target){
        target.classList.remove('vibrate'); void target.offsetWidth; target.classList.add('vibrate');
        setTimeout(()=>target.classList.remove('vibrate'), 380);
      }
    });

    kb.appendChild(col);
  }
}

/* 尺寸變更時重繪 */
window.addEventListener('resize', ()=>{ if(currentInstrument==='piano') sizePiano(); });
window.addEventListener('orientationchange', ()=>{ if(currentInstrument==='piano') sizePiano(); });

/* 樂器切換 */
$('#instrument').addEventListener('change', ()=>{
  if(hardLocked) return;
  currentInstrument=$('#instrument').value;
  loadSampler(currentInstrument);
  if(currentInstrument==='guitar') renderGuitar(); else renderPiano();
  validateLockBtn();
});

/* 重設一顆：從尾端退一格 */
$('#resetBtn').addEventListener('click', ()=>{
  if(hardLocked) return;
  if(selectedNotes.length>0){ selectedNotes.pop(); selectedInsts.pop(); refreshNotesDisplay(); validateLockBtn(); }
});

/* 備註小浮層 */
const hintBtn=$('#hintBtn'), hintPop=$('#hintPopover');
function positionArrow(){
  const popRect=hintPop.getBoundingClientRect(), btnRect=hintBtn.getBoundingClientRect();
  const x=(btnRect.left+btnRect.width/2)-popRect.left;
  const clamped=Math.max(16, Math.min(popRect.width-16, x));
  hintPop.style.setProperty('--arrow-x', clamped+'px');
}
function closeHint(){ hintPop.classList.remove('show'); hintBtn.setAttribute('aria-expanded','false'); }
hintBtn.addEventListener('click', (e)=>{
  const showing=hintPop.classList.toggle('show');
  hintBtn.setAttribute('aria-expanded', showing?'true':'false');
  if(showing){ positionArrow(); }
  e.stopPropagation();
});
document.addEventListener('click', (e)=>{ if(!hintPop.classList.contains('show')) return;
  const within=hintPop.contains(e.target)||hintBtn.contains(e.target);
  if(!within) closeHint(); });
window.addEventListener('resize', ()=>{ if(hintPop.classList.contains('show')) positionArrow(); });
window.addEventListener('orientationchange', ()=>{ setTimeout(()=>{ if(hintPop.classList.contains('show')) positionArrow(); }, 250); });
window.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeHint(); });

/* ====================== 鎖定送出 ====================== */
let lineId='', displayName='', pictureUrl='';
$('#lockBtn').addEventListener('click', async ()=>{
  if(hardLocked) return;
  if(selectedNotes.length!==3){ alert('請彈滿 3 個音再鎖定'); return; }

  /* --- 先快速 ping 一下 GAS 是否可達 --- */
  try {
    const ping = await fetch(WEBHOOK + '?action=ping', { method:'GET', cache:'no-store' });
    const t = await ping.text().catch(()=> '');
    if (String(t).trim().toLowerCase() !== 'ok') {
      setStatus('⚠️ 後端未回應正常（ping='+t+'），請檢查 GAS 部署與權限');
      return;
    }
  } catch (_) {
    setStatus('⚠️ 無法連到後端（ping 失敗），請檢查 GAS URL/權限/網路');
    return;
  }

  setStatus('⏳ 送出中…');
  const payload = {
    action: 'submitNotes',                    // ★ 後端對齊
    lineId, displayName, pictureUrl,          // ★ logs B,C,D
    instrumentsCSV: selectedInsts.join(','),  // ★ logs E
    notesCSV:       selectedNotes.join(','),  // ★ logs F
    extraMessage                              // ★ 預留：logs G
  };

  // 第一次送出：text/plain 避免預檢；加 cache-busting 與 keepalive
  const controller=new AbortController();
  const timer=setTimeout(()=>controller.abort(), TIMEOUT_MS);

  let firstTried = false;
  try{
    firstTried = true;
    const r=await fetch(WEBHOOK + '?_t=' + Date.now(),{
      method:'POST',
      headers:{'Content-Type':'text/plain;charset=UTF-8'},
      body: JSON.stringify(payload),
      keepalive: true,
      signal: controller.signal
    });
    clearTimeout(timer);

    const ct = (r.headers.get('content-type')||'').toLowerCase();
    let j = null;
    if(ct.includes('application/json')){
      j = await r.json().catch(()=>null);
    }else{
      const t = await r.text().catch(()=> '');
      if(/^\s*\{/.test(t)){ try{ j = JSON.parse(t); }catch(_){} }
      if(!j && /(^|\b)ok(\b|$)/i.test(t)) j = { ok:true };
    }
    if(!j && r.ok){ j = { ok:true }; }

    if(j && j.ok){
      setStatus('✅ 已送出成功，可退安囉');
      enterHardLock();
    }else{
      const err = String(j?.error||'');
      if(err==='duplicate') setStatus('已填寫過了，想要更換音階請洽管理員呢🙏');
      else if(err==='deadline_passed') setStatus('已過截止日，但還可在這玩耍唷👣');
      else if(err==='busy') setStatus('⚠️ 系統忙碌或鎖等待，稍後再試🌀');
      else {
        const ctDebug = (r.headers.get('content-type')||'');
        setStatus(`⚠️ 送出失敗（HTTP ${r.status}）\ncontent-type=${ctDebug}\n請檢查 GAS 部署與權限`);
      }
    }
  }catch(e){
    // 清掉第一次的計時器，避免殘留
    clearTimeout(timer);

    if (e && (e.name === 'AbortError' || /abort/i.test(String(e)))) {
      setStatus('⚠️ 送出逾時，請再按一次鎖定（若仍逾時，請關閉重開或稍後再試）');
      return;
    }

    // 僅在「網路錯誤」時重試一次（不帶 signal，避免被第一次的 abort 影響）
    try {
      setStatus('網路閃斷，嘗試重送中…');
      const r2 = await fetch(WEBHOOK + '?_t=' + Date.now(), {
        method:'POST',
        headers:{'Content-Type':'text/plain;charset=UTF-8'},
        body: JSON.stringify(payload),
        keepalive: true,
        cache: 'no-store'
      });

      const ct2 = (r2.headers.get('content-type')||'').toLowerCase();
      let j2 = null;
      if (ct2.includes('application/json')) j2 = await r2.json().catch(()=>null);
      else {
        const t2 = await r2.text().catch(()=> '');
        if (/^\s*\{/.test(t2)) { try{ j2 = JSON.parse(t2); }catch(_){} }
        if (!j2 && /(^|\b)ok(\b|$)/i.test(t2)) j2 = { ok:true };
      }
      if(!j2 && r2.ok) j2 = { ok:true };

      if (j2 && j2.ok) {
        setStatus('✅ 已送出成功，可退安囉');
        enterHardLock();
      } else {
        const err = String(j2?.error||'');
        if(err==='duplicate') setStatus('已填寫過了，想要更換音階請洽管理員呢🙏');
        else if(err==='deadline_passed') setStatus('已過截止日，但還可在這玩耍唷👣');
        else if(err==='busy') setStatus('⚠️ 系統忙碌或鎖等待，稍後再試🌀');
        else {
          const ctDebug = (r2.headers.get('content-type')||'');
          setStatus(`⚠️ 送出失敗（HTTP ${r2.status}）\ncontent-type=${ctDebug}\n請檢查 GAS 部署與權限`);
        }
      }
    } catch (e2) {
      setStatus('⚠️ 網路異常或連線中斷，請確認網路後再試一次');
    }
  }
});

function enterHardLock(){
  hardLocked=true;
  $('#displayName').disabled=true;
  $('#instrument').disabled=true;
  $('#resetBtn').disabled=true;
  $('#lockBtn').disabled=true;
  $('#lockScreen').style.display='block';
}

/* ====================== 對話框流程 ====================== */
['click','touchend'].forEach(evt=>{
  document.addEventListener(evt,(e)=>{
    const t=e.target;
    if(t.id==='guideOk'){
      document.getElementById('guideOverlay').classList.add('hidden');
      document.getElementById('unlockOverlay').classList.remove('hidden');
      e.preventDefault();
    }else if(t.id==='cancelUnlock'){
      document.getElementById('unlockOverlay').classList.add('hidden');
      e.preventDefault();
    }else if(t.id==='confirmUnlock'){
      unlockAudio();
      document.getElementById('unlockOverlay').classList.add('hidden');
      e.preventDefault();
    }
  }, {passive:true});
});

/* ========= 小工具：去掉暱稱前面跑出來的「:」或「：」 ========= */
function sanitizeName(name){
  return String(name||'').replace(/^[\s:：]+/, ''); // 去前導空白/半形冒號/全形冒號
}

/* ====================== 初始化（畫面 / LIFF / Profile） ====================== */
async function init(){
  renderPiano();                 // 預設先畫鋼琴
  setStatus('等待啟用聲音…');
  validateLockBtn();
  $('#guideOverlay').classList.remove('hidden');

  try{
    setStatus('初始化 LIFF…');
    await liff.init({ liffId: LIFF_ID, withLoginOnExternalBrowser: true });

    if(!liff.isLoggedIn()){
      // ✅ 要求 openid + profile scope，避免取不到 userId / displayName
      liff.login({ scope: ['openid','profile'] });
      return; // 會重新導回本頁
    }
    if(liff.ready){ await liff.ready; } // 某些瀏覽器需要等 ready

    let prof = null, idt = null;
    try{ prof = await liff.getProfile(); }catch(_){}
    try{ idt  = liff.getDecodedIDToken(); }catch(_){}

    // 兩條路都試：getProfile 與 ID Token
    lineId      = (prof && prof.userId) || (idt && idt.sub) || '';
    displayName = sanitizeName( (prof && prof.displayName) || (idt && (idt.name || idt.nickname)) || '' );
    pictureUrl  = (prof && prof.pictureUrl) || '';

    if(!lineId){
      setStatus('請於 LINE App 內開啟此連結重試（無法取得 LINE ID）');
      return;
    }
    $('#displayName').value = displayName || '（匿名）';
    setStatus('已就緒');
  }catch(e){
    setStatus('LIFF 初始化失敗：'+e.message);
  }
}
window.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
