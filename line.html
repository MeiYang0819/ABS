/**** 互動音符 v2 – 後端完整版（Flex 二選一卡＆配色統一 + 永久保留頭貼暱稱 + LINE 端阻擋） ********
 * 表結構（主本 / 副本結構相同）
 *  - guests: A=man, B=woman, C=deadline
 *  - logs  : A=time, B=lineId, C=pictureUrl, D=這是親友(男方或女方)=role,
 *            E=displayName, F=instruments, G=notes, H=message
 ******************************************************************************/

/* ==================== 可調參數 ==================== */
const SPREADSHEET_ID_MAIN   = '1loTbnXfQ90AN3tGUdpEsR3AGZUFHvaijBSctOUSZQFs';
const SPREADSHEET_ID_PUBLIC = '18hxRoLU_TFV6Dc4fNAxQFEv9VAYoSbeVZvfIZ17MHPQ';
const LIFF_URL              = 'https://meiyang0819.github.io/SSS/line.html';

const KWS_PORTAL = ['音符','互動音符','吉他','鋼琴','🎵'];

const WELCOME_AUDIO_URL = 'https://drive.google.com/file/d/1Voif_FluZuNUMSjVeA6NitAb6skxnnFp/view?usp=drive_link';
const WELCOME_AUDIO_MS  = 6000;

/* 全局截止日（到當日 23:59:59 才算過期，台北時區） */
const GLOBAL_DEADLINE_ISO = '2025-08-31';

/* Flex 視覺控制 */
const FLEX_SIZE_LEVEL    = 2;  // 1 micro / 2 kilo / 3 mega
const GAP_LEVEL          = 2;  // 1 sm / 2 md / 3 lg
const LINK_FONT_LEVEL    = 2;  // 1 sm / 2 md / 3 lg
const LINK_WIDTH_PERCENT = 62;

const LINK_CORNER_PX     = 18;
const LINK_BORDER_PX     = 1;
const LINK_PAD_V_PX      = 12;
const LINK_PAD_H_PX      = 18;

const FLEX_COLORS = {
  body:   '#E4E4E4',
  footer: '#E4E4E4',
  title:  '#0f172a',
  accent: '#A68A7C',
  linkBg: '#F5F1EC'
};

const KEYWORD_THEME = { body:'#E4E4E4', footer:'#E4E4E4', title:'#0f172a', text:'#A68A7C' };

const SHEET_GUESTS = 'guests';
const SHEET_LOGS   = 'logs';
const TZ           = 'Asia/Taipei';
const TIME_FMT     = 'yyyy-MM-dd HH:mm:ss';
const HEADER_ROWS  = 1;

const ROLE_MALE_FRIEND   = 'MALE_FRIEND';
const ROLE_FEMALE_FRIEND = 'FEMALE_FRIEND';

/* 小工具 */
const J = (o)=>ContentService.createTextOutput(JSON.stringify(o)).setMimeType(ContentService.MimeType.JSON);
const T = (s)=>ContentService.createTextOutput(String(s||'')).setMimeType(ContentService.MimeType.TEXT);
const nowStr = ()=>Utilities.formatDate(new Date(), TZ, TIME_FMT);

/* ---------- 顏色/尺寸工具 ---------- */
function mapSizeLevel_(n){ return ({1:'micro',2:'kilo',3:'mega'})[n] || 'kilo'; }
function mapGap_(n){ return ({1:'sm',2:'md',3:'lg'})[n] || 'md'; }
function mapFont_(n){ return ({1:'sm',2:'md',3:'lg'})[n] || 'md'; }
function hexToRgb_(hex){ const m=/^#?([a-fA-F0-9]{6})$/.exec((hex||'').trim()); const n=m?parseInt(m[1],16):0xE4E4E4; return {r:(n>>16)&255,g:(n>>8)&255,b:n&255}; }
function blendHex_(fgHex,bgHex,alpha){ const f=hexToRgb_(fgHex), b=hexToRgb_(bgHex); const r=Math.round(f.r*alpha+b.r*(1-alpha)), g=Math.round(f.g*alpha+b.g*(1-alpha)), bl=Math.round(f.b*alpha+b.b*(1-alpha)); return '#'+[r,g,bl].map(v=>v.toString(16).padStart(2,'0')).join(''); }

/* ---------- Flex 建構 ---------- */
function buildLinkChip_(uri, label){
  const w = Math.max(0, Math.min(100, Number(LINK_WIDTH_PERCENT)||0));
  const side = Math.max(0, Math.floor((100 - w)/2));
  const leftFlex  = side;
  const midFlex   = Math.max(1, w);
  const rightFlex = Math.max(0, 100 - leftFlex - midFlex);

  return {
    type:'box', layout:'horizontal',
    contents:[
      { type:'filler', flex:leftFlex },
      {
        type:'box', layout:'vertical', flex:midFlex,
        backgroundColor:FLEX_COLORS.linkBg,
        cornerRadius:String(LINK_CORNER_PX)+'px',
        borderColor:FLEX_COLORS.accent, borderWidth:String(LINK_BORDER_PX)+'px',
        paddingTop:String(LINK_PAD_V_PX)+'px', paddingBottom:String(LINK_PAD_V_PX)+'px',
        paddingStart:String(LINK_PAD_H_PX)+'px', paddingEnd:String(LINK_PAD_H_PX)+'px',
        action:{ type:'uri', uri:String(uri||LIFF_URL) },
        contents:[{
          type:'text', text:String(label||'🛎️ 賜予最完美的旋律'), size:mapFont_(LINK_FONT_LEVEL),
          weight:'bold', color:FLEX_COLORS.accent, align:'center'
        }]
      },
      { type:'filler', flex:rightFlex }
    ]
  };
}

/* Chip 按鈕（postback 版） */
function buildChoiceChip_(label, data){
  return {
    type:'box', layout:'vertical', flex:1,
    backgroundColor:FLEX_COLORS.linkBg,
    cornerRadius:String(LINK_CORNER_PX)+'px',
    borderColor:FLEX_COLORS.accent, borderWidth:String(LINK_BORDER_PX)+'px',
    paddingTop:String(LINK_PAD_V_PX)+'px', paddingBottom:String(LINK_PAD_V_PX)+'px',
    paddingStart:String(LINK_PAD_H_PX)+'px', paddingEnd:String(LINK_PAD_H_PX)+'px',
    action:{ type:'postback', data:data, displayText:label },
    contents:[{ type:'text', text:label, size:mapFont_(LINK_FONT_LEVEL), weight:'bold', color:FLEX_COLORS.accent, align:'center' }]
  };
}

function buildThemedTextCard_(lines, theme){
  const bubbleSize = mapSizeLevel_(FLEX_SIZE_LEVEL);
  const gapToken   = mapGap_(GAP_LEVEL);
  const padAll     = '15px';
  const sepColor   = blendHex_(theme.text, theme.body, 0.5);

  const bodyContents = [
    { type:'text', text:'🤵🏻新人👰🏻‍♀️', weight:'bold', size:'lg', color:theme.title, align:'center', wrap:true },
    { type:'separator', color:sepColor, margin:'md' },
    ...lines.map((t,i)=>({
      type:'text', text:t, size:'md', weight:'bold', color:theme.text, align:'center', wrap:true,
      margin: i===0 ? 'md' : gapToken
    }))
  ];

  return { type:'flex', altText:'通知', contents:{
    type:'bubble', size:bubbleSize,
    styles:{ body:{backgroundColor:theme.body}, footer:{backgroundColor:theme.footer} },
    body:{ type:'box', layout:'vertical', paddingAll:padAll, spacing:gapToken, contents:bodyContents }
  }};
}

/* 入口/狀態卡 */
function buildCard_Entrance_(){ 
  return { type:'flex', altText:'🛎️ 賜予最完美的旋律', contents:{
    type:'bubble', size:mapSizeLevel_(FLEX_SIZE_LEVEL),
    styles:{ body:{backgroundColor:FLEX_COLORS.body}, footer:{backgroundColor:FLEX_COLORS.footer} },
    body:{ type:'box', layout:'vertical', paddingAll:'15px', spacing:mapGap_(GAP_LEVEL), contents:[
      { type:'text', text:'🤵🏻新人👰🏻‍♀️', weight:'bold', size:'lg', color:FLEX_COLORS.title, align:'center', wrap:true },
      { type:'separator', color:blendHex_(FLEX_COLORS.accent, FLEX_COLORS.body,0.5), margin:'md' },
      { type:'text', text:'賜予最完美的旋律', size:'md', weight:'bold', color:FLEX_COLORS.accent, align:'center', wrap:true, margin:'md' }
    ]},
    footer:{ type:'box', layout:'vertical', contents:[ buildLinkChip_(LIFF_URL, '🛎️ 賜予最完美的旋律') ], backgroundColor:FLEX_COLORS.footer }
  }}; 
}
function buildCard_Submitted_(){ return buildThemedTextCard_(['欸，兄弟／姊妹已填彈過了🫶🏻','想要更換音階請呼叫管理員🙏'], KEYWORD_THEME); }
function buildCard_Expired_(){ return buildThemedTextCard_(['欸，兄弟／姊妹已過截止日🕒','但還可點圖文選單玩玩呢👣'], KEYWORD_THEME); }
function buildCard_Reminder_(){ return buildThemedTextCard_(['📍提醒📍','因後台資料過於龐大','回覆會有點略慢出來','再麻煩親友們多擔待'], KEYWORD_THEME); }

/* Flex 二選一卡：你/妳是…我的？（chip 風格＋統一配色） */
function buildCard_RoleSelect_(){
  const bubbleSize = mapSizeLevel_(FLEX_SIZE_LEVEL);
  const gapToken   = mapGap_(GAP_LEVEL);
  const padAll     = '15px';
  const sepColor   = blendHex_(KEYWORD_THEME.text, KEYWORD_THEME.body, 0.5);

  return {
    type: 'flex',
    altText: '你/妳是…我的？',
    contents: {
      type: 'bubble',
      size: bubbleSize,
      styles: { body:{backgroundColor:KEYWORD_THEME.body}, footer:{backgroundColor:KEYWORD_THEME.footer} },
      body: {
        type: 'box', layout: 'vertical', paddingAll: padAll, spacing: gapToken,
        contents: [
          { type:'text', text:'🤵🏻新人👰🏻‍♀️', weight:'bold', size:'lg', color:KEYWORD_THEME.title, align:'center', wrap:true },
          { type:'separator', color:sepColor, margin:'md' },
          { type:'text', text:'你/妳是…我的？', size:'md', weight:'bold', color:KEYWORD_THEME.text, align:'center', wrap:true, margin:'md' }
        ]
      },
      footer: {
        type: 'box', layout: 'horizontal', spacing: 'md', backgroundColor: KEYWORD_THEME.footer,
        contents: [
          buildChoiceChip_('🤵🏻親友','role=male'),
          buildChoiceChip_('👰🏻‍♀️親友','role=female')
        ]
      }
    }
  };
}

/* ---------- Reply ---------- */
function replyFlex_(token, replyToken, flexMsg){
  const url='https://api.line.me/v2/bot/message/reply';
  const payload={ replyToken, messages:[ flexMsg ] };
  const opt={ method:'post', contentType:'application/json', headers:{Authorization:'Bearer '+token}, payload:JSON.stringify(payload), muteHttpExceptions:true };
  try{ UrlFetchApp.fetch(url,opt); }catch(_){}
}
function replyAudio_(token, replyToken, audioUrl, durationMs){
  const url='https://api.line.me/v2/bot/message/reply';
  const payload={ replyToken, messages:[{ type:'audio', originalContentUrl:String(audioUrl), duration:Number(durationMs)||1000 }] };
  const opt={ method:'post', contentType:'application/json', headers:{Authorization:'Bearer '+token}, payload:JSON.stringify(payload), muteHttpExceptions:true };
  try{ UrlFetchApp.fetch(url,opt); }catch(_){}
}
function replyMulti_(token, replyToken, messages){
  const url='https://api.line.me/v2/bot/message/reply';
  const payload={ replyToken, messages };
  const opt={ method:'post', contentType:'application/json', headers:{Authorization:'Bearer '+token}, payload:JSON.stringify(payload), muteHttpExceptions:true };
  try{ UrlFetchApp.fetch(url,opt); }catch(_){}
}

/* ---------- LINE Profile 取得（用於永久保留頭貼/暱稱） ---------- */
function fetchUserProfile_(channelToken, userId){
  if(!channelToken || !userId) return { displayName:'', pictureUrl:'' };
  const url = 'https://api.line.me/v2/bot/profile/' + encodeURIComponent(userId);
  const opt = { method:'get', headers:{ Authorization:'Bearer '+channelToken }, muteHttpExceptions:true };
  try{
    const r = UrlFetchApp.fetch(url,opt);
    if(r.getResponseCode()===200){
      const j = JSON.parse(r.getContentText()||'{}');
      return {
        displayName: String(j.displayName||''),
        pictureUrl : String(j.pictureUrl||'')
      };
    }
  }catch(_){}
  return { displayName:'', pictureUrl:'' };
}

/* ---------- Spreadsheet helpers ---------- */
function openMain_(){ return SpreadsheetApp.openById(SPREADSHEET_ID_MAIN); }
function openPublic_(){ return SpreadsheetApp.openById(SPREADSHEET_ID_PUBLIC); }

function ensureHeaderAtRow1_(sh, expectedHeader){
  const last=sh.getLastRow();
  if(last===0){ sh.getRange(1,1,1,expectedHeader.length).setValues([expectedHeader]); return; }
  const vals=sh.getRange(1,1,1,expectedHeader.length).getValues()[0];
  const same=expectedHeader.every((h,i)=>String(vals[i]||'').toLowerCase()===String(h).toLowerCase());
  if(!same){ sh.getRange(1,1,1,expectedHeader.length).setValues([expectedHeader]); }
}
function ensureLogs_(ss){
  let sh=ss.getSheetByName(SHEET_LOGS); if(!sh) sh=ss.insertSheet(SHEET_LOGS);
  /* >>> 表頭依你指定的新順序 <<< */
  const header = ['time','lineId','pictureUrl','這是親友(男方或女方)','displayName','instruments','notes','message'];
  ensureHeaderAtRow1_(sh, header);
  return sh;
}

/* ---------- logs 操作（依新欄位順序） ---------- */
function findLogRowByLineId_(sh, lineId){
  const last=sh.getLastRow(); if(last<=HEADER_ROWS) return -1;
  const vals=sh.getRange(HEADER_ROWS+1,2,last-HEADER_ROWS,1).getValues(); // B 欄 lineId
  for(let i=0;i<vals.length;i++){ if(String(vals[i][0]||'')===String(lineId)) return i+HEADER_ROWS+1; }
  return -1;
}
/* 僅在提供非空值時才覆蓋，永久保留歷史；新順序：A=time, B=lineId, C=pictureUrl, D=role, E=displayName, F=instruments, G=notes, H=message */
function bindLineIdEnsureRow_(ss, lineId, displayName, pictureUrl){
  const sh = ensureLogs_(ss);
  const r = findLogRowByLineId_(sh, lineId);
  if(r === -1){
    sh.appendRow([ nowStr(), lineId, String(pictureUrl||''), '', String(displayName||''), '', '', '' ]);
  }else{
    const row = sh.getRange(r, 1, 1, 8).getValues()[0];
    row[0] = nowStr();
    row[1] = lineId;
    /* 只有在傳入非空時，才覆蓋既有值，避免退出/回來後被清空 */
    row[2] = String(pictureUrl||'')  ? String(pictureUrl)  : String(row[2]||''); // pictureUrl → C
    // row[3] (=role) 不在這裡覆蓋，交由 setRole_ 控制
    row[4] = String(displayName||'') ? String(displayName) : String(row[4]||''); // displayName → E
    sh.getRange(r, 1, 1, 8).setValues([row]);
  }
}
function alreadySubmitted_(sh,lineId){
  const r=findLogRowByLineId_(sh,lineId); if(r===-1) return false;
  const e=String(sh.getRange(r,6).getValue()||'').trim(); // F=instruments
  const f=String(sh.getRange(r,7).getValue()||'').trim(); // G=notes
  return !!(e||f);
}
function getRole_(sh,lineId){
  const r=findLogRowByLineId_(sh,lineId); if(r===-1) return '';
  return String(sh.getRange(r,4).getValue()||'').trim(); // D=role
}
function setRole_(sh,lineId,role){
  const r=findLogRowByLineId_(sh,lineId); if(r===-1) return;
  sh.getRange(r,4).setValue(String(role||'')); // D=role
}
function isFirstInteraction_(sh, lineId){
  const r = findLogRowByLineId_(sh, lineId);
  if(r === -1) return true;
  const role = String(sh.getRange(r,4).getValue()||'').trim(); // D
  const e=String(sh.getRange(r,6).getValue()||'').trim();      // F
  const f=String(sh.getRange(r,7).getValue()||'').trim();      // G
  return !role && !e && !f;
}

/* ---------- 截止判斷 ---------- */
function getGlobalDeadline_(){
  // 轉為台北時區當日 23:59:59
  const d = new Date(GLOBAL_DEADLINE_ISO+'T23:59:59+08:00');
  return d;
}
function isExpired_(){
  return new Date() > getGlobalDeadline_();
}

/* ---------- HTTP 入口 ---------- */
function doGet(e){
  const p=e?.parameter||{}; const action=String(p.action||'').toLowerCase();
  if(action==='ping') return T('ok');
  if(action==='config') return J({ok:true});
  return T('ok');
}
function doPost(e){
  let body={}; try{ body=JSON.parse(e?.postData?.contents||'{}'); }catch(_){ body={}; }
  if(body && Array.isArray(body.events)) return handleLineWebhook_(body);
  return handleLiffSubmit_(body);
}

/* ---------- 狀態判斷（LINE 端先擋） ---------- */
function respondByState_(channelToken, replyToken, shLogs, lineId){
  if(!channelToken) return;
  const submitted = alreadySubmitted_(shLogs, lineId);
  const expired   = isExpired_();

  if(!submitted && !expired){
    replyFlex_(channelToken, replyToken, buildCard_Entrance_());
  }else if(submitted){
    replyFlex_(channelToken, replyToken, buildCard_Submitted_());
  }else if(expired){
    replyFlex_(channelToken, replyToken, buildCard_Expired_());
  }
}

/* ---------- Webhook ---------- */
function handleLineWebhook_(body){
  const events=body.events||[];
  const ssM=openMain_(); const ssP=openPublic_();
  const shM=ensureLogs_(ssM);
  const shP=ensureLogs_(ssP);
  const channelToken=(PropertiesService.getScriptProperties().getProperty('CHANNEL_TOKEN')||'').trim();

  events.forEach(ev=>{
    try{
      const userId = ev.source?.userId || '';
      if(!userId) return;

      /* follow：第一時間就抓一次 profile，永久保留；回歡迎音檔（維持原樣） */
      if(ev.type==='follow'){
        if(channelToken){
          const prof = fetchUserProfile_(channelToken, userId);
          bindLineIdEnsureRow_(ssM, userId, prof.displayName, prof.pictureUrl);
          bindLineIdEnsureRow_(ssP, userId, prof.displayName, prof.pictureUrl);
          replyAudio_(channelToken, ev.replyToken, WELCOME_AUDIO_URL, WELCOME_AUDIO_MS);
        }
        return;
      }

      /* postback：角色綁定，完成後也要按狀態判斷阻擋（不是一律入口卡）
         ★★★ 同步寫入主本與副本的 D 欄（這是親友） ★★★ */
      if(ev.type==='postback'){
        const data = String(ev.postback?.data||'');
        if(/role=male/.test(data)){        setRole_(shM, userId, ROLE_MALE_FRIEND);   setRole_(shP, userId, ROLE_MALE_FRIEND); }
        else if(/role=female/.test(data)){ setRole_(shM, userId, ROLE_FEMALE_FRIEND); setRole_(shP, userId, ROLE_FEMALE_FRIEND); }

        if(channelToken) respondByState_(channelToken, ev.replyToken, shM, userId);
        return;
      }

      /* message（文字）：入口關鍵字才回卡片；同時補抓 profile（若缺） */
      if(ev.type==='message' && ev.message?.type==='text'){
        const rawInput=String(ev.message.text||'').trim();
        const isPortal = KWS_PORTAL.some(k=>rawInput.includes(k));

        // 建立 / 補齊使用者列
        if(channelToken){
          const prof = fetchUserProfile_(channelToken, userId);
          bindLineIdEnsureRow_(ssM, userId, prof.displayName, prof.pictureUrl);
          bindLineIdEnsureRow_(ssP, userId, prof.displayName, prof.pictureUrl);
        }else{
          bindLineIdEnsureRow_(ssM, userId, '', '');
          bindLineIdEnsureRow_(ssP, userId, '', '');
        }

        // 指令「開始」維持原邏輯
        if(rawInput==='開始'){
          if(channelToken) replyMulti_(channelToken, ev.replyToken, [ buildCard_Reminder_(), buildCard_Entrance_() ]);
          return;
        }

        // 未綁定且首次互動 / 入口關鍵字 → 先做身分二選一
        const isBound  = !!getRole_(shM,userId);
        if(!isBound && (isPortal || isFirstInteraction_(shM, userId))){
          if(channelToken) replyFlex_(channelToken, ev.replyToken, buildCard_RoleSelect_());
          return;
        }

        // 入口關鍵字 → 依狀態阻擋（已填 or 過期），否則給入口卡
        if(isPortal){
          respondByState_(channelToken, ev.replyToken, shM, userId);
          return;
        }
      }
    }catch(_){}
  });
  return J({status:'ok'});
}

/* ---------- LIFF 送單（與前端 payload 對齊；雙重保護 duplicate/deadline） ----------
   ★★★ 依新欄位順序寫入：A=time, B=lineId, C=pictureUrl, D=role, E=displayName, F=instruments, G=notes, H=message ★★★ */
function handleLiffSubmit_(body){
  const ssM=openMain_(); const ssP=openPublic_();
  const shM=ensureLogs_(ssM); const shP=ensureLogs_(ssP);

  const lineId=String(body.lineId||'').trim();
  const displayName=String(body.displayName||'').trim();
  const pictureUrl=String(body.pictureUrl||'').trim();
  const instruments=String(body.instrumentsCSV||'').trim();
  const notes=String(body.notesCSV||'').trim();
  const msg=String(body.extraMessage||'').trim();
  if(!lineId) return J({ok:false, error:'missing_line_id'});

  // 先確保 row 存在並補齊頭貼/暱稱（僅非空覆蓋）
  bindLineIdEnsureRow_(ssM, lineId, displayName, pictureUrl);
  bindLineIdEnsureRow_(ssP, lineId, displayName, pictureUrl);

  // 截止保護
  if(isExpired_()) return J({ok:false, error:'deadline_passed'});

  // 重覆保護
  if(alreadySubmitted_(shM, lineId)) return J({ok:false, error:'duplicate'});

  // 取得角色（分別從主本/副本）
  const roleM = getRole_(shM, lineId);
  const roleP = getRole_(shP, lineId);

  // 正常寫入（同時寫主本/副本；新順序）
  const rM=findLogRowByLineId_(shM,lineId);
  if(rM===-1){
    shM.appendRow([ nowStr(), lineId, pictureUrl, roleM, displayName, instruments, notes, msg ]);
  }else{
    shM.getRange(rM,1,1,8).setValues([[ nowStr(), lineId, pictureUrl, roleM, displayName, instruments, notes, msg ]]);
  }

  const rP=findLogRowByLineId_(shP,lineId);
  if(rP===-1){
    shP.appendRow([ nowStr(), lineId, pictureUrl, roleP, displayName, instruments, notes, msg ]);
  }else{
    shP.getRange(rP,1,1,8).setValues([[ nowStr(), lineId, pictureUrl, roleP, displayName, instruments, notes, msg ]]);
  }

  return J({ok:true});
}
