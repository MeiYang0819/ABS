<!doctype html>
<html lang="zh-Hant">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>送上祝福</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Patrick+Hand:wght@400&family=Sacramento:wght@400;700&display=swap" rel="stylesheet">

<style>
:root{
  --brand-bg:#c9daf8;
  --title:#A68A7C;  --ink:#0f172a; --accent:#A68A7C; --rim:#E4E4E4; --soft:#F5F1EC;
  --panel-grad-from:#b7d2f6; --panel-grad-to:#cfe1fb; --panel-bg-image:none;
  --paper-grad-from:rgba(255,242,204,.98); --paper-grad-to:rgba(255,242,204,.92);

  --panel-maxw:1320px;   /* 只加寬，不改色 */
  --card-maxw:1200px;

  --radius-xl:16px; --radius-md:12px;
  --shadow-1:0 10px 26px rgba(0,0,0,.10);
  --shadow-2:0 2px 0 rgba(0,0,0,.15), 0 2px 8px rgba(0,0,0,.06);

  --content-pad:22px; --editor-zoom:1rem;
  --toolbar-gap:8px; --status-fz:14px; --h2-size:2.8rem;
  --stroke:rgba(0,0,0,.18); --glow:rgba(255,255,255,.65);

  --footer-gap:48px;
  --btn-w:220px; --btn-h:50px;

  --tile-w:220px; --tile-h:150px;

  --chip-w:140px; --chip-h:44px; --chip-gap:10px;

  /* 左側底部「修改/送出」列高度 */
  --left-actions-h:48px;
}

/* 基本視覺（保留） */
*{box-sizing:border-box;}
html,body{
  height:100%; margin:0; overflow:hidden;
  color:var(--ink); background:var(--brand-bg);
  font-family:"Patrick Hand","Noto Sans TC",system-ui,-apple-system,sans-serif;
  -webkit-text-stroke:.35px var(--stroke); text-shadow:0 1px 0 var(--glow);
}

.bg-photo{ position:fixed; inset:0; z-index:0; width:100%; height:100%;
  object-fit:cover; opacity:.35; pointer-events:none; filter:brightness(.6) saturate(.9); }

.panel{
  position:relative; z-index:1; max-width:var(--panel-maxw);
  height:calc(100vh - (70px + var(--footer-gap))); margin:26px auto;
  background:linear-gradient(135deg, var(--panel-grad-from), var(--panel-grad-to)), var(--panel-bg-image);
  background-size:auto, cover; background-position:left top, center;
  border:1px solid var(--rim); border-radius:var(--radius-xl);
  box-shadow:var(--shadow-1); display:flex; flex-direction:column; overflow:hidden;
}

/* 標題列（與你保持一致） */
.titlebar{ background:transparent; padding:16px 16px 6px; }
h2{
  margin:0 0 10px; text-align:center; font-family:"Sacramento",cursive;
  font-weight:700; font-size:var(--h2-size); letter-spacing:1px; color:var(--title);
  -webkit-text-stroke:.6px rgba(0,0,0,.12); text-shadow:0 3px 4px rgba(255,255,255,.75);
}

/* 頂部工具區（保留） */
.bar{ padding:6px 22px 8px; }
.bar-inner{ max-width:var(--card-maxw); margin:0 auto; display:flex; align-items:center; gap:12px; }
.toolbar{ display:flex; gap:var(--toolbar-gap); filter:drop-shadow(0 2px 0 rgba(0,0,0,.08)); }
.tool-btn,.tool-select{
  min-width:64px; height:36px; padding:0 12px; background:#fff; border:1px solid var(--rim); border-radius:var(--radius-md);
  font-weight:700; display:flex; align-items:center; justify-content:center; gap:6px; box-shadow:var(--shadow-2);
}
.tool-select{ min-width:auto; padding:0 10px; }
.tool-btn:active{ transform:translateY(1px) scale(.99); }

.rolebar{ display:flex; gap:var(--toolbar-gap); }
.role-btn{ min-width:64px; height:36px; padding:0 12px; background:#fff; border:1px solid var(--rim); border-radius:var(--radius-md); font-weight:700; display:flex; align-items:center; justify-content:center; box-shadow:var(--shadow-2); }
.role-btn.active{ outline:2px solid rgba(0,0,0,.15); }

#status{
  flex:1 1 auto; min-width:240px; background:var(--soft); border:1px solid #E4E4E4;
  border-radius:12px; padding:10px; font-size:var(--status-fz); white-space:pre-wrap;
  text-align:center; color:var(--accent)!important; font-weight:700;
  -webkit-text-stroke:.35px rgba(0,0,0,.10); text-shadow:0 1px 0 rgba(255,255,255,.85),0 3px 6px rgba(0,0,0,.04);
}

/* 內容舞台（左右 1/3：2/3） */
.stage{ flex:1 1 auto; padding:14px 22px 0; display:flex; justify-content:center; align-items:flex-start; overflow:hidden; }
.card{
  position:relative; width:100%; max-width:var(--card-maxw);
  background:linear-gradient(180deg, var(--paper-grad-from), var(--paper-grad-to));
  border:1px solid rgba(0,0,0,.05); border-radius:var(--radius-xl); box-shadow:0 10px 26px rgba(0,0,0,.08);
  padding:var(--content-pad); height:100%; overflow:auto;
  display:grid; grid-template-columns: 1fr 2fr; gap:14px;
}

/* 左側（固定 chip + 編輯器 + 新增的按鈕列） */
.left-content{ position:relative; min-height:280px; }

/* 新人/簽名 chip（原本樣式保持） */
.chip{
  position:absolute; width:var(--chip-w); height:var(--chip-h);
  background:#fff; border:1px solid var(--rim); border-radius:10px;
  box-shadow:0 2px 8px rgba(0,0,0,.06);
  display:flex; align-items:center; justify-content:center; gap:8px; padding:6px 10px; user-select:none;
}
#chipBride{ top:var(--chip-gap); left:var(--chip-gap); }
#chipSign{  right:var(--chip-gap); bottom:var(--chip-gap); cursor:pointer; }
#chipSign:not(.has-img){ opacity:.22; }
#chipSign .hint{ font-weight:900; }
#signThumb{ display:none; width:120px; height:50px; object-fit:contain; background:linear-gradient(180deg, var(--paper-grad-from), var(--paper-grad-to)); border:1px solid var(--rim); border-radius:8px; }
#chipSign.has-img #signThumb{ display:block; }
#chipSign.has-img .hint{ display:none; }

/* 編輯器：上下為 chip / 底部為按鈕列預留空間 */
.editor{
  position:absolute;
  top:calc(var(--chip-gap) + var(--chip-h) + 10px);
  right:var(--chip-gap);
  bottom:calc(var(--chip-gap) + var(--chip-h) + 10px + var(--left-actions-h) + 8px);
  left:var(--chip-gap);
  overflow:auto; line-height:1.8; outline:none; background:transparent; border-radius:12px; padding:12px;
  font-size:var(--editor-zoom); background-image:none; border:1px dashed rgba(0,0,0,.12);
}
.editor[data-empty]{ opacity:.22; }
.editor.locked{ background:transparent; pointer-events:none; opacity:.85; }

/* 新增：左側底部「修改／送出」按鈕列（等距兩顆） */
.left-actions{
  position:absolute; left:var(--chip-gap); right:calc(var(--chip-gap) + var(--chip-w) + 8px); /* 右側留給簽名 chip */
  bottom:var(--chip-gap); height:var(--left-actions-h);
  display:flex; align-items:center; justify-content:space-between; gap:10px;
}
.left-actions button{
  flex:1 1 0; height:100%; background:#fff; border:1px solid var(--rim); border-radius:10px; font-weight:800;
  box-shadow:var(--shadow-2); cursor:pointer;
}
.left-actions button:active{ transform:translateY(1px) scale(.99); }

/* 右側牆（木牌 + 紅繩；其餘不變） */
.wall{
  min-height:280px; display:grid; grid-template-columns: repeat(auto-fill, minmax(var(--tile-w), 1fr));
  gap:12px; align-content:start; padding:6px 4px 10px;
}
.tile{
  width:100%; height:var(--tile-h); position:relative;
  background:
    linear-gradient(180deg,#f2e4d5,#e9d7c5),
    repeating-linear-gradient(12deg, rgba(0,0,0,.035) 0, rgba(0,0,0,.035) 6px, rgba(255,255,255,.04) 6px, rgba(255,255,255,.04) 12px );
  border:1px solid #d8c8b6; border-radius:14px;
  box-shadow:0 6px 14px rgba(0,0,0,.08);
  padding:12px 14px 14px; cursor:pointer; overflow:hidden;
  display:flex; flex-direction:column; justify-content:flex-start; gap:6px;
}
.tile:before{ content:""; position:absolute; top:-12px; left:50%; transform:translateX(-50%); width:8px; height:26px; background:linear-gradient(#b10,#d22); border-radius:4px; }
.tile:after{ content:""; position:absolute; top:2px; left:50%; transform:translateX(-50%); width:20px; height:10px; background:linear-gradient(#b10,#d22); border-radius:0 0 10px 10px; box-shadow:0 2px 0 rgba(0,0,0,.08); }
.tile-header{ display:flex; align-items:center; justify-content:center; gap:8px; font-weight:800; text-align:center; margin-top:6px; }
.tile-meta{ font-size:12px; opacity:.8; text-align:center; }
.tile-snippet{ font-size:14px; line-height:1.5; display:-webkit-box; -webkit-line-clamp:3; -webkit-box-orient:vertical; overflow:hidden; text-align:center; }
.tile-sign{ position:absolute; right:8px; bottom:8px; width:70px; height:34px; border:1px solid var(--rim); border-radius:6px; background:#fff; display:flex; align-items:center; justify-content:center; overflow:hidden; }
.tile-sign img{ width:100%; height:100%; object-fit:contain; }

.overlay{ position:fixed; inset:0; z-index:9999; display:none; align-items:center; justify-content:center; background:rgba(17,24,39,.35); backdrop-filter:blur(3px); }
.overlay.show{ display:flex; }
.dialog{ width:min(92vw,680px); max-height:82vh; background:var(--soft); border:1px solid var(--rim); border-radius:14px; padding:16px; box-shadow:0 18px 44px rgba(0,0,0,.18); overflow:auto; }
.dialog h3{ margin:0 0 10px; font-size:18px; color:#6b5e52; text-align:center; -webkit-text-stroke:0; text-shadow:none; }
.view-meta{ text-align:center; font-size:12px; opacity:.75; margin-bottom:8px; }
.view-content{ background:#fff; border:1px solid #ddd; border-radius:12px; padding:12px; line-height:1.8; }
.view-actions{ display:flex; gap:10px; justify-content:center; margin-top:12px; }
.view-actions button{ min-width:120px; height:38px; border-radius:10px; border:1px solid var(--rim); background:#fff; cursor:pointer; font-weight:700; }

.footer-actions{ flex:0 0 auto; display:flex; justify-content:center; align-items:center; padding:14px 0 16px; }
.primary{ min-width:var(--btn-w); height:var(--btn-h); padding:0 20px; background:#fff; border:1px solid var(--rim); border-radius:var(--radius-md); font-weight:700; cursor:pointer; box-shadow:var(--shadow-2); }
.primary:active{ transform:translateY(1px) scale(.99); }

footer{ position:fixed; left:0; right:0; bottom:var(--footer-gap); text-align:center; color:#6b5e52; font-size:12px; opacity:.9; pointer-events:none; z-index:5; }

#sigOverlay .dialog{ width:min(92vw,520px); }
#pad{ width:100%; height:260px; background:#fff; border:1px solid #ddd; border-radius:12px; touch-action:none; }
.dlg-actions{ display:flex; gap:10px; justify-content:center; margin-top:12px; }
.dlg-actions button{ width:120px; height:38px; border-radius:10px; border:1px solid var(--rim); background:#fff; cursor:pointer; font-weight:700; }
</style>

<body>
  <img class="bg-photo" src="./assets/wishing.png" alt="">

  <div class="panel">
    <div class="titlebar">
      <h2>送上祝福</h2>

      <div class="bar">
        <div class="bar-inner" id="barInner">
          <div class="rolebar">
            <button type="button" class="role-btn active" id="roleAll">全部</button>
            <button type="button" class="role-btn" id="roleMale">男方</button>
            <button type="button" class="role-btn" id="roleFemale">女方</button>
          </div>

          <p id="status">已就緒</p>

          <div class="toolbar" role="toolbar" aria-label="文字工具">
            <button class="tool-btn" id="btnBold"      type="button" title="粗體">粗體</button>
            <button class="tool-btn" id="btnItalic"    type="button" title="斜體">斜體</button>
            <button class="tool-btn" id="btnUnderline" type="button" title="底線">底線</button>
            <select id="colorPick" class="tool-select" title="字體顏色">
              <option value="" selected>顏色</option>
              <option value="#0f172a">墨色</option>
              <option value="#a21caf">紫</option>
              <option value="#dc2626">紅</option>
              <option value="#2563eb">藍</option>
              <option value="#059669">綠</option>
              <option value="#d97706">橘</option>
              <option value="#6b7280">灰</option>
            </select>
            <button class="tool-btn" id="btnBigger"    type="button" title="放大">放大</button>
            <button class="tool-btn" id="btnSmaller"   type="button" title="縮小">縮小</button>
          </div>
        </div>
      </div>
    </div>

    <div class="stage">
      <div class="card" id="card">
        <!-- 左 1/3 -->
        <section class="left-content">
          <div class="chip" id="chipBride" title="新人"><span id="brideLabel">新人：—</span></div>
          <div class="chip" id="chipSign" title="點此簽名">
            <span class="hint">點我簽名</span>
            <img id="signThumb" alt="signature preview" />
          </div>

          <div class="editor" id="editor" contenteditable="true" aria-label="祝福內容">
            在此寫下你對新人的祝福…（可選字後按上方的粗體／斜體／底線／顏色／放大／縮小）💝
          </div>

          <!-- 新增：底部操作列（修改 / 送出），簽名 chip 獨立在右下 -->
          <div class="left-actions">
            <button id="btnEdit"  type="button">修改</button>
            <button id="btnSend"  type="button">送出</button>
          </div>
        </section>

        <!-- 右 2/3 -->
        <section>
          <div class="wall" id="wall"></div>
        </section>
      </div>
    </div>

    <div class="footer-actions">
      <button id="btnSubmit" class="primary" type="button">送出祝福</button>
    </div>
  </div>

  <footer>© Copyright 2025 MY‘s System</footer>

  <!-- 放大檢視（保留） -->
  <div id="viewOverlay" class="overlay" role="dialog" aria-modal="true" aria-labelledby="viewTitle">
    <div class="dialog">
      <h3 id="viewTitle">祝福內容</h3>
      <div class="view-meta" id="viewMeta"></div>
      <div id="viewContent" class="view-content"></div>
      <div class="view-actions">
        <button id="viewClose" type="button">關閉</button>
        <button id="viewEdit"  type="button" style="display:none;">編輯（僅限本人）</button>
        <button id="viewSave"  type="button" style="display:none;">儲存</button>
      </div>
    </div>
  </div>

  <!-- 簽名 Modal（保留） -->
  <div id="sigOverlay" class="overlay" role="dialog" aria-modal="true" aria-labelledby="sigTitle">
    <div class="dialog">
      <h3 id="sigTitle">請於下方簽名</h3>
      <canvas id="pad"></canvas>
      <div class="dlg-actions">
        <button id="sigClear"  type="button">清除</button>
        <button id="sigCancel" type="button">取消</button>
        <button id="sigOK"     type="button">確定</button>
      </div>
    </div>
  </div>

<script>
/* ====== 基本設定（沿用） ====== */
const LIFF_ID='2008149060-m5pDXW6a';
const WEBHOOK='https://script.google.com/macros/s/AKfycbx4wqm5tIWGvXRqIrjKPEFTYkaDf7cHLrYQTrJZ9ETQ8Fgikkv5QMny0TG8xW6aW_l0/exec';
const TIMEOUT_MS=20000;

/* 狀態列 */
function setStatus(m){
  const el=document.getElementById('status');
  el.textContent=m; el.classList.remove('ok','busy','err');
  if(/成功|已載入|就緒/.test(m)) el.classList.add('ok');
  else if(/送出中|等待|處理/.test(m)) el.classList.add('busy');
  else if(/失敗|逾時|無法|錯誤/.test(m)) el.classList.add('err');
}

/* LIFF */
let lineId='',displayName='',pictureUrl='';
async function initLIFF(){
  if(typeof liff==='undefined'){ setStatus('（未載入 LIFF SDK，可先測樣式）'); return; }
  try{
    setStatus('初始化 LIFF…');
    await liff.init({ liffId: LIFF_ID, withLoginOnExternalBrowser:true });
    if(!liff.isLoggedIn()){ liff.login({ scope:['openid','profile'] }); return; }
    if(liff.ready) await liff.ready;
    let prof=null, idt=null;
    try{ prof=await liff.getProfile(); }catch(_){}
    try{ idt=liff.getDecodedIDToken(); }catch(_){}
    lineId=(prof&&prof.userId)||(idt&&idt.sub)||'';
    displayName=(prof&&prof.displayName)||(idt&&(idt.name||idt.nickname))||'';
    pictureUrl=(prof&&prof.pictureUrl)||'';
    try{
      const r=await fetch(WEBHOOK+'?action=couple',{method:'GET',cache:'no-store'});
      if(r.ok){ const j=await r.json().catch(()=>null); if(j&&j.ok&&j.name){ document.getElementById('brideLabel').textContent='新人：'+String(j.name||'—'); } }
    }catch(_){}
    await refreshWall(); setStatus('已就緒');
  }catch(e){ setStatus('LIFF 初始化失敗：'+e.message); }
}

/* 工具列（保留） */
const editor=document.getElementById('editor');
function btnExec(cmd){ if(editor.hasAttribute('data-empty')||editor.classList.contains('locked')) return; document.execCommand(cmd,false,null); editor.focus(); }
document.getElementById('btnBold').addEventListener('click',()=>btnExec('bold'));
document.getElementById('btnItalic').addEventListener('click',()=>btnExec('italic'));
document.getElementById('btnUnderline').addEventListener('click',()=>btnExec('underline'));
document.getElementById('colorPick').addEventListener('change',e=>{
  const v=e.target.value; if(!editor.hasAttribute('data-empty') && !editor.classList.contains('locked') && v){ document.execCommand('foreColor',false,v); editor.focus(); }
  e.target.blur();
});
function wrapSelectionWithClass(cls){
  if(editor.hasAttribute('data-empty')||editor.classList.contains('locked')) return false;
  const sel=window.getSelection(); if(!sel.rangeCount) return false;
  const r=sel.getRangeAt(0); if(r.collapsed) return false;
  const span=document.createElement('span'); span.className=cls;
  try{ r.surroundContents(span);}catch(_){ const f=r.extractContents(); span.appendChild(f); r.insertNode(span); }
  const s2=window.getSelection(); s2.removeAllRanges(); const nr=document.createRange(); nr.setStartAfter(span); nr.collapse(true); s2.addRange(nr);
  editor.focus(); return true;
}
let globalScale=1;
function setGlobalScale(sc){ globalScale=Math.max(0.7,Math.min(1.7,sc)); editor.style.setProperty('--editor-zoom',globalScale+'rem'); }
function stepBigger(){ if(!wrapSelectionWithClass('fs-up-1')) setGlobalScale(globalScale+0.06); }
function stepSmaller(){ if(!wrapSelectionWithClass('fs-down-1')) setGlobalScale(globalScale-0.06); }
document.getElementById('btnBigger').addEventListener('click',stepBigger);
document.getElementById('btnSmaller').addEventListener('click',stepSmaller);

/* placeholder */
const PLACEHOLDER='在此寫下你對新人的祝福…（可選字後按上方的粗體／斜體／底線／顏色／放大／縮小）💝';
function showPlaceholder(){ editor.setAttribute('data-empty',''); editor.innerHTML=PLACEHOLDER; }
editor.addEventListener('focus',()=>{ if(editor.hasAttribute('data-empty')){ editor.innerHTML=''; editor.removeAttribute('data-empty'); }});
editor.addEventListener('blur',()=>{ if(!editor.textContent.trim()) showPlaceholder(); });

/* 簽名 chip */
const sigOverlay=document.getElementById('sigOverlay');
const pad=document.getElementById('pad'); const ctx=pad.getContext('2d');
let drawing=false,lastX=0,lastY=0,signatureDataURL='';
function fitCanvas(){ const dpr=Math.max(1,window.devicePixelRatio||1),w=pad.clientWidth,h=pad.clientHeight; pad.width=w*dpr; pad.height=h*dpr; ctx.setTransform(dpr,0,0,dpr,0,0); ctx.lineCap='round'; ctx.lineJoin='round'; ctx.lineWidth=3; ctx.strokeStyle='#111'; ctx.clearRect(0,0,w,h); }
function openSign(){ sigOverlay.classList.add('show'); setTimeout(fitCanvas,40); }
function closeSign(){ sigOverlay.classList.remove('show'); }
function pos(e){ const r=pad.getBoundingClientRect(); return {x:(e.touches?e.touches[0].clientX:e.clientX)-r.left, y:(e.touches?e.touches[0].clientY:e.clientY)-r.top}; }
function start(e){ drawing=true; const p=pos(e); lastX=p.x; lastY=p.y; e.preventDefault(); }
function move(e){ if(!drawing) return; const p=pos(e); ctx.beginPath(); ctx.moveTo(lastX,lastY); ctx.lineTo(p.x,p.y); ctx.stroke(); lastX=p.x; lastY=p.y; e.preventDefault(); }
function end(){ drawing=false; }
pad.addEventListener('mousedown',start); pad.addEventListener('mousemove',move); pad.addEventListener('mouseup',end); pad.addEventListener('mouseleave',end);
pad.addEventListener('touchstart',start,{passive:false}); pad.addEventListener('touchmove',move,{passive:false}); pad.addEventListener('touchend',end);
document.getElementById('chipSign').addEventListener('click',openSign);
document.getElementById('sigClear').addEventListener('click',fitCanvas);
document.getElementById('sigCancel').addEventListener('click',closeSign);
document.getElementById('sigOK').addEventListener('click',()=>{
  signatureDataURL=pad.toDataURL('image/png');
  const chip=document.getElementById('chipSign'); const img=document.getElementById('signThumb');
  img.src=signatureDataURL; chip.classList.add('has-img'); closeSign();
});

/* ====== 牆（含 Drive 圖片轉直連） ====== */
const wallEl=document.getElementById('wall');
let currentRole='all';
let myLastRow=null; // ★ 你本人最新一筆 row

async function fetchJSON(url, opt){
  const r=await fetch(url,opt); const ct=(r.headers.get('content-type')||'').toLowerCase();
  const t=await (ct.includes('application/json')? r.json(): r.text()); return t;
}
function escapeHTML(s){ return String(s||'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
function normalizeDriveUrl(u){
  if(!u) return ''; let m=/drive\.google\.com\/file\/d\/([a-zA-Z0-9_-]+)/.exec(u); if(m) return `https://drive.google.com/uc?export=view&id=${m[1]}`;
  m=/[?&]id=([a-zA-Z0-9_-]{10,})/.exec(u); if(m) return `https://drive.google.com/uc?export=view&id=${m[1]}`; return u;
}
function tileTemplate(item){
  const date=item.time?String(item.time).slice(0,16):''; const snippet=(item.preview||'').trim()||'—';
  const sigURL=normalizeDriveUrl(item.signature||''); const signHTML=sigURL?`<img src="${sigURL}" alt="">`:''; 
  return `<div class="tile" data-row="${item.row||''}" data-owner="${item.lineId||''}">
    <div class="tile-header">${escapeHTML(item.displayName||'—')}</div>
    <div class="tile-meta">${escapeHTML(date)}</div>
    <div class="tile-snippet">${escapeHTML(snippet)}</div>
    <div class="tile-sign">${signHTML}</div>
  </div>`;
}
async function refreshWall(){
  try{
    const url=WEBHOOK+`?action=listblessings&role=${encodeURIComponent(currentRole)}`;
    const j=await fetchJSON(url,{method:'GET',cache:'no-store'});
    if(j && j.ok){
      const items=j.items||[];
      wallEl.innerHTML=items.map(tileTemplate).join('')||'';
      // ★ 找出你本人最新 row（最大 row）
      if(lineId){
        const mine=items.filter(it=>String(it.lineId||'')===String(lineId));
        myLastRow = mine.length ? Math.max(...mine.map(it=>Number(it.row||0))) : null;
      }
      bindTileClicks();
    }
  }catch(e){}
}
function bindTileClicks(){ wallEl.querySelectorAll('.tile').forEach(tile=>{ tile.addEventListener('click', ()=>openView(tile)); }); }

/* 詳細視窗（保留原樣） */
const viewOverlay=document.getElementById('viewOverlay');
const viewMeta=document.getElementById('viewMeta');
const viewContent=document.getElementById('viewContent');
const btnViewClose=document.getElementById('viewClose');
const btnViewEdit=document.getElementById('viewEdit');
const btnViewSave=document.getElementById('viewSave');
let currentViewRow=null,currentViewOwner='';
btnViewClose.addEventListener('click',()=>{ viewOverlay.classList.remove('show'); currentViewRow=null; });
btnViewEdit.addEventListener('click',()=>{ viewContent.setAttribute('contenteditable','true'); btnViewSave.style.display='inline-flex'; btnViewEdit.style.display='none'; });
btnViewSave.addEventListener('click',async ()=>{
  if(!currentViewRow) return;
  try{
    const payload={ action:'updateBlessing', row:Number(currentViewRow), lineId, contentHTML:viewContent.innerHTML.trim() };
    const r=await fetch(WEBHOOK,{ method:'POST', headers:{'Content-Type':'text/plain;charset=UTF-8'}, body:JSON.stringify(payload) });
    const j=await r.json().catch(()=>null);
    if(j&&j.ok){ setStatus('✅ 已儲存'); viewContent.removeAttribute('contenteditable'); btnViewSave.style.display='none'; await refreshWall(); }
    else if(j && j.error==='deadline_passed'){ setStatus('⛔ 已到截止日，無法編輯'); }
    else{ setStatus('❌ 無法儲存'); }
  }catch(e){ setStatus('❌ 儲存失敗：'+(e?.message||'')); }
});
async function openView(tileEl){
  const row=tileEl.getAttribute('data-row'); const owner=tileEl.getAttribute('data-owner')||'';
  currentViewRow=row; currentViewOwner=owner;
  try{
    const j=await fetchJSON(WEBHOOK+`?action=getBlessingDetail&id=${encodeURIComponent(row)}`,{method:'GET',cache:'no-store'});
    if(j&&j.ok&&j.item){
      const it=j.item; const date=it.time?String(it.time).slice(0,16):'';
      viewMeta.textContent=`${it.displayName||'—'} ｜ ${date}`; viewContent.innerHTML=it.contentHTML||'';
      if(lineId && owner===lineId){ btnViewEdit.style.display='inline-flex'; } else { btnViewEdit.style.display='none'; }
      btnViewSave.style.display='none'; viewOverlay.classList.add('show');
    }
  }catch(e){}
}

/* 角色鍵 */
function setRole(role){
  currentRole=role; document.querySelectorAll('.role-btn').forEach(b=>b.classList.remove('active'));
  if(role==='all') document.getElementById('roleAll').classList.add('active');
  if(role==='male') document.getElementById('roleMale').classList.add('active');
  if(role==='female') document.getElementById('roleFemale').classList.add('active');
  refreshWall();
}
document.getElementById('roleAll').addEventListener('click',()=>setRole('all'));
document.getElementById('roleMale').addEventListener('click',()=>setRole('male'));
document.getElementById('roleFemale').addEventListener('click',()=>setRole('female'));

/* ====== 新增：左側 修改／送出 ====== */
function lockEditor(){ editor.classList.add('locked'); editor.setAttribute('contenteditable','false'); }
function unlockEditor(){ editor.classList.remove('locked'); editor.setAttribute('contenteditable','true'); }

document.getElementById('btnEdit').addEventListener('click',()=>{ unlockEditor(); editor.focus(); });

async function sendOrUpdate(){
  if(editor.hasAttribute('data-empty') || !editor.textContent.trim()){ alert('請寫下祝福內容唷～'); return; }
  const text=editor.innerHTML.trim();

  try{
    const ping=await fetch(WEBHOOK+'?action=ping',{method:'GET',cache:'no-store'});
    const t=await ping.text().catch(()=> ''); if(String(t).trim().toLowerCase()!=='ok'){ setStatus('⚠️ 後端未回應正常'); return; }
  }catch(_){ setStatus('⚠️ 無法連到後端'); return; }

  setStatus('⏳ 送出中…');

  // 有舊單 → update；沒有 → create
  let payload = myLastRow
    ? { action:'updateBlessing', row:Number(myLastRow), lineId, contentHTML:text }
    : { action:'createBlessing', lineId, displayName, pictureUrl, contentHTML:text, signaturePNG:signatureDataURL||'', extra:{} };

  try{
    const r=await fetch(WEBHOOK,{ method:'POST', headers:{'Content-Type':'text/plain;charset=UTF-8'}, body:JSON.stringify(payload) });
    const j=await r.json().catch(()=>null);

    if(j && j.ok){
      setStatus(myLastRow ? '✅ 已更新並鎖定' : '✅ 已送出並鎖定');
      lockEditor(); // ★ 送出後鎖住，但內容與簽名預覽保留
      // 成功後刷新牆並更新 myLastRow
      await refreshWall();
    }else if(j && j.error==='deadline_passed'){
      setStatus('⛔ 已到截止日，無法送出/編輯'); lockEditor();
    }else{
      setStatus('❌ 送出失敗，請稍後再試');
    }
  }catch(e){ setStatus('❌ 送出失敗：'+(e?.message||'')); }
}
document.getElementById('btnSend').addEventListener('click',sendOrUpdate);

/* ====== 舊的「送出祝福」主按鈕：沿用，但行為等同上方 btnSend ====== */
document.getElementById('btnSubmit').addEventListener('click',sendOrUpdate);

/* 啟動 */
window.addEventListener('DOMContentLoaded', ()=>{
  setStatus('已就緒'); showPlaceholder();
  if(window.liff) initLIFF(); else refreshWall();
});
</script>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</body>
</html>
