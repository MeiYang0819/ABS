<!doctype html>
<html lang="zh-Hant">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>â¤ï¸åŒå¿ƒç¥ˆé¡˜â¤ï¸</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Patrick+Hand:wght@400&family=Sacramento:wght@400;700&display=swap" rel="stylesheet">

<style>
:root{
  --brand-bg:#c9daf8;
  --title:#A68A7C;  --ink:#0f172a; --accent:#A68A7C; --rim:#E4E4E4; --soft:#F5F1EC;
  --panel-grad-from:#b7d2f6; --panel-grad-to:#cfe1fb;

  --panel-maxw:1320px;
  --radius-xl:16px; --radius-md:12px;
  --shadow-1:0 10px 26px rgba(0,0,0,.10);
  --shadow-2:0 2px 0 rgba(0,0,0,.15), 0 2px 8px rgba(0,0,0,.06);

  /* Dear èˆ‡ä¸‰é¡†æŒ‰éˆ•ä¸€è‡´çš„å¯¬é«˜ */
  --ctrl-w:168px;
  --ctrl-h:40px;

  /* ç·¨è¼¯å™¨ç¸®æ”¾ï¼ˆæ”¾å¤§/ç¸®å°ä½¿ç”¨ï¼‰ */
  --editor-zoom:1rem;

  /* ç´…å¡èˆ‡è—åº•çš„é–“è·ï¼ˆä¿ç•™ä¸‹ç·£ç·©è¡ä¸è¦è²¼ï¼‰ */
  --bottom-gap:16px;

  /* ç‰ˆæ¬Šå¯èª¿æ•´ï¼ˆé¡è‰²/ä½ç½®/å¤§å°ï¼‰ */
  --copyright-bottom: 20px;
  --copyright-size: 13px;
  --copyright-pad: 6px;
  --copyright-color: #6b5e52;
}

/* æœ€åº•å±¤èƒŒæ™¯åœ– */
.bg-notes{position:fixed;inset:0;width:100%;height:100%;object-fit:cover;z-index:0;}

*{box-sizing:border-box;}
html,body{height:100%;margin:0;overflow:hidden;color:var(--ink);background:var(--brand-bg);
  font-family:"Patrick Hand","Noto Sans TC",system-ui,-apple-system,sans-serif;}

.panel{position:relative;z-index:2;max-width:var(--panel-maxw);
  height:calc(100vh - 110px);margin:26px auto;background:linear-gradient(135deg,var(--panel-grad-from),var(--panel-grad-to));
  border:1px solid var(--rim);border-radius:16px;box-shadow:var(--shadow-1);display:flex;flex-direction:column;overflow:hidden;}
h2{margin:12px 0 6px;text-align:center;font-family:"Sacramento",cursive;font-size:2.6rem;color:var(--title);}

.bar{padding:6px 22px 8px;}
.bar-inner{max-width:1200px;margin:0 auto;display:flex;align-items:center;gap:12px;}
.toolbar{display:flex;gap:8px;filter:drop-shadow(0 2px 0 rgba(0,0,0,.08));}
.tool-btn,.tool-select{min-width:64px;height:var(--ctrl-h);padding:0 12px;background:#fff;border:1px solid var(--rim);
  border-radius:12px;font-weight:700;display:flex;align-items:center;justify-content:center;gap:6px;box-shadow:var(--shadow-2);}
.tool-select{min-width:auto;padding:0 10px;}
.tool-btn:active{transform:translateY(1px) scale(.99);}

.rolebar{display:flex;gap:8px;}
.role-btn{min-width:64px;height:var(--ctrl-h);padding:0 12px;background:#fff;border:1px solid var(--rim);border-radius:12px;font-weight:700;box-shadow:var(--shadow-2);}
.role-btn.active{outline:2px solid rgba(0,0,0,.15);}
#status{flex:1 1 auto;min-width:240px;background:#F5F1EC;border:1px solid #E4E4E4;border-radius:12px;padding:8px 10px;font-size:14px;text-align:center;color:#A68A7C;font-weight:700;}

/* æœ‰åº•éƒ¨ç·©è¡ï¼Œç´…å¡ä¸æœƒè²¼åˆ°è—åº• */
.stage{flex:1 1 auto;padding:14px 22px var(--bottom-gap);display:flex;justify-content:center;}
.card{position:relative;width:100%;max-width:1200px;border:1px solid rgba(0,0,0,.05);border-radius:16px;box-shadow:0 10px 26px rgba(0,0,0,.08);
  padding:22px;height:calc(100% - var(--bottom-gap));display:grid;grid-template-columns:1fr 2fr;gap:14px;background:#e6b8af;}
.left-wrap{position:relative;background:linear-gradient(180deg, rgba(255,242,204,.98), rgba(255,242,204,.92));border-radius:16px;border:1px solid rgba(0,0,0,.05);padding:12px;overflow:hidden;}

/* Dear èˆ‡ä¸‰é¡†æŒ‰éˆ•åŒå¯¬åŒé«˜ */
.chip{width:var(--ctrl-w);height:var(--ctrl-h);background:#fff;border:1px solid var(--rim);border-radius:10px;display:flex;align-items:center;justify-content:center;gap:8px;padding:0 10px;box-shadow:var(--shadow-2);user-select:none;}
#chipBride{margin-bottom:10px;}
#brideLabel{font-weight:800;line-height:1;}

/* ç·¨è¼¯å™¨ï¼ˆå­—ç´šå¯æ”¾å¤§ç¸®å°ï¼‰ */
.editor{height:calc(100% - var(--ctrl-h) - 20px);overflow:auto;line-height:1.8;outline:none;border:1px dashed rgba(0,0,0,.12);border-radius:12px;padding:14px;
  font-size:var(--editor-zoom); background:transparent;}
.editor[data-empty]{opacity:1;color:rgba(15,23,42,.28);-webkit-text-stroke:0;text-shadow:none;font-style:italic;}
.editor.locked{pointer-events:none;opacity:.85;}

/* ä¸‹æ–¹ä¸‰é¡†ï¼ˆç­‰å¯¬ç­‰é«˜ï¼Œå«ç°½å chipï¼‰ */
.left-actions{display:flex;gap:10px;margin-top:10px;}
.left-actions>*{flex:0 0 var(--ctrl-w);height:var(--ctrl-h);}
.left-actions button{background:#fff;border:1px solid var(--rim);border-radius:10px;font-weight:800;box-shadow:var(--shadow-2);cursor:pointer;}
.left-actions button:active{transform:translateY(1px) scale(.99);}

/* ç°½å chipï¼šç°½å®Œé¡¯ç¤ºç¸®åœ–ä¸”é–å®šï¼ˆåªè§£é–å…§æ–‡ï¼‰ */
#chipSign{cursor:pointer;display:flex;align-items:center;justify-content:center;}
#chipSign.locked{pointer-events:none;opacity:.9;}
#signThumb{display:none;width:100%;height:70%;object-fit:contain;}
#chipSign.has-img #signThumb{display:block;}
#chipSign.has-img .hint{display:none;}
#chipSign .hint{font-weight:900; color:rgba(15,23,42,.34); letter-spacing:.02em;}

/* å³å´ç‰†é¢ */
.wall-wrap{background:linear-gradient(180deg,#f9e5ee,#f6dce7);border-radius:16px;border:1px solid rgba(0,0,0,.05);padding:12px;overflow:auto;}
.wall{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:14px;align-content:start;}

/* ç¥ç¦åŠç‰Œï¼ˆæ²¿ç”¨ä½ çš„è¨­å®šï¼‰ */
.tile{
  position:relative;width:100%;height:156px;padding:14px 12px 12px;cursor:pointer;overflow:visible;display:flex;flex-direction:column;gap:6px;
  background:
    linear-gradient(180deg,#f1e3cf,#e5d1b8),
    repeating-linear-gradient(14deg, rgba(0,0,0, .12) 0 4px, rgba(255,255,255, .08) 4px 9px),
    repeating-linear-gradient(0deg, rgba(0,0,0, .06) 0 2px, rgba(255,255,255, .05) 2px 4px),
    radial-gradient(16px 12px at 28% 36%, rgba(0,0,0,.08), transparent 60%),
    radial-gradient(14px 10px at 72% 62%, rgba(0,0,0,.08), transparent 60%);
  border:1px solid #cfba9b;border-radius:14px;box-shadow:0 10px 18px rgba(0,0,0,.10);
  clip-path:polygon(0 12%, 12% 0, 88% 0, 100% 12%, 100% 100%, 0 100%);
}
.tile::before{content:"";position:absolute;top:4px;left:50%;transform:translateX(-50%);width:16px;height:16px;border-radius:50%;
  background:radial-gradient(circle at 35% 35%, #fff 0 35%, #bbb 36% 60%, transparent 61%);box-shadow:inset 0 1px 0 rgba(255,255,255,.9), inset 0 -1px 0 rgba(0,0,0,.15);}
.tile::after{content:"";position:absolute;top:-6px;right:12px;width:18px;height:12px;border-radius:0 18px 18px 18px / 0 12px 12px 12px;
  background:linear-gradient(180deg,#7fcf7a,#58b35a);box-shadow:0 1px 0 rgba(255,255,255,.45), inset 0 -1px 0 rgba(0,0,0,.15);}
.tile .rope{position:absolute;top:-18px;left:50%;transform:translateX(-50%);width:8px;height:42px;background:
  repeating-linear-gradient(90deg,#b77c3a 0 3px,#c98a45 3px 6px),
  linear-gradient(180deg,rgba(255,255,255,.65),rgba(255,255,255,0) 55%),
  linear-gradient(0deg,rgba(0,0,0,.12),transparent 60%);border-radius:999px;filter:saturate(.9);box-shadow:0 3px 8px rgba(0,0,0,.15);}
.tile .knot{position:absolute;top:-12px;left:50%;transform:translateX(-50%);width:28px;height:20px;background:linear-gradient(180deg,#cc8a3d,#a9652b);
  border-radius:14px;box-shadow:0 2px 0 rgba(0,0,0,.08), 0 10px 16px rgba(0,0,0,.12);border:1px solid rgba(0,0,0,.12);}
.tile .knot::before,.tile .knot::after{content:"";position:absolute;top:40%;width:54%;height:54%;background:linear-gradient(180deg,#d09045,#b17233);
  border-radius:999px;box-shadow:inset 0 2px 2px rgba(255,255,255,.35);}
.tile .knot::before{left:-14px;transform:rotate(-28deg);}
.tile .knot::after{right:-14px;transform:rotate(28deg);}
.tile-name{font-weight:800;text-align:center;margin-top:8px;}
.tile-sep{height:1px;background:rgba(0,0,0,.12);margin:6px 0;}
.tile-date{font-size:12px;opacity:.8;text-align:center;}
.tile-snippet{font-size:14px;line-height:1.6;text-align:left;word-break:break-word;display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;overflow:hidden;text-overflow:ellipsis;}

/* ç‰ˆæ¬Šåœ¨èƒŒæ™¯å±¤ï¼ˆè—åº•å¤–ï¼‰ï¼Œé¡è‰²/é«˜åº¦å¯èª¿ */
.copyright-bg{
  position:fixed; left:0; right:0; bottom:var(--copyright-bottom);
  z-index:1; text-align:center; padding:var(--copyright-pad) 0;
  font-size:var(--copyright-size); color:var(--copyright-color); font-weight:700; pointer-events:none;
}

/* ç°½åå°è©±æ¡†ï¼ˆå¯é»å¯ç•«ï¼‰ */
.overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(17,24,39,.35);backdrop-filter:blur(3px);z-index:9999;}
.overlay.show{display:flex;}
.dialog{width:min(92vw,520px);max-height:82vh;background:#F5F1EC;border:1px solid var(--rim);border-radius:14px;padding:16px;box-shadow:0 18px 44px rgba(0,0,0,.18);overflow:auto;}
.dialog h3{margin:0 0 10px;font-size:18px;color:#6b5e52;text-align:center;-webkit-text-stroke:0;text-shadow:none;}
#pad{width:100%;height:260px;background:#fff;border:1px solid #ddd;border-radius:12px;touch-action:none;}
.dlg-actions{display:flex;gap:10px;justify-content:center;margin-top:12px;}
.dlg-actions button{width:120px;height:var(--ctrl-h);border-radius:10px;border:1px solid var(--rim);background:#fff;cursor:pointer;font-weight:700;box-shadow:var(--shadow-2);}
</style>

<body>
  <!-- èƒŒæ™¯åœ–ï¼ˆä½ æä¾›çš„è·¯å¾‘ï¼‰ -->
  <img class="bg-notes" src="./assets/favors.png?v=4" alt="">

  <!-- ç‰ˆæ¬Šï¼ˆå¯æ”¹é¡è‰²èˆ‡é«˜åº¦ï¼‰ -->
  <div class="copyright-bg">Â© Copyright 2025 MYâ€˜s System</div>

  <div class="panel">
    <h2>â¤ï¸åŒå¿ƒç¥ˆé¡˜â¤ï¸</h2>

    <div class="bar"><div class="bar-inner">
      <div class="rolebar">
        <button type="button" class="role-btn active" id="roleAll">å…¨éƒ¨</button>
        <button type="button" class="role-btn" id="roleMale">ç”·æ–¹</button>
        <button type="button" class="role-btn" id="roleFemale">å¥³æ–¹</button>
      </div>

      <p id="status">ğŸ“¥ é‚„åœ¨ç­‰å¾…ï¼Œå¾…é€å‡ºè³‡æ–™</p>

      <div class="toolbar" role="toolbar" aria-label="æ–‡å­—å·¥å…·">
        <button class="tool-btn" id="btnBold">ç²—é«”</button>
        <button class="tool-btn" id="btnItalic">æ–œé«”</button>
        <button class="tool-btn" id="btnUnderline">åº•ç·š</button>
        <select id="colorPick" class="tool-select" title="å­—é«”é¡è‰²">
          <option value="" selected>é¡è‰²</option>
          <option value="#a21caf">å°ç´«</option>
          <option value="#dc2626">å°ç´…</option>
          <option value="#2563eb">å°è—</option>
          <option value="#059669">å°ç¶ </option>
          <option value="#d97706">å°æ©˜</option>
          <option value="#6b7280">å°ç°</option>
        </select>
        <button class="tool-btn" id="btnBigger">æ”¾å¤§</button>
        <button class="tool-btn" id="btnSmaller">ç¸®å°</button>
      </div>
    </div></div>

    <div class="stage">
      <div class="card" id="card">
        <!-- å·¦ï¼šè¼¸å…¥ -->
        <section class="left-wrap">
          <div id="chipBride" class="chip" title="æ–°äºº"><span id="brideLabel">Dear â€”</span></div>

          <div id="editor" class="editor" contenteditable="true" aria-label="ç¥ˆé¡˜å…§å®¹" data-empty>
            å¯«ä¸‹ä¸¦ç»ä¸Šæœ€èª æ‘¯çš„ç¥ç¦â€¦ğŸ’
          </div>

          <!-- ä¸‰é¡†ï¼šå†æ¬¡ä¿®æ”¹ï¼é€å‡ºç¥ç¦ï¼ç•«æŠ¼ç°½åï¼ˆç­‰å¯¬ç­‰é«˜ï¼‰ -->
          <div class="left-actions">
            <button id="btnEdit"  type="button">å†æ¬¡ä¿®æ”¹</button>
            <button id="btnSend"  type="button">é€å‡ºç¥ç¦</button>
            <div class="chip" id="chipSign" title="é»æ­¤ç°½å">
              <span class="hint">ç•«æŠ¼ç°½å</span>
              <img id="signThumb" alt="signature preview" />
            </div>
          </div>
        </section>

        <!-- å³ï¼šç¥ç¦ç‰† -->
        <section class="wall-wrap">
          <div class="wall" id="wall"></div>
        </section>
      </div>
    </div>
  </div>

  <!-- æª¢è¦–çª— -->
  <div id="viewOverlay" class="overlay" role="dialog" aria-modal="true" aria-labelledby="viewTitle">
    <div class="dialog">
      <h3 id="viewTitle">ç¥ç¦å…§å®¹</h3>
      <div class="view-meta" id="viewMeta"></div>
      <div id="viewContent" class="view-content" style="background:#fff;border:1px solid #ddd;border-radius:12px;padding:12px;line-height:1.8;"></div>
      <div class="dlg-actions"><button id="viewClose" type="button">é—œé–‰</button></div>
    </div>
  </div>

  <!-- ç°½å Modalï¼ˆå®Œæ•´ï¼‰ -->
  <div id="sigOverlay" class="overlay" role="dialog" aria-modal="true" aria-labelledby="sigTitle">
    <div class="dialog">
      <h3 id="sigTitle">è«‹æ–¼ä¸‹æ–¹ç•«æŠ¼å”·ğŸ˜ˆ</h3>
      <canvas id="pad"></canvas>
      <div class="dlg-actions">
        <button id="sigClear"  type="button">æ¸…é™¤</button>
        <button id="sigCancel" type="button">å–æ¶ˆ</button>
        <button id="sigOK"     type="button">ç¢ºå®š</button>
      </div>
    </div>
  </div>

<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script>
/* ===== ä½ çš„åŸæœ¬è¨­å®šï¼ˆä¸å‹•ï¼‰ ===== */
const LIFF_ID='2008149060-m5pDXW6a';
const WEBHOOK='https://script.google.com/macros/s/AKfycby-yPxuPhS9hk-uLLSEZRuEfHqw1r16ND6c_6D2GzoN0XEnu-cWg1DIw_-i2G50YM2t/exec';

/* ç‹€æ…‹èˆ‡å…ƒç´  */
const editor=document.getElementById('editor'); const wallEl=document.getElementById('wall');
function setStatus(m){ document.getElementById('status').textContent=m; }

/* ===== LIFF init & role/nameï¼ˆæ²¿ç”¨ï¼‰ ===== */
let lineId='',displayName='',pictureUrl='',myLastRow=null, signatureDataURL='';

async function initLIFF(){
  if(!window.liff){ await initialLoad(); return; }
  try{
    await liff.init({ liffId: LIFF_ID, withLoginOnExternalBrowser:true });
    if(!liff.isLoggedIn()){ liff.login(); return; }
    await liff.ready;
    const prof=await liff.getProfile(); const idt=liff.getDecodedIDToken();
    lineId=prof.userId||idt.sub||''; displayName=prof.displayName||idt.name||''; pictureUrl=prof.pictureUrl||'';
  }catch(_){}
  await fetchRoleAndNames(); await preloadMyLatest(); await refreshWall();
}
async function initialLoad(){ await fetchRoleAndNames(); await refreshWall(); }

async function fetchRoleAndNames(){
  try{
    const j=await (await fetch(WEBHOOK+`?action=userRole&lineId=${encodeURIComponent(lineId||'')}`)).json();
    if(j?.ok){ document.getElementById('brideLabel').textContent = j.nameLabel || 'â€”'; }
  }catch(_){}
}

/* ===== è‡ªå·±æœ€è¿‘ä¸€ç­†ï¼ˆè¼‰å…¥å³é–ï¼›ç°½åä¹Ÿé–ï¼‰ ===== */
async function preloadMyLatest(){
  if(!lineId) return;
  try{
    const j=await (await fetch(WEBHOOK+`?action=getLatestByLineId&lineId=${encodeURIComponent(lineId)}`)).json();
    if(j?.ok && j.item){
      const it=j.item;
      if(it.contentHTML){ editor.innerHTML=it.contentHTML; editor.removeAttribute('data-empty'); lockEditor(); }
      if(it.signature){
        const chip=document.getElementById('chipSign'); const img=document.getElementById('signThumb');
        img.src=it.signature; chip.classList.add('has-img'); chip.classList.add('locked');
      }
      myLastRow = Number(it.row||0) || null;
    }
  }catch(_){}
}

/* ===== å·¥å…·åˆ—ï¼ˆç²—é«”/æ–œé«”/åº•ç·š + æ”¾å¤§/ç¸®å° + é¡è‰²ï¼‰ ===== */
function exec(cmd){ if(editor.hasAttribute('data-empty')||editor.classList.contains('locked')) return; document.execCommand(cmd,false,null); editor.focus(); }
document.getElementById('btnBold').onclick=()=>exec('bold');
document.getElementById('btnItalic').onclick=()=>exec('italic');
document.getElementById('btnUnderline').onclick=()=>exec('underline');
document.getElementById('colorPick').onchange=e=>{ const v=e.target.value; if(v&&!editor.classList.contains('locked')&&!editor.hasAttribute('data-empty')) document.execCommand('foreColor',false,v); e.target.blur(); };

/* æ”¾å¤§/ç¸®å°ï¼šèª¿ CSS è®Šæ•¸ */
let currentScale=1;
function setScale(s){ currentScale=Math.max(.7,Math.min(1.7,s)); editor.style.setProperty('--editor-zoom', currentScale+'rem'); editor.focus(); }
document.getElementById('btnBigger').onclick=()=> setScale(currentScale + .06);
document.getElementById('btnSmaller').onclick=()=> setScale(currentScale - .06);

/* å ä½å­—ï¼šé»é€²å»å°±æ¸…æ‰ï¼Œé›¢é–‹è‹¥ç©ºå†æ”¾å› */
const PLACEHOLDER='å¯«ä¸‹ä¸¦ç»ä¸Šæœ€èª æ‘¯çš„ç¥ç¦â€¦ğŸ’';
editor.addEventListener('focus',()=>{
  if(editor.hasAttribute('data-empty')){
    editor.innerHTML='';            // ç›´æ¥æ¸…ç©ºï¼Œä¸ç”¨æ‰‹å‹•åˆª
    editor.removeAttribute('data-empty');
  }
});
editor.addEventListener('blur',()=>{
  if(!editor.textContent.trim()){
    editor.setAttribute('data-empty','');
    editor.textContent=PLACEHOLDER;
  }
});

/* ===== ç¥ç¦ç‰†ï¼ˆä¿éšªå€’åºï¼‰ ===== */
function escapeHTML(s){return String(s||'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));}
function fmt(s){return s?String(s).replace('T',' ').slice(0,19):'';}
function tileTemplate(it){return `<div class="tile" data-row="${it.row||''}" data-owner="${it.lineId||''}">
  <div class="rope"></div><div class="knot"></div>
  <div class="tile-name">${escapeHTML(it.displayName||'â€”')}</div>
  <div class="tile-sep"></div>
  <div class="tile-date">${escapeHTML(fmt(it.time))}</div>
  <div class="tile-sep"></div>
  <div class="tile-snippet">${escapeHTML((it.preview||'').trim()||'â€”')}</div>
</div>`;}
async function refreshWall(){
  try{
    const role=document.querySelector('.role-btn.active')?.id?.replace('role','').toLowerCase()||'all';
    const j=await (await fetch(WEBHOOK+`?action=listblessings&role=${role}`)).json();
    if(j?.ok){
      const arr=(j.items||[]).slice().sort((a,b)=> new Date(b.time||0) - new Date(a.time||0));
      wallEl.innerHTML=arr.map(tileTemplate).join('');
      bindTileClicks();
    }
  }catch(_){}
}
function bindTileClicks(){ document.querySelectorAll('.tile').forEach(t=>t.addEventListener('click',()=>openView(t))); }
async function openView(el){
  const row=el.getAttribute('data-row');
  const j=await (await fetch(WEBHOOK+`?action=getBlessingDetail&id=${encodeURIComponent(row)}`)).json();
  if(j?.ok&&j.item){
    const meta=document.getElementById('viewMeta'); if(meta) meta.textContent=`${j.item.displayName||'â€”'} ï½œ ${fmt(j.item.time)}`;
    const vc=document.getElementById('viewContent'); vc.innerHTML=j.item.contentHTML||'';
    document.getElementById('viewOverlay').classList.add('show');
  }
}
document.getElementById('viewClose').onclick=()=>document.getElementById('viewOverlay').classList.remove('show');
document.getElementById('roleAll').onclick=()=>{document.querySelectorAll('.role-btn').forEach(b=>b.classList.remove('active'));document.getElementById('roleAll').classList.add('active');refreshWall();};
document.getElementById('roleMale').onclick=()=>{document.querySelectorAll('.role-btn').forEach(b=>b.classList.remove('active'));document.getElementById('roleMale').classList.add('active');refreshWall();};
document.getElementById('roleFemale').onclick=()=>{document.querySelectorAll('.role-btn').forEach(b=>b.classList.remove('active'));document.getElementById('roleFemale').classList.add('active');refreshWall();};

/* ===== é€å‡º / æ›´æ–° ===== */
function lockEditor(){editor.classList.add('locked');editor.setAttribute('contenteditable','false');}
function unlockEditor(){editor.classList.remove('locked');editor.setAttribute('contenteditable','true');editor.focus();}
document.getElementById('btnEdit').onclick=()=>unlockEditor();

function hasSignature(){return document.getElementById('chipSign').classList.contains('has-img');}
async function sendOrUpdate(){
  if(editor.hasAttribute('data-empty')||!editor.textContent.trim()){ alert('æ¬¸ï¼Œä¸å¯èƒ½ä¸ç¥ç¦æˆ‘å€‘å§ğŸ–•ï¸'); return; }
  if(!hasSignature()){ alert('æ¬¸ï¼Œæ²’æœ‰ç•«æŠ¼ä¸å‡†é›¢é–‹âœï¸'); return; }
  const content=editor.innerHTML.trim();
  const payload = myLastRow
    ? {action:'updateBlessing',row:Number(myLastRow),lineId,contentHTML:content}
    : {action:'createBlessing',lineId,displayName,pictureUrl,contentHTML:content,signaturePNG:signatureDataURL||'',extra:{}};
  const r=await fetch(WEBHOOK,{method:'POST',headers:{'Content-Type':'text/plain;charset=UTF-8'},body:JSON.stringify(payload)});
  const j=await r.json().catch(()=>null);
  if(j?.ok){ lockEditor(); await refreshWall(); if(!myLastRow) await preloadMyLatest(); setStatus(myLastRow?'âœ… å·²æ›´æ–°ä¸¦é–å®š':'âœ… å·²é€å‡ºä¸¦é–å®š'); }
  else if(j?.error==='deadline_passed'){ setStatus('â›” å·²åˆ°æˆªæ­¢æ—¥ï¼Œç„¡æ³•é€å‡ºåŠç·¨è¼¯'); lockEditor(); }
  else setStatus('âŒ é€å‡ºå¤±æ•—ï¼Œç¨å¾Œå†è©¦');
}
document.getElementById('btnSend').onclick=sendOrUpdate;

/* ===== ç°½åï¼šå¯ç•«ã€å¯æ¸…é™¤ã€ç¢ºå®šå¾Œç¸®åœ–ä¸¦é–å®šï¼›å–æ¶ˆä¸è®Š ===== */
const sigOverlay = document.getElementById('sigOverlay');
const pad        = document.getElementById('pad');
const ctx        = pad.getContext('2d');
const chipSign   = document.getElementById('chipSign');
const signThumb  = document.getElementById('signThumb');

let drawing=false, lastX=0, lastY=0;

function fitCanvas(){
  const dpr = Math.max(1, window.devicePixelRatio || 1);
  const w = pad.clientWidth, h = pad.clientHeight;
  pad.width = w * dpr; pad.height = h * dpr;
  ctx.setTransform(dpr,0,0,dpr,0,0);
  ctx.lineCap='round'; ctx.lineJoin='round'; ctx.lineWidth=3; ctx.strokeStyle='#111';
  ctx.clearRect(0,0,w,h);
}
function pos(e){
  const r = pad.getBoundingClientRect();
  const t = (e.touches && e.touches[0]) || e;
  return { x: t.clientX - r.left, y: t.clientY - r.top };
}
function start(e){ drawing=true; const p=pos(e); lastX=p.x; lastY=p.y; e.preventDefault(); }
function move(e){
  if(!drawing) return;
  const p=pos(e);
  ctx.beginPath(); ctx.moveTo(lastX,lastY); ctx.lineTo(p.x,p.y); ctx.stroke();
  lastX=p.x; lastY=p.y; e.preventDefault();
}
function end(){ drawing=false; }

/* é–‹å•Ÿå°è©±æ¡†ï¼ˆè‹¥ç°½åå·²é–å®šå‰‡ä¸é–‹ï¼‰ */
chipSign.addEventListener('click', ()=>{
  if(chipSign.classList.contains('locked')) return;
  sigOverlay.classList.add('show');
  setTimeout(fitCanvas, 40);
});

/* æ»‘é¼  + è§¸æ§ç¹ªåœ–äº‹ä»¶ */
pad.addEventListener('mousedown', start);
pad.addEventListener('mousemove', move);
pad.addEventListener('mouseup', end);
pad.addEventListener('mouseleave', end);
pad.addEventListener('touchstart', start, {passive:false});
pad.addEventListener('touchmove',  move,  {passive:false});
pad.addEventListener('touchend',   end);

/* å°è©±æ¡†ä¸‰é¡† */
document.getElementById('sigClear').onclick  = fitCanvas;
document.getElementById('sigCancel').onclick = ()=> sigOverlay.classList.remove('show');
document.getElementById('sigOK').onclick     = ()=>{
  signatureDataURL = pad.toDataURL('image/png');
  signThumb.src = signatureDataURL;
  chipSign.classList.add('has-img');   // é¡¯ç¤ºç¸®åœ–
  chipSign.classList.add('locked');    // ç°½åé–å®š
  sigOverlay.classList.remove('show');
};

/* ===== å•Ÿå‹• ===== */
window.addEventListener('DOMContentLoaded',()=>{
  /* å ä½å­—ï¼šåˆå§‹çµ¦ä¸Š data-emptyï¼Œé»é€²å°±æ¸… */
  if(!editor.textContent.trim()){
    editor.setAttribute('data-empty','');
    editor.textContent='å¯«ä¸‹ä¸¦ç»ä¸Šæœ€èª æ‘¯çš„ç¥ç¦â€¦ğŸ’';
  }
  if(window.liff) initLIFF(); else initialLoad();
});
</script>
</body>
</html>
