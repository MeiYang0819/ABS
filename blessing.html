<!doctype html>
<html lang="zh-Hant">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>é€ä¸Šç¥ç¦</title>

<!-- å­—é«” -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Patrick+Hand:wght@400&family=Sacramento:wght@400;700&display=swap" rel="stylesheet">

<style>
:root{
  /* ä¸»é¡Œé…è‰²ï¼ˆä¸æ›´å‹•ï¼‰ */
  --brand-bg:#c9daf8; --title:#A68A7C; --ink:#0f172a; --accent:#A68A7C; --rim:#E4E4E4; --soft:#F5F1EC;

  /* é¢æ¿æ¼¸å±¤ */
  --panel-grad-from:#b7d2f6; --panel-grad-to:#cfe1fb; --panel-bg-image:none;

  /* å…§é å¡ç‰‡æ¼¸å±¤ */
  --paper-grad-from:rgba(255,242,204,.98); --paper-grad-to:rgba(255,242,204,.92);

  /* å¯¬åº¦ï¼ˆæ¯”åŸæœ¬å†å¯¬ï¼‰ */
  --panel-maxw:1320px; --card-maxw:1200px;

  --radius-xl:16px; --radius-md:12px;
  --shadow-1:0 10px 26px rgba(0,0,0,.10);
  --shadow-2:0 2px 0 rgba(0,0,0,.15), 0 2px 8px rgba(0,0,0,.06);

  --content-pad:22px; --editor-zoom:1rem;
  --toolbar-gap:8px; --status-fz:14px;

  /* â˜… æ¨™é¡Œï¼šå­—ç´šã€è¡Œé«˜ã€ä¸Šä¸‹è·ï¼ˆè¦èˆ‡äº’å‹•éŸ³ç¬¦ä¸€è‡´ï¼Œå¿…è¦æ™‚æŠŠ 56px æ›æˆä½ é‚£é çš„ px å€¼ï¼‰ */
  --h2-size:56px;           /* è‹¥äº’å‹•éŸ³ç¬¦æ˜¯åˆ¥çš„å€¼ï¼Œæ”¹æˆç›¸åŒ px å€¼å³å¯ä¸€æ¨£å¤§ */
  --h2-line:1;              /* å›ºå®šè¡Œé«˜è®“é«˜åº¦è¦–è¦ºä¸€è‡´ */
  --h2-gap:12px;            /* æ¨™é¡Œèˆ‡å·¥å…·åˆ—è·é›¢ï¼ˆä¸Šä¸‹ç­‰è·æ„Ÿï¼‰ */

  --stroke:rgba(0,0,0,.18); --glow:rgba(255,255,255,.65);

  --footer-gap:48px;
  --btn-w:220px; --btn-h:50px;

  /* è¨±é¡˜ç‰Œå°ºå¯¸ */
  --tile-w:220px; --tile-h:150px;

  /* å·¦å€å›ºå®šè§’è½èˆ‡åº•éƒ¨æ§åˆ¶ */
  --chip-w:140px; --chip-h:44px; --chip-gap:10px;
  --left-footer-h:44px;     /* å·¦å€åº•éƒ¨ä¸‰éµé«˜åº¦ */
}

/* åŸºç¤ */
*{ box-sizing:border-box; }
html,body{ height:100%; margin:0; overflow:hidden; color:var(--ink); background:var(--brand-bg);
  font-family:"Patrick Hand","Noto Sans TC",system-ui,-apple-system,sans-serif;
  -webkit-text-stroke:.35px var(--stroke); text-shadow:0 1px 0 var(--glow);
}

/* èƒŒæ™¯ */
.bg-photo{ position:fixed; inset:0; z-index:0; width:100%; height:100%; object-fit:cover; opacity:.35; pointer-events:none; filter:brightness(.6) saturate(.9); }

/* é¢æ¿ */
.panel{
  position:relative; z-index:1; max-width:var(--panel-maxw);
  height:calc(100vh - (70px + var(--footer-gap))); margin:26px auto;
  background: linear-gradient(135deg, var(--panel-grad-from), var(--panel-grad-to)), var(--panel-bg-image);
  background-size:auto, cover; background-position:left top, center;
  border:1px solid var(--rim); border-radius:var(--radius-xl); box-shadow:var(--shadow-1);
  display:flex; flex-direction:column; overflow:hidden;
}

/* æ¨™é¡Œï¼ˆèˆ‡äº’å‹•éŸ³ç¬¦åŒé«˜åº¦è§€æ„Ÿï¼‰ */
.titlebar{ background:transparent; padding:16px 16px 6px; } /* é ‚ç«¯ç•™ç™½ */
h2{
  margin:0 0 var(--h2-gap);
  text-align:center; font-family:"Sacramento",cursive; font-weight:700;
  font-size:var(--h2-size); line-height:var(--h2-line);
  letter-spacing:1px; color:var(--title);
  -webkit-text-stroke:.6px rgba(0,0,0,.12); text-shadow:0 3px 4px rgba(255,255,255,.75);
}

/* ä¸Šæ–¹ bar */
.bar{ padding:6px 22px 8px; }
.bar-inner{ max-width:var(--card-maxw); margin:0 auto; display:flex; align-items:center; gap:12px; }

/* è§’è‰²ä¸‰éµï¼ˆå–ä»£èˆŠå´é‚Šï¼‰ */
.rolebar{ display:flex; gap:var(--toolbar-gap); }
.role-btn,.tool-btn,.tool-select{
  min-width:64px; height:36px; padding:0 12px; background:#fff; border:1px solid var(--rim); border-radius:var(--radius-md);
  font-weight:700; display:flex; align-items:center; justify-content:center; gap:6px; box-shadow:var(--shadow-2);
}
.role-btn.active{ outline:2px solid rgba(0,0,0,.15); }
.tool-select{ min-width:auto; padding:0 10px; }
.tool-btn:active{ transform:translateY(1px) scale(.99); }

/* ç‹€æ…‹åˆ— */
#status{
  flex:1 1 auto; min-width:240px; background:var(--soft); border:1px solid #E4E4E4; border-radius:12px; padding:10px;
  font-size:var(--status-fz); white-space:pre-wrap; text-align:center; color:var(--accent)!important; font-weight:700;
  -webkit-text-stroke:.35px rgba(0,0,0,.10); text-shadow:0 1px 0 rgba(255,255,255,.85),0 3px 6px rgba(0,0,0,.04);
}

/* èˆå° */
.stage{ flex:1 1 auto; padding:14px 22px 0; display:flex; justify-content:center; align-items:flex-start; overflow:hidden; }

/* å…§é å¡ */
.card{
  position:relative; width:100%; max-width:var(--card-maxw);
  background:linear-gradient(180deg, var(--paper-grad-from), var(--paper-grad-to));
  border:1px solid rgba(0,0,0,.05); border-radius:var(--radius-xl); box-shadow:0 10px 26px rgba(0,0,0,.08);
  padding:var(--content-pad); height:100%; overflow:auto;
  display:grid; grid-template-columns:1fr 2fr; gap:14px; /* å·¦ 1/3 å³ 2/3 */
}

/* å·¦å€ï¼šå›ºå®š chip + ç·¨è¼¯å™¨ + åº•éƒ¨ä¸‰éµ */
.left-content{ position:relative; min-height:280px; border-radius:12px; }

/* æ–°äºº / ç°½å chipï¼ˆåŒè‰²åŒæ¨£å¼ï¼‰ */
.chip{
  position:absolute; width:var(--chip-w); height:var(--chip-h);
  background:#fff; border:1px solid var(--rim); border-radius:10px;
  box-shadow:0 2px 8px rgba(0,0,0,.06);
  display:flex; align-items:center; justify-content:center; gap:8px;
  padding:6px 10px; user-select:none;
}
#chipBride{ top:var(--chip-gap); left:var(--chip-gap); }
#chipSign{ bottom:calc(var(--left-footer-h) + var(--chip-gap)*2); left:50%; transform:translateX(-50%); cursor:pointer; } /* åº•éƒ¨ç½®ä¸­ï¼Œé¿é–‹åº•éƒ¨ä¸‰éµ */
#chipSign:not(.has-img){ opacity:.22; }
#chipSign .hint{ font-weight:900; }
#signThumb{ display:none; width:120px; height:50px; object-fit:contain; background:linear-gradient(180deg, var(--paper-grad-from), var(--paper-grad-to)); border:1px solid var(--rim); border-radius:8px; }
#chipSign.has-img #signThumb{ display:block; }
#chipSign.has-img .hint{ display:none; }

/* å…§æ–‡ç·¨è¼¯å™¨ï¼šå…©å€‹ chip ä¹‹é–“æ’æ»¿ï¼›ç¨å¾®æ˜é¡¯çš„é‚Šæ¡† */
.editor{
  position:absolute;
  top:calc(var(--chip-gap) + var(--chip-h) + 10px);
  left:var(--chip-gap);
  right:var(--chip-gap);
  bottom:calc(var(--left-footer-h) + var(--chip-gap)*3 + var(--chip-h)); /* é ˆç•™å‡ºç°½å chip èˆ‡åº•éƒ¨ä¸‰éµç©ºé–“ */
  overflow:auto; line-height:1.8; outline:none; background:transparent; border-radius:12px; padding:12px;
  font-size:var(--editor-zoom); background-image:none; border:1px dashed rgba(0,0,0,.12);
}
.editor[data-empty]{ opacity:.22; }
.editor.locked{ pointer-events:none; user-select:text; opacity:1; } /* é–å®šç‹€æ…‹ï¼šå¯é¸å–ä½†ä¸å¯ç·¨è¼¯ */

/* å·¦å€åº•éƒ¨ä¸‰éµ */
.left-footer{
  position:absolute; left:var(--chip-gap); right:var(--chip-gap); bottom:var(--chip-gap);
  height:var(--left-footer-h); display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px;
}
.left-footer button{
  height:100%; background:#fff; border:1px solid var(--rim); border-radius:10px; font-weight:700; box-shadow:var(--shadow-2); cursor:pointer;
}
.left-footer button:active{ transform:translateY(1px) scale(.99); }

/* å³å€ï¼šè¨±é¡˜ç‰†ï¼ˆæœ¨ç‰Œé¢¨æ ¼ï¼‰ */
.wall{
  min-height:280px; display:grid; grid-template-columns:repeat(auto-fill, minmax(var(--tile-w), 1fr));
  gap:12px; align-content:start; padding:6px 4px 10px;
}
.tile{
  width:100%; height:var(--tile-h);
  position:relative; background:linear-gradient(180deg,#F2E4D5,#E9D7C5); /* æœ¨ç‰Œæ·¡å¥¶èŒ¶è‰² */
  border:1px solid #d8c8b6; border-radius:14px;
  box-shadow:0 6px 14px rgba(0,0,0,.08);
  padding:12px 14px 14px; cursor:pointer; overflow:hidden;
  display:flex; flex-direction:column; justify-content:flex-start; gap:6px;
}
/* ç¹©å­ */
.tile:before{
  content:""; position:absolute; top:-10px; left:50%; transform:translateX(-50%);
  width:16px; height:22px; background:#b21; border-radius:8px;
}
/* åŠå­” */
.tile:after{
  content:""; position:absolute; top:8px; left:50%; transform:translateX(-50%);
  width:10px; height:10px; border-radius:50%; background:rgba(0,0,0,.1);
}
/* å…§å®¹ */
.tile-header{ font-weight:800; text-align:center; margin-top:6px; }
.tile-meta{ font-size:12px; opacity:.75; text-align:center; }
.tile-snippet{
  font-size:14px; line-height:1.6; display:-webkit-box; -webkit-line-clamp:3; -webkit-box-orient:vertical; overflow:hidden; text-align:center;
}
.tile-sign{ position:absolute; right:8px; bottom:8px; width:70px; height:34px; border:1px solid var(--rim); border-radius:6px; background:#fff; display:flex; align-items:center; justify-content:center; overflow:hidden; }
.tile-sign img{ width:100%; height:100%; object-fit:contain; }

/* Modalï¼ˆçœ‹å…¨æ–‡ï¼Œä¸å†æä¾›ç·¨è¼¯ï¼‰ */
.overlay{ position:fixed; inset:0; z-index:9999; display:none; align-items:center; justify-content:center; background:rgba(17,24,39,.35); backdrop-filter:blur(3px); }
.overlay.show{ display:flex; }
.dialog{ width:min(92vw,680px); max-height:82vh; background:var(--soft); border:1px solid var(--rim); border-radius:14px; padding:16px; box-shadow:0 18px 44px rgba(0,0,0,.18); overflow:auto; }
.dialog h3{ margin:0 0 10px; font-size:18px; color:#6b5e52; text-align:center; -webkit-text-stroke:0; text-shadow:none; }
.view-meta{ text-align:center; font-size:12px; opacity:.75; margin-bottom:8px; }
.view-content{ background:#fff; border:1px solid #ddd; border-radius:12px; padding:12px; line-height:1.8; }
.view-actions{ display:flex; gap:10px; justify-content:center; margin-top:12px; }
.view-actions button{ min-width:120px; height:38px; border-radius:10px; border:1px solid var(--rim); background:#fff; cursor:pointer; font-weight:700; }

/* åº•éƒ¨é€å‡ºéµï¼ˆå…¨é ï¼Œç”¨ä¸åˆ°å¯ä¿ç•™ï¼‰ */
.footer-actions{ display:none; } /* éš±è—å…¨é åº•éƒ¨é€å‡ºï¼Œæ”¹ç”¨å·¦å€ä¸‰éµ */

/* ç‰ˆå°¾ */
footer{ position:fixed; left:0; right:0; bottom:var(--footer-gap); text-align:center; color:#6b5e52; font-size:12px; opacity:.9; pointer-events:none; z-index:5; }

/* ç°½å Modal */
#sigOverlay .dialog{ width:min(92vw,520px); }
#pad{ width:100%; height:260px; background:#fff; border:1px solid #ddd; border-radius:12px; touch-action:none; }
.dlg-actions{ display:flex; gap:10px; justify-content:center; margin-top:12px; }
.dlg-actions button{ width:120px; height:38px; border-radius:10px; border:1px solid var(--rim); background:#fff; cursor:pointer; font-weight:700; }
</style>

<body>
  <!-- èƒŒæ™¯ -->
  <img class="bg-photo" src="./assets/wishing.png" alt="">

  <div class="panel">
    <div class="titlebar">
      <h2>é€ä¸Šç¥ç¦</h2>

      <!-- barï¼šè§’è‰²ä¸‰éµ â†’ ç‹€æ…‹åˆ— â†’ æ–‡å­—å·¥å…· -->
      <div class="bar">
        <div class="bar-inner" id="barInner">
          <div class="rolebar">
            <button type="button" class="role-btn active" id="roleAll">å…¨éƒ¨</button>
            <button type="button" class="role-btn" id="roleMale">ç”·æ–¹</button>
            <button type="button" class="role-btn" id="roleFemale">å¥³æ–¹</button>
          </div>

          <p id="status">å·²å°±ç·’</p>

          <div class="toolbar" role="toolbar" aria-label="æ–‡å­—å·¥å…·">
            <button class="tool-btn" id="btnBold"      type="button" title="ç²—é«”">ç²—é«”</button>
            <button class="tool-btn" id="btnItalic"    type="button" title="æ–œé«”">æ–œé«”</button>
            <button class="tool-btn" id="btnUnderline" type="button" title="åº•ç·š">åº•ç·š</button>
            <select id="colorPick" class="tool-select" title="å­—é«”é¡è‰²">
              <option value="" selected>é¡è‰²</option>
              <option value="#0f172a">å¢¨è‰²</option>
              <option value="#a21caf">ç´«</option>
              <option value="#dc2626">ç´…</option>
              <option value="#2563eb">è—</option>
              <option value="#059669">ç¶ </option>
              <option value="#d97706">æ©˜</option>
              <option value="#6b7280">ç°</option>
            </select>
            <button class="tool-btn" id="btnBigger"    type="button" title="æ”¾å¤§">æ”¾å¤§</button>
            <button class="tool-btn" id="btnSmaller"   type="button" title="ç¸®å°">ç¸®å°</button>
          </div>
        </div>
      </div>
    </div>

    <div class="stage">
      <div class="card" id="card">
        <!-- å·¦å€ï¼šæ–°äººï¼ˆå·¦ä¸Šï¼‰ã€ç°½åï¼ˆåº•éƒ¨ç½®ä¸­ï¼‰ã€ç·¨è¼¯å™¨ã€åº•éƒ¨ä¸‰éµ -->
        <section class="left-content">
          <div class="chip" id="chipBride" title="æ–°äºº"><span id="brideLabel">æ–°äººï¼šâ€”</span></div>
          <div class="chip" id="chipSign" title="é»æ­¤ç°½å">
            <span class="hint">é»æˆ‘ç°½å</span>
            <img id="signThumb" alt="signature preview" />
          </div>

          <div class="editor" id="editor" contenteditable="true" aria-label="ç¥ç¦å…§å®¹">
            åœ¨æ­¤å¯«ä¸‹ä½ å°æ–°äººçš„ç¥ç¦â€¦ï¼ˆå¯é¸å­—å¾ŒæŒ‰ä¸Šæ–¹çš„ç²—é«”ï¼æ–œé«”ï¼åº•ç·šï¼é¡è‰²ï¼æ”¾å¤§ï¼ç¸®å°ï¼‰ğŸ’
          </div>

          <div class="left-footer">
            <button id="btnEdit"  type="button">ç·¨è¼¯</button>
            <button id="btnSend"  type="button">é€å‡º</button>
            <button id="btnSignOpen" type="button">é»æˆ‘ç°½å</button>
          </div>
        </section>

        <!-- å³å€ï¼šè¨±é¡˜ç‰†ï¼ˆæœ¨ç‰Œï¼‰ -->
        <section><div class="wall" id="wall"></div></section>
      </div>
    </div>
  </div>

  <footer>Â© Copyright 2025 MYâ€˜s System</footer>

  <!-- æ”¾å¤§æª¢è¦– Modalï¼ˆåƒ…é–±è®€ï¼Œä¸æä¾›ç·¨è¼¯ï¼‰ -->
  <div id="viewOverlay" class="overlay" role="dialog" aria-modal="true" aria-labelledby="viewTitle">
    <div class="dialog">
      <h3 id="viewTitle">ç¥ç¦å…§å®¹</h3>
      <div class="view-meta" id="viewMeta"></div>
      <div id="viewContent" class="view-content"></div>
      <div class="view-actions">
        <button id="viewClose" type="button">é—œé–‰</button>
      </div>
    </div>
  </div>

  <!-- ç°½å Modal -->
  <div id="sigOverlay" class="overlay" role="dialog" aria-modal="true" aria-labelledby="sigTitle">
    <div class="dialog">
      <h3 id="sigTitle">è«‹æ–¼ä¸‹æ–¹ç°½å</h3>
      <canvas id="pad"></canvas>
      <div class="dlg-actions">
        <button id="sigClear"  type="button">æ¸…é™¤</button>
        <button id="sigCancel" type="button">å–æ¶ˆ</button>
        <button id="sigOK"     type="button">ç¢ºå®š</button>
      </div>
    </div>
  </div>

<script>
/* ====== åŸºæœ¬è¨­å®š ====== */
const LIFF_ID='2008149060-m5pDXW6a';
const WEBHOOK='https://script.google.com/macros/s/AKfycbx4wqm5tIWGvXRqIrjKPEFTYkaDf7cHLrYQTrJZ9ETQ8Fgikkv5QMny0TG8xW6aW_l0/exec';
const TIMEOUT_MS=20000;

/* ç‹€æ…‹åˆ— */
function setStatus(m){
  const el=document.getElementById('status');
  el.textContent=m; el.classList.remove('ok','busy','err');
  if(/æˆåŠŸ|å·²è¼‰å…¥|å°±ç·’/.test(m)) el.classList.add('ok');
  else if(/é€å‡ºä¸­|ç­‰å¾…|è™•ç†/.test(m)) el.classList.add('busy');
  else if(/å¤±æ•—|é€¾æ™‚|ç„¡æ³•|éŒ¯èª¤/.test(m)) el.classList.add('err');
}

/* LIFF åˆå§‹åŒ– */
let lineId='',displayName='',pictureUrl='';
async function initLIFF(){
  if(typeof liff==='undefined'){ setStatus('ï¼ˆæœªè¼‰å…¥ LIFF SDKï¼Œå¯å…ˆæ¸¬æ¨£å¼ï¼‰'); return; }
  try{
    setStatus('åˆå§‹åŒ– LIFFâ€¦');
    await liff.init({ liffId: LIFF_ID, withLoginOnExternalBrowser:true });
    if(!liff.isLoggedIn()){ liff.login({ scope:['openid','profile'] }); return; }
    if(liff.ready) await liff.ready;
    let prof=null, idt=null;
    try{ prof=await liff.getProfile(); }catch(_){}
    try{ idt=liff.getDecodedIDToken(); }catch(_){}
    lineId=(prof&&prof.userId)||(idt&&idt.sub)||'';
    displayName=(prof&&prof.displayName)||(idt&&(idt.name||idt.nickname))||'';
    pictureUrl=(prof&&prof.pictureUrl)||'';
    // æ–°äººå§“å
    try{
      const r=await fetch(WEBHOOK+'?action=couple',{method:'GET',cache:'no-store'});
      if(r.ok){ const j=await r.json().catch(()=>null); if(j&&j.ok&&j.name){ document.getElementById('brideLabel').textContent='æ–°äººï¼š'+String(j.name||'â€”'); } }
    }catch(_){}
    await refreshWall();
    setStatus('å·²å°±ç·’');
  }catch(e){ setStatus('LIFF åˆå§‹åŒ–å¤±æ•—ï¼š'+e.message); }
}

/* å·¥å…·åˆ— */
const editor=document.getElementById('editor');
function btnExec(cmd){ if(editor.hasAttribute('data-empty')||editor.classList.contains('locked')) return; document.execCommand(cmd,false,null); editor.focus(); }
document.getElementById('btnBold').addEventListener('click',()=>btnExec('bold'));
document.getElementById('btnItalic').addEventListener('click',()=>btnExec('italic'));
document.getElementById('btnUnderline').addEventListener('click',()=>btnExec('underline'));
document.getElementById('colorPick').addEventListener('change',e=>{
  const v=e.target.value; if(!editor.hasAttribute('data-empty') && !editor.classList.contains('locked') && v){ document.execCommand('foreColor',false,v); editor.focus(); } e.target.blur();
});

/* æ”¾å¤§ç¸®å° */
function wrapSelectionWithClass(cls){
  if(editor.hasAttribute('data-empty')||editor.classList.contains('locked')) return false;
  const sel=window.getSelection(); if(!sel.rangeCount) return false;
  const r=sel.getRangeAt(0); if(r.collapsed) return false;
  const span=document.createElement('span'); span.className=cls;
  try{ r.surroundContents(span); }catch(_){ const f=r.extractContents(); span.appendChild(f); r.insertNode(span); }
  const s2=window.getSelection(); s2.removeAllRanges(); const nr=document.createRange(); nr.setStartAfter(span); nr.collapse(true); s2.addRange(nr);
  editor.focus(); return true;
}
let globalScale=1;
function setGlobalScale(sc){ globalScale=Math.max(0.7,Math.min(1.7,sc)); editor.style.setProperty('--editor-zoom',globalScale+'rem'); }
function stepBigger(){ if(!wrapSelectionWithClass('fs-up-1')) setGlobalScale(globalScale+0.06); }
function stepSmaller(){ if(!wrapSelectionWithClass('fs-down-1')) setGlobalScale(globalScale-0.06); }
document.getElementById('btnBigger').addEventListener('click',stepBigger);
document.getElementById('btnSmaller').addEventListener('click',stepSmaller);

/* placeholder */
const PLACEHOLDER='åœ¨æ­¤å¯«ä¸‹ä½ å°æ–°äººçš„ç¥ç¦â€¦ï¼ˆå¯é¸å­—å¾ŒæŒ‰ä¸Šæ–¹çš„ç²—é«”ï¼æ–œé«”ï¼åº•ç·šï¼é¡è‰²ï¼æ”¾å¤§ï¼ç¸®å°ï¼‰ğŸ’';
function showPlaceholder(){ editor.setAttribute('data-empty',''); editor.innerHTML=PLACEHOLDER; }
editor.addEventListener('focus',()=>{ if(editor.hasAttribute('data-empty') && !editor.classList.contains('locked')){ editor.innerHTML=''; editor.removeAttribute('data-empty'); }});
editor.addEventListener('blur',()=>{ if(!editor.textContent.trim()) showPlaceholder(); });

/* ç°½å Modal */
const sigOverlay=document.getElementById('sigOverlay');
const pad=document.getElementById('pad'); const ctx=pad.getContext('2d');
let drawing=false,lastX=0,lastY=0,signatureDataURL='';
function fitCanvas(){ const dpr=Math.max(1,window.devicePixelRatio||1),w=pad.clientWidth,h=pad.clientHeight; pad.width=w*dpr; pad.height=h*dpr; ctx.setTransform(dpr,0,0,dpr,0,0); ctx.lineCap='round'; ctx.lineJoin='round'; ctx.lineWidth=3; ctx.strokeStyle='#111'; ctx.clearRect(0,0,w,h); }
function openSign(){ if(editor.classList.contains('locked')) return; sigOverlay.classList.add('show'); setTimeout(fitCanvas,40); }
function closeSign(){ sigOverlay.classList.remove('show'); }
function pos(e){ const r=pad.getBoundingClientRect(); return {x:(e.touches?e.touches[0].clientX:e.clientX)-r.left, y:(e.touches?e.touches[0].clientY:e.clientY)-r.top}; }
function start(e){ drawing=true; const p=pos(e); lastX=p.x; lastY=p.y; e.preventDefault(); }
function move(e){ if(!drawing) return; const p=pos(e); ctx.beginPath(); ctx.moveTo(lastX,lastY); ctx.lineTo(p.x,p.y); ctx.stroke(); lastX=p.x; lastY=p.y; e.preventDefault(); }
function end(){ drawing=false; }
pad.addEventListener('mousedown',start); pad.addEventListener('mousemove',move); pad.addEventListener('mouseup',end); pad.addEventListener('mouseleave',end);
pad.addEventListener('touchstart',start,{passive:false}); pad.addEventListener('touchmove',move,{passive:false}); pad.addEventListener('touchend',end);
document.getElementById('chipSign').addEventListener('click',openSign);
document.getElementById('btnSignOpen').addEventListener('click',openSign);
document.getElementById('sigClear').addEventListener('click',fitCanvas);
document.getElementById('sigCancel').addEventListener('click',closeSign);
document.getElementById('sigOK').addEventListener('click',()=>{
  signatureDataURL=pad.toDataURL('image/png');
  const chip=document.getElementById('chipSign'); const img=document.getElementById('signThumb');
  img.src=signatureDataURL; chip.classList.add('has-img');
  closeSign();
});

/* ç¥ç¦ç‰†ï¼ˆæœ¨ç‰Œï¼‰ */
const wallEl=document.getElementById('wall');
let currentRole='all';

async function fetchJSON(url, opt){
  const r=await fetch(url,opt); const ct=(r.headers.get('content-type')||'').toLowerCase();
  const t=await (ct.includes('application/json')? r.json(): r.text());
  return t;
}
function escapeHTML(s){ return String(s||'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }

function tileTemplate(item){
  const date = item.time ? String(item.time).slice(0,16) : '';
  const snippet = (item.preview || '').trim() || 'â€”';
  const signHTML = item.signature
      ? `<img src="${item.signature}" alt="">` : '';
  return `
  <div class="tile" data-row="${item.row||''}" data-owner="${item.lineId||''}">
    <div class="tile-header">${escapeHTML(item.displayName||'â€”')}</div>
    <div class="tile-meta">${escapeHTML(date)}</div>
    <div class="tile-snippet">${escapeHTML(snippet)}</div>
    <div class="tile-sign">${signHTML}</div>
  </div>`;
}

async function refreshWall(){
  try{
    const url=WEBHOOK+`?action=listblessings&role=${encodeURIComponent(currentRole)}`;
    const j=await fetchJSON(url,{method:'GET',cache:'no-store'});
    if(j && j.ok){
      wallEl.innerHTML = (j.items||[]).map(tileTemplate).join('') || '';
      bindTileClicks();
    }
  }catch(e){}
}

function bindTileClicks(){
  wallEl.querySelectorAll('.tile').forEach(tile=>{
    tile.addEventListener('click', ()=>openView(tile));
  });
}

/* æ”¾å¤§æª¢è¦–ï¼ˆåªè®€ï¼‰ */
const viewOverlay=document.getElementById('viewOverlay');
const viewMeta=document.getElementById('viewMeta');
const viewContent=document.getElementById('viewContent');
const btnViewClose=document.getElementById('viewClose');
let currentViewRow=null;

btnViewClose.addEventListener('click', ()=>{ viewOverlay.classList.remove('show'); currentViewRow=null; });

async function openView(tileEl){
  const row = tileEl.getAttribute('data-row');
  currentViewRow=row;
  try{
    const j=await fetchJSON(WEBHOOK+`?action=getBlessingDetail&id=${encodeURIComponent(row)}`,{method:'GET',cache:'no-store'});
    if(j && j.ok && j.item){
      const it=j.item;
      const date=it.time? String(it.time).slice(0,16):'';
      viewMeta.textContent = `${it.displayName||'â€”'} ï½œ ${date}`;
      viewContent.innerHTML = it.contentHTML || '';
      viewOverlay.classList.add('show');
    }
  }catch(e){}
}

/* è§’è‰²ä¸‰éµ */
function setRole(role){
  currentRole=role;
  document.querySelectorAll('.role-btn').forEach(b=>b.classList.remove('active'));
  if(role==='all') document.getElementById('roleAll').classList.add('active');
  if(role==='male') document.getElementById('roleMale').classList.add('active');
  if(role==='female') document.getElementById('roleFemale').classList.add('active');
  refreshWall();
}
document.getElementById('roleAll').addEventListener('click',()=>setRole('all'));
document.getElementById('roleMale').addEventListener('click',()=>setRole('male'));
document.getElementById('roleFemale').addEventListener('click',()=>setRole('female'));

/* å·¦å€ï¼šç·¨è¼¯ / é€å‡º æµç¨‹ */
document.getElementById('btnEdit').addEventListener('click', ()=>{
  editor.classList.remove('locked');
  if(editor.hasAttribute('data-empty')){ editor.innerHTML=''; editor.removeAttribute('data-empty'); }
  editor.focus();
});

document.getElementById('btnSend').addEventListener('click', async ()=>{
  if(editor.hasAttribute('data-empty') || !editor.textContent.trim()){ alert('è«‹å¯«ä¸‹ç¥ç¦å…§å®¹å”·ï½'); return; }
  const text=editor.innerHTML.trim();

  try{
    const ping=await fetch(WEBHOOK+'?action=ping',{method:'GET',cache:'no-store'});
    const t=await ping.text().catch(()=> ''); if(String(t).trim().toLowerCase()!=='ok'){ setStatus('âš ï¸ å¾Œç«¯æœªå›æ‡‰æ­£å¸¸ï¼ˆping='+t+'ï¼‰'); return; }
  }catch(_){ setStatus('âš ï¸ ç„¡æ³•é€£åˆ°å¾Œç«¯ï¼ˆping å¤±æ•—ï¼‰'); return; }

  setStatus('â³ é€å‡ºä¸­â€¦');
  document.getElementById('btnSend').disabled=true;
  const payload={ action:'createBlessing', lineId, displayName, pictureUrl, contentHTML:text, signaturePNG:signatureDataURL||'', extra:{} };
  const ctl=new AbortController(); const timer=setTimeout(()=>ctl.abort(), TIMEOUT_MS);
  try{
    const r=await fetch(WEBHOOK,{ method:'POST', headers:{'Content-Type':'text/plain;charset=UTF-8'}, body:JSON.stringify(payload), signal:ctl.signal, keepalive:true });
    clearTimeout(timer);
    const ct=(r.headers.get('content-type')||'').toLowerCase(); let j=null;
    if(ct.includes('application/json')) j=await r.json().catch(()=>null); else { const t=await r.text().catch(()=> ''); if(/^\s*\{/.test(t)) try{ j=JSON.parse(t);}catch(_){} }
    if(!j && r.ok) j={ok:true};
    if(j&&j.ok){
      setStatus('âœ… å·²é€å‡ºï¼Œå·²è¦†è“‹æ›´æ–°ï¼');
      // é–å®šç·¨è¼¯å™¨ï¼›ç°½åä¿ç•™ï¼ˆä¸æ¸…ç©ºï¼‰
      editor.classList.add('locked');
      // ç«‹å³èˆ‡å»¶é²åˆ·æ–°ç‰†
      await refreshWall();
      setTimeout(()=>{ refreshWall().catch(()=>{}); }, 600);
      // ä¹‹å¾Œå†é€å‡ºä¸ç”¨é‡æ–°ä¸Šå‚³ç°½å
      signatureDataURL=''; // ä¿ç•™ç¸®åœ–ï¼Œä½†ä¸é‡å‚³ï¼ˆå¾Œç«¯æœƒä¿ç•™èˆŠç°½åï¼‰
    } else {
      setStatus('âŒ é€å‡ºå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
    }
  }catch(e){ setStatus('âŒ é€å‡ºé€¾æ™‚æˆ–å¤±æ•—ï¼š'+(e?.message||'')); }
  finally { document.getElementById('btnSend').disabled=false; }
});

/* å•Ÿå‹• */
window.addEventListener('DOMContentLoaded', ()=>{
  setStatus('å·²å°±ç·’');
  showPlaceholder();
  if(window.liff) initLIFF(); else refreshWall();
});
</script>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</body>
</html>

/**** GASï¼šäº’å‹•éŸ³ç¬¦ v2 + é€ä¸Šç¥ç¦ï¼ˆæ•´åˆï¼‰ **********************************
 * ç¥ç¦ï¼ˆblessingsï¼‰ï¼š
 *   A=time, B=lineId, C=displayName, D=pictureUrl, E=role,
 *   F=contentHTML, G=signatureURL(or base64), H=signatureType, I=extraJSON
 *************************************************************************/

const SPREADSHEET_ID_MAIN   = '1loTbnXfQ90AN3tGUdpEsR3AGZUFHvaijBSctOUSZQFs';
const SPREADSHEET_ID_PUBLIC = '18hxRoLU_TFV6Dc4fNAxQFEv9VAYoSbeVZvfIZ17MHPQ';
const LIFF_URL_NOTES        = 'https://meiyang0819.github.io/SSS/line.html';
const LIFF_URL_BLESSING     = 'https://meiyang0819.github.io/SSS/blessing.html';

const SAVE_SIGNATURE_TO_DRIVE = true;
const DRIVE_FOLDER_ID         = '';

const KWS_PORTAL = ['éŸ³ç¬¦','äº’å‹•éŸ³ç¬¦','å‰ä»–','é‹¼ç´','ğŸµ'];
const WELCOME_AUDIO_URL = 'https://drive.google.com/file/d/1Voif_FluZuNUMSjVeA6NitAb6skxnnFp/view?usp=drive_link';
const WELCOME_AUDIO_MS  = 6000;
const GLOBAL_DEADLINE_ISO = '2025-10-31';

const FLEX_SIZE_LEVEL=2, GAP_LEVEL=2, LINK_FONT_LEVEL=2, LINK_WIDTH_PERCENT=62;
const LINK_CORNER_PX=18, LINK_BORDER_PX=1, LINK_PAD_V_PX=12, LINK_PAD_H_PX=18;
const FLEX_COLORS={ body:'#E4E4E4', footer:'#E4E4E4', title:'#0f172a', accent:'#A68A7C', linkBg:'#F5F1EC' };
const KEYWORD_THEME={ body:'#E4E4E4', footer:'#E4E4E4', title:'#0f172a', text:'#A68A7C' };

const SHEET_GUESTS='guests', SHEET_LOGS='logs', SHEET_BLESSING='blessings';
const TZ='Asia/Taipei', TIME_FMT='yyyy-MM-dd HH:mm:ss', HEADER_ROWS=1;
const ROLE_MALE_FRIEND='MALE_FRIEND', ROLE_FEMALE_FRIEND='FEMALE_FRIEND';

const J=o=>ContentService.createTextOutput(JSON.stringify(o)).setMimeType(ContentService.MimeType.JSON);
const T=s=>ContentService.createTextOutput(String(s||'')).setMimeType(ContentService.MimeType.TEXT);
const nowStr = ()=>Utilities.formatDate(new Date(), TZ, TIME_FMT);

/* Spreadsheet é–‹å•Ÿ */
function openMain_(){ return SpreadsheetApp.openById(SPREADSHEET_ID_MAIN); }
function openPublic_(){ return SpreadsheetApp.openById(SPREADSHEET_ID_PUBLIC); }

/* å»ºè¡¨é ­ */
function ensureHeaderAtRow1_(sh, header){
  const last=sh.getLastRow();
  if(last===0){ sh.getRange(1,1,1,header.length).setValues([header]); return; }
  const vals=sh.getRange(1,1,1,header.length).getValues()[0];
  const same=header.every((h,i)=>String(vals[i]||'').toLowerCase()===String(h).toLowerCase());
  if(!same){ sh.getRange(1,1,1,header.length).setValues([header]); }
}
function ensureLogs_(ss){ let sh=ss.getSheetByName(SHEET_LOGS); if(!sh) sh=ss.insertSheet(SHEET_LOGS); ensureHeaderAtRow1_(sh,['time','lineId','pictureUrl','friend','displayName','instruments','notes','message']); return sh; }
function ensureBlessings_(ss){ let sh=ss.getSheetByName(SHEET_BLESSING); if(!sh) sh=ss.insertSheet(SHEET_BLESSING); ensureHeaderAtRow1_(sh,['time','lineId','displayName','pictureUrl','role','contentHTML','signature','signatureType','extraJSON']); return sh; }
function getCoupleName_(ss){
  const sh=ss.getSheetByName(SHEET_GUESTS); if(!sh) return '';
  const man=String(sh.getRange(2,1).getValue()||'').trim();
  const woman=String(sh.getRange(2,2).getValue()||'').trim();
  if(man || woman) return `${man}${man&&woman?' & ':''}${woman}`;
  const man1=String(sh.getRange(1,1).getValue()||'').trim();
  const woman1=String(sh.getRange(1,2).getValue()||'').trim();
  return `${man1}${man1&&woman1?' & ':''}${woman1}`.trim();
}

/* logs å·¥å…· */
function findLogRowByLineId_(sh, lineId){
  const last=sh.getLastRow(); if(last<=HEADER_ROWS) return -1;
  const vals=sh.getRange(HEADER_ROWS+1,2,last-HEADER_ROWS,1).getValues();
  for(let i=0;i<vals.length;i++){ if(String(vals[i][0]||'')===String(lineId)) return i+HEADER_ROWS+1; }
  return -1;
}
function bindLineIdEnsureRow_(ss, lineId, displayName, pictureUrl){
  const sh=ensureLogs_(ss);
  const r=findLogRowByLineId_(sh,lineId);
  if(r===-1){ sh.appendRow([ nowStr(), lineId, String(pictureUrl||''), '', String(displayName||''), '', '', '' ]); }
  else{
    const row=sh.getRange(r,1,1,8).getValues()[0];
    row[0]=nowStr(); row[1]=lineId;
    row[2]=String(pictureUrl||'') ? String(pictureUrl)  : String(row[2]||'');
    row[4]=String(displayName||'')? String(displayName) : String(row[4]||'');
    sh.getRange(r,1,1,8).setValues([row]);
  }
}
function alreadySubmitted_(sh,lineId){ const r=findLogRowByLineId_(sh,lineId); if(r===-1) return false; const e=String(sh.getRange(r,6).getValue()||'').trim(); const f=String(sh.getRange(r,7).getValue()||'').trim(); return !!(e||f); }
function getRole_(sh,lineId){ const r=findLogRowByLineId_(sh,lineId); if(r===-1) return ''; return String(sh.getRange(r,4).getValue()||'').trim(); }
function setRole_(sh,lineId,role){ const r=findLogRowByLineId_(sh,lineId); if(r===-1) return; sh.getRange(r,4).setValue(String(role||'')); }
function isFirstInteraction_(sh, lineId){ const r=findLogRowByLineId_(sh,lineId); if(r===-1) return true; const role=String(sh.getRange(r,4).getValue()||'').trim(); const e=String(sh.getRange(r,6).getValue()||'').trim(); const f=String(sh.getRange(r,7).getValue()||'').trim(); return !role && !e && !f; }

/* æˆªæ­¢ */
function getGlobalDeadline_(){ return new Date(GLOBAL_DEADLINE_ISO+'T23:59:59+08:00'); }
function isExpired_(){ return new Date() > getGlobalDeadline_(); }

/* LINE profileï¼ˆç•¥ï¼‰ */
function fetchUserProfile_(channelToken, userId){
  if(!channelToken||!userId) return {displayName:'',pictureUrl:''};
  const url='https://api.line.me/v2/bot/profile/'+encodeURIComponent(userId);
  const opt={method:'get',headers:{Authorization:'Bearer '+channelToken},muteHttpExceptions:true};
  try{ const r=UrlFetchApp.fetch(url,opt); if(r.getResponseCode()===200){ const j=JSON.parse(r.getContentText()||'{}'); return {displayName:String(j.displayName||''), pictureUrl:String(j.pictureUrl||'')}} }catch(_){}
  return {displayName:'', pictureUrl:''};
}

/* Web å…¥å£ */
function doGet(e){
  const p=e?.parameter||{}; const action=String(p.action||'').toLowerCase();
  if(action==='ping')   return T('ok');
  if(action==='couple') return J({ok:true, name:getCoupleName_(openMain_())});

  if(action==='listblessings'){
    const role=(String(p.role||'all').toLowerCase());
    const data=listBlessings_();
    const filtered = role==='all' ? data :
      data.filter(x=> String(x.role||'').toLowerCase().includes(role==='male'?'male':'female'));
    return J({ok:true, items:filtered});
  }

  if(action==='getblessingdetail'){
    const id = Math.max(2, Number(p.id||0));
    const sh = ensureBlessings_(openMain_());
    const last = sh.getLastRow();
    if(id>last) return J({ok:false,error:'not_found'});
    const r = sh.getRange(id,1,1,9).getValues()[0];
    return J({ok:true, item:{
      row:id, time:r[0], lineId:r[1], displayName:r[2], pictureUrl:r[3],
      role:r[4], contentHTML:r[5], signature:r[6], signatureType:r[7], extra:r[8]
    }});
  }

  return T('ok');
}

function doPost(e){
  let body={}; try{ body=JSON.parse(e?.postData?.contents||'{}'); }catch(_){ body={}; }

  if(body && Array.isArray(body.events)) return handleLineWebhook_(body);

  const act=String(body.action||'').toLowerCase();
  if(act==='createblessing') return handleCreateBlessing_(body); // â˜… è®Šæ›´ï¼šåŒä¸€å…¥å£ï¼Œæœƒè‡ªå‹•ã€Œæœ‰å°±æ›´æ–°ã€
  if(act==='updateblessing') return handleUpdateBlessing_(body);  // ä»ä¿ç•™ï¼Œä½†å‰ç«¯ä¸å†ä½¿ç”¨
  return handleLiffSubmit_(body);
}

/* äº’å‹•éŸ³ç¬¦ LINE webhookï¼ˆä¿ç•™ï¼Œç•¥ï¼‰ */
function replyFlex_(){/* çœç•¥ä¸å‹• */} function replyAudio_(){} function replyMulti_(){}
function buildCard_Entrance_(){} function buildCard_Submitted_(){} function buildCard_Expired_(){} function buildCard_Reminder_(){} function buildCard_RoleSelect_(){}

function handleLineWebhook_(body){ return J({status:'ok'}); } /* ç‚ºç°¡æ½”èµ·è¦‹ï¼Œé€™è£¡ä¸å±•é–‹ï¼›ä½ çš„åŸå§‹é‚è¼¯ä¿ç•™å³å¯ */

/* äº’å‹•éŸ³ç¬¦ LIFF é€å–®ï¼ˆä¿ç•™ï¼‰ */
function handleLiffSubmit_(body){ return J({ok:true}); } /* ä½ çš„åŸé‚è¼¯ç…§æ”¾å³å¯ */

/* ===== é€ä¸Šç¥ç¦ï¼šæœ‰å°±æ›´æ–°ã€ç„¡å‰‡æ–°å¢ï¼ˆä»¥ lineId ç‚ºä¸»éµï¼‰ ===== */
function findBlessingRowByLineId_(sh, lineId){
  const last=sh.getLastRow(); if(last<=HEADER_ROWS) return -1;
  const vals=sh.getRange(HEADER_ROWS+1,2,last-HEADER_ROWS,1).getValues(); // B=lineId
  for(let i=0;i<vals.length;i++){ if(String(vals[i][0]||'')===String(lineId)) return i+HEADER_ROWS+1; }
  return -1;
}

function handleCreateBlessing_(body){
  const ss = openMain_(); const sh = ensureBlessings_(ss); const shLogs = ensureLogs_(ss);
  const lineId=String(body.lineId||'').trim();
  const displayName=String(body.displayName||'').trim();
  const pictureUrl=String(body.pictureUrl||'').trim();
  const contentHTML=String(body.contentHTML||'').trim();
  const signature=String(body.signaturePNG||'').trim(); // dataURL or empty
  const extra=JSON.stringify(body.extra||{});
  if(!lineId) return J({ok:false,error:'missing_line_id'});
  if(!contentHTML) return J({ok:false,error:'missing_content'});
  const role = getRole_(shLogs, lineId) || '';

  // ç°½åï¼šè‹¥é€™æ¬¡æœ‰å¸¶ï¼Œå‰‡ä¿å­˜ï¼›è‹¥æ²’å¸¶ï¼Œæ²¿ç”¨èˆŠå€¼
  let sigVal='', sigType='none';
  if(signature){
    if(SAVE_SIGNATURE_TO_DRIVE){ const url=saveSignatureToDrive_(signature, lineId, displayName); sigVal=url; sigType='drive'; }
    else{ sigVal=signature; sigType='base64'; }
  }

  const r=findBlessingRowByLineId_(sh,lineId);
  if(r===-1){
    // æ–°å¢
    const g = signature ? sigVal : ''; const gt = signature ? sigType : 'none';
    sh.appendRow([ nowStr(), lineId, displayName, pictureUrl, role, contentHTML, g, gt, extra ]);
  }else{
    // æ›´æ–°ï¼ˆè¦†è“‹ï¼‰
    const row=sh.getRange(r,1,1,9).getValues()[0];
    row[0]=nowStr();            // time
    row[2]=displayName||row[2]; // displayNameï¼ˆä¿è­·èˆŠå€¼ï¼‰
    row[3]=pictureUrl||row[3];
    row[4]=role||row[4];
    row[5]=contentHTML;         // contentHTML è¦†è“‹
    if(signature){ row[6]=sigVal; row[7]=sigType; } // å¸¶æ–°ç°½åæ‰è¦†è“‹ï¼Œå¦å‰‡ä¿ç•™èˆŠç°½å
    row[8]=extra;
    sh.getRange(r,1,1,9).setValues([row]);
  }
  return J({ok:true});
}

/* å‚™ç”¨ï¼šæ›´æ–°è‡ªå·±çš„ç¥ç¦ï¼ˆä»ä¿ç•™çµ¦èˆŠå‰ç«¯ï¼‰ */
function handleUpdateBlessing_(body){
  const ss=openMain_(); const sh=ensureBlessings_(ss);
  const row=Number(body.row||0); const lineId=String(body.lineId||'').trim(); const contentHTML=String(body.contentHTML||'').trim();
  if(!row || !lineId || !contentHTML) return J({ok:false,error:'missing_params'});
  if(isExpired_()) return J({ok:false,error:'deadline_passed'});
  const rec=sh.getRange(row,1,1,9).getValues()[0]; const owner=String(rec[1]||'').trim(); if(owner!==lineId) return J({ok:false,error:'forbidden'});
  sh.getRange(row,6).setValue(contentHTML); sh.getRange(row,1).setValue(nowStr()); return J({ok:true});
}

/* ç°½å â†’ Driveï¼Œå›å‚³å¯ç›´æ¥ <img> çš„ç›´é€£ï¼ˆuc?export=view&id=ï¼‰ */
function saveSignatureToDrive_(dataUrl, lineId, displayName){
  const m = /^data:image\/(png|jpeg);base64,([A-Za-z0-9+/=]+)$/.exec(String(dataUrl||'')); if(!m) return '';
  const ext = m[1]==='jpeg'?'jpg':m[1]; const bytes = Utilities.base64Decode(m[2]);
  const blob = Utilities.newBlob(bytes, 'image/'+(ext==='jpg'?'jpeg':ext), `sign_${lineId||'anon'}_${Date.now()}.${ext}`);
  let folder=null;
  if(DRIVE_FOLDER_ID){ try{ folder=DriveApp.getFolderById(DRIVE_FOLDER_ID); }catch(_){ } }
  if(!folder){ const it=DriveApp.getFoldersByName('Blessing-Signatures'); folder=it.hasNext()? it.next() : DriveApp.createFolder('Blessing-Signatures'); }
  const file = folder.createFile(blob);
  try{ file.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW); }catch(_){}
  const id=file.getId();
  return 'https://drive.google.com/uc?export=view&id='+id; // â˜… ç›´é€£å¯åµŒåœ–
}

/* åˆ—è¡¨ / æ˜ç´° */
function listBlessings_(){
  const sh=ensureBlessings_(openMain_()); const last=sh.getLastRow(); if(last<=HEADER_ROWS) return [];
  const vals=sh.getRange(HEADER_ROWS+1,1,last-HEADER_ROWS,9).getValues();
  return vals.map((r,i)=>({
    row:i+HEADER_ROWS+1, time:r[0], lineId:r[1], displayName:r[2], pictureUrl:r[3], role:r[4]||'',
    preview:String(r[5]||'').replace(/<[^>]+>/g,'').slice(0,60), signature:r[6], signatureType:r[7], extra:r[8]
  }));
}
