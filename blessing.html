//******************************* åŒå¿ƒç¥ˆé¡˜ + äº’å‹•éŸ³ç¬¦ *******************************//
//* è©¦ç®—è¡¨å·¥ä½œè¡¨ï¼ˆä¸»æœ¬ / å‰¯æœ¬çµæ§‹ç›¸åŒï¼‰ *//
//*  - guests: A=man(æ–°éƒ), B=woman(æ–°å¨˜), C=deadline(å¯é¸) *//
//*  - logs  : A=time, B=lineId, C=pictureUrl, D=friend(role), *//
//*            E=displayName, F=instruments, G=notes *//
//*  - blessings: *//
//*      A=time, B=lineId, C=displayName, D=pictureUrl, E=role, *//
//*      F=contentHTML(å¯¦éš›å­˜ç´”æ–‡å­—), G=signature, H=signatureType, I=extraJSON *//
//*******************************************************************************//

/** â”€â”€ æœ€å°åŒ–ï¼šLINE Verify å°ˆç”¨ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ **/
// â˜… åˆä½µç‚ºå”¯ä¸€çš„ doPostï¼šåŒæ™‚æ»¿è¶³ Verifyï¼ˆç«‹å³ 200ï¼‰èˆ‡å‰ç«¯/Webhook åˆ†æµ
function doPost(e){
  try{
    // å…ˆè§£æ bodyï¼ˆæ²’æœ‰å°±çµ¦ç©ºç‰©ä»¶ï¼‰
    var body = {};
    try{ body = JSON.parse(e && e.postData && e.postData.contents || '{}'); }catch(_){ body = {}; }

    // 1) LINE Webhookï¼ˆäº’å‹•éŸ³ç¬¦ + åŒå¿ƒç¥ˆé¡˜å…¥å£ï¼‰
    if (body && Array.isArray(body.events)) {
      return handleLineWebhook_(body); // ç›´æ¥å› JSONï¼›LINE åªè¦æ±‚ 200 å³å¯
    }

    // 2) å‰ç«¯/LIFF çš„ action åˆ†æµï¼ˆç¶­æŒä½ åŸæœ¬çš„æµç¨‹ï¼‰
    var act = String(body.action || '').toLowerCase();
    if (act === 'createblessing') return handleCreateBlessing_(body);
    if (act === 'updateblessing') return handleUpdateBlessing_(body);
    if (act === 'submitnotes')    return handleLiffSubmit_(body);

    // 3) æœªçŸ¥æƒ…å¢ƒï¼šä»å› 200ï¼Œé¿å… Verify é€¾æ™‚/302
    return J({ok:true});
  }catch(err){
    return J({ok:false, error: String(err)});
  }
}
/** â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ **/

//* ==================== å¿…æ”¹åƒæ•¸ï¼ˆè«‹å¡«ä½ è‡ªå·±çš„ï¼‰ ==================== *//
const SPREADSHEET_ID_MAIN   = '1loTbnXfQ90AN3tGUdpEsR3AGZUFHvaijBSctOUSZQFs'; // ä¸»æœ¬ï¼šGoogle è©¦ç®—è¡¨ IDï¼ˆå¿…å¡«ï¼‰
const SPREADSHEET_ID_PUBLIC = '18hxRoLU_TFV6Dc4fNAxQFEv9VAYoSbeVZvfIZ17MHPQ'; // å‰¯æœ¬ï¼ˆå…¬é–‹ï¼‰ï¼šGoogle è©¦ç®—è¡¨ IDï¼ˆå¿…å¡«ï¼‰

//* è‹¥ä½ åŒæ™‚ç”¨ã€Œäº’å‹•éŸ³ç¬¦ã€é ï¼Œä¹Ÿè«‹åœ¨ LINE Bot çš„ Script Properties æ”¾å…¥ CHANNEL_TOKEN *//
const LIFF_URL_NOTES        = 'https://liff.line.me/2008149060-ZGVdAvGo';     // äº’å‹•éŸ³ç¬¦ LIFFï¼ˆä½¿ç”¨è€…é€²å…¥é»ï¼‰
const LIFF_URL_BLESSING     = 'https://liff.line.me/2008149060-Djoe6jKp';     // åŒå¿ƒç¥ˆé¡˜ LIFFï¼ˆè—è‰²ï¼›ä½¿ç”¨è€…é€²å…¥é»ï¼‰

//* ç°½åæª”å­˜æ³•ï¼štrue=å­˜åˆ°é›²ç«¯ç¡¬ç¢Ÿä¸¦åœ¨è¡¨å¯« URLï¼›false=ç›´æ¥æŠŠ base64 å­˜è¡¨ *//
const SAVE_SIGNATURE_TO_DRIVE = true;  // trueï¼šå°‡ç°½ååœ–ç‰‡å­˜åˆ° Google Driveï¼›falseï¼šç›´æ¥æŠŠ base64 æ–‡å­—å¯«é€²è¡¨
const DRIVE_FOLDER_ID         = '';    // æŒ‡å®šè³‡æ–™å¤¾ IDï¼›ç•™ç©ºï¼è‡ªå‹•å»ºç«‹ã€ŒBlessing-Signaturesã€ä¸¦é–‹æ”¾ã€ŒæŒé€£çµè€…å¯é–±ã€

//* é—œéµå­—è§¸ç™¼ï¼ˆå…©çµ„åˆ†é–‹ï¼‰ *//
const KWS_PORTAL_NOTES  = ['äº’å‹•','éŸ³ç¬¦','ğŸµ']; // è§¸ç™¼ã€Œäº’å‹•éŸ³ç¬¦ã€å…¥å£çš„é—œéµå­—é™£åˆ—
const KWS_PORTAL_BLESS  = ['ç¥ç¦','ç¥ˆé¡˜','ğŸ“']; // è§¸ç™¼ã€ŒåŒå¿ƒç¥ˆé¡˜ã€å…¥å£çš„é—œéµå­—é™£åˆ—

//* æ­¡è¿éŸ³æª”ï¼ˆäº’å‹•éŸ³ç¬¦ï¼‰ *//
const WELCOME_AUDIO_URL = 'https://drive.google.com/file/d/1Voif_FluZuNUMSjVeA6NitAb6skxnnFp/view?usp=drive_link'; // åŠ å¥½å‹æ™‚è¦æ’­æ”¾çš„éŸ³æª”ï¼ˆåˆ†äº«é€£çµæˆ–æª”æ¡ˆ IDï¼‰
/* const WELCOME_AUDIO_URL ä¹Ÿå¯å¡«ã€Œæª”æ¡ˆIDã€ï¼Œæœ¬æª”æœƒè‡ªå‹•è½‰æˆç›´é€£ï¼ˆtoDirectDriveUrl_ï¼‰ */
const WELCOME_AUDIO_MS  = 19000; // æ’­æ”¾é•·åº¦ï¼ˆæ¯«ç§’ï¼‰ï¼Œâ˜… é€™è£¡è¨­å®šç‚º 19 ç§’

//* å…¨å±€æˆªæ­¢æ—¥ï¼ˆåˆ°ç•¶æ—¥ 23:59:59ï¼Œå°åŒ—æ™‚å€ï¼‰ *//
const GLOBAL_DEADLINE_ISO = '2025-10-31'; // ä¾‹ï¼š2025-10-31 ä»£è¡¨ç•¶å¤©çš„ 23:59:59 +08:00 æœƒæˆªæ­¢

//* Flex ä¸»é¡Œï¼ˆä¸€èˆ¬ / ç¥ç¦ / æé†’ï¼‰ *//
const FLEX_COLORS = { 
  body:'#E4E4E4',    // å…§å®¹å€èƒŒæ™¯ï¼ˆä¸€èˆ¬å¡ï¼‰ï¼é¡è‰²å¯èª¿
  footer:'#E4E4E4',  // åº•éƒ¨å€èƒŒæ™¯ï¼ˆä¸€èˆ¬å¡ï¼‰ï¼é¡è‰²å¯èª¿
  title:'#0f172a',   // æ¨™é¡Œæ–‡å­—è‰²ï¼ˆä¸€èˆ¬å¡ï¼‰ï¼é¡è‰²å¯èª¿
  accent:'#A68A7C',  // é‡é»è‰²/é‚Šæ¡†è‰²ï¼ˆä¸€èˆ¬å¡ï¼‰ï¼é¡è‰²å¯èª¿
  linkBg:'#F5F1EC'   // é€£çµæŒ‰éˆ•åº•è‰²ï¼ˆä¸€èˆ¬å¡ï¼‰ï¼é¡è‰²å¯èª¿
};

const BLESS_THEME = { 
  body:'#c9daf8',    // å…§å®¹å€èƒŒæ™¯ï¼ˆç¥ç¦å¡ï¼‰ï¼é¡è‰²å¯èª¿
  footer:'#c9daf8',  // åº•éƒ¨å€èƒŒæ™¯ï¼ˆç¥ç¦å¡ï¼‰ï¼é¡è‰²å¯èª¿
  title:'#0f172a',   // æ¨™é¡Œæ–‡å­—è‰²ï¼ˆç¥ç¦å¡ï¼‰ï¼é¡è‰²å¯èª¿
  text:'#0f172a',    // å…§å®¹æ–‡å­—è‰²ï¼ˆç¥ç¦å¡ï¼‰ï¼é¡è‰²å¯èª¿
  linkBg:'#F5F1EC'   // é€£çµæŒ‰éˆ•åº•è‰²ï¼ˆç¥ç¦å¡ï¼‰ï¼é¡è‰²å¯èª¿
};

const ALERT_THEME = { 
  body:'#FDE7EA',    // å…§å®¹å€èƒŒæ™¯ï¼ˆæé†’/è­¦ç¤ºå¡ï¼‰ï¼é¡è‰²å¯èª¿
  footer:'#FDE7EA',  // åº•éƒ¨å€èƒŒæ™¯ï¼ˆæé†’/è­¦ç¤ºå¡ï¼‰ï¼é¡è‰²å¯èª¿
  title:'#7A1D2A',   // æ¨™é¡Œæ–‡å­—è‰²ï¼ˆæé†’/è­¦ç¤ºå¡ï¼‰ï¼é¡è‰²å¯èª¿
  text:'#7A1D2A',    // å…§å®¹æ–‡å­—è‰²ï¼ˆæé†’/è­¦ç¤ºå¡ï¼‰ï¼é¡è‰²å¯èª¿
  linkBg:'#FFF1F3'   // é€£çµæŒ‰éˆ•åº•è‰²ï¼ˆæé†’/è­¦ç¤ºå¡ï¼‰ï¼é¡è‰²å¯èª¿
};

const SHEET_GUESTS   = 'guests';     // å·¥ä½œè¡¨åç¨±ï¼šæ–°äººå§“å
const SHEET_LOGS     = 'logs';       // å·¥ä½œè¡¨åç¨±ï¼šäº’å‹•éŸ³ç¬¦ç´€éŒ„ / ç¶å®šè³‡è¨Š
const SHEET_BLESSING = 'blessings';  // å·¥ä½œè¡¨åç¨±ï¼šåŒå¿ƒç¥ˆé¡˜ç´€éŒ„

const TZ           = 'Asia/Taipei';             // ä¼ºæœå™¨æ™‚å€è¨­å®šï¼ˆå°åŒ—ï¼‰
const TIME_FMT     = 'yyyy-MM-dd HH:mm:ss';     // è¼¸å‡ºæ™‚é–“æ ¼å¼
const HEADER_ROWS  = 1;                         // è¡¨é ­åˆ—æ•¸ï¼ˆå›ºå®šç‚ºç¬¬ 1 åˆ—ï¼‰

const ROLE_MALE_FRIEND   = 'MALE_FRIEND';       // è§’è‰²ä»£ç¢¼ï¼šç”·æ–¹è¦ªå‹
const ROLE_FEMALE_FRIEND = 'FEMALE_FRIEND';     // è§’è‰²ä»£ç¢¼ï¼šå¥³æ–¹è¦ªå‹

//* å¿«æ· *//
const J = (o)=>ContentService.createTextOutput(JSON.stringify(o)).setMimeType(ContentService.MimeType.JSON); // å›å‚³ JSON
const T = (s)=>ContentService.createTextOutput(String(s||'')).setMimeType(ContentService.MimeType.TEXT);     // å›å‚³ç´”æ–‡å­—
const nowStr = ()=>Utilities.formatDate(new Date(), TZ, TIME_FMT);                                           // å–å¾—å°åŒ—æ™‚å€çš„ç¾åœ¨å­—ä¸²

//* ==================== å·¥å…·ï¼šDrive ç›´é€£è½‰æ›ï¼ˆfor LINE audioï¼‰ ==================== *//
//* å°‡ Google Drive æª”æ¡ˆã€Œé è¦½/åˆ†äº«ã€ç¶²å€æˆ–æª”æ¡ˆID â†’ ç›´é€£ä¸‹è¼‰ç¶²å€ï¼ˆuc?export=download&id=...ï¼‰ *//
function toDirectDriveUrl_(urlOrId){ // â˜… å°‡åˆ†äº«é€£çµæˆ–æª”æ¡ˆ ID è½‰ç‚ºå¯ä¾› LINE éŸ³è¨Šæ’­æ”¾çš„ç›´é€£ URL
  const s = String(urlOrId||'').trim();
  if(!s) return '';
  // è‹¥ç›´æ¥çµ¦ ID
  if(!/^https?:\/\//i.test(s)){
    return 'https://drive.google.com/uc?export=download&id=' + encodeURIComponent(s); // ç”±æª”æ¡ˆ ID çµ„ç›´é€£
  }
  // ä¸€èˆ¬åˆ†äº«/é è¦½ç¶²å€æŠ½ ID
  const m1 = s.match(/\/d\/([A-Za-z0-9_-]{25,})/);     // åŒ¹é… /d/{id}/ å½¢å¼
  const m2 = s.match(/[?&]id=([A-Za-z0-9_-]{25,})/);   // åŒ¹é… ?id={id} å½¢å¼
  const m3 = s.match(/\/([A-Za-z0-9_-]{25,})(?:[/?#]|$)/); // å…¶ä»–å¯èƒ½å½¢å¼
  const id = (m1 && m1[1]) || (m2 && m2[1]) || (m3 && m3[1]) || '';
  return id ? ('https://drive.google.com/uc?export=download&id=' + id) : s; // æœ‰æŠ“åˆ° ID å°±è½‰ç›´é€£ï¼Œå¦å‰‡å›åŸå­—ä¸²
}

//* ========== é–‹è¡¨/è¡¨é ­ ========== *//
function openMain_(){   return SpreadsheetApp.openById(SPREADSHEET_ID_MAIN); }   // é–‹ä¸»æœ¬
function openPublic_(){ return SpreadsheetApp.openById(SPREADSHEET_ID_PUBLIC); } // é–‹å‰¯æœ¬ï¼ˆå…¬é–‹ï¼‰

//* â˜… å¼·åŒ–ï¼šç¬¬ 1 åˆ—è‹¥å…¨ç©º / é•·åº¦ä¸ç¬¦ / å…§å®¹ä¸ç¬¦ â†’ ç›´æ¥é‡å¯«è¡¨é ­ *//
function ensureHeaderAtRow1_(sh, expectedHeader){
  const last = sh.getLastRow();
  let needWrite = false;

  if (last === 0) { // å°šç„¡ä»»ä½•åˆ—
    needWrite = true;
  } else {
    const rng = sh.getRange(1, 1, 1, expectedHeader.length);
    const vals = rng.getValues()[0];
    const allEmpty = vals.every(v => String(v||'').trim() === '');                                // åˆ¤æ–·æ˜¯å¦æ•´åˆ—ç©ºç™½
    const same = expectedHeader.every((h,i)=> String(vals[i]||'').toLowerCase() === String(h).toLowerCase()); // åˆ¤æ–·è¡¨é ­æ˜¯å¦ç›¸åŒï¼ˆä¸åˆ†å¤§å°å¯«ï¼‰
    if (allEmpty || !same) needWrite = true;
  }

  if (needWrite) {
    sh.getRange(1,1,1,expectedHeader.length).setValues([expectedHeader]); // è¦†å¯«ç¬¬ 1 åˆ—ç‚ºæœŸæœ›è¡¨é ­
  }
}

function ensureLogs_(ss){
  let sh=ss.getSheetByName(SHEET_LOGS); if(!sh) sh=ss.insertSheet(SHEET_LOGS); // è‹¥ç„¡ logs è¡¨å‰‡å»ºç«‹
  const header=['time','lineId','pictureUrl','friend','displayName','instruments','notes']; // ç§»é™¤ message æ¬„ï¼ˆå›ºå®š 7 æ¬„ï¼‰
  ensureHeaderAtRow1_(sh, header);
  return sh;
}
function ensureBlessings_(ss){
  let sh=ss.getSheetByName(SHEET_BLESSING); if(!sh) sh=ss.insertSheet(SHEET_BLESSING); // è‹¥ç„¡ blessings è¡¨å‰‡å»ºç«‹
  const header=['time','lineId','displayName','pictureUrl','role','contentHTML','signature','signatureType','extraJSON']; // A~I å›ºå®šï¼ˆ9 æ¬„ï¼‰
  ensureHeaderAtRow1_(sh, header);
  return sh;
}

//* è®€ guestsï¼šå›å‚³æ–°éƒ/æ–°å¨˜åå­— *//
function getGuests_(ss){
  const sh = ss.getSheetByName(SHEET_GUESTS);
  if(!sh) return {man:'',woman:''};
  // å…ˆè®€ç¬¬2åˆ—ï¼Œè‹¥ç„¡å‰‡è®€ç¬¬1åˆ—ï¼ˆå…è¨±ä½¿ç”¨è€…åªå¡«ç¬¬ä¸€åˆ—ï¼‰
  const man = String(sh.getRange(2,1).getValue()||sh.getRange(1,1).getValue()||'').trim();
  const woman = String(sh.getRange(2,2).getValue()||sh.getRange(1,2).getValue()||'').trim();
  return {man, woman};
}

//* ========== logs å·¥å…· ========== *//
function findLogRowByLineId_(sh, lineId){
  const last=sh.getLastRow(); if(last<=HEADER_ROWS) return -1; // ç„¡è³‡æ–™
  const vals=sh.getRange(HEADER_ROWS+1,2,last-HEADER_ROWS,1).getValues(); // B æ¬„ï¼ˆlineIdï¼‰
  for(let i=0;i<vals.length;i++){ if(String(vals[i][0]||'')===String(lineId)) return i+HEADER_ROWS+1; } // æ‰¾åˆ°å›å‚³åˆ—è™Ÿ
  return -1;
}
function bindLineIdEnsureRow_(ss, lineId, displayName, pictureUrl){
  const sh=ensureLogs_(ss);
  const r=findLogRowByLineId_(sh,lineId);
  if(r===-1){
    sh.appendRow([ nowStr(), lineId, String(pictureUrl||''), '', String(displayName||''), '', '' ]); // æ–°å¢ä¸€åˆ—ï¼ˆ7 æ¬„ï¼‰
  }else{
    const row=sh.getRange(r,1,1,7).getValues()[0]; // è®€åŸåˆ—ï¼ˆ7 æ¬„ï¼‰
    row[0]=nowStr(); row[1]=lineId;
    row[2]=String(pictureUrl||'') ? String(pictureUrl)  : String(row[2]||''); // æœ‰æ–°é ­åƒæ‰è¦†è“‹
    row[4]=String(displayName||'')? String(displayName) : String(row[4]||''); // æœ‰æ–°æš±ç¨±æ‰è¦†è“‹
    sh.getRange(r,1,1,7).setValues([row]); // å›å¯«
  }
}
function alreadySubmitted_(sh,lineId){
  const r=findLogRowByLineId_(sh,lineId); if(r===-1) return false;
  const e=String(sh.getRange(r,6).getValue()||'').trim(); // F=instruments
  const f=String(sh.getRange(r,7).getValue()||'').trim(); // G=notes
  return !!(e||f); // ä»»ä¸€æ¬„æœ‰å€¼è¦–ç‚ºå·²é€å‡º
}
function getRole_(sh,lineId){ const r=findLogRowByLineId_(sh,lineId); if(r===-1) return ''; return String(sh.getRange(r,4).getValue()||'').trim(); } // è®€å–è§’è‰²ä»£ç¢¼
function setRole_(sh,lineId,role){ const r=findLogRowByLineId_(sh,lineId); if(r===-1) return; sh.getRange(r,4).setValue(String(role||'')); } // è¨­å®šè§’è‰²ä»£ç¢¼
function isFirstInteraction_(sh, lineId){
  const r=findLogRowByLineId_(sh,lineId);
  if(r===-1) return true;
  const role=String(sh.getRange(r,4).getValue()||'').trim();
  const e=String(sh.getRange(r,6).getValue()||'').trim();
  const f=String(sh.getRange(r,7).getValue()||'').trim();
  return !role && !e && !f; // æœªè¨­å®šè§’è‰²ä¸”æœªé€å‡ºä»»ä½•è³‡æ–™ï¼Œè¦–ç‚ºç¬¬ä¸€æ¬¡äº’å‹•
}

//* ========== æ™‚é–“/æˆªæ­¢ ========== *//
function getGlobalDeadline_(){ return new Date(GLOBAL_DEADLINE_ISO+'T23:59:59+08:00'); } // å°‡æ—¥æœŸå­—ä¸²è£œä¸Šç•¶æ—¥ 23:59:59 +08:00
function isExpired_(){ return new Date() > getGlobalDeadline_(); }                              // åˆ¤æ–·æ˜¯å¦é€¾æœŸ

//* ========== Flex å·¥å…· ========== *//
function hexToRgb_(hex){ const m=/^#?([a-fA-F0-9]{6})$/.exec((hex||'').trim()); const n=m?parseInt(m[1],16):0xE4E4E4; return {r:(n>>16)&255,g:(n>>8)&255,b:n&255}; } // HEX è½‰ RGB
function blendHex_(fgHex,bgHex,alpha){ const f=hexToRgb_(fgHex), b=hexToRgb_(bgHex); const r=Math.round(f.r*alpha+b.r*(1-alpha)), g=Math.round(f.g*alpha+b.g*(1-alpha)), bl=Math.round(f.b*alpha+b.b*(1-alpha)); return '#'+[r,g,bl].map(v=>v.toString(16).padStart(2,'0')).join(''); } // å‰æ™¯/èƒŒæ™¯æ··è‰²
const FLEX_SIZE='kilo', GAP='md', FONT='md'; // Flex è¨­è¨ˆå®šå€¼ï¼šå°ºå¯¸/é–“è·/å­—ç´š
function buildLinkChip_(uri,label,bgHex){
  return { type:'box', layout:'horizontal', contents:[
    { type:'filler', flex:19 },
    { type:'box', layout:'vertical', flex:62, backgroundColor:bgHex, cornerRadius:'18px',
      borderColor:FLEX_COLORS.accent, borderWidth:'1px', paddingTop:'12px', paddingBottom:'12px', paddingStart:'18px', paddingEnd:'18px',
      action:{ type:'uri', uri:String(uri) },
      contents:[{ type:'text', text:String(label||'ğŸ›ï¸ é»æˆ‘é»æˆ‘'), size:FONT, weight:'bold', color:FLEX_COLORS.accent, align:'center', wrap:true }] }
    ,
    { type:'filler', flex:19 }
  ]};
}
function buildThemedTextCard_(lines, theme){
  const sep=blendHex_(theme.text||'#0f172a', theme.body||'#E4E4E4', .5);
  return { type:'flex', altText:'é€šçŸ¥', contents:{
    type:'bubble', size:FLEX_SIZE, styles:{body:{backgroundColor:theme.body},footer:{backgroundColor:theme.footer}},
    body:{ type:'box', layout:'vertical', paddingAll:'15px', spacing:GAP, contents:[
      { type:'text', text:'ğŸ¤µğŸ»æ–°äººğŸ‘°ğŸ»â€â™€ï¸', weight:'bold', size:'lg', color:theme.title, align:'center', wrap:true },
      { type:'separator', color:sep, margin:'md' },
      ...lines.map((t,i)=>({ type:'text', text:t, size:'md', weight:'bold', color:theme.text||theme.accent||'#0f172a', align:'center', wrap:true, margin:i===0?'md':GAP }))
    ]}
  }};
}
function buildCard_Entrance_(roleLabel){
  return { type:'flex', altText:'ğŸ›ï¸ é»æˆ‘é»æˆ‘', contents:{
    type:'bubble', size:FLEX_SIZE,
    styles:{ body:{backgroundColor:FLEX_COLORS.body}, footer:{backgroundColor:FLEX_COLORS.footer} },
    body:{ type:'box', layout:'vertical', paddingAll:'15px', spacing:GAP, contents:[
      { type:'text', text:'ğŸ¤µğŸ»æ–°äººğŸ‘°ğŸ»â€â™€ï¸', weight:'bold', size:'lg', color:FLEX_COLORS.title, align:'center', wrap:true },
      { type:'separator', color:blendHex_(FLEX_COLORS.accent,FLEX_COLORS.body,.5), margin:'md' },
      { type:'text', text:`è¦ªæ„›çš„${roleLabel}è¦ªå‹ğŸ‘‹`, size:'md', weight:'bold', color:FLEX_COLORS.accent, align:'center', wrap:true, margin:'md' },
      { type:'text', text:'å¿«å¿«é»é€£çµä¾†ç©è€ğŸ‘£',      size:'md', weight:'bold', color:FLEX_COLORS.accent, align:'center', wrap:true, margin:GAP }
    ]},
    footer:{ type:'box', layout:'vertical', contents:[ buildLinkChip_(LIFF_URL_NOTES,'ğŸ›ï¸ é»æˆ‘é»æˆ‘', FLEX_COLORS.linkBg) ], backgroundColor:FLEX_COLORS.footer }
  }};
}
function buildCard_BlessingEntrance_(roleLabel){
  return { type:'flex', altText:'ğŸ”” é¸æˆ‘é¸æˆ‘', contents:{
    type:'bubble', size:FLEX_SIZE,
    styles:{ body:{backgroundColor:BLESS_THEME.body}, footer:{backgroundColor:BLESS_THEME.footer} },
    body:{ type:'box', layout:'vertical', paddingAll:'15px', spacing:GAP, contents:[
      { type:'text', text:'ğŸ¤µğŸ»æ–°äººğŸ‘°ğŸ»â€â™€ï¸', weight:'bold', size:'lg', color:BLESS_THEME.title, align:'center', wrap:true },
      { type:'separator', color:blendHex_(BLESS_THEME.text,BLESS_THEME.body,.5), margin:'md' },
      { type:'text', text:`è¦ªæ„›çš„${roleLabel}è¦ªå‹ğŸ‘‹`, size:'md', weight:'bold', color:BLESS_THEME.text, align:'center', wrap:true, margin:'md' },
      { type:'text', text:'å¿«å¿«é»é€£çµä¾†å‘Šç™½ğŸ“£',       size:'md', weight:'bold', color:BLESS_THEME.text, align:'center', wrap:true, margin:GAP }
    ]},
    footer:{ type:'box', layout:'vertical', contents:[ buildLinkChip_(LIFF_URL_BLESSING,'ğŸ”” é¸æˆ‘é¸æˆ‘', BLESS_THEME.linkBg) ], backgroundColor:BLESS_THEME.footer }
  }};
}
function buildCard_RoleSelect_(){
  return { type:'flex', altText:'å—¨å—¨ï¼Œä½ /å¦³æ˜¯...æˆ‘çš„', contents:{
    type:'bubble', size:FLEX_SIZE,
    styles:{ body:{backgroundColor:'#FFF7D6'}, footer:{backgroundColor:FLEX_COLORS.footer} },
    body:{ type:'box', layout:'vertical', paddingAll:'15px', spacing:GAP, contents:[
      { type:'text', text:'å—¨å—¨ï¼Œä½ /å¦³æ˜¯...æˆ‘çš„', weight:'bold', size:'lg', color:FLEX_COLORS.title, align:'center' },
      { type:'box', layout:'horizontal', spacing:'md', margin:'lg', contents:[
        { type:'box', layout:'vertical', flex:1, backgroundColor:FLEX_COLORS.linkBg, cornerRadius:'18px', borderColor:FLEX_COLORS.accent, borderWidth:'1px',
          paddingAll:'12px', action:{ type:'postback', data:'role=male', displayText:'ğŸ¤µğŸ»è¦ªå‹' },
          contents:[{ type:'text', text:'ğŸ¤µğŸ»è¦ªå‹', size:'md', weight:'bold', color:FLEX_COLORS.accent, align:'center' }] }
        ,
        { type:'box', layout:'vertical', flex:1, backgroundColor:FLEX_COLORS.linkBg, cornerRadius:'18px', borderColor:FLEX_COLORS.accent, borderWidth:'1px',
          paddingAll:'12px', action:{ type:'postback', data:'role=female', displayText:'ğŸ‘°ğŸ»â€â™€ï¸è¦ªå‹' },
          contents:[{ type:'text', text:'ğŸ‘°ğŸ»â€â™€ï¸è¦ªå‹', size:'md', weight:'bold', color:FLEX_COLORS.accent, align:'center' }] }
      ]}
    ]}
  }};
}
function buildCard_Reminder_(){
  return buildThemedTextCard_(['ğŸ“æé†’ğŸ“','å› å¾Œå°è³‡æ–™éæ–¼é¾å¤§','å›è¦†æœƒæœ‰é»ç•¥æ…¢å‡ºä¾†','å†éº»ç…©è¦ªå‹å€‘å¤šæ“”å¾…'], ALERT_THEME); // æé†’ç”¨å¡ç‰‡
}
function buildCard_NoticeBusy_(){
  return buildThemedTextCard_(['ğŸ“é€šçŸ¥ğŸ“','ç®¡ç†å“¡æ­£åœ¨å¿™ç¢Œä¸­','ä»–çœ‹åˆ°æœƒç«‹å³å›è¦†','é‚„è«‹è¦ªå‹å¤šå¤šåŒ…æ¶µ'], ALERT_THEME); // å¿™ç¢Œé€šçŸ¥å¡
}
function buildCard_NotBound_(){
  return buildThemedTextCard_(['ğŸ“æç¤ºğŸ“','ç›®å‰å°šæœªé¸æ“‡å“ªæ–¹','è¼¸å…¥é–‹å§‹é€²è¡Œç¶å®š','å®Œæˆå¾Œå†é»é€£çµå”·'], ALERT_THEME); // å°šæœªç¶å®šæé†’å¡
}

//* ========== LINE API ========== *//
function replyFlex_(token, replyToken, flex){ const url='https://api.line.me/v2/bot/message/reply'; const payload={replyToken,messages:[flex]}; const opt={method:'post',contentType:'application/json',headers:{Authorization:'Bearer '+token},payload:JSON.stringify(payload),muteHttpExceptions:true}; try{UrlFetchApp.fetch(url,opt);}catch(_){} } // å›è¦†å–®ä¸€ Flex è¨Šæ¯
function replyAudio_(token, replyToken, audioUrl, duration){ const url='https://api.line.me/v2/bot/message/reply'; const payload={replyToken,messages:[{type:'audio',originalContentUrl:String(audioUrl),duration:Number(duration)||1000}]}; const opt={method:'post',contentType:'application/json',headers:{Authorization:'Bearer '+token},payload:JSON.stringify(payload),muteHttpExceptions:true}; try{UrlFetchApp.fetch(url,opt);}catch(_){} } // å›è¦†éŸ³è¨Š
function replyMulti_(token, replyToken, messages){ const url='https://api.line.me/v2/bot/message/reply'; const payload={replyToken,messages}; const opt={method:'post',contentType:'application/json',headers:{Authorization:'Bearer '+token},payload:JSON.stringify(payload),muteHttpExceptions:true}; try{UrlFetchApp.fetch(url,opt);}catch(_){} } // å›è¦†å¤šå‰‡è¨Šæ¯
function fetchUserProfile_(channelToken, userId){
  if(!channelToken||!userId) return {displayName:'',pictureUrl:''};
  const url='https://api.line.me/v2/bot/profile/'+encodeURIComponent(userId);
  const opt={method:'get',headers:{Authorization:'Bearer '+channelToken},muteHttpExceptions:true};
  try{ const r=UrlFetchApp.fetch(url,opt); if(r.getResponseCode()===200){ const j=JSON.parse(r.getContentText()||'{}'); return {displayName:String(j.displayName||''), pictureUrl:String(j.pictureUrl||'')} } }catch(_){}
  return {displayName:'', pictureUrl:''};
}

//* ========== Web å…¥å£ ========== *//
function doGet(e){
  const p=e?.parameter||{}; const action=String(p.action||'').toLowerCase();
  if(action==='ping')    return T('ok'); // å¥åº·æª¢æŸ¥

  if(action==='couple'){ // å–å¾—æ–°äººåå­—ï¼ˆåˆä½µé¡¯ç¤ºï¼‰
    const {man,woman}=getGuests_(openMain_());
    return J({ok:!!(man||woman), name: (man && woman) ? `${man} & ${woman}` : (man||woman||'') });
  }

  // è§’è‰² + æ–°éƒ/æ–°å¨˜å§“åï¼ˆä¾›å‰ç«¯æ›¿æ› A&Bï¼‰
  if(action==='userrole'){
    const ssM=openMain_(); const shLogs=ensureLogs_(ssM); const guests=getGuests_(ssM);
    const lineId=String(p.lineId||'').trim();
    let role=''; if(lineId) role=getRole_(shLogs,lineId)||'';
    let nameLabel='â€”';
    if(role===ROLE_MALE_FRIEND && guests.man) nameLabel=guests.man;
    else if(role===ROLE_FEMALE_FRIEND && guests.woman) nameLabel=guests.woman;
    else if(guests.man||guests.woman) nameLabel=[guests.man,guests.woman].filter(Boolean).join(' & ')||'â€”';
    return J({ok:true, role, man:guests.man||'', woman:guests.woman||'', nameLabel});
  }

  // åŒå¿ƒç¥ˆé¡˜ï¼šåˆ—è¡¨ï¼ˆæ”¯æ´ role ç¯©é¸ï¼Œå…§éƒ¨å·²æ™‚é–“å€’åºï¼‰
  if(action==='listblessings'){
    const role=(String(p.role||'all').toLowerCase());
    const data=listBlessings_(); // â˜… å…§éƒ¨å·²æ™‚é–“å€’åº
    const filtered = role==='all' ? data :
      data.filter(x=> String(x.role||'').toLowerCase().includes(role==='male'?'male':'female'));
    return J({ok:true, items:filtered});
  }

  // åŒå¿ƒç¥ˆé¡˜ï¼šæ˜ç´°ï¼ˆä»¥ row id è®€å–ï¼‰
  if(action==='getblessingdetail'){
    const id = Math.max(2, Number(p.id||0)); // ç¬¬2åˆ—èµ·ï¼ˆè·³éè¡¨é ­ï¼‰
    const sh = ensureBlessings_(openMain_());
    const last = sh.getLastRow();
    if(id>last) return J({ok:false,error:'not_found'});
    const r = sh.getRange(id,1,1,9).getValues()[0];
    return J({ok:true, item:{
      row:id, time:r[0], lineId:r[1], displayName:r[2], pictureUrl:r[3],
      role:r[4], contentHTML:r[5], signature:r[6], signatureType:r[7], extra:r[8]
    }});
  }

  // ä¾ lineId å–è©²ä½¿ç”¨è€…ã€Œæœ€æ–°ä¸€ç­†ã€
  if(action==='getlatestbylineid'){
    const sh = ensureBlessings_(openMain_());
    const lineId = String(p.lineId||'').trim();
    if(!lineId) return J({ok:false});
    const last = sh.getLastRow(); if(last<=HEADER_ROWS) return J({ok:true, item:null});
    const vals = sh.getRange(HEADER_ROWS+1,1,last-HEADER_ROWS,9).getValues();
    let bestIdx=-1,bestTime=0;
    for(let i=0;i<vals.length;i++){
      const row=vals[i];
      if(String(row[1]||'')===lineId){
        const t = new Date(row[0]||'').getTime()||0;
        if(t>=bestTime){ bestTime=t; bestIdx=i; }
      }
    }
    if(bestIdx<0) return J({ok:true, item:null});
    const r=vals[bestIdx]; const rowNo=bestIdx+HEADER_ROWS+1;
    return J({ok:true, item:{
      row:rowNo, time:r[0], lineId:r[1], displayName:r[2], pictureUrl:r[3],
      role:r[4], contentHTML:r[5], signature:r[6], signatureType:r[7], extra:r[8]
    }});
  }

  return T('ok'); // é è¨­å›æ‡‰
}

//* å°å·¥å…·ï¼šç”± userId å–å¾— roleLabelï¼ˆç”·æ–¹/å¥³æ–¹ï¼‰ï¼Œç„¡å‰‡å›ç©ºå­—ä¸² *//
function getRoleLabelByUser_(shLogs, userId){
  const code = getRole_(shLogs, userId);
  if(code===ROLE_FEMALE_FRIEND) return 'å¥³æ–¹';
  if(code===ROLE_MALE_FRIEND)   return 'ç”·æ–¹';
  return '';
}
function getRoleLabelOrDefault_(shLogs, userId){
  return getRoleLabelByUser_(shLogs, userId) || 'ç”·æ–¹/å¥³æ–¹';
}

function doPost_real(e){
  let body={}; try{ body=JSON.parse(e?.postData?.contents||'{}'); }catch(_){ body={}; }

  // 1) LINE Webhookï¼ˆäº’å‹•éŸ³ç¬¦ + åŒå¿ƒç¥ˆé¡˜å…¥å£ï¼‰
  if(body && Array.isArray(body.events)) return handleLineWebhook_(body);

  // 2) åŒå¿ƒç¥ˆé¡˜ï¼šæ–°å¢
  const act=String(body.action||'').toLowerCase();
  if(act==='createblessing') return handleCreateBlessing_(body);

  // 3) åŒå¿ƒç¥ˆé¡˜ï¼šæ›´æ–°ï¼ˆæˆªæ­¢æ—¥å‰ï¼‰
  if(act==='updateblessing') return handleUpdateBlessing_(body);

  // 4) äº’å‹•éŸ³ç¬¦ LIFF é€å–®ï¼ˆä¿ç•™ï¼‰
  if(act==='submitnotes')    return handleLiffSubmit_(body);

  return J({ok:false, error:'unknown_action'}); // æœªçŸ¥æŒ‡ä»¤
}

//* ========== Webhookï¼ˆäº’å‹•éŸ³ç¬¦ + åŒå¿ƒç¥ˆé¡˜å…¥å£ï¼‰ ========== *//
function handleLineWebhook_(body){
  const events=body.events||[];
  const ssM=openMain_(); const ssP=openPublic_();
  const shM=ensureLogs_(ssM); const shP=ensureLogs_(ssP);
  const channelToken=(PropertiesService.getScriptProperties().getProperty('CHANNEL_TOKEN')||'').trim(); // å¾ Script Properties è®€å– LINE Bot token

  events.forEach(ev=>{
    try{
      const userId=ev.source?.userId||''; if(!userId) return;

      if(ev.type==='follow'){ // ä½¿ç”¨è€…åŠ å¥½å‹
        if(channelToken){
          const prof=fetchUserProfile_(channelToken,userId);
          bindLineIdEnsureRow_(ssM,userId,prof.displayName,prof.pictureUrl); // ä¸»æœ¬ç¶å®š/æ›´æ–°
          bindLineIdEnsureRow_(ssP,userId,prof.displayName,prof.pictureUrl); // å‰¯æœ¬ç¶å®š/æ›´æ–°

          // â˜… å°‡ Google Drive é é¢ç¶²å€è½‰ç‚ºã€Œç›´é€£ã€ä»¥ç¬¦åˆ LINE audio è¦æ±‚
          const playable = toDirectDriveUrl_(WELCOME_AUDIO_URL);
          replyAudio_(channelToken, ev.replyToken, playable, WELCOME_AUDIO_MS); // å›å‚³éŸ³æª”
        }
        return;
      }

      if(ev.type==='postback'){ // è§’è‰²é¸æ“‡ï¼ˆç”·/å¥³æ–¹ï¼‰
        const data=String(ev.postback?.data||'');

        /* â˜… å…ˆ ensure logs é€™å€‹ä½¿ç”¨è€…å­˜åœ¨ï¼ˆé¿å… setRole_ æ‰¾ä¸åˆ°åˆ—ï¼‰ */
        if(channelToken){
          const prof=fetchUserProfile_(channelToken,userId);
          bindLineIdEnsureRow_(ssM,userId,prof.displayName,prof.pictureUrl);
          bindLineIdEnsureRow_(ssP,userId,prof.displayName,prof.pictureUrl);
        }else{
          bindLineIdEnsureRow_(ssM,userId,'','');
          bindLineIdEnsureRow_(ssP,userId,'','');
        }

        if(/role=male/.test(data)){   setRole_(shM,userId,ROLE_MALE_FRIEND);   setRole_(shP,userId,ROLE_MALE_FRIEND); }      // è¨­ç‚ºç”·æ–¹è¦ªå‹
        else if(/role=female/.test(data)){ setRole_(shM,userId,ROLE_FEMALE_FRIEND); setRole_(shP,userId,ROLE_FEMALE_FRIEND); } // è¨­ç‚ºå¥³æ–¹è¦ªå‹

        if(channelToken){
          const roleLabel = getRoleLabelByUser_(shM, userId);
          replyMulti_(channelToken, ev.replyToken, [
            buildCard_Reminder_(),             // æé†’å¡
            buildCard_Entrance_(roleLabel),    // äº’å‹•éŸ³ç¬¦å…¥å£
            buildCard_BlessingEntrance_(roleLabel) // åŒå¿ƒç¥ˆé¡˜å…¥å£
          ]);
        }
        return;
      }

      if(ev.type==='message' && ev.message?.type==='text'){ // ä½¿ç”¨è€…å‚³æ–‡å­—
        const raw=String(ev.message.text||'').trim();

        if(!channelToken) return;

        if(['è¦ªå‹','æ–°éƒ','æ–°å¨˜'].some(k=>raw.includes(k))){ // é—œéµå­—ï¼šå«å‡ºè§’è‰²é¸å–®
          replyFlex_(channelToken, ev.replyToken, buildCard_RoleSelect_());
          return;
        }

        if(raw.includes('ğŸ“¡')){ // å¿™ç¢Œå°éˆ´éº
          replyFlex_(channelToken, ev.replyToken, buildCard_NoticeBusy_());
          return;
        }

        if(raw==='é–‹å§‹'){ // ä¸»å‹•å¼•å°ï¼šè‹¥æœªç¶å®šï¼Œå…ˆé¸è§’è‰²ï¼›å·²ç¶å‰‡ä¸Ÿä¸‰å¡
          const roleLabel = getRoleLabelByUser_(shM, userId);
          if(!roleLabel){
            replyFlex_(channelToken, ev.replyToken, buildCard_RoleSelect_());
          }else{
            replyMulti_(channelToken, ev.replyToken, [
              buildCard_Reminder_(),
              buildCard_Entrance_(roleLabel),
              buildCard_BlessingEntrance_(roleLabel)
            ]);
          }
          return;
        }

        if(KWS_PORTAL_NOTES.some(k=>raw.includes(k))){ // é—œéµå­—é€²å…¥ äº’å‹•éŸ³ç¬¦
          const roleLabel = getRoleLabelByUser_(shM, userId);
          if(!roleLabel){
            replyFlex_(channelToken, ev.replyToken, buildCard_NotBound_()); // å°šæœªç¶å®šæé†’
          }else{
            replyFlex_(channelToken, ev.replyToken, buildCard_Entrance_(roleLabel));
          }
          return;
        }

        if(KWS_PORTAL_BLESS.some(k=>raw.includes(k))){ // é—œéµå­—é€²å…¥ åŒå¿ƒç¥ˆé¡˜
          const roleLabel = getRoleLabelByUser_(shM, userId);
          if(!roleLabel){
            replyFlex_(channelToken, ev.replyToken, buildCard_NotBound_()); // å°šæœªç¶å®šæé†’
          }else{
            replyFlex_(channelToken, ev.replyToken, buildCard_BlessingEntrance_(roleLabel));
          }
          return;
        }

        return;
      }
    }catch(_){}
  });

  return J({status:'ok'}); // Webhook çµ±ä¸€å›è¦†
}

//* ========== äº’å‹•éŸ³ç¬¦ â€“ LIFF é€å–®ï¼ˆä¿ç•™ï¼‰ ========== *//
function handleLiffSubmit_(body){
  const ssM=openMain_(); const ssP=openPublic_();
  const shM=ensureLogs_(ssM); const shP=ensureLogs_(ssP);

  const lineId=String(body.lineId||'').trim();             // ä½¿ç”¨è€… IDï¼ˆLIFF profileï¼‰
  const displayName=String(body.displayName||'').trim();   // ä½¿ç”¨è€…æš±ç¨±
  const pictureUrl=String(body.pictureUrl||'').trim();     // é ­åƒ URL
  const instruments=String(body.instrumentsCSV||'').trim();// æ¨‚å™¨é¸æ“‡ï¼ˆCSVï¼‰
  const notes=String(body.notesCSV||'').trim();            // ä¸‰éŸ³ï¼ˆCSVï¼‰
  // const msg=String(body.extraMessage||'').trim(); // âœ‚ å·²åœç”¨ï¼Œä¸å†å­˜è¡¨
  if(!lineId) return J({ok:false,error:'missing_line_id'});

  bindLineIdEnsureRow_(ssM,lineId,displayName,pictureUrl); // ä¸»æœ¬ç¢ºä¿ç¶å®š
  bindLineIdEnsureRow_(ssP,lineId,displayName,pictureUrl); // å‰¯æœ¬ç¢ºä¿ç¶å®š

  if(isExpired_())                  return J({ok:false,error:'deadline_passed'}); // é€¾æœŸ
  if(alreadySubmitted_(shM,lineId)) return J({ok:false,error:'duplicate'});       // é‡è¤‡é€å‡º

  let roleM=getRole_(shM,lineId), roleP=getRole_(shP,lineId);

  const rM=findLogRowByLineId_(shM,lineId);
  if(rM===-1) shM.appendRow([nowStr(),lineId,pictureUrl,roleM,displayName,instruments,notes]); // æ–°å¢
  else        shM.getRange(rM,1,1,7).setValues([[nowStr(),lineId,pictureUrl,roleM,displayName,instruments,notes]]); // è¦†å¯«è©²åˆ—

  const rP=findLogRowByLineId_(shP,lineId);
  if(rP===-1) shP.appendRow([nowStr(),lineId,pictureUrl,roleP,displayName,instruments,notes]); // æ–°å¢ï¼ˆå‰¯æœ¬ï¼‰
  else        shP.getRange(rP,1,1,7).setValues([[nowStr(),lineId,pictureUrl,roleP,displayName,instruments,notes]]); // è¦†å¯«è©²åˆ—ï¼ˆå‰¯æœ¬ï¼‰

  return J({ok:true});
}

//* ========== åŒå¿ƒç¥ˆé¡˜ â€“ æ–°å¢/æ›´æ–°ï¼ˆä¸»æœ¬ï¼‹å‰¯æœ¬ï¼Œç´”æ–‡å­—å„²å­˜ï¼‰ ========== *//
function stripHtml_(html){ return String(html||'').replace(/<[^>]+>/g,''); } // å»é™¤ HTML æ¨™ç±¤ï¼Œä¿ç•™ç´”æ–‡å­—

function handleCreateBlessing_(body){
  const ssM = openMain_();
  const ssP = openPublic_();
  const shM = ensureBlessings_(ssM);
  const shP = ensureBlessings_(ssP);
  const shLogsM = ensureLogs_(ssM);

  const lineId      = String(body.lineId||'').trim();        // ä½¿ç”¨è€… ID
  const displayName = String(body.displayName||'').trim();   // æš±ç¨±
  const pictureUrl  = String(body.pictureUrl||'').trim();    // é ­åƒ
  const contentHTML = String(body.contentHTML||'').trim();   // ä¾†è‡ªå‰ç«¯çš„å…§å®¹ï¼ˆè¦–è¦º HTMLï¼‰
  const contentPlain= stripHtml_(contentHTML);               // â­ å¯¦éš›å­˜ç´”æ–‡å­—
  const signature   = String(body.signaturePNG||'').trim();  // ç°½åï¼ˆdataURLï¼‰
  const extra       = JSON.stringify(body.extra||{});        // å…¶ä»–é™„åŠ æ¬„ä½ï¼ˆJSONï¼‰

  if(!lineId)       return J({ok:false,error:'missing_line_id'});
  if(!contentPlain) return J({ok:false,error:'missing_content'});
  if(isExpired_())  return J({ok:false,error:'deadline_passed'});

  const role = getRole_(shLogsM, lineId) || ''; // å¾ logs è®€å–ä½¿ç”¨è€…è§’è‰²

  let sigVal = '', sigType = 'none';
  if(signature){
    if(SAVE_SIGNATURE_TO_DRIVE){
      const url = saveSignatureToDrive_(signature, lineId, displayName); // å­˜åˆ° Driveï¼Œå›å‚³åˆ†äº«é€£çµ
      sigVal = url; sigType='drive';
    }else{
      sigVal = signature; sigType='base64'; // ç›´æ¥å­˜ base64
    }
  }

  const rowData = [ nowStr(), lineId, displayName, pictureUrl, role, contentPlain, sigVal, sigType, extra ];
  shM.appendRow(rowData); // ä¸»æœ¬æ–°å¢
  shP.appendRow(rowData); // å‰¯æœ¬åŒæ­¥æ–°å¢
  return J({ok:true});
}

function handleUpdateBlessing_(body){
  const ssM = openMain_();
  const ssP = openPublic_();
  const shM = ensureBlessings_(ssM);
  const shP = ensureBlessings_(ssP);

  const row = Number(body.row||0);                 // æŒ‡å®šè¦æ›´æ–°çš„åˆ—ï¼ˆä¸»æœ¬ï¼‰
  const lineId = String(body.lineId||'').trim();   // æª¢æŸ¥æ¬Šé™ç”¨
  const contentHTML = String(body.contentHTML||'').trim();
  const contentPlain= stripHtml_(contentHTML);     // â­ å¯¦éš›å­˜ç´”æ–‡å­—
  if(!row || !lineId || !contentPlain) return J({ok:false,error:'missing_params'});
  if(isExpired_()) return J({ok:false,error:'deadline_passed'});

  const recM = shM.getRange(row,1,1,9).getValues()[0]; // è®€ä¸»æœ¬è©²åˆ—è³‡æ–™
  const ownerM = String(recM[1]||'').trim();
  if(ownerM!==lineId) return J({ok:false,error:'forbidden'}); // åƒ…æœ¬äººå¯æ”¹

  const cellM=shM.getRange(row,6); // F=contentHTML(å¯¦éš›å­˜ç´”æ–‡å­—)
  const oldHtmlM=cellM.getValue(); const oldNoteM=cellM.getNote();
  const newNoteM = `${nowStr()} èˆŠå…§å®¹ï¼š\n${stripHtml_(oldHtmlM)}${oldNoteM?('\n\n'+oldNoteM):''}`.slice(0,5000); // èˆŠå…§å®¹å¯«å…¥å‚™è¨»ï¼ˆä¿ç•™æ­·ç¨‹ï¼‰
  cellM.setNote(newNoteM);
  cellM.setValue(contentPlain);
  shM.getRange(row,1).setValue(nowStr()); // æ›´æ–°æ™‚é–“

  const rP = findLatestBlessingRowByLineId_(shP, lineId); // æ‰¾å‰¯æœ¬ä¸­è©²ä½¿ç”¨è€…çš„æœ€æ–°ä¸€ç­†
  if(rP>0){
    const cellP=shP.getRange(rP,6);
    const oldHtmlP=cellP.getValue(); const oldNoteP=cellP.getNote();
    const newNoteP=`${nowStr()} èˆŠå…§å®¹ï¼š\n${stripHtml_(oldHtmlP)}${oldNoteP?('\n\n'+oldNoteP):''}`.slice(0,5000);
    cellP.setNote(newNoteP);
    cellP.setValue(contentPlain);
    shP.getRange(rP,1).setValue(nowStr()); // æ›´æ–°æ™‚é–“ï¼ˆå‰¯æœ¬ï¼‰
  }

  return J({ok:true});
}

function findLatestBlessingRowByLineId_(sh, lineId){
  const last=sh.getLastRow(); if(last<=HEADER_ROWS) return -1;
  const vals=sh.getRange(HEADER_ROWS+1,1,last-HEADER_ROWS,9).getValues();
  let bestRow=-1, bestTime=0;
  for(let i=0;i<vals.length;i++){
    const r=vals[i];
    if(String(r[1]||'').trim()===lineId){
      const t = new Date(r[0]||'').getTime()||0;
      const rowNum = i+HEADER_ROWS+1;
      if(t>=bestTime){ bestTime=t; bestRow=rowNum; }
    }
  }
  return bestRow; // å›å‚³è©²ä½¿ç”¨è€…æœ€æ–°ä¸€ç­†æ‰€åœ¨åˆ—ï¼ˆæ‰¾ä¸åˆ°å› -1ï¼‰
}

//* ========== ç°½å â†’ Drive ========== *//
function saveSignatureToDrive_(dataUrl, lineId, displayName){
  const m = /^data:image\/(png|jpeg);base64,([A-Za-z0-9+/=]+)$/.exec(String(dataUrl||'')); if(!m) return ''; // åƒ…æ¥å— png/jpeg dataURL
  const ext = m[1]==='jpeg'?'jpg':m[1]; // å‰¯æª”å
  const bytes = Utilities.base64Decode(m[2]); // è½‰æˆä½å…ƒçµ„
  const blob = Utilities.newBlob(bytes, 'image/'+(ext==='jpg'?'jpeg':ext), `sign_${lineId||'anon'}_${Date.now()}.${ext}`); // å»ºç«‹ blob æª”æ¡ˆ

  let folder = null;
  if(DRIVE_FOLDER_ID){
    try{ folder = DriveApp.getFolderById(DRIVE_FOLDER_ID); }catch(_){}
  }
  if(!folder){
    const it = DriveApp.getFoldersByName('Blessing-Signatures'); // ä»¥åç¨±å°‹æ‰¾
    folder = it.hasNext()? it.next() : DriveApp.createFolder('Blessing-Signatures'); // æ²’æœ‰å°±å»ºç«‹
  }

  const file = folder.createFile(blob);            // ä¸Šå‚³æª”æ¡ˆ
  try{ file.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW); }catch(_){ } // è¨­å®šæŒé€£çµè€…å¯æª¢è¦–
  return file.getUrl();                            // å›å‚³åˆ†äº«ç¶²å€
}

//* ========== åˆ—è¡¨/æ˜ç´°è¼¸å‡ºï¼ˆåªå›å‚³æœ‰å…§å®¹çš„åˆ—ï¼›â˜…æ™‚é–“å€’åºï¼‰ ========== *//
function listBlessings_(){
  const sh = ensureBlessings_(openMain_());
  const last = sh.getLastRow(); if(last<=HEADER_ROWS) return []; // ç„¡è³‡æ–™
  const vals = sh.getRange(HEADER_ROWS+1,1,last-HEADER_ROWS,9).getValues();

  const items=[];
  for(let i=0;i<vals.length;i++){
    const r=vals[i];
    const contentPlain = String(r[5]||'').replace(/<[^>]+>/g,'').trim(); // å†ä¿éšªå»æ¨™ç±¤
    if(!contentPlain) continue; // æ²’å…§å®¹å°±ç•¥é
    items.push({
      row: i+HEADER_ROWS+1,
      time: r[0],
      lineId: r[1],
      displayName: r[2],
      pictureUrl: r[3],
      role: r[4]||'',
      preview: contentPlain.slice(0,60), // å‰ 60 å­—åšé è¦½
      signature: r[6],
      signatureType: r[7],
      extra: r[8]
    });
  }
  // â˜… ä¾æ™‚é–“å€’åºï¼ˆæœ€æ–°åœ¨ä¸Šï¼‰ï¼›ä¸åˆæ³•æ™‚é–“è¦–ç‚º 0
  items.sort((a,b)=> (new Date(b.time||0)).getTime() - (new Date(a.time||0)).getTime());
  return items;
}
