<!doctype html> 
<html lang="zh-Hant">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>â¤ï¸åŒå¿ƒç¥ˆé¡˜â¤ï¸</title>

<!-- âœ… å­—é«”ï¼ˆç¶­æŒä½ çš„é…ç½®ï¼‰ -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Patrick+Hand:wght@400&family=Sacramento:wght@400;700&display=swap" rel="stylesheet">

<style>
:root{
  /* âœ… ä¸»é¡Œè‰²ï¼šç¶­æŒä½ çš„è—è‰²ä¸»é¡Œ */
  --brand-bg:#c9daf8;
  --title:#A68A7C;  --ink:#0f172a; --accent:#A68A7C; --rim:#E4E4E4; --soft:#F5F1EC;
  --panel-grad-from:#b7d2f6; --panel-grad-to:#cfe1fb;

  --panel-maxw:1320px;

  --shadow-1:0 10px 26px rgba(0,0,0,.10);
  --shadow-2:0 2px 0 rgba(0,0,0,.15), 0 2px 8px rgba(0,0,0,.06);

  --editor-zoom:1rem; --toolbar-gap:8px; --h2-size:2.8rem;
  --btn-w:184px; --btn-h:36px; --tool-h:36px;

  /* âœ… æœ¨ç‰Œå°ºå¯¸ï¼ˆç¶­æŒï¼‰ */
  --tile-w:180px; --tile-h:156px;

  /* âœ… ç¹©æ¢/ç¹©çµï¼ˆæ›´ç´°ã€å¤–å‡¸ï¼‰ */
  --rope-width:6px;
  --rope-height:44px;
  --knot-size:18px;
}

/* âœ… èƒŒæ™¯åœ–ï¼ˆç…§ä½ çš„è¦æ±‚æ¢å¾© favors.png?v=4ï¼‰ */
.bg-notes{
  position: fixed; inset: 0; width: 100%; height: 100%;
  object-fit: cover; z-index: 0; pointer-events: none; user-select: none; opacity: .9;
}

/* âœ… Layout èˆ‡é¢æ¿ï¼ˆç¶­æŒä½ çš„è¨­å®šï¼‰ */
*{box-sizing:border-box;}
html,body{
  height:100%;margin:0;overflow:hidden;color:var(--ink);background:var(--brand-bg);
  font-family:"Patrick Hand","Noto Sans TC",system-ui,-apple-system,sans-serif;
  -webkit-text-stroke:.35px rgba(0,0,0,.18); text-shadow:0 1px 0 rgba(255,255,255,.65);
}
.panel{
  position:relative;z-index:1;max-width:var(--panel-maxw);
  height:calc(100vh - 110px);margin:26px auto;
  background:linear-gradient(135deg,var(--panel-grad-from),var(--panel-grad-to));
  border:1px solid var(--rim);border-radius:16px;box-shadow:var(--shadow-1);
  display:flex;flex-direction:column;overflow:hidden;
}
h2{
  position:relative;left:50%;transform:translateX(-50%);
  margin:12px 0 6px;text-align:center;width:max-content;max-width:90%;
  font-family:"Sacramento",cursive;font-weight:700;font-size:var(--h2-size);color:var(--title);
  -webkit-text-stroke:.6px rgba(0,0,0,.12);text-shadow:0 3px 4px rgba(255,255,255,.75);
}
.bar{padding:6px 22px 8px;}
.bar-inner{max-width:1200px;margin:0 auto;display:flex;align-items:center;gap:12px;}
.toolbar{display:flex;gap:var(--toolbar-gap);filter:drop-shadow(0 2px 0 rgba(0,0,0,.08));}
.tool-btn,.tool-select{
  min-width:64px;height:var(--tool-h);padding:0 12px;background:#fff;border:1px solid var(--rim);
  border-radius:12px;font-weight:700;display:flex;align-items:center;justify-content:center;gap:6px;box-shadow:var(--shadow-2);
}
.tool-select{min-width:auto;padding:0 10px;}
.tool-btn:active{transform:translateY(1px) scale(.99);}
.rolebar{display:flex;gap:var(--toolbar-gap);}
.role-btn{
  min-width:64px;height:var(--tool-h);padding:0 12px;background:#fff;border:1px solid var(--rim);border-radius:12px;
  font-weight:700;display:flex;align-items:center;justify-content:center;box-shadow:var(--shadow-2);
}
.role-btn.active{outline:2px solid rgba(0,0,0,.15);}
#status{
  flex:1 1 auto;min-width:240px;background:#F5F1EC;border:1px solid #E4E4E4;border-radius:12px;
  padding:8px 10px;font-size:14px;text-align:center;color:#A68A7C;font-weight:700;
}

.stage{flex:1 1 auto;padding:14px 22px 0;display:flex;justify-content:center;align-items:flex-start;overflow:hidden;}
.card{
  position:relative;width:100%;max-width:1200px;border:1px solid rgba(0,0,0,.05);border-radius:16px;box-shadow:0 10px 26px rgba(0,0,0,.08);
  padding:22px;height:100%;display:grid;grid-template-columns:1fr 2fr;gap:14px;background:#e6b8af; /* å³åŠç²‰ç‰†çš„å¤–åº•è‰²ï¼ˆä¿ç•™ï¼‰ */
}

/* âœ… å·¦å´è¼¸å…¥é¢æ¿ï¼ˆä¸å‹•ä½ çš„çµæ§‹ã€åªç¶­æŒæ¨£å¼ï¼‰ */
.left-wrap{
  position:relative;background:linear-gradient(180deg, rgba(255,242,204,.98), rgba(255,242,204,.92));
  border-radius:16px;border:1px solid rgba(0,0,0,.05);padding:12px;overflow:hidden;
}
.left-content{position:relative;height:100%;}

/* âœ… æ–°äºº chipï¼ˆDear A/Bï¼‰ */
.chip{
  position:absolute;min-width:160px;height:var(--tool-h);background:#fff;border:1px solid var(--rim);border-radius:10px;
  box-shadow:0 2px 8px rgba(0,0,0,.06);display:flex;align-items:center;justify-content:center;gap:8px;padding:0 10px;user-select:none;
}
#chipBride{top:10px;left:10px;}
#brideLabel{font-weight:800;line-height:1;}

/* âœ… ç·¨è¼¯å™¨ï¼ˆä»å¯å±€éƒ¨åŠ ç²—/åº•ç·šï¼Œä½†å…¥åº«å‡è½‰ç´”æ–‡å­—ï¼‰ */
.editor{
  position:absolute;top:calc(10px + var(--tool-h) + 16px);right:10px;bottom:calc(10px + 36px + 10px);left:10px;
  overflow:auto;line-height:1.8;outline:none;background:transparent;border-radius:12px;padding:14px;font-size:var(--editor-zoom);
  border:1px dashed rgba(0,0,0,.12);
}
.editor[data-empty]{opacity:1;color:rgba(15,23,42,.28);-webkit-text-stroke:0;text-shadow:none;font-style:italic;}
.editor.locked{pointer-events:none;opacity:.85;}

/* âœ… å·¦ä¸‹æ–¹ä¸‰é¡†ï¼ˆä¿ç•™ï¼‰ */
.left-actions{position:absolute;left:10px;right:10px;bottom:10px;height:36px;display:flex;gap:10px;}
.left-actions>*{flex:1 1 0;height:100%;}
.left-actions button{
  background:#fff;border:1px solid var(--rim);border-radius:10px;font-weight:800;box-shadow:var(--shadow-2);cursor:pointer;
}
.left-actions button:active{transform:translateY(1px) scale(.99);}

/* âœ… ç°½å chipï¼ˆèˆŠæ¨£å¼ï¼‰ */
#chipSign{
  position:static;display:flex;align-items:center;justify-content:center;cursor:pointer;background:#fff;border:1px solid var(--rim);
  border-radius:10px;box-shadow:var(--shadow-2);padding:0 8px;
}
#chipSign .hint{font-weight:900;color:rgba(15,23,42,.35);}
#chipSign.locked{pointer-events:none;opacity:.9;}
#signThumb{display:none;width:100%;height:70%;object-fit:contain;}
#chipSign.has-img #signThumb{display:block;}
#chipSign.has-img .hint{display:none;}

/* âœ… å³å´ç¥ç¦ç‰†ï¼ˆç²‰è‰²ç³»ï¼‰ */
.wall-wrap{
  background:linear-gradient(180deg,#f9e5ee,#f6dce7);
  border-radius:16px;border:1px solid rgba(0,0,0,.05);padding:12px;overflow:auto;
}
.wall{min-height:280px;display:grid;grid-template-columns:repeat(auto-fill,minmax(var(--tile-w),1fr));gap:14px;align-content:start;padding:2px;overflow:visible;}

/* âœ… æœ¨ç‰Œå®¹å™¨ï¼ˆä¸è£åˆ‡ï¼Œè®“ç¹©çµèƒ½å‡¸å‡ºï¼‰ */
.tile{position:relative;width:100%;height:var(--tile-h);cursor:pointer;overflow:visible;}

/* âœ… æœ¨ç‰Œé¢æ¿ï¼ˆå’–å•¡è‰²æœ¨æ¡† + æœ¨ç´‹ + æ–œè§’ï¼‰ */
.tile-plate{
  position:absolute; inset:0; padding:14px 12px 12px; display:flex; flex-direction:column; gap:6px;
  background:
    linear-gradient(180deg,#f1e3cf,#e5d1b8),
    repeating-linear-gradient(14deg, rgba(0,0,0,.05) 0 4px, rgba(255,255,255,.04) 4px 9px),
    repeating-linear-gradient(0deg,  rgba(0,0,0,.035) 0 2px, rgba(255,255,255,.035) 2px 4px),
    radial-gradient(16px 12px at 28% 36%, rgba(0,0,0,.06), transparent 60%),
    radial-gradient(14px 10px at 72% 62%, rgba(0,0,0,.06), transparent 60%);
  border:3px solid transparent;
  border-image: repeating-linear-gradient(15deg,#8f6a3a 0 6px,#a67942 6px 12px,#7c5430 12px 18px) 8 round; /* å’–å•¡è‰²æœ¨æ¡† */
  border-radius:14px;
  box-shadow: inset 0 1px 0 rgba(255,255,255,.28), inset 0 -1.5px 0 rgba(0,0,0,.12), 0 10px 18px rgba(0,0,0,.10);
  clip-path:polygon(0 12%, 12% 0, 88% 0, 100% 12%, 100% 100%, 0 100%);
}
.tile-plate::before{
  content:"";position:absolute;top:4px;left:50%;transform:translateX(-50%);width:16px;height:16px;border-radius:50%;
  background:radial-gradient(circle at 35% 35%, #fff 0 35%, #bbb 36% 60%, transparent 61%);
  box-shadow:inset 0 1px 0 rgba(255,255,255,.9), inset 0 -1px 0 rgba(0,0,0,.15);
}
/* å³ä¸Šå°è²¼ç´™ï¼ˆä¿ç•™è¶£å‘³ï¼‰ */
.tile-plate::after{
  content:"";position:absolute;top:-6px;right:12px;width:18px;height:12px;border-radius:0 18px 18px 18px / 0 12px 12px 12px;
  background:linear-gradient(180deg,#7fcf7a,#58b35a);box-shadow:0 1px 0 rgba(255,255,255,.45), inset 0 -1px 0 rgba(0,0,0,.15);
}

/* âœ… ç¹©ï¼‹çµï¼ˆæ›´ç´°ï¼‹å¤–å‡¸ï¼‰ */
.tile .rope{
  position:absolute;top:-20px;left:50%;transform:translateX(-50%);
  width:var(--rope-width);height:var(--rope-height);
  background:
    repeating-linear-gradient(90deg,#b77c3a 0 3px,#c98a45 3px 6px),
    linear-gradient(180deg,rgba(255,255,255,.65),rgba(255,255,255,0) 55%),
    linear-gradient(0deg,rgba(0,0,0,.12),transparent 60%);
  border-radius:999px;filter:saturate(.95);
  box-shadow:0 4px 10px rgba(0,0,0,.18), inset 0 1px 0 rgba(255,255,255,.55), inset 0 -1px 0 rgba(0,0,0,.10);
  z-index:3;
}
.tile .knot{
  position:absolute;top:-14px;left:50%;transform:translateX(-50%);
  width:calc(var(--knot-size) * 1.25);height:calc(var(--knot-size) * .88);
  background:linear-gradient(180deg,#cc8a3d,#a9652b);
  border-radius:14px;border:1px solid rgba(0,0,0,.12);
  box-shadow:0 2px 0 rgba(0,0,0,.08), 0 12px 18px rgba(0,0,0,.20), inset 0 1px 0 rgba(255,255,255,.35), inset 0 -2px 0 rgba(0,0,0,.15);
  z-index:4;
}
.tile .knot::before,.tile .knot::after{
  content:"";position:absolute;top:40%;width:54%;height:54%;
  background:linear-gradient(180deg,#d09045,#b17233); border-radius:999px;
  box-shadow:inset 0 2px 2px rgba(255,255,255,.38), 0 4px 6px rgba(0,0,0,.10);
}
.tile .knot::before{left:-14px;transform:rotate(-28deg);}
.tile .knot::after{right:-14px;transform:rotate(28deg);}

/* âœ… ç‰Œé¢æ–‡å­—ï¼ˆç¶­æŒï¼‰ */
.tile-name{font-weight:800;text-align:center;margin-top:8px;}
.tile-sep{height:1px;background:linear-gradient(90deg, rgba(0,0,0,.18), rgba(0,0,0,.06) 40%, rgba(0,0,0,.18));opacity:.7;margin:6px 0;}
.tile-date{font-size:12px;opacity:.8;text-align:center;}
.tile-snippet{
  font-size:14px;line-height:1.6;text-align:left;word-break:break-word;
  display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;overflow:hidden;text-overflow:ellipsis;
}

/* âœ… æª¢è¦–çª—ï¼ˆæ˜ç´°ï¼‰ */
.overlay{position:fixed;inset:0;z-index:9999;display:none;align-items:center;justify-content:center;background:rgba(17,24,39,.35);backdrop-filter:blur(3px);}
.overlay.show{display:flex;}
.dialog{
  width:min(92vw,680px);max-height:82vh;background:#F5F1EC;border:1px solid var(--rim);border-radius:14px;padding:16px;
  box-shadow:0 18px 44px rgba(0,0,0,.18);overflow:auto;
}
.dialog h3{margin:0 0 10px;font-size:18px;color:#6b5e52;text-align:center;-webkit-text-stroke:0;text-shadow:none;}
.view-meta{text-align:center;font-size:12px;opacity:.75;margin-bottom:8px;}
.view-content{background:#fff;border:1px solid #ddd;border-radius:12px;padding:12px;line-height:1.8;white-space:pre-wrap;}
.view-actions{display:flex;gap:10px;justify-content:center;margin-top:12px;}
.view-actions button{min-width:120px;height:var(--tool-h);border-radius:10px;border:1px solid var(--rim);background:#fff;cursor:pointer;font-weight:700;}

/* âœ… ç°½åå°è©±æ¡†ï¼ˆèˆŠæ¨£å¼ï¼Œä¿ç•™ï¼‰ */
#sigOverlay .dialog{width:min(92vw,520px);}
#pad{width:100%;height:260px;background:#fff;border:1px solid #ddd;border-radius:12px;touch-action:none;display:block;}
.dlg-actions{display:flex;gap:10px;justify-content:center;margin-top:12px;}
.dlg-actions button{width:120px;height:var(--tool-h);border-radius:10px;border:1px solid var(--rim);background:#fff;cursor:pointer;font-weight:700;}

/* âœ… Footer ç‰ˆæ¬Šï¼ˆç½®ä¸­ï¼Œä¸Šç§»ä¸€é»ï¼‰ */
footer.copyright{
  position: fixed; left: 50%; transform: translateX(-50%); bottom: 22px;
  font-size: 12px; opacity: .75;
  -webkit-text-stroke: 0; text-shadow: none;
  z-index: 2;
}

/* â˜… è®“åº•éƒ¨é€å‡ºéµå¤–è§€èˆ‡å·¦å´ä¸‰é¡†ä¸€è‡´ï¼ˆç´”è£œå……é¸æ“‡å™¨ï¼Œä¸æ”¹ä½ åŸ classï¼‰ */
.footer-actions #btnSubmit{
  background:#fff;border:1px solid var(--rim);border-radius:10px;font-weight:800;box-shadow:var(--shadow-2);cursor:pointer;
  height: var(--tool-h); min-width: var(--btn-w);
}
.footer-actions #btnSubmit:active{ transform:translateY(1px) scale(.99); }
</style>

<body>
  <!-- âœ… èƒŒæ™¯åœ–ï¼ˆæ¢å¾©ï¼‰ -->
  <img class="bg-notes" src="./assets/favors.png?v=4" alt="">

  <div class="panel">
    <h2>â¤ï¸åŒå¿ƒç¥ˆé¡˜â¤ï¸</h2>

    <div class="bar">
      <div class="bar-inner">
        <!-- âœ… è§’è‰²éæ¿¾ï¼ˆä¿ç•™ä½ çš„ä¸‰éµï¼‰ -->
        <div class="rolebar">
          <button type="button" class="role-btn active" id="roleAll">å…¨éƒ¨</button>
          <button type="button" class="role-btn" id="roleMale">ç”·æ–¹</button>
          <button type="button" class="role-btn" id="roleFemale">å¥³æ–¹</button>
        </div>

        <p id="status">âœ… å·²å°±ç·’ï¼Œå¯ä»¥å¡«å¯«å›‰ï¼å»ºè­°ä½¿ç”¨é›»è…¦æ“ä½œæœƒæ›´æ£’</p>

        <!-- âœ… å·¥å…·åˆ—ï¼ˆä»ç„¶åªå½±éŸ¿å‰ç«¯è¦–è¦ºï¼Œå„²å­˜ç‚ºç´”æ–‡å­—ï¼‰ -->
        <div class="toolbar" role="toolbar" aria-label="æ–‡å­—å·¥å…·">
          <button class="tool-btn" id="btnBold"      type="button">ç²—é«”</button>
          <button class="tool-btn" id="btnItalic"    type="button">æ–œé«”</button>
          <button class="tool-btn" id="btnUnderline" type="button">åº•ç·š</button>
          <select id="colorPick" class="tool-select" title="å­—é«”é¡è‰²">
            <option value="" selected>é¡è‰²</option>
            <option value="#a21caf">å°ç´«</option>
            <option value="#dc2626">å°ç´…</option>
            <option value="#2563eb">å°è—</option>
            <option value="#059669">å°ç¶ </option>
            <option value="#d97706">å°æ©˜</option>
            <option value="#6b7280">å°ç°</option>
          </select>
          <button class="tool-btn" id="btnBigger"    type="button">æ”¾å¤§</button>
          <button class="tool-btn" id="btnSmaller"   type="button">ç¸®å°</button>
        </div>
      </div>
    </div>

    <div class="stage">
      <div class="card" id="card">
        <!-- âœ… å·¦ï¼šè¼¸å…¥ -->
        <section class="left-wrap">
          <div class="left-content">
            <div class="chip" id="chipBride" title="æ–°äºº"><span id="brideLabel">Dear â€”</span></div>

            <div class="editor" id="editor" contenteditable="true" aria-label="ç¥ˆé¡˜å…§å®¹" data-empty>
              å¯«ä¸‹ä¸¦ç»ä¸Šæœ€èª æ‘¯çš„ç¥ç¦â€¦ğŸ’
            </div>

            <div class="left-actions">
              <button id="btnEdit"  type="button">ä¿®æ”¹</button>
              <button id="btnSend"  type="button">é€å‡º</button>

              <!-- âœ… ç°½åï¼ˆç•«æŠ¼ï¼‰ -->
              <div class="chip" id="chipSign" title="ç•«æŠ¼ç°½å">
                <span class="hint">ç•«æŠ¼ç°½å</span>
                <img id="signThumb" alt="signature preview" />
              </div>
            </div>
          </div>
        </section>

        <!-- âœ… å³ï¼šç¥ç¦ç‰† -->
        <section class="wall-wrap">
          <div class="wall" id="wall"></div>
        </section>
      </div>
    </div>

    <div class="footer-actions" style="display:flex;justify-content:center;align-items:center;padding:14px 0 16px;">
      <button id="btnSubmit" class="primary" type="button">é€å‡ºæ»¿æ»¿ç¥ç¦</button>
    </div>
  </div>

  <!-- âœ… ç‰ˆæ¬Šï¼ˆç¶­æŒä¸å‹•ï¼‰ -->
  <footer class="copyright">
    Â© Copyright 2025 MYâ€˜s System Version:b1.0.227
  </footer>

  <!-- âœ… æª¢è¦–çª—ï¼ˆæ˜ç´°ï¼‰ -->
  <div id="viewOverlay" class="overlay" role="dialog" aria-modal="true" aria-labelledby="viewTitle">
    <div class="dialog">
      <h3 id="viewTitle">ç¥ç¦å…§å®¹</h3>
      <div class="view-meta" id="viewMeta"></div>
      <div id="viewContent" class="view-content"></div>
      <div class="view-actions"><button id="viewClose" type="button">é—œé–‰</button></div>
    </div>
  </div>

  <!-- âœ… ç°½å Modalï¼ˆèˆŠæ¨£å¼ï¼‰ -->
  <div id="sigOverlay" class="overlay" role="dialog" aria-modal="true" aria-labelledby="sigTitle">
    <div class="dialog">
      <h3 id="sigTitle">è«‹æ–¼ä¸‹æ–¹ç•«æŠ¼å”·ğŸ˜ˆ</h3>
      <canvas id="pad"></canvas>
      <div class="dlg-actions">
        <button id="sigClear"  type="button">æ¸…é™¤</button>
        <button id="sigCancel" type="button">å–æ¶ˆ</button>
        <button id="sigOK"     type="button">ç¢ºå®š</button>
      </div>
    </div>
  </div>

<script>
/* ===================== å‰ç«¯è¨­å®šï¼ˆè«‹ç¢ºèªï¼‰ ===================== */
/* âœ… ä½ çš„ LIFF èˆ‡ GAS WebApp Endpoint */
const LIFF_ID='2008149060-m5pDXW6a';  // â† ä½ çš„ LIFF IDï¼ˆåŒå¿ƒç¥ˆé¡˜ï¼‰
const WEBHOOK='https://script.google.com/macros/s/AKfycbxH_0NJkDLFjmwq5jYMGIScbnwrfQZIraNOhMleu9LSia_imVU2zah_XyMwtWx7NtoX/exec'; // â† ä½ çš„ GAS ç¶²å€

/* ===================== DOM å¿«æ· ===================== */
const $ = s => document.querySelector(s);
const editor = $('#editor');
const wallEl = $('#wall');
const chip = $('#chipSign');
const img  = $('#signThumb');

// === æ–°å¢ï¼šç”¨æ–¼ Dear æ¨™ç±¤çš„è³‡æ–™ï¼ˆä¸å½±éŸ¿å…¶å®ƒæµç¨‹/æ¨£å¼ï¼‰ ===
let manName = '', womanName = '', currentRoleCode = ''; // ROLE_MALE_FRIEND / ROLE_FEMALE_FRIEND / ''
function activeRoleId(){ return document.querySelector('.role-btn.active')?.id || 'roleAll'; }
function dearTextByActive(){
  const id = activeRoleId();
  if(id==='roleMale')   return manName    ? `Dear ${manName}`    : 'Dear â€”';
  if(id==='roleFemale') return womanName  ? `Dear ${womanName}`  : 'Dear â€”';
  // å…¨éƒ¨ï¼šè‹¥å…©é‚Šéƒ½æœ‰å°±ã€ŒA æˆ– Bã€ï¼Œå¦å‰‡é¡¯ç¤ºæœ‰çš„é‚£å€‹
  const both = [manName, womanName].filter(Boolean);
  return both.length===2 ? `Dear ${manName} æˆ– ${womanName}` : (both[0] ? `Dear ${both[0]}` : 'Dear â€”');
}
function updateBrideLabelByUIRole(){ $('#brideLabel').textContent = dearTextByActive(); }

function setStatus(m){ $('#status').textContent = m; }

/* ===================== LIFF init & è§’è‰²/å§“å ===================== */
let lineId='',displayName='',pictureUrl='',myLastRow=null;

async function initLIFF(){
  if(!window.liff){ await initialLoad(); return; }
  try{
    await liff.init({ liffId: LIFF_ID, withLoginOnExternalBrowser:true });
    if(!liff.isLoggedIn()){
      // â˜… ç›´æ¥è¦æ±‚ scopeï¼Œç¢ºä¿èƒ½æ‹¿åˆ° lineId/displayName
      liff.login({ scope: ['openid','profile'] });
      return; // ç™»å…¥å¾Œæœƒå›åˆ°æœ¬é 
    }
    await liff.ready;
    const prof=await liff.getProfile().catch(()=>null);
    const idt =await liff.getDecodedIDToken().catch(()=>null);
    lineId      = (prof && prof.userId) || (idt && idt.sub) || '';
    displayName = (prof && prof.displayName) || (idt && (idt.name||idt.nickname)) || '';
    pictureUrl  = (prof && prof.pictureUrl) || '';
  }catch(_){}
  await fetchRoleAndNames();   // è§’è‰² + A/B åç¨±ï¼ˆå«ï¼šè‹¥å¥³æ–¹è¦ªå‹â†’é è¨­ Dear Cï¼‰
  await preloadMyLatest();     // è¼‰å…¥è‡ªå·±æœ€è¿‘ä¸€ç­†ï¼ˆè‹¥æœ‰ï¼‰
  await refreshWall();         // åˆ—è¡¨
}

/* ç„¡ LIFF ä¹Ÿèƒ½å…ˆè¼‰å…¥ç‰†ï¼ˆåŒ¿åç€è¦½ï¼‰ */
async function initialLoad(){ await fetchRoleAndNames(); await refreshWall(); }

/* âœ… å¾ GAS æ­£ç¢ºæŠ“ nameLabelï¼ˆaction=userroleï¼‰
   âœ è‹¥å›å‚³æ˜¯å¥³æ–¹è¦ªå‹ï¼ˆROLE_FEMALE_FRIEND / 'female'ï¼‰ï¼Œé è¨­é»äº®ã€Œå¥³æ–¹ã€ï¼ŒDear é¡¯ç¤ºæˆã€ŒDear Cã€ */
async function fetchRoleAndNames(){
  try{
    const url = WEBHOOK + `?action=userrole&lineId=${encodeURIComponent(lineId||'')}&_t=${Date.now()}`;
    const j = await (await fetch(url, {cache:'no-store'})).json();
    if(j?.ok){
      manName = String(j.man||'').trim();
      womanName = String(j.woman||'').trim();
      currentRoleCode = String(j.role||'').trim();

      // â˜… æ ¹æ“šè§’è‰²è‡ªå‹•åˆ‡æ› UI çš„é è¨­é¸æ“‡ï¼Œç¢ºä¿ã€ŒDearã€å°æ‡‰æ­£ç¢º
      const isFemale = /ROLE_FEMALE_FRIEND|female/i.test(currentRoleCode);
      const isMale   = /ROLE_MALE_FRIEND|male/i.test(currentRoleCode);

      document.querySelectorAll('.role-btn').forEach(b=>b.classList.remove('active'));
      if(isFemale){ $('#roleFemale').classList.add('active'); } 
      else if(isMale){ $('#roleMale').classList.add('active'); }
      else { $('#roleAll').classList.add('active'); }

      updateBrideLabelByUIRole();
    }
  }catch(_){}
}

/* ===================== ç°½åé è¦½ï¼ˆæˆåŠŸæ‰é¡¯ç¤ºç¸®åœ–ï¼‰ ===================== */
function setSignaturePreview(url, lock=false){
  chip.classList.remove('has-img');
  img.removeAttribute('src');
  if(!url){ lock ? chip.classList.add('locked') : chip.classList.remove('locked'); return; }

  const test = new Image();
  test.onload = () => {
    img.src = url;
    chip.classList.add('has-img');
    lock ? chip.classList.add('locked') : chip.classList.remove('locked');
  };
  test.onerror = () => {
    chip.classList.remove('has-img');
    chip.classList.remove('locked');
  };
  test.src = url;
}

/* ===================== è‡ªå·±æœ€è¿‘ä¸€ç­†ï¼ˆè¼‰å…¥å³é–ï¼‰ ===================== */
/* âœ… è·¯ç”±å°å¯«ï¼šgetlatestbylineid */
async function preloadMyLatest(){
  if(!lineId) return;
  try{
    const j=await (await fetch(WEBHOOK+`?action=getlatestbylineid&lineId=${encodeURIComponent(lineId)}&_t=${Date.now()}`, {cache:'no-store'})).json();
    if(j?.ok && j.item){
      const it=j.item;
      if(it.contentHTML){
        editor.textContent = it.contentHTML;     // é¡¯ç¤ºç´”æ–‡å­—
        editor.removeAttribute('data-empty');
        lockEditor();
      }
      if(it.signature){ setSignaturePreview(it.signature, true); }
      myLastRow = Number(it.row||0) || null;
    }
  }catch(_){}
}

/* ===================== å·¥å…·åˆ—ï¼ˆè¦–è¦ºï¼Œå„²å­˜ä»ç´”æ–‡å­—ï¼‰ ===================== */
function exec(cmd){ if(editor.hasAttribute('data-empty')||editor.classList.contains('locked')) return; document.execCommand(cmd,false,null); editor.focus(); }
$('#btnBold').onclick=()=>exec('bold');
$('#btnItalic').onclick=()=>exec('italic');
$('#btnUnderline').onclick=()=>exec('underline');
$('#colorPick').onchange=e=>{ e.target.blur(); }; // é¡è‰²åƒ…è¦–è¦ºï¼Œå…¥åº«ä¸å¸¶æ¨£å¼
let globalScale=1; function setScale(s){globalScale=Math.max(.7,Math.min(1.7,s)); editor.style.setProperty('--editor-zoom',globalScale+'rem');}
$('#btnBigger').onclick=()=>setScale(globalScale+.06);
$('#btnSmaller').onclick=()=>setScale(globalScale-.06);

const PLACEHOLDER='å¯«ä¸‹ä¸¦ç»ä¸Šæœ€èª æ‘¯çš„ç¥ç¦â€¦ğŸ’';
editor.addEventListener('focus',()=>{ if(editor.hasAttribute('data-empty')){ editor.textContent=''; editor.removeAttribute('data-empty'); }});
editor.addEventListener('blur',()=>{ if(!editor.textContent.trim()){ editor.setAttribute('data-empty',''); editor.textContent=PLACEHOLDER; }});

/* ===================== ç°½åï¼ˆèˆŠæ¨£å¼ï¼‹å®Œæ•´äº‹ä»¶ï¼‰ ===================== */
const sigOverlay = $('#sigOverlay');
const pad = $('#pad');
const ctx = pad.getContext('2d');
let drawing=false,lastX=0,lastY=0,signatureDataURL='';

function fitCanvas(){
  const dpr=Math.max(1,devicePixelRatio||1),w=pad.clientWidth,h=pad.clientHeight;
  pad.width=w*dpr; pad.height=h*dpr; ctx.setTransform(dpr,0,0,dpr,0,0);
  ctx.lineCap='round'; ctx.lineJoin='round'; ctx.lineWidth=3; ctx.strokeStyle='#111';
  ctx.clearRect(0,0,w,h);
}
function pos(e){ const r=pad.getBoundingClientRect(); const p=e.touches?e.touches[0]:e; return {x:p.clientX-r.left, y:p.clientY-r.top}; }
function start(e){ drawing=true; const p=pos(e); lastX=p.x; lastY=p.y; e.preventDefault(); }
function move(e){ if(!drawing)return; const p=pos(e); ctx.beginPath(); ctx.moveTo(lastX,lastY); ctx.lineTo(p.x,p.y); ctx.stroke(); lastX=p.x; lastY=p.y; e.preventDefault(); }
function end(){ drawing=false; }

/* åªæœ‰åœ¨æœªé–å®šæ™‚å¯ä»¥æ‰“é–‹ç°½åæ¿ */
chip.addEventListener('click',()=>{ if(chip.classList.contains('locked')) return; sigOverlay.classList.add('show'); setTimeout(fitCanvas,40); });
$('#sigClear').onclick=fitCanvas;
$('#sigCancel').onclick=()=>sigOverlay.classList.remove('show');
$('#sigOK').onclick=()=>{
  signatureDataURL=pad.toDataURL('image/png');
  setSignaturePreview(signatureDataURL, false);   // æˆåŠŸæ‰é¡¯ç¤ºç¸®åœ–
  sigOverlay.classList.remove('show');
};

/* ç­†åŠƒäº‹ä»¶ */
pad.addEventListener('mousedown',start);
pad.addEventListener('mousemove',move);
pad.addEventListener('mouseup',end);
pad.addEventListener('mouseleave',end);
pad.addEventListener('touchstart',start,{passive:false});
pad.addEventListener('touchmove',move,{passive:false});
pad.addEventListener('touchend',end);

/* ===================== ç¥ç¦ç‰† ===================== */
function escapeHTML(s){return String(s||'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));}
function fmt(s){return s?String(s).replace('T',' ').slice(0,19):'';}

function tileTemplate(it){
  return `<div class="tile" data-row="${it.row||''}" data-owner="${it.lineId||''}">
    <div class="rope"></div><div class="knot"></div>
    <div class="tile-plate">
      <div class="tile-name">${escapeHTML(it.displayName||'â€”')}</div>
      <div class="tile-sep"></div>
      <div class="tile-date">${escapeHTML(fmt(it.time))}</div>
      <div class="tile-sep"></div>
      <div class="tile-snippet">${escapeHTML((it.preview||'').trim()||'â€”')}</div>
    </div>
  </div>`;
}

/* âœ… è·¯ç”±å°å¯«ï¼šlistblessings */
async function refreshWall(){
  try{
    const role=document.querySelector('.role-btn.active')?.id?.replace('role','').toLowerCase()||'all';
    const j=await (await fetch(WEBHOOK+`?action=listblessings&role=${role}&_t=${Date.now()}`, {cache:'no-store'})).json();
    if(j?.ok){
      wallEl.innerHTML=(j.items||[]).map(tileTemplate).join('');
      bindTileClicks();
    }
  }catch(_){}
}

/* âœ… è·¯ç”±å°å¯«ï¼šgetblessingdetail */
function bindTileClicks(){ document.querySelectorAll('.tile').forEach(t=>t.addEventListener('click',()=>openView(t))); }
async function openView(el){
  const row=el.getAttribute('data-row');
  const j=await (await fetch(WEBHOOK+`?action=getblessingdetail&id=${encodeURIComponent(row)}&_t=${Date.now()}`, {cache:'no-store'})).json();
  if(j?.ok&&j.item){
    $('#viewMeta').textContent=`${j.item.displayName||'â€”'} ï½œ ${fmt(j.item.time)}`;
    const vc=$('#viewContent');
    vc.textContent = j.item.contentHTML || '';  // ç´”æ–‡å­—é¡¯ç¤º
    $('#viewOverlay').classList.add('show');
  }
}
$('#viewClose').onclick=()=>$('#viewOverlay').classList.remove('show');

/* â˜… è§’è‰²éµï¼šç¶­æŒåŸè¡Œç‚ºï¼‹åŒæ­¥ Dear æ¨™ç±¤ */
$('#roleAll').onclick   =()=>{document.querySelectorAll('.role-btn').forEach(b=>b.classList.remove('active'));$('#roleAll').classList.add('active');  updateBrideLabelByUIRole(); refreshWall();};
$('#roleMale').onclick  =()=>{document.querySelectorAll('.role-btn').forEach(b=>b.classList.remove('active'));$('#roleMale').classList.add('active'); updateBrideLabelByUIRole(); refreshWall();};
$('#roleFemale').onclick=()=>{document.querySelectorAll('.role-btn').forEach(b=>b.classList.remove('active'));$('#roleFemale').classList.add('active');updateBrideLabelByUIRole(); refreshWall();};

/* ===================== é€å‡º / æ›´æ–°ï¼ˆç´”æ–‡å­—å…¥åº«ï¼‰ ===================== */
function lockEditor(){editor.classList.add('locked');editor.setAttribute('contenteditable','false');}
function unlockEditor(){editor.classList.remove('locked');editor.setAttribute('contenteditable','true');editor.focus();}
$('#btnEdit').onclick=()=>unlockEditor();

function hasSignature(){return chip.classList.contains('has-img');}

/* âœ… è·¯ç”±å°å¯«ï¼šcreateblessing / updateblessing */
async function sendOrUpdate(){
  const contentPlain=(editor.hasAttribute('data-empty')?'':editor.textContent).trim(); // ç´”æ–‡å­—
  if(!contentPlain){ alert('æ¬¸ï¼Œä¸å¯èƒ½ä¸ç¥ç¦æˆ‘å€‘å§ğŸ–•ï¸'); return; }
  if(!hasSignature()){ alert('æ¬¸ï¼Œæ²’æœ‰ç•«æŠ¼ä¸å‡†é›¢é–‹âœï¸'); return; }

  // â˜… è‹¥å°šæœªç™»å…¥ï¼Œæç¤ºä¸¦å¼•å°ï¼ˆèˆ‡äº’å‹•éŸ³ç¬¦ä¸€è‡´ï¼‰
  if(!lineId){
    alert('è«‹æ–¼ LINE App å…§é–‹å•Ÿä¸¦ç™»å…¥å¾Œå†é€å‡ºå”·');
    try{ if(window.liff && !liff.isLoggedIn()) liff.login({ scope: ['openid','profile'] }); }catch(_){}
    return;
  }

  const payload = myLastRow
    ? {action:'updateblessing',row:Number(myLastRow),lineId,contentHTML:contentPlain}
    : {action:'createblessing',lineId,displayName,pictureUrl,contentHTML:contentPlain,signaturePNG:signatureDataURL||'',extra:{}};

  const r=await fetch(WEBHOOK,{
    method:'POST',
    headers:{'Content-Type':'text/plain;charset=UTF-8'}, /* text/plain å¯é¿é–‹é æª¢ï¼ˆä¿ç•™ä½ çš„ç¿’æ…£ï¼‰ */
    body:JSON.stringify(payload)
  });
  const j=await r.json().catch(()=>null);

  if(j?.ok){
    lockEditor(); await refreshWall(); if(!myLastRow) await preloadMyLatest();
    setStatus(myLastRow?'âœ… å·²æ›´æ–°ä¸¦é–å®šå®Œæˆï¼Œæ–¼æˆªæ­¢æ—¥å‰éƒ½å¯ä¿®æ”¹å”·':'âœ… å·²é€å‡ºä¸¦é–å®šå®Œæˆï¼Œæ–¼æˆªæ­¢æ—¥å‰éƒ½å¯ä¿®æ”¹å”·');
    chip.classList.add('locked'); // é€å‡ºå¾Œé–ç°½å
  } else if(j?.error==='deadline_passed'){
    setStatus('â›” å·²åˆ°æˆªæ­¢æ—¥ï¼Œç„¡æ³•ç·¨è¼¯åŠé€å‡º'); lockEditor();
  } else {
    setStatus('âŒ é€å‡ºå¤±æ•—ï¼Œç¨å¾Œå†è©¦');
  }
}
$('#btnSend').onclick=sendOrUpdate;
$('#btnSubmit').onclick=sendOrUpdate;

/* ===================== å•Ÿå‹• ===================== */
window.addEventListener('DOMContentLoaded',()=>{
  if(!editor.textContent.trim()){
    editor.setAttribute('data-empty','');
    editor.textContent='å¯«ä¸‹ä¸¦ç»ä¸Šæœ€èª æ‘¯çš„ç¥ç¦â€¦ğŸ’';
  }
  if(window.liff) initLIFF(); else initialLoad();
});
</script>

<!-- âœ… LIFF SDKï¼ˆæ”¾åœ¨æ–‡æœ«ï¼Œèˆ‡ä½ åŸæœ¬ç›¸åŒï¼‰ -->
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</body>
</html>
