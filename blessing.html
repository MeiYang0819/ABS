<!doctype html>
<html lang="zh-Hant">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>❤️同心祈願❤️</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Patrick+Hand:wght@400&family=Sacramento:wght@400;700&display=swap" rel="stylesheet">

<style>
:root{
  --brand-bg:#c9daf8;
  --title:#A68A7C;  --ink:#0f172a; --accent:#A68A7C; --rim:#E4E4E4; --soft:#F5F1EC;
  --panel-grad-from:#b7d2f6; --panel-grad-to:#cfe1fb;

  --panel-maxw:1320px;
  --radius-xl:16px; --radius-md:12px;
  --shadow-1:0 10px 26px rgba(0,0,0,.10);
  --shadow-2:0 2px 0 rgba(0,0,0,.15), 0 2px 8px rgba(0,0,0,.06);

  --tool-h:40px;  /* Dear 與按鈕統一高度 */
  --btn-w:180px;
  --copyright-pad:20px;
}

.bg-notes{position:fixed;inset:0;width:100%;height:100%;object-fit:cover;z-index:0;}

*{box-sizing:border-box;}
html,body{height:100%;margin:0;overflow:hidden;color:var(--ink);background:var(--brand-bg);
  font-family:"Patrick Hand","Noto Sans TC",system-ui,-apple-system,sans-serif;}

.panel{position:relative;z-index:1;max-width:var(--panel-maxw);
  height:calc(100vh - 110px);margin:26px auto;background:linear-gradient(135deg,var(--panel-grad-from),var(--panel-grad-to));
  border:1px solid var(--rim);border-radius:16px;box-shadow:var(--shadow-1);display:flex;flex-direction:column;overflow:hidden;}
h2{margin:12px 0 6px;text-align:center;font-family:"Sacramento",cursive;font-size:2.6rem;color:var(--title);}

.bar{padding:6px 22px 8px;}
.bar-inner{max-width:1200px;margin:0 auto;display:flex;align-items:center;gap:12px;}
.toolbar{display:flex;gap:8px;}
.tool-btn{min-width:64px;height:var(--tool-h);padding:0 12px;background:#fff;border:1px solid var(--rim);border-radius:12px;font-weight:700;}

.rolebar{display:flex;gap:8px;}
.role-btn{min-width:64px;height:var(--tool-h);padding:0 12px;background:#fff;border:1px solid var(--rim);border-radius:12px;font-weight:700;}
.role-btn.active{outline:2px solid rgba(0,0,0,.15);}
#status{flex:1 1 auto;min-width:240px;background:#F5F1EC;border:1px solid #E4E4E4;border-radius:12px;padding:8px 10px;font-size:14px;text-align:center;color:#A68A7C;font-weight:700;}

.stage{flex:1 1 auto;padding:14px 22px 0;display:flex;justify-content:center;}
.card{position:relative;width:100%;max-width:1200px;border:1px solid rgba(0,0,0,.05);border-radius:16px;box-shadow:0 10px 26px rgba(0,0,0,.08);
  padding:22px;height:100%;display:grid;grid-template-columns:1fr 2fr;gap:14px;background:#e6b8af;}
.left-wrap{position:relative;background:#fff8dc;border-radius:16px;padding:12px;}

.chip{min-width:160px;height:var(--tool-h);background:#fff;border:1px solid var(--rim);border-radius:10px;display:flex;align-items:center;justify-content:center;gap:8px;padding:0 10px;}
#chipBride{margin-bottom:10px;}

.editor{height:calc(100% - var(--tool-h) - 20px);overflow:auto;line-height:1.8;outline:none;border:1px dashed rgba(0,0,0,.12);border-radius:12px;padding:14px;font-size:1rem;}
.editor.locked{pointer-events:none;opacity:.85;}

.left-actions{display:flex;gap:10px;margin-top:10px;}
.left-actions button,.left-actions .chip{flex:1 1 0;height:var(--tool-h);background:#fff;border:1px solid var(--rim);border-radius:10px;font-weight:800;}

#chipSign{cursor:pointer;}
#chipSign.locked{pointer-events:none;opacity:.9;}
#signThumb{display:none;width:100%;height:70%;object-fit:contain;}
#chipSign.has-img #signThumb{display:block;}
#chipSign.has-img .hint{display:none;}

.wall-wrap{background:#fce4ec;border-radius:16px;padding:12px;overflow:auto;}
.wall{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:14px;}

.footer-copyright{text-align:center;padding:var(--copyright-pad) 0;font-size:13px;color:#6b5e52;font-weight:700;}
.overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.35);}
.overlay.show{display:flex;}
#pad{width:100%;height:260px;background:#fff;border:1px solid #ddd;border-radius:12px;}
</style>

<body>
  <img class="bg-notes" src="./assets/favos.png?v=4" alt="">
  <div class="panel">
    <h2>❤️同心祈願❤️</h2>
    <div class="bar"><div class="bar-inner">
      <div class="rolebar">
        <button type="button" class="role-btn active" id="roleAll">全部</button>
        <button type="button" class="role-btn" id="roleMale">男方</button>
        <button type="button" class="role-btn" id="roleFemale">女方</button>
      </div>
      <p id="status">📥 還在等待，待送出資料</p>
      <div class="toolbar">
        <button class="tool-btn" id="btnBold">粗體</button>
        <button class="tool-btn" id="btnItalic">斜體</button>
        <button class="tool-btn" id="btnUnderline">底線</button>
      </div>
    </div></div>

    <div class="stage">
      <div class="card">
        <section class="left-wrap">
          <div id="chipBride" class="chip"><span id="brideLabel">Dear —</span></div>
          <div id="editor" class="editor" contenteditable="true" data-empty>寫下並獻上最誠摯的祝福…💝</div>
          <div class="left-actions">
            <button id="btnEdit">再次修改</button>
            <button id="btnSend">送出祝福</button>
            <div id="chipSign" class="chip"><span class="hint">畫押簽名</span><img id="signThumb"></div>
          </div>
        </section>
        <section class="wall-wrap"><div id="wall" class="wall"></div></section>
      </div>
    </div>

    <div class="footer-copyright">© Copyright 2025 MY‘s System</div>
  </div>

  <!-- 簽名 Modal -->
  <div id="sigOverlay" class="overlay"><canvas id="pad"></canvas></div>

<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script>
const LIFF_ID='2008149060-m5pDXW6a';
const WEBHOOK='https://script.google.com/macros/s/AKfycby-yPxuPhS9hk-uLLSEZRuEfHqw1r16ND6c_6D2GzoN0XEnu-cWg1DIw_-i2G50YM2t/exec';

const editor=document.getElementById('editor');
let lineId='',displayName='',pictureUrl='',myLastRow=null,signatureDataURL='';

async function initLIFF(){
  try{
    await liff.init({ liffId: LIFF_ID, withLoginOnExternalBrowser:true });
    if(!liff.isLoggedIn()){ liff.login(); return; }
    const prof=await liff.getProfile();
    lineId=prof.userId; displayName=prof.displayName; pictureUrl=prof.pictureUrl;
  }catch(_){}
}
function lockEditor(){editor.classList.add('locked');}
function unlockEditor(){editor.classList.remove('locked');editor.focus();}
document.getElementById('btnEdit').onclick=()=>unlockEditor();

function hasSignature(){return document.getElementById('chipSign').classList.contains('has-img');}
async function sendOrUpdate(){
  if(editor.hasAttribute('data-empty')||!editor.textContent.trim()){alert('欸，不可能不祝福我們吧🖕️');return;}
  if(!hasSignature()){alert('欸，沒有畫押不准離開✍️');return;}
  const payload=myLastRow
    ? {action:'updateBlessing',row:myLastRow,lineId,contentHTML:editor.innerHTML.trim()}
    : {action:'createBlessing',lineId,displayName,pictureUrl,contentHTML:editor.innerHTML.trim(),signaturePNG:signatureDataURL||''};
  const r=await fetch(WEBHOOK,{method:'POST',headers:{'Content-Type':'text/plain'},body:JSON.stringify(payload)});
  const j=await r.json().catch(()=>null);
  if(j?.ok){lockEditor();document.getElementById('status').textContent='✅ 已送出並鎖定';}
}
document.getElementById('btnSend').onclick=sendOrUpdate;

/* 簽名 */
const sigOverlay=document.getElementById('sigOverlay'),pad=document.getElementById('pad'),ctx=pad.getContext('2d');
let drawing=false,lastX=0,lastY=0;
function fitCanvas(){pad.width=pad.clientWidth;pad.height=pad.clientHeight;ctx.lineWidth=3;ctx.strokeStyle='#000';}
pad.addEventListener('mousedown',e=>{drawing=true;lastX=e.offsetX;lastY=e.offsetY;});
pad.addEventListener('mousemove',e=>{if(!drawing)return;ctx.beginPath();ctx.moveTo(lastX,lastY);ctx.lineTo(e.offsetX,e.offsetY);ctx.stroke();lastX=e.offsetX;lastY=e.offsetY;});
pad.addEventListener('mouseup',()=>{drawing=false;});
document.getElementById('chipSign').onclick=()=>{if(document.getElementById('chipSign').classList.contains('locked'))return;sigOverlay.classList.add('show');fitCanvas();};
sigOverlay.onclick=()=>{signatureDataURL=pad.toDataURL('image/png');document.getElementById('signThumb').src=signatureDataURL;document.getElementById('chipSign').classList.add('has-img');sigOverlay.classList.remove('show');};

window.addEventListener('DOMContentLoaded',initLIFF);
</script>
</body>
</html>
