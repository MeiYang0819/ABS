<!doctype html>
<html lang="zh-Hant">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>é€ä¸Šç¥ç¦</title>

<!-- âœ… æˆ‘å¯ä»¥èª¿ï¼šå­—é«”ï¼ˆæ¨™é¡Œ/å…§æ–‡ï¼‰ -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<!-- Sacramentoï¼ˆæ¨™é¡Œï¼‰ï¼‹ Patrick Handï¼ˆå…§æ–‡/å·¥å…·åˆ—/ç‹€æ…‹åˆ—ï¼‰ -->
<link href="https://fonts.googleapis.com/css2?family=Patrick+Hand:wght@400&family=Sacramento:wght@400;700&display=swap" rel="stylesheet">

<style>
/* ====================== å…¨åŸŸè®Šæ•¸ï¼ˆæˆ‘å¯ä»¥èª¿ï¼šé…è‰²/å°ºå¯¸/é™°å½±/åœ–ç‰‡ï¼‰ ====================== */
:root{
  /* â€”â€” ä¸»é¡Œé¡è‰² â€”â€” */
  --brand-bg: #c9daf8;          /* âœ… æˆ‘å¯ä»¥èª¿ï¼šæ•´é åº•è‰²ï¼ˆè—ï¼‰ */
  --paper:    #fff2cc;          /* âœ… æˆ‘å¯ä»¥èª¿ï¼šå…§æ–‡åº•è‰²ï¼ˆé»ƒï¼‰ */
  --title:    #A68A7C;          /* âœ… æˆ‘å¯ä»¥èª¿ï¼šæ¨™é¡Œå­—è‰²ï¼ˆæ²¿ç”¨äº’å‹•éŸ³ç¬¦ä¸»é¡Œï¼‰ */
  --ink:      #0f172a;          /* âœ… æˆ‘å¯ä»¥èª¿ï¼šä¸€èˆ¬æ–‡å­—è‰² */
  --accent:   #A68A7C;          /* âœ… æˆ‘å¯ä»¥èª¿ï¼šé‡é»/é£¾è‰²ï¼ˆå’Œäº’å‹•éŸ³ç¬¦ä¸€è‡´ï¼‰ */
  --rim:      #E4E4E4;          /* âœ… æˆ‘å¯ä»¥èª¿ï¼šé‚Šæ¡†åŸºè‰² */
  --soft:     #F5F1EC;          /* âœ… ç‹€æ…‹åˆ—/æç¤ºåº•è‰²ï¼ˆèˆ‡äº’å‹•éŸ³ç¬¦ä¸€è‡´ï¼›éœ€æ±‚ï¼šåˆ¥å‹•æ¨£å¼æ™‚ä¹Ÿå¯å¾®èª¿è‰²ï¼‰ */

  /* â€”â€” èƒŒæ™¯åœ–ç‰‡ï¼ˆè«‹æŠŠ wedding-bg.jpg æ”¾åœ¨ /assetsï¼Œæˆ–æ”¹ URLï¼‰â€”â€” */
  --bg-image-url: url("./assets/wedding-bg.jpg");  /* âœ… æˆ‘å¯ä»¥èª¿ï¼šèƒŒæ™¯åœ–è·¯å¾‘ */

  /* â€”â€” æ¼¸å±¤ï¼ˆæ¨™é¡Œåˆ—ï¼‰â€”â€” */
  --titlebar-grad-from: #b7d2f6; /* âœ… æˆ‘å¯ä»¥èª¿ï¼šæ¨™é¡Œåˆ—æ¼¸å±¤è‰²(å·¦/ä¸Š) */
  --titlebar-grad-to:   #cfe1fb; /* âœ… æˆ‘å¯ä»¥èª¿ï¼šæ¨™é¡Œåˆ—æ¼¸å±¤è‰²(å³/ä¸‹) */

  /* â€”â€” ç‰ˆå¯¬èˆ‡åœ“è§’/é™°å½± â€”â€” */
  --panel-maxw: 1020px;         /* âœ… æˆ‘å¯ä»¥èª¿ï¼šä¸»è¦é¢æ¿æœ€å¤§å¯¬ */
  --radius-xl:  16px;           /* âœ… æˆ‘å¯ä»¥èª¿ï¼šæ•´é«”å¤§åœ“è§’ */
  --radius-md:  12px;           /* âœ… æˆ‘å¯ä»¥èª¿ï¼šä¸€èˆ¬å…ƒä»¶åœ“è§’ */
  --shadow-1:   0 10px 26px rgba(0,0,0,.10);  /* âœ… æˆ‘å¯ä»¥èª¿ï¼šé¢æ¿é™°å½± */
  --shadow-2:   0 2px 0 rgba(0,0,0,.15), 0 2px 8px rgba(0,0,0,.06); /* âœ… æˆ‘å¯ä»¥èª¿ï¼šæŒ‰éˆ•é™°å½± */

  /* â€”â€” å…§æ–‡æ’ç‰ˆ â€”â€” */
  --content-pad: 22px;          /* âœ… æˆ‘å¯ä»¥èª¿ï¼šå…§æ–‡ paddingï¼ˆå››å‘¨ï¼‰ */
  --content-gap: 14px;          /* âœ… æˆ‘å¯ä»¥èª¿ï¼šå…§æ–‡å€å¡Šä¸Šä¸‹é–“è· */
  --content-line: 2px;          /* âœ… æˆ‘å¯ä»¥èª¿ï¼šå…§æ–‡è™›ç·šç²—ç´°ï¼ˆæ‰‹ç¹ªç·šæ¢æ„Ÿï¼‰ */
  --content-line-alpha: .18;    /* âœ… æˆ‘å¯ä»¥èª¿ï¼šå…§æ–‡è™›ç·šé€æ˜åº¦ */

  /* â€”â€” å·¥å…·åˆ—/ç‹€æ…‹åˆ— â€”â€” */
  --toolbar-gap: 8px;           /* âœ… æˆ‘å¯ä»¥èª¿ï¼šå·¥å…·åˆ—æŒ‰éˆ•é–“è· */
  --status-fz: 14px;            /* âœ… æˆ‘å¯ä»¥èª¿ï¼šç‹€æ…‹åˆ—å­—ç´šï¼ˆå·²èˆ‡äº’å‹•éŸ³ç¬¦ä¸€è‡´=14pxï¼‰ */

  /* â€”â€” æ¨™é¡Œå°ºå¯¸ï¼ˆèˆ‡äº’å‹•éŸ³ç¬¦ä¸€è‡´ï¼‰â€”â€” */
  --h2-size: 2.8rem;            /* âœ… æˆ‘å¯ä»¥èª¿ï¼šæ¨™é¡Œå­—ç´š */

  /* â€”â€” å…¨ç«™æé‚Š/é«˜å…‰ï¼ˆèˆ‡äº’å‹•éŸ³ç¬¦åŒè³ªæ„Ÿï¼‰â€”â€” */
  --stroke: rgba(0,0,0,.18);    /* âœ… æˆ‘å¯ä»¥èª¿ï¼šæ–‡å­—æé‚Š */
  --glow:   rgba(255,255,255,.65); /* âœ… æˆ‘å¯ä»¥èª¿ï¼šæ–‡å­—é«˜å…‰ */
}

/* ====================== å…¨ç«™èˆ‡èƒŒæ™¯ ====================== */
*{ box-sizing:border-box; }
html,body{
  margin:0; color:var(--ink);
  background: var(--brand-bg);
  font-family: "Patrick Hand","Noto Sans TC",system-ui,-apple-system,sans-serif;
  -webkit-text-stroke:.35px var(--stroke);
  text-shadow:0 1px 0 var(--glow);
}
body::before{
  /* âœ… æˆ‘å¯ä»¥èª¿ï¼šèƒŒæ™¯åœ– + æŸ”åŒ–/æ··åˆ */
  content:""; position:fixed; inset:0; z-index:-1;
  background-image: var(--bg-image-url);
  background-size:cover; background-position:center;
  opacity:.35; mix-blend-mode:multiply; filter:contrast(1.05) saturate(1.05);
}

/* ====================== é¢æ¿ & æ¨™é¡Œåˆ— ====================== */
.panel{
  max-width: var(--panel-maxw);
  margin: 22px auto;
  background: #E4E4E4;                     /* èˆ‡äº’å‹•éŸ³ç¬¦çš„é¢æ¿è‰²ç³»ä¸€è‡´ */
  border:1px solid var(--rim);
  border-radius: var(--radius-xl);
  box-shadow: var(--shadow-1);
  overflow:hidden;                          /* è®“ titlebar åœ“è§’è²¼é½Š */
}

/* â€”â€” æ¨™é¡Œåˆ—ï¼ˆè—è‰²æ¼¸å±¤ï¼‰ â€”â€” */
.titlebar{
  background: linear-gradient(135deg, var(--titlebar-grad-from), var(--titlebar-grad-to)); /* âœ… æˆ‘å¯ä»¥èª¿ï¼šæ¼¸å±¤è‰² */
  padding: 10px 16px;
  position: relative;
}

/* â€”â€” æ¨™é¡Œï¼ˆå­—è‰²å›åŸä¸»é¡Œè‰²ï¼›ç½®ä¸­ï¼‰ â€”â€” */
h2{
  margin: 4px 0 6px;
  text-align:center;
  font-family: "Sacramento", cursive;
  font-weight: 700;            /* Sacramento æ²’ç²—é«”ï¼Œé€™è£¡ä¿ç•™ 700 åšè¦–è¦ºå¼·åŒ– */
  font-size: var(--h2-size);   /* èˆ‡äº’å‹•éŸ³ç¬¦ä¸€è‡´ */
  letter-spacing: 1px;
  color: var(--title);         /* éœ€æ±‚ï¼šå›åŸæœ¬é¡è‰² */
  -webkit-text-stroke:.6px rgba(0,0,0,.12);
  text-shadow:0 3px 4px rgba(255,255,255,.75);
}

/* â€”â€” æ¨™é¡Œåˆ—ä¸‹æ–¹ï¼šå·¥å…·åˆ— + ç‹€æ…‹åˆ—åŒè¡Œ â€”â€” */
.bar{
  display:flex; align-items:center; justify-content:space-between;
  gap: 10px;
  padding: 8px 16px 12px;
  background: transparent;
}

/* â€”â€” ä¸­å¤®å·¥å…·åˆ—ï¼ˆåªä¿ç•™å››é¡†ï¼›ç½®ä¸­è¦–è¦ºï¼‰ â€”â€” */
.toolbar{
  display:flex; gap: var(--toolbar-gap);
  margin: 0 auto;                     /* è¦–è¦ºç½®ä¸­ */
  filter: drop-shadow(0 2px 0 rgba(0,0,0,.08));
}
.tool-btn{
  min-width: 64px; height: 36px; padding: 0 12px;
  background:#fff; border:1px solid var(--rim); border-radius: var(--radius-md);
  font-weight:700; cursor:pointer;
  -webkit-text-stroke:.25px rgba(0,0,0,.12); text-shadow:0 1px 0 rgba(255,255,255,.5);
  box-shadow: var(--shadow-2);
  display:flex; align-items:center; justify-content:center; gap:6px;
}
.tool-btn:active{ transform:translateY(1px) scale(.99); }

/* â€”â€” ç‹€æ…‹åˆ—ï¼ˆèˆ‡äº’å‹•éŸ³ç¬¦ä¸€è‡´ï¼›æ”¾å³å´ï¼‰ â€”â€” */
#status{
  background: var(--soft); border:1px solid #E4E4E4; border-radius:12px;
  padding:10px; font-size: var(--status-fz); white-space:pre-wrap; text-align:center;
  color: var(--accent) !important; font-weight:700;
  -webkit-text-stroke:.35px rgba(0,0,0,.10);
  text-shadow:0 1px 0 rgba(255,255,255,.85), 0 3px 6px rgba(0,0,0,.04);
  min-width: 220px;               /* âœ… æˆ‘å¯ä»¥èª¿ï¼šç‹€æ…‹åˆ—æœ€å°å¯¬åº¦ */
}
#status.ok,#status.busy,#status.err{
  color: var(--accent) !important;
}

/* ====================== å…§å®¹å®¹å™¨ ====================== */
.stage{
  position:relative;
  padding: 22px 22px 26px;
}

/* â€”â€” å…§æ–‡å¡ï¼ˆè¼ƒå¯¬çš„å·¦å³ç•™ç™½ï¼›é»ƒåº•+æŸ”å’Œæ¼¸å±¤ï¼‰ â€”â€” */
.card{
  position:relative;
  margin: 18px auto;
  background: linear-gradient(180deg, rgba(255,242,204,.98), rgba(255,242,204,.92)); /* âœ… æˆ‘å¯ä»¥èª¿ï¼šå…§æ–‡æ¼¸å±¤ */
  border:1px solid rgba(0,0,0,.05);
  border-radius: var(--radius-xl);
  box-shadow: 0 10px 26px rgba(0,0,0,.08);
  max-width: 900px;                    /* âœ… æˆ‘å¯ä»¥èª¿ï¼šå…§æ–‡å¡æœ€å¤§å¯¬ï¼ˆéœ€æ±‚ï¼šå·¦å³æ›´å¯¬ï¼‰ */
  padding: var(--content-pad);
}

/* â€”â€” å…§æ–‡å¯ç·¨è¼¯å€ï¼ˆcontenteditableï¼‰ â€”â€” */
.editor{
  min-height: 320px;                   /* âœ… æˆ‘å¯ä»¥èª¿ï¼šå…§æ–‡é«˜åº¦ */
  line-height: 1.8;                    /* âœ… æˆ‘å¯ä»¥èª¿ï¼šè¡Œé«˜ï¼ˆæ›´æœ‰æ‰‹å¯«æ„Ÿï¼‰ */
  outline: none;
  background: transparent;
  border-radius: var(--radius-md);
  padding: 10px 12px;
  /* æ‰‹å¯«ç¨¿è™›ç·šï¼ˆè¦–è¦ºå‡å‹»ï¼‰ï¼šç”¨ background-size æ§åˆ¶ç²—ç´°èˆ‡é–“éš” */
  background-image:
    linear-gradient(to bottom, rgba(0,0,0,var(--content-line-alpha)) var(--content-line), transparent 0);
  background-size: 100% 38px;          /* âœ… æˆ‘å¯ä»¥èª¿ï¼šæ¯è¡Œè·é›¢ï¼ˆåƒç­†è¨˜æ©«ç·šï¼‰ */
}

/* â€”â€” æ–‡å­—å¼·èª¿ï¼ˆæ”¾å¤§/ç¸®å°çš„ classï¼Œæ”¯æ´é€£é»é€ç´šï¼‰ â€”â€” */
.fs-up-1 { font-size: 1.15em; }
.fs-up-2 { font-size: 1.30em; }
.fs-up-3 { font-size: 1.50em; }
.fs-down-1 { font-size: .92em; }
.fs-down-2 { font-size: .84em; }
.fs-down-3 { font-size: .76em; }

/* â€”â€” å·¦ä¸Š/å³ä¸‹çš„å°æ¡†ï¼ˆæ–°äºº / ç°½åï¼‰ â€”â€” */
/* æ–°äººï¼šè²¼åœ¨ã€Œå…§æ–‡å¡ã€å¤–æ¡†å·¦ä¸Šè§’ */
.badge-top-left{
  position:absolute; left: -8px; top: -12px;         /* âœ… æˆ‘å¯ä»¥èª¿ï¼šè²¼é½Šç¨‹åº¦ */
  background: var(--paper);                          /* éœ€æ±‚ï¼šå’Œå…§æ–‡åº•è‰²ä¸€è‡´ */
  color: var(--ink);
  padding: 8px 12px;
  border-radius: 10px;
  border: none;                                      /* éœ€æ±‚ï¼šæ–°äººç„¡å¤–æ¡† */
  box-shadow: 0 2px 8px rgba(0,0,0,.06);
  font-weight:700;
}
/* ç°½åï¼šè²¼åœ¨ã€Œå…§æ–‡å¡ã€å¤–æ¡†å³ä¸‹è§’ */
.badge-bottom-right{
  position:absolute; right: -8px; bottom: -12px;     /* âœ… æˆ‘å¯ä»¥èª¿ï¼šè²¼é½Šç¨‹åº¦ */
  background: var(--paper);                          /* éœ€æ±‚ï¼šå’Œå…§æ–‡åº•è‰²ä¸€è‡´ */
  color: var(--ink);
  padding: 8px 12px;
  border-radius: 10px;
  border: 1px solid rgba(0,0,0,.08);                 /* éœ€æ±‚ï¼šç°½åæ·¡æ·¡å¤–æ¡† */
  box-shadow: 0 2px 8px rgba(0,0,0,.06);
  font-weight:700;
  display:flex; align-items:center; gap:8px;
  cursor:pointer;
}
.badge-bottom-right img{
  width: 64px; height: 36px; object-fit:contain;     /* âœ… æˆ‘å¯ä»¥èª¿ï¼šç¸®åœ–å¤§å° */
  background:#fff; border-radius:6px; border:1px dashed rgba(0,0,0,.08);
}

/* â€”â€” é€å‡ºæŒ‰éˆ•ï¼ˆç½®ä¸­ï¼‹æŒ‰éµæ„Ÿï¼Œåƒç…§äº’å‹•éŸ³ç¬¦ï¼‰ â€”â€” */
.actions{
  display:flex; align-items:center; justify-content:center;
  margin-top: 18px;
}
.primary{
  min-width: 180px; height: 42px; padding: 0 18px;
  background:#fff; border:1px solid var(--rim); border-radius: var(--radius-md);
  font-weight:700; cursor:pointer;
  box-shadow: var(--shadow-2);
}
.primary:active{ transform:translateY(1px) scale(.99); }

/* ====================== ç°½å Modal ====================== */
.overlay{ position:fixed; inset:0; z-index:9999; display:none; align-items:center; justify-content:center; background:rgba(17,24,39,.35); backdrop-filter:blur(3px); }
.overlay.show{ display:flex; }
.dialog{
  width:min(92vw, 520px);
  background: var(--soft);
  border:1px solid var(--rim);
  border-radius: 14px;
  padding: 16px;
  box-shadow: 0 18px 44px rgba(0,0,0,.18);
}
.dialog h3{ margin: 0 0 10px; font-size:18px; color:#6b5e52; text-align:center; -webkit-text-stroke:0; text-shadow:none; }
#pad{
  width:100%; height:260px;                        /* âœ… æˆ‘å¯ä»¥èª¿ï¼šç°½åç•«å¸ƒå¤§å° */
  background:#fff; border:1px solid #ddd; border-radius:12px;
  touch-action:none;
}
.dlg-actions{ display:flex; gap:10px; justify-content:center; margin-top:12px; }
.dlg-actions button{ width:120px; height:38px; border-radius:10px; border:1px solid var(--rim); background:#fff; cursor:pointer; font-weight:700; }

/* ====================== Footer ====================== */
footer{ max-width: var(--panel-maxw); margin: 8px auto 22px; text-align:center; color:#6b5e52; font-size:12px; opacity:.9; }
</style>

<body>
  <div class="panel">
    <!-- æ¨™é¡Œåˆ—ï¼ˆè—è‰²æ¼¸å±¤ï¼‰ -->
    <div class="titlebar">
      <h2>é€ä¸Šç¥ç¦</h2>
      <div class="bar">
        <!-- å·¥å…·åˆ—ï¼ˆç½®ä¸­é¡¯ç¤ºï¼‰ -->
        <div class="toolbar" role="toolbar" aria-label="æ–‡å­—å·¥å…·">
          <button class="tool-btn" id="btnBold"      type="button"><span>ç²—é«”</span></button>   <!-- âœ… æˆ‘å¯ä»¥èª¿ï¼šæ–‡æ¡ˆ -->
          <button class="tool-btn" id="btnUnderline" type="button"><span>åº•ç·š</span></button>
          <button class="tool-btn" id="btnBigger"    type="button"><span>æ”¾å¤§</span></button>
          <button class="tool-btn" id="btnSmaller"   type="button"><span>ç¸®å°</span></button>
        </div>
        <!-- ç‹€æ…‹åˆ—ï¼ˆæ”¾å³å´ï¼›æ¨£å¼èˆ‡äº’å‹•éŸ³ç¬¦ä¸€è‡´ï¼‰ -->
        <p id="status">å°šæœªåˆå§‹åŒ–</p>
      </div>
    </div>

    <!-- å…§å®¹èˆå° -->
    <div class="stage">
      <!-- å…§æ–‡å¡ -->
      <div class="card" id="card">
        <!-- å·¦ä¸Šï¼šæ–°äººï¼ˆç”±å¾Œç«¯å¸¶å…¥ï¼›é è¨­ä½”ä½ï¼‰ -->
        <div class="badge-top-left" id="chipBride"><span id="brideLabel">æ–°äººï¼šâ€”</span></div>
        <!-- å³ä¸‹ï¼šç°½åï¼ˆå¯é»é–‹æ”¾å¤§ç°½ï¼‰ -->
        <div class="badge-bottom-right" id="chipSign">
          <span>é»æˆ‘ç°½å</span>
          <img id="signThumb" alt="signature preview" />
        </div>

        <!-- å…§æ–‡ï¼ˆcontenteditableï¼‰ -->
        <div id="editor" class="editor" contenteditable="true" aria-label="ç¥ç¦å…§å®¹">
          åœ¨æ­¤å¯«ä¸‹ä½ å°æ–°äººçš„ç¥ç¦â€¦ï¼ˆå¯é¸å­—å¾ŒæŒ‰ä¸Šæ–¹çš„ç²—é«”ï¼åº•ç·šï¼æ”¾å¤§ï¼ç¸®å°ï¼‰ğŸ’
        </div>

        <!-- ç½®ä¸­é€å‡º -->
        <div class="actions">
          <button id="btnSubmit" class="primary" type="button">é€å‡ºç¥ç¦</button> <!-- âœ… æˆ‘å¯ä»¥èª¿ï¼šæ–‡æ¡ˆ -->
        </div>
      </div>
    </div>
  </div>

  <footer>Â© Copyright 2025 MYâ€˜s System</footer>

  <!-- ====================== ç°½å Modal ====================== -->
  <div id="sigOverlay" class="overlay" role="dialog" aria-modal="true" aria-labelledby="sigTitle">
    <div class="dialog">
      <h3 id="sigTitle">è«‹æ–¼ä¸‹æ–¹ç°½å</h3>
      <canvas id="pad"></canvas>
      <div class="dlg-actions">
        <button id="sigClear"  type="button">æ¸…é™¤</button>
        <button id="sigCancel" type="button">å–æ¶ˆ</button>
        <button id="sigOK"     type="button">ç¢ºå®š</button>
      </div>
    </div>
  </div>

<script>
/* ====================== å‰ç«¯è¨­å®šï¼ˆæˆ‘å¯ä»¥èª¿ï¼šLIFF/GAS/é€¾æ™‚ï¼‰ ====================== */
const LIFF_ID = '2008149060-m5pDXW6a'; // âœ… æˆ‘å¯ä»¥èª¿ï¼šå¡«å…¥ä½ çš„ LIFF ID
const WEBHOOK = 'https://meiyang0819.github.io/SSS/blessing'; // âœ… æˆ‘å¯ä»¥èª¿ï¼šä½ çš„ GAS å…¥å£ï¼ˆå·²æ”¯æ´ createBlessingï¼‰
const TIMEOUT_MS = 20000; // âœ… æˆ‘å¯ä»¥èª¿ï¼šè«‹æ±‚é€¾æ™‚

/* ====================== å·¥å…·ï¼šç‹€æ…‹åˆ—ï¼ˆæ²¿ç”¨äº’å‹•éŸ³ç¬¦çš„èªæ°£ï¼‰ ====================== */
function setStatus(m){
  const el = document.getElementById('status');
  el.textContent = m;
  el.classList.remove('ok','busy','err');
  if(/æˆåŠŸ|å·²è¼‰å…¥|å°±ç·’/.test(m)) el.classList.add('ok');
  else if(/é€å‡ºä¸­|ç­‰å¾…|è™•ç†/.test(m)) el.classList.add('busy');
  else if(/å¤±æ•—|é€¾æ™‚|ç„¡æ³•|éŒ¯èª¤/.test(m)) el.classList.add('err');
}

/* ====================== LIFF åˆå§‹åŒ–ï¼ˆè‡ªå‹•å¸¶å…¥ lineId / æ–°äººåï¼‰ ====================== */
// èªªæ˜ï¼šç‚ºäº†è®“ã€Œæ–°äººï¼šOOã€è‡ªå‹•å¸¶å…¥ï¼Œä½ çš„ GAS éœ€æä¾›ä»¥ä¸‹å…¶ä¸­ä¸€ç¨®ï¼š
// 1) GET ?action=couple&lineId=xxx  â†’ { ok:true, name:"OO", role:"MALE_FRIEND|FEMALE_FRIEND" }
// 2) æˆ– POST createBlessing æ™‚ï¼Œä½ åœ¨å¾Œç«¯ä¾ lineId åæŸ¥æ–°äººåå†å¯«å…¥
let lineId='', displayName='', pictureUrl='';
async function initLIFF(){
  if(typeof liff === 'undefined'){ setStatus('ï¼ˆæœªè¼‰å…¥ LIFF SDKï¼Œå¯å…ˆæ¸¬æ¨£å¼ï¼‰'); return; }
  try{
    setStatus('åˆå§‹åŒ– LIFFâ€¦');
    await liff.init({ liffId: LIFF_ID, withLoginOnExternalBrowser:true });
    if(!liff.isLoggedIn()){ liff.login({ scope:['openid','profile'] }); return; }
    if(liff.ready) await liff.ready;

    let prof=null, idt=null;
    try{ prof=await liff.getProfile(); }catch(_){}
    try{ idt=liff.getDecodedIDToken(); }catch(_){}

    lineId      = (prof&&prof.userId) || (idt&&idt.sub) || '';
    displayName = (prof&&prof.displayName) || (idt&&(idt.name||idt.nickname)) || '';
    pictureUrl  = (prof&&prof.pictureUrl) || '';

    // å·¦ä¸Šè§’ã€Œæ–°äººã€ï¼šå‘å¾Œç«¯è©¢å•ï¼ˆè‹¥å¾Œç«¯å°šæœªå¯¦ä½œï¼Œæœƒä¿ç•™é è¨­ â€”ï¼‰
    if(lineId){
      try{
        const r = await fetch(WEBHOOK+'?action=couple&lineId='+encodeURIComponent(lineId),{method:'GET',cache:'no-store'});
        if(r.ok){
          const j = await r.json().catch(()=>null);
          if(j && j.ok && j.name){
            document.getElementById('brideLabel').textContent = 'æ–°äººï¼š' + String(j.name||'â€”');
          }
        }
      }catch(_){}
    }

    setStatus('å·²å°±ç·’');
  }catch(e){
    setStatus('LIFF åˆå§‹åŒ–å¤±æ•—ï¼š'+ e.message);
  }
}

/* ====================== ç·¨è¼¯å™¨å·¥å…·åˆ—ï¼ˆç²—é«”ï¼åº•ç·šï¼æ”¾å¤§ï¼ç¸®å°ï¼‰ ====================== */
// ç²—é«”/åº•ç·šä½¿ç”¨ execCommandï¼ˆè·¨ç€è¦½å™¨æœ€å–®ç´”ï¼›æœªä¾†å¯æ› Range API è‡ªè£½ï¼‰
// æ”¾å¤§/ç¸®å°ï¼šå°ã€Œç›®å‰é¸å–æ–‡å­—ã€åŒ…ä¸€å±¤ <span class="fs-up-n">ï¼›é€£é»é€ç´šï¼ˆæœ€å¤š 3 ç´šï¼‰
function btnExec(cmd){
  document.execCommand(cmd, false, null);
  document.getElementById('editor').focus();
}
function wrapSelectionWithClass(cls){
  const sel = window.getSelection();
  if(!sel.rangeCount) return;
  const range = sel.getRangeAt(0);
  if(range.collapsed) return; // æ²’é¸å­—å°±ä¸è™•ç†
  const span = document.createElement('span');
  span.className = cls;
  range.surroundContents(span);
  // ç§»é™¤é¸å–ã€æŠŠ caret ç§»åˆ°åŒ…å®Œçš„å¾Œé¢
  sel.removeAllRanges();
  const newRange = document.createRange();
  newRange.setStartAfter(span);
  newRange.collapse(true);
  sel.addRange(newRange);
  document.getElementById('editor').focus();
}
let upLevel = 0, downLevel = 0; // é»æ“Šç´šæ•¸ï¼ˆç°¡å–®è¨˜æ†¶ï¼Œä¸äº’æ–¥ï¼›å¯åŒæ™‚å­˜åœ¨ï¼‰
function stepBigger(){
  if(upLevel < 3) upLevel++;
  wrapSelectionWithClass('fs-up-' + upLevel);
}
function stepSmaller(){
  if(downLevel < 3) downLevel++;
  wrapSelectionWithClass('fs-down-' + downLevel);
}
// è‹¥é‡æ–°é¸å…¶ä»–æ–‡å­—ï¼Œç´šæ•¸é‡ç½®ï¼ˆé¿å…æŒçºŒç–ŠåŠ åˆ° 4+ï¼‰
document.getElementById('editor').addEventListener('mouseup', ()=>{ upLevel=0; downLevel=0; });
document.getElementById('editor').addEventListener('keyup',   ()=>{ upLevel=0; downLevel=0; });

document.getElementById('btnBold').addEventListener('click',()=>btnExec('bold'));
document.getElementById('btnUnderline').addEventListener('click',()=>btnExec('underline'));
document.getElementById('btnBigger').addEventListener('click', stepBigger);
document.getElementById('btnSmaller').addEventListener('click', stepSmaller);

/* ====================== ç°½åï¼ˆé»å°æ¡† â†’ Modal ç•«ç°½ï¼‰ ====================== */
const sigOverlay = document.getElementById('sigOverlay');
const pad = document.getElementById('pad');
const ctx = pad.getContext('2d');
let drawing=false, lastX=0, lastY=0, signatureDataURL='';

function fitCanvas(){
  // é«˜ DPI æ”¯æ´
  const dpr = Math.max(1, window.devicePixelRatio || 1);
  const cssW = pad.clientWidth, cssH = pad.clientHeight;
  pad.width = Math.floor(cssW * dpr);
  pad.height = Math.floor(cssH * dpr);
  ctx.scale(dpr, dpr);
  ctx.lineCap='round'; ctx.lineJoin='round';
  ctx.lineWidth=3;                      // âœ… æˆ‘å¯ä»¥èª¿ï¼šç°½åç­†ç²—ç´°
  ctx.strokeStyle='#111';               // âœ… æˆ‘å¯ä»¥èª¿ï¼šç°½åç­†é¡è‰²
  ctx.clearRect(0,0,cssW,cssH);
}

function openSign(){
  sigOverlay.classList.add('show');
  setTimeout(fitCanvas, 40);
}
function closeSign(){ sigOverlay.classList.remove('show'); }

function pointerPos(e){
  const rect = pad.getBoundingClientRect();
  const x = (e.touches? e.touches[0].clientX : e.clientX) - rect.left;
  const y = (e.touches? e.touches[0].clientY : e.clientY) - rect.top;
  return {x,y};
}
function startDraw(e){ drawing=true; const p=pointerPos(e); lastX=p.x; lastY=p.y; e.preventDefault(); }
function moveDraw(e){
  if(!drawing) return;
  const p=pointerPos(e);
  ctx.beginPath(); ctx.moveTo(lastX,lastY); ctx.lineTo(p.x,p.y); ctx.stroke();
  lastX=p.x; lastY=p.y;
  e.preventDefault();
}
function endDraw(){ drawing=false; }
pad.addEventListener('mousedown', startDraw);
pad.addEventListener('mousemove', moveDraw);
pad.addEventListener('mouseup', endDraw);
pad.addEventListener('mouseleave', endDraw);
pad.addEventListener('touchstart', startDraw, {passive:false});
pad.addEventListener('touchmove', moveDraw, {passive:false});
pad.addEventListener('touchend', endDraw);

document.getElementById('chipSign').addEventListener('click', openSign);
document.getElementById('sigClear').addEventListener('click', fitCanvas);
document.getElementById('sigCancel').addEventListener('click', closeSign);
document.getElementById('sigOK').addEventListener('click', ()=>{
  // è½‰æˆç¸®åœ–é¡¯ç¤º + å­˜æˆ dataURL
  signatureDataURL = pad.toDataURL('image/png');
  const img = document.getElementById('signThumb');
  img.src = signatureDataURL;
  closeSign();
});

/* ====================== é€å‡ºç¥ç¦ ====================== */
document.getElementById('btnSubmit').addEventListener('click', async ()=>{
  const text = document.getElementById('editor').innerHTML.trim(); // ä¿ç•™æ¨£å¼ï¼ˆç²—é«”/åº•ç·š/æ”¾å¤§ç¸®å°ï¼‰
  if(!text || text.includes('åœ¨æ­¤å¯«ä¸‹ä½ å°æ–°äººçš„ç¥ç¦')){ alert('è«‹å¯«ä¸‹ç¥ç¦å…§å®¹å”·ï½'); return; }

  // å…ˆ ping å¾Œç«¯
  try{
    const ping = await fetch(WEBHOOK+'?action=ping',{method:'GET',cache:'no-store'});
    const t = await ping.text().catch(()=> ''); if(String(t).trim().toLowerCase()!=='ok'){
      setStatus('âš ï¸ å¾Œç«¯æœªå›æ‡‰æ­£å¸¸ï¼ˆping='+t+'ï¼‰ï¼Œè«‹æª¢æŸ¥ GAS éƒ¨ç½²'); return;
    }
  }catch(_){ setStatus('âš ï¸ ç„¡æ³•é€£åˆ°å¾Œç«¯ï¼ˆping å¤±æ•—ï¼‰'); return; }

  setStatus('â³ é€å‡ºä¸­â€¦');

  const payload = {
    action: 'createBlessing',                // â˜… å¾Œç«¯å‹•ä½œï¼ˆä½ å·²åœ¨ GAS ä¿ç•™ï¼‰
    lineId, displayName, pictureUrl,         // â˜… æ–¹ä¾¿å¾Œç«¯è¨˜éŒ„
    contentHTML: text,                       // â˜… ç¥ç¦å…¨æ–‡ï¼ˆå«æ¨£å¼ï¼‰
    signaturePNG: signatureDataURL || '',    // â˜… ç°½åï¼ˆdataURLï¼Œå¯åœ¨å¾Œç«¯è½‰åœ–æª”ï¼‰
    extra: {}                                // â˜… é ç•™
  };

  const ctl=new AbortController(); const timer=setTimeout(()=>ctl.abort(), TIMEOUT_MS);
  try{
    const r = await fetch(WEBHOOK,{ method:'POST', headers:{'Content-Type':'text/plain;charset=UTF-8'}, body: JSON.stringify(payload), signal: ctl.signal, keepalive:true });
    clearTimeout(timer);
    const ct=(r.headers.get('content-type')||'').toLowerCase();
    let j=null;
    if(ct.includes('application/json')) j=await r.json().catch(()=>null);
    else { const t=await r.text().catch(()=> ''); if(/^\s*\{/.test(t)) try{ j=JSON.parse(t); }catch(_){} }
    if(!j && r.ok) j={ok:true};

    if(j && j.ok){
      setStatus('âœ… ç¥ç¦å·²é€å‡ºæˆåŠŸï¼'); // éœ€æ±‚ï¼šç‹€æ…‹åˆ— OK
      // è‹¥è¦é€å‡ºå¾Œé–å®šï¼šå¯å–æ¶ˆè¨»è§£ä»¥ä¸‹å…©è¡Œ
      // document.getElementById('editor').setAttribute('contenteditable','false');
      // document.getElementById('btnSubmit').disabled = true;
    }else{
      setStatus('âŒ é€å‡ºå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
    }
  }catch(e){
    setStatus('âŒ é€å‡ºé€¾æ™‚æˆ–å¤±æ•—ï¼š'+ (e?.message||''));
  }
});

/* ====================== å•Ÿå‹• ====================== */
window.addEventListener('DOMContentLoaded', ()=>{
  // åˆå§‹ç‹€æ…‹åˆ—æ–‡æ¡ˆ
  setStatus('ç­‰å¾…åˆå§‹åŒ–â€¦');
  // æ²’è¼‰å…¥ LIFF SDK ä¹Ÿèƒ½å…ˆçœ‹ç•«é¢
  if(window.liff) initLIFF(); else setStatus('å°±ç·’ï¼ˆæœªå•Ÿå‹• LIFFï¼‰');
});
</script>

<!-- å¯é¸ï¼šè‹¥è¦ç›´æ¥åœ¨ LIFF å…§é‹è¡Œï¼Œè¨˜å¾—å¼•å…¥ LIFF SDKï¼›å…ˆè¨»è§£èµ·ä¾†ï¼Œéœ€ç”¨æ™‚æ‰“é–‹ -->
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</body>
</html>
