<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ğŸ’åŒå¿ƒç¥ˆé¡˜</title>

    <!-- ///* å­—å‹é è¼‰ï¼šGoogle Fonts */// -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Patrick+Hand:wght@400&family=Sacramento:wght@400;700&display=swap" rel="stylesheet" />

    <style>
      /* ///======================= å…¨åŸŸ CSS è®Šæ•¸ï¼ˆå¯èª¿åƒæ•¸ï¼‰ =======================/// */
      :root{
        --brand-bg:#c9daf8;           /* èƒŒæ™¯åº•è‰²ï¼ˆè—ç´«ï¼‰ å¯èª¿ */
        --title:#A68A7C;              /* ä¸»æ¨™é¡Œå­—è‰² å¯èª¿ */
        --ink:#0f172a;                /* å…§æ–‡ä¸»å­—è‰² å¯èª¿ */
        --accent:#A68A7C;             /* é‡é»/é»ç¶´è‰² å¯èª¿ */
        --rim:#E4E4E4;                /* é‚Šæ¡†ç·šé¡è‰² å¯èª¿ */
        --soft:#F5F1EC;               /* æŸ”å’Œåº•è‰²ï¼ˆæ·ºç±³ï¼‰ å¯èª¿ */

        --panel-grad-from:#b7d2f6;    /* é¢æ¿æ¼¸å±¤ èµ·è‰² å¯èª¿ */
        --panel-grad-to:#cfe1fb;      /* é¢æ¿æ¼¸å±¤ æœ«è‰² å¯èª¿ */

        --panel-maxw:1320px;          /* å¤–å±¤é¢æ¿ æœ€å¤§å¯¬åº¦ å¯èª¿ */
        --card-maxw:1200px;           /* å…§å®¹å¡ç‰‡ æœ€å¤§å¯¬åº¦ å¯èª¿ */

        --radius-xl:16px;             /* å¤§åœ“è§’ å¯èª¿ */
        --radius-md:12px;             /* ä¸­åœ“è§’ å¯èª¿ */

        --shadow-1:0 10px 26px rgba(0,0,0,.10);               /* å¤§é™°å½± å¯èª¿ */
        --shadow-2:0 2px 0 rgba(0,0,0,.15), 0 2px 8px rgba(0,0,0,.06); /* å°é™°å½± å¯èª¿ */

        --toolbar-gap:8px;            /* å·¥å…·åˆ—æŒ‰éˆ•é–“è· å¯èª¿ */
        --tool-h:36px;                /* å·¥å…·åˆ—æŒ‰éˆ•é«˜åº¦ å¯èª¿ */
        --editor-zoom:1rem;           /* å…§æ–‡å­—ç´šå€ç‡ï¼ˆæ”¾å¤§/ç¸®å°ä½¿ç”¨ï¼‰ å¯èª¿ */

        /* Dear èˆ‡ä¸‹æ–¹ä¸‰é¡†çµ±ä¸€å°ºå¯¸ï¼ˆç¸®çŸ­é¿å…é‡ç–Šï¼‰ */
        --ctrl-w:90px;                /* ä¸‰é¡†æŒ‰éˆ•å¯¬åº¦ å¯èª¿ æ•¸å­—è¶Šå¤§è¶Šå¯¬ */
        --ctrl-h:36px;                /* ä¸‰é¡†æŒ‰éˆ•é«˜åº¦ å¯èª¿ */

        /* ç´…å¡èˆ‡è—åº•çš„åº•éƒ¨é–“è· */
        --panel-bottom-gap:25px;      /* é¢æ¿åº•éƒ¨é ç•™é«˜åº¦ å¯èª¿ */

        /* ç‰ˆæ¬Šï¼ˆåªåœ¨ä¸‹æ–¹ä½¿ç”¨ color:var(--copyright-color)ï¼‰ */
        --copyright-color:#444444;    /* ç‰ˆæ¬Šå­—é¡è‰² å¯èª¿ï¼ˆè¼ƒæ·±ï¼Œé¿å…è¢«èƒŒæ™¯åƒæ‰ï¼‰ */
        --copyright-pad:12px;         /* ç‰ˆæ¬Šä¸Šä¸‹å…§è· å¯èª¿ */

        /* æœ¨ç‰Œè¦–è¦ºç´°ç¯€ï¼ˆrope/knot è®Šæ•¸ä¿ç•™ã€æœªä½¿ç”¨ï¼‰ */
        --tile-w:180px;               /* å–®å€‹ç‰Œå­æœ€å°å¯¬ï¼ˆgrid ç”¨ï¼‰ å¯èª¿ */
        --tile-h:156px;               /* æœ¨ç‰Œé«˜åº¦ å¯èª¿ */
        --wood-grain-contrast:.9;     /* æœ¨ç´‹å°æ¯” å¯èª¿ */
        --rope-width:8px;             /* ï¼ˆä¿ç•™ï¼‰ç¹©å¯¬ */
        --rope-height:42px;           /* ï¼ˆä¿ç•™ï¼‰ç¹©é«˜ */
        --knot-size:22px;             /* ï¼ˆä¿ç•™ï¼‰çµå¤§å° */
      }

      /* èƒŒæ™¯é£¾åœ–ï¼ˆä¸å¯äº’å‹•ï¼‰ */
      .bg-notes{position:fixed;inset:0;width:100%;height:100%;object-fit:cover;z-index:0;pointer-events:none;user-select:none;}

      /* å…¨ç«™å­—é«”èˆ‡åŸºåº•è‰² */
      *{box-sizing:border-box;}
      html,body{height:100%;margin:0;overflow:hidden;color:var(--ink);background:var(--brand-bg);
        font-family:"Patrick Hand","Noto Sans TC",system-ui,-apple-system,sans-serif;
        -webkit-text-stroke:.35px rgba(0,0,0,.18); text-shadow:0 1px 0 rgba(255,255,255,.65);}

      /* ///======================= å¤–å±¤é¢æ¿èˆ‡æ¨™é¡Œ =======================/// */
      .panel{position:relative;z-index:1;max-width:var(--panel-maxw);
        height:calc(100vh - 110px);margin:26px auto;background:linear-gradient(135deg,var(--panel-grad-from),var(--panel-grad-to));
        border:1px solid var(--rim);border-radius:16px;box-shadow:var(--shadow-1);display:flex;flex-direction:column;overflow:hidden;}
      h2{position:relative;left:50%;transform:translateX(-50%);margin:12px 0 6px;text-align:center;width:max-content;max-width:90%;
        font-family:"Sacramento",cursive;font-weight:700;font-size:2.8rem;color:var(--title);
        -webkit-text-stroke:.6px rgba(0,0,0,.12);text-shadow:0 3px 4px rgba(255,255,255,.75);}

      /* ///======================= å·¥å…·åˆ— + è§’è‰²éæ¿¾ + ç‹€æ…‹åˆ— =======================/// */
      .bar{padding:6px 22px 8px;}
      .bar-inner{max-width:1200px;margin:0 auto;display:flex;align-items:center;gap:12px;}
      .toolbar{display:flex;gap:var(--toolbar-gap);filter:drop-shadow(0 2px 0 rgba(0,0,0,.08));}
      .tool-btn,.tool-select{min-width:64px;height:var(--tool-h);padding:0 12px;background:#fff;border:1px solid var(--rim);
        border-radius:12px;font-weight:700;display:flex;align-items:center;justify-content:center;gap:6px;box-shadow:var(--shadow-2);cursor:pointer;}
      .tool-select{min-width:auto;padding:0 10px;}
      .tool-btn:active{transform:translateY(1px) scale(.99);}

      .rolebar{display:flex;gap:var(--toolbar-gap);}
      .role-btn{min-width:64px;height:var(--tool-h);padding:0 12px;background:#fff;border:1px solid var(--rim);border-radius:12px;
        font-weight:700;display:flex;align-items:center;justify-content:center;box-shadow:var(--shadow-2);cursor:pointer;}
      .role-btn.active{outline:2px solid rgba(0,0,0,.15);}
      #status{flex:1 1 auto;min-width:240px;background:#F5F1EC;border:1px solid #E4E4E4;border-radius:12px;padding:8px 10px;
        font-size:14px;text-align:center;color:#A68A7C;font-weight:700;}

      /* ///======================= ä¸»è¦èˆå°ï¼ˆå·¦ï¼šè¼¸å…¥ / å³ï¼šç‰†ï¼‰ =======================/// */
      .stage{flex:1 1 auto;padding:14px 22px var(--panel-bottom-gap);display:flex;justify-content:center;align-items:flex-start;overflow:hidden;}
      .card{position:relative;width:100%;max-width:var(--card-maxw);border:1px solid rgba(0,0,0,.05);border-radius:16px;box-shadow:0 10px 26px rgba(0,0,0,.08);
        padding:22px;height:calc(100% - var(--panel-bottom-gap));display:grid;grid-template-columns:1fr 2fr;gap:14px;background:#e6b8af;}

      /* å·¦å´é»ƒè‰²è¼¸å…¥å€ */
      .left-wrap{position:relative;background:linear-gradient(180deg, rgba(255,242,204,.98), rgba(255,242,204,.92));border-radius:16px;border:1px solid rgba(0,0,0,.05);padding:12px;overflow:hidden;}
      .left-content{position:relative;height:100%;}

      /* Dear æ¨™ç±¤ */
      .chip{position:absolute;min-width:var(--ctrl-w);width:var(--ctrl-w);height:var(--ctrl-h);background:#fff;border:1px solid var(--rim);border-radius:10px;
        box-shadow:0 2px 8px rgba(0,0,0,.06);display:flex;align-items:center;justify-content:center;gap:8px;padding:0 10px;user-select:none;}
      #chipBride{top:10px;left:10px;}
      #brideLabel{font-weight:800;line-height:1;}

      /* å…§æ–‡ç·¨è¼¯æ¡†ï¼ˆè™›ç·šï¼‰ */
      /* âœ” ä¿æŒä½ åŸæœ¬çš„å€¼ï¼šåº•éƒ¨èˆ‡ä¸‰é¡†æŒ‰éˆ•é–“è· 6pxï¼Œè®“æŒ‰éˆ•æ›´è²¼è¿‘è™›ç·šåº•éƒ¨ */
      .editor{position:absolute;top:calc(10px + var(--ctrl-h) + 16px);right:10px;bottom:calc(10px + var(--ctrl-h) + 6px);left:10px;overflow:auto;line-height:1.8;
        outline:none;background:transparent;border-radius:12px;padding:14px;font-size:var(--editor-zoom);border:1px dashed rgba(0,0,0,.12);}
      .editor[data-empty]{opacity:1;color:rgba(15,23,42,.28);-webkit-text-stroke:0;text-shadow:none;font-style:italic;}
      .editor.locked{pointer-events:none;opacity:.85;}

      /* ä¸‹æ–¹ä¸‰é¡†ï¼šå†æ¬¡ä¿®æ”¹ â†’ é€å‡ºç¥ç¦ â†’ ç•«æŠ¼ç°½åï¼›å›ºå®šå¯¬é¿å…é‡ç–Š */
      .left-actions{position:absolute;left:10px;right:10px;bottom:10px;height:var(--ctrl-h);display:flex;gap:8px;justify-content:center;flex-wrap:nowrap;}
      .left-actions > *{flex:0 0 var(--ctrl-w);width:var(--ctrl-w);height:100%;}
      .left-actions button{background:#fff;border:1px solid var(--rim);border-radius:10px;font-weight:800;box-shadow:var(--shadow-2);cursor:pointer;white-space:nowrap;}
      .left-actions button:active{transform:translateY(1px) scale(.99);}

      /* ç°½å chipï¼ˆèˆ‡æŒ‰éˆ•åŒå°ºå¯¸ï¼‰ */
      .left-actions .chip{
        font-size:1rem;font-weight:800;line-height:1; position:static; display:flex; align-items:center; justify-content:center; cursor:pointer;
        background:#fff; border:1px solid var(--rim); border-radius:10px; box-shadow:var(--shadow-2); padding:0; overflow:hidden;
        width:var(--ctrl-w); height:var(--ctrl-h);
      }
      #chipSign .hint{ font-weight:800; color:rgba(15,23,42,.38); }
      #chipSign.locked{ pointer-events:none; opacity:.9; }
      #signThumb{ display:none; width:100%; height:100%; object-fit:contain; pointer-events:none; max-width:100%; max-height:100%; }
      #chipSign.has-img #signThumb{ display:block; }
      #chipSign.has-img .hint{ display:none; }

      /* å³å´ç²‰è‰²ç‰†å®¹å™¨ */
      .wall-wrap{
        background:linear-gradient(180deg,#f9e5ee,#f6dce7);
        border-radius:16px;border:1px solid rgba(0,0,0,.05);
        padding:12px;
        overflow:auto;
      }
      .wall{
        min-height:280px;
        height:100%;
        display:grid;
        grid-template-columns:repeat(auto-fill,minmax(180px,1fr));
        gap:14px;align-content:start;
        padding:2px;
        overflow:visible;
      }

      /* æœ¨ç‰Œï¼ˆrope/knot å·²ç§»é™¤ï¼›ä¿ç•™ä¸Šæ–¹é‡˜å­”ï¼‰ */
      .tile{
        position:relative;width:100%;height:var(--tile-h);padding:18px 12px 12px;cursor:pointer;overflow:hidden;display:flex;flex-direction:column;gap:6px;
        background:
          linear-gradient(180deg,#f1e3cf,#e5d1b8),
          repeating-linear-gradient(14deg, rgba(0,0,0, calc(.03 + var(--wood-grain-contrast)*.10)) 0 4px, rgba(255,255,255, calc(.02 + var(--wood-grain-contrast)*.06)) 4px 9px),
          repeating-linear-gradient(0deg, rgba(0,0,0, calc(.018 + var(--wood-grain-contrast)*.04)) 0 2px, rgba(255,255,255, calc(.015 + var(--wood-grain-contrast)*.04)) 2px 4px),
          radial-gradient(16px 12px at 28% 36%, rgba(0,0,0,.08), transparent 60%),
          radial-gradient(14px 10px at 72% 62%, rgba(0,0,0,.08), transparent 60%);
        border:1px solid #cfba9b;border-radius:14px;box-shadow:0 10px 18px rgba(0,0,0,.10);
        clip-path:polygon(0 12%, 12% 0, 88% 0, 100% 12%, 100% 100%, 0 100%);
      }
      .tile::before{content:"";position:absolute;top:2px;left:50%;transform:translateX(-50%);width:16px;height:16px;border-radius:50%;
        background:radial-gradient(circle at 35% 35%, #fff 0 35%, #bbb 36% 60%, transparent 61%);box-shadow:inset 0 1px 0 rgba(255,255,255,.9), inset 0 -1px 0 rgba(0,0,0,.15);}

      .tile-name{font-weight:800;text-align:center;margin-top:8px;}
      .tile-sep{height:1px;background:rgba(0,0,0,.12);margin:6px 0;}
      .tile-date{font-size:12px;opacity:.85;text-align:center;font-weight:800;}
      .tile-snippet{font-size:14px;line-height:1.6;text-align:left;word-break:break-word;display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;overflow:hidden;text-overflow:ellipsis;}

      /* é®ç½©èˆ‡é€šç”¨å°è©±æ¡† */
      .overlay{position:fixed;inset:0;z-index:9999;display:none;align-items:center;justify-content:center;background:rgba(17,24,39,.35);backdrop-filter:blur(3px);}
      .overlay.show{display:flex;}
      .dialog{width:min(92vw,680px);max-height:82vh;background:#F5F1EC;border:1px solid var(--rim);border-radius:14px;padding:16px;box-shadow:0 18px 44px rgba(0,0,0,.18);overflow:auto;}
      .dialog h3{margin:0 0 10px;font-size:18px;color:#6b5e52;text-align:center;-webkit-text-stroke:0;text-shadow:none;}
      .view-meta{text-align:center;font-size:12px;opacity:.80;margin-bottom:8px;font-weight:800;color:#6b5e52;}
      .view-content{background:#fff;border:1px solid #ddd;border-radius:12px;padding:12px;line-height:1.8;}
      .view-actions{display:flex;gap:10px;justify-content:center;margin-top:12px;}
      .view-actions button{min-width:120px;height:var(--tool-h);border-radius:10px;border:1px solid var(--rim);background:#fff;cursor:pointer;font-weight:700;}

      /* ç°½åæ¿å°è©±æ¡†å°ºå¯¸èˆ‡ç•«å¸ƒ */
      #sigOverlay .dialog{width:min(92vw,520px);}
      #pad{width:100%;height:260px;background:#fff;border:1px solid #ddd;border-radius:12px;touch-action:none;}
      .dlg-actions{display:flex;gap:10px;justify-content:center;margin-top:12px;}
      .dlg-actions button{width:120px;height:var(--tool-h);border-radius:10px;border:1px solid var(--rim);background:#fff;cursor:pointer;font-weight:700;}

      /* ç‰ˆæ¬Šï¼ˆå›ºå®šæ–¼åº•éƒ¨èƒŒæ™¯å±¤ï¼‰â€”â€”åƒ…æ”¹ã€Œcolorã€è®€å–è®Šæ•¸ï¼Œå…¶ä»–ä¸å‹• */
      .footer-copyright{position:fixed;left:0;right:0;bottom:6px;z-index:0;text-align:center;padding:var(--copyright-pad) 0;
        font-size:13px;font-weight:700;color:var(--copyright-color);-webkit-text-stroke:0;text-shadow:none;}

      /* ///======================= æ‰‹æ©Ÿç‰ˆï¼šç›´å‘ =======================/// */
      @media (max-width: 860px) and (orientation: portrait){
        :root{ --tool-w-m: 53px; } /* æ‰‹æ©Ÿç›´å‘ï¼šå·¥å…·éˆ•å¯¬åº¦ï¼ˆç­‰å¯¬ï¼‰ */
        .bar-inner{ flex-direction: column; align-items: stretch; gap: 8px; }
        .rolebar{ order:1; justify-content:center; }
        #status{ order:2; min-width:0; }
        .toolbar{ order:3; flex-wrap:wrap; justify-content:center; gap:8px; }
        .toolbar .tool-btn,.toolbar .tool-select{ min-width:0; width:var(--tool-w-m); height:32px; padding:0 10px; font-size:13px; border-radius:10px; }
        .toolbar .tool-select{ text-align:center; text-align-last:center; }

        html, body{ overflow:auto; }
        .panel{ height:auto; min-height:100dvh; }
        .stage{ overflow:visible; padding:10px 10px var(--panel-bottom-gap); }

        /* ç‰ˆé¢åˆ‡æˆä¸Šä¸‹ï¼šé»ƒ 74% / ç²‰ 26% */
        .card{ grid-template-columns:1fr; grid-template-rows:74% 26%; height:auto; min-height:calc(100dvh - 160px); gap:12px; }
        .left-wrap{ min-height:0; }
        .wall-wrap{ min-height:0; }
        .editor{ bottom: calc(10px + var(--ctrl-h) + 16px); }

        :root{ --tile-h: 160px; } /* æœ¨ç‰Œé«˜åº¦åœ¨æ‰‹æ©Ÿç›´å‘å¾®èª¿ */
        .wall{ grid-template-columns: repeat(2, 1fr); gap:14px; }
        .tile{ font-size: 14px; }
      }

      /* ///======================= æ‰‹æ©Ÿç‰ˆï¼šæ©«å‘ï¼ˆæŒ‰éˆ•ä¸€å®šæ”¶åœ¨é»ƒè‰²ç‰ˆå…§ï¼‰ =======================/// */
      @media (max-width: 860px) and (orientation: landscape){
        html, body{ overflow:auto; }
        .panel{ height:auto; min-height:100dvh; }
        .stage{ padding:10px 12px var(--panel-bottom-gap); overflow:visible; }
        .card{ grid-template-columns:1fr 1.2fr; gap:12px; height:auto; min-height:calc(100dvh - 160px); }

        .bar-inner{ flex-wrap:wrap; align-items:center; gap:10px 12px; }
        .rolebar{ order:1; flex:0 1 auto; }
        #status{ order:1; flex:1 1 50%; min-width:200px; }
        .toolbar{ order:2; flex:1 0 100%; justify-content:center; }

        /* è®“ä¸‰é¡†æŒ‰éˆ•æœ‰æ›´å¤§å®¹éŒ¯ç‡ï¼Œä¸æœƒè¶…å‡ºé»ƒè‰²å€å¡Šï¼ˆåƒ…æ©«å‘æ™‚å¾®ç¸®å¯¬ï¼‰ */
        :root{ --ctrl-w: 86px; }
        .left-actions{ gap:8px; right:10px; left:10px; flex-wrap:nowrap; }
        .left-actions .chip,.left-actions button{ font-size:.95rem; }

        /* ç²‰æ¡†ä¸€åˆ— 2 ç‰‡ */
        .wall{ grid-template-columns: repeat(2, 1fr); gap:14px; }
      }
    </style>
  </head>

  <body>
    <!-- ///* èƒŒæ™¯é£¾åœ–ï¼ˆä¸å¯äº’å‹•ï¼‰ */// -->
    <img class="bg-notes" src="./assets/favors.png?v=4" alt="" />

    <!-- ///======================= ä¸»é¢æ¿ï¼šæ¨™é¡Œ + å·¥å…·åˆ— + å…§å®¹å€ =======================/// -->
    <div class="panel">
      <h2>â¤ï¸åŒå¿ƒç¥ˆé¡˜â¤ï¸</h2> <!-- å…§æ–‡æ¨™é¡Œ -->

      <!-- å·¥å…·åˆ—èˆ‡è§’è‰²ç¯©é¸ -->
      <div class="bar">
        <div class="bar-inner">
          <div class="rolebar">
            <button type="button" class="role-btn active" id="roleAll">å…¨éƒ¨</button>
            <button type="button" class="role-btn" id="roleMale">ç”·æ–¹</button>
            <button type="button" class="role-btn" id="roleFemale">å¥³æ–¹</button>
          </div>

          <p id="status">âœ… å¯é€ä¸Šç¥ç¦å›‰ï¼Œé€å‡ºå¾Œè«‹ç¨å¾Œå”·ï¼ŒæˆåŠŸæœƒé€šçŸ¥å‘¢</p>

          <div class="toolbar" role="toolbar" aria-label="æ–‡å­—å·¥å…·">
            <button class="tool-btn" id="btnBold"      type="button">ç²—é«”</button>
            <button class="tool-btn" id="btnItalic"    type="button">æ–œé«”</button>
            <button class="tool-btn" id="btnUnderline" type="button">åº•ç·š</button>

            <select id="colorPick" class="tool-select" title="å­—é«”é¡è‰²">
              <option value="" selected>é¡è‰²</option>
              <option value="#a21caf">å°ç´«</option>
              <option value="#dc2626">å°ç´…</option>
              <option value="#2563eb">å°è—</option>
              <option value="#059669">å°ç¶ </option>
              <option value="#d97706">å°æ©˜</option>
              <option value="#6b7280">å°ç°</option>
            </select>

            <button class="tool-btn" id="btnBigger"    type="button">æ”¾å¤§</button>
            <button class="tool-btn" id="btnSmaller"   type="button">ç¸®å°</button>
          </div>
        </div>
      </div>

      <!-- ä¸»è¦èˆå°ï¼ˆå·¦ï¼šè¼¸å…¥å¡ï¼å³ï¼šç¥ˆé¡˜ç‰†ï¼‰ -->
      <div class="stage">
        <div class="card" id="card">
          <!-- å·¦å´ï¼šè¼¸å…¥å¡ -->
          <section class="left-wrap">
            <div class="left-content">
              <div class="chip" id="chipBride" title="Dear "><span id="brideLabel">Dear â€”</span></div>

              <div class="editor" id="editor" contenteditable="true" aria-label="ç¥ˆé¡˜å…§å®¹" data-empty>
                å¯«ä¸‹ä¸¦ç»ä¸Šæœ€èª æ‘¯çš„ç¥ç¦â€¦ğŸ’
              </div>

              <!-- ä¸‰é¡†æŒ‰éˆ•ï¼šå†æ¬¡ä¿®æ”¹ â†’ é€å‡ºç¥ç¦ â†’ ç•«æŠ¼ç°½å -->
              <div class="left-actions">
                <button id="btnEdit"  type="button">å†æ¬¡ä¿®æ”¹</button>
                <button id="btnSend"  type="button">é€å‡ºç¥ç¦</button>
                <div class="chip" id="chipSign" title="é»æ­¤ç°½å">
                  <span class="hint">ç•«æŠ¼ç°½å</span>
                  <img id="signThumb" alt="signature preview" />
                </div>
              </div>
            </div>
          </section>

          <!-- å³å´ï¼šç¥ˆé¡˜ç‰† -->
          <section class="wall-wrap">
            <div class="wall" id="wall"></div>
          </section>
        </div>
      </div>
    </div>

    <!-- ç‰ˆæ¬Šï¼ˆå›ºå®šåœ¨æœ€åº•ï¼‰ -->
    <div class="footer-copyright" id="copyright">Â© Copyright 2025 MYâ€˜s System</div>

    <!-- æª¢è¦–çª—ï¼ˆé»æœ¨ç‰Œæ‰“é–‹å…§å®¹ï¼‰ -->
    <div id="viewOverlay" class="overlay" role="dialog" aria-modal="true" aria-labelledby="viewTitle">
      <div class="dialog">
        <h3 id="viewTitle">ç¥ç¦å…§å®¹</h3>
        <div class="view-meta" id="viewMeta"></div>
        <div id="viewContent" class="view-content"></div>
        <div class="view-actions"><button id="viewClose" type="button">é—œé–‰</button></div>
      </div>
    </div>

    <!-- ç°½å Modal -->
    <div id="sigOverlay" class="overlay" role="dialog" aria-modal="true" aria-labelledby="sigTitle">
      <div class="dialog">
        <h3 id="sigTitle">è«‹æ–¼ä¸‹æ–¹ç•«æŠ¼å”·ğŸ˜ˆ</h3>
        <canvas id="pad"></canvas>
        <div class="dlg-actions">
          <button id="sigClear"  type="button">æ¸…é™¤</button>
          <button id="sigCancel" type="button">å–æ¶ˆ</button>
          <button id="sigOK"     type="button">ç¢ºå®š</button>
        </div>
      </div>
    </div>

    <!-- ///* LINE LIFF SDK */// -->
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

    <script>
      ///* ======================= åŸºæœ¬è¨­å®šèˆ‡å…±ç”¨å‡½å¼ ======================= *///
      const LIFF_ID='2008149060-m5pDXW6a';  // * LINE LIFF ID *//
      const WEBHOOK='https://script.google.com/macros/s/AKfycbyBBOcKctW3NsUMMg6wtZGrdR9nOeboK-ueMgTC6fGveanM7e8E7Wj4tiIUNc4Sfk8P/exec'; // * å¾Œç«¯ Apps Script *//

      // * ä¸»è¦ç¯€é» *//
      const editor=document.getElementById('editor'); const wallEl=document.getElementById('wall');
      function setStatus(m){ document.getElementById('status').textContent=m; } // * ç‹€æ…‹è¨Šæ¯ *//

      // * ç‹€æ…‹è³‡æ–™ *//
      let lineId='',displayName='',pictureUrl='',myLastRow=null,signatureDataURL='',sendInFlight=false,submittedOnce=false,signatureLocked=false;

      // * LocalStorage å¿«å– keyï¼ˆä¿ Dear èˆ‡ å…§æ–‡ï¼‰ *//
      const LS_KEY_CONTENT='blessContent';
      const LS_KEY_NAME='nameLabel';

      // * æ™‚é–“å­—ä¸² â†’ Dateï¼ˆå…¼å®¹è©¦ç®—è¡¨å›ä¾†çš„æ ¼å¼ï¼‰ *//
      function parseSheetTimeToDate(s){
        if(!s) return new Date();
        const m=/^(\d{4})-(\d{2})-(\d{2})[ T](\d{2}):(\d{2}):(\d{2})$/.exec(String(s).trim());
        if(m){
          const iso=`${m[1]}-${m[2]}-${m[3]}T${m[4]}:${m[5]}:${m[6]}+08:00`;
          const d=new Date(iso);
          return isNaN(d.getTime())?new Date():d;
        }
        const d=new Date(s); return isNaN(d.getTime())?new Date():d;
      }
      function pad2(n){return String(n).padStart(2,'0');}
      function fmtTaipei(s){ const d=parseSheetTimeToDate(s); return d.getFullYear()+'-'+pad2(d.getMonth()+1)+'-'+pad2(d.getDate())+' '+pad2(d.getHours())+':'+pad2(d.getMinutes())+':'+pad2(d.getSeconds()); }

      ///* ======================= LIFF åˆå§‹åŒ–èˆ‡åŸºæœ¬è³‡æ–™ ======================= *///
      async function initLIFF(){
        try{
          await liff.init({ liffId: LIFF_ID, withLoginOnExternalBrowser:true });
          if(!liff.isLoggedIn()){ liff.login(); return; }
          await liff.ready;
          const prof=await liff.getProfile(); const idt=liff.getDecodedIDToken();
          lineId=prof.userId||idt.sub||''; displayName=prof.displayName||idt.name||''; pictureUrl=prof.pictureUrl||'';
        }catch(_){}
        await fetchRoleAndNames(); await preloadMyLatest(); await refreshWall();
      }
      async function initialLoad(){ await fetchRoleAndNames(); await refreshWall(); }

      // * Dear åç¨±å¥—ç”¨ï¼ˆå«å¿«å–ï¼‰ *//
      function applyNameLabel(lbl){
        const name = (lbl && String(lbl).trim()) ? lbl : (localStorage.getItem(LS_KEY_NAME)||'â€”');
        document.getElementById('brideLabel').textContent = 'Dear ' + (name||'â€”');
      }

      // * å¾å¾Œç«¯å–ä½¿ç”¨è€…è§’è‰²/åç¨±ï¼ˆå¤±æ•—å°±ç”¨å¿«å–ï¼‰ *//
      async function fetchRoleAndNames(){
        applyNameLabel(null); // å…ˆç”¨å¿«å–
        try{
          const j=await (await fetch(WEBHOOK+`?action=userRole&lineId=${encodeURIComponent(lineId||'')}`)).json();
          if(j?.ok){
            const name = j.nameLabel || 'â€”';
            localStorage.setItem(LS_KEY_NAME, name);
            applyNameLabel(name);
          }
        }catch(_){
          applyNameLabel(null);
        }
      }

      // * Google Drive é€£çµ â†’ ç›´æ¥åœ–æª”ï¼ˆé¿å… hotlink å•é¡Œï¼‰ *//
      function toDriveDirectUrl(u){
        if(!u) return u;
        try{
          const s=String(u);
          const m1 = s.match(/drive\.google\.com\/file\/d\/([^/]+)/);
          const m2 = s.match(/[?&]id=([^&]+)/);
          const id = m1 ? m1[1] : (m2 ? m2[1] : null);
          return id ? `https://drive.google.com/uc?export=view&id=${id}` : u;
        }catch(_){ return u; }
      }

      ///* ======================= è¼‰å…¥æˆ‘ä¸Šä¸€ç­†è³‡æ–™ï¼ˆæˆ–ç”¨å¿«å–å¡«å…¥ï¼‰ ======================= *///
      async function preloadMyLatest(){
        if(!lineId){
          const cached = localStorage.getItem(LS_KEY_CONTENT);
          if(cached && editor.hasAttribute('data-empty')){
            editor.removeAttribute('data-empty');
            editor.innerHTML = cached;
          }
          return;
        }
        try{
          const j=await (await fetch(WEBHOOK+`?action=getLatestByLineId&lineId=${encodeURIComponent(lineId)}`)).json();
          if(j?.ok && j.item){
            const it=j.item;
            if(it.contentHTML){
              editor.innerHTML=it.contentHTML; editor.removeAttribute('data-empty'); lockEditor();
              localStorage.setItem(LS_KEY_CONTENT, it.contentHTML);
            }

            if(it.signature){
              const chip=document.getElementById('chipSign');
              const img=document.getElementById('signThumb');
              let src = String(it.signature||'').trim();
              if(src){
                src = src.startsWith('data:') ? src : toDriveDirectUrl(src);
                chip.classList.remove('has-img','locked');
                img.removeAttribute('src'); img.removeAttribute('alt');
                img.loading = 'eager'; img.referrerPolicy = 'no-referrer';
                img.onload = ()=>{ chip.classList.add('has-img'); chip.classList.add('locked'); signatureLocked=true; };
                img.onerror = ()=>{ const direct = toDriveDirectUrl(src); if(img.src !== direct){ img.src = direct; } else { chip.classList.remove('has-img','locked'); img.removeAttribute('src'); } img.onerror = null; };
                if(/^data:/.test(src) || /^https?:\/\//.test(src)){ img.src = src; }
              }
            }

            myLastRow = Number(it.row||0) || null;
            if(myLastRow){
              setButtonsState({ canEdit:true, canSend:false, inflight:false });
              submittedOnce=true; signatureLocked=true; document.getElementById('chipSign').classList.add('locked');
            }
          }else{
            setButtonsState({ canEdit:true, canSend:true, inflight:false });
            const cached = localStorage.getItem(LS_KEY_CONTENT);
            if(cached && editor.hasAttribute('data-empty')){
              editor.removeAttribute('data-empty');
              editor.innerHTML = cached;
            }
          }
        }catch(_){
          const cached = localStorage.getItem(LS_KEY_CONTENT);
          if(cached && editor.hasAttribute('data-empty')){
            editor.removeAttribute('data-empty');
            editor.innerHTML = cached;
          }
        }
      }

      ///* ======================= ç·¨è¼¯å™¨å·¥å…·ï¼ˆç²—æ–œç·šã€å­—è‰²ã€ç¸®æ”¾ï¼‰ ======================= *///
      function exec(cmd){ if(editor.hasAttribute('data-empty')||editor.classList.contains('locked')) return; document.execCommand(cmd,false,null); editor.focus(); }
      document.getElementById('btnBold').onclick=()=>exec('bold');
      document.getElementById('btnItalic').onclick=()=>exec('italic');
      document.getElementById('btnUnderline').onclick=()=>exec('underline');
      document.getElementById('colorPick').onchange=e=>{ const v=e.target.value; if(v&&!editor.classList.contains('locked')&&!editor.hasAttribute('data-empty')) document.execCommand('foreColor',false,v); e.target.blur(); };
      let globalScale=1; function setScale(s){globalScale=Math.max(.7,Math.min(1.7,s)); editor.style.setProperty('--editor-zoom',globalScale+'rem');}
      document.getElementById('btnBigger').onclick=()=>setScale(globalScale+.06);
      document.getElementById('btnSmaller').onclick=()=>setScale(globalScale-.06);
      const PLACEHOLDER='å¯«ä¸‹ä¸¦ç»ä¸Šæœ€èª æ‘¯çš„ç¥ç¦â€¦ğŸ’';
      editor.addEventListener('focus',()=>{ if(editor.hasAttribute('data-empty')){ editor.textContent=''; editor.removeAttribute('data-empty'); }});
      editor.addEventListener('blur',()=>{ if(!editor.textContent.trim()){ editor.setAttribute('data-empty',''); editor.textContent=PLACEHOLDER; }});

      // * å…§æ–‡å³æ™‚ä¿å­˜ï¼ˆæœªé–å®šä¸”é placeholderï¼‰ *//
      editor.addEventListener('input',()=>{
        if(!editor.classList.contains('locked') && !editor.hasAttribute('data-empty')){
          localStorage.setItem(LS_KEY_CONTENT, editor.innerHTML);
        }
      });

      ///* ç°½åæ¿ï¼ˆç•«æŠ¼ï¼‰ *///
      const sigOverlay=document.getElementById('sigOverlay'); const pad=document.getElementById('pad'); const ctx=pad.getContext('2d');
      let drawing=false,lastX=0,lastY=0;
      function fitCanvas(){ const dpr=Math.max(1,devicePixelRatio||1),w=pad.clientWidth,h=pad.clientHeight; pad.width=w*dpr; pad.height=h*dpr;
        ctx.setTransform(dpr,0,0,dpr,0,0); ctx.lineCap='round'; ctx.lineJoin='round'; ctx.lineWidth=3; ctx.strokeStyle='#111'; ctx.clearRect(0,0,w,h); }
      function pos(e){ const r=pad.getBoundingClientRect(); const c=e.touches?e.touches[0]:e; return {x:c.clientX-r.left,y:c.clientY-r.top}; }
      function start(e){ if(signatureLocked) return; drawing=true; const p=pos(e); lastX=p.x; lastY=p.y; e.preventDefault(); }
      function move(e){ if(!drawing||signatureLocked)return; const p=pos(e); ctx.beginPath(); ctx.moveTo(lastX,lastY); ctx.lineTo(p.x,p.y); ctx.stroke(); lastX=p.x; lastY=p.y; e.preventDefault(); }
      function end(){ drawing=false; }
      document.getElementById('chipSign').addEventListener('click',()=>{ const chip=document.getElementById('chipSign'); if(chip.classList.contains('locked')||signatureLocked) return;
        sigOverlay.classList.add('show'); setTimeout(fitCanvas,40); });
      pad.addEventListener('mousedown',start); pad.addEventListener('mousemove',move); pad.addEventListener('mouseup',end); pad.addEventListener('mouseleave',end);
      pad.addEventListener('touchstart',start,{passive:false}); pad.addEventListener('touchmove',move,{passive:false}); pad.addEventListener('touchend',end);
      document.getElementById('sigClear').onclick=()=>{ if(signatureLocked) return; fitCanvas(); };
      document.getElementById('sigCancel').onclick=()=>sigOverlay.classList.remove('show');
      document.getElementById('sigOK').onclick=()=>{
        if(signatureLocked) { sigOverlay.classList.remove('show'); return; }
        requestAnimationFrame(()=>{
          signatureDataURL=pad.toDataURL('image/png');
          const chip=document.getElementById('chipSign'); const img=document.getElementById('signThumb');
          chip.classList.remove('has-img','locked');
          img.onload = ()=>{ chip.classList.add('has-img'); img.onload=null; };
          img.removeAttribute('alt'); img.loading='eager'; img.src=signatureDataURL;
          sigOverlay.classList.remove('show');
        });
      };

      ///* ç‰†ä¸Šçš„æ‘˜è¦å…ˆè½‰ç´”æ–‡å­—ï¼Œé¿å… &nbsp; / <br> äº‚ç¢¼ *///
      function decodeEntities(s){
        if(s==null) return '';
        const el=document.createElement('textarea');
        el.innerHTML=String(s);
        return el.value;
      }
      function htmlToPlain(s){
        const decoded = decodeEntities(s).replace(/\u00A0/g,' ');
        const noTags = decoded.replace(/<\/?[^>]+>/g,'');
        return noTags.replace(/\r\n|\r/g,'\n').replace(/[ \t]+/g,' ').trim();
      }
      function oneLinePreview(s){ return htmlToPlain(s).replace(/\n+/g,' '); }
      function escapeHTML(s){return String(s||'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));}

      ///* ç”Ÿæˆæœ¨ç‰Œï¼ˆå³å´ç‰†ï¼‰ *///
      function tileTemplate(it){
        const raw = (it.preview ?? it.contentHTML ?? '');
        const snippet = oneLinePreview(raw) || 'â€”';
        return `<div class="tile" data-row="${it.row||''}" data-owner="${it.lineId||''}">
          <div class="tile-name">${escapeHTML(it.displayName||'â€”')}</div>
          <div class="tile-sep"></div>
          <div class="tile-date">${escapeHTML(fmtTaipei(it.time))}</div>
          <div class="tile-sep"></div>
          <div class="tile-snippet">${escapeHTML(snippet)}</div>
        </div>`;
      }

      ///* è®€å–åˆ—è¡¨ + é»æ“Šæœ¨ç‰Œé–‹çª— *///
      async function refreshWall(){
        try{
          const role=document.querySelector('.role-btn.active')?.id?.replace('role','').toLowerCase()||'all';
          const j=await (await fetch(WEBHOOK+`?action=listblessings&role=${role}`)).json();
          if(j?.ok){
            const arr=(j.items||[]).slice().sort((a,b)=>parseSheetTimeToDate(b.time)-parseSheetTimeToDate(a.time));
            wallEl.innerHTML=arr.map(tileTemplate).join('');
            bindTileClicks();
          }
        }catch(_){}
      }
      function bindTileClicks(){ document.querySelectorAll('.tile').forEach(t=>t.addEventListener('click',()=>openView(t))); }
      async function openView(el){
        const row=el.getAttribute('data-row');
        const j=await (await fetch(WEBHOOK+`?action=getBlessingDetail&id=${encodeURIComponent(row)}`)).json();
        if(j?.ok&&j.item){
          document.getElementById('viewMeta').textContent=`${j.item.displayName||'â€”'} ï½œ ${fmtTaipei(j.item.time)}`;
          document.getElementById('viewContent').innerHTML=j.item.contentHTML||'';
          document.getElementById('viewOverlay').classList.add('show');
        }
      }
      document.getElementById('viewClose').onclick=()=>document.getElementById('viewOverlay').classList.remove('show');
      document.getElementById('roleAll').onclick=()=>{document.querySelectorAll('.role-btn').forEach(b=>b.classList.remove('active'));document.getElementById('roleAll').classList.add('active');refreshWall();};
      document.getElementById('roleMale').onclick=()=>{document.querySelectorAll('.role-btn').forEach(b=>b.classList.remove('active'));document.getElementById('roleMale').classList.add('active');refreshWall();};
      document.getElementById('roleFemale').onclick=()=>{document.querySelectorAll('.role-btn').forEach(b=>b.classList.remove('active'));document.getElementById('roleFemale').classList.add('active');refreshWall();};

      ///* ç·¨è¼¯é–å®š/è§£é–èˆ‡é€å‡ºæŒ‰éˆ•ç‹€æ…‹ *///
      function lockEditor(){editor.classList.add('locked');editor.setAttribute('contenteditable','false');}
      function unlockEditor(){editor.classList.remove('locked');editor.setAttribute('contenteditable','true');editor.focus();}
      function hasSignature(){return document.getElementById('chipSign').classList.contains('has-img') || signatureLocked;}

      function setButtonsState({canEdit, canSend, inflight}){
        const btnSend=document.getElementById('btnSend');
        const btnEdit=document.getElementById('btnEdit');
        const editDisabled = !canEdit || !!inflight;
        const sendDisabled = !canSend || !!inflight;

        // æ–°å¢ï¼šå¯é€å‡ºæ™‚é¡¯ç¤ºã€Œé–å®šã€ï¼Œå…¶ä»–æƒ…æ³é¡¯ç¤ºã€Œé€å‡ºç¥ç¦ã€
        btnSend.textContent = (!sendDisabled ? 'é–å®š' : 'é€å‡ºç¥ç¦');
        btnSend.setAttribute('aria-label', btnSend.textContent);

        btnEdit.disabled = editDisabled; btnEdit.style.opacity = editDisabled ? '0.6' : '1'; btnEdit.style.pointerEvents = editDisabled ? 'none' : 'auto';
        btnSend.disabled = sendDisabled; btnSend.style.opacity = sendDisabled ? '0.6' : '1'; btnSend.style.pointerEvents = sendDisabled ? 'none' : 'auto';
      }

      // * å†æ¬¡ä¿®æ”¹ï¼ˆè§£é–ï¼‰ *//
      document.getElementById('btnEdit').onclick=()=>{
        unlockEditor();
        submittedOnce=false; sendInFlight=false;
        setButtonsState({ canEdit:true, canSend:true, inflight:false });
        if(signatureLocked){ document.getElementById('chipSign').classList.add('locked'); }
      };

      ///* é€å‡ºï¼æ›´æ–°ï¼ˆæŒ‰ã€Œé–å®šã€â†’ é¡¯ç¤ºç­‰å¾… â†’ æˆåŠŸè¨Šæ¯ï¼‰ *///
      async function sendOrUpdate(){
        if(editor.hasAttribute('data-empty')||!editor.textContent.trim()){ alert('æ¬¸ï¼Œä¸å¯èƒ½ä¸ç¥ç¦æˆ‘å€‘å§ğŸ–•ï¸'); return; }
        if(!hasSignature()){ alert('æ¬¸ï¼Œæ²’æœ‰ç•«æŠ¼ä¸å‡†é›¢é–‹âœï¸'); return; }
        if(sendInFlight){ return; }

        sendInFlight=true;
        setButtonsState({ canEdit:false, canSend:false, inflight:true });
        setStatus('â³ é€å‡ºä¸­ï¼è«‹ç¨å¾Œ...'); /* æ–°å¢ï¼šé€å‡ºé–å®šæœŸé–“é¡¯ç¤ºç­‰å¾…ä¸­ */

        const content=editor.innerHTML.trim();
        const payload = myLastRow
          ? {action:'updateBlessing',row:Number(myLastRow),lineId,contentHTML:content}
          : {action:'createBlessing',lineId,displayName,pictureUrl,contentHTML:content,signaturePNG:signatureDataURL||'',extra:{}};
        try{
          const r=await fetch(WEBHOOK,{method:'POST',headers:{'Content-Type':'text/plain;charset=UTF-8'},body:JSON.stringify(payload)});
          const j=await r.json().catch(()=>null);
          if(j?.ok){
            submittedOnce=true; lockEditor(); await refreshWall(); if(!myLastRow) await preloadMyLatest();
            setStatus(myLastRow?'âœ… å·²æ›´æ–°ä¸¦é–å®šï¼Œæˆªæ­¢æ—¥å‰éƒ½å¯ä»¥ä¿®æ”¹å”·':'âœ… å·²é€å‡ºä¸¦é–å®šï¼Œæˆªæ­¢æ—¥å‰éƒ½å¯ä»¥ä¿®æ”¹å”·');
            if(!signatureLocked){ signatureLocked=true; document.getElementById('chipSign').classList.add('locked'); }
            setButtonsState({ canEdit:true, canSend:false, inflight:false });
            sendInFlight=false;
            myLastRow = myLastRow || Number(j.row||0) || myLastRow;
          }else if(j?.error==='deadline_passed'){
            setStatus('â›” å·²åˆ°æˆªæ­¢æ—¥ï¼Œç„¡æ³•é€å‡ºåŠç·¨è¼¯'); lockEditor();
            setButtonsState({ canEdit:false, canSend:false, inflight:false });
            sendInFlight=false;
          }else{
            setStatus('âŒ é€å‡ºå¤±æ•—ï¼Œç¨å¾Œå†è©¦');
            sendInFlight=false;
            setButtonsState({ canEdit:true, canSend:true, inflight:false });
          }
        }catch(_){
          setStatus('âŒ é€å‡ºå¤±æ•—ï¼Œç¨å¾Œå†è©¦');
          sendInFlight=false;
          setButtonsState({ canEdit:true, canSend:true, inflight:false });
        }
      }
      document.getElementById('btnSend').onclick=sendOrUpdate;

      ///* é é¢è¼‰å…¥ï¼šå…ˆå¥— Dear å¿«å–èˆ‡è‰ç¨¿ï¼Œå†å•Ÿ LIFF or åˆå§‹è¼‰å…¥ *///
      window.addEventListener('DOMContentLoaded',()=>{
        applyNameLabel(null);
        const cached = localStorage.getItem(LS_KEY_CONTENT);
        if(cached && editor.hasAttribute('data-empty')){
          editor.removeAttribute('data-empty');
          editor.innerHTML = cached;
        }
        if(!editor.textContent.trim()){ editor.setAttribute('data-empty',''); editor.textContent='å¯«ä¸‹ä¸¦ç»ä¸Šæœ€èª æ‘¯çš„ç¥ç¦â€¦ğŸ’'; }
        if(window.liff) initLIFF(); else initialLoad();
      });
    </script>
  </body>
</html>
