<!doctype html>
<html lang="zh-Hant">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>é€ä¸Šç¥ç¦</title>

<!-- å­—é«” -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Patrick+Hand:wght@400&family=Sacramento:wght@400;700&display=swap" rel="stylesheet">

<style>
:root{
  /* ä¸»é¡Œèˆ‡å°ºå¯¸ */
  --brand-bg:#c9daf8;                 /* å…¨é åº•è‰²ï¼ˆå¤–å±¤è—ï¼‰ */
  --title:#A68A7C;                    /* æ¨™é¡Œå­—è‰² */
  --ink:#0f172a; --accent:#A68A7C; --rim:#E4E4E4; --soft:#F5F1EC;

  /* æ•´å¡Šé¢æ¿ï¼šè—è‰²æ¼¸å±¤ ï¼‹ï¼ˆå¯é¸ï¼‰èƒŒæ™¯åœ– */
  --panel-grad-from:#b7d2f6;
  --panel-grad-to:#cfe1fb;
  --panel-bg-image:none;              /* âœ… æƒ³ç”¨åœ–ç‰‡ï¼šæ”¹æˆ url('./assets/ä½ çš„åœ–.jpg') */

  /* å…§é å¡ç‰‡ï¼šé»ƒè‰²æ¼¸å±¤ */
  --paper-grad-from:rgba(255,242,204,.98);
  --paper-grad-to:rgba(255,242,204,.92);

  /* å°ºå¯¸å¾®èª¿ï¼ˆåŠ å¯¬ä¸€é»é»ï¼‰ */
  --panel-maxw:1180px;  /* â† æ¯”åŸæœ¬ 1020 å†å¯¬ï¼Œä½†ä»ä¿ç•™å·¦å³ç•™ç™½ */
  --card-maxw:1060px;

  --radius-xl:16px; --radius-md:12px;
  --shadow-1:0 10px 26px rgba(0,0,0,.10);
  --shadow-2:0 2px 0 rgba(0,0,0,.15), 0 2px 8px rgba(0,0,0,.06);

  --content-pad:22px; --editor-zoom:1rem;
  --toolbar-gap:8px; --status-fz:14px; --h2-size:2.8rem;
  --stroke:rgba(0,0,0,.18); --glow:rgba(255,255,255,.65);

  --footer-gap:48px;                  /* ç‰ˆå°¾é›¢åº•è·é›¢ï¼ˆå¯èª¿ï¼‰ */

  /* é€å‡ºç¥ç¦å°ºå¯¸ï¼ˆå†åŠ å¤§ä¸€é»ï¼‰ */
  --btn-w:220px;
  --btn-h:50px;

  /* è¨±é¡˜ç‰Œçµ±ä¸€å¡ç‰‡å°ºå¯¸ */
  --tile-w: 220px;
  --tile-h: 150px;
}

/* å›ºå®šç‰ˆé¢ã€ä¸æ²å‹• */
*{ box-sizing:border-box; }
html,body{
  height:100%; margin:0; overflow:hidden;
  color:var(--ink); background:var(--brand-bg);
  font-family:"Patrick Hand","Noto Sans TC",system-ui,-apple-system,sans-serif;
  -webkit-text-stroke:.35px var(--stroke); text-shadow:0 1px 0 var(--glow);
}

/* å›ºå®šèƒŒæ™¯ç…§ç‰‡ï¼ˆæ•´é ï¼‰ + åŠ æ·±è™•ç† */
.bg-photo{
  position:fixed; inset:0; z-index:0; width:100%; height:100%;
  object-fit:cover; opacity:.35; pointer-events:none;
  filter: brightness(.6) saturate(.9);  /* â† æ›´æ·±ä¸€äº› */
}

/* === é€ä¸Šç¥ç¦æ•´å¡Šï¼ˆè—è‰²æ¼¸å±¤ + å¯é¸åœ–ç‰‡ï¼‰ === */
.panel{
  position:relative; z-index:1;
  max-width:var(--panel-maxw);
  /* æŠŠé å°¾ç©ºé–“ç®—é€²å»ï¼Œé¿å…æ“‹ä½ footer */
  height:calc(100vh - (70px + var(--footer-gap)));
  margin:26px auto;
  background:
    linear-gradient(135deg, var(--panel-grad-from), var(--panel-grad-to)),
    var(--panel-bg-image);
  background-size: auto, cover;        /* åœ–ç‰‡é‹ªæ»¿ï¼Œæ¼¸å±¤åœ¨ä¸Šå±¤ */
  background-position: left top, center;
  border:1px solid var(--rim); border-radius:var(--radius-xl);
  box-shadow:var(--shadow-1);
  display:flex; flex-direction:column; overflow:hidden;
}

/* æ¨™é¡Œåˆ— */
.titlebar{ background:transparent; padding:10px 16px 6px; flex:0 0 auto; }
h2{
  margin:0 0 6px; text-align:center; font-family:"Sacramento",cursive;
  font-weight:700; font-size:var(--h2-size); letter-spacing:1px; color:var(--title);
  -webkit-text-stroke:.6px rgba(0,0,0,.12); text-shadow:0 3px 4px rgba(255,255,255,.75);
}

/* å°è¦½åˆ—å®¹å™¨ï¼šå¯¬åº¦èˆ‡å¡ç‰‡ä¸€è‡´ï¼Œé”æˆå·¦å³é‚Šé½Š */
.bar{ padding:6px 22px 8px; }
.bar-inner{
  max-width:var(--card-maxw);
  margin:0 auto;
  display:flex; align-items:center; gap:12px;
}
/* å·¥å…·åˆ—é å·¦ï¼Œç‹€æ…‹åˆ—åƒæ»¿å‰©é¤˜å¯¬ï¼Œå³é‚Šé½Š â€”â€”ï¼ˆä¿æŒä½ åŸæœ¬æ¨£å¼ï¼Œä¸å‹•èªæ„ï¼‰ */
.toolbar{ display:flex; gap:var(--toolbar-gap); filter:drop-shadow(0 2px 0 rgba(0,0,0,.08)); }
.flex-spacer{ flex:0 0 8px; }
.tool-btn,.tool-select{
  min-width:64px; height:36px; padding:0 12px; background:#fff; border:1px solid var(--rim); border-radius:var(--radius-md);
  font-weight:700; display:flex; align-items:center; justify-content:center; gap:6px; box-shadow:var(--shadow-2);
}
.tool-select{ min-width:auto; padding:0 10px; }
.tool-btn:active{ transform:translateY(1px) scale(.99); }

/* ç‹€æ…‹åˆ—ï¼ˆç¶­æŒåŸä¾†ç½®ä¸­æ‹‰å¯¬ï¼‰ */
#status{
  flex:1 1 auto;
  background:var(--soft); border:1px solid #E4E4E4; border-radius:12px; padding:10px;
  font-size:var(--status-fz); white-space:pre-wrap; text-align:center; color:var(--accent)!important; font-weight:700;
  -webkit-text-stroke:.35px rgba(0,0,0,.10); text-shadow:0 1px 0 rgba(255,255,255,.85),0 3px 6px rgba(0,0,0,.04);
  min-width:320px;
}

/* === å…§é èˆå° === */
.stage{ flex:1 1 auto; padding:14px 22px 0; display:flex; justify-content:center; align-items:flex-start; overflow:hidden; }

/* å…§æ–‡å¡ï¼ˆé»ƒè‰²æ¼¸å±¤ï¼‰ */
.card{
  position:relative; width:100%; max-width:var(--card-maxw);
  background:linear-gradient(180deg, var(--paper-grad-from), var(--paper-grad-to));
  border:1px solid rgba(0,0,0,.05);
  border-radius:var(--radius-xl); box-shadow:0 10px 26px rgba(0,0,0,.08);
  padding:var(--content-pad);
  padding-bottom:calc(var(--content-pad) + 36px); /* é ç•™å³ä¸‹ç°½åå¾½ç« ç©ºé–“ï¼ˆç¶­æŒï¼‰ */

  /* ä¸‰æ¬„å¼ï¼šå·¦ 1fr / ä¸­ 2fr / å³ 1fr */
  display:grid; grid-template-columns: 0.9fr 2.2fr 1fr; gap:14px;
  height:100%; overflow:auto;  /* è®“å…§å®¹å¯æ²ï¼Œä½†å³å´å€å¡Š sticky ä¿æŒå¯è¦‹ */
}

/* ====== å·¦å´ï¼šç¯©é¸ï¼ˆç¸®å°ä¸€é»ï¼Œæ¯”ã€Œç²—é«”ã€æŒ‰éˆ•å¤§ä¸€é»é»ï¼‰ ====== */
.sidebar{
  align-self:start;
  position:sticky; top:0; /* å¡ç‰‡å…§æ²å‹•æ™‚å›ºå®š */
}
.filter-panel{
  display:flex; flex-direction:column; align-items:stretch; gap:10px;
  background:#fff; border:2px solid var(--ink); border-radius:12px; padding:10px;
  box-shadow:var(--shadow-2);
  width:min(180px, 100%);
}
.filter-title{ text-align:center; font-weight:900; }
.filter-btn{
  height:36px; font-weight:900; background:#fff;
  border:2px solid var(--ink); border-radius:10px; cursor:pointer;
  display:flex; align-items:center; justify-content:center;
}
.filter-btn.active{ background:#f3f4f6; }

/* ====== ä¸­é–“ï¼šç¥ç¦ç‰†ï¼ˆè¨±é¡˜ç‰Œï¼‰ ====== */
.wall{
  min-height:280px;
  display:grid;
  grid-template-columns: repeat(auto-fill, minmax(var(--tile-w), 1fr));
  gap:12px;
  align-content:start;
  padding-bottom:10px;
}
.tile{
  width:100%; height:var(--tile-h);
  background:#fff;
  border:1px solid var(--rim);
  border-radius:12px;
  box-shadow:0 4px 12px rgba(0,0,0,.06);
  padding:10px 12px; cursor:pointer; position:relative; overflow:hidden;
  display:flex; flex-direction:column; justify-content:flex-start; gap:6px;
}
.tile-header{
  display:flex; align-items:center; justify-content:center; gap:8px;
  font-weight:800; text-align:center;
}
.tile-meta{
  font-size:12px; opacity:.8; text-align:center;
}
.tile-snippet{
  font-size:14px; line-height:1.5; display:-webkit-box; -webkit-line-clamp:3; -webkit-box-orient:vertical; overflow:hidden;
  text-align:center;
}
.tile-sign{
  position:absolute; right:8px; bottom:8px;
  width:70px; height:34px; border:1px solid var(--rim); border-radius:6px; background:#fff;
  display:flex; align-items:center; justify-content:center; overflow:hidden;
}
.tile-sign img{ width:100%; height:100%; object-fit:contain; }

/* æ”¾å¤§æª¢è¦– modal */
.overlay{ position:fixed; inset:0; z-index:9999; display:none; align-items:center; justify-content:center; background:rgba(17,24,39,.35); backdrop-filter:blur(3px); }
.overlay.show{ display:flex; }
.dialog{ width:min(92vw,680px); max-height:82vh; background:var(--soft); border:1px solid var(--rim); border-radius:14px; padding:16px; box-shadow:0 18px 44px rgba(0,0,0,.18); overflow:auto; }
.dialog h3{ margin:0 0 10px; font-size:18px; color:#6b5e52; text-align:center; -webkit-text-stroke:0; text-shadow:none; }
.view-meta{ text-align:center; font-size:12px; opacity:.75; margin-bottom:8px; }
.view-content{ background:#fff; border:1px solid #ddd; border-radius:12px; padding:12px; line-height:1.8; }
.view-actions{ display:flex; gap:10px; justify-content:center; margin-top:12px; }
.view-actions button{ min-width:120px; height:38px; border-radius:10px; border:1px solid var(--rim); background:#fff; cursor:pointer; font-weight:700; }

/* ====== å³å´ï¼šå›ºå®šæ–°äººï¼‹ç°½åï¼ˆä¸å› æ²å‹•æ¶ˆå¤±ï¼‰ ====== */
.right-fixed{
  position:sticky; top:0; align-self:start;
}
.right-card{
  background:linear-gradient(180deg, var(--paper-grad-from), var(--paper-grad-to));
  border:1px solid rgba(0,0,0,.08); border-radius:12px; padding:12px; box-shadow:0 6px 16px rgba(0,0,0,.08);
  display:flex; flex-direction:column; gap:12px;
}
.right-header{ font-weight:900; font-size:1.05rem; }
#chipBride{ background:transparent; padding:0; box-shadow:none; border:none; position:static; }
#chipBride span{ font-weight:900; }
.sign-block{ display:flex; flex-direction:column; gap:8px; }
.sign-title{ font-weight:900; text-align:right; }
#chipSign{
  position:relative; right:auto; bottom:auto;
  border:1px solid rgba(0,0,0,.08);
  background:linear-gradient(180deg, var(--paper-grad-from), var(--paper-grad-to)); /* èˆ‡å¡ç‰‡ä¸€è‡´ */
  border-radius:12px; padding:8px; box-shadow:0 2px 8px rgba(0,0,0,.06); cursor:pointer;
  display:flex; align-items:center; gap:8px; justify-content:flex-end;
}
#chipSign .hint{ opacity:.55; }
#chipSign.has-img .hint{ display:none; }          /* â† ç°½å®Œåå¾Œæ–‡å­—æ¶ˆå¤± */
#signThumb{
  display:none; width:120px; height:50px; object-fit:contain;
  background:linear-gradient(180deg, var(--paper-grad-from), var(--paper-grad-to)); /* åº•è‰²èˆ‡æ¡†ä¸€è‡´ */
  border:1px solid var(--rim); border-radius:8px;
}
#chipSign.has-img #signThumb{ display:block; }

/* ç·¨è¼¯å™¨æœ¬é«”ï¼šä¿ç•™ä½ çš„è¡Œç‚º */
.editor{
  min-height:220px; max-height:36vh; overflow:auto;
  line-height:1.8; outline:none; background:transparent; border-radius:var(--radius-md); padding:10px 12px;
  font-size:var(--editor-zoom);
  background-image:none;
}
/* placeholder è¶…æ·¡ï¼ˆæŒ‰å·¥å…·éµä¹Ÿä¿æŒæ·¡ï¼Œç›´åˆ°è¼¸å…¥ï¼‰ */
.editor[data-empty]{ opacity:.22; }

/* æ”¾å¤§/ç¸®å°é¡åˆ¥ï¼ˆä¿ç•™ï¼‰ */
.fs-up-1{font-size:1.15em;} .fs-up-2{font-size:1.30em;} .fs-up-3{font-size:1.50em;}
.fs-down-1{font-size:.92em;} .fs-down-2{font-size:.84em;} .fs-down-3{font-size:.76em;}

/* é€å‡ºéµï¼ˆåŠ å¤§ï¼‹ä¸Šä¸‹ç•™ç™½æ›´å¤šï¼‰ */
.footer-actions{ flex:0 0 auto; display:flex; justify-content:center; align-items:center; padding:14px 0 16px; }
.primary{
  min-width:var(--btn-w); height:var(--btn-h); padding:0 20px; background:#fff; border:1px solid var(--rim);
  border-radius:var(--radius-md); font-weight:700; cursor:pointer; box-shadow:var(--shadow-2);
}
.primary:active{ transform:translateY(1px) scale(.99); }

/* ç‰ˆå°¾ */
footer{
  position:fixed; left:0; right:0; bottom:var(--footer-gap);
  text-align:center; color:#6b5e52; font-size:12px; opacity:.9; pointer-events:none;
  z-index:5;
}

/* ç°½å Modalï¼ˆæ²¿ç”¨ï¼‰ */
#sigOverlay .dialog{ width:min(92vw,520px); }
#pad{ width:100%; height:260px; background:#fff; border:1px solid #ddd; border-radius:12px; touch-action:none; }
.dlg-actions{ display:flex; gap:10px; justify-content:center; margin-top:12px; }
.dlg-actions button{ width:120px; height:38px; border-radius:10px; border:1px solid var(--rim); background:#fff; cursor:pointer; font-weight:700; }
</style>

<body>
  <!-- å›ºå®šèƒŒæ™¯ç…§ç‰‡ -->
  <img class="bg-photo" src="./assets/wishing.png" alt="">

  <div class="panel">
    <div class="titlebar">
      <h2>é€ä¸Šç¥ç¦</h2>

      <!-- å·¥å…·åˆ—ï¼‹ç‹€æ…‹åˆ—ï¼ˆä¿æŒåŸçµæ§‹èˆ‡æ¨£å¼ï¼‰ -->
      <div class="bar">
        <div class="bar-inner">
          <div class="toolbar" role="toolbar" aria-label="æ–‡å­—å·¥å…·">
            <button class="tool-btn" id="btnBold"      type="button" title="ç²—é«”">ç²—é«”</button>
            <button class="tool-btn" id="btnItalic"    type="button" title="æ–œé«”">æ–œé«”</button>
            <button class="tool-btn" id="btnUnderline" type="button" title="åº•ç·š">åº•ç·š</button>
            <select id="colorPick" class="tool-select" title="å­—é«”é¡è‰²">
              <option value="" selected>é¡è‰²</option>
              <option value="#0f172a">å¢¨è‰²</option>
              <option value="#a21caf">ç´«</option>
              <option value="#dc2626">ç´…</option>
              <option value="#2563eb">è—</option>
              <option value="#059669">ç¶ </option>
              <option value="#d97706">æ©˜</option>
              <option value="#6b7280">ç°</option>
            </select>
            <button class="tool-btn" id="btnBigger"    type="button" title="æ”¾å¤§">æ”¾å¤§</button>
            <button class="tool-btn" id="btnSmaller"   type="button" title="ç¸®å°">ç¸®å°</button>
          </div>
          <div class="flex-spacer"></div>
          <p id="status">å·²å°±ç·’</p>
        </div>
      </div>
    </div>

    <div class="stage">
      <div class="card" id="card">
        <!-- å·¦ï¼šç¯©é¸ï¼ˆæ›´å°ã€ç½®ä¸­ã€ç²—æ¡†ï¼‰ -->
        <aside class="sidebar">
          <div class="filter-panel">
            <div class="filter-title">ç¯©é¸</div>
            <button type="button" class="filter-btn active" data-role="all">å…¨éƒ¨</button>
            <button type="button" class="filter-btn" data-role="male">ç”·æ–¹</button>
            <button type="button" class="filter-btn" data-role="female">å¥³æ–¹</button>
          </div>
        </aside>

        <!-- ä¸­ï¼šç¥ç¦ç‰†ï¼ˆè¨±é¡˜ç‰Œï¼‰ -->
        <section>
          <div class="wall" id="wall">
            <!-- JS å‹•æ…‹æ³¨å…¥å›ºå®šå°ºå¯¸è¨±é¡˜ç‰Œ -->
          </div>
        </section>

        <!-- å³ï¼šå›ºå®šæ–°äººï¼‹ç°½å -->
        <aside class="right-fixed">
          <div class="right-card">
            <div class="right-header">å³å´å…§æ–‡</div>
            <div id="chipBride"><span id="brideLabel">æ–°äººï¼šâ€”</span></div>
            <div class="sign-block">
              <div class="sign-title">ç°½å</div>
              <div class="badge badge-bottom-right" id="chipSign" title="é»æ­¤ç°½å">
                <span class="hint">é»æˆ‘ç°½å</span>
                <img id="signThumb" alt="signature preview" />
              </div>
            </div>
            <!-- ç·¨è¼¯å™¨æ”¾é€™è£¡ï¼ˆé»ƒè‰²å€å¡Šä¸‹æ–¹ã€é€å‡ºéµä¸Šæ–¹ï¼‰ï¼Œä½ç½®å›ºå®šåœ¨å³æ¬„æ–¹ä¾¿æ“ä½œ -->
            <div class="editor" id="editor" contenteditable="true" aria-label="ç¥ç¦å…§å®¹">
              åœ¨æ­¤å¯«ä¸‹ä½ å°æ–°äººçš„ç¥ç¦â€¦ï¼ˆå¯é¸å­—å¾ŒæŒ‰ä¸Šæ–¹çš„ç²—é«”ï¼æ–œé«”ï¼åº•ç·šï¼é¡è‰²ï¼æ”¾å¤§ï¼ç¸®å°ï¼‰ğŸ’
            </div>
          </div>
        </aside>
      </div>
    </div>

    <div class="footer-actions">
      <button id="btnSubmit" class="primary" type="button">é€å‡ºç¥ç¦</button>
    </div>
  </div>

  <footer>Â© Copyright 2025 MYâ€˜s System</footer>

  <!-- æ”¾å¤§æª¢è¦– Modal -->
  <div id="viewOverlay" class="overlay" role="dialog" aria-modal="true" aria-labelledby="viewTitle">
    <div class="dialog">
      <h3 id="viewTitle">ç¥ç¦å…§å®¹</h3>
      <div class="view-meta" id="viewMeta"></div>
      <div id="viewContent" class="view-content"></div>
      <div class="view-actions">
        <button id="viewClose" type="button">é—œé–‰</button>
        <button id="viewEdit"  type="button" style="display:none;">ç·¨è¼¯ï¼ˆåƒ…é™æœ¬äººï¼‰</button>
        <button id="viewSave"  type="button" style="display:none;">å„²å­˜</button>
      </div>
    </div>
  </div>

  <!-- ç°½å Modal -->
  <div id="sigOverlay" class="overlay" role="dialog" aria-modal="true" aria-labelledby="sigTitle">
    <div class="dialog">
      <h3 id="sigTitle">è«‹æ–¼ä¸‹æ–¹ç°½å</h3>
      <canvas id="pad"></canvas>
      <div class="dlg-actions">
        <button id="sigClear"  type="button">æ¸…é™¤</button>
        <button id="sigCancel" type="button">å–æ¶ˆ</button>
        <button id="sigOK"     type="button">ç¢ºå®š</button>
      </div>
    </div>
  </div>

<script>
/* ====== åŸºæœ¬è¨­å®šï¼ˆæ²¿ç”¨ï¼‰ ====== */
const LIFF_ID='2008149060-m5pDXW6a';
const WEBHOOK='https://script.google.com/macros/s/AKfycbzv1N_JkqZQDmm3F9pj9NwVbsJ94G4MMJBJOBl3Ewf4DZQwH7_ILAlz6OCE1wnx7yW7/exec';
const TIMEOUT_MS=20000;

/* ç‹€æ…‹åˆ— */
function setStatus(m){
  const el=document.getElementById('status');
  el.textContent=m; el.classList.remove('ok','busy','err');
  if(/æˆåŠŸ|å·²è¼‰å…¥|å°±ç·’/.test(m)) el.classList.add('ok');
  else if(/é€å‡ºä¸­|ç­‰å¾…|è™•ç†/.test(m)) el.classList.add('busy');
  else if(/å¤±æ•—|é€¾æ™‚|ç„¡æ³•|éŒ¯èª¤/.test(m)) el.classList.add('err');
}

/* LIFF åˆå§‹åŒ–ï¼ˆæ²¿ç”¨ï¼‰ */
let lineId='',displayName='',pictureUrl='';
async function initLIFF(){
  if(typeof liff==='undefined'){ setStatus('ï¼ˆæœªè¼‰å…¥ LIFF SDKï¼Œå¯å…ˆæ¸¬æ¨£å¼ï¼‰'); return; }
  try{
    setStatus('åˆå§‹åŒ– LIFFâ€¦');
    await liff.init({ liffId: LIFF_ID, withLoginOnExternalBrowser:true });
    if(!liff.isLoggedIn()){ liff.login({ scope:['openid','profile'] }); return; }
    if(liff.ready) await liff.ready;
    let prof=null, idt=null;
    try{ prof=await liff.getProfile(); }catch(_){}
    try{ idt=liff.getDecodedIDToken(); }catch(_){}
    lineId=(prof&&prof.userId)||(idt&&idt.sub)||'';
    displayName=(prof&&prof.displayName)||(idt&&(idt.name||idt.nickname))||'';
    pictureUrl=(prof&&prof.pictureUrl)||'';
    // è¼‰å…¥æ–°äººå§“å
    try{
      const r=await fetch(WEBHOOK+'?action=couple',{method:'GET',cache:'no-store'});
      if(r.ok){ const j=await r.json().catch(()=>null); if(j&&j.ok&&j.name){ document.getElementById('brideLabel').textContent='æ–°äººï¼š'+String(j.name||'â€”'); } }
    }catch(_){}
    // è®€å–ç‰†
    await refreshWall();
    setStatus('å·²å°±ç·’');
  }catch(e){ setStatus('LIFF åˆå§‹åŒ–å¤±æ•—ï¼š'+e.message); }
}

/* ====== å·¥å…·åˆ—ï¼ˆä¿ç•™åŸæœ¬åŠŸèƒ½ï¼‰ ====== */
const editor=document.getElementById('editor');
function btnExec(cmd){
  if(editor.hasAttribute('data-empty')) return;
  document.execCommand(cmd,false,null); editor.focus();
}
document.getElementById('btnBold').addEventListener('click',()=>btnExec('bold'));
document.getElementById('btnItalic').addEventListener('click',()=>btnExec('italic'));
document.getElementById('btnUnderline').addEventListener('click',()=>btnExec('underline'));
document.getElementById('colorPick').addEventListener('change',e=>{
  const v=e.target.value;
  if(!editor.hasAttribute('data-empty') && v){ document.execCommand('foreColor',false,v); editor.focus(); }
  e.target.blur();
});

/* æ”¾å¤§/ç¸®å°ï¼šä¿ç•™ä½ çš„é‚è¼¯ */
function wrapSelectionWithClass(cls){
  if(editor.hasAttribute('data-empty')) return false;
  const sel=window.getSelection(); if(!sel.rangeCount) return false;
  const r=sel.getRangeAt(0); if(r.collapsed) return false;
  const span=document.createElement('span'); span.className=cls;
  try{ r.surroundContents(span); }catch(_){ const f=r.extractContents(); span.appendChild(f); r.insertNode(span); }
  const s2=window.getSelection(); s2.removeAllRanges(); const nr=document.createRange(); nr.setStartAfter(span); nr.collapse(true); s2.addRange(nr);
  editor.focus(); return true;
}
let globalScale=1;
function setGlobalScale(sc){ globalScale=Math.max(0.7,Math.min(1.7,sc)); editor.style.setProperty('--editor-zoom',globalScale+'rem'); }
function stepBigger(){ if(!wrapSelectionWithClass('fs-up-1')) setGlobalScale(globalScale+0.06); }
function stepSmaller(){ if(!wrapSelectionWithClass('fs-down-1')) setGlobalScale(globalScale-0.06); }
document.getElementById('btnBigger').addEventListener('click',stepBigger);
document.getElementById('btnSmaller').addEventListener('click',stepSmaller);

/* placeholderï¼šé»ä¸€ä¸‹å°±æ¸…ç©ºï¼›è‹¥ç©ºç™½é›¢é–‹å†æ¢å¾©ï¼ˆä¿ç•™ï¼‰ */
const PLACEHOLDER='åœ¨æ­¤å¯«ä¸‹ä½ å°æ–°äººçš„ç¥ç¦â€¦ï¼ˆå¯é¸å­—å¾ŒæŒ‰ä¸Šæ–¹çš„ç²—é«”ï¼æ–œé«”ï¼åº•ç·šï¼é¡è‰²ï¼æ”¾å¤§ï¼ç¸®å°ï¼‰ğŸ’';
function showPlaceholder(){ editor.setAttribute('data-empty',''); editor.innerHTML=PLACEHOLDER; }
editor.addEventListener('focus',()=>{ if(editor.hasAttribute('data-empty')){ editor.innerHTML=''; editor.removeAttribute('data-empty'); }});
editor.addEventListener('blur',()=>{ if(!editor.textContent.trim()) showPlaceholder(); });

/* ====== ç°½åï¼ˆç°½å®Œåªç•™ç¸®åœ–ï¼›åº•è‰²èˆ‡æ¡†ä¸€è‡´ï¼‰ ====== */
const sigOverlay=document.getElementById('sigOverlay');
const pad=document.getElementById('pad'); const ctx=pad.getContext('2d');
let drawing=false,lastX=0,lastY=0,signatureDataURL='';
function fitCanvas(){ const dpr=Math.max(1,window.devicePixelRatio||1),w=pad.clientWidth,h=pad.clientHeight; pad.width=w*dpr; pad.height=h*dpr; ctx.setTransform(dpr,0,0,dpr,0,0); ctx.lineCap='round'; ctx.lineJoin='round'; ctx.lineWidth=3; ctx.strokeStyle='#111'; ctx.clearRect(0,0,w,h); }
function openSign(){ sigOverlay.classList.add('show'); setTimeout(fitCanvas,40); }
function closeSign(){ sigOverlay.classList.remove('show'); }
function pos(e){ const r=pad.getBoundingClientRect(); return {x:(e.touches?e.touches[0].clientX:e.clientX)-r.left, y:(e.touches?e.touches[0].clientY:e.clientY)-r.top}; }
function start(e){ drawing=true; const p=pos(e); lastX=p.x; lastY=p.y; e.preventDefault(); }
function move(e){ if(!drawing) return; const p=pos(e); ctx.beginPath(); ctx.moveTo(lastX,lastY); ctx.lineTo(p.x,p.y); ctx.stroke(); lastX=p.x; lastY=p.y; e.preventDefault(); }
function end(){ drawing=false; }
pad.addEventListener('mousedown',start); pad.addEventListener('mousemove',move); pad.addEventListener('mouseup',end); pad.addEventListener('mouseleave',end);
pad.addEventListener('touchstart',start,{passive:false}); pad.addEventListener('touchmove',move,{passive:false}); pad.addEventListener('touchend',end);

document.getElementById('chipSign').addEventListener('click',openSign);
document.getElementById('sigClear').addEventListener('click',fitCanvas);
document.getElementById('sigCancel').addEventListener('click',closeSign);
document.getElementById('sigOK').addEventListener('click',()=>{
  signatureDataURL=pad.toDataURL('image/png');
  const chip=document.getElementById('chipSign'); const img=document.getElementById('signThumb');
  img.src=signatureDataURL; chip.classList.add('has-img');  /* â† æ–‡å­—è‡ªå‹•æ¶ˆå¤± */
  closeSign();
});

/* ====== ç¥ç¦ç‰†ï¼šåˆ—è¡¨è¼‰å…¥ + æ”¾å¤§æª¢è¦– +ï¼ˆæœ¬äººï¼‰å¯ç·¨è¼¯ ====== */
const wallEl=document.getElementById('wall');
let currentRole='all';
document.querySelectorAll('.filter-btn').forEach(btn=>{
  btn.addEventListener('click', async ()=>{
    document.querySelectorAll('.filter-btn').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    currentRole=btn.dataset.role||'all';
    await refreshWall();
  });
});

async function fetchJSON(url, opt){
  const r=await fetch(url,opt); const ct=(r.headers.get('content-type')||'').toLowerCase();
  const t=await (ct.includes('application/json')? r.json(): r.text());
  return t;
}

function tileTemplate(item){
  const date = item.time ? String(item.time).slice(0,16) : '';
  const snippet = (item.preview || '').trim() || 'â€”';
  const signHTML = item.signature && item.signatureType==='drive'
      ? `<img src="${item.signature}" alt="">`
      : (item.signature ? `<img src="${item.signature}" alt="">` : '');
  return `
  <div class="tile" data-row="${item.row||''}" data-owner="${item.lineId||''}">
    <div class="tile-header">${escapeHTML(item.displayName||'â€”')}</div>
    <div class="tile-meta">${escapeHTML(date)}</div>
    <div class="tile-snippet">${escapeHTML(snippet)}</div>
    <div class="tile-sign">${signHTML}</div>
  </div>`;
}

function escapeHTML(s){ return String(s||'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }

async function refreshWall(){
  try{
    const url=WEBHOOK+`?action=listblessings&role=${encodeURIComponent(currentRole)}`;
    const j=await fetchJSON(url,{method:'GET',cache:'no-store'});
    if(j && j.ok){
      wallEl.innerHTML = (j.items||[]).map(tileTemplate).join('') || '';
      bindTileClicks();
    }
  }catch(e){ /* å¿½ç•¥ç‰†å¤±æ•—ï¼Œä¸å½±éŸ¿é€å‡º */ }
}

function bindTileClicks(){
  wallEl.querySelectorAll('.tile').forEach(tile=>{
    tile.addEventListener('click', ()=>openView(tile));
  });
}

/* æ”¾å¤§æª¢è¦–/ç·¨è¼¯çª—å£ */
const viewOverlay=document.getElementById('viewOverlay');
const viewMeta=document.getElementById('viewMeta');
const viewContent=document.getElementById('viewContent');
const btnViewClose=document.getElementById('viewClose');
const btnViewEdit=document.getElementById('viewEdit');
const btnViewSave=document.getElementById('viewSave');
let currentViewRow=null, currentViewOwner='';

btnViewClose.addEventListener('click', ()=>{ viewOverlay.classList.remove('show'); currentViewRow=null; });
btnViewEdit.addEventListener('click', ()=>{ viewContent.setAttribute('contenteditable','true'); btnViewSave.style.display='inline-flex'; btnViewEdit.style.display='none'; });
btnViewSave.addEventListener('click', async ()=>{
  if(!currentViewRow) return;
  try{
    const payload={ action:'updateBlessing', row:Number(currentViewRow), lineId, contentHTML:viewContent.innerHTML.trim() };
    const r=await fetch(WEBHOOK,{ method:'POST', headers:{'Content-Type':'text/plain;charset=UTF-8'}, body:JSON.stringify(payload) });
    const j= await r.json().catch(()=>null);
    if(j && j.ok){ setStatus('âœ… å·²å„²å­˜'); viewContent.removeAttribute('contenteditable'); btnViewSave.style.display='none'; await refreshWall(); }
    else{ setStatus('âŒ ç„¡æ³•å„²å­˜ï¼ˆå¯èƒ½å·²éæˆªæ­¢æˆ–éæœ¬äººï¼‰'); }
  }catch(e){ setStatus('âŒ å„²å­˜å¤±æ•—ï¼š'+(e?.message||'')); }
});

async function openView(tileEl){
  const row = tileEl.getAttribute('data-row');
  const owner = tileEl.getAttribute('data-owner')||'';
  currentViewRow=row; currentViewOwner=owner;
  try{
    const j=await fetchJSON(WEBHOOK+`?action=getBlessingDetail&id=${encodeURIComponent(row)}`,{method:'GET',cache:'no-store'});
    if(j && j.ok && j.item){
      const it=j.item;
      const date=it.time? String(it.time).slice(0,16):'';
      viewMeta.textContent = `${it.displayName||'â€”'} ï½œ ${date}`;
      viewContent.innerHTML = it.contentHTML || '';
      // æ˜¯å¦å¯ç·¨è¼¯ï¼ˆåªå…è¨±æœ¬äººï¼›æˆªæ­¢ç”±å¾Œç«¯æŠŠé—œï¼‰
      if(lineId && owner===lineId){ btnViewEdit.style.display='inline-flex'; } else { btnViewEdit.style.display='none'; }
      btnViewSave.style.display='none';
      viewOverlay.classList.add('show');
    }
  }catch(e){ /* ignore */ }
}

/* ====== é€å‡º ====== */
document.getElementById('btnSubmit').addEventListener('click', async ()=>{
  if(editor.hasAttribute('data-empty') || !editor.textContent.trim()){ alert('è«‹å¯«ä¸‹ç¥ç¦å…§å®¹å”·ï½'); return; }
  const text=editor.innerHTML.trim();

  try{
    const ping=await fetch(WEBHOOK+'?action=ping',{method:'GET',cache:'no-store'});
    const t=await ping.text().catch(()=> ''); if(String(t).trim().toLowerCase()!=='ok'){ setStatus('âš ï¸ å¾Œç«¯æœªå›æ‡‰æ­£å¸¸ï¼ˆping='+t+'ï¼‰'); return; }
  }catch(_){ setStatus('âš ï¸ ç„¡æ³•é€£åˆ°å¾Œç«¯ï¼ˆping å¤±æ•—ï¼‰'); return; }

  setStatus('â³ é€å‡ºä¸­â€¦');
  const payload={ action:'createBlessing', lineId, displayName, pictureUrl, contentHTML:text, signaturePNG:signatureDataURL||'', extra:{} };
  const ctl=new AbortController(); const timer=setTimeout(()=>ctl.abort(), TIMEOUT_MS);
  try{
    const r=await fetch(WEBHOOK,{ method:'POST', headers:{'Content-Type':'text/plain;charset=UTF-8'}, body:JSON.stringify(payload), signal:ctl.signal, keepalive:true });
    clearTimeout(timer);
    const ct=(r.headers.get('content-type')||'').toLowerCase(); let j=null;
    if(ct.includes('application/json')) j=await r.json().catch(()=>null); else { const t=await r.text().catch(()=> ''); if(/^\s*\{/.test(t)) try{ j=JSON.parse(t);}catch(_){} }
    if(!j && r.ok) j={ok:true};
    if(j&&j.ok){
      setStatus('âœ… ç¥ç¦å·²é€å‡ºæˆåŠŸï¼');
      // æ¸…ç©ºç·¨è¼¯å™¨ & æ›´æ–°ç‰†
      showPlaceholder(); signatureDataURL=''; document.getElementById('chipSign').classList.remove('has-img'); document.getElementById('signThumb').src='';
      await refreshWall();
    } else { setStatus('âŒ é€å‡ºå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦'); }
  }catch(e){ setStatus('âŒ é€å‡ºé€¾æ™‚æˆ–å¤±æ•—ï¼š'+(e?.message||'')); }
});

/* å•Ÿå‹• */
window.addEventListener('DOMContentLoaded', ()=>{
  setStatus('å·²å°±ç·’');
  showPlaceholder();
  if(window.liff) initLIFF(); else refreshWall(); // æ²’ LIFF ä¹Ÿå¯çœ‹ç‰†
});
</script>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</body>
</html>
