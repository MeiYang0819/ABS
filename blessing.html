<!doctype html>
<html lang="zh-Hant">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ç¥ç¦ç‰†</title>

  <!-- âœ… å­—é«”ï¼šæ¨™é¡Œ Sacramentoã€å…§æ–‡ Patrick Handï¼ˆéƒ½å¯æ”¹æ–‡å­—èˆ‡ç²—ç´°ï¼‰ -->
  <link rel="preconnect" href="https://fonts.googleapis.com"> <!-- âœ… å¯æ”¹ï¼šå­—é«”ä¾†æºï¼ˆGoogle Fontsï¼‰ -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Patrick+Hand&family=Sacramento&display=swap" rel="stylesheet">

  <style>
    /* ========================= å…¨ç«™å¯èª¿åƒæ•¸ï¼ˆé›†ä¸­ç®¡ç†ï¼‰ ========================= */
    :root{
      /* ğŸ¨ å…¨ç«™é…è‰²ï¼ˆä½ èªªè¦æ‹‰å‡ºä¾†å¯èª¿ï¼‰ */
      --site-bg: #c9daf8;            /* âœ… èƒŒæ™¯ï¼ˆè—ï¼‰ â†’ ä½ æŒ‡å®š */
      --site-bg-2: #dce7fb;          /* âœ… èƒŒæ™¯æ¼¸å±¤çš„æ¬¡è‰²ï¼ˆè—æ›´æ·ºï¼‰ */
      --paper: #fff2cc;              /* âœ… å…§å®¹å¡åº•è‰²ï¼ˆé»ƒï¼‰ â†’ ä½ æŒ‡å®š */
      --paper-2: #fff7de;            /* âœ… å…§å®¹å¡åº•è‰²æ¼¸å±¤æ¬¡è‰²ï¼ˆæ›´æ·¡é»ƒï¼‰ */
      --ink: #0f172a;                /* âœ… å…§æ–‡å­—è‰²ï¼ˆæ·±è—ï¼‰ */
      --muted: #6b5e52;              /* âœ… æ¬¡æ–‡å­—è‰² */
      --accent: #A68A7C;             /* âœ… é‡é»è‰²ï¼ˆå’Œäº’å‹•éŸ³ç¬¦ä¸€è‡´ç³»ï¼‰ */
      --rim: #E4E4E4;                /* âœ… è¼¸å…¥æ¡†é‚Šæ¡†é¡è‰² */
      --soft: #F5F1EC;               /* âœ… ç‹€æ…‹åˆ—/æç¤ºåº•è‰²ï¼ˆå°é½Šä½ çš„å¦ä¸€é ï¼‰ */

      /* ğŸ§° å¤–è§€å¾®èª¿ */
      --radius-xl: 16px;             /* âœ… å¤§åœ“è§’ */
      --radius-md: 12px;             /* âœ… ä¸­åœ“è§’ï¼ˆç‹€æ…‹åˆ—/å¡ç‰‡ï¼‰ */
      --shadow-1: 0 10px 26px rgba(0,0,0,.10);          /* âœ… å¡ç‰‡é™°å½± */
      --shadow-2: 0 2px 0 rgba(0,0,0,.15), 0 2px 8px rgba(0,0,0,.06); /* âœ… æŒ‰éˆ•é™°å½± */
      --shadow-3: 0 8px 24px rgba(0,0,0,.10), 0 2px 8px rgba(0,0,0,.06); /* âœ… æµ®å±¤é™°å½± */

      /* ğŸ”¤ å­—é«”ï¼ˆä½ æŒ‡å®šï¼‰ */
      --font-title: 'Sacramento', cursive; /* âœ… æ¨™é¡Œå­—å‹ */
      --font-body: 'Patrick Hand', 'Zen Maru Gothic', 'Noto Sans TC', system-ui, -apple-system, sans-serif; /* âœ… å…§æ–‡å­—å‹ */

      /* ğŸ”  å­—ç´šï¼ˆèˆ‡äº’å‹•éŸ³ç¬¦å°é½Šï¼‰*/
      --title-size: 2.8rem;          /* âœ… æ¨™é¡Œå¤§å°ï¼ˆå°é½Šäº’å‹•éŸ³ç¬¦ï¼‰ */
      --status-fz: 14px;             /* âœ… ç‹€æ…‹åˆ—å­—ç´šï¼ˆå°é½Šäº’å‹•éŸ³ç¬¦ï¼‰ */
      --btn-h: 38px;                 /* âœ… æŒ‰éˆ•é«˜åº¦ */
      --gap: 10px;                   /* âœ… å…ƒä»¶é–“è· */

      /* ğŸ“¦ æ¬„å¯¬å¯èª¿ */
      --w-couple: 220px;             /* âœ… æ–°äººåå­—å°å¡å¯¬ */
      --w-sign: 220px;               /* âœ… ç°½åå°å¡å¯¬ï¼ˆèˆ‡æ–°äººä¸€è‡´ï¼‰ */
      --w-toolbar-btn: 92px;         /* âœ… å·¥å…·åˆ—æŒ‰éˆ•å¯¬ï¼ˆç²—é«”/åº•ç·š/å¤§å­—/ç¸®å°ï¼‰ */
    }

    /* ====== åŸºç¤å­—é«”æ•ˆæœï¼ˆæ²¿ç”¨ä½ å¦ä¸€é é¢¨æ ¼ï¼‰ ====== */
    *{ box-sizing: border-box; -webkit-text-stroke: .35px rgba(0,0,0,.18); text-shadow: 0 1px 0 rgba(255,255,255,.65); }
    html,body{ margin:0; background: linear-gradient(180deg,var(--site-bg), var(--site-bg-2)); color:var(--ink); font-family: var(--font-body); font-weight:700; }

    /* å®¹å™¨ï¼ˆèˆ‡äº’å‹•éŸ³ç¬¦ä¸€è‡´è¦–è¦ºï¼‰ */
    .panel{ max-width:1060px; margin:22px auto; background: linear-gradient(180deg,var(--paper), var(--paper-2)); border:1px solid var(--rim); border-radius: var(--radius-xl); padding:18px; box-shadow: var(--shadow-1); backdrop-filter: blur(8px) saturate(115%); }

    /* æ¨™é¡Œï¼ˆä½ æŒ‡å®š Sacramento ç½®ä¸­ï¼‰ */
    h2{ margin:4px 0 16px; text-align:center; font-family: var(--font-title); font-size: var(--title-size); letter-spacing:1px; color: var(--ink); -webkit-text-stroke:.6px rgba(0,0,0,.12); text-shadow:0 3px 4px rgba(255,255,255,.75); }

    /* ====== ä¸Šæ–¹è³‡è¨Šåˆ—ï¼šæ–°äººå¡ + å·¥å…·åˆ— + ç‹€æ…‹åˆ—ï¼ˆå³ï¼‰ ====== */
    .topbar{ display:flex; gap: var(--gap); align-items:center; flex-wrap:wrap; }

    /* æ–°äººåå­—å°å¡ï¼ˆè²¼é½Šå…§æ–‡å·¦ä¸Šè§’æ„Ÿè¦ºï¼‰ */
    .chip{ background: linear-gradient(180deg,var(--paper), var(--paper-2)); /* âœ… åŒå…§æ–‡åº•è‰² */
           border: 0; /* âœ… ä½ è¦ã€Œæ–°äººåå­—ç„¡å¤–æ¡†ã€ */
           border-radius: 14px; padding:8px 12px; min-height: var(--btn-h); display:flex; align-items:center; gap:8px; width: var(--w-couple); }
    .chip .label{ opacity:.8; }
    .chip .value{ white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

    /* å·¥å…·åˆ—ï¼ˆæŒ‰éˆ•è¦–è¦ºæ¯”ç…§äº’å‹•éŸ³ç¬¦æŒ‰éˆ•ï¼‰ */
    .toolbar{ display:flex; gap: var(--gap); align-items:center; flex-wrap:wrap; }
    .toolbar button{ height: var(--btn-h); min-width: var(--w-toolbar-btn); padding: 8px 10px; border:1px solid var(--rim); border-radius: 10px; background:#fff; cursor:pointer; font-weight:700; box-shadow: var(--shadow-2); -webkit-text-stroke:.25px rgba(0,0,0,.12); text-shadow:0 1px 0 rgba(255,255,255,.5); }
    .toolbar button:active{ transform: translateY(1px) scale(.99); box-shadow: 0 1px 0 rgba(0,0,0,.18), 0 1px 4px rgba(0,0,0,.06); filter: brightness(.98); }

    /* ç‹€æ…‹åˆ—ï¼ˆå³å´ï¼Œèˆ‡äº’å‹•éŸ³ç¬¦åŒè¦–è¦ºï¼‰ */
    .status-wrap{ margin-left:auto; }
    #status{ background: var(--soft); border:1px solid var(--rim); border-radius: var(--radius-md); padding:10px 14px; min-width:240px; text-align:center; font-size: var(--status-fz); color:#A68A7C; box-shadow: var(--shadow-1); }
    #status.ok,#status.busy,#status.err{ color:#A68A7C; }

    /* ====== å…§å®¹å¡ï¼ˆæœ‰ã€Œæ©«ç·šã€å¯å¯«å­—ï¼Œç·šæ¢å¹³å‡ï¼‰ ====== */
    .paper{ position:relative; margin-top:12px; border-radius: var(--radius-xl); border:1px solid var(--rim); background: linear-gradient(180deg,var(--paper), var(--paper-2)); box-shadow: var(--shadow-1); }
    /* å…§æ–‡ç•™ç™½èˆ‡ç·šæ¢ï¼ˆç­‰è·ç­‰ç²—ï¼‰ */
    .editor{ min-height: 320px; padding: 18px 18px 90px; outline:none; line-height: 1.9; font-size: 18px; /* âœ… ä½ è¦å’Œäº’å‹•éŸ³ç¬¦â€œå…§æ–‡å¤§å°ä¸€è‡´æ„Ÿâ€ï¼šé€™è£¡ 18px*/
      background: repeating-linear-gradient(
        to bottom,
        transparent 0px,
        transparent 36px,
        rgba(0,0,0,.06) 36px,
        rgba(0,0,0,.06) 37px
      ); /* âœ… æ¯ 37px ä¸€æ¢ç´°ç·šï¼Œååˆ†å¹³å‡ */
    }

    /* ====== è§’è½å°å¡ï¼ˆæ–°äººåå·¦ä¸Šï¼ç°½åå³ä¸‹ï¼Œå¾®è²¼æ­£æ–‡ï¼‰ ====== */
    .corner{ position:absolute; display:flex; align-items:center; gap:8px; padding:8px 12px; min-height: var(--btn-h); border-radius: 14px; box-shadow: var(--shadow-1); }
    .corner .label{ opacity:.8; }

    .corner.couple{ left: 10px; top: -14px; background: linear-gradient(180deg,var(--paper), var(--paper-2)); border:0; } /* âœ… ç„¡å¤–æ¡† */
    .corner.sign{ right: 10px; bottom: -14px; background: linear-gradient(180deg,var(--paper), var(--paper-2)); border:1px solid rgba(0,0,0,.08); } /* âœ… æ·¡æ·¡å¤–æ¡† */

    .corner .val{ max-width: 180px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .sign-thumb{ width: 120px; height: 44px; border-radius: 8px; background:#fff; border:1px dashed rgba(0,0,0,.18); display:flex; align-items:center; justify-content:center; cursor:pointer; }
    .sign-thumb img{ max-width:100%; max-height:100%; display:block; }

    /* ====== é€å‡ºå€ï¼ˆæŒ‰éˆ•æ¯”ç…§äº’å‹•éŸ³ç¬¦ï¼‰ ====== */
    .actions{ display:flex; gap: var(--gap); justify-content:flex-end; padding: 14px 4px 0; }
    .primary{ height: var(--btn-h); min-width: 140px; border:1px solid var(--rim); border-radius: 10px; background:#fff; cursor:pointer; font-weight:700; box-shadow: var(--shadow-2); -webkit-text-stroke:.25px rgba(0,0,0,.12); text-shadow:0 1px 0 rgba(255,255,255,.5); }
    .primary:active{ transform: translateY(1px) scale(.99); box-shadow: 0 1px 0 rgba(0,0,0,.18), 0 1px 4px rgba(0,0,0,.06); filter: brightness(.98); }

    /* ====== ç°½åå½ˆçª—ï¼ˆModal + Canvas æ”¾å¤§ç°½ï¼‰ ====== */
    .overlay{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; background: rgba(17,24,39,.35); backdrop-filter: blur(3px); z-index:9999; }
    .overlay.show{ display:flex; }
    .dialog{ width:min(92vw, 720px); background: var(--soft); border:1px solid var(--rim); border-radius: 14px; padding: 16px; box-shadow: var(--shadow-3); }
    .dialog h3{ margin:0 0 10px; font-size: 18px; color: var(--muted); font-weight:700; }
    .dialog .canvas-wrap{ background:#fff; border:1px solid #ddd; border-radius: 12px; height: 340px; display:flex; align-items:center; justify-content:center; }
    canvas{ width:100%; height:100%; border-radius: 12px; touch-action: none; }
    .dialog .footer{ display:flex; gap: var(--gap); justify-content:flex-end; margin-top: 10px; }
    .btn{ height: var(--btn-h); min-width: 120px; border:1px solid var(--rim); border-radius: 10px; background:#fff; cursor:pointer; font-weight:700; box-shadow: var(--shadow-2); }
    .btn:active{ transform: translateY(1px) scale(.99); }

    /* æ‰‹æ©Ÿç›´å‘ï¼šè®“è§’è½å¡ç‰‡æ›´è²¼è¿‘ */
    @media (orientation:portrait){
      .corner.couple{ left: 8px; top: -12px; }
      .corner.sign{ right: 8px; bottom: -12px; }
    }
  </style>

  <body>
    <div class="panel">
      <h2>ç¥ç¦ç‰†</h2> <!-- âœ… æ¨™é¡Œï¼šSacramento ç²—é«”ç½®ä¸­ï¼ˆå­—å‹åœ¨ :root è¨­å®šï¼‰ -->

      <div class="topbar">
        <!-- âœ… æ–°äººåç‰‡ï¼ˆå·¦ï¼‰-->
        <div class="chip" title="æ–°äºº">
          <span class="label">æ–°äººï¼š</span>
          <span class="value" id="coupleName">ï¼ˆè®€å–ä¸­â€¦ï¼‰</span>
        </div>

        <!-- âœ… å·¥å…·åˆ—ï¼ˆä¸­ï¼‰-->
        <div class="toolbar" aria-label="æ–‡å­—å·¥å…·">
          <button type="button" id="btnBold">ç²—é«”</button>      <!-- âœ… åˆ‡æ›ç²—é«” -->
          <button type="button" id="btnUnderline">åº•ç·š</button>  <!-- âœ… åˆ‡æ›åº•ç·š -->
          <button type="button" id="btnBig1">å¤§å­—Ã—1</button>     <!-- âœ… æ”¾å¤§ä¸€æ®µï¼ˆè‡³å°‘ä¸‰æ®µï¼‰ -->
          <button type="button" id="btnBig2">å¤§å­—Ã—2</button>     <!-- âœ… æ”¾å¤§å…©æ®µ -->
          <button type="button" id="btnBig3">å¤§å­—Ã—3</button>     <!-- âœ… æ”¾å¤§ä¸‰æ®µ -->
          <button type="button" id="btnSmall1">ç¸®å°Ã—1</button>   <!-- âœ… ç¸®å°ä¸€æ®µï¼ˆè‡³å°‘ä¸‰æ®µï¼‰ -->
          <button type="button" id="btnSmall2">ç¸®å°Ã—2</button>   <!-- âœ… ç¸®å°å…©æ®µ -->
          <button type="button" id="btnSmall3">ç¸®å°Ã—3</button>   <!-- âœ… ç¸®å°ä¸‰æ®µ -->
        </div>

        <!-- âœ… ç‹€æ…‹åˆ—ï¼ˆå³ï¼‰-->
        <div class="status-wrap"><p id="status">å°šæœªåˆå§‹åŒ–</p></div>
      </div>

      <!-- âœ… å…§å®¹å¡ï¼ˆå¸¶æ©«ç·šï¼‰ï¼Œè§’è½å°å¡æœƒã€Œè²¼ã€æ­£æ–‡å·¦ä¸Š/å³ä¸‹ -->
      <div class="paper">
        <div class="corner couple">
          <span class="label">æ–°â¼ˆ </span>
          <span class="val" id="cornerCouple">â€”</span>
        </div>
        <div class="corner sign">
          <span class="label">ç°½åï¼š</span>
          <div class="sign-thumb" id="signThumb" title="é»æˆ‘æ”¾å¤§ç°½å">
            <span>é»æˆ‘ç°½å</span>
          </div>
        </div>
        <div id="editor" class="editor" contenteditable="true" aria-label="ç¥ç¦å…§å®¹ï¼ˆå¯ç›´æ¥è¼¸å…¥ï¼‰"></div>
      </div>

      <div class="actions">
        <button class="primary" id="btnSubmit">é€å‡ºç¥ç¦</button> <!-- âœ… é€å‡ºæŒ‰éˆ•è¦æœ‰â€œæŒ‰éˆ•æ„Ÿâ€ -->
      </div>
    </div>

    <!-- âœ… ç°½åå½ˆçª—ï¼ˆæ”¾å¤§ç•«å¸ƒï¼‰ -->
    <div id="signModal" class="overlay" role="dialog" aria-modal="true" aria-labelledby="signTitle">
      <div class="dialog">
        <h3 id="signTitle">ç°½å</h3>
        <div class="canvas-wrap">
          <canvas id="pad"></canvas>
        </div>
        <div class="footer">
          <button class="btn" id="btnClear">æ¸…é™¤</button>
          <button class="btn" id="btnCancel">å–æ¶ˆ</button>
          <button class="btn" id="btnSave">å®Œæˆ</button>
        </div>
      </div>
    </div>

    <!-- ====================== å‰ç«¯è¨­å®šï¼ˆä½ è¦å¡«ï¼‰ ====================== -->
    <script>
      /* âœ… å¯æ›´æ”¹ï¼šä½ çš„ LIFF ID èˆ‡ GAS ç¶²å€ */
      const LIFF_ID = 'https://meiyang0819.github.io/SSS/blessing.html';                 // â† LIFF å¾Œå°çš„ IDï¼ˆè¦æ›æˆçœŸçš„ï¼‰
      const WEBHOOK = 'https://script.google.com/macros/s/XXX/exec'; // â† GAS éƒ¨ç½²ç¶²å€ï¼ˆè¦æ›æˆçœŸçš„ï¼‰

      /* âœ… å­—ç´šéšæ¢¯ï¼ˆå¤§å­—/ç¸®å°æœƒç”¨åˆ°ï¼Œå¯æŒ‰éœ€æ±‚èª¿æ•´ï¼‰ */
      const FONT_STEPS = [16, 18, 20, 22, 24]; // â† editor å…§æ–‡å­—ç´šéšæ¢¯ï¼ˆé è¨­ index=1 â†’ 18pxï¼‰

      /* ===== å¿«å–ç¯€é» ===== */
      const $ = s => document.querySelector(s);
      const statusEl = $('#status');
      const editor   = $('#editor');
      const coupleA  = $('#coupleName');
      const coupleB  = $('#cornerCouple');

      /* ===== ç‹€æ…‹åˆ—ï¼ˆæ²¿ç”¨ä½ å¦ä¸€é èªæ„ï¼‰ ===== */
      function setStatus(m){
        statusEl.textContent = m; statusEl.classList.remove('ok','busy','err');
        if(/æˆåŠŸ|å·²å°±ç·’|è¼‰å…¥/.test(m)) statusEl.classList.add('ok');
        else if(/è™•ç†|é€å‡º|ç­‰å¾…/.test(m)) statusEl.classList.add('busy');
        else if(/å¤±æ•—|é€¾æ™‚|éŒ¯èª¤|ç„¡æ³•/.test(m)) statusEl.classList.add('err');
      }

      /* ===== æ–‡å­—å·¥å…·ï¼šç²—é«”/åº•ç·š/å­—ç´šéšæ¢¯ ===== */
      function toggleCmd(cmd){ document.execCommand(cmd, false, null); editor.focus(); }
      function setFontByStep(stepIdx){ const px = FONT_STEPS[Math.max(0, Math.min(FONT_STEPS.length-1, stepIdx))]; document.execCommand('fontSize', false, 7); // å…ˆè¨­æœ€å¤§
        // æŠŠæœ€å¤§ size span æ›æˆå¯¦éš› px
        editor.querySelectorAll('font[size="7"]').forEach(n=>{ n.removeAttribute('size'); n.style.fontSize = px + 'px'; }); editor.focus(); }

      // ç›®å‰å­—ç´šç´¢å¼•ï¼ˆ1=18pxï¼‰
      let curStep = 1;
      $('#btnBold').addEventListener('click', ()=>toggleCmd('bold'));         // âœ… ç²—é«”
      $('#btnUnderline').addEventListener('click', ()=>toggleCmd('underline'));// âœ… åº•ç·š
      $('#btnBig1').addEventListener('click', ()=>{ curStep=Math.min(curStep+1, FONT_STEPS.length-1); setFontByStep(curStep); });
      $('#btnBig2').addEventListener('click', ()=>{ curStep=Math.min(curStep+2, FONT_STEPS.length-1); setFontByStep(curStep); });
      $('#btnBig3').addEventListener('click', ()=>{ curStep=Math.min(curStep+3, FONT_STEPS.length-1); setFontByStep(curStep); });
      $('#btnSmall1').addEventListener('click', ()=>{ curStep=Math.max(curStep-1, 0); setFontByStep(curStep); });
      $('#btnSmall2').addEventListener('click', ()=>{ curStep=Math.max(curStep-2, 0); setFontByStep(curStep); });
      $('#btnSmall3').addEventListener('click', ()=>{ curStep=Math.max(curStep-3, 0); setFontByStep(curStep); });

      /* ===== ç°½åæ¿ï¼ˆæ”¾å¤§ç°½åï¼Œç¸®åœ–å›è²¼å³ä¸‹è§’ï¼‰ ===== */
      const signModal = $('#signModal');
      const signThumb = $('#signThumb');
      const pad = $('#pad');
      const ctx = pad.getContext('2d');
      let drawing=false, last=null, signDataUrl='';

      function openSign(){ signModal.classList.add('show'); resizePad(); }
      function closeSign(){ signModal.classList.remove('show'); }
      function resizePad(){ const wrap = pad.parentElement.getBoundingClientRect(); pad.width = Math.floor(wrap.width*2); pad.height = Math.floor(wrap.height*2); ctx.scale(2,2); ctx.lineWidth = 2.4; ctx.lineCap='round'; ctx.strokeStyle='#222'; } // âœ… å¯èª¿ï¼šç·šç²—

      function pt(ev){ const r=pad.getBoundingClientRect(); const x=(ev.touches?ev.touches[0].clientX:ev.clientX)-r.left; const y=(ev.touches?ev.touches[0].clientY:ev.clientY)-r.top; return {x,y}; }
      function down(ev){ drawing=true; last=pt(ev); ev.preventDefault(); }
      function move(ev){ if(!drawing) return; const p=pt(ev); ctx.beginPath(); ctx.moveTo(last.x,last.y); ctx.lineTo(p.x,p.y); ctx.stroke(); last=p; ev.preventDefault(); }
      function up(){ drawing=false; last=null; }

      pad.addEventListener('mousedown', down); pad.addEventListener('mousemove', move); window.addEventListener('mouseup', up);
      pad.addEventListener('touchstart', down, {passive:false}); pad.addEventListener('touchmove', move, {passive:false}); pad.addEventListener('touchend', up);
      window.addEventListener('resize', ()=>{ if(signModal.classList.contains('show')) resizePad(); });

      $('#btnClear').addEventListener('click', ()=>{ ctx.clearRect(0,0,pad.width,pad.height); });
      $('#btnCancel').addEventListener('click', closeSign);
      $('#btnSave').addEventListener('click', ()=>{ signDataUrl = pad.toDataURL('image/png'); signThumb.innerHTML = `<img alt="ç°½å" src="${signDataUrl}">`; closeSign(); });
      signThumb.addEventListener('click', openSign); // âœ… é»ç¸®åœ–æ”¾å¤§ç°½

      /* ===== LIFF + å¾Œç«¯ï¼šæŠ“ lineId â†’ å–å¾—æ–°äººåèˆ‡è§’è‰² ===== */
      let lineId='';
      async function initLiff(){
        try{
          if(!window.liff){ setStatus('æœªè¼‰å…¥ LIFF SDK'); return; }
          await liff.init({ liffId: LIFF_ID, withLoginOnExternalBrowser: true });
          if(!liff.isLoggedIn()){ liff.login({ scope: ['openid','profile'] }); return; }
          const idt = liff.getDecodedIDToken(); lineId = (idt && idt.sub) || '';
          await liff.ready; setStatus('LIFF å·²å°±ç·’');
        }catch(e){ setStatus('LIFF åˆå§‹åŒ–å¤±æ•—ï¼š'+e.message); }
      }

      // âœ… å¾Œç«¯è«‹å¯¦ä½œ action=blessInit&lineId=xxx å›å‚³ {ok:true, coupleName:"å°æ˜ & å°ç¾", role:"MALE_FRIEND"}
      async function fetchCouple(){
        try{
          const r = await fetch(WEBHOOK + '?action=blessInit&lineId=' + encodeURIComponent(lineId), { cache:'no-store' });
          if(r.ok){ const j=await r.json(); if(j && j.ok){ coupleA.textContent=j.coupleName||'â€”'; coupleB.textContent=j.coupleName||'â€”'; setStatus('å·²è¼‰å…¥ âœ…'); return; } }
        }catch(_){ }
        coupleA.textContent='ï¼ˆæ–°äººï¼‰'; coupleB.textContent='ï¼ˆæ–°äººï¼‰'; setStatus('å·²è¼‰å…¥ âœ…'); // âœ… å¾Œå‚™
      }

      /* ===== é€å‡ºç¥ç¦ ===== */
      $('#btnSubmit').addEventListener('click', async ()=>{
        const text = editor.innerHTML.trim(); // âœ… ä¿ç•™ç²—é«”/åº•ç·šèˆ‡å­—ç´š
        if(!text){ alert('è«‹å¯«äº›ç¥ç¦å†é€å‡º'); return; }
        setStatus('â³ é€å‡ºä¸­â€¦è«‹ç¨å¾Œ');
        try{
          const payload = { action:'createBlessing', lineId, html:text, sign:signDataUrl };
          const r = await fetch(WEBHOOK, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
          const j = await r.json().catch(()=>null);
          if(j && j.ok){ setStatus('âœ… é€å‡ºæˆåŠŸï¼Œå¯é€€å®‰å›‰'); }
          else{ setStatus('âŒ é€å‡ºå¤±æ•—'); }
        }catch(e){ setStatus('âŒ ç„¡æ³•é€å‡º'+e.message); }
      });

      /* ===== å•Ÿå‹•æµç¨‹ ===== */
      window.addEventListener('DOMContentLoaded', async ()=>{
        setStatus('åˆå§‹åŒ–ä¸­â€¦');
        editor.focus(); // âœ… é€²é é¢å³å¯è¼¸å…¥
        // è‹¥æ­¤é åµŒå…¥ LIFFï¼Œå»ºè­°å¼•ç”¨ LIFF SDKï¼š<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
        if(window.liff){ await initLiff(); }
        await fetchCouple();
      });
    </script>

    <!-- âœ… è‹¥æ­¤é æœƒåœ¨ LIFF å…§æ‰“é–‹ï¼Œè¨˜å¾—åŠ ä¸Š LIFF SDKï¼ˆå¯ç§»å‹•åˆ°ä¸Šæ–¹ headï¼‰ -->
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  </body>
</html>
