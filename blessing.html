<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>💞同心祈願</title>
<div class="panel">
  <h2>❤️同心祈願❤️</h2>
  <div class="bar">
    <div class="bar-inner">
      <div class="rolebar">
        <button type="button" class="role-btn active" id="roleAll">全部</button>
        <button type="button" class="role-btn" id="roleMale">男方</button>
        <button type="button" class="role-btn" id="roleFemale">女方</button>
      </div>

      <p id="status">✅ 可送上祝福囉，送出後請稍後唷，成功會通知呢</p>

      <div class="toolbar" role="toolbar" aria-label="文字工具">
        <button class="tool-btn" id="btnBold"      type="button">粗體</button>
        <button class="tool-btn" id="btnItalic"    type="button">斜體</button>
        <button class="tool-btn" id="btnUnderline" type="button">底線</button>

        <select id="colorPick" class="tool-select" title="字體顏色">
          <option value="" selected>顏色</option>
          <option value="#a21caf">小紫</option>
          <option value="#dc2626">小紅</option>
          <option value="#2563eb">小藍</option>
          <option value="#059669">小綠</option>
          <option value="#d97706">小橘</option>
          <option value="#6b7280">小灰</option>
        </select>

        <button class="tool-btn" id="btnBigger"    type="button">放大</button>
        <button class="tool-btn" id="btnSmaller"   type="button">縮小</button>
      </div>
    </div>
  </div>

  <div class="stage">
    <div class="card" id="card">
      <section class="left-wrap">
        <div class="left-content">
          <div class="chip" id="chipBride" title="Dear "><span id="brideLabel">Dear —</span></div>

          <div class="editor" id="editor" contenteditable="true" aria-label="祈願內容" data-empty>
            寫下並獻上最誠摯的祝福…💝
          </div>

          <!-- 三顆按鈕：再次修改 → 送出祝福 → 畫押簽名 -->
          <div class="left-actions">
            <button id="btnEdit"  type="button">再次修改</button>
            <button id="btnSend"  type="button">送出祝福</button>
            <div class="chip" id="chipSign" title="點此簽名">
              <span class="hint">畫押簽名</span>
              <img id="signThumb" alt="signature preview" />
            </div>
          </div>
        </div>
      </section>

      <section class="wall-wrap">
        <div class="wall" id="wall"></div>
      </section>
    </div>
  </div>
</div>

<!-- 版權（恢復） -->
<div class="footer-copyright" id="copyright">© Copyright 2025 MY‘s System</div>

<!-- 檢視窗 -->
<div id="viewOverlay" class="overlay" role="dialog" aria-modal="true" aria-labelledby="viewTitle">
  <div class="dialog">
    <h3 id="viewTitle">祝福內容</h3>
    <div class="view-meta" id="viewMeta"></div>
    <div id="viewContent" class="view-content"></div>
    <div class="view-actions"><button id="viewClose" type="button">關閉</button></div>
  </div>
</div>

<!-- 簽名 Modal -->
<div id="sigOverlay" class="overlay" role="dialog" aria-modal="true" aria-labelledby="sigTitle">
  <div class="dialog">
    <h3 id="sigTitle">請於下方畫押唷😈</h3>
    <canvas id="pad"></canvas>
    <div class="dlg-actions">
      <button id="sigClear"  type="button">清除</button>
      <button id="sigCancel" type="button">取消</button>
      <button id="sigOK"     type="button">確定</button>
    </div>
  </div>
</div>

<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script>
  const LIFF_ID='2008149060-m5pDXW6a';
  const WEBHOOK='https://script.google.com/macros/s/AKfycbw1MOPYMbFzxed__pkBCHBM0OcmBlrBshXOKri0Yai6CVKv-EG-AyyunLKD896UOAAo/exec';

  const editor=document.getElementById('editor'); const wallEl=document.getElementById('wall');
  function setStatus(m){ document.getElementById('status').textContent=m; }

  let lineId='',displayName='',pictureUrl='',myLastRow=null,signatureDataURL='',sendInFlight=false,submittedOnce=false;

  function parseSheetTimeToDate(s){
    if(!s) return new Date();
    const m=/^(\d{4})-(\d{2})-(\d{2})[ T](\d{2}):(\d{2}):(\d{2})/.exec(String(s));
    if(m){ return new Date(+m[1],+m[2]-1,+m[3],+m[4],+m[5],+m[6]); }
    const d=new Date(s); return isNaN(d.getTime())?new Date():d;
  }
  function pad2(n){return String(n).padStart(2,'0');}
  function fmtTaipei(s){ const d=parseSheetTimeToDate(s); return d.getFullYear()+'-'+pad2(d.getMonth()+1)+'-'+pad2(d.getDate())+' '+pad2(d.getHours())+':'+pad2(d.getMinutes())+':'+pad2(d.getSeconds()); }

  async function initLIFF(){
    try{
      await liff.init({ liffId: LIFF_ID, withLoginOnExternalBrowser:true });
      if(!liff.isLoggedIn()){ liff.login(); return; }
      await liff.ready;
      const prof=await liff.getProfile(); const idt=liff.getDecodedIDToken();
      lineId=prof.userId||idt.sub||''; displayName=prof.displayName||idt.name||''; pictureUrl=prof.pictureUrl||'';
    }catch(_){}
    await fetchRoleAndNames(); await preloadMyLatest(); await refreshWall();
  }
  async function initialLoad(){ await fetchRoleAndNames(); await refreshWall(); }

  /* ===(1) 新人欄加上 "Dear " + 半形空格 === */
  async function fetchRoleAndNames(){
    try{
      const j=await (await fetch(WEBHOOK+`?action=userRole&lineId=${encodeURIComponent(lineId||'')}`)).json();
      if(j?.ok){
        const name = j.nameLabel || '—';
        document.getElementById('brideLabel').textContent = 'Dear ' + name; // ← 這行是新增點
      }
    }catch(_){}
  }

  /* 轉換 Google Drive 分享連結為可嵌入的直連（縮圖不破） */
  function toDriveDirectUrl(u){
    if(!u) return u;
    try{
      const s=String(u);
      const m1 = s.match(/drive\.google\.com\/file\/d\/([^/]+)/);
      const m2 = s.match(/[?&]id=([^&]+)/);
      const id = m1 ? m1[1] : (m2 ? m2[1] : null);
      return id ? `https://drive.google.com/uc?export=view&id=${id}` : u;
    }catch(_){ return u; }
  }

  /* ===(2) 簽名縮圖顯示修正：只在載入成功後才顯示，並處理 Drive 連結 === */
  async function preloadMyLatest(){
    if(!lineId) return;
    try{
      const j=await (await fetch(WEBHOOK+`?action=getLatestByLineId&lineId=${encodeURIComponent(lineId)}`)).json();
      if(j?.ok && j.item){
        const it=j.item;
        if(it.contentHTML){ editor.innerHTML=it.contentHTML; editor.removeAttribute('data-empty'); lockEditor(); }

        if(it.signature){
          const chip=document.getElementById('chipSign');
          const img=document.getElementById('signThumb');

          let src = String(it.signature||'').trim();
          if(src){
            src = src.startsWith('data:') ? src : toDriveDirectUrl(src);

            // 先清掉狀態，等載入成功再顯示
            chip.classList.remove('has-img','locked');
            img.removeAttribute('src');
            img.removeAttribute('alt');
            img.loading = 'eager';
            img.referrerPolicy = 'no-referrer';

            img.onload = ()=>{ chip.classList.add('has-img'); chip.classList.add('locked'); };
            img.onerror = ()=>{
              const direct = toDriveDirectUrl(src);
              if(img.src !== direct){ img.src = direct; }
              else { chip.classList.remove('has-img','locked'); img.removeAttribute('src'); }
              img.onerror = null;
            };

            if(/^data:/.test(src) || /^https?:\/\//.test(src)){ img.src = src; }
          }
        }

        myLastRow = Number(it.row||0) || null;
      }
    }catch(_){}
  }

  function exec(cmd){ if(editor.hasAttribute('data-empty')||editor.classList.contains('locked')) return; document.execCommand(cmd,false,null); editor.focus(); }
  document.getElementById('btnBold').onclick=()=>exec('bold');
  document.getElementById('btnItalic').onclick=()=>exec('italic');
  document.getElementById('btnUnderline').onclick=()=>exec('underline');
  document.getElementById('colorPick').onchange=e=>{ const v=e.target.value; if(v&&!editor.classList.contains('locked')&&!editor.hasAttribute('data-empty')) document.execCommand('foreColor',false,v); e.target.blur(); };
  let globalScale=1; function setScale(s){globalScale=Math.max(.7,Math.min(1.7,s)); editor.style.setProperty('--editor-zoom',globalScale+'rem');}
  document.getElementById('btnBigger').onclick=()=>setScale(globalScale+.06);
  document.getElementById('btnSmaller').onclick=()=>setScale(globalScale-.06);
  const PLACEHOLDER='寫下並獻上最誠摯的祝福…💝';
  editor.addEventListener('focus',()=>{ if(editor.hasAttribute('data-empty')){ editor.textContent=''; editor.removeAttribute('data-empty'); }});
  editor.addEventListener('blur',()=>{ if(!editor.textContent.trim()){ editor.setAttribute('data-empty',''); editor.textContent=PLACEHOLDER; }});

  /* 簽名（保留你的流程；新增 onload 後才顯示縮圖） */
  const sigOverlay=document.getElementById('sigOverlay'); const pad=document.getElementById('pad'); const ctx=pad.getContext('2d');
  let drawing=false,lastX=0,lastY=0;
  function fitCanvas(){ const dpr=Math.max(1,devicePixelRatio||1),w=pad.clientWidth,h=pad.clientHeight; pad.width=w*dpr; pad.height=h*dpr;
    ctx.setTransform(dpr,0,0,dpr,0,0); ctx.lineCap='round'; ctx.lineJoin='round'; ctx.lineWidth=3; ctx.strokeStyle='#111'; ctx.clearRect(0,0,w,h); }
  function pos(e){ const r=pad.getBoundingClientRect(); const c=e.touches?e.touches[0]:e; return {x:c.clientX-r.left,y:c.clientY-r.top}; }
  function start(e){ drawing=true; const p=pos(e); lastX=p.x; lastY=p.y; e.preventDefault(); }
  function move(e){ if(!drawing)return; const p=pos(e); ctx.beginPath(); ctx.moveTo(lastX,lastY); ctx.lineTo(p.x,p.y); ctx.stroke(); lastX=p.x; lastY=p.y; e.preventDefault(); }
  function end(){ drawing=false; }
  document.getElementById('chipSign').addEventListener('click',()=>{ const chip=document.getElementById('chipSign'); if(chip.classList.contains('locked')) return;
    sigOverlay.classList.add('show'); setTimeout(fitCanvas,40); });
  pad.addEventListener('mousedown',start); pad.addEventListener('mousemove',move); pad.addEventListener('mouseup',end); pad.addEventListener('mouseleave',end);
  pad.addEventListener('touchstart',start,{passive:false}); pad.addEventListener('touchmove',move,{passive:false}); pad.addEventListener('touchend',end);
  document.getElementById('sigClear').onclick=fitCanvas;
  document.getElementById('sigCancel').onclick=()=>sigOverlay.classList.remove('show');
  document.getElementById('sigOK').onclick=()=>{
    requestAnimationFrame(()=>{
      signatureDataURL=pad.toDataURL('image/png');
      const chip=document.getElementById('chipSign'); const img=document.getElementById('signThumb');
      chip.classList.remove('has-img','locked');
      img.onload = ()=>{ chip.classList.add('has-img'); chip.classList.add('locked'); img.onload=null; };
      img.removeAttribute('alt');
      img.loading = 'eager';
      img.src=signatureDataURL;
      sigOverlay.classList.remove('show');
    });
  };

  /* 牆 */
  function escapeHTML(s){return String(s||'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));}
  function tileTemplate(it){return `<div class="tile" data-row="${it.row||''}" data-owner="${it.lineId||''}">
    <div class="rope"></div><div class="knot"></div>
    <div class="tile-name">${escapeHTML(it.displayName||'—')}</div>
    <div class="tile-sep"></div>
    <div class="tile-date">${escapeHTML(fmtTaipei(it.time))}</div>
    <div class="tile-sep"></div>
    <div class="tile-snippet">${escapeHTML((it.preview||'').trim()||'—')}</div>
  </div>`;}
  async function refreshWall(){
    try{
      const role=document.querySelector('.role-btn.active')?.id?.replace('role','').toLowerCase()||'all';
      const j=await (await fetch(WEBHOOK+`?action=listblessings&role=${role}`)).json();
      if(j?.ok){ const arr=(j.items||[]).slice().sort((a,b)=>parseSheetTimeToDate(b.time)-parseSheetTimeToDate(a.time)); wallEl.innerHTML=arr.map(tileTemplate).join(''); bindTileClicks(); }
    }catch(_){}
  }
  function bindTileClicks(){ document.querySelectorAll('.tile').forEach(t=>t.addEventListener('click',()=>openView(t))); }
  async function openView(el){
    const row=el.getAttribute('data-row');
    const j=await (await fetch(WEBHOOK+`?action=getBlessingDetail&id=${encodeURIComponent(row)}`)).json();
    if(j?.ok&&j.item){
      document.getElementById('viewMeta').textContent=`${j.item.displayName||'—'} ｜ ${fmtTaipei(j.item.time)}`;
      document.getElementById('viewContent').innerHTML=j.item.contentHTML||'';
      document.getElementById('viewOverlay').classList.add('show');
    }
  }
  document.getElementById('viewClose').onclick=()=>document.getElementById('viewOverlay').classList.remove('show');
  document.getElementById('roleAll').onclick=()=>{document.querySelectorAll('.role-btn').forEach(b=>b.classList.remove('active'));document.getElementById('roleAll').classList.add('active');refreshWall();};
  document.getElementById('roleMale').onclick=()=>{document.querySelectorAll('.role-btn').forEach(b=>b.classList.remove('active'));document.getElementById('roleMale').classList.add('active');refreshWall();};
  document.getElementById('roleFemale').onclick=()=>{document.querySelectorAll('.role-btn').forEach(b=>b.classList.remove('active'));document.getElementById('roleFemale').classList.add('active');refreshWall();};

  /* 編輯/送出互鎖（保留） */
  function lockEditor(){editor.classList.add('locked');editor.setAttribute('contenteditable','false');}
  function unlockEditor(){editor.classList.remove('locked');editor.setAttribute('contenteditable','true');editor.focus();}
  document.getElementById('btnEdit').onclick=()=>{ unlockEditor(); submittedOnce=false; const btn=document.getElementById('btnSend'); btn.disabled=false; btn.style.opacity=1; btn.style.pointerEvents='auto'; };
  function hasSignature(){return document.getElementById('chipSign').classList.contains('has-img');}

  async function sendOrUpdate(){
    if(editor.hasAttribute('data-empty')||!editor.textContent.trim()){ alert('欸，不可能不祝福我們吧🖕️'); return; }
    if(!hasSignature()){ alert('欸，沒有畫押不准離開✍️'); return; }
    if(sendInFlight||submittedOnce){ return; }
    sendInFlight=true;
    const btnSend=document.getElementById('btnSend'); const btnEdit=document.getElementById('btnEdit');
    btnSend.disabled=true; btnSend.style.opacity=.6; btnSend.style.pointerEvents='none';
    btnEdit.disabled=true; btnEdit.style.opacity=.6; btnEdit.style.pointerEvents='none';

    const content=editor.innerHTML.trim();
    const payload = myLastRow
      ? {action:'updateBlessing',row:Number(myLastRow),lineId,contentHTML:content}
      : {action:'createBlessing',lineId,displayName,pictureUrl,contentHTML:content,signaturePNG:signatureDataURL||'',extra:{}};
    try{
      const r=await fetch(WEBHOOK,{method:'POST',headers:{'Content-Type':'text/plain;charset=UTF-8'},body:JSON.stringify(payload)});
      const j=await r.json().catch(()=>null);
      if(j?.ok){
        submittedOnce=true; lockEditor(); await refreshWall(); if(!myLastRow) await preloadMyLatest();
        setStatus(myLastRow?'✅ 已更新並鎖定，截止日前都可以修改唷':'✅ 已送出並鎖定，截止日前都可以修改唷');
        btnEdit.disabled=false; btnEdit.style.opacity=1; btnEdit.style.pointerEvents='auto';
      }else if(j?.error==='deadline_passed'){
        setStatus('⛔ 已到截止日，無法送出及編輯'); lockEditor();
      }else{
        setStatus('❌ 送出失敗，稍後再試');
        sendInFlight=false;
        btnSend.disabled=false; btnSend.style.opacity=1; btnSend.style.pointerEvents='auto';
        btnEdit.disabled=false; btnEdit.style.opacity=1; btnEdit.style.pointerEvents='auto';
      }
    }catch(_){
      setStatus('❌ 送出失敗，稍後再試');
      sendInFlight=false;
      btnSend.disabled=false; btnSend.style.opacity=1; btnSend.style.pointerEvents='auto';
      btnEdit.disabled=false; btnEdit.style.opacity=1; btnEdit.style.pointerEvents='auto';
    }
  }
  document.getElementById('btnSend').onclick=sendOrUpdate;

  window.addEventListener('DOMContentLoaded',()=>{
    if(!editor.textContent.trim()){ editor.setAttribute('data-empty',''); editor.textContent='寫下並獻上最誠摯的祝福…💝'; }
    if(window.liff) initLIFF(); else initialLoad();
  });
</script>
    </head> <body> <img class="bg-notes" src="./assets/favors.png?v=4" alt="" />
      <div class="panel">
  <h2>❤️同心祈願❤️</h2>

  <div class="bar">
    <div class="bar-inner">
      <div class="rolebar">
        <button type="button" class="role-btn active" id="roleAll">全部</button>
        <button type="button" class="role-btn" id="roleMale">男方</button>
        <button type="button" class="role-btn" id="roleFemale">女方</button>
      </div>

      <p id="status">✅ 可送上祝福囉，送出後請稍後唷，成功會通知呢</p>

      <div class="toolbar" role="toolbar" aria-label="文字工具">
        <button class="tool-btn" id="btnBold"      type="button">粗體</button>
        <button class="tool-btn" id="btnItalic"    type="button">斜體</button>
        <button class="tool-btn" id="btnUnderline" type="button">底線</button>

        <select id="colorPick" class="tool-select" title="字體顏色">
          <option value="" selected>顏色</option>
          <option value="#a21caf">小紫</option>
          <option value="#dc2626">小紅</option>
          <option value="#2563eb">小藍</option>
          <option value="#059669">小綠</option>
          <option value="#d97706">小橘</option>
          <option value="#6b7280">小灰</option>
        </select>

        <button class="tool-btn" id="btnBigger"    type="button">放大</button>
        <button class="tool-btn" id="btnSmaller"   type="button">縮小</button>
      </div>
    </div>
  </div>

  <div class="stage">
    <div class="card" id="card">
      <section class="left-wrap">
        <div class="left-content">
          <div class="chip" id="chipBride" title="Dear "><span id="brideLabel">Dear —</span></div>

          <div class="editor" id="editor" contenteditable="true" aria-label="祈願內容" data-empty>
            寫下並獻上最誠摯的祝福…💝
          </div>

          <!-- 三顆按鈕：再次修改 → 送出祝福 → 畫押簽名 -->
          <div class="left-actions">
            <button id="btnEdit"  type="button">再次修改</button>
            <button id="btnSend"  type="button">送出祝福</button>
            <div class="chip" id="chipSign" title="點此簽名">
              <span class="hint">畫押簽名</span>
              <img id="signThumb" alt="signature preview" />
            </div>
          </div>
        </div>
      </section>

      <section class="wall-wrap">
        <div class="wall" id="wall"></div>
      </section>
    </div>
  </div>
</div>

<!-- 版權（恢復） -->
<div class="footer-copyright" id="copyright">© Copyright 2025 MY‘s System</div>

<!-- 檢視窗 -->
<div id="viewOverlay" class="overlay" role="dialog" aria-modal="true" aria-labelledby="viewTitle">
  <div class="dialog">
    <h3 id="viewTitle">祝福內容</h3>
    <div class="view-meta" id="viewMeta"></div>
    <div id="viewContent" class="view-content"></div>
    <div class="view-actions"><button id="viewClose" type="button">關閉</button></div>
  </div>
</div>

<!-- 簽名 Modal -->
<div id="sigOverlay" class="overlay" role="dialog" aria-modal="true" aria-labelledby="sigTitle">
  <div class="dialog">
    <h3 id="sigTitle">請於下方畫押唷😈</h3>
    <canvas id="pad"></canvas>
    <div class="dlg-actions">
      <button id="sigClear"  type="button">清除</button>
      <button id="sigCancel" type="button">取消</button>
      <button id="sigOK"     type="button">確定</button>
    </div>
  </div>
</div>

<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script>
  const LIFF_ID='2008149060-m5pDXW6a';
  const WEBHOOK='https://script.google.com/macros/s/AKfycbw1MOPYMbFzxed__pkBCHBM0OcmBlrBshXOKri0Yai6CVKv-EG-AyyunLKD896UOAAo/exec';

  const editor=document.getElementById('editor'); const wallEl=document.getElementById('wall');
  function setStatus(m){ document.getElementById('status').textContent=m; }

  let lineId='',displayName='',pictureUrl='',myLastRow=null,signatureDataURL='',sendInFlight=false,submittedOnce=false;

  function parseSheetTimeToDate(s){
    if(!s) return new Date();
    const m=/^(\d{4})-(\d{2})-(\d{2})[ T](\d{2}):(\d{2}):(\d{2})/.exec(String(s));
    if(m){ return new Date(+m[1],+m[2]-1,+m[3],+m[4],+m[5],+m[6]); }
    const d=new Date(s); return isNaN(d.getTime())?new Date():d;
  }
  function pad2(n){return String(n).padStart(2,'0');}
  function fmtTaipei(s){ const d=parseSheetTimeToDate(s); return d.getFullYear()+'-'+pad2(d.getMonth()+1)+'-'+pad2(d.getDate())+' '+pad2(d.getHours())+':'+pad2(d.getMinutes())+':'+pad2(d.getSeconds()); }

  async function initLIFF(){
    try{
      await liff.init({ liffId: LIFF_ID, withLoginOnExternalBrowser:true });
      if(!liff.isLoggedIn()){ liff.login(); return; }
      await liff.ready;
      const prof=await liff.getProfile(); const idt=liff.getDecodedIDToken();
      lineId=prof.userId||idt.sub||''; displayName=prof.displayName||idt.name||''; pictureUrl=prof.pictureUrl||'';
    }catch(_){}
    await fetchRoleAndNames(); await preloadMyLatest(); await refreshWall();
  }
  async function initialLoad(){ await fetchRoleAndNames(); await refreshWall(); }

  /* ===(1) 新人欄加上 "Dear " + 半形空格 === */
  async function fetchRoleAndNames(){
    try{
      const j=await (await fetch(WEBHOOK+`?action=userRole&lineId=${encodeURIComponent(lineId||'')}`)).json();
      if(j?.ok){
        const name = j.nameLabel || '—';
        document.getElementById('brideLabel').textContent = 'Dear ' + name; // ← 這行是新增點
      }
    }catch(_){}
  }

  /* 轉換 Google Drive 分享連結為可嵌入的直連（縮圖不破） */
  function toDriveDirectUrl(u){
    if(!u) return u;
    try{
      const s=String(u);
      const m1 = s.match(/drive\.google\.com\/file\/d\/([^/]+)/);
      const m2 = s.match(/[?&]id=([^&]+)/);
      const id = m1 ? m1[1] : (m2 ? m2[1] : null);
      return id ? `https://drive.google.com/uc?export=view&id=${id}` : u;
    }catch(_){ return u; }
  }

  /* ===(2) 簽名縮圖顯示修正：只在載入成功後才顯示，並處理 Drive 連結 === */
  async function preloadMyLatest(){
    if(!lineId) return;
    try{
      const j=await (await fetch(WEBHOOK+`?action=getLatestByLineId&lineId=${encodeURIComponent(lineId)}`)).json();
      if(j?.ok && j.item){
        const it=j.item;
        if(it.contentHTML){ editor.innerHTML=it.contentHTML; editor.removeAttribute('data-empty'); lockEditor(); }

        if(it.signature){
          const chip=document.getElementById('chipSign');
          const img=document.getElementById('signThumb');

          let src = String(it.signature||'').trim();
          if(src){
            src = src.startsWith('data:') ? src : toDriveDirectUrl(src);

            // 先清掉狀態，等載入成功再顯示
            chip.classList.remove('has-img','locked');
            img.removeAttribute('src');
            img.removeAttribute('alt');
            img.loading = 'eager';
            img.referrerPolicy = 'no-referrer';

            img.onload = ()=>{ chip.classList.add('has-img'); chip.classList.add('locked'); };
            img.onerror = ()=>{
              const direct = toDriveDirectUrl(src);
              if(img.src !== direct){ img.src = direct; }
              else { chip.classList.remove('has-img','locked'); img.removeAttribute('src'); }
              img.onerror = null;
            };

            if(/^data:/.test(src) || /^https?:\/\//.test(src)){ img.src = src; }
          }
        }

        myLastRow = Number(it.row||0) || null;
      }
    }catch(_){}
  }

  function exec(cmd){ if(editor.hasAttribute('data-empty')||editor.classList.contains('locked')) return; document.execCommand(cmd,false,null); editor.focus(); }
  document.getElementById('btnBold').onclick=()=>exec('bold');
  document.getElementById('btnItalic').onclick=()=>exec('italic');
  document.getElementById('btnUnderline').onclick=()=>exec('underline');
  document.getElementById('colorPick').onchange=e=>{ const v=e.target.value; if(v&&!editor.classList.contains('locked')&&!editor.hasAttribute('data-empty')) document.execCommand('foreColor',false,v); e.target.blur(); };
  let globalScale=1; function setScale(s){globalScale=Math.max(.7,Math.min(1.7,s)); editor.style.setProperty('--editor-zoom',globalScale+'rem');}
  document.getElementById('btnBigger').onclick=()=>setScale(globalScale+.06);
  document.getElementById('btnSmaller').onclick=()=>setScale(globalScale-.06);
  const PLACEHOLDER='寫下並獻上最誠摯的祝福…💝';
  editor.addEventListener('focus',()=>{ if(editor.hasAttribute('data-empty')){ editor.textContent=''; editor.removeAttribute('data-empty'); }});
  editor.addEventListener('blur',()=>{ if(!editor.textContent.trim()){ editor.setAttribute('data-empty',''); editor.textContent=PLACEHOLDER; }});

  /* 簽名（保留你的流程；新增 onload 後才顯示縮圖） */
  const sigOverlay=document.getElementById('sigOverlay'); const pad=document.getElementById('pad'); const ctx=pad.getContext('2d');
  let drawing=false,lastX=0,lastY=0;
  function fitCanvas(){ const dpr=Math.max(1,devicePixelRatio||1),w=pad.clientWidth,h=pad.clientHeight; pad.width=w*dpr; pad.height=h*dpr;
    ctx.setTransform(dpr,0,0,dpr,0,0); ctx.lineCap='round'; ctx.lineJoin='round'; ctx.lineWidth=3; ctx.strokeStyle='#111'; ctx.clearRect(0,0,w,h); }
  function pos(e){ const r=pad.getBoundingClientRect(); const c=e.touches?e.touches[0]:e; return {x:c.clientX-r.left,y:c.clientY-r.top}; }
  function start(e){ drawing=true; const p=pos(e); lastX=p.x; lastY=p.y; e.preventDefault(); }
  function move(e){ if(!drawing)return; const p=pos(e); ctx.beginPath(); ctx.moveTo(lastX,lastY); ctx.lineTo(p.x,p.y); ctx.stroke(); lastX=p.x; lastY=p.y; e.preventDefault(); }
  function end(){ drawing=false; }
  document.getElementById('chipSign').addEventListener('click',()=>{ const chip=document.getElementById('chipSign'); if(chip.classList.contains('locked')) return;
    sigOverlay.classList.add('show'); setTimeout(fitCanvas,40); });
  pad.addEventListener('mousedown',start); pad.addEventListener('mousemove',move); pad.addEventListener('mouseup',end); pad.addEventListener('mouseleave',end);
  pad.addEventListener('touchstart',start,{passive:false}); pad.addEventListener('touchmove',move,{passive:false}); pad.addEventListener('touchend',end);
  document.getElementById('sigClear').onclick=fitCanvas;
  document.getElementById('sigCancel').onclick=()=>sigOverlay.classList.remove('show');
  document.getElementById('sigOK').onclick=()=>{
    requestAnimationFrame(()=>{
      signatureDataURL=pad.toDataURL('image/png');
      const chip=document.getElementById('chipSign'); const img=document.getElementById('signThumb');
      chip.classList.remove('has-img','locked');
      img.onload = ()=>{ chip.classList.add('has-img'); chip.classList.add('locked'); img.onload=null; };
      img.removeAttribute('alt');
      img.loading = 'eager';
      img.src=signatureDataURL;
      sigOverlay.classList.remove('show');
    });
  };

  /* 牆 */
  function escapeHTML(s){return String(s||'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));}
  function tileTemplate(it){return `<div class="tile" data-row="${it.row||''}" data-owner="${it.lineId||''}">
    <div class="rope"></div><div class="knot"></div>
    <div class="tile-name">${escapeHTML(it.displayName||'—')}</div>
    <div class="tile-sep"></div>
    <div class="tile-date">${escapeHTML(fmtTaipei(it.time))}</div>
    <div class="tile-sep"></div>
    <div class="tile-snippet">${escapeHTML((it.preview||'').trim()||'—')}</div>
  </div>`;}
  async function refreshWall(){
    try{
      const role=document.querySelector('.role-btn.active')?.id?.replace('role','').toLowerCase()||'all';
      const j=await (await fetch(WEBHOOK+`?action=listblessings&role=${role}`)).json();
      if(j?.ok){ const arr=(j.items||[]).slice().sort((a,b)=>parseSheetTimeToDate(b.time)-parseSheetTimeToDate(a.time)); wallEl.innerHTML=arr.map(tileTemplate).join(''); bindTileClicks(); }
    }catch(_){}
  }
  function bindTileClicks(){ document.querySelectorAll('.tile').forEach(t=>t.addEventListener('click',()=>openView(t))); }
  async function openView(el){
    const row=el.getAttribute('data-row');
    const j=await (await fetch(WEBHOOK+`?action=getBlessingDetail&id=${encodeURIComponent(row)}`)).json();
    if(j?.ok&&j.item){
      document.getElementById('viewMeta').textContent=`${j.item.displayName||'—'} ｜ ${fmtTaipei(j.item.time)}`;
      document.getElementById('viewContent').innerHTML=j.item.contentHTML||'';
      document.getElementById('viewOverlay').classList.add('show');
    }
  }
  document.getElementById('viewClose').onclick=()=>document.getElementById('viewOverlay').classList.remove('show');
  document.getElementById('roleAll').onclick=()=>{document.querySelectorAll('.role-btn').forEach(b=>b.classList.remove('active'));document.getElementById('roleAll').classList.add('active');refreshWall();};
  document.getElementById('roleMale').onclick=()=>{document.querySelectorAll('.role-btn').forEach(b=>b.classList.remove('active'));document.getElementById('roleMale').classList.add('active');refreshWall();};
  document.getElementById('roleFemale').onclick=()=>{document.querySelectorAll('.role-btn').forEach(b=>b.classList.remove('active'));document.getElementById('roleFemale').classList.add('active');refreshWall();};

  /* 編輯/送出互鎖（保留） */
  function lockEditor(){editor.classList.add('locked');editor.setAttribute('contenteditable','false');}
  function unlockEditor(){editor.classList.remove('locked');editor.setAttribute('contenteditable','true');editor.focus();}
  document.getElementById('btnEdit').onclick=()=>{ unlockEditor(); submittedOnce=false; const btn=document.getElementById('btnSend'); btn.disabled=false; btn.style.opacity=1; btn.style.pointerEvents='auto'; };
  function hasSignature(){return document.getElementById('chipSign').classList.contains('has-img');}

  async function sendOrUpdate(){
    if(editor.hasAttribute('data-empty')||!editor.textContent.trim()){ alert('欸，不可能不祝福我們吧🖕️'); return; }
    if(!hasSignature()){ alert('欸，沒有畫押不准離開✍️'); return; }
    if(sendInFlight||submittedOnce){ return; }
    sendInFlight=true;
    const btnSend=document.getElementById('btnSend'); const btnEdit=document.getElementById('btnEdit');
    btnSend.disabled=true; btnSend.style.opacity=.6; btnSend.style.pointerEvents='none';
    btnEdit.disabled=true; btnEdit.style.opacity=.6; btnEdit.style.pointerEvents='none';

    const content=editor.innerHTML.trim();
    const payload = myLastRow
      ? {action:'updateBlessing',row:Number(myLastRow),lineId,contentHTML:content}
      : {action:'createBlessing',lineId,displayName,pictureUrl,contentHTML:content,signaturePNG:signatureDataURL||'',extra:{}};
    try{
      const r=await fetch(WEBHOOK,{method:'POST',headers:{'Content-Type':'text/plain;charset=UTF-8'},body:JSON.stringify(payload)});
      const j=await r.json().catch(()=>null);
      if(j?.ok){
        submittedOnce=true; lockEditor(); await refreshWall(); if(!myLastRow) await preloadMyLatest();
        setStatus(myLastRow?'✅ 已更新並鎖定，截止日前都可以修改唷':'✅ 已送出並鎖定，截止日前都可以修改唷');
        btnEdit.disabled=false; btnEdit.style.opacity=1; btnEdit.style.pointerEvents='auto';
      }else if(j?.error==='deadline_passed'){
        setStatus('⛔ 已到截止日，無法送出及編輯'); lockEditor();
      }else{
        setStatus('❌ 送出失敗，稍後再試');
        sendInFlight=false;
        btnSend.disabled=false; btnSend.style.opacity=1; btnSend.style.pointerEvents='auto';
        btnEdit.disabled=false; btnEdit.style.opacity=1; btnEdit.style.pointerEvents='auto';
      }
    }catch(_){
      setStatus('❌ 送出失敗，稍後再試');
      sendInFlight=false;
      btnSend.disabled=false; btnSend.style.opacity=1; btnSend.style.pointerEvents='auto';
      btnEdit.disabled=false; btnEdit.style.opacity=1; btnEdit.style.pointerEvents='auto';
    }
  }
  document.getElementById('btnSend').onclick=sendOrUpdate;

  window.addEventListener('DOMContentLoaded',()=>{
    if(!editor.textContent.trim()){ editor.setAttribute('data-empty',''); editor.textContent='寫下並獻上最誠摯的祝福…💝'; }
    if(window.liff) initLIFF(); else initialLoad();
  });
</script>
  </body>
</html>
