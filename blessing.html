<!doctype html>
<html lang="zh-Hant">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>â¤ï¸åŒå¿ƒç¥ˆé¡˜â¤ï¸</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Patrick+Hand:wght@400&family=Sacramento:wght@400;700&display=swap" rel="stylesheet">

<style>
:root{
  /* ===================== å¯è‡ªè¡Œèª¿æ•´ï¼ˆæ•¸å­—è¶Šå¤§æ•ˆæœè¶Šå¼·ï¼‰ =====================
     --editor-zoomï¼šç·¨è¼¯å™¨æ•´é«”å­—ç´šï¼ˆä¾‹ 1.2rem â†’ è®Šå¤§ï¼‰
     --wood-grain-contrastï¼šæœ¨ç´‹å°æ¯”ï¼ˆ0.0~1.0ï¼›å»ºè­° 0.35~0.7ï¼‰
     --rope-width / --rope-height / --knot-sizeï¼šç¹©æ¢èˆ‡çµé»å°ºå¯¸ï¼ˆpxï¼‰
     --rope-twistï¼šç¹©æ¢æ‰­ç´‹å¯†åº¦ï¼ˆæ•¸å€¼è¶Šå¤§ï¼Œæ¢ç´‹è¶Šç´°å¯†ï¼‰
     ç¯„ä¾‹ï¼š
       å­—é«”è®Šå¤§ï¼š:root { --editor-zoom: 1.2rem; }
       æœ¨ç´‹æ›´æ˜é¡¯ï¼š:root { --wood-grain-contrast: .6; }
       ç¹©æ›´ç´°ï¼š:root { --rope-width: 9px; --knot-size: 22px; }
  ======================================================================== */
  --brand-bg:#c9daf8;
  --title:#A68A7C;  --ink:#0f172a; --accent:#A68A7C; --rim:#E4E4E4; --soft:#F5F1EC;
  --panel-grad-from:#b7d2f6; --panel-grad-to:#cfe1fb; --panel-bg-image:none;

  --paper-grad-from:#e6b8af; /* â† æ”¹æˆæŒ‡å®šè‰² */
  --paper-grad-to:#e6b8af;   /* â† æ”¹æˆæŒ‡å®šè‰² */
  --panel-maxw:1320px;  --card-maxw:1200px;

  --radius-xl:16px; --radius-md:12px;
  --shadow-1:0 10px 26px rgba(0,0,0,.10);
  --shadow-2:0 2px 0 rgba(0,0,0,.15), 0 2px 8px rgba(0,0,0,.06);

  --content-pad:22px; --editor-zoom:1rem; /* â† ä¾‹ï¼š1.2rem æœƒè®Šå¤§ */
  --toolbar-gap:8px; --status-fz:14px; --h2-size:2.8rem;
  --stroke:rgba(0,0,0,.18); --glow:rgba(255,255,255,.65);

  --footer-gap:48px;
  --btn-w:220px; --btn-h:36px;       /* â–¶ èˆ‡å·¥å…·åˆ—åŒé«˜ */
  --tool-h:36px;

  --tile-w:220px; --tile-h:150px;

  --chip-w:140px; --chip-h:44px; --chip-gap:10px;
  --left-actions-h:36px;             /* â–¶ ä¸‰é¡†æŒ‰éˆ•åŒé«˜ */

  /* === æœ¨ç‰Œï¼‹ç¹©çµï¼ˆå¯èª¿ï¼‰ === */
  --wood-grain-contrast:.55; /* æœ¨ç´‹å¼·åº¦ï¼š0.0~1.0ï¼ˆè¶Šå¤§è¶Šæ˜é¡¯ï¼‰ */
  --rope-shadow:8px;         /* é™°å½±å¼·åº¦(px) */
  --rope-width:10px;         /* ç¹©æ¢å¯¬(px) â€” å·²èª¿ç´° */
  --rope-height:34px;        /* ç¹©æ¢é«˜(px) */
  --knot-size:24px;          /* çµé»å¤§å°(px) â€” ç¨å¾®ç¸®å° */
  --rope-twist:16;           /* æ‰­ç´‹å¯†åº¦ï¼ˆè¶Šå¤§è¶Šç´°å¯†ï¼‰ */
}

/* === éª¨æ¶ï¼ˆä¸å‹•å…¶å®ƒï¼‰ === */
*{box-sizing:border-box;}
html,body{
  height:100%; margin:0; overflow:hidden;
  color:var(--ink); background:var(--brand-bg);
  font-family:"Patrick Hand","Noto Sans TC",system-ui,-apple-system,sans-serif;
  -webkit-text-stroke:.35px var(--stroke); text-shadow:0 1px 0 var(--glow);
}
.bg-photo{ position:fixed; inset:0; z-index:0; width:100%; height:100%; object-fit:cover; opacity:.35; pointer-events:none; filter:brightness(.6) saturate(.9); }

.panel{
  position:relative; z-index:1; max-width:var(--panel-maxw);
  height:calc(100vh - (70px + var(--footer-gap))); margin:26px auto;
  background:linear-gradient(135deg, var(--panel-grad-from), var(--panel-grad-to)), var(--panel-bg-image);
  background-size:auto, cover; background-position:left top, center;
  border:1px solid var(--rim); border-radius:var(--radius-xl);
  box-shadow:var(--shadow-1); display:flex; flex-direction:column; overflow:hidden;
}

/* æ¨™é¡Œèˆ‡å·¥å…·ï¼ˆä¸å‹•ï¼‰ */
.titlebar{ background:transparent; padding:16px 16px 6px; }
h2{
  margin:0 0 10px; text-align:center; font-family:"Sacramento",cursive;
  font-weight:700; font-size:var(--h2-size); letter-spacing:1px; color:var(--title);
  -webkit-text-stroke:.6px rgba(0,0,0,.12); text-shadow:0 3px 4px rgba(255,255,255,.75);
}
.bar{ padding:6px 22px 8px; }
.bar-inner{ max-width:var(--card-maxw); margin:0 auto; display:flex; align-items:center; gap:12px; }
.toolbar{ display:flex; gap:var(--toolbar-gap); filter:drop-shadow(0 2px 0 rgba(0,0,0,.08)); }
.tool-btn,.tool-select{
  min-width:64px; height:var(--tool-h); padding:0 12px; background:#fff; border:1px solid var(--rim); border-radius:var(--radius-md);
  font-weight:700; display:flex; align-items:center; justify-content:center; gap:6px; box-shadow:var(--shadow-2);
}
.tool-select{ min-width:auto; padding:0 10px; }
.tool-btn:active{ transform:translateY(1px) scale(.99); }
.rolebar{ display:flex; gap:var(--toolbar-gap); }
.role-btn{ min-width:64px; height:var(--tool-h); padding:0 12px; background:#fff; border:1px solid var(--rim); border-radius:var(--radius-md); font-weight:700; display:flex; align-items:center; justify-content:center; box-shadow:var(--shadow-2); }
.role-btn.active{ outline:2px solid rgba(0,0,0,.15); }
#status{
  flex:1 1 auto; min-width:240px; background:var(--soft); border:1px solid #E4E4E4;
  border-radius:12px; padding:10px; font-size:var(--status-fz); white-space:pre-wrap;
  text-align:center; color:var(--accent)!important; font-weight:700;
  -webkit-text-stroke:.35px rgba(0,0,0,.10); text-shadow:0 1px 0 rgba(255,255,255,.85),0 3px 6px rgba(0,0,0,.04);
}

/* èˆå°ï¼šå·¦ 1/3 ï¼‹ å³ 2/3ï¼ˆä¸å‹•ï¼‰ */
.stage{ flex:1 1 auto; padding:14px 22px 0; display:flex; justify-content:center; align-items:flex-start; overflow:hidden; }
.card{
  position:relative; width:100%; max-width:var(--card-maxw);
  border:1px solid rgba(0,0,0,.05); border-radius:var(--radius-xl); box-shadow:0 10px 26px rgba(0,0,0,.08);
  padding:var(--content-pad); height:100%;
  display:grid; grid-template-columns: 1fr 2fr; gap:14px; overflow:hidden; background:transparent;
}

/* å·¦å€å®¹å™¨ï¼šæ”¹ç‚ºæŒ‡å®šè‰² #e6b8afï¼ˆä¸å†ç”¨é»ƒç´™æ¼¸å±¤ï¼‰ */
.left-wrap{
  position:relative; background:#e6b8af;
  border-radius:var(--radius-xl); border:1px solid rgba(0,0,0,.05); padding:12px; overflow:hidden;
}
.left-content{ position:relative; height:100%; }

/* æ–°äºº chipï¼ˆç²—é«”ï¼‰ */
.chip{
  position:absolute; min-width:var(--chip-w); height:var(--chip-h);
  background:#fff; border:1px solid var(--rim); border-radius:10px;
  box-shadow:0 2px 8px rgba(0,0,0,.06);
  display:flex; align-items:center; justify-content:center; gap:8px; padding:6px 10px; user-select:none;
}
#chipBride{ top:var(--chip-gap); left:var(--chip-gap); }
#brideLabel{ font-weight:800; }  /* â–¶ æ–°äººç²—é«” */

/* å…§æ–‡ç·¨è¼¯å™¨ï¼šéœ€è¦æ™‚æ‰å‡ºæ²è»¸ */
.editor{
  position:absolute;
  top:calc(var(--chip-gap) + var(--chip-h) + 16px);
  right:var(--chip-gap);
  bottom:calc(var(--chip-gap) + var(--left-actions-h) + 10px);
  left:var(--chip-gap);
  overflow:auto;
  line-height:1.8; outline:none; background:transparent; border-radius:12px; padding:14px;
  font-size:var(--editor-zoom); border:1px dashed rgba(0,0,0,.12);
}
.editor[data-empty]{ opacity:.22; }
.editor.locked{ pointer-events:none; opacity:.85; }

/* ä¸‹æ–¹ä¸‰é¡†ï¼šä¿®æ”¹ / é€å‡º / ç°½å â€”â€” ä¸‰ç­‰åˆ†ã€åŒå­—ç´šåŒé«˜ */
.left-actions{
  position:absolute; left:var(--chip-gap); right:var(--chip-gap);
  bottom:var(--chip-gap); height:var(--left-actions-h);
  display:flex; gap:10px; font-size:16px;     /* â–¶ èˆ‡å·¥å…·åˆ—å­—ç´šä¸€è‡´ */
}
.left-actions > *{ flex:1 1 0; height:100%; }
.left-actions button{
  background:#fff; border:1px solid var(--rim); border-radius:10px; font-weight:800;
  box-shadow:var(--shadow-2); cursor:pointer;
}
.left-actions button:active{ transform:translateY(1px) scale(.99); }

/* ç°½å chip æ”¾åœ¨æŒ‰éˆ•åˆ—å…§ï¼ˆåŒå¯¬åŒé«˜ï¼‰ */
#chipSign{
  position:static; display:flex; align-items:center; justify-content:center; cursor:pointer;
  background:#fff; border:1px solid var(--rim); border-radius:10px; box-shadow:var(--shadow-2);
  padding:0 8px;
}
#chipSign:not(.has-img){ opacity:.22; }
#chipSign.locked{ opacity:.9; pointer-events:none; }
#chipSign.has-img{ padding:0 6px; }
#chipSign .hint{ font-weight:900; }
#signThumb{ display:none; width:100%; height:70%; object-fit:contain; }
#chipSign.has-img #signThumb{ display:block; }  #chipSign.has-img .hint{ display:none; }

/* å³å€ç¥ç¦ç‰†ï¼šåº•è‰²æ”¹ #e6b8afï¼ˆåŸå…ˆç²‰è‰²æ¼¸å±¤æ”¹ç‚ºå¯¦è‰²ï¼‰ */
.wall-wrap{
  background:#e6b8af;
  border-radius:var(--radius-xl); border:1px solid rgba(0,0,0,.05);
  padding:12px; overflow:auto;
}
.wall{
  min-height:280px; display:grid;
  grid-template-columns: repeat(auto-fill, minmax(var(--tile-w), 1fr));
  gap:12px; align-content:start; padding:2px;
  overflow:visible;
}

/* === æœ¨ç‰Œï¼ˆåŠ å¼·æœ¨è³ªç´‹è·¯ï¼‰ & ç¹©çµï¼ˆæ›´åƒç¹©ï¼‰ ===========================
   å¯èª¿åƒæ•¸ï¼š
   --wood-grain-contrast: æœ¨ç´‹å°æ¯”ï¼ˆ0.0~1.0ï¼‰
   --rope-width / --rope-height / --knot-sizeï¼šå°ºå¯¸ï¼ˆpxï¼‰
   --rope-twist: æ‰­ç´‹å¯†åº¦ï¼ˆè¶Šå¤§è¶Šç´°å¯†ï¼‰
===================================================================== */
.tile{
  position:relative; width:100%; height:var(--tile-h);
  background:
    /* æŸ”å’Œåº•è‰² */
    linear-gradient(180deg,#f1e2cf,#ead7c4),
    /* ä¸»æœ¨ç´‹ï¼ˆæ–œå‘ç´°ç´‹ï¼‰ */
    repeating-linear-gradient(14deg,
      rgba(0,0,0, calc(.02 + var(--wood-grain-contrast)*.08)) 0,
      rgba(0,0,0, calc(.02 + var(--wood-grain-contrast)*.08)) 5px,
      rgba(255,255,255, calc(.02 + var(--wood-grain-contrast)*.06)) 5px,
      rgba(255,255,255, calc(.02 + var(--wood-grain-contrast)*.06)) 10px
    ),
    /* å¹´è¼ªæ³¢ç´‹ï¼ˆç¸±å‘ï¼‰ */
    repeating-linear-gradient(0deg,
      rgba(0,0,0, calc(.01 + var(--wood-grain-contrast)*.03)) 0,
      rgba(0,0,0, calc(.01 + var(--wood-grain-contrast)*.03)) 2px,
      rgba(255,255,255, calc(.01 + var(--wood-grain-contrast)*.03)) 2px,
      rgba(255,255,255, calc(.01 + var(--wood-grain-contrast)*.03)) 4px
    ),
    /* éš¨æ©Ÿçµç–¤ */
    radial-gradient(20px 14px at 28% 32%, rgba(0,0,0,.06), transparent 60%),
    radial-gradient(16px 12px at 72% 64%, rgba(0,0,0,.05), transparent 60%);

  border:1px solid #d8c8b6; border-radius:14px; box-shadow:0 6px 14px rgba(0,0,0,.08);
  padding:10px 12px 12px;
  cursor:pointer; overflow:visible; display:flex; flex-direction:column; gap:6px;
}

/* ç¹©æ¢ï¼ˆé›™è‚¡ï¼‹æ‰­ç´‹ï¼‰ï¼Œæ›´ç´°ã€æ›´åƒç¹© */
.tile:before{
  content:"";
  position:absolute; top:calc(var(--rope-height)*-0.55); left:50%; transform:translateX(-50%);
  width:calc(var(--rope-width) * 2 + 6px); height:var(--rope-height);
  background:
    /* å…©è‚¡ä¸»ç¹©ï¼ˆå·¦å³å„ä¸€æ¢ï¼‰ */
    radial-gradient(12px 50% at 35% 50%, #c9934b 35%, #b57a3a 60%, transparent 62%) no-repeat left center / var(--rope-width) 100%,
    radial-gradient(12px 50% at 65% 50%, #c9934b 35%, #b57a3a 60%, transparent 62%) no-repeat right center / var(--rope-width) 100%,
    /* æ‰­ç´‹èˆ‡çº–ç¶­ */
    repeating-conic-gradient(from 0deg,
      rgba(255,255,255,.25) 0deg 6deg,
      rgba(0,0,0,.10) 6deg 12deg) center/ calc(100% / var(--rope-twist)) calc(100% / 2);
  border-radius:999px;
  filter:brightness(.97) saturate(.95);
  box-shadow:
    0 1px 0 rgba(0,0,0,.12),
    0 6px var(--rope-shadow) rgba(0,0,0,.12);
}

/* çµé»ï¼ˆç«‹é«”è³ªæ„Ÿï¼‰ */
.tile:after{
  content:"";
  position:absolute; top:-8px; left:50%; transform:translateX(-50%);
  width:calc(var(--knot-size) * 1.15); height:var(--knot-size);
  background:
    radial-gradient(60% 80% at 35% 35%, rgba(255,255,255,.55), transparent 60%),
    linear-gradient(180deg,#cc8b42,#a86a2f);
  border-radius:12px;
  box-shadow:
    0 2px 0 rgba(0,0,0,.08),
    0 8px 14px rgba(0,0,0,.12);
  border:1px solid rgba(0,0,0,.12);
}

/* ç‰Œé¢å…§å®¹ï¼ˆåŸæ¨£ï¼‰ */
.tile-name{ font-weight:800; text-align:center; margin-top:8px; }
.tile-sep{ height:1px; background:rgba(0,0,0,.1); margin:4px 0; }
.tile-date{ font-size:12px; opacity:.8; text-align:center; }
.tile-snippet{
  font-size:14px; line-height:1.6; text-align:left; word-break:break-word;
  display:-webkit-box; -webkit-line-clamp:3; -webkit-box-orient:vertical; overflow:hidden;
}

/* æª¢è¦–çª—ï¼ˆåƒ…é—œé–‰ï¼‰èˆ‡åº•éƒ¨é€å‡ºï¼ˆé«˜åº¦èˆ‡å·¥å…·åˆ—ä¸€è‡´ï¼‰ */
.overlay{ position:fixed; inset:0; z-index:9999; display:none; align-items:center; justify-content:center; background:rgba(17,24,39,.35); backdrop-filter:blur(3px); }
.overlay.show{ display:flex; }
.dialog{ width:min(92vw,680px); max-height:82vh; background:var(--soft); border:1px solid var(--rim); border-radius:14px; padding:16px; box-shadow:0 18px 44px rgba(0,0,0,.18); overflow:auto; }
.dialog h3{ margin:0 0 10px; font-size:18px; color:#6b5e52; text-align:center; -webkit-text-stroke:0; text-shadow:none; }
.view-meta{ text-align:center; font-size:12px; opacity:.75; margin-bottom:8px; }
.view-content{ background:#fff; border:1px solid #ddd; border-radius:12px; padding:12px; line-height:1.8; }
.view-actions{ display:flex; gap:10px; justify-content:center; margin-top:12px; }
.view-actions button{ min-width:120px; height:var(--tool-h); border-radius:10px; border:1px solid var(--rim); background:#fff; cursor:pointer; font-weight:700; }

.footer-actions{ flex:0 0 auto; display:flex; justify-content:center; align-items:center; padding:14px 0 16px; }
.primary{ min-width:var(--btn-w); height:var(--btn-h); padding:0 20px; background:#fff; border:1px solid var(--rim); border-radius:var(--radius-md); font-weight:700; cursor:pointer; box-shadow:var(--shadow-2); }
.primary:active{ transform:translateY(1px) scale(.99); }

footer{ position:fixed; left:0; right:0; bottom:var(--footer-gap); text-align:center; color:#6b5e52; font-size:12px; opacity:.9; pointer-events:none; z-index:5; }

#sigOverlay .dialog{ width:min(92vw,520px); }
#pad{ width:100%; height:260px; background:#fff; border:1px solid #ddd; border-radius:12px; touch-action:none; }
.dlg-actions{ display:flex; gap:10px; justify-content:center; margin-top:12px; }
.dlg-actions button{ width:120px; height:var(--tool-h); border-radius:10px; border:1px solid var(--rim); background:#fff; cursor:pointer; font-weight:700; }
</style>

<body>
  <img class="bg-photo" src="./assets/favors.png" alt="">

  <div class="panel">
    <div class="titlebar">
      <h2>â¤ï¸åŒå¿ƒç¥ˆé¡˜â¤ï¸</h2>

      <div class="bar">
        <div class="bar-inner" id="barInner">
          <div class="rolebar">
            <button type="button" class="role-btn active" id="roleAll">å…¨éƒ¨</button>
            <button type="button" class="role-btn" id="roleMale">ç”·æ–¹</button>
            <button type="button" class="role-btn" id="roleFemale">å¥³æ–¹</button>
          </div>

          <p id="status">ğŸ“¥ é‚„åœ¨ç­‰å¾…ï¼Œå¾…é€å‡ºè³‡æ–™</p>

          <div class="toolbar" role="toolbar" aria-label="æ–‡å­—å·¥å…·">
            <button class="tool-btn" id="btnBold"      type="button" title="ç²—é«”">ç²—é«”</button>
            <button class="tool-btn" id="btnItalic"    type="button" title="æ–œé«”">æ–œé«”</button>
            <button class="tool-btn" id="btnUnderline" type="button" title="åº•ç·š">åº•ç·š</button>
            <select id="colorPick" class="tool-select" title="å­—é«”é¡è‰²">
              <option value="" selected>é¡è‰²</option>
              <option value="#a21caf">å°ç´«</option>
              <option value="#dc2626">å°ç´…</option>
              <option value="#2563eb">å°è—</option>
              <option value="#059669">å°ç¶ </option>
              <option value="#d97706">å°æ©˜</option>
              <option value="#6b7280">å°ç°</option>
            </select>
            <button class="tool-btn" id="btnBigger"    type="button" title="æ”¾å¤§">æ”¾å¤§</button>
            <button class="tool-btn" id="btnSmaller"   type="button" title="ç¸®å°">ç¸®å°</button>
          </div>
        </div>
      </div>
    </div>

    <div class="stage">
      <div class="card" id="card">
        <!-- å·¦ 1/3 -->
        <section class="left-wrap">
          <div class="left-content">
            <div class="chip" id="chipBride" title="æ–°äºº"><span id="brideLabel">Dear â€”</span></div>

            <div class="editor" id="editor" contenteditable="true" aria-label="ç¥ˆé¡˜å…§å®¹">
              å¯«ä¸‹ä¸¦ç»ä¸Šæœ€èª æ‘¯çš„ç¥ç¦â€¦ğŸ’
            </div>

            <div class="left-actions">
              <button id="btnEdit"  type="button">ä¿®æ”¹</button>
              <button id="btnSend"  type="button">é€å‡º</button>
              <div class="chip" id="chipSign" title="é»æ­¤ç°½å">
                <span class="hint">ç°½åç•«æŠ¼</span>
                <img id="signThumb" alt="signature preview" />
              </div>
            </div>
          </div>
        </section>

        <!-- å³ 2/3ï¼šç¥ç¦ç‰† -->
        <section class="wall-wrap">
          <div class="wall" id="wall"></div>
        </section>
      </div>
    </div>

    <div class="footer-actions">
      <button id="btnSubmit" class="primary" type="button">é€å‡ºæ»¿æ»¿ç¥ç¦</button>
    </div>
  </div>

  <footer>Â© Copyright 2025 MYâ€˜s System</footer>

  <!-- æª¢è¦–çª—ï¼ˆåƒ…é—œé–‰ï¼‰ -->
  <div id="viewOverlay" class="overlay" role="dialog" aria-modal="true" aria-labelledby="viewTitle">
    <div class="dialog">
      <h3 id="viewTitle">ç¥ç¦å…§å®¹</h3>
      <div class="view-meta" id="viewMeta"></div>
      <div id="viewContent" class="view-content"></div>
      <div class="view-actions">
        <button id="viewClose" type="button">é—œé–‰</button>
      </div>
    </div>
  </div>

  <!-- ç°½å Modal -->
  <div id="sigOverlay" class="overlay" role="dialog" aria-modal="true" aria-labelledby="sigTitle">
    <div class="dialog">
      <h3 id="sigTitle">è«‹æ–¼ä¸‹æ–¹ç•«æŠ¼å”·ğŸ˜ˆ</h3>
      <canvas id="pad"></canvas>
      <div class="dlg-actions">
        <button id="sigClear"  type="button">æ¸…é™¤</button>
        <button id="sigCancel" type="button">å–æ¶ˆ</button>
        <button id="sigOK"     type="button">ç¢ºå®š</button>
      </div>
    </div>
  </div>

<script>
/* ====== åŸºæœ¬è¨­å®šï¼ˆæ²¿ç”¨ï¼‰ ====== */
const LIFF_ID='2008149060-m5pDXW6a';
const WEBHOOK='https://script.google.com/macros/s/AKfycbzVhMwZIqS2NUOuusjVij9sMaqWe1WrIbc1v6__ugYRS-T5p9gu68F9AvBUJhEiAs2j/exec';
const TIMEOUT_MS=20000;

/* ç‹€æ…‹åˆ— */
function setStatus(m){
  const el=document.getElementById('status');
  el.textContent=m; el.classList.remove('ok','busy','err');
  if(/æˆåŠŸ|å·²è¼‰å…¥|å°±ç·’/.test(m)) el.classList.add('ok');
  else if(/é€å‡ºä¸­|ç­‰å¾…|è™•ç†/.test(m)) el.classList.add('busy');
  else if(/å¤±æ•—|é€¾æ™‚|ç„¡æ³•|éŒ¯èª¤/.test(m)) el.classList.add('err');
}

/* LIFF */
let lineId='',displayName='',pictureUrl='';
async function initLIFF(){
  if(typeof liff==='undefined'){ setStatus('æœªè¼‰å…¥LIFF SDKï¼Œå¯å…ˆæ¸¬æ¨£å¼'); return; }
  try{
    setStatus('â³ æ­£åœ¨åˆå§‹åŒ–ï¼Œè«‹ç¨å¾Œ...');
    await liff.init({ liffId: LIFF_ID, withLoginOnExternalBrowser:true });
    if(!liff.isLoggedIn()){ liff.login({ scope:['openid','profile'] }); return; }
    if(liff.ready) await liff.ready;
    let prof=null, idt=null;
    try{ prof=await liff.getProfile(); }catch(_){}
    try{ idt=liff.getDecodedIDToken(); }catch(_){}
    lineId=(prof&&prof.userId)||(idt&&idt.sub)||'';
    displayName=(prof&&prof.displayName)||(idt&&(idt.name||idt.nickname))||'';
    pictureUrl=(prof&&prof.pictureUrl)||'';
    try{
      const r=await fetch(WEBHOOK+'?action=couple',{method:'GET',cache:'no-store'});
      if(r.ok){ const j=await r.json().catch(()=>null); if(j&&j.ok&&j.name){ document.getElementById('brideLabel').textContent=''+String(j.name||'â€”'); } }
    }catch(_){}
    await refreshWall(); setStatus('âœ… åˆå§‹åŒ–å·²å®Œæˆï¼Œå¯ä»¥å¡«å¯«æ»¿æ»¿å¿ƒæ„å›‰');
  }catch(e){
    setStatus('âŒ åˆå§‹åŒ–å¤±æ•—ï¼š' + (e && e.message ? e.message : 'æœªçŸ¥éŒ¯èª¤') + 'ï¼Œå˜—è©¦ç„¡æ•ˆè«‹å›åˆ°å®˜æ–¹LINEå‘¼å«ç®¡ç†å“¡');
  }
}

/* å·¥å…·åˆ—ï¼ˆåŸæœ¬åŠŸèƒ½ï¼‰ */
const editor=document.getElementById('editor');
function btnExec(cmd){ if(editor.hasAttribute('data-empty')||editor.classList.contains('locked')) return; document.execCommand(cmd,false,null); editor.focus(); }
document.getElementById('btnBold').addEventListener('click',()=>btnExec('bold'));
document.getElementById('btnItalic').addEventListener('click',()=>btnExec('italic'));
document.getElementById('btnUnderline').addEventListener('click',()=>btnExec('underline'));
document.getElementById('colorPick').addEventListener('change',e=>{
  const v=e.target.value; if(!editor.hasAttribute('data-empty') && !editor.classList.contains('locked') && v){ document.execCommand('foreColor',false,v); editor.focus(); }
  e.target.blur();
});
function wrapSelectionWithClass(cls){
  if(editor.hasAttribute('data-empty')||editor.classList.contains('locked')) return false;
  const sel=window.getSelection(); if(!sel.rangeCount) return false;
  const r=sel.getRangeAt(0); if(r.collapsed) return false;
  const span=document.createElement('span'); span.className=cls;
  try{ r.surroundContents(span);}catch(_){ const f=r.extractContents(); span.appendChild(f); r.insertNode(span); }
  const s2=window.getSelection(); s2.removeAllRanges(); const nr=document.createRange(); nr.setStartAfter(span); nr.collapse(true); s2.addRange(nr);
  editor.focus(); return true;
}
let globalScale=1;
function setGlobalScale(sc){ globalScale=Math.max(0.7,Math.min(1.7,sc)); editor.style
