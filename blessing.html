<!doctype html>
<html lang="zh-Hant">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>é€ä¸Šç¥ç¦</title>

<!-- å­—é«”ï¼šSacramentoï¼ˆæ¨™é¡Œï¼‰ï¼‹ Patrick Handï¼ˆå…§æ–‡/å·¥å…·åˆ—/ç‹€æ…‹åˆ—ï¼‰ -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Patrick+Hand:wght@400&family=Sacramento:wght@400;700&display=swap" rel="stylesheet">

<style>
/* ====================== å…¨åŸŸè®Šæ•¸ ====================== */
:root{
  /* ä¸»é¡Œ */
  --brand-bg:#c9daf8;     /* å…¨é åº•è‰²ï¼ˆè—ï¼‰ */
  --paper:#fff2cc;        /* ä¸»é¢æ¿ / å…§æ–‡å¡èƒŒæ™¯ï¼ˆé»ƒï¼‰â€”çµ±ä¸€è‰² */
  --title:#A68A7C;        /* æ¨™é¡Œå­—è‰²ï¼ˆäº’å‹•éŸ³ç¬¦ä¸»é¡Œï¼‰ */
  --ink:#0f172a;
  --accent:#A68A7C;
  --rim:#E4E4E4;
  --soft:#F5F1EC;         /* ç‹€æ…‹åˆ—ç”¨ï¼ˆé–æ¨£å¼ï¼‰ */

  /* èƒŒæ™¯åœ– */
  --bg-image-url:url("./assets/wishing.png");

  /* æ¨™é¡Œåˆ—ï¼ˆå¯ä¿ç•™æ·¡è—æ„Ÿï¼Œä¹Ÿå¯æ”¹åŒé»ƒï¼‰ */
  --titlebar-grad-from:#b7d2f6;
  --titlebar-grad-to:#cfe1fb;

  /* å°ºå¯¸/é™°å½± */
  --panel-maxw:1020px;
  --radius-xl:16px;
  --radius-md:12px;
  --shadow-1:0 10px 26px rgba(0,0,0,.10);
  --shadow-2:0 2px 0 rgba(0,0,0,.15), 0 2px 8px rgba(0,0,0,.06);

  /* å…§æ–‡ */
  --content-pad:22px;
  --content-line:2px;
  --content-line-alpha:.10;   /* æ›´æ·¡ */
  --editor-zoom:1rem;

  /* å·¥å…· / ç‹€æ…‹åˆ— */
  --toolbar-gap:8px;
  --status-fz:14px;

  /* æ¨™é¡Œå°ºå¯¸ï¼ˆèˆ‡äº’å‹•éŸ³ç¬¦ä¸€è‡´ï¼‰ */
  --h2-size:2.8rem;

  /* å…¨ç«™æé‚Š/é«˜å…‰ */
  --stroke:rgba(0,0,0,.18);
  --glow:rgba(255,255,255,.65);
}

/* ====================== ç‰ˆé¢èˆ‡èƒŒæ™¯ ====================== */
*{ box-sizing:border-box; }
html,body{
  height:100%;
  margin:0;
  color:var(--ink);
  background:var(--brand-bg);
  font-family:"Patrick Hand","Noto Sans TC",system-ui,-apple-system,sans-serif;
  -webkit-text-stroke:.35px var(--stroke);
  text-shadow:0 1px 0 var(--glow);
  overflow:hidden;                  /* âœ… å›ºå®šç‰ˆé¢ï¼šä¸æ»¾å‹• */
}
body::before{
  content:"";
  position:fixed; inset:0; z-index:-1;
  background-image:var(--bg-image-url);
  background-size:cover; background-position:center;
  opacity:.35; mix-blend-mode:multiply;
  filter:contrast(1.05) saturate(1.05);
}

/* ====================== ä¸»é¢æ¿ï¼ˆå›ºå®šåœ¨ä¸€å€‹è¦–çª—å…§ï¼‰ ====================== */
.panel{
  position:relative;
  max-width:var(--panel-maxw);
  height:calc(100vh - 40px);        /* âœ… å‰›å¥½ä¸€å€‹è¦–çª—çš„é«˜åº¦ï¼ˆä¸Šä¸‹é ç•™ 40pxï¼‰ */
  margin:20px auto;
  background:var(--paper);          /* âœ… èˆ‡å¡ç‰‡åŒè‰²ï¼Œæœçµ•é›™è‰²éŒ¯è¦º */
  border:1px solid var(--rim);
  border-radius:var(--radius-xl);
  box-shadow:var(--shadow-1);
  display:flex;
  flex-direction:column;
  overflow:hidden;                  /* å…§éƒ¨è‡ªå·±æ’ï¼Œä¸è®“é¢æ¿è¢«æ’å‡º */
}

/* â€”â€” æ¨™é¡Œåˆ— â€”â€” */
.titlebar{
  background:linear-gradient(135deg, var(--titlebar-grad-from), var(--titlebar-grad-to));
  padding:8px 16px;
  flex:0 0 auto;
}
h2{
  margin:2px 0 6px;
  text-align:center;
  font-family:"Sacramento",cursive;
  font-weight:700;
  font-size:var(--h2-size);         /* 2.8rem èˆ‡äº’å‹•éŸ³ç¬¦ä¸€è‡´ */
  letter-spacing:1px;
  color:var(--title);
  -webkit-text-stroke:.6px rgba(0,0,0,.12);
  text-shadow:0 3px 4px rgba(255,255,255,.75);
}

/* æ¨™é¡Œåˆ—å…§ï¼šå·¥å…·åˆ—ï¼ˆå·¦ï¼‰ + ç‹€æ…‹åˆ—ï¼ˆå³ï¼‰ */
.bar{
  display:flex; align-items:center; justify-content:space-between;
  gap:10px; padding:8px 0 10px;
}
.toolbar{
  display:flex; gap:var(--toolbar-gap); filter:drop-shadow(0 2px 0 rgba(0,0,0,.08));
}
.tool-btn,.tool-select{
  min-width:64px; height:36px; padding:0 12px;
  background:#fff; border:1px solid var(--rim); border-radius:var(--radius-md);
  font-weight:700; display:flex; align-items:center; justify-content:center; gap:6px;
  box-shadow:var(--shadow-2);
}
.tool-select{ min-width:auto; padding:0 10px; }
.tool-btn:active{ transform:translateY(1px) scale(.99); }

#status{
  background:var(--soft); border:1px solid #E4E4E4; border-radius:12px;
  padding:10px; font-size:var(--status-fz); white-space:pre-wrap; text-align:center;
  color:var(--accent)!important; font-weight:700;
  -webkit-text-stroke:.35px rgba(0,0,0,.10);
  text-shadow:0 1px 0 rgba(255,255,255,.85), 0 3px 6px rgba(0,0,0,.04);
  min-width:220px;
}

/* â€”â€” å…§å®¹å€ï¼ˆä¸æ»¾å‹•æ•´é ï¼Œå¿…è¦æ™‚åƒ…å…§å®¹å€æ»¾å‹•ï¼‰ â€”â€” */
.stage{
  flex:1 1 auto;
  padding:18px 22px 8px;
  overflow:hidden;                  /* âœ… å…§å®¹å€æœ¬èº«ä¸æ»¾ï¼ˆä¸‹é¢å¦æœ‰å›ºå®šçš„é€å‡ºéµï¼‰ */
  display:flex; justify-content:center; align-items:flex-start;
}

/* å…§æ–‡å¡ï¼šèˆ‡é¢æ¿åŒè‰²ï¼Œå»æ¼¸å±¤ï¼ˆé¿å…å…©å¡Šä¸åŒè‰²è¦–è¦ºï¼‰ */
.card{
  position:relative;
  width:100%;
  max-width:900px;
  background:var(--paper);          /* âœ… åŒè‰² */
  border:1px solid rgba(0,0,0,.05);
  border-radius:var(--radius-xl);
  box-shadow:0 10px 26px rgba(0,0,0,.08);
  padding:var(--content-pad);
}

/* ç·¨è¼¯å™¨ */
.editor{
  min-height:300px;
  max-height:48vh;                  /* âœ… è®“å…§å®¹ä¸è¶…å‡ºè¦–çª—ï¼›å¿…è¦æ™‚å¯å…§éƒ¨æ»¾å‹• */
  overflow:auto;
  line-height:1.8;
  outline:none; background:transparent; border-radius:var(--radius-md);
  padding:10px 12px;
  font-size:var(--editor-zoom);
  background-image:linear-gradient(to bottom, rgba(0,0,0,var(--content-line-alpha)) var(--content-line), transparent 0);
  background-size:100% 38px;
}

/* æ”¾å¤§ï¼ç¸®å° classï¼ˆä¿ç•™ï¼‰ */
.fs-up-1{font-size:1.15em;} .fs-up-2{font-size:1.30em;} .fs-up-3{font-size:1.50em;}
.fs-down-1{font-size:.92em;} .fs-down-2{font-size:.84em;} .fs-down-3{font-size:.76em;}

/* æ–°äºº / ç°½åå¾½ç« ï¼ˆå…©è€…åŒå°ºå¯¸ï¼‰ */
.badge{
  position:absolute; background:var(--paper); color:var(--ink);
  padding:10px 14px; border-radius:10px; box-shadow:0 2px 8px rgba(0,0,0,.06); font-weight:700;
  display:flex; align-items:center; gap:8px;
}
.badge-top-left{ left:-8px; top:-12px; border:none; }
.badge-bottom-right{ right:-8px; bottom:-12px; border:1px solid rgba(0,0,0,.08); cursor:pointer; }

/* æœªç°½å‰ç¸®åœ–éš±è—ï¼Œç°½å®Œæ‰é¡¯ç¤ºï¼ˆé¿å…ç ´åœ–ï¼‰ */
.badge-bottom-right img{ display:none; width:64px; height:36px; object-fit:contain; background:#fff; border-radius:6px; border:1px dashed rgba(0,0,0,.08); }
.badge-bottom-right.has-img img{ display:block; }

/* å…©å¥èªªæ˜æ›´æ·¡ */
.badge-bottom-right .hint{ opacity:.42; transition:opacity .2s; }
.badge-bottom-right:hover .hint{ opacity:.75; }
.editor[data-empty]{ opacity:.52; } /* placeholder æ›´æ·¡ */

/* é€å‡ºéµï¼šå›ºå®šåœ¨ä¸»é¢æ¿åº•éƒ¨ï¼Œç½®ä¸­ï¼ˆä¸å†æ’å‡ºé é¢æ²å‹•ï¼‰ */
.footer-actions{
  flex:0 0 auto;
  display:flex; justify-content:center; align-items:center;
  padding:8px 0 14px;
}
.primary{
  min-width:180px; height:42px; padding:0 18px;
  background:#fff; border:1px solid var(--rim); border-radius:var(--radius-md);
  font-weight:700; cursor:pointer; box-shadow:var(--shadow-2);
}
.primary:active{ transform:translateY(1px) scale(.99); }

/* ç°½å Modalï¼ˆä¸è®Šï¼‰ */
.overlay{ position:fixed; inset:0; z-index:9999; display:none; align-items:center; justify-content:center; background:rgba(17,24,39,.35); backdrop-filter:blur(3px); }
.overlay.show{ display:flex; }
.dialog{ width:min(92vw,520px); background:var(--soft); border:1px solid var(--rim); border-radius:14px; padding:16px; box-shadow:0 18px 44px rgba(0,0,0,.18); }
.dialog h3{ margin:0 0 10px; font-size:18px; color:#6b5e52; text-align:center; -webkit-text-stroke:0; text-shadow:none; }
#pad{ width:100%; height:260px; background:#fff; border:1px solid #ddd; border-radius:12px; touch-action:none; }
.dlg-actions{ display:flex; gap:10px; justify-content:center; margin-top:12px; }
.dlg-actions button{ width:120px; height:38px; border-radius:10px; border:1px solid var(--rim); background:#fff; cursor:pointer; font-weight:700; }

/* å…¨ç«™é å°¾ï¼ˆä¿æŒå›ºå®šé«˜åº¦ä¸å½±éŸ¿ä¸»é¢æ¿ï¼‰ */
footer{ width:100%; text-align:center; color:#6b5e52; font-size:12px; opacity:.9; position:fixed; left:0; right:0; bottom:4px; pointer-events:none; }
</style>

<body>
  <div class="panel">
    <!-- æ¨™é¡Œåˆ— -->
    <div class="titlebar">
      <h2>é€ä¸Šç¥ç¦</h2>
      <div class="bar">
        <!-- å·¥å…·åˆ—ï¼ˆä¸è¦å‹•å·²ç¢ºèªOKï¼‰ -->
        <div class="toolbar" role="toolbar" aria-label="æ–‡å­—å·¥å…·">
          <button class="tool-btn" id="btnBold"      type="button" title="ç²—é«”">ç²—é«”</button>
          <button class="tool-btn" id="btnItalic"    type="button" title="æ–œé«”">æ–œé«”</button>
          <button class="tool-btn" id="btnUnderline" type="button" title="åº•ç·š">åº•ç·š</button>
          <select id="colorPick" class="tool-select" title="å­—é«”é¡è‰²">
            <option value="" selected>é¡è‰²</option>
            <option value="#0f172a">å¢¨è‰²</option>
            <option value="#a21caf">ç´«</option>
            <option value="#dc2626">ç´…</option>
            <option value="#2563eb">è—</option>
            <option value="#059669">ç¶ </option>
            <option value="#d97706">æ©˜</option>
            <option value="#6b7280">ç°</option>
          </select>
          <button class="tool-btn" id="btnBigger"    type="button" title="æ”¾å¤§">æ”¾å¤§</button>
          <button class="tool-btn" id="btnSmaller"   type="button" title="ç¸®å°">ç¸®å°</button>
        </div>
        <p id="status">å°šæœªåˆå§‹åŒ–</p>
      </div>
    </div>

    <!-- å…§å®¹ -->
    <div class="stage">
      <div class="card" id="card">
        <div class="badge badge-top-left" id="chipBride"><span id="brideLabel">æ–°äººï¼šâ€”</span></div>

        <div class="badge badge-bottom-right" id="chipSign">
          <span class="hint">é»æˆ‘ç°½å</span>
          <img id="signThumb" alt="signature preview" />
        </div>

        <div id="editor" class="editor" contenteditable="true" aria-label="ç¥ç¦å…§å®¹">
          åœ¨æ­¤å¯«ä¸‹ä½ å°æ–°äººçš„ç¥ç¦â€¦ï¼ˆå¯é¸å­—å¾ŒæŒ‰ä¸Šæ–¹çš„ç²—é«”ï¼æ–œé«”ï¼åº•ç·šï¼é¡è‰²ï¼æ”¾å¤§ï¼ç¸®å°ï¼‰ğŸ’
        </div>
      </div>
    </div>

    <!-- å›ºå®šåº•éƒ¨é€å‡ºéµï¼ˆç½®ä¸­ï¼‰ -->
    <div class="footer-actions">
      <button id="btnSubmit" class="primary" type="button">é€å‡ºç¥ç¦</button>
    </div>
  </div>

  <footer>Â© Copyright 2025 MYâ€˜s System</footer>

  <!-- ç°½å Modal -->
  <div id="sigOverlay" class="overlay" role="dialog" aria-modal="true" aria-labelledby="sigTitle">
    <div class="dialog">
      <h3 id="sigTitle">è«‹æ–¼ä¸‹æ–¹ç°½å</h3>
      <canvas id="pad"></canvas>
      <div class="dlg-actions">
        <button id="sigClear"  type="button">æ¸…é™¤</button>
        <button id="sigCancel" type="button">å–æ¶ˆ</button>
        <button id="sigOK"     type="button">ç¢ºå®š</button>
      </div>
    </div>
  </div>

<!-- ====================== JS ====================== -->
<script>
/* åŸºæœ¬è¨­å®š */
const LIFF_ID = '2008149060-m5pDXW6a';
const WEBHOOK = 'https://meiyang0819.github.io/SSS/blessing.html';
const TIMEOUT_MS = 20000;

/* ç‹€æ…‹åˆ— */
function setStatus(m){
  const el=document.getElementById('status');
  el.textContent=m;
  el.classList.remove('ok','busy','err');
  if(/æˆåŠŸ|å·²è¼‰å…¥|å°±ç·’/.test(m)) el.classList.add('ok');
  else if(/é€å‡ºä¸­|ç­‰å¾…|è™•ç†/.test(m)) el.classList.add('busy');
  else if(/å¤±æ•—|é€¾æ™‚|ç„¡æ³•|éŒ¯èª¤/.test(m)) el.classList.add('err');
}

/* LIFF åˆå§‹åŒ–ï¼šæŠ“æ–°äººå */
let lineId='', displayName='', pictureUrl='';
async function initLIFF(){
  if(typeof liff==='undefined'){ setStatus('ï¼ˆæœªè¼‰å…¥ LIFF SDKï¼Œå¯å…ˆæ¸¬æ¨£å¼ï¼‰'); return; }
  try{
    setStatus('åˆå§‹åŒ– LIFFâ€¦');
    await liff.init({ liffId: LIFF_ID, withLoginOnExternalBrowser:true });
    if(!liff.isLoggedIn()){ liff.login({ scope:['openid','profile'] }); return; }
    if(liff.ready) await liff.ready;
    let prof=null, idt=null;
    try{ prof=await liff.getProfile(); }catch(_){}
    try{ idt=liff.getDecodedIDToken(); }catch(_){}
    lineId=(prof&&prof.userId)||(idt&&idt.sub)||'';
    displayName=(prof&&prof.displayName)||(idt&&(idt.name||idt.nickname))||'';
    pictureUrl=(prof&&prof.pictureUrl)||'';
    if(lineId){
      try{
        const r=await fetch(WEBHOOK+'?action=couple&lineId='+encodeURIComponent(lineId),{method:'GET',cache:'no-store'});
        if(r.ok){
          const j=await r.json().catch(()=>null);
          if(j&&j.ok&&j.name){ document.getElementById('brideLabel').textContent='æ–°äººï¼š'+String(j.name||'â€”'); }
        }
      }catch(_){}
    }
    setStatus('å·²å°±ç·’');
  }catch(e){ setStatus('LIFF åˆå§‹åŒ–å¤±æ•—ï¼š'+e.message); }
}

/* å·¥å…·åˆ—ï¼šç²—é«”/æ–œé«”/åº•ç·š/é¡è‰²/æ”¾å¤§ç¸®å° */
const editor=document.getElementById('editor');
function btnExec(cmd){ document.execCommand(cmd,false,null); editor.focus(); }
document.getElementById('btnBold').addEventListener('click',()=>btnExec('bold'));
document.getElementById('btnItalic').addEventListener('click',()=>btnExec('italic'));
document.getElementById('btnUnderline').addEventListener('click',()=>btnExec('underline'));
document.getElementById('colorPick').addEventListener('change',e=>{
  const v=e.target.value; if(v){ document.execCommand('foreColor',false,v); editor.focus(); } e.target.blur();
});

/* æ”¾å¤§/ç¸®å°ï¼šæœ‰é¸å–â†’åŒ… <span>ï¼›ç„¡é¸å–â†’å…¨åŸŸç¸®æ”¾ */
function wrapSelectionWithClass(cls){
  const sel=window.getSelection(); if(!sel.rangeCount) return false;
  const range=sel.getRangeAt(0); if(range.collapsed) return false;
  const span=document.createElement('span'); span.className=cls;
  try{ range.surroundContents(span); }
  catch(_){ const frag=range.extractContents(); span.appendChild(frag); range.insertNode(span); }
  const s2=window.getSelection(); s2.removeAllRanges(); const nr=document.createRange(); nr.setStartAfter(span); nr.collapse(true); s2.addRange(nr);
  editor.focus(); return true;
}
let globalScale=1;
function setGlobalScale(sc){ globalScale=Math.max(0.7,Math.min(1.7,sc)); editor.style.setProperty('--editor-zoom',globalScale+'rem'); }
function stepBigger(){ if(!wrapSelectionWithClass('fs-up-1')) setGlobalScale(globalScale+0.06); }
function stepSmaller(){ if(!wrapSelectionWithClass('fs-down-1')) setGlobalScale(globalScale-0.06); }
document.getElementById('btnBigger').addEventListener('click',stepBigger);
document.getElementById('btnSmaller').addEventListener('click',stepSmaller);

/* å…§æ–‡ placeholder é‚è¼¯ï¼ˆæ›´æ·¡ï¼‰ */
const PLACEHOLDER='åœ¨æ­¤å¯«ä¸‹ä½ å°æ–°äººçš„ç¥ç¦â€¦ï¼ˆå¯é¸å­—å¾ŒæŒ‰ä¸Šæ–¹çš„ç²—é«”ï¼æ–œé«”ï¼åº•ç·šï¼é¡è‰²ï¼æ”¾å¤§ï¼ç¸®å°ï¼‰ğŸ’';
function showPlaceholder(){ editor.setAttribute('data-empty',''); editor.innerHTML=PLACEHOLDER; }
function clearPlaceholderIfNeeded(){
  if(editor.hasAttribute('data-empty')){ editor.innerHTML=''; editor.removeAttribute('data-empty'); editor.style.opacity=1; }
}
editor.addEventListener('focus',clearPlaceholderIfNeeded);
editor.addEventListener('input',clearPlaceholderIfNeeded);
editor.addEventListener('blur',()=>{ const t=editor.textContent.trim(); if(!t){ showPlaceholder(); }});

/* ç°½åï¼ˆæœªç°½ä¸é¡¯ç¤ºç¸®åœ–ï¼‰ */
const sigOverlay=document.getElementById('sigOverlay');
const pad=document.getElementById('pad'); const ctx=pad.getContext('2d');
let drawing=false,lastX=0,lastY=0,signatureDataURL='';
function fitCanvas(){
  const dpr=Math.max(1,window.devicePixelRatio||1), cssW=pad.clientWidth, cssH=pad.clientHeight;
  pad.width=Math.floor(cssW*dpr); pad.height=Math.floor(cssH*dpr);
  ctx.setTransform(dpr,0,0,dpr,0,0); ctx.lineCap='round'; ctx.lineJoin='round'; ctx.lineWidth=3; ctx.strokeStyle='#111'; ctx.clearRect(0,0,cssW,cssH);
}
function openSign(){ sigOverlay.classList.add('show'); setTimeout(fitCanvas,40); }
function closeSign(){ sigOverlay.classList.remove('show'); }
function pos(e){ const r=pad.getBoundingClientRect(); const x=(e.touches?e.touches[0].clientX:e.clientX)-r.left; const y=(e.touches?e.touches[0].clientY:e.clientY)-r.top; return {x,y}; }
function start(e){ drawing=true; const p=pos(e); lastX=p.x; lastY=p.y; e.preventDefault(); }
function move(e){ if(!drawing) return; const p=pos(e); ctx.beginPath(); ctx.moveTo(lastX,lastY); ctx.lineTo(p.x,p.y); ctx.stroke(); lastX=p.x; lastY=p.y; e.preventDefault(); }
function end(){ drawing=false; }
pad.addEventListener('mousedown',start); pad.addEventListener('mousemove',move); pad.addEventListener('mouseup',end); pad.addEventListener('mouseleave',end);
pad.addEventListener('touchstart',start,{passive:false}); pad.addEventListener('touchmove',move,{passive:false}); pad.addEventListener('touchend',end);

document.getElementById('chipSign').addEventListener('click',openSign);
document.getElementById('sigClear').addEventListener('click',fitCanvas);
document.getElementById('sigCancel').addEventListener('click',closeSign);
document.getElementById('sigOK').addEventListener('click',()=>{
  signatureDataURL=pad.toDataURL('image/png');
  const chip=document.getElementById('chipSign'); const img=document.getElementById('signThumb');
  img.src=signatureDataURL; chip.classList.add('has-img'); // âœ… æœ‰åœ–æ‰é¡¯ç¤ºç¸®åœ–
  closeSign();
});

/* é€å‡º */
document.getElementById('btnSubmit').addEventListener('click', async ()=>{
  if(editor.hasAttribute('data-empty')){ alert('è«‹å¯«ä¸‹ç¥ç¦å…§å®¹å”·ï½'); return; }
  const text=editor.innerHTML.trim(); if(!text){ alert('è«‹å¯«ä¸‹ç¥ç¦å…§å®¹å”·ï½'); return; }

  try{
    const ping=await fetch(WEBHOOK+'?action=ping',{method:'GET',cache:'no-store'});
    const t=await ping.text().catch(()=> ''); if(String(t).trim().toLowerCase()!=='ok'){ setStatus('âš ï¸ å¾Œç«¯æœªå›æ‡‰æ­£å¸¸ï¼ˆping='+t+'ï¼‰'); return; }
  }catch(_){ setStatus('âš ï¸ ç„¡æ³•é€£åˆ°å¾Œç«¯ï¼ˆping å¤±æ•—ï¼‰'); return; }

  setStatus('â³ é€å‡ºä¸­â€¦');
  const payload={ action:'createBlessing', lineId, displayName, pictureUrl, contentHTML:text, signaturePNG:signatureDataURL||'', extra:{} };
  const ctl=new AbortController(); const timer=setTimeout(()=>ctl.abort(), TIMEOUT_MS);
  try{
    const r=await fetch(WEBHOOK,{ method:'POST', headers:{'Content-Type':'text/plain;charset=UTF-8'}, body:JSON.stringify(payload), signal:ctl.signal, keepalive:true });
    clearTimeout(timer);
    const ct=(r.headers.get('content-type')||'').toLowerCase(); let j=null;
    if(ct.includes('application/json')) j=await r.json().catch(()=>null); else { const t=await r.text().catch(()=> ''); if(/^\s*\{/.test(t)) try{ j=JSON.parse(t);}catch(_){} }
    if(!j && r.ok) j={ok:true};
    if(j&&j.ok){ setStatus('âœ… ç¥ç¦å·²é€å‡ºæˆåŠŸï¼'); } else { setStatus('âŒ é€å‡ºå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦'); }
  }catch(e){ setStatus('âŒ é€å‡ºé€¾æ™‚æˆ–å¤±æ•—ï¼š'+(e?.message||'')); }
});

/* å•Ÿå‹• */
window.addEventListener('DOMContentLoaded', ()=>{
  setStatus('ç­‰å¾…åˆå§‹åŒ–â€¦');
  showPlaceholder();
  if(window.liff) initLIFF(); else setStatus('å·²å°±ç·’');
});
</script>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</body>
</html>
