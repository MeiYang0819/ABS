<!doctype html>
<html lang="zh-Hant">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>â¤ï¸åŒå¿ƒç¥ˆé¡˜â¤ï¸</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Patrick+Hand:wght@400&family=Sacramento:wght@400;700&display=swap" rel="stylesheet">

<style>
:root{
  --brand-bg:#c9daf8;
  --title:#A68A7C;  --ink:#0f172a; --accent:#A68A7C; --rim:#E4E4E4; --soft:#F5F1EC;
  --panel-grad-from:#b7d2f6; --panel-grad-to:#cfe1fb;

  --panel-maxw:1320px;  --card-maxw:1200px;

  --radius-xl:16px; --radius-md:12px;
  --shadow-1:0 10px 26px rgba(0,0,0,.10);
  --shadow-2:0 2px 0 rgba(0,0,0,.15), 0 2px 8px rgba(0,0,0,.06);

  --content-pad:22px; --editor-zoom:1rem;
  --toolbar-gap:8px; --status-fz:14px; --h2-size:2.8rem;

  --tool-h:36px;                 /* Dear èˆ‡ä¸‰é¡†æŒ‰éˆ•çµ±ä¸€é«˜åº¦ */
  --ctrl-gap:10px;               /* å·¦æ¬„å…§éƒ¨ gap */
  --panel-bottom-gap:14px;       /* ç´…å¡èˆ‡è—åº•ä¿ç•™é–“è· */
}
.bg-notes{position:fixed;inset:0;width:100%;height:100%;object-fit:cover;z-index:0;}
*{box-sizing:border-box;}
html,body{height:100%;margin:0;overflow:hidden;color:var(--ink);background:var(--brand-bg);
  font-family:"Patrick Hand","Noto Sans TC",system-ui,-apple-system,sans-serif;
  -webkit-text-stroke:.35px rgba(0,0,0,.18); text-shadow:0 1px 0 rgba(255,255,255,.65);}

.panel{position:relative;z-index:1;max-width:var(--panel-maxw);
  height:calc(100vh - 110px);margin:26px auto;background:linear-gradient(135deg,var(--panel-grad-from),var(--panel-grad-to));
  border:1px solid var(--rim);border-radius:16px;box-shadow:var(--shadow-1);display:flex;flex-direction:column;overflow:hidden;}
h2{position:relative;left:50%;transform:translateX(-50%);margin:12px 0 6px;text-align:center;width:max-content;max-width:90%;
  font-family:"Sacramento",cursive;font-weight:700;font-size:var(--h2-size);color:var(--title);
  -webkit-text-stroke:.6px rgba(0,0,0,.12);text-shadow:0 3px 4px rgba(255,255,255,.75);}

.bar{padding:6px 22px 8px;}
.bar-inner{max-width:1200px;margin:0 auto;display:flex;align-items:center;gap:12px;}
.toolbar{display:flex;gap:var(--toolbar-gap);}
.tool-btn,.tool-select{min-width:64px;height:var(--tool-h);padding:0 12px;background:#fff;border:1px solid var(--rim);
  border-radius:12px;font-weight:700;display:flex;align-items:center;justify-content:center;gap:6px;box-shadow:var(--shadow-2);}
.tool-select{min-width:auto;padding:0 10px;}
.rolebar{display:flex;gap:var(--toolbar-gap);}
.role-btn{min-width:64px;height:var(--tool-h);padding:0 12px;background:#fff;border:1px solid var(--rim);border-radius:12px;font-weight:700;display:flex;align-items:center;justify-content:center;box-shadow:var(--shadow-2);}
.role-btn.active{outline:2px solid rgba(0,0,0,.15);}
#status{flex:1 1 auto;min-width:240px;background:#F5F1EC;border:1px solid #E4E4E4;border-radius:12px;padding:8px 10px;font-size:14px;text-align:center;color:#A68A7C;font-weight:700;}

.stage{padding:14px 22px var(--panel-bottom-gap);display:flex;justify-content:center;align-items:flex-start;overflow:hidden;flex:1 1 auto;}
.card{position:relative;width:100%;max-width:1200px;border:1px solid rgba(0,0,0,.05);border-radius:16px;box-shadow:0 10px 26px rgba(0,0,0,.08);
  padding:22px;height:calc(100% - var(--panel-bottom-gap));display:grid;grid-template-columns:1fr 2fr;gap:14px;background:#e6b8af;}

/* å·¦æ¬„ */
.left-wrap{position:relative;background:linear-gradient(180deg, rgba(255,242,204,.98), rgba(255,242,204,.92));border-radius:16px;border:1px solid rgba(0,0,0,.05);padding:12px;overflow:hidden;}
.left-content{position:relative;height:100%;}
.chip{position:absolute;min-width:160px;height:var(--tool-h);background:#fff;border:1px solid var(--rim);border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,.06);display:flex;align-items:center;justify-content:center;gap:8px;padding:0 10px;user-select:none;}
#chipBride{top:10px;left:10px;}
#brideLabel{font-weight:800;line-height:1;}
.editor{position:absolute;top:calc(10px + var(--tool-h) + 16px);right:10px;bottom:calc(10px + var(--tool-h) + 56px);left:10px;overflow:auto;line-height:1.8;outline:none;background:transparent;border-radius:12px;padding:14px;font-size:var(--editor-zoom);border:1px dashed rgba(0,0,0,.12);}
.editor[data-empty]{opacity:1;color:rgba(15,23,42,.28);-webkit-text-stroke:0;text-shadow:none;font-style:italic;}
.editor.locked{pointer-events:none;opacity:.85;}
/* ä¸‰é¡†æŒ‰éˆ•åœ¨å…§æ–‡åº•éƒ¨ */
.left-actions{position:absolute;left:10px;right:10px;bottom:10px;height:var(--tool-h);display:flex;gap:var(--ctrl-gap);}
.left-actions>*{flex:1 1 0;height:100%;}
.left-actions button{background:#fff;border:1px solid var(--rim);border-radius:10px;font-weight:800;box-shadow:var(--shadow-2);cursor:pointer;}
.left-actions button:active{transform:translateY(1px) scale(.99);}
#chipSign{display:flex;align-items:center;justify-content:center;cursor:pointer;background:#fff;border:1px solid var(--rim);border-radius:10px;box-shadow:var(--shadow-2);padding:0 8px;font-weight:800;}
#chipSign .hint{font-weight:800;color:rgba(15,23,42,.35);}
#chipSign.locked{pointer-events:none;opacity:.9;}
#signThumb{display:none;width:100%;height:70%;object-fit:contain;}
#chipSign.has-img #signThumb{display:block;}
#chipSign.has-img .hint{display:none;}

.wall-wrap{background:linear-gradient(180deg,#f9e5ee,#f6dce7);border-radius:16px;border:1px solid rgba(0,0,0,.05);padding:12px;overflow:auto;}
.wall{min-height:280px;display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:14px;align-content:start;padding:2px;overflow:visible;}

.overlay{position:fixed;inset:0;z-index:10000;display:none;align-items:center;justify-content:center;background:rgba(17,24,39,.35);backdrop-filter:blur(3px);}
.overlay.show{display:flex;}
.dialog{width:min(92vw,680px);max-height:82vh;background:#F5F1EC;border:1px solid var(--rim);border-radius:14px;padding:16px;box-shadow:0 18px 44px rgba(0,0,0,.18);overflow:auto;}
.dialog h3{margin:0 0 10px;font-size:18px;color:#6b5e52;text-align:center;}
.view-meta{text-align:center;font-size:12px;opacity:.75;margin-bottom:8px;}
.view-content{background:#fff;border:1px solid #ddd;border-radius:12px;padding:12px;line-height:1.8;}
.view-actions{display:flex;gap:10px;justify-content:center;margin-top:12px;}
.view-actions button{min-width:120px;height:var(--tool-h);border-radius:10px;border:1px solid var(--rim);background:#fff;cursor:pointer;font-weight:700;}

#sigOverlay .dialog{width:min(92vw,520px);}
#pad{width:100%;height:260px;background:#fff;border:1px solid #ddd;border-radius:12px;touch-action:none;}
.dlg-actions{display:flex;gap:10px;justify-content:center;margin-top:12px;}
.dlg-actions button{width:120px;height:var(--tool-h);border-radius:10px;border:1px solid var(--rim);background:#fff;cursor:pointer;font-weight:700;}
</style>

<body>
<img class="bg-notes" src="./assets/favos.png?v=4" alt="">
<div class="panel">
  <h2>â¤ï¸åŒå¿ƒç¥ˆé¡˜â¤ï¸</h2>
  <div class="bar">
    <div class="bar-inner">
      <div class="rolebar">
        <button type="button" class="role-btn active" id="roleAll">å…¨éƒ¨</button>
        <button type="button" class="role-btn" id="roleMale">ç”·æ–¹</button>
        <button type="button" class="role-btn" id="roleFemale">å¥³æ–¹</button>
      </div>
      <p id="status">ğŸ“¥ é‚„åœ¨ç­‰å¾…ï¼Œå¾…é€å‡ºè³‡æ–™</p>
    </div>
  </div>

  <div class="stage">
    <div class="card" id="card">
      <section class="left-wrap">
        <div class="left-content">
          <div class="chip" id="chipBride"><span id="brideLabel">Dear â€”</span></div>
          <div class="editor" id="editor" contenteditable="true" aria-label="ç¥ˆé¡˜å…§å®¹" data-empty>
            å¯«ä¸‹ä¸¦ç»ä¸Šæœ€èª æ‘¯çš„ç¥ç¦â€¦ğŸ’
          </div>
          <div class="left-actions">
            <button id="btnEdit" type="button">å†æ¬¡ä¿®æ”¹</button>
            <button id="btnSend" type="button">é€å‡ºç¥ç¦</button>
            <div class="chip" id="chipSign"><span class="hint">ç•«æŠ¼ç°½å</span><img id="signThumb"/></div>
          </div>
        </div>
      </section>
      <section class="wall-wrap"><div class="wall" id="wall"></div></section>
    </div>
  </div>
</div>

<div id="viewOverlay" class="overlay"><div class="dialog"><h3 id="viewTitle">ç¥ç¦å…§å®¹</h3><div class="view-meta" id="viewMeta"></div><div id="viewContent" class="view-content"></div><div class="view-actions"><button id="viewClose">é—œé–‰</button></div></div></div>
<div id="sigOverlay" class="overlay"><div class="dialog"><h3>è«‹æ–¼ä¸‹æ–¹ç•«æŠ¼</h3><canvas id="pad"></canvas><div class="dlg-actions"><button id="sigClear">æ¸…é™¤</button><button id="sigCancel">å–æ¶ˆ</button><button id="sigOK">ç¢ºå®š</button></div></div></div>

<script>
const LIFF_ID='2008149060-m5pDXW6a';
const WEBHOOK='https://script.google.com/macros/s/AKfycby-yPxuPhS9hk-uLLSEZRuEfHqw1r16ND6c_6D2GzoN0XEnu-cWg1DIw_-i2G50YM2t/exec';
const editor=document.getElementById('editor');
let lineId='',displayName='',pictureUrl='',myLastRow=null,signatureDataURL='',alreadySent=false;

function setStatus(m){document.getElementById('status').textContent=m;}
function tzTime(s){return new Date(s).toLocaleString('zh-TW',{timeZone:'Asia/Taipei'});}

async function preloadMyLatest(){/* ...ä¸å‹•ï¼Œç•¥... */}
function lockEditor(){editor.classList.add('locked');editor.setAttribute('contenteditable','false');}
function unlockEditor(){editor.classList.remove('locked');editor.setAttribute('contenteditable','true');editor.focus();}

document.getElementById('btnEdit').onclick=()=>unlockEditor();

async function sendOrUpdate(){
  if(alreadySent) return;
  if(editor.hasAttribute('data-empty')||!editor.textContent.trim()){alert('æ¬¸ï¼Œä¸å¯èƒ½ä¸ç¥ç¦æˆ‘å€‘å§ğŸ–•ï¸');return;}
  if(!document.getElementById('chipSign').classList.contains('has-img')){alert('æ¬¸ï¼Œæ²’æœ‰ç•«æŠ¼ä¸å‡†é›¢é–‹âœï¸');return;}
  alreadySent=true;
  const content=editor.innerHTML.trim();
  const payload={action:'createBlessing',lineId,displayName,pictureUrl,contentHTML:content,signaturePNG:signatureDataURL||'',extra:{}};
  const r=await fetch(WEBHOOK,{method:'POST',headers:{'Content-Type':'text/plain'},body:JSON.stringify(payload)});
  const j=await r.json().catch(()=>null);
  if(j?.ok){lockEditor();document.getElementById('chipSign').classList.add('locked');setStatus('âœ… å·²é€å‡ºä¸¦é–å®š');}
  else setStatus('âŒ é€å‡ºå¤±æ•—');
}
document.getElementById('btnSend').onclick=sendOrUpdate;

function fmtMeta(name,time){return `${name||'â€”'} ï½œ ${tzTime(time)}`;}
function openView(item){document.getElementById('viewMeta').textContent=fmtMeta(item.displayName,item.time);document.getElementById('viewContent').innerHTML=item.contentHTML||'';document.getElementById('viewOverlay').classList.add('show');}
document.getElementById('viewClose').onclick=()=>document.getElementById('viewOverlay').classList.remove('show');
</script>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</body>
</html>
