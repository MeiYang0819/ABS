<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ğŸ’åŒå¿ƒç¥ˆé¡˜</title>
<div class="panel">
  <h2>â¤ï¸åŒå¿ƒç¥ˆé¡˜â¤ï¸</h2>
  <div class="bar">
    <div class="bar-inner">
      <div class="rolebar">
        <button type="button" class="role-btn active" id="roleAll">å…¨éƒ¨</button>
        <button type="button" class="role-btn" id="roleMale">ç”·æ–¹</button>
        <button type="button" class="role-btn" id="roleFemale">å¥³æ–¹</button>
      </div>

      <p id="status">âœ… å¯é€ä¸Šç¥ç¦å›‰ï¼Œé€å‡ºå¾Œè«‹ç¨å¾Œå”·ï¼ŒæˆåŠŸæœƒé€šçŸ¥å‘¢</p>

      <div class="toolbar" role="toolbar" aria-label="æ–‡å­—å·¥å…·">
        <button class="tool-btn" id="btnBold"      type="button">ç²—é«”</button>
        <button class="tool-btn" id="btnItalic"    type="button">æ–œé«”</button>
        <button class="tool-btn" id="btnUnderline" type="button">åº•ç·š</button>

        <select id="colorPick" class="tool-select" title="å­—é«”é¡è‰²">
          <option value="" selected>é¡è‰²</option>
          <option value="#a21caf">å°ç´«</option>
          <option value="#dc2626">å°ç´…</option>
          <option value="#2563eb">å°è—</option>
          <option value="#059669">å°ç¶ </option>
          <option value="#d97706">å°æ©˜</option>
          <option value="#6b7280">å°ç°</option>
        </select>

        <button class="tool-btn" id="btnBigger"    type="button">æ”¾å¤§</button>
        <button class="tool-btn" id="btnSmaller"   type="button">ç¸®å°</button>
      </div>
    </div>
  </div>

  <div class="stage">
    <div class="card" id="card">
      <section class="left-wrap">
        <div class="left-content">
          <div class="chip" id="chipBride" title="Dear "><span id="brideLabel">Dear â€”</span></div>

          <div class="editor" id="editor" contenteditable="true" aria-label="ç¥ˆé¡˜å…§å®¹" data-empty>
            å¯«ä¸‹ä¸¦ç»ä¸Šæœ€èª æ‘¯çš„ç¥ç¦â€¦ğŸ’
          </div>

          <!-- ä¸‰é¡†æŒ‰éˆ•ï¼šå†æ¬¡ä¿®æ”¹ â†’ é€å‡ºç¥ç¦ â†’ ç•«æŠ¼ç°½å -->
          <div class="left-actions">
            <button id="btnEdit"  type="button">å†æ¬¡ä¿®æ”¹</button>
            <button id="btnSend"  type="button">é€å‡ºç¥ç¦</button>
            <div class="chip" id="chipSign" title="é»æ­¤ç°½å">
              <span class="hint">ç•«æŠ¼ç°½å</span>
              <img id="signThumb" alt="signature preview" />
            </div>
          </div>
        </div>
      </section>

      <section class="wall-wrap">
        <div class="wall" id="wall"></div>
      </section>
    </div>
  </div>
</div>

<!-- ç‰ˆæ¬Šï¼ˆæ¢å¾©ï¼‰ -->
<div class="footer-copyright" id="copyright">Â© Copyright 2025 MYâ€˜s System</div>

<!-- æª¢è¦–çª— -->
<div id="viewOverlay" class="overlay" role="dialog" aria-modal="true" aria-labelledby="viewTitle">
  <div class="dialog">
    <h3 id="viewTitle">ç¥ç¦å…§å®¹</h3>
    <div class="view-meta" id="viewMeta"></div>
    <div id="viewContent" class="view-content"></div>
    <div class="view-actions"><button id="viewClose" type="button">é—œé–‰</button></div>
  </div>
</div>

<!-- ç°½å Modal -->
<div id="sigOverlay" class="overlay" role="dialog" aria-modal="true" aria-labelledby="sigTitle">
  <div class="dialog">
    <h3 id="sigTitle">è«‹æ–¼ä¸‹æ–¹ç•«æŠ¼å”·ğŸ˜ˆ</h3>
    <canvas id="pad"></canvas>
    <div class="dlg-actions">
      <button id="sigClear"  type="button">æ¸…é™¤</button>
      <button id="sigCancel" type="button">å–æ¶ˆ</button>
      <button id="sigOK"     type="button">ç¢ºå®š</button>
    </div>
  </div>
</div>

<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script>
  const LIFF_ID='2008149060-m5pDXW6a';
  const WEBHOOK='https://script.google.com/macros/s/AKfycbw1MOPYMbFzxed__pkBCHBM0OcmBlrBshXOKri0Yai6CVKv-EG-AyyunLKD896UOAAo/exec';

  const editor=document.getElementById('editor'); const wallEl=document.getElementById('wall');
  function setStatus(m){ document.getElementById('status').textContent=m; }

  let lineId='',displayName='',pictureUrl='',myLastRow=null,signatureDataURL='',sendInFlight=false,submittedOnce=false;

  function parseSheetTimeToDate(s){
    if(!s) return new Date();
    const m=/^(\d{4})-(\d{2})-(\d{2})[ T](\d{2}):(\d{2}):(\d{2})/.exec(String(s));
    if(m){ return new Date(+m[1],+m[2]-1,+m[3],+m[4],+m[5],+m[6]); }
    const d=new Date(s); return isNaN(d.getTime())?new Date():d;
  }
  function pad2(n){return String(n).padStart(2,'0');}
  function fmtTaipei(s){ const d=parseSheetTimeToDate(s); return d.getFullYear()+'-'+pad2(d.getMonth()+1)+'-'+pad2(d.getDate())+' '+pad2(d.getHours())+':'+pad2(d.getMinutes())+':'+pad2(d.getSeconds()); }

  async function initLIFF(){
    try{
      await liff.init({ liffId: LIFF_ID, withLoginOnExternalBrowser:true });
      if(!liff.isLoggedIn()){ liff.login(); return; }
      await liff.ready;
      const prof=await liff.getProfile(); const idt=liff.getDecodedIDToken();
      lineId=prof.userId||idt.sub||''; displayName=prof.displayName||idt.name||''; pictureUrl=prof.pictureUrl||'';
    }catch(_){}
    await fetchRoleAndNames(); await preloadMyLatest(); await refreshWall();
  }
  async function initialLoad(){ await fetchRoleAndNames(); await refreshWall(); }

  /* ===(1) æ–°äººæ¬„åŠ ä¸Š "Dear " + åŠå½¢ç©ºæ ¼ === */
  async function fetchRoleAndNames(){
    try{
      const j=await (await fetch(WEBHOOK+`?action=userRole&lineId=${encodeURIComponent(lineId||'')}`)).json();
      if(j?.ok){
        const name = j.nameLabel || 'â€”';
        document.getElementById('brideLabel').textContent = 'Dear ' + name; // â† é€™è¡Œæ˜¯æ–°å¢é»
      }
    }catch(_){}
  }

  /* è½‰æ› Google Drive åˆ†äº«é€£çµç‚ºå¯åµŒå…¥çš„ç›´é€£ï¼ˆç¸®åœ–ä¸ç ´ï¼‰ */
  function toDriveDirectUrl(u){
    if(!u) return u;
    try{
      const s=String(u);
      const m1 = s.match(/drive\.google\.com\/file\/d\/([^/]+)/);
      const m2 = s.match(/[?&]id=([^&]+)/);
      const id = m1 ? m1[1] : (m2 ? m2[1] : null);
      return id ? `https://drive.google.com/uc?export=view&id=${id}` : u;
    }catch(_){ return u; }
  }

  /* ===(2) ç°½åç¸®åœ–é¡¯ç¤ºä¿®æ­£ï¼šåªåœ¨è¼‰å…¥æˆåŠŸå¾Œæ‰é¡¯ç¤ºï¼Œä¸¦è™•ç† Drive é€£çµ === */
  async function preloadMyLatest(){
    if(!lineId) return;
    try{
      const j=await (await fetch(WEBHOOK+`?action=getLatestByLineId&lineId=${encodeURIComponent(lineId)}`)).json();
      if(j?.ok && j.item){
        const it=j.item;
        if(it.contentHTML){ editor.innerHTML=it.contentHTML; editor.removeAttribute('data-empty'); lockEditor(); }

        if(it.signature){
          const chip=document.getElementById('chipSign');
          const img=document.getElementById('signThumb');

          let src = String(it.signature||'').trim();
          if(src){
            src = src.startsWith('data:') ? src : toDriveDirectUrl(src);

            // å…ˆæ¸…æ‰ç‹€æ…‹ï¼Œç­‰è¼‰å…¥æˆåŠŸå†é¡¯ç¤º
            chip.classList.remove('has-img','locked');
            img.removeAttribute('src');
            img.removeAttribute('alt');
            img.loading = 'eager';
            img.referrerPolicy = 'no-referrer';

            img.onload = ()=>{ chip.classList.add('has-img'); chip.classList.add('locked'); };
            img.onerror = ()=>{
              const direct = toDriveDirectUrl(src);
              if(img.src !== direct){ img.src = direct; }
              else { chip.classList.remove('has-img','locked'); img.removeAttribute('src'); }
              img.onerror = null;
            };

            if(/^data:/.test(src) || /^https?:\/\//.test(src)){ img.src = src; }
          }
        }

        myLastRow = Number(it.row||0) || null;
      }
    }catch(_){}
  }

  function exec(cmd){ if(editor.hasAttribute('data-empty')||editor.classList.contains('locked')) return; document.execCommand(cmd,false,null); editor.focus(); }
  document.getElementById('btnBold').onclick=()=>exec('bold');
  document.getElementById('btnItalic').onclick=()=>exec('italic');
  document.getElementById('btnUnderline').onclick=()=>exec('underline');
  document.getElementById('colorPick').onchange=e=>{ const v=e.target.value; if(v&&!editor.classList.contains('locked')&&!editor.hasAttribute('data-empty')) document.execCommand('foreColor',false,v); e.target.blur(); };
  let globalScale=1; function setScale(s){globalScale=Math.max(.7,Math.min(1.7,s)); editor.style.setProperty('--editor-zoom',globalScale+'rem');}
  document.getElementById('btnBigger').onclick=()=>setScale(globalScale+.06);
  document.getElementById('btnSmaller').onclick=()=>setScale(globalScale-.06);
  const PLACEHOLDER='å¯«ä¸‹ä¸¦ç»ä¸Šæœ€èª æ‘¯çš„ç¥ç¦â€¦ğŸ’';
  editor.addEventListener('focus',()=>{ if(editor.hasAttribute('data-empty')){ editor.textContent=''; editor.removeAttribute('data-empty'); }});
  editor.addEventListener('blur',()=>{ if(!editor.textContent.trim()){ editor.setAttribute('data-empty',''); editor.textContent=PLACEHOLDER; }});

  /* ç°½åï¼ˆä¿ç•™ä½ çš„æµç¨‹ï¼›æ–°å¢ onload å¾Œæ‰é¡¯ç¤ºç¸®åœ–ï¼‰ */
  const sigOverlay=document.getElementById('sigOverlay'); const pad=document.getElementById('pad'); const ctx=pad.getContext('2d');
  let drawing=false,lastX=0,lastY=0;
  function fitCanvas(){ const dpr=Math.max(1,devicePixelRatio||1),w=pad.clientWidth,h=pad.clientHeight; pad.width=w*dpr; pad.height=h*dpr;
    ctx.setTransform(dpr,0,0,dpr,0,0); ctx.lineCap='round'; ctx.lineJoin='round'; ctx.lineWidth=3; ctx.strokeStyle='#111'; ctx.clearRect(0,0,w,h); }
  function pos(e){ const r=pad.getBoundingClientRect(); const c=e.touches?e.touches[0]:e; return {x:c.clientX-r.left,y:c.clientY-r.top}; }
  function start(e){ drawing=true; const p=pos(e); lastX=p.x; lastY=p.y; e.preventDefault(); }
  function move(e){ if(!drawing)return; const p=pos(e); ctx.beginPath(); ctx.moveTo(lastX,lastY); ctx.lineTo(p.x,p.y); ctx.stroke(); lastX=p.x; lastY=p.y; e.preventDefault(); }
  function end(){ drawing=false; }
  document.getElementById('chipSign').addEventListener('click',()=>{ const chip=document.getElementById('chipSign'); if(chip.classList.contains('locked')) return;
    sigOverlay.classList.add('show'); setTimeout(fitCanvas,40); });
  pad.addEventListener('mousedown',start); pad.addEventListener('mousemove',move); pad.addEventListener('mouseup',end); pad.addEventListener('mouseleave',end);
  pad.addEventListener('touchstart',start,{passive:false}); pad.addEventListener('touchmove',move,{passive:false}); pad.addEventListener('touchend',end);
  document.getElementById('sigClear').onclick=fitCanvas;
  document.getElementById('sigCancel').onclick=()=>sigOverlay.classList.remove('show');
  document.getElementById('sigOK').onclick=()=>{
    requestAnimationFrame(()=>{
      signatureDataURL=pad.toDataURL('image/png');
      const chip=document.getElementById('chipSign'); const img=document.getElementById('signThumb');
      chip.classList.remove('has-img','locked');
      img.onload = ()=>{ chip.classList.add('has-img'); chip.classList.add('locked'); img.onload=null; };
      img.removeAttribute('alt');
      img.loading = 'eager';
      img.src=signatureDataURL;
      sigOverlay.classList.remove('show');
    });
  };

  /* ç‰† */
  function escapeHTML(s){return String(s||'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));}
  function tileTemplate(it){return `<div class="tile" data-row="${it.row||''}" data-owner="${it.lineId||''}">
    <div class="rope"></div><div class="knot"></div>
    <div class="tile-name">${escapeHTML(it.displayName||'â€”')}</div>
    <div class="tile-sep"></div>
    <div class="tile-date">${escapeHTML(fmtTaipei(it.time))}</div>
    <div class="tile-sep"></div>
    <div class="tile-snippet">${escapeHTML((it.preview||'').trim()||'â€”')}</div>
  </div>`;}
  async function refreshWall(){
    try{
      const role=document.querySelector('.role-btn.active')?.id?.replace('role','').toLowerCase()||'all';
      const j=await (await fetch(WEBHOOK+`?action=listblessings&role=${role}`)).json();
      if(j?.ok){ const arr=(j.items||[]).slice().sort((a,b)=>parseSheetTimeToDate(b.time)-parseSheetTimeToDate(a.time)); wallEl.innerHTML=arr.map(tileTemplate).join(''); bindTileClicks(); }
    }catch(_){}
  }
  function bindTileClicks(){ document.querySelectorAll('.tile').forEach(t=>t.addEventListener('click',()=>openView(t))); }
  async function openView(el){
    const row=el.getAttribute('data-row');
    const j=await (await fetch(WEBHOOK+`?action=getBlessingDetail&id=${encodeURIComponent(row)}`)).json();
    if(j?.ok&&j.item){
      document.getElementById('viewMeta').textContent=`${j.item.displayName||'â€”'} ï½œ ${fmtTaipei(j.item.time)}`;
      document.getElementById('viewContent').innerHTML=j.item.contentHTML||'';
      document.getElementById('viewOverlay').classList.add('show');
    }
  }
  document.getElementById('viewClose').onclick=()=>document.getElementById('viewOverlay').classList.remove('show');
  document.getElementById('roleAll').onclick=()=>{document.querySelectorAll('.role-btn').forEach(b=>b.classList.remove('active'));document.getElementById('roleAll').classList.add('active');refreshWall();};
  document.getElementById('roleMale').onclick=()=>{document.querySelectorAll('.role-btn').forEach(b=>b.classList.remove('active'));document.getElementById('roleMale').classList.add('active');refreshWall();};
  document.getElementById('roleFemale').onclick=()=>{document.querySelectorAll('.role-btn').forEach(b=>b.classList.remove('active'));document.getElementById('roleFemale').classList.add('active');refreshWall();};

  /* ç·¨è¼¯/é€å‡ºäº’é–ï¼ˆä¿ç•™ï¼‰ */
  function lockEditor(){editor.classList.add('locked');editor.setAttribute('contenteditable','false');}
  function unlockEditor(){editor.classList.remove('locked');editor.setAttribute('contenteditable','true');editor.focus();}
  document.getElementById('btnEdit').onclick=()=>{ unlockEditor(); submittedOnce=false; const btn=document.getElementById('btnSend'); btn.disabled=false; btn.style.opacity=1; btn.style.pointerEvents='auto'; };
  function hasSignature(){return document.getElementById('chipSign').classList.contains('has-img');}

  async function sendOrUpdate(){
    if(editor.hasAttribute('data-empty')||!editor.textContent.trim()){ alert('æ¬¸ï¼Œä¸å¯èƒ½ä¸ç¥ç¦æˆ‘å€‘å§ğŸ–•ï¸'); return; }
    if(!hasSignature()){ alert('æ¬¸ï¼Œæ²’æœ‰ç•«æŠ¼ä¸å‡†é›¢é–‹âœï¸'); return; }
    if(sendInFlight||submittedOnce){ return; }
    sendInFlight=true;
    const btnSend=document.getElementById('btnSend'); const btnEdit=document.getElementById('btnEdit');
    btnSend.disabled=true; btnSend.style.opacity=.6; btnSend.style.pointerEvents='none';
    btnEdit.disabled=true; btnEdit.style.opacity=.6; btnEdit.style.pointerEvents='none';

    const content=editor.innerHTML.trim();
    const payload = myLastRow
      ? {action:'updateBlessing',row:Number(myLastRow),lineId,contentHTML:content}
      : {action:'createBlessing',lineId,displayName,pictureUrl,contentHTML:content,signaturePNG:signatureDataURL||'',extra:{}};
    try{
      const r=await fetch(WEBHOOK,{method:'POST',headers:{'Content-Type':'text/plain;charset=UTF-8'},body:JSON.stringify(payload)});
      const j=await r.json().catch(()=>null);
      if(j?.ok){
        submittedOnce=true; lockEditor(); await refreshWall(); if(!myLastRow) await preloadMyLatest();
        setStatus(myLastRow?'âœ… å·²æ›´æ–°ä¸¦é–å®šï¼Œæˆªæ­¢æ—¥å‰éƒ½å¯ä»¥ä¿®æ”¹å”·':'âœ… å·²é€å‡ºä¸¦é–å®šï¼Œæˆªæ­¢æ—¥å‰éƒ½å¯ä»¥ä¿®æ”¹å”·');
        btnEdit.disabled=false; btnEdit.style.opacity=1; btnEdit.style.pointerEvents='auto';
      }else if(j?.error==='deadline_passed'){
        setStatus('â›” å·²åˆ°æˆªæ­¢æ—¥ï¼Œç„¡æ³•é€å‡ºåŠç·¨è¼¯'); lockEditor();
      }else{
        setStatus('âŒ é€å‡ºå¤±æ•—ï¼Œç¨å¾Œå†è©¦');
        sendInFlight=false;
        btnSend.disabled=false; btnSend.style.opacity=1; btnSend.style.pointerEvents='auto';
        btnEdit.disabled=false; btnEdit.style.opacity=1; btnEdit.style.pointerEvents='auto';
      }
    }catch(_){
      setStatus('âŒ é€å‡ºå¤±æ•—ï¼Œç¨å¾Œå†è©¦');
      sendInFlight=false;
      btnSend.disabled=false; btnSend.style.opacity=1; btnSend.style.pointerEvents='auto';
      btnEdit.disabled=false; btnEdit.style.opacity=1; btnEdit.style.pointerEvents='auto';
    }
  }
  document.getElementById('btnSend').onclick=sendOrUpdate;

  window.addEventListener('DOMContentLoaded',()=>{
    if(!editor.textContent.trim()){ editor.setAttribute('data-empty',''); editor.textContent='å¯«ä¸‹ä¸¦ç»ä¸Šæœ€èª æ‘¯çš„ç¥ç¦â€¦ğŸ’'; }
    if(window.liff) initLIFF(); else initialLoad();
  });
</script>
    </head> <body> <img class="bg-notes" src="./assets/favors.png?v=4" alt="" />
      <div class="panel">
  <h2>â¤ï¸åŒå¿ƒç¥ˆé¡˜â¤ï¸</h2>

  <div class="bar">
    <div class="bar-inner">
      <div class="rolebar">
        <button type="button" class="role-btn active" id="roleAll">å…¨éƒ¨</button>
        <button type="button" class="role-btn" id="roleMale">ç”·æ–¹</button>
        <button type="button" class="role-btn" id="roleFemale">å¥³æ–¹</button>
      </div>

      <p id="status">âœ… å¯é€ä¸Šç¥ç¦å›‰ï¼Œé€å‡ºå¾Œè«‹ç¨å¾Œå”·ï¼ŒæˆåŠŸæœƒé€šçŸ¥å‘¢</p>

      <div class="toolbar" role="toolbar" aria-label="æ–‡å­—å·¥å…·">
        <button class="tool-btn" id="btnBold"      type="button">ç²—é«”</button>
        <button class="tool-btn" id="btnItalic"    type="button">æ–œé«”</button>
        <button class="tool-btn" id="btnUnderline" type="button">åº•ç·š</button>

        <select id="colorPick" class="tool-select" title="å­—é«”é¡è‰²">
          <option value="" selected>é¡è‰²</option>
          <option value="#a21caf">å°ç´«</option>
          <option value="#dc2626">å°ç´…</option>
          <option value="#2563eb">å°è—</option>
          <option value="#059669">å°ç¶ </option>
          <option value="#d97706">å°æ©˜</option>
          <option value="#6b7280">å°ç°</option>
        </select>

        <button class="tool-btn" id="btnBigger"    type="button">æ”¾å¤§</button>
        <button class="tool-btn" id="btnSmaller"   type="button">ç¸®å°</button>
      </div>
    </div>
  </div>

  <div class="stage">
    <div class="card" id="card">
      <section class="left-wrap">
        <div class="left-content">
          <div class="chip" id="chipBride" title="Dear "><span id="brideLabel">Dear â€”</span></div>

          <div class="editor" id="editor" contenteditable="true" aria-label="ç¥ˆé¡˜å…§å®¹" data-empty>
            å¯«ä¸‹ä¸¦ç»ä¸Šæœ€èª æ‘¯çš„ç¥ç¦â€¦ğŸ’
          </div>

          <!-- ä¸‰é¡†æŒ‰éˆ•ï¼šå†æ¬¡ä¿®æ”¹ â†’ é€å‡ºç¥ç¦ â†’ ç•«æŠ¼ç°½å -->
          <div class="left-actions">
            <button id="btnEdit"  type="button">å†æ¬¡ä¿®æ”¹</button>
            <button id="btnSend"  type="button">é€å‡ºç¥ç¦</button>
            <div class="chip" id="chipSign" title="é»æ­¤ç°½å">
              <span class="hint">ç•«æŠ¼ç°½å</span>
              <img id="signThumb" alt="signature preview" />
            </div>
          </div>
        </div>
      </section>

      <section class="wall-wrap">
        <div class="wall" id="wall"></div>
      </section>
    </div>
  </div>
</div>

<!-- ç‰ˆæ¬Šï¼ˆæ¢å¾©ï¼‰ -->
<div class="footer-copyright" id="copyright">Â© Copyright 2025 MYâ€˜s System</div>

<!-- æª¢è¦–çª— -->
<div id="viewOverlay" class="overlay" role="dialog" aria-modal="true" aria-labelledby="viewTitle">
  <div class="dialog">
    <h3 id="viewTitle">ç¥ç¦å…§å®¹</h3>
    <div class="view-meta" id="viewMeta"></div>
    <div id="viewContent" class="view-content"></div>
    <div class="view-actions"><button id="viewClose" type="button">é—œé–‰</button></div>
  </div>
</div>

<!-- ç°½å Modal -->
<div id="sigOverlay" class="overlay" role="dialog" aria-modal="true" aria-labelledby="sigTitle">
  <div class="dialog">
    <h3 id="sigTitle">è«‹æ–¼ä¸‹æ–¹ç•«æŠ¼å”·ğŸ˜ˆ</h3>
    <canvas id="pad"></canvas>
    <div class="dlg-actions">
      <button id="sigClear"  type="button">æ¸…é™¤</button>
      <button id="sigCancel" type="button">å–æ¶ˆ</button>
      <button id="sigOK"     type="button">ç¢ºå®š</button>
    </div>
  </div>
</div>

<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script>
  const LIFF_ID='2008149060-m5pDXW6a';
  const WEBHOOK='https://script.google.com/macros/s/AKfycbw1MOPYMbFzxed__pkBCHBM0OcmBlrBshXOKri0Yai6CVKv-EG-AyyunLKD896UOAAo/exec';

  const editor=document.getElementById('editor'); const wallEl=document.getElementById('wall');
  function setStatus(m){ document.getElementById('status').textContent=m; }

  let lineId='',displayName='',pictureUrl='',myLastRow=null,signatureDataURL='',sendInFlight=false,submittedOnce=false;

  function parseSheetTimeToDate(s){
    if(!s) return new Date();
    const m=/^(\d{4})-(\d{2})-(\d{2})[ T](\d{2}):(\d{2}):(\d{2})/.exec(String(s));
    if(m){ return new Date(+m[1],+m[2]-1,+m[3],+m[4],+m[5],+m[6]); }
    const d=new Date(s); return isNaN(d.getTime())?new Date():d;
  }
  function pad2(n){return String(n).padStart(2,'0');}
  function fmtTaipei(s){ const d=parseSheetTimeToDate(s); return d.getFullYear()+'-'+pad2(d.getMonth()+1)+'-'+pad2(d.getDate())+' '+pad2(d.getHours())+':'+pad2(d.getMinutes())+':'+pad2(d.getSeconds()); }

  async function initLIFF(){
    try{
      await liff.init({ liffId: LIFF_ID, withLoginOnExternalBrowser:true });
      if(!liff.isLoggedIn()){ liff.login(); return; }
      await liff.ready;
      const prof=await liff.getProfile(); const idt=liff.getDecodedIDToken();
      lineId=prof.userId||idt.sub||''; displayName=prof.displayName||idt.name||''; pictureUrl=prof.pictureUrl||'';
    }catch(_){}
    await fetchRoleAndNames(); await preloadMyLatest(); await refreshWall();
  }
  async function initialLoad(){ await fetchRoleAndNames(); await refreshWall(); }

  /* ===(1) æ–°äººæ¬„åŠ ä¸Š "Dear " + åŠå½¢ç©ºæ ¼ === */
  async function fetchRoleAndNames(){
    try{
      const j=await (await fetch(WEBHOOK+`?action=userRole&lineId=${encodeURIComponent(lineId||'')}`)).json();
      if(j?.ok){
        const name = j.nameLabel || 'â€”';
        document.getElementById('brideLabel').textContent = 'Dear ' + name; // â† é€™è¡Œæ˜¯æ–°å¢é»
      }
    }catch(_){}
  }

  /* è½‰æ› Google Drive åˆ†äº«é€£çµç‚ºå¯åµŒå…¥çš„ç›´é€£ï¼ˆç¸®åœ–ä¸ç ´ï¼‰ */
  function toDriveDirectUrl(u){
    if(!u) return u;
    try{
      const s=String(u);
      const m1 = s.match(/drive\.google\.com\/file\/d\/([^/]+)/);
      const m2 = s.match(/[?&]id=([^&]+)/);
      const id = m1 ? m1[1] : (m2 ? m2[1] : null);
      return id ? `https://drive.google.com/uc?export=view&id=${id}` : u;
    }catch(_){ return u; }
  }

  /* ===(2) ç°½åç¸®åœ–é¡¯ç¤ºä¿®æ­£ï¼šåªåœ¨è¼‰å…¥æˆåŠŸå¾Œæ‰é¡¯ç¤ºï¼Œä¸¦è™•ç† Drive é€£çµ === */
  async function preloadMyLatest(){
    if(!lineId) return;
    try{
      const j=await (await fetch(WEBHOOK+`?action=getLatestByLineId&lineId=${encodeURIComponent(lineId)}`)).json();
      if(j?.ok && j.item){
        const it=j.item;
        if(it.contentHTML){ editor.innerHTML=it.contentHTML; editor.removeAttribute('data-empty'); lockEditor(); }

        if(it.signature){
          const chip=document.getElementById('chipSign');
          const img=document.getElementById('signThumb');

          let src = String(it.signature||'').trim();
          if(src){
            src = src.startsWith('data:') ? src : toDriveDirectUrl(src);

            // å…ˆæ¸…æ‰ç‹€æ…‹ï¼Œç­‰è¼‰å…¥æˆåŠŸå†é¡¯ç¤º
            chip.classList.remove('has-img','locked');
            img.removeAttribute('src');
            img.removeAttribute('alt');
            img.loading = 'eager';
            img.referrerPolicy = 'no-referrer';

            img.onload = ()=>{ chip.classList.add('has-img'); chip.classList.add('locked'); };
            img.onerror = ()=>{
              const direct = toDriveDirectUrl(src);
              if(img.src !== direct){ img.src = direct; }
              else { chip.classList.remove('has-img','locked'); img.removeAttribute('src'); }
              img.onerror = null;
            };

            if(/^data:/.test(src) || /^https?:\/\//.test(src)){ img.src = src; }
          }
        }

        myLastRow = Number(it.row||0) || null;
      }
    }catch(_){}
  }

  function exec(cmd){ if(editor.hasAttribute('data-empty')||editor.classList.contains('locked')) return; document.execCommand(cmd,false,null); editor.focus(); }
  document.getElementById('btnBold').onclick=()=>exec('bold');
  document.getElementById('btnItalic').onclick=()=>exec('italic');
  document.getElementById('btnUnderline').onclick=()=>exec('underline');
  document.getElementById('colorPick').onchange=e=>{ const v=e.target.value; if(v&&!editor.classList.contains('locked')&&!editor.hasAttribute('data-empty')) document.execCommand('foreColor',false,v); e.target.blur(); };
  let globalScale=1; function setScale(s){globalScale=Math.max(.7,Math.min(1.7,s)); editor.style.setProperty('--editor-zoom',globalScale+'rem');}
  document.getElementById('btnBigger').onclick=()=>setScale(globalScale+.06);
  document.getElementById('btnSmaller').onclick=()=>setScale(globalScale-.06);
  const PLACEHOLDER='å¯«ä¸‹ä¸¦ç»ä¸Šæœ€èª æ‘¯çš„ç¥ç¦â€¦ğŸ’';
  editor.addEventListener('focus',()=>{ if(editor.hasAttribute('data-empty')){ editor.textContent=''; editor.removeAttribute('data-empty'); }});
  editor.addEventListener('blur',()=>{ if(!editor.textContent.trim()){ editor.setAttribute('data-empty',''); editor.textContent=PLACEHOLDER; }});

  /* ç°½åï¼ˆä¿ç•™ä½ çš„æµç¨‹ï¼›æ–°å¢ onload å¾Œæ‰é¡¯ç¤ºç¸®åœ–ï¼‰ */
  const sigOverlay=document.getElementById('sigOverlay'); const pad=document.getElementById('pad'); const ctx=pad.getContext('2d');
  let drawing=false,lastX=0,lastY=0;
  function fitCanvas(){ const dpr=Math.max(1,devicePixelRatio||1),w=pad.clientWidth,h=pad.clientHeight; pad.width=w*dpr; pad.height=h*dpr;
    ctx.setTransform(dpr,0,0,dpr,0,0); ctx.lineCap='round'; ctx.lineJoin='round'; ctx.lineWidth=3; ctx.strokeStyle='#111'; ctx.clearRect(0,0,w,h); }
  function pos(e){ const r=pad.getBoundingClientRect(); const c=e.touches?e.touches[0]:e; return {x:c.clientX-r.left,y:c.clientY-r.top}; }
  function start(e){ drawing=true; const p=pos(e); lastX=p.x; lastY=p.y; e.preventDefault(); }
  function move(e){ if(!drawing)return; const p=pos(e); ctx.beginPath(); ctx.moveTo(lastX,lastY); ctx.lineTo(p.x,p.y); ctx.stroke(); lastX=p.x; lastY=p.y; e.preventDefault(); }
  function end(){ drawing=false; }
  document.getElementById('chipSign').addEventListener('click',()=>{ const chip=document.getElementById('chipSign'); if(chip.classList.contains('locked')) return;
    sigOverlay.classList.add('show'); setTimeout(fitCanvas,40); });
  pad.addEventListener('mousedown',start); pad.addEventListener('mousemove',move); pad.addEventListener('mouseup',end); pad.addEventListener('mouseleave',end);
  pad.addEventListener('touchstart',start,{passive:false}); pad.addEventListener('touchmove',move,{passive:false}); pad.addEventListener('touchend',end);
  document.getElementById('sigClear').onclick=fitCanvas;
  document.getElementById('sigCancel').onclick=()=>sigOverlay.classList.remove('show');
  document.getElementById('sigOK').onclick=()=>{
    requestAnimationFrame(()=>{
      signatureDataURL=pad.toDataURL('image/png');
      const chip=document.getElementById('chipSign'); const img=document.getElementById('signThumb');
      chip.classList.remove('has-img','locked');
      img.onload = ()=>{ chip.classList.add('has-img'); chip.classList.add('locked'); img.onload=null; };
      img.removeAttribute('alt');
      img.loading = 'eager';
      img.src=signatureDataURL;
      sigOverlay.classList.remove('show');
    });
  };

  /* ç‰† */
  function escapeHTML(s){return String(s||'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));}
  function tileTemplate(it){return `<div class="tile" data-row="${it.row||''}" data-owner="${it.lineId||''}">
    <div class="rope"></div><div class="knot"></div>
    <div class="tile-name">${escapeHTML(it.displayName||'â€”')}</div>
    <div class="tile-sep"></div>
    <div class="tile-date">${escapeHTML(fmtTaipei(it.time))}</div>
    <div class="tile-sep"></div>
    <div class="tile-snippet">${escapeHTML((it.preview||'').trim()||'â€”')}</div>
  </div>`;}
  async function refreshWall(){
    try{
      const role=document.querySelector('.role-btn.active')?.id?.replace('role','').toLowerCase()||'all';
      const j=await (await fetch(WEBHOOK+`?action=listblessings&role=${role}`)).json();
      if(j?.ok){ const arr=(j.items||[]).slice().sort((a,b)=>parseSheetTimeToDate(b.time)-parseSheetTimeToDate(a.time)); wallEl.innerHTML=arr.map(tileTemplate).join(''); bindTileClicks(); }
    }catch(_){}
  }
  function bindTileClicks(){ document.querySelectorAll('.tile').forEach(t=>t.addEventListener('click',()=>openView(t))); }
  async function openView(el){
    const row=el.getAttribute('data-row');
    const j=await (await fetch(WEBHOOK+`?action=getBlessingDetail&id=${encodeURIComponent(row)}`)).json();
    if(j?.ok&&j.item){
      document.getElementById('viewMeta').textContent=`${j.item.displayName||'â€”'} ï½œ ${fmtTaipei(j.item.time)}`;
      document.getElementById('viewContent').innerHTML=j.item.contentHTML||'';
      document.getElementById('viewOverlay').classList.add('show');
    }
  }
  document.getElementById('viewClose').onclick=()=>document.getElementById('viewOverlay').classList.remove('show');
  document.getElementById('roleAll').onclick=()=>{document.querySelectorAll('.role-btn').forEach(b=>b.classList.remove('active'));document.getElementById('roleAll').classList.add('active');refreshWall();};
  document.getElementById('roleMale').onclick=()=>{document.querySelectorAll('.role-btn').forEach(b=>b.classList.remove('active'));document.getElementById('roleMale').classList.add('active');refreshWall();};
  document.getElementById('roleFemale').onclick=()=>{document.querySelectorAll('.role-btn').forEach(b=>b.classList.remove('active'));document.getElementById('roleFemale').classList.add('active');refreshWall();};

  /* ç·¨è¼¯/é€å‡ºäº’é–ï¼ˆä¿ç•™ï¼‰ */
  function lockEditor(){editor.classList.add('locked');editor.setAttribute('contenteditable','false');}
  function unlockEditor(){editor.classList.remove('locked');editor.setAttribute('contenteditable','true');editor.focus();}
  document.getElementById('btnEdit').onclick=()=>{ unlockEditor(); submittedOnce=false; const btn=document.getElementById('btnSend'); btn.disabled=false; btn.style.opacity=1; btn.style.pointerEvents='auto'; };
  function hasSignature(){return document.getElementById('chipSign').classList.contains('has-img');}

  async function sendOrUpdate(){
    if(editor.hasAttribute('data-empty')||!editor.textContent.trim()){ alert('æ¬¸ï¼Œä¸å¯èƒ½ä¸ç¥ç¦æˆ‘å€‘å§ğŸ–•ï¸'); return; }
    if(!hasSignature()){ alert('æ¬¸ï¼Œæ²’æœ‰ç•«æŠ¼ä¸å‡†é›¢é–‹âœï¸'); return; }
    if(sendInFlight||submittedOnce){ return; }
    sendInFlight=true;
    const btnSend=document.getElementById('btnSend'); const btnEdit=document.getElementById('btnEdit');
    btnSend.disabled=true; btnSend.style.opacity=.6; btnSend.style.pointerEvents='none';
    btnEdit.disabled=true; btnEdit.style.opacity=.6; btnEdit.style.pointerEvents='none';

    const content=editor.innerHTML.trim();
    const payload = myLastRow
      ? {action:'updateBlessing',row:Number(myLastRow),lineId,contentHTML:content}
      : {action:'createBlessing',lineId,displayName,pictureUrl,contentHTML:content,signaturePNG:signatureDataURL||'',extra:{}};
    try{
      const r=await fetch(WEBHOOK,{method:'POST',headers:{'Content-Type':'text/plain;charset=UTF-8'},body:JSON.stringify(payload)});
      const j=await r.json().catch(()=>null);
      if(j?.ok){
        submittedOnce=true; lockEditor(); await refreshWall(); if(!myLastRow) await preloadMyLatest();
        setStatus(myLastRow?'âœ… å·²æ›´æ–°ä¸¦é–å®šï¼Œæˆªæ­¢æ—¥å‰éƒ½å¯ä»¥ä¿®æ”¹å”·':'âœ… å·²é€å‡ºä¸¦é–å®šï¼Œæˆªæ­¢æ—¥å‰éƒ½å¯ä»¥ä¿®æ”¹å”·');
        btnEdit.disabled=false; btnEdit.style.opacity=1; btnEdit.style.pointerEvents='auto';
      }else if(j?.error==='deadline_passed'){
        setStatus('â›” å·²åˆ°æˆªæ­¢æ—¥ï¼Œç„¡æ³•é€å‡ºåŠç·¨è¼¯'); lockEditor();
      }else{
        setStatus('âŒ é€å‡ºå¤±æ•—ï¼Œç¨å¾Œå†è©¦');
        sendInFlight=false;
        btnSend.disabled=false; btnSend.style.opacity=1; btnSend.style.pointerEvents='auto';
        btnEdit.disabled=false; btnEdit.style.opacity=1; btnEdit.style.pointerEvents='auto';
      }
    }catch(_){
      setStatus('âŒ é€å‡ºå¤±æ•—ï¼Œç¨å¾Œå†è©¦');
      sendInFlight=false;
      btnSend.disabled=false; btnSend.style.opacity=1; btnSend.style.pointerEvents='auto';
      btnEdit.disabled=false; btnEdit.style.opacity=1; btnEdit.style.pointerEvents='auto';
    }
  }
  document.getElementById('btnSend').onclick=sendOrUpdate;

  window.addEventListener('DOMContentLoaded',()=>{
    if(!editor.textContent.trim()){ editor.setAttribute('data-empty',''); editor.textContent='å¯«ä¸‹ä¸¦ç»ä¸Šæœ€èª æ‘¯çš„ç¥ç¦â€¦ğŸ’'; }
    if(window.liff) initLIFF(); else initialLoad();
  });
</script>
  </body>
</html>
