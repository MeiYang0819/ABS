//******************************* 同心祈願 + 互動音符 *******************************//
//* 試算表工作表（主本 / 副本結構相同） *//
//*  - guests: A=man(新郎), B=woman(新娘), C=deadline(可選) *//
//*  - logs  : A=time, B=lineId, C=pictureUrl, D=friend(role), *//
//*            E=displayName, F=instruments, G=notes *//
//*  - blessings: *//
//*      A=time, B=lineId, C=displayName, D=pictureUrl, E=role, *//
//*      F=contentHTML(實際存純文字), G=signature, H=signatureType, I=extraJSON *//
//*******************************************************************************//

/** ── 最小化：LINE Verify 專用 ───────────────────────── **/
// ★ 合併為唯一的 doPost：同時滿足 Verify（立即 200）與前端/Webhook 分流
function doPost(e){
  try{
    // 先解析 body（沒有就給空物件）
    var body = {};
    try{ body = JSON.parse(e && e.postData && e.postData.contents || '{}'); }catch(_){ body = {}; }

    // 1) LINE Webhook（互動音符 + 同心祈願入口）
    if (body && Array.isArray(body.events)) {
      return handleLineWebhook_(body); // 直接回 JSON；LINE 只要求 200 即可
    }

    // 2) 前端/LIFF 的 action 分流（維持你原本的流程）
    var act = String(body.action || '').toLowerCase();
    if (act === 'createblessing') return handleCreateBlessing_(body);
    if (act === 'updateblessing') return handleUpdateBlessing_(body);
    if (act === 'submitnotes')    return handleLiffSubmit_(body);

    // 3) 未知情境：仍回 200，避免 Verify 逾時/302
    return J({ok:true});
  }catch(err){
    return J({ok:false, error: String(err)});
  }
}
/** ───────────────────────────────────────────────────── **/

//* ==================== 必改參數（請填你自己的） ==================== *//
const SPREADSHEET_ID_MAIN   = '1loTbnXfQ90AN3tGUdpEsR3AGZUFHvaijBSctOUSZQFs'; // 主本：Google 試算表 ID（必填）
const SPREADSHEET_ID_PUBLIC = '18hxRoLU_TFV6Dc4fNAxQFEv9VAYoSbeVZvfIZ17MHPQ'; // 副本（公開）：Google 試算表 ID（必填）

//* 若你同時用「互動音符」頁，也請在 LINE Bot 的 Script Properties 放入 CHANNEL_TOKEN *//
const LIFF_URL_NOTES        = 'https://liff.line.me/2008149060-ZGVdAvGo';     // 互動音符 LIFF（使用者進入點）
const LIFF_URL_BLESSING     = 'https://liff.line.me/2008149060-Djoe6jKp';     // 同心祈願 LIFF（藍色；使用者進入點）

//* 簽名檔存法：true=存到雲端硬碟並在表寫 URL；false=直接把 base64 存表 *//
const SAVE_SIGNATURE_TO_DRIVE = true;  // true：將簽名圖片存到 Google Drive；false：直接把 base64 文字寫進表
const DRIVE_FOLDER_ID         = '';    // 指定資料夾 ID；留空＝自動建立「Blessing-Signatures」並開放「持連結者可閱」

//* 關鍵字觸發（兩組分開） *//
const KWS_PORTAL_NOTES  = ['互動','音符','🎵']; // 觸發「互動音符」入口的關鍵字陣列
const KWS_PORTAL_BLESS  = ['祝福','祈願','📝']; // 觸發「同心祈願」入口的關鍵字陣列

//* 歡迎音檔（互動音符） *//
const WELCOME_AUDIO_URL = 'https://drive.google.com/file/d/1Voif_FluZuNUMSjVeA6NitAb6skxnnFp/view?usp=drive_link'; // 加好友時要播放的音檔（分享連結或檔案 ID）
/* const WELCOME_AUDIO_URL 也可填「檔案ID」，本檔會自動轉成直連（toDirectDriveUrl_） */
const WELCOME_AUDIO_MS  = 19000; // 播放長度（毫秒），★ 這裡設定為 19 秒

//* 全局截止日（到當日 23:59:59，台北時區） *//
const GLOBAL_DEADLINE_ISO = '2025-10-31'; // 例：2025-10-31 代表當天的 23:59:59 +08:00 會截止

//* Flex 主題（一般 / 祝福 / 提醒） *//
const FLEX_COLORS = { 
  body:'#E4E4E4',    // 內容區背景（一般卡）－顏色可調
  footer:'#E4E4E4',  // 底部區背景（一般卡）－顏色可調
  title:'#0f172a',   // 標題文字色（一般卡）－顏色可調
  accent:'#A68A7C',  // 重點色/邊框色（一般卡）－顏色可調
  linkBg:'#F5F1EC'   // 連結按鈕底色（一般卡）－顏色可調
};

const BLESS_THEME = { 
  body:'#c9daf8',    // 內容區背景（祝福卡）－顏色可調
  footer:'#c9daf8',  // 底部區背景（祝福卡）－顏色可調
  title:'#0f172a',   // 標題文字色（祝福卡）－顏色可調
  text:'#0f172a',    // 內容文字色（祝福卡）－顏色可調
  linkBg:'#F5F1EC'   // 連結按鈕底色（祝福卡）－顏色可調
};

const ALERT_THEME = { 
  body:'#FDE7EA',    // 內容區背景（提醒/警示卡）－顏色可調
  footer:'#FDE7EA',  // 底部區背景（提醒/警示卡）－顏色可調
  title:'#7A1D2A',   // 標題文字色（提醒/警示卡）－顏色可調
  text:'#7A1D2A',    // 內容文字色（提醒/警示卡）－顏色可調
  linkBg:'#FFF1F3'   // 連結按鈕底色（提醒/警示卡）－顏色可調
};

const SHEET_GUESTS   = 'guests';     // 工作表名稱：新人姓名
const SHEET_LOGS     = 'logs';       // 工作表名稱：互動音符紀錄 / 綁定資訊
const SHEET_BLESSING = 'blessings';  // 工作表名稱：同心祈願紀錄

const TZ           = 'Asia/Taipei';             // 伺服器時區設定（台北）
const TIME_FMT     = 'yyyy-MM-dd HH:mm:ss';     // 輸出時間格式
const HEADER_ROWS  = 1;                         // 表頭列數（固定為第 1 列）

const ROLE_MALE_FRIEND   = 'MALE_FRIEND';       // 角色代碼：男方親友
const ROLE_FEMALE_FRIEND = 'FEMALE_FRIEND';     // 角色代碼：女方親友

//* 快捷 *//
const J = (o)=>ContentService.createTextOutput(JSON.stringify(o)).setMimeType(ContentService.MimeType.JSON); // 回傳 JSON
const T = (s)=>ContentService.createTextOutput(String(s||'')).setMimeType(ContentService.MimeType.TEXT);     // 回傳純文字
const nowStr = ()=>Utilities.formatDate(new Date(), TZ, TIME_FMT);                                           // 取得台北時區的現在字串

//* ==================== 工具：Drive 直連轉換（for LINE audio） ==================== *//
//* 將 Google Drive 檔案「預覽/分享」網址或檔案ID → 直連下載網址（uc?export=download&id=...） *//
function toDirectDriveUrl_(urlOrId){ // ★ 將分享連結或檔案 ID 轉為可供 LINE 音訊播放的直連 URL
  const s = String(urlOrId||'').trim();
  if(!s) return '';
  // 若直接給 ID
  if(!/^https?:\/\//i.test(s)){
    return 'https://drive.google.com/uc?export=download&id=' + encodeURIComponent(s); // 由檔案 ID 組直連
  }
  // 一般分享/預覽網址抽 ID
  const m1 = s.match(/\/d\/([A-Za-z0-9_-]{25,})/);     // 匹配 /d/{id}/ 形式
  const m2 = s.match(/[?&]id=([A-Za-z0-9_-]{25,})/);   // 匹配 ?id={id} 形式
  const m3 = s.match(/\/([A-Za-z0-9_-]{25,})(?:[/?#]|$)/); // 其他可能形式
  const id = (m1 && m1[1]) || (m2 && m2[1]) || (m3 && m3[1]) || '';
  return id ? ('https://drive.google.com/uc?export=download&id=' + id) : s; // 有抓到 ID 就轉直連，否則回原字串
}

//* ========== 開表/表頭 ========== *//
function openMain_(){   return SpreadsheetApp.openById(SPREADSHEET_ID_MAIN); }   // 開主本
function openPublic_(){ return SpreadsheetApp.openById(SPREADSHEET_ID_PUBLIC); } // 開副本（公開）

//* ★ 強化：第 1 列若全空 / 長度不符 / 內容不符 → 直接重寫表頭 *//
function ensureHeaderAtRow1_(sh, expectedHeader){
  const last = sh.getLastRow();
  let needWrite = false;

  if (last === 0) { // 尚無任何列
    needWrite = true;
  } else {
    const rng = sh.getRange(1, 1, 1, expectedHeader.length);
    const vals = rng.getValues()[0];
    const allEmpty = vals.every(v => String(v||'').trim() === '');                                // 判斷是否整列空白
    const same = expectedHeader.every((h,i)=> String(vals[i]||'').toLowerCase() === String(h).toLowerCase()); // 判斷表頭是否相同（不分大小寫）
    if (allEmpty || !same) needWrite = true;
  }

  if (needWrite) {
    sh.getRange(1,1,1,expectedHeader.length).setValues([expectedHeader]); // 覆寫第 1 列為期望表頭
  }
}

function ensureLogs_(ss){
  let sh=ss.getSheetByName(SHEET_LOGS); if(!sh) sh=ss.insertSheet(SHEET_LOGS); // 若無 logs 表則建立
  const header=['time','lineId','pictureUrl','friend','displayName','instruments','notes']; // 移除 message 欄（固定 7 欄）
  ensureHeaderAtRow1_(sh, header);
  return sh;
}
function ensureBlessings_(ss){
  let sh=ss.getSheetByName(SHEET_BLESSING); if(!sh) sh=ss.insertSheet(SHEET_BLESSING); // 若無 blessings 表則建立
  const header=['time','lineId','displayName','pictureUrl','role','contentHTML','signature','signatureType','extraJSON']; // A~I 固定（9 欄）
  ensureHeaderAtRow1_(sh, header);
  return sh;
}

//* 讀 guests：回傳新郎/新娘名字 *//
function getGuests_(ss){
  const sh = ss.getSheetByName(SHEET_GUESTS);
  if(!sh) return {man:'',woman:''};
  // 先讀第2列，若無則讀第1列（允許使用者只填第一列）
  const man = String(sh.getRange(2,1).getValue()||sh.getRange(1,1).getValue()||'').trim();
  const woman = String(sh.getRange(2,2).getValue()||sh.getRange(1,2).getValue()||'').trim();
  return {man, woman};
}

//* ========== logs 工具 ========== *//
function findLogRowByLineId_(sh, lineId){
  const last=sh.getLastRow(); if(last<=HEADER_ROWS) return -1; // 無資料
  const vals=sh.getRange(HEADER_ROWS+1,2,last-HEADER_ROWS,1).getValues(); // B 欄（lineId）
  for(let i=0;i<vals.length;i++){ if(String(vals[i][0]||'')===String(lineId)) return i+HEADER_ROWS+1; } // 找到回傳列號
  return -1;
}
function bindLineIdEnsureRow_(ss, lineId, displayName, pictureUrl){
  const sh=ensureLogs_(ss);
  const r=findLogRowByLineId_(sh,lineId);
  if(r===-1){
    sh.appendRow([ nowStr(), lineId, String(pictureUrl||''), '', String(displayName||''), '', '' ]); // 新增一列（7 欄）
  }else{
    const row=sh.getRange(r,1,1,7).getValues()[0]; // 讀原列（7 欄）
    row[0]=nowStr(); row[1]=lineId;
    row[2]=String(pictureUrl||'') ? String(pictureUrl)  : String(row[2]||''); // 有新頭像才覆蓋
    row[4]=String(displayName||'')? String(displayName) : String(row[4]||''); // 有新暱稱才覆蓋
    sh.getRange(r,1,1,7).setValues([row]); // 回寫
  }
}
function alreadySubmitted_(sh,lineId){
  const r=findLogRowByLineId_(sh,lineId); if(r===-1) return false;
  const e=String(sh.getRange(r,6).getValue()||'').trim(); // F=instruments
  const f=String(sh.getRange(r,7).getValue()||'').trim(); // G=notes
  return !!(e||f); // 任一欄有值視為已送出
}
function getRole_(sh,lineId){ const r=findLogRowByLineId_(sh,lineId); if(r===-1) return ''; return String(sh.getRange(r,4).getValue()||'').trim(); } // 讀取角色代碼
function setRole_(sh,lineId,role){ const r=findLogRowByLineId_(sh,lineId); if(r===-1) return; sh.getRange(r,4).setValue(String(role||'')); } // 設定角色代碼
function isFirstInteraction_(sh, lineId){
  const r=findLogRowByLineId_(sh,lineId);
  if(r===-1) return true;
  const role=String(sh.getRange(r,4).getValue()||'').trim();
  const e=String(sh.getRange(r,6).getValue()||'').trim();
  const f=String(sh.getRange(r,7).getValue()||'').trim();
  return !role && !e && !f; // 未設定角色且未送出任何資料，視為第一次互動
}

//* ========== 時間/截止 ========== *//
function getGlobalDeadline_(){ return new Date(GLOBAL_DEADLINE_ISO+'T23:59:59+08:00'); } // 將日期字串補上當日 23:59:59 +08:00
function isExpired_(){ return new Date() > getGlobalDeadline_(); }                              // 判斷是否逾期

//* ========== Flex 工具 ========== *//
function hexToRgb_(hex){ const m=/^#?([a-fA-F0-9]{6})$/.exec((hex||'').trim()); const n=m?parseInt(m[1],16):0xE4E4E4; return {r:(n>>16)&255,g:(n>>8)&255,b:n&255}; } // HEX 轉 RGB
function blendHex_(fgHex,bgHex,alpha){ const f=hexToRgb_(fgHex), b=hexToRgb_(bgHex); const r=Math.round(f.r*alpha+b.r*(1-alpha)), g=Math.round(f.g*alpha+b.g*(1-alpha)), bl=Math.round(f.b*alpha+b.b*(1-alpha)); return '#'+[r,g,bl].map(v=>v.toString(16).padStart(2,'0')).join(''); } // 前景/背景混色
const FLEX_SIZE='kilo', GAP='md', FONT='md'; // Flex 設計定值：尺寸/間距/字級
function buildLinkChip_(uri,label,bgHex){
  return { type:'box', layout:'horizontal', contents:[
    { type:'filler', flex:19 },
    { type:'box', layout:'vertical', flex:62, backgroundColor:bgHex, cornerRadius:'18px',
      borderColor:FLEX_COLORS.accent, borderWidth:'1px', paddingTop:'12px', paddingBottom:'12px', paddingStart:'18px', paddingEnd:'18px',
      action:{ type:'uri', uri:String(uri) },
      contents:[{ type:'text', text:String(label||'🛎️ 點我點我'), size:FONT, weight:'bold', color:FLEX_COLORS.accent, align:'center', wrap:true }] }
    ,
    { type:'filler', flex:19 }
  ]};
}
function buildThemedTextCard_(lines, theme){
  const sep=blendHex_(theme.text||'#0f172a', theme.body||'#E4E4E4', .5);
  return { type:'flex', altText:'通知', contents:{
    type:'bubble', size:FLEX_SIZE, styles:{body:{backgroundColor:theme.body},footer:{backgroundColor:theme.footer}},
    body:{ type:'box', layout:'vertical', paddingAll:'15px', spacing:GAP, contents:[
      { type:'text', text:'🤵🏻新人👰🏻‍♀️', weight:'bold', size:'lg', color:theme.title, align:'center', wrap:true },
      { type:'separator', color:sep, margin:'md' },
      ...lines.map((t,i)=>({ type:'text', text:t, size:'md', weight:'bold', color:theme.text||theme.accent||'#0f172a', align:'center', wrap:true, margin:i===0?'md':GAP }))
    ]}
  }};
}
function buildCard_Entrance_(roleLabel){
  return { type:'flex', altText:'🛎️ 點我點我', contents:{
    type:'bubble', size:FLEX_SIZE,
    styles:{ body:{backgroundColor:FLEX_COLORS.body}, footer:{backgroundColor:FLEX_COLORS.footer} },
    body:{ type:'box', layout:'vertical', paddingAll:'15px', spacing:GAP, contents:[
      { type:'text', text:'🤵🏻新人👰🏻‍♀️', weight:'bold', size:'lg', color:FLEX_COLORS.title, align:'center', wrap:true },
      { type:'separator', color:blendHex_(FLEX_COLORS.accent,FLEX_COLORS.body,.5), margin:'md' },
      { type:'text', text:`親愛的${roleLabel}親友👋`, size:'md', weight:'bold', color:FLEX_COLORS.accent, align:'center', wrap:true, margin:'md' },
      { type:'text', text:'快快點連結來玩耍👣',      size:'md', weight:'bold', color:FLEX_COLORS.accent, align:'center', wrap:true, margin:GAP }
    ]},
    footer:{ type:'box', layout:'vertical', contents:[ buildLinkChip_(LIFF_URL_NOTES,'🛎️ 點我點我', FLEX_COLORS.linkBg) ], backgroundColor:FLEX_COLORS.footer }
  }};
}
function buildCard_BlessingEntrance_(roleLabel){
  return { type:'flex', altText:'🔔 選我選我', contents:{
    type:'bubble', size:FLEX_SIZE,
    styles:{ body:{backgroundColor:BLESS_THEME.body}, footer:{backgroundColor:BLESS_THEME.footer} },
    body:{ type:'box', layout:'vertical', paddingAll:'15px', spacing:GAP, contents:[
      { type:'text', text:'🤵🏻新人👰🏻‍♀️', weight:'bold', size:'lg', color:BLESS_THEME.title, align:'center', wrap:true },
      { type:'separator', color:blendHex_(BLESS_THEME.text,BLESS_THEME.body,.5), margin:'md' },
      { type:'text', text:`親愛的${roleLabel}親友👋`, size:'md', weight:'bold', color:BLESS_THEME.text, align:'center', wrap:true, margin:'md' },
      { type:'text', text:'快快點連結來告白📣',       size:'md', weight:'bold', color:BLESS_THEME.text, align:'center', wrap:true, margin:GAP }
    ]},
    footer:{ type:'box', layout:'vertical', contents:[ buildLinkChip_(LIFF_URL_BLESSING,'🔔 選我選我', BLESS_THEME.linkBg) ], backgroundColor:BLESS_THEME.footer }
  }};
}
function buildCard_RoleSelect_(){
  return { type:'flex', altText:'嗨嗨，你/妳是...我的', contents:{
    type:'bubble', size:FLEX_SIZE,
    styles:{ body:{backgroundColor:'#FFF7D6'}, footer:{backgroundColor:FLEX_COLORS.footer} },
    body:{ type:'box', layout:'vertical', paddingAll:'15px', spacing:GAP, contents:[
      { type:'text', text:'嗨嗨，你/妳是...我的', weight:'bold', size:'lg', color:FLEX_COLORS.title, align:'center' },
      { type:'box', layout:'horizontal', spacing:'md', margin:'lg', contents:[
        { type:'box', layout:'vertical', flex:1, backgroundColor:FLEX_COLORS.linkBg, cornerRadius:'18px', borderColor:FLEX_COLORS.accent, borderWidth:'1px',
          paddingAll:'12px', action:{ type:'postback', data:'role=male', displayText:'🤵🏻親友' },
          contents:[{ type:'text', text:'🤵🏻親友', size:'md', weight:'bold', color:FLEX_COLORS.accent, align:'center' }] }
        ,
        { type:'box', layout:'vertical', flex:1, backgroundColor:FLEX_COLORS.linkBg, cornerRadius:'18px', borderColor:FLEX_COLORS.accent, borderWidth:'1px',
          paddingAll:'12px', action:{ type:'postback', data:'role=female', displayText:'👰🏻‍♀️親友' },
          contents:[{ type:'text', text:'👰🏻‍♀️親友', size:'md', weight:'bold', color:FLEX_COLORS.accent, align:'center' }] }
      ]}
    ]}
  }};
}
function buildCard_Reminder_(){
  return buildThemedTextCard_(['📍提醒📍','因後台資料過於龐大','回覆會有點略慢出來','再麻煩親友們多擔待'], ALERT_THEME); // 提醒用卡片
}
function buildCard_NoticeBusy_(){
  return buildThemedTextCard_(['📍通知📍','管理員正在忙碌中','他看到會立即回覆','還請親友多多包涵'], ALERT_THEME); // 忙碌通知卡
}
function buildCard_NotBound_(){
  return buildThemedTextCard_(['📍提示📍','目前尚未選擇哪方','輸入開始進行綁定','完成後再點連結唷'], ALERT_THEME); // 尚未綁定提醒卡
}

//* ========== LINE API ========== *//
function replyFlex_(token, replyToken, flex){ const url='https://api.line.me/v2/bot/message/reply'; const payload={replyToken,messages:[flex]}; const opt={method:'post',contentType:'application/json',headers:{Authorization:'Bearer '+token},payload:JSON.stringify(payload),muteHttpExceptions:true}; try{UrlFetchApp.fetch(url,opt);}catch(_){} } // 回覆單一 Flex 訊息
function replyAudio_(token, replyToken, audioUrl, duration){ const url='https://api.line.me/v2/bot/message/reply'; const payload={replyToken,messages:[{type:'audio',originalContentUrl:String(audioUrl),duration:Number(duration)||1000}]}; const opt={method:'post',contentType:'application/json',headers:{Authorization:'Bearer '+token},payload:JSON.stringify(payload),muteHttpExceptions:true}; try{UrlFetchApp.fetch(url,opt);}catch(_){} } // 回覆音訊
function replyMulti_(token, replyToken, messages){ const url='https://api.line.me/v2/bot/message/reply'; const payload={replyToken,messages}; const opt={method:'post',contentType:'application/json',headers:{Authorization:'Bearer '+token},payload:JSON.stringify(payload),muteHttpExceptions:true}; try{UrlFetchApp.fetch(url,opt);}catch(_){} } // 回覆多則訊息
function fetchUserProfile_(channelToken, userId){
  if(!channelToken||!userId) return {displayName:'',pictureUrl:''};
  const url='https://api.line.me/v2/bot/profile/'+encodeURIComponent(userId);
  const opt={method:'get',headers:{Authorization:'Bearer '+channelToken},muteHttpExceptions:true};
  try{ const r=UrlFetchApp.fetch(url,opt); if(r.getResponseCode()===200){ const j=JSON.parse(r.getContentText()||'{}'); return {displayName:String(j.displayName||''), pictureUrl:String(j.pictureUrl||'')} } }catch(_){}
  return {displayName:'', pictureUrl:''};
}

//* ========== Web 入口 ========== *//
function doGet(e){
  const p=e?.parameter||{}; const action=String(p.action||'').toLowerCase();
  if(action==='ping')    return T('ok'); // 健康檢查

  if(action==='couple'){ // 取得新人名字（合併顯示）
    const {man,woman}=getGuests_(openMain_());
    return J({ok:!!(man||woman), name: (man && woman) ? `${man} & ${woman}` : (man||woman||'') });
  }

  // 角色 + 新郎/新娘姓名（供前端替換 A&B）
  if(action==='userrole'){
    const ssM=openMain_(); const shLogs=ensureLogs_(ssM); const guests=getGuests_(ssM);
    const lineId=String(p.lineId||'').trim();
    let role=''; if(lineId) role=getRole_(shLogs,lineId)||'';
    let nameLabel='—';
    if(role===ROLE_MALE_FRIEND && guests.man) nameLabel=guests.man;
    else if(role===ROLE_FEMALE_FRIEND && guests.woman) nameLabel=guests.woman;
    else if(guests.man||guests.woman) nameLabel=[guests.man,guests.woman].filter(Boolean).join(' & ')||'—';
    return J({ok:true, role, man:guests.man||'', woman:guests.woman||'', nameLabel});
  }

  // 同心祈願：列表（支援 role 篩選，內部已時間倒序）
  if(action==='listblessings'){
    const role=(String(p.role||'all').toLowerCase());
    const data=listBlessings_(); // ★ 內部已時間倒序
    const filtered = role==='all' ? data :
      data.filter(x=> String(x.role||'').toLowerCase().includes(role==='male'?'male':'female'));
    return J({ok:true, items:filtered});
  }

  // 同心祈願：明細（以 row id 讀取）
  if(action==='getblessingdetail'){
    const id = Math.max(2, Number(p.id||0)); // 第2列起（跳過表頭）
    const sh = ensureBlessings_(openMain_());
    const last = sh.getLastRow();
    if(id>last) return J({ok:false,error:'not_found'});
    const r = sh.getRange(id,1,1,9).getValues()[0];
    return J({ok:true, item:{
      row:id, time:r[0], lineId:r[1], displayName:r[2], pictureUrl:r[3],
      role:r[4], contentHTML:r[5], signature:r[6], signatureType:r[7], extra:r[8]
    }});
  }

  // 依 lineId 取該使用者「最新一筆」
  if(action==='getlatestbylineid'){
    const sh = ensureBlessings_(openMain_());
    const lineId = String(p.lineId||'').trim();
    if(!lineId) return J({ok:false});
    const last = sh.getLastRow(); if(last<=HEADER_ROWS) return J({ok:true, item:null});
    const vals = sh.getRange(HEADER_ROWS+1,1,last-HEADER_ROWS,9).getValues();
    let bestIdx=-1,bestTime=0;
    for(let i=0;i<vals.length;i++){
      const row=vals[i];
      if(String(row[1]||'')===lineId){
        const t = new Date(row[0]||'').getTime()||0;
        if(t>=bestTime){ bestTime=t; bestIdx=i; }
      }
    }
    if(bestIdx<0) return J({ok:true, item:null});
    const r=vals[bestIdx]; const rowNo=bestIdx+HEADER_ROWS+1;
    return J({ok:true, item:{
      row:rowNo, time:r[0], lineId:r[1], displayName:r[2], pictureUrl:r[3],
      role:r[4], contentHTML:r[5], signature:r[6], signatureType:r[7], extra:r[8]
    }});
  }

  return T('ok'); // 預設回應
}

//* 小工具：由 userId 取得 roleLabel（男方/女方），無則回空字串 *//
function getRoleLabelByUser_(shLogs, userId){
  const code = getRole_(shLogs, userId);
  if(code===ROLE_FEMALE_FRIEND) return '女方';
  if(code===ROLE_MALE_FRIEND)   return '男方';
  return '';
}
function getRoleLabelOrDefault_(shLogs, userId){
  return getRoleLabelByUser_(shLogs, userId) || '男方/女方';
}

function doPost_real(e){
  let body={}; try{ body=JSON.parse(e?.postData?.contents||'{}'); }catch(_){ body={}; }

  // 1) LINE Webhook（互動音符 + 同心祈願入口）
  if(body && Array.isArray(body.events)) return handleLineWebhook_(body);

  // 2) 同心祈願：新增
  const act=String(body.action||'').toLowerCase();
  if(act==='createblessing') return handleCreateBlessing_(body);

  // 3) 同心祈願：更新（截止日前）
  if(act==='updateblessing') return handleUpdateBlessing_(body);

  // 4) 互動音符 LIFF 送單（保留）
  if(act==='submitnotes')    return handleLiffSubmit_(body);

  return J({ok:false, error:'unknown_action'}); // 未知指令
}

//* ========== Webhook（互動音符 + 同心祈願入口） ========== *//
function handleLineWebhook_(body){
  const events=body.events||[];
  const ssM=openMain_(); const ssP=openPublic_();
  const shM=ensureLogs_(ssM); const shP=ensureLogs_(ssP);
  const channelToken=(PropertiesService.getScriptProperties().getProperty('CHANNEL_TOKEN')||'').trim(); // 從 Script Properties 讀取 LINE Bot token

  events.forEach(ev=>{
    try{
      const userId=ev.source?.userId||''; if(!userId) return;

      if(ev.type==='follow'){ // 使用者加好友
        if(channelToken){
          const prof=fetchUserProfile_(channelToken,userId);
          bindLineIdEnsureRow_(ssM,userId,prof.displayName,prof.pictureUrl); // 主本綁定/更新
          bindLineIdEnsureRow_(ssP,userId,prof.displayName,prof.pictureUrl); // 副本綁定/更新

          // ★ 將 Google Drive 頁面網址轉為「直連」以符合 LINE audio 要求
          const playable = toDirectDriveUrl_(WELCOME_AUDIO_URL);
          replyAudio_(channelToken, ev.replyToken, playable, WELCOME_AUDIO_MS); // 回傳音檔
        }
        return;
      }

      if(ev.type==='postback'){ // 角色選擇（男/女方）
        const data=String(ev.postback?.data||'');

        /* ★ 先 ensure logs 這個使用者存在（避免 setRole_ 找不到列） */
        if(channelToken){
          const prof=fetchUserProfile_(channelToken,userId);
          bindLineIdEnsureRow_(ssM,userId,prof.displayName,prof.pictureUrl);
          bindLineIdEnsureRow_(ssP,userId,prof.displayName,prof.pictureUrl);
        }else{
          bindLineIdEnsureRow_(ssM,userId,'','');
          bindLineIdEnsureRow_(ssP,userId,'','');
        }

        if(/role=male/.test(data)){   setRole_(shM,userId,ROLE_MALE_FRIEND);   setRole_(shP,userId,ROLE_MALE_FRIEND); }      // 設為男方親友
        else if(/role=female/.test(data)){ setRole_(shM,userId,ROLE_FEMALE_FRIEND); setRole_(shP,userId,ROLE_FEMALE_FRIEND); } // 設為女方親友

        if(channelToken){
          const roleLabel = getRoleLabelByUser_(shM, userId);
          replyMulti_(channelToken, ev.replyToken, [
            buildCard_Reminder_(),             // 提醒卡
            buildCard_Entrance_(roleLabel),    // 互動音符入口
            buildCard_BlessingEntrance_(roleLabel) // 同心祈願入口
          ]);
        }
        return;
      }

      if(ev.type==='message' && ev.message?.type==='text'){ // 使用者傳文字
        const raw=String(ev.message.text||'').trim();

        if(!channelToken) return;

        if(['親友','新郎','新娘'].some(k=>raw.includes(k))){ // 關鍵字：叫出角色選單
          replyFlex_(channelToken, ev.replyToken, buildCard_RoleSelect_());
          return;
        }

        if(raw.includes('📡')){ // 忙碌小鈴鐺
          replyFlex_(channelToken, ev.replyToken, buildCard_NoticeBusy_());
          return;
        }

        if(raw==='開始'){ // 主動引導：若未綁定，先選角色；已綁則丟三卡
          const roleLabel = getRoleLabelByUser_(shM, userId);
          if(!roleLabel){
            replyFlex_(channelToken, ev.replyToken, buildCard_RoleSelect_());
          }else{
            replyMulti_(channelToken, ev.replyToken, [
              buildCard_Reminder_(),
              buildCard_Entrance_(roleLabel),
              buildCard_BlessingEntrance_(roleLabel)
            ]);
          }
          return;
        }

        if(KWS_PORTAL_NOTES.some(k=>raw.includes(k))){ // 關鍵字進入 互動音符
          const roleLabel = getRoleLabelByUser_(shM, userId);
          if(!roleLabel){
            replyFlex_(channelToken, ev.replyToken, buildCard_NotBound_()); // 尚未綁定提醒
          }else{
            replyFlex_(channelToken, ev.replyToken, buildCard_Entrance_(roleLabel));
          }
          return;
        }

        if(KWS_PORTAL_BLESS.some(k=>raw.includes(k))){ // 關鍵字進入 同心祈願
          const roleLabel = getRoleLabelByUser_(shM, userId);
          if(!roleLabel){
            replyFlex_(channelToken, ev.replyToken, buildCard_NotBound_()); // 尚未綁定提醒
          }else{
            replyFlex_(channelToken, ev.replyToken, buildCard_BlessingEntrance_(roleLabel));
          }
          return;
        }

        return;
      }
    }catch(_){}
  });

  return J({status:'ok'}); // Webhook 統一回覆
}

//* ========== 互動音符 – LIFF 送單（保留） ========== *//
function handleLiffSubmit_(body){
  const ssM=openMain_(); const ssP=openPublic_();
  const shM=ensureLogs_(ssM); const shP=ensureLogs_(ssP);

  const lineId=String(body.lineId||'').trim();             // 使用者 ID（LIFF profile）
  const displayName=String(body.displayName||'').trim();   // 使用者暱稱
  const pictureUrl=String(body.pictureUrl||'').trim();     // 頭像 URL
  const instruments=String(body.instrumentsCSV||'').trim();// 樂器選擇（CSV）
  const notes=String(body.notesCSV||'').trim();            // 三音（CSV）
  // const msg=String(body.extraMessage||'').trim(); // ✂ 已停用，不再存表
  if(!lineId) return J({ok:false,error:'missing_line_id'});

  bindLineIdEnsureRow_(ssM,lineId,displayName,pictureUrl); // 主本確保綁定
  bindLineIdEnsureRow_(ssP,lineId,displayName,pictureUrl); // 副本確保綁定

  if(isExpired_())                  return J({ok:false,error:'deadline_passed'}); // 逾期
  if(alreadySubmitted_(shM,lineId)) return J({ok:false,error:'duplicate'});       // 重複送出

  let roleM=getRole_(shM,lineId), roleP=getRole_(shP,lineId);

  const rM=findLogRowByLineId_(shM,lineId);
  if(rM===-1) shM.appendRow([nowStr(),lineId,pictureUrl,roleM,displayName,instruments,notes]); // 新增
  else        shM.getRange(rM,1,1,7).setValues([[nowStr(),lineId,pictureUrl,roleM,displayName,instruments,notes]]); // 覆寫該列

  const rP=findLogRowByLineId_(shP,lineId);
  if(rP===-1) shP.appendRow([nowStr(),lineId,pictureUrl,roleP,displayName,instruments,notes]); // 新增（副本）
  else        shP.getRange(rP,1,1,7).setValues([[nowStr(),lineId,pictureUrl,roleP,displayName,instruments,notes]]); // 覆寫該列（副本）

  return J({ok:true});
}

//* ========== 同心祈願 – 新增/更新（主本＋副本，純文字儲存） ========== *//
function stripHtml_(html){ return String(html||'').replace(/<[^>]+>/g,''); } // 去除 HTML 標籤，保留純文字

function handleCreateBlessing_(body){
  const ssM = openMain_();
  const ssP = openPublic_();
  const shM = ensureBlessings_(ssM);
  const shP = ensureBlessings_(ssP);
  const shLogsM = ensureLogs_(ssM);

  const lineId      = String(body.lineId||'').trim();        // 使用者 ID
  const displayName = String(body.displayName||'').trim();   // 暱稱
  const pictureUrl  = String(body.pictureUrl||'').trim();    // 頭像
  const contentHTML = String(body.contentHTML||'').trim();   // 來自前端的內容（視覺 HTML）
  const contentPlain= stripHtml_(contentHTML);               // ⭐ 實際存純文字
  const signature   = String(body.signaturePNG||'').trim();  // 簽名（dataURL）
  const extra       = JSON.stringify(body.extra||{});        // 其他附加欄位（JSON）

  if(!lineId)       return J({ok:false,error:'missing_line_id'});
  if(!contentPlain) return J({ok:false,error:'missing_content'});
  if(isExpired_())  return J({ok:false,error:'deadline_passed'});

  const role = getRole_(shLogsM, lineId) || ''; // 從 logs 讀取使用者角色

  let sigVal = '', sigType = 'none';
  if(signature){
    if(SAVE_SIGNATURE_TO_DRIVE){
      const url = saveSignatureToDrive_(signature, lineId, displayName); // 存到 Drive，回傳分享連結
      sigVal = url; sigType='drive';
    }else{
      sigVal = signature; sigType='base64'; // 直接存 base64
    }
  }

  const rowData = [ nowStr(), lineId, displayName, pictureUrl, role, contentPlain, sigVal, sigType, extra ];
  shM.appendRow(rowData); // 主本新增
  shP.appendRow(rowData); // 副本同步新增
  return J({ok:true});
}

function handleUpdateBlessing_(body){
  const ssM = openMain_();
  const ssP = openPublic_();
  const shM = ensureBlessings_(ssM);
  const shP = ensureBlessings_(ssP);

  const row = Number(body.row||0);                 // 指定要更新的列（主本）
  const lineId = String(body.lineId||'').trim();   // 檢查權限用
  const contentHTML = String(body.contentHTML||'').trim();
  const contentPlain= stripHtml_(contentHTML);     // ⭐ 實際存純文字
  if(!row || !lineId || !contentPlain) return J({ok:false,error:'missing_params'});
  if(isExpired_()) return J({ok:false,error:'deadline_passed'});

  const recM = shM.getRange(row,1,1,9).getValues()[0]; // 讀主本該列資料
  const ownerM = String(recM[1]||'').trim();
  if(ownerM!==lineId) return J({ok:false,error:'forbidden'}); // 僅本人可改

  const cellM=shM.getRange(row,6); // F=contentHTML(實際存純文字)
  const oldHtmlM=cellM.getValue(); const oldNoteM=cellM.getNote();
  const newNoteM = `${nowStr()} 舊內容：\n${stripHtml_(oldHtmlM)}${oldNoteM?('\n\n'+oldNoteM):''}`.slice(0,5000); // 舊內容寫入備註（保留歷程）
  cellM.setNote(newNoteM);
  cellM.setValue(contentPlain);
  shM.getRange(row,1).setValue(nowStr()); // 更新時間

  const rP = findLatestBlessingRowByLineId_(shP, lineId); // 找副本中該使用者的最新一筆
  if(rP>0){
    const cellP=shP.getRange(rP,6);
    const oldHtmlP=cellP.getValue(); const oldNoteP=cellP.getNote();
    const newNoteP=`${nowStr()} 舊內容：\n${stripHtml_(oldHtmlP)}${oldNoteP?('\n\n'+oldNoteP):''}`.slice(0,5000);
    cellP.setNote(newNoteP);
    cellP.setValue(contentPlain);
    shP.getRange(rP,1).setValue(nowStr()); // 更新時間（副本）
  }

  return J({ok:true});
}

function findLatestBlessingRowByLineId_(sh, lineId){
  const last=sh.getLastRow(); if(last<=HEADER_ROWS) return -1;
  const vals=sh.getRange(HEADER_ROWS+1,1,last-HEADER_ROWS,9).getValues();
  let bestRow=-1, bestTime=0;
  for(let i=0;i<vals.length;i++){
    const r=vals[i];
    if(String(r[1]||'').trim()===lineId){
      const t = new Date(r[0]||'').getTime()||0;
      const rowNum = i+HEADER_ROWS+1;
      if(t>=bestTime){ bestTime=t; bestRow=rowNum; }
    }
  }
  return bestRow; // 回傳該使用者最新一筆所在列（找不到回 -1）
}

//* ========== 簽名 → Drive ========== *//
function saveSignatureToDrive_(dataUrl, lineId, displayName){
  const m = /^data:image\/(png|jpeg);base64,([A-Za-z0-9+/=]+)$/.exec(String(dataUrl||'')); if(!m) return ''; // 僅接受 png/jpeg dataURL
  const ext = m[1]==='jpeg'?'jpg':m[1]; // 副檔名
  const bytes = Utilities.base64Decode(m[2]); // 轉成位元組
  const blob = Utilities.newBlob(bytes, 'image/'+(ext==='jpg'?'jpeg':ext), `sign_${lineId||'anon'}_${Date.now()}.${ext}`); // 建立 blob 檔案

  let folder = null;
  if(DRIVE_FOLDER_ID){
    try{ folder = DriveApp.getFolderById(DRIVE_FOLDER_ID); }catch(_){}
  }
  if(!folder){
    const it = DriveApp.getFoldersByName('Blessing-Signatures'); // 以名稱尋找
    folder = it.hasNext()? it.next() : DriveApp.createFolder('Blessing-Signatures'); // 沒有就建立
  }

  const file = folder.createFile(blob);            // 上傳檔案
  try{ file.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW); }catch(_){ } // 設定持連結者可檢視
  return file.getUrl();                            // 回傳分享網址
}

//* ========== 列表/明細輸出（只回傳有內容的列；★時間倒序） ========== *//
function listBlessings_(){
  const sh = ensureBlessings_(openMain_());
  const last = sh.getLastRow(); if(last<=HEADER_ROWS) return []; // 無資料
  const vals = sh.getRange(HEADER_ROWS+1,1,last-HEADER_ROWS,9).getValues();

  const items=[];
  for(let i=0;i<vals.length;i++){
    const r=vals[i];
    const contentPlain = String(r[5]||'').replace(/<[^>]+>/g,'').trim(); // 再保險去標籤
    if(!contentPlain) continue; // 沒內容就略過
    items.push({
      row: i+HEADER_ROWS+1,
      time: r[0],
      lineId: r[1],
      displayName: r[2],
      pictureUrl: r[3],
      role: r[4]||'',
      preview: contentPlain.slice(0,60), // 前 60 字做預覽
      signature: r[6],
      signatureType: r[7],
      extra: r[8]
    });
  }
  // ★ 依時間倒序（最新在上）；不合法時間視為 0
  items.sort((a,b)=> (new Date(b.time||0)).getTime() - (new Date(a.time||0)).getTime());
  return items;
}
