<!doctype html>
<html lang="zh-Hant">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>鋼琴鍵盤（本地取樣優先｜必有聲｜固定Webhook）</title>
<style>
  body{font-family:system-ui,-apple-system,"Noto Sans TC",sans-serif;margin:0;padding:16px;background:#f6f7fb;}
  .panel{background:#fff;border-radius:14px;box-shadow:0 10px 25px rgba(0,0,0,.08);padding:14px;}
  #status{background:#eef1f6;border-radius:10px;padding:10px;margin-top:10px;font-size:14px;white-space:pre-wrap}
  .kb-wrap{overflow-x:auto;background:#eceff4;border-radius:14px;margin-top:12px}
  #keyboard{position:relative;height:220px;min-width:720px;user-select:none;-webkit-user-select:none}
  .white{position:absolute;bottom:0;height:100%;background:#fff;border:1px solid #ccc;}
  .white.active{background:#ffd;}
</style>
<body>
  <div class="panel">
    <h2>鋼琴鍵盤（本地取樣優先｜必有聲｜固定Webhook）</h2>
    <label>顯示名稱：</label>
    <input id="displayName" placeholder="例如：小明" style="flex:1">
    <p id="status">尚未初始化</p>
    <div class="kb-wrap"><div id="keyboard"></div></div>
  </div>

  <!-- Tone.js 只有這個即可 -->
  <script src="https://cdn.jsdelivr.net/npm/tone@14.8.49/build/Tone.min.js"></script>
  <script>
    // Webhook 寫死，使用固定 /exec
    const WEBHOOK = "https://script.google.com/macros/s/AKfycbw3rDKy-mjN93ValBMs28ndCFv5IbqjupDgn9rHvqYOqJwo5If3DdB1zVervdluT8YW/exec";

    const $ = s => document.querySelector(s);
    const statusEl = $('#status');

    let engineReady = false;
    let synth = null;                 // 立即出聲（保底）
    let sampler = null;               // 取樣鋼琴（本地優先）
    let samplerReady = false;         // 取樣是否載入完成

    function setStatus(msg){ statusEl.textContent = msg; }

    async function ensureEngine(){
      if(engineReady) return;
      await Tone.start();
      // 合成器保底：先保證可出聲
      synth = new Tone.PolySynth(Tone.Synth).toDestination();
      synth.set({ oscillator:{type:'triangle'}, envelope:{attack:0.002, decay:0.12, sustain:0.2, release:0.25} });
      engineReady = true;
      setStatus('音源就緒 ✅（先用合成器，背景載入鋼琴取樣）');
      // 背景開始載入取樣
      ensureSampler();
    }

    // 少量跨八度取樣，Tone 會自動轉調
    const URLS = {
      'A1': 'A1.mp3',
      'C2': 'C2.mp3', 'D#2': 'Ds2.mp3', 'F#2': 'Fs2.mp3', 'A2': 'A2.mp3',
      'C3': 'C3.mp3', 'D#3': 'Ds3.mp3', 'F#3': 'Fs3.mp3', 'A3': 'A3.mp3',
      'C4': 'C4.mp3', 'D#4': 'Ds4.mp3', 'F#4': 'Fs4.mp3', 'A4': 'A4.mp3',
      'C5': 'C5.mp3'
    };

    async function pickBaseUrl(){
      // 1) 先試「./audio/piano/」
      try{
        const r = await fetch('./audio/piano/C4.mp3', { method:'HEAD' });
        if (r.ok) { setStatus('偵測到本地取樣：./audio/piano/'); return './audio/piano/'; }
      }catch(e){}
      // 2) 再試「./piano/」（你目前的結構）
      try{
        const r2 = await fetch('./piano/C4.mp3', { method:'HEAD' });
        if (r2.ok) { setStatus('偵測到本地取樣：./piano/'); return './piano/'; }
      }catch(e){}
      // 3) 最後再試 tonejs 官方 CDN
      try{
        const test = await fetch('https://tonejs.github.io/audio/salamander/C4.mp3', { method:'HEAD' });
        if (test.ok) { setStatus('使用外部取樣 CDN'); return 'https://tonejs.github.io/audio/salamander/'; }
      }catch(e){}
      return null;
    });
        if (r.ok) return './audio/piano/';
      }catch(e){}
      // 2) 再試 tonejs 官方 CDN（若被擋會失敗）
      try{
        const test = await fetch('https://tonejs.github.io/audio/piano/C4.mp3', { method:'HEAD' });
        if (test.ok) return 'https://tonejs.github.io/audio/piano/';
      }catch(e){}
      return null;
    }

    async function ensureSampler(){
      if (sampler || samplerReady) return;
      const base = await pickBaseUrl();
      if (!base) { setStatus('⚠️ 找不到鋼琴取樣來源，維持合成器'); return; }
      try{
        sampler = new Tone.Sampler({ urls: URLS, release: 1, baseUrl: base, onload:()=>{ samplerReady = true; setStatus('鋼琴取樣已載入 ✅'); } }).toDestination();
      }catch(e){
        setStatus('鋼琴取樣載入失敗，維持合成器');
      }
    }

    const WHITE=["C3","D3","E3","F3","G3","A3","B3","C4","D4","E4","F4","G4","A4","B4"];

    function buildKeyboard(){
      const kb=$('#keyboard'); kb.innerHTML='';
      const total=WHITE.length, keyW=100/total;
      WHITE.forEach((note,i)=>{
        const w=document.createElement('div'); w.className='white'; w.dataset.note=note;
        w.style.left=`${i*keyW}%`; w.style.width=`${keyW}%`;
        kb.appendChild(w);
      });
      kb.addEventListener('pointerdown',async e=>{
        const t=e.target.closest('.white'); if(!t) return;
        await ensureEngine();
        playNote(t.dataset.note);
        log(t.dataset.note);
        t.classList.add('active');
      });
      kb.addEventListener('pointerup',e=>{
        const t=e.target.closest('.white'); if(t) t.classList.remove('active');
      });
    }

    function playNote(note){
      // 先合成器立即出聲
      if (synth) synth.triggerAttackRelease(note, '8n');
      // 若鋼琴取樣已就緒，再疊加真鋼琴音色（或改成只用取樣）
      if (samplerReady && sampler) {
        sampler.triggerAttackRelease(note, '8n');
      }
    }

    function log(note){
      const payload={userId:"guest",displayName:$('#displayName').value||'Guest',instrument:'piano',note,velocity:1,sessionId:'demo'};
      fetch(WEBHOOK,{method:'POST',headers:{'Content-Type':'text/plain;charset=UTF-8'},body:JSON.stringify(payload)})
      .then(r=>r.text()).then(txt=>setStatus(`已記錄：${note}｜回應：${txt}`))
      .catch(err=>setStatus('記錄失敗：'+err.message));
    }

    buildKeyboard();
  </script>
</body>
</html>
