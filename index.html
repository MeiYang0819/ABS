<!doctype html>
<html lang="zh-Hant">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>鋼琴鍵盤（簡化版｜必有聲｜固定Webhook）</title>
<style>
  body{font-family:system-ui,-apple-system,"Noto Sans TC",sans-serif;margin:0;padding:16px;background:#f6f7fb;}
  .panel{background:#fff;border-radius:14px;box-shadow:0 10px 25px rgba(0,0,0,.08);padding:14px;}
  #status{background:#eef1f6;border-radius:10px;padding:10px;margin-top:10px;font-size:14px;white-space:pre-wrap}
  .kb-wrap{overflow-x:auto;background:#eceff4;border-radius:14px;margin-top:12px}
  #keyboard{position:relative;height:220px;min-width:720px;user-select:none;-webkit-user-select:none}
  .white{position:absolute;bottom:0;height:100%;background:#fff;border:1px solid #ccc;}
  .white.active{background:#ffd;}
</style>
<body>
  <div class="panel">
    <h2>鋼琴鍵盤（簡化版｜必有聲｜固定Webhook）</h2>
    <label>顯示名稱：</label>
    <input id="displayName" placeholder="例如：小明" style="flex:1">
    <p id="status">尚未初始化</p>
    <div class="kb-wrap"><div id="keyboard"></div></div>
  </div>

  <!-- Tone.js -->
  <script src="https://cdn.jsdelivr.net/npm/tone@14.8.49/build/Tone.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tonejs/piano@0.2.0/build/Piano.js"></script>
  <script>
    // Webhook 寫死，使用固定 /exec
    const WEBHOOK = "https://script.google.com/macros/s/AKfycbw3rDKy-mjN93ValBMs28ndCFv5IbqjupDgn9rHvqYOqJwo5If3DdB1zVervdluT8YW/exec";

    const $ = s => document.querySelector(s);
    const statusEl = $('#status');

    let engineReady = false;
    let piano = null;
    let pianoReady = false;

    async function ensureEngine(){
      if(engineReady) return;
      await Tone.start();
      piano = new Piano({velocities:2}).toDestination();
      await piano.load();
      pianoReady = true;
      engineReady = true;
      setStatus('鋼琴音源就緒 ✅');
    }

    function setStatus(msg){ statusEl.textContent = msg; }

    const WHITE=["C3","D3","E3","F3","G3","A3","B3","C4","D4","E4","F4","G4","A4","B4"];

    function buildKeyboard(){
      const kb=$('#keyboard'); kb.innerHTML='';
      const total=WHITE.length, keyW=100/total;
      WHITE.forEach((note,i)=>{
        const w=document.createElement('div'); w.className='white'; w.dataset.note=note;
        w.style.left=`${i*keyW}%`; w.style.width=`${keyW}%`;
        kb.appendChild(w);
      });
      kb.addEventListener('pointerdown',async e=>{
        const t=e.target.closest('.white'); if(!t) return;
        await ensureEngine();
        playNote(t.dataset.note);
        log(t.dataset.note);
        t.classList.add('active');
      });
      kb.addEventListener('pointerup',e=>{
        const t=e.target.closest('.white'); if(t) t.classList.remove('active');
      });
    }

    function playNote(note){
      if(pianoReady){
        piano.keyDown({note,velocity:0.9});
        setTimeout(()=>piano.keyUp({note}),Tone.Time('8n').toMilliseconds());
      }
    }

    function log(note){
      const payload={userId:"guest",displayName:$('#displayName').value||'Guest',instrument:'piano',note,velocity:1,sessionId:'demo'};
      fetch(WEBHOOK,{method:'POST',headers:{'Content-Type':'text/plain;charset=UTF-8'},body:JSON.stringify(payload)})
      .then(r=>r.text()).then(txt=>setStatus(`已記錄：${note}｜回應：${txt}`))
      .catch(err=>setStatus('記錄失敗：'+err.message));
    }

    buildKeyboard();
  </script>
</body>
</html>
