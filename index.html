<!doctype html>
<html lang="zh-Hant">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>互動音符</title>
<style>
  :root{ --page:#f6f7fb; --panel:#fff; --rim:#e4e7ef; --ink:#0f172a; }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--page);color:var(--ink);font-family:system-ui,-apple-system,"Noto Sans TC",sans-serif}
  .panel{max-width:1060px;margin:22px auto;background:var(--panel);border-radius:16px;padding:18px 18px 26px;box-shadow:0 10px 30px rgba(0,0,0,.08)}
  h2{margin:4px 0 12px; text-align:center;}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  input{padding:8px 10px;border:1px solid var(--rim);border-radius:10px;min-width:220px}
  #status{background:#eef2f7;border:1px solid var(--rim);border-radius:12px;padding:10px;margin-top:10px;font-size:14px;white-space:pre-wrap;color:#334155}

  .kb-wrap{overflow-x:auto;background:#e9edf4;border:1px solid var(--rim);border-radius:14px;margin-top:14px}
  #keyboard{position:relative;height:280px;min-width:860px;user-select:none;-webkit-user-select:none;touch-action:none}

  .white{position:absolute;bottom:0;height:100%;
    background:linear-gradient(#ffffff,#eceef3 72%,#d9dde5);
    border-radius:0 0 12px 12px;
    box-shadow:inset 0 -12px 16px rgba(0,0,0,.12),inset 0 1px 0 rgba(255,255,255,.9),0 1px 0 rgba(0,0,0,.04);
    border-right:1px solid #cfd3dc;
  }
  .white:first-child{border-left:1px solid #cfd3dc}
  .white.active{filter:brightness(1.06)}

  .black{position:absolute;bottom:38%;height:62%;
    width:6.4%;
    background:linear-gradient(#2d2f36,#0e0f13);
    border:1px solid #0b0d11;border-top:none;
    border-radius:0 0 10px 10px;z-index:5;
    box-shadow:inset 0 -6px 10px rgba(0,0,0,.45),0 3px 10px rgba(0,0,0,.35);
  }
  .black.active{filter:brightness(1.22)}

  .label{position:absolute;bottom:12px;left:50%;transform:translateX(-50%);
    font-size:11px;color:#475569;background:#ffffffee;border:1px solid var(--rim);
    padding:2px 6px;border-radius:8px}
</style>
<body>
  <div class="panel">
    <h2>互動音符</h2>
    <div class="row">
      <label for="displayName">顯示名稱：</label>
      <input id="displayName" placeholder="例如：小明" />
    </div>
    <p id="status">尚未初始化</p>
    <div class="kb-wrap"><div id="keyboard"></div></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/tone@14.8.49/build/Tone.min.js"></script>
  <script>
    const WEBHOOK = "https://script.google.com/macros/s/AKfycbw3rDKy-mjN93ValBMs28ndCFv5IbqjupDgn9rHvqYOqJwo5If3DdB1zVervdluT8YW/exec";

    const $ = s => document.querySelector(s);
    const statusEl = $('#status');
    const setStatus = (m)=> statusEl.textContent = m;

    let engineReady=false;
    let synth=null;
    let sampler=null;
    let samplerReady=false;
    let audioUnlocked=false;

    // —— 關鍵：在手勢事件中做「零音量短促播放」來解鎖 iOS/Safari —— //
    function unlockAudioOnce(){
      // 已解鎖或已 running 就跳過
      const ctx = Tone.getContext().rawContext;
      if(audioUnlocked || ctx.state === 'running'){ audioUnlocked = true; return; }

      try{
        // 1. 嘗試 resume（同步、不 await）
        ctx.resume && ctx.resume();

        // 2. 播放 1 個樣本、零音量的 buffer 以確保裝置真的出聲（雖然聽不到）
        const buffer = ctx.createBuffer(1, 1, 22050);
        const src = ctx.createBufferSource();
        src.buffer = buffer;
        const gain = ctx.createGain();
        gain.gain.value = 0; // 靜音
        src.connect(gain).connect(ctx.destination);
        src.start(0);

        // 3. 通知 Tone（fire-and-forget）
        Tone.start();

        audioUnlocked = true;
      }catch(e){
        // 若失敗不阻斷流程，下次手勢會再試
      }
    }

    function ensureEngineSync(){
      if(engineReady) return;
      try{
        if(!synth){
          synth = new Tone.PolySynth(Tone.Synth).toDestination();
          synth.set({ oscillator:{type:'triangle'}, envelope:{attack:0.002, decay:0.12, sustain:0.2, release:0.25} });
        }
        // 不 await，保持在手勢事件同步鏈上
        unlockAudioOnce();
        engineReady = true;
        setStatus('音源就緒 ✅（先合成器，背景載入鋼琴取樣）');
        ensureSampler();
      }catch(e){
        setStatus('音源啟動失敗：'+e.message);
      }
    }

    const BASE='./piano/';
    const URLS={
      'A1':'A1.mp3',
      'C2':'C2.mp3','D#2':'Ds2.mp3','F#2':'Fs2.mp3','A2':'A2.mp3',
      'C3':'C3.mp3','D#3':'Ds3.mp3','F#3':'Fs3.mp3','A3':'A3.mp3',
      'C4':'C4.mp3','D#4':'Ds4.mp3','F#4':'Fs4.mp3','A4':'A4.mp3',
      'C5':'C5.mp3'
    };
    function ensureSampler(){
      if(sampler || samplerReady) return;
      try{
        sampler = new Tone.Sampler({
          urls: URLS, release:1, baseUrl: BASE,
          onload: ()=>{ samplerReady=true; setStatus('鋼琴取樣已載入 ✅'); }
        }).toDestination();
      }catch(e){
        setStatus('鋼琴取樣載入失敗（維持合成器）');
      }
    }

    const WHITE=["C3","D3","E3","F3","G3","A3","B3","C4","D4","E4","F4","G4","A4","B4"];
    const BLACK_AFTER={ 'C':'C#', 'D':'D#', 'F':'F#', 'G':'G#', 'A':'A#' };

    function buildKeyboard(){
      const kb=$('#keyboard'); kb.innerHTML='';
      const total=WHITE.length; const keyW=100/total;
      let blackCount=0;

      // white keys
      WHITE.forEach((note,i)=>{
        const w=document.createElement('div'); w.className='white'; w.dataset.note=note;
        w.style.left=`${i*keyW}%`; w.style.width=`${keyW}%`;
        if(note.startsWith('C')||note.startsWith('G')){
          const lab=document.createElement('div'); lab.className='label'; lab.textContent=note; w.appendChild(lab);
        }
        kb.appendChild(w);
      });

      // black keys
      WHITE.forEach((note,i)=>{
        const n0=note[0]; const sharp=BLACK_AFTER[n0] ? BLACK_AFTER[n0] + note.slice(1) : null;
        if(!sharp || (n0==='A' && i===WHITE.length-1)) return;
        const b=document.createElement('div'); b.className='black'; b.dataset.note=sharp;
        b.style.left=`calc(${i*keyW}% + ${keyW*0.68}%)`;
        kb.appendChild(b); blackCount++;
      });

      setStatus(`初始化完成｜白鍵 ${WHITE.length}｜黑鍵 ${blackCount}`);

      // 事件：一律在事件最前面先 unlock，再 ensureEngineSync，再播放
      kb.addEventListener('pointerdown', (e)=>{
        const t=e.target.closest('.black,.white'); if(!t) return;
        t.setPointerCapture?.(e.pointerId);
        unlockAudioOnce();
        ensureEngineSync();
        playNote(t.dataset.note); log(t.dataset.note);
        t.classList.add('active');
      });
      kb.addEventListener('pointerup', (e)=>{
        const t=e.target.closest('.black,.white'); if(t) t.classList.remove('active');
      });

      kb.addEventListener('touchstart', (e)=>{
        if(e.touches && e.touches.length>0) e.preventDefault();
        const t0=e.touches[0]||e.changedTouches[0];
        const el=document.elementFromPoint(t0.clientX,t0.clientY);
        const key=el&&el.closest?el.closest('.black,.white'):null; if(!key) return;
        unlockAudioOnce();
        ensureEngineSync();
        playNote(key.dataset.note); log(key.dataset.note);
        key.classList.add('active');
      }, {passive:false});
      kb.addEventListener('touchend', (e)=>{
        const t0=e.changedTouches&&e.changedTouches[0]; if(!t0) return;
        const el=document.elementFromPoint(t0.clientX,t0.clientY);
        const key=el&&el.closest?el.closest('.black,.white'):null; if(key) key.classList.remove('active');
      }, {passive:false});

      kb.addEventListener('mousedown', (e)=>{
        const t=e.target.closest('.black,.white'); if(!t) return;
        unlockAudioOnce();
        ensureEngineSync();
        playNote(t.dataset.note); log(t.dataset.note);
        t.classList.add('active');
      });
      kb.addEventListener('mouseup', (e)=>{
        const t=e.target.closest('.black,.white'); if(t) t.classList.remove('active');
      });
    }

    function playNote(note){
      // 先用合成器保底，取樣載入後會同時發聲
      if(synth) synth.triggerAttackRelease(note,'8n');
      if(samplerReady && sampler) sampler.triggerAttackRelease(note,'8n');
    }

    function log(note){
      const payload={userId:'guest',displayName:$('#displayName').value||'Guest',instrument:'piano',note,velocity:1,sessionId:'demo'};
      fetch(WEBHOOK,{method:'POST',headers:{'Content-Type':'text/plain;charset=UTF-8'},body:JSON.stringify(payload)})
        .then(r=>r.text()).then(txt=>setStatus(`已記錄：${note}｜回應：${txt}`))
        .catch(err=>setStatus('記錄失敗：'+err.message));
    }

    // 回到前景時，有些瀏覽器會把 context 暫停；帶回時再嘗試恢復
    document.addEventListener('visibilitychange', () => {
      if(document.visibilityState === 'visible'){
        try{ unlockAudioOnce(); }catch(e){}
      }
    });

    // 額外保險：任意點擊/觸控頁面也會嘗試解鎖（不影響已解鎖的情況）
    ['click','touchstart'].forEach(ev=>{
      window.addEventListener(ev, unlockAudioOnce, {passive:true, once:false});
    });

    window.addEventListener('DOMContentLoaded', ()=>{
      try{ buildKeyboard(); }catch(e){ setStatus('載入錯誤：'+e.message); }
    });
  </script>
</body>
</html>
