<!doctype html>
<html lang="zh-Hant">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ğŸ¶äº’å‹•éŸ³ç¬¦</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700&display=swap" rel="stylesheet">
<style>
/* ===== èª¿è‰²ç›¤èˆ‡å°ºå¯¸ï¼ˆæ¬„ä½å¯¬åº¦å¯åœ¨é€™è£¡æ”¹ï¼‰ ===== */
:root{
  --brand:#D4BFAA;;   /* ä¸»è‰²ï¼šæ•´é åº•è‰² */ 
  --title:#A68A7C;    /* æ¨™é¡Œå­—è‰² */ 
  --neutral:#E4E4E4;  /* å€å¡ŠèƒŒæ™¯ */
  --soft:#F5F1EC;     /* å…§é /å®¹å™¨åº• */
  --accent:#BFA5A0;   /* æäº®è‰²ï¼ˆè¼‰å…¥å®Œæˆï¼‰ */
  --rim:#E4E4E4; 
  --ink:#0f172a;
  --w-displayName: 96px;   /* è¦ªå‹å§“å input */
  --w-email:261px;         /* é›»å­éƒµä»¶ input */
  --w-code:96px;           /* å–å¾—ä»£è™Ÿ input */
  --w-instrument:96px;     /* æ¨‚å™¨è½‰æ› select */
  --w-lastNote:120px;      /* éŸ³ç¬¦ç´€éŒ„ input */
  --label-w:88px;          /* çµ±ä¸€æ¯å€‹ label çš„å¯¬åº¦ï¼Œç¢ºä¿å·¦ç·£å°é½Š */
  --gap:10px;              /* å…©å€‹é …ç›®é–“çš„æ°´å¹³é–“è· */
  --kb-h:280px;            /* æ¨‚å™¨å€é«˜åº¦ */
  --sep:2px; 
  --stroke:rgba(0,0,0,.18); 
  --glow:rgba(255,255,255,.65);
}
*{
  box-sizing:border-box;
  font-family:"Zen Maru Gothic","Noto Sans TC",system-ui,-apple-system,sans-serif !important;
  -webkit-text-stroke:.35px var(--stroke);
  text-shadow:0 1px 0 var(--glow);
}
html,body{ margin:0; color:var(--ink); background:var(--brand); }

/* èƒŒæ™¯éŸ³ç¬¦ */
.bg-notes{ position:fixed; inset:0; width:100%; height:100%; object-fit:cover; opacity:.60; mix-blend-mode:multiply; filter:contrast(1.1); pointer-events:none; z-index:0; }

/* å®¹å™¨ */
.panel{ position:relative; z-index:1; max-width:1060px; margin:22px auto; background:var(--neutral); border:1px solid var(--neutral); border-radius:16px; padding:18px 18px 26px; box-shadow:0 10px 26px rgba(0,0,0,.10); backdrop-filter:blur(8px) saturate(115%); }

/* æ¨™é¡Œ */
h2{ margin:4px 0 20px; text-align:center; font-size:2.8rem; font-weight:700; letter-spacing:1px; color:var(--title); -webkit-text-stroke:.6px rgba(0,0,0,.12); text-shadow:0 3px 4px rgba(255,255,255,.75); }

/* æ§åˆ¶åˆ— */
.row{ display:flex; gap:var(--gap); align-items:center; flex-wrap:wrap; margin-top:10px; }
.row label{ width:var(--label-w); opacity:.92; white-space:nowrap; font-weight:400; -webkit-text-stroke:0; text-shadow:none; }
.row input,.row select,.row button{ height:38px; font-size:14px; background:#fff; padding:8px 10px; border:1px solid var(--rim); border-radius:10px; -webkit-text-stroke:.25px rgba(0,0,0,.12); text-shadow:0 1px 0 rgba(255,255,255,.5); }

/* æ¬„ä½å¯¬åº¦ */
#displayName{ width:var(--w-displayName); }
#email{       width:var(--w-email); }
#code{        width:var(--w-code); }
#instrument{  width:var(--w-instrument); }
#lastNote{    width:var(--w-lastNote); text-align:center; letter-spacing:.3px; }
#lastNote::placeholder{ text-align:center; }

/* ã€ŒéŸ³ç¬¦ç´€éŒ„ã€èˆ‡ä¸Šæ–¹ã€Œé›»å­éƒµä»¶ã€å·¦ç·£å°é½Š */
.align-to-email{ margin-left: calc(var(--w-displayName) - var(--w-instrument)); }

/* æŒ‰éˆ• */
.row select option{text-align:center}
.row button{ width:120px; cursor:pointer; font-weight:600; }
.btn-compact{ width:60px !important; }
.row button:disabled{ opacity:.55; cursor:not-allowed; }

/* ç‹€æ…‹åˆ— */
#status{ background:var(--soft); border:1px solid var(--neutral); border-radius:12px; padding:10px; margin-top:10px; font-size:14px; white-space:pre-wrap; color:#6b5e52; text-align:center; }
#status.ok{ color:var(--accent); font-weight:600; }
#status.busy{ color:var(--title); }
#status.err{ color:#8b5e52; }

/* éµç›¤å¤–æ¡†ï¼šâœ… å…è¨±æ°´å¹³å·è»¸ï¼ˆæ²¿ç”¨ä½ å¯ç”¨çš„ç‰ˆæœ¬ï¼‰ */
.kb-wrap{
  overflow-x:auto;                 /* éœ€è¦æ™‚å‡ºç¾æ°´å¹³å·è»¸ */
  -webkit-overflow-scrolling:touch;
  background:var(--soft); border:1px solid var(--rim); border-radius:14px; margin-top:14px;
}
#keyboard{
  position:relative; height:var(--kb-h);
  user-select:none; -webkit-user-select:none;
  touch-action: pan-x pan-y;       /* ä¸é˜»æ“‹åŸç”Ÿæ²å‹• */
}

/* ===== é‹¼ç´ ===== */
.white{ position:absolute; bottom:0; height:100%; background:linear-gradient(#ffffff,#eceef3 72%,#d9dde5); border-radius:0 0 12px 12px; box-shadow:inset 0 -12px 16px rgba(0,0,0,.12), inset 0 1px 0 rgba(255,255,255,.9), 0 1px 0 rgba(0,0,0,.04); }
.white::after{ content:""; position:absolute; top:0; bottom:0; right:0; width:var(--sep); background:linear-gradient(transparent,#cfd3dc 50%,transparent); }
.white:first-child::before{ content:""; position:absolute; top:0; bottom:0; left:0; width:var(--sep); background:linear-gradient(transparent,#cfd3dc 50%,transparent); }
.white.active{ filter:brightness(1.06); }
.black{ position:absolute; bottom:38%; height:62%; background:linear-gradient(#2d2f36,#0e0f13); border:1px solid #0b0d11; border-top:none; border-radius:0 0 10px 10px; z-index:5; box-shadow:inset 0 -6px 10px rgba(0,0,0,.45), 0 3px 10px rgba(0,0,0,.35); transform: translateX(-50%); }
.black.active{ filter:brightness(1.22); }
.label{ position:absolute; bottom:12px; left:50%; transform:translateX(-50%); font-size:11px; color:#475569; background:#ffffffee; border:1px solid var(--rim); padding:2px 6px; border-radius:8px; }

/* ===== å‰ä»–ï¼ˆæ›´åƒç¹éŠ…å¼¦ + éœ‡å‹•ä¿ç•™ï¼‰ ===== */
.fretboard{ position:relative; display:grid; grid-template-columns: repeat(13, 1fr); width:100%; height:var(--kb-h); background:linear-gradient(180deg,#6b4f2e 0%, #5b4429 50%, #533c24 100%); border-radius:12px; box-shadow:inset 0 10px 20px rgba(0,0,0,.25), inset 0 -8px 16px rgba(0,0,0,.2); }
.head{ position:absolute; left:0; top:0; bottom:0; width:86px; z-index:2; background:linear-gradient(180deg, rgba(0,0,0,.12), transparent 40%),linear-gradient(180deg,#7a5534 0%, #6b4f2e 55%, #5a3f24 100%); border-right:1px solid rgba(40,22,8,.35); box-shadow: inset -8px 0 16px rgba(0,0,0,.18); border-radius:12px 0 0 12px; pointer-events:none; }
.nut{ position:absolute; left:86px; top:0; bottom:0; width:8px; z-index:3; background:linear-gradient(180deg,#e5e1d6,#c9c5ba); box-shadow: inset -1px 0 0 rgba(0,0,0,.35), inset 1px 0 0 rgba(255,255,255,.6); border-right:2px solid rgba(120,120,120,.5); pointer-events:none; }
.bridge{ position:absolute; right:0; top:0; bottom:0; width:10px; z-index:2; background:linear-gradient(180deg,#b9b6ad,#8f8c83); box-shadow: inset 1px 0 0 rgba(255,255,255,.5), inset -1px 0 0 rgba(0,0,0,.25); pointer-events:none; border-left:1px solid rgba(0,0,0,.18); }
.fret-col{ position:relative; background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.02)); box-shadow: inset -2px 0 0 rgba(255,255,255,.18), inset -4px 0 0 rgba(0,0,0,.28); }

/* â€”â€” å¼¦æœ¬é«”ï¼šå…©å±¤ç¹ç·šæ¢ç´‹ + ç­’å½¢é«˜å…‰ + é‚Šç·£é™°å½± â€”â€” */
.string{
  --sw: 2px;                               /* ç²—ç´°ä¸è®Š */
  position:absolute; left:94px; right:0; height:0; z-index:3;
  border-top: var(--sw) solid transparent; /* ç”±å½å…ƒç´ ç•«å‡ºå¼¦é«” */
  transform-origin:center;
  filter:drop-shadow(0 1px 0 rgba(0,0,0,.18));
  /* ç¶­æŒæ»‘å‹•é«˜å…‰å‹•ç•«ï¼ˆä¸å½±éŸ¿å¤–è§€ï¼‰ */
  background: linear-gradient(90deg, rgba(255,255,255,0) 0%, rgba(255,255,255,.45) 50%, rgba(255,255,255,0) 100%);
  background-size:160px 1px; background-repeat:no-repeat; background-position:-160px 0;
}
.string::before{
  content:""; position:absolute; left:0; right:0;
  top: calc(var(--sw) * -0.5); height: var(--sw);
  /* å…©å±¤ç¹éŠ…æ¢ç´‹ï¼ˆç›¸ä½å¾®éŒ¯é–‹ï¼‰+ åœ“æŸ±é«˜å…‰ + ä¸‹ç·£é™°å½± */
  background:
    repeating-linear-gradient(90deg, #caa56b 0 2.4px, #906a3d 2.4px 3.1px),
    repeating-linear-gradient(90deg, rgba(255,255,255,.08) 0 2.4px, rgba(0,0,0,.10) 2.4px 3.1px),
    linear-gradient(180deg, rgba(255,255,255,.70), rgba(255,255,255,.15) 55%, rgba(0,0,0,.18) 100%);
  border-radius: 999px;
  opacity:.98; pointer-events:none;
}
.string::after{
  /* ç´°é«˜å…‰ç·šï¼šè®“å¼¦æ›´é‡‘å±¬ */
  content:""; position:absolute; left:0; right:0;
  top: calc(var(--sw) * -0.5 + 0.2px); height: calc(var(--sw) * .25);
  background: linear-gradient(180deg, rgba(255,255,255,.55), rgba(255,255,255,0));
  pointer-events:none; border-radius:999px; opacity:.9;
}
/* ç²—ç´°ç¶­æŒæ—¢æœ‰è¨­å®š */
.string[data-s="2"]{ --sw:2.5px; }
.string[data-s="3"]{ --sw:3px;   }
.string[data-s="4"]{ --sw:3.5px; }
.string[data-s="5"]{ --sw:4px;   }

/* ç´é ­å€æ®µä¹Ÿå¥—ç”¨ç¹éŠ…å¤–è§€ï¼ˆé¿å…å‰æ®µçœ‹èµ·ä¾†åªæ˜¯ç·šæ¢ï¼‰ */
.head-line{ --sw:2px; position:absolute; left:0; width:86px; height:0; z-index:2; border-top: var(--sw) solid transparent; filter:drop-shadow(0 1px 0 rgba(0,0,0,.06)); pointer-events:none; }
.head-line::before{
  content:""; position:absolute; left:0; right:0; top: calc(var(--sw) * -0.5); height: var(--sw);
  background:
    repeating-linear-gradient(90deg, #caa56b 0 2.4px, #906a3d 2.4px 3.1px),
    repeating-linear-gradient(90deg, rgba(255,255,255,.08) 0 2.4px, rgba(0,0,0,.10) 2.4px 3.1px),
    linear-gradient(180deg, rgba(255,255,255,.70), rgba(255,255,255,.15) 55%, rgba(0,0,0,.18) 100%);
  border-radius:999px; opacity:.98;
}
.head-line::after{
  content:""; position:absolute; left:0; right:0; top: calc(var(--sw) * -0.5 + 0.2px); height: calc(var(--sw) * .25);
  background: linear-gradient(180deg, rgba(255,255,255,.55), rgba(255,255,255,0));
  border-radius:999px; opacity:.9;
}
.head-line[data-s="2"]{ --sw:2.5px; } .head-line[data-s="3"]{ --sw:3px; } .head-line[data-s="4"]{ --sw:3.5px; } .head-line[data-s="5"]{ --sw:4px; }

/* è§¸æ§å€èˆ‡éœ‡å‹•å‹•ç•«ï¼ˆä¿ç•™ï¼‰ */
.hit-row{ position:absolute; left:0; right:0; height:28px; transform:translateY(-50%); background:transparent; cursor:pointer; z-index:4; }
@media (pointer:coarse){ .hit-row{ height:34px; } }
.string.vibrate{ animation: vibrCurve 360ms ease-out, shine 360ms ease-out; }
@keyframes vibrCurve{
  0%{transform:translateY(0)} 10%{transform:translateY(-3.2px)} 20%{transform:translateY(0)}
  30%{transform:translateY(2.6px)} 45%{transform:translateY(0)} 60%{transform:translateY(-1.8px)}
  75%{transform:translateY(0.6px)} 100%{transform:translateY(0)}
}
@keyframes shine{ 0%{ background-position:-160px 0; opacity:.95 } 100%{ background-position:160px 0; opacity:.96 } }

/* Overlay */
.overlay{ position:fixed; inset:0; z-index:9999; display:flex; align-items:center; justify-content:center; background:rgba(17,24,39,.35); backdrop-filter:blur(3px); }
.overlay.hidden{ display:none; }
.dialog{ min-width:300px; max-width:92vw; background:var(--soft); border:1px solid var(--neutral); border-radius:14px; padding:18px; box-shadow:0 18px 44px rgba(0,0,0,.18); text-align:center; }
.dialog h3{ margin:0 0 8px; font-size:18px; color:var(--title); }
/* iPhone æç¤ºï¼šç´…è‰²ã€éç²—é«”ã€ç¦ç”¨å½ç²—é«”èˆ‡æé‚Š */
.dialog p.ios-hint{
  margin:6px 0; line-height:1.6; font-size:15px; color:#d11;
  font-weight:400 !important;
  font-family:"Noto Sans TC","PingFang TC","Heiti TC",system-ui,-apple-system,sans-serif !important;
  font-synthesis: none !important;            /* é—œæ‰ Safari å½ç²—é«”/å½æ–œé«” */
  font-variation-settings: "wght" 400 !important; /* è‹¥å­—å‹æ”¯æ´å¯ç¡¬å£“ 400 */
  -webkit-text-stroke:0 !important;
  text-shadow:none !important;
}
.dialog .actions{ display:flex; gap:10px; justify-content:center; margin-top:12px; }
.dialog button{ width:120px; height:38px; border-radius:10px; border:1px solid var(--rim); background:#fff; cursor:pointer; font-weight:600; }
.dialog button.primary{ background:#fff; }

#lockScreen{ position:fixed; inset:0; z-index:9998; display:none; background:transparent; }
footer{ max-width:1060px;margin:8px auto 22px; text-align:center; color:#6b5e52; font-size:12px; opacity:.9; }
</style>

<body>
  <!-- èƒŒæ™¯éŸ³ç¬¦ -->
  <img class="bg-notes" src="./assets/notes.png?v=4" alt="">
  <div class="panel">
    <h2>ğŸ¼äº’å‹•éŸ³ç¬¦ğŸ¼</h2>

    <!-- ç¬¬ 1 è¡Œï¼šå§“å â†’ Email â†’ ä»£è™Ÿ -->
    <div class="row row-line2">
      <label for="displayName">è¦ªå‹å§“åï¼š</label>
      <input id="displayName" placeholder="ä¾‹ï¼šå¼µå’©æš" />
      <label for="email">é›»å­éƒµä»¶ï¼š</label>
      <input id="email" placeholder="hey fill in your@email" inputmode="email" />
      <label for="code">å–å¾—ä»£è™Ÿï¼š</label>
      <input id="code" placeholder="è«‹è¼¸å…¥ä»£è™Ÿ" />
    </div>

    <!-- ç¬¬ 2 è¡Œï¼šæ¨‚å™¨ â†’ éŸ³ç¬¦ç´€éŒ„ â†’ é‡è¨­ â†’ é–å®š -->
    <div class="row row-line3">
      <label for="instrument">æ¨‚å™¨è½‰æ›ï¼š</label>
      <select id="instrument">
        <option value="piano" selected>é‹¼ç´</option>
        <option value="guitar">å‰ä»–</option>
      </select>
      <label for="lastNote" class="align-to-email">éŸ³ç¬¦ç´€éŒ„ï¼š</label>
      <input id="lastNote" placeholder="â€” , â€” , â€”" readonly />
      <button id="resetBtn" type="button" class="btn-compact">é‡è¨­</button>
      <button id="lockBtn"  type="button" class="btn-compact" disabled>é–å®š</button>
    </div>

    <p id="status">å°šæœªåˆå§‹åŒ–</p>
    <div class="kb-wrap"><div id="keyboard"></div></div>
  </div>

  <!-- å½ˆè·³è¦–çª— â‘ ï¼šæ“ä½œèªªæ˜ -->
  <div id="guideOverlay" class="overlay" role="dialog" aria-modal="true" aria-labelledby="guideTitle">
    <div class="dialog">
      <h3 id="guideTitle">ğŸ“æ“ä½œèªªæ˜ğŸ“</h3>
      <p>ğŸ”»å¡«å…¥å§“åã€Emailèˆ‡å–å¾—çš„ä»£è™Ÿ</p><p>â†“</p>
      <p>ğŸ”»å¯é¸æ“‡é‹¼ç´æˆ–å‰ä»–ä¸­çš„ä¸‰å€‹éŸ³éš</p><p>â†“</p>
      <p>ğŸ”»ä¸‰å€‹éŸ³éšç¢ºèªå¾Œï¼Œä¸€å®šè¦æŒ‰é–å®š</p><p>â†“</p>
      <p>ğŸ”»é–å®šå®Œæˆå¾Œï¼Œæœƒæœ‰é€šçŸ¥æ˜¯å¦æˆåŠŸ</p><p>â†“</p>
      <p>ğŸ”»è‹¥æˆåŠŸå³å¯é€€å‡ºä»‹é¢ï¼›åä¹‹å†è©¦</p><p>â†“</p>
      <p>â—ï¸æ²’æŒ‰é–å®šå°±æ˜¯æ²’æœ‰é€å‡ºå°±æ˜¯å½ˆå€‹å¯‚å¯</p>
      <div class="actions"><button id="guideOk" class="primary">äº†è§£</button></div>
    </div>
  </div>

  <!-- å½ˆè·³è¦–çª— â‘¡ï¼šå•Ÿç”¨è²éŸ³ / éŸ³è‰²è¼‰å…¥ -->
  <div id="unlockOverlay" class="overlay hidden" role="dialog" aria-modal="true" aria-labelledby="unlockTitle">
    <div class="dialog">
      <h3 id="unlockTitle">å•Ÿç”¨è²éŸ³</h3>
      <p class="ios-hint">iPhoneè«‹ç¢ºä¿å´é‚Šã€ŒéœéŸ³éµã€æœ‰é–‹å•ŸéŸ¿éˆ´æ¨¡å¼</p>
      <div class="actions">
        <button id="cancelUnlock">å–æ¶ˆ</button>
        <button id="confirmUnlock" class="primary">ç¢ºå®š</button>
      </div>
    </div>
  </div>

  <div id="lockScreen" aria-hidden="true"></div>
  <footer>Â© Copyright 2025 MYâ€˜s system Version:b1.0.1</footer>

  <script src="https://cdn.jsdelivr.net/npm/tone@14.8.49/build/Tone.min.js"></script>
  <script>
  /* ===== ä¸»ç¨‹å¼ï¼ˆé‚è¼¯ä¸å‹•ï¼‰ ===== */
  const WEBHOOK = "https://script.google.com/macros/s/AKfycbxxw3vbCEdC7DjF19blGXfQPr0dMEFhVo020XLI4sfQaBKe0fW388JAh3k77WufGim-/exec";
  const $ = s => document.querySelector(s);
  const setStatus = m => {
    const el = $('#status'); el.textContent = m;
    el.classList.remove('ok','busy','err');
    if(/å·²è¼‰å…¥/.test(m)) el.classList.add('ok');
    else if(/é€å‡ºä¸­/.test(m)) el.classList.add('busy');
    else if(/âŒ|å¤±æ•—|é€¾æ™‚|æ‰¾å°‹ä¸åˆ°|å·²é|æ ¼å¼ä¸æ­£ç¢º|å¿™ç¢Œ/.test(m)) el.classList.add('err');
  };

  let audioCtx=null, sampler=null, samplerReady=false, unlocked=false, hardLocked=false;
  let currentInstrument='piano';
  let selectedNotes = [];

  const PIANO_BASE  = new URL('./piano/',  location.href).href;
  const GUITAR_BASE = new URL('./guitar/', location.href).href;
  const PIANO_URLS  = {'A1':'A1.mp3','C2':'C2.mp3','D#2':'Ds2.mp3','F#2':'Fs2.mp3','A2':'A2.mp3','C3':'C3.mp3','D#3':'Ds3.mp3','F#3':'Fs3.mp3','A3':'A3.mp3','C4':'C4.mp3','D#4':'Ds4.mp3','F#4':'Fs4.mp3','A4':'A4.mp3','C5':'C5.mp3'};
  const GUITAR_URLS = {'E2':'E2.wav','A2':'A2.wav','D3':'D3.wav','G3':'G3.wav','B3':'B3.wav','E4':'E4.wav'};

  const WHITE=["C3","D3","E3","F3","G3","A3","B3","C4","D4","E4","F4","G4","A4","B4"];
  const BLACK_AFTER={ 'C':'C#','D':'D#','F':'F#','G':'G#','A':'A#' };
  const MIN_WHITE_PX=64, TOTAL_WHITE=WHITE.length;

  const TUNING_MIDI = [40,45,50,55,59,64];
  const NOTE_NAMES = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];

  function validEmail(v){ return /.+@.+\..+/.test((v||'').trim()); }

  async function unlockAudio(){
    try{
      const Ctx=window.webkitAudioContext||window.AudioContext;
      if(!audioCtx) audioCtx=new Ctx({latencyHint:'interactive'});
      if(audioCtx.state!=='running') await audioCtx.resume();
      Tone.setContext(new Tone.Context(audioCtx));
      await Tone.start();
      loadSampler(currentInstrument);
      unlocked=true;
      $('#unlockOverlay').classList.add('hidden');
    }catch(e){ setStatus('å•Ÿç”¨å¤±æ•—ï¼š'+e.message); }
  }

  function loadSampler(inst='piano'){
    sampler?.dispose?.(); sampler=null; samplerReady=false;
    let urls=PIANO_URLS, base=PIANO_BASE, label='ğŸ¹ ';
    if(inst==='guitar'){ urls=GUITAR_URLS; base=GUITAR_BASE; label='ğŸ¸ '; }
    setStatus(label+'è¼‰å…¥ä¸­â€¦');
    sampler=new Tone.Sampler({
      urls, release:1, baseUrl:base,
      onload:()=>{ samplerReady=true; setStatus(label+'å·²è¼‰å…¥ âœ…'); }
    }).toDestination();
  }

  function refreshNotesDisplay(){
    const parts=[selectedNotes[0]||'â€”', selectedNotes[1]||'â€”', selectedNotes[2]||'â€”'];
    $('#lastNote').value = parts.join(' , ');
  }

  function trigger(note){
    if(hardLocked) return;
    if(!samplerReady){ setStatus('éŸ³è‰²è¼‰å…¥ä¸­â€¦'); return; }
    sampler.triggerAttackRelease(note,'8n');
    if(selectedNotes.length<3) selectedNotes.push(note); else selectedNotes[2]=note;
    refreshNotesDisplay(); validateLockBtn();
  }

  function validateLockBtn(){
    const nameOk = ($('#displayName').value||'').trim().length>0;
    const codeOk = ($('#code').value||'').trim().length>0;
    const emailOk = validEmail($('#email').value);
    const notesOk = selectedNotes.length===3;
    $('#lockBtn').disabled = !(nameOk && codeOk && emailOk && notesOk);
  }

  /* === é‹¼ç´ === */
  function renderPiano(){
    const kb=$('#keyboard'); kb.innerHTML=''; kb.className='';
    sizePiano();
    const keyW=100/TOTAL_WHITE;

    WHITE.forEach((note,i)=>{
      const w=document.createElement('div'); w.className='white'; w.dataset.note=note;
      w.style.left=(i*keyW)+'%'; w.style.width=keyW+'%';
      if(note[0]==='C'||note[0]==='G'){ const lab=document.createElement('div'); lab.className='label'; lab.textContent=note; w.appendChild(lab); }
      w.addEventListener('pointerdown', ()=>{
        if(hardLocked) return;
        if(!unlocked){ $('#unlockOverlay').classList.remove('hidden'); return; }
        trigger(note); w.classList.add('active');
      });
      w.addEventListener('pointerup', ()=>w.classList.remove('active'));
      kb.appendChild(w);
    });

    WHITE.forEach((note,i)=>{
      const l=note[0], sharp = BLACK_AFTER[l]? (BLACK_AFTER[l]+note.slice(1)) : null;
      if(!sharp || (l==='A' && i===TOTAL_WHITE-1)) return;
      const b=document.createElement('div'); b.className='black'; b.dataset.note=sharp;
      const blackWidthPct = keyW*0.62;
      b.style.width = blackWidthPct+'%'; b.style.left=((i+1)*keyW)+'%';
      b.addEventListener('pointerdown', ()=>{
        if(hardLocked) return;
        if(!unlocked){ $('#unlockOverlay').classList.remove('hidden'); return; }
        trigger(sharp); b.classList.add('active');
      });
      b.addEventListener('pointerup', ()=>b.classList.remove('active'));
      kb.appendChild(b);
    });
  }

  function sizePiano(){
    const wrap=document.querySelector('.kb-wrap');
    const kb=document.querySelector('#keyboard');
    const wrapW=wrap.clientWidth;
    const sep=parseInt(getComputedStyle(kb).getPropertyValue('--sep')||'2',10);
    const minW=WHITE.length*(MIN_WHITE_PX+sep);
    /* ç›´å‘ä¸è¶³æ™‚æœƒè¶…å‡ºâ†’å› ç‚º .kb-wrap å¯æ°´å¹³å·è»¸ï¼Œæ‰€ä»¥å¯ä»¥æ»‘ */
    kb.style.width=(wrapW>=minW?wrapW-1:minW)+'px';
    kb.style.height='var(--kb-h)';
  }

  /* === å‰ä»– === */
  function renderGuitar(){
    const kb=$('#keyboard'); kb.innerHTML=''; kb.className='fretboard'; kb.style.height='var(--kb-h)';

    const head=document.createElement('div'); head.className='head'; kb.appendChild(head);
    const nut =document.createElement('div');  nut.className='nut';  kb.appendChild(nut);
    const bridge=document.createElement('div'); bridge.className='bridge'; kb.appendChild(bridge);

    for(let s=0;s<6;s++){
      const y=(s+1)*(100/7);
      const str=document.createElement('div'); str.className='string'; str.dataset.s=String(s); str.style.top=`calc(${y}% )`; kb.appendChild(str);
      const hline=document.createElement('div'); hline.className='head-line'; hline.dataset.s=String(s); hline.style.top=`calc(${y}% )`; kb.appendChild(hline);
    }

    for(let f=1; f<=13; f++){
      const col=document.createElement('div'); col.className='fret-col';

      for(let s=0; s<6; s++){
        const y=(s+1)*(100/7);
        const hit=document.createElement('div'); hit.className='hit-row'; hit.style.top=`calc(${y}% )`; col.appendChild(hit);
      }

      col.addEventListener('pointerdown',(ev)=>{
        if(hardLocked) return;
        if(!unlocked){ $('#unlockOverlay').classList.remove('hidden'); return; }

        const rect = col.getBoundingClientRect();
        const y = ev.clientY - rect.top;
        const slot = rect.height/7;
        let idx = Math.round(y/slot - 1);
        idx = Math.max(0, Math.min(5, idx));

        if(f<=12){
          const midi = TUNING_MIDI[5-idx] + f;
          const note = NOTE_NAMES[midi % 12] + (Math.floor(midi/12) - 1);
          trigger(note);
        }

        const target = kb.querySelector(`.string[data-s="${idx}"]`);
        if(target){
          target.classList.remove('vibrate'); void target.offsetWidth;   // é‡æ–°è§¸ç™¼å‹•ç•«
          target.classList.add('vibrate');
          setTimeout(()=>target.classList.remove('vibrate'), 380);
        }
      });

      kb.appendChild(col);
    }
  }

  /* === äº‹ä»¶èˆ‡æµç¨‹ === */
  $('#instrument').addEventListener('change', ()=>{
    if(hardLocked) return;
    currentInstrument=$('#instrument').value;
    loadSampler(currentInstrument);
    if(currentInstrument==='guitar') renderGuitar(); else renderPiano();
    validateLockBtn();
  });
  $('#displayName').addEventListener('input', validateLockBtn);
  $('#code').addEventListener('input', validateLockBtn);
  $('#email').addEventListener('input', validateLockBtn);

  $('#resetBtn').addEventListener('click', ()=>{
    if(hardLocked) return;
    if(selectedNotes.length>0){ selectedNotes.pop(); refreshNotesDisplay(); validateLockBtn(); }
  });

  // è¦–çª—æµç¨‹ï¼šæ“ä½œèªªæ˜ â†’ å•Ÿç”¨è²éŸ³
  $('#guideOk').addEventListener('click', ()=>{
    $('#guideOverlay').classList.add('hidden');
    $('#unlockOverlay').classList.remove('hidden');
  });
  $('#cancelUnlock').addEventListener('click', ()=>{ $('#unlockOverlay').classList.add('hidden'); });
  $('#confirmUnlock').addEventListener('click', unlockAudio, {once:true});
  window.addEventListener('keydown', (e)=>{
    if(e.key==='Escape'){
      $('#guideOverlay').classList.add('hidden');
      $('#unlockOverlay').classList.add('hidden');
    }
  });

  // é–å®šï¼šæˆåŠŸæ‰é–
  $('#lockBtn').addEventListener('click', async ()=>{
    if(hardLocked) return;
    const name=($('#displayName').value||'').trim();
    const code=($('#code').value||'').trim();
    const email=($('#email').value||'').trim();
    if(!name||!code||!validEmail(email)||selectedNotes.length!==3){
      alert('è«‹å¡«å§“åã€ä»£è™Ÿã€Email ä¸¦å½ˆæ»¿ 3 å€‹éŸ³å†é–å®š'); return;
    }
    setStatus('â³ é€å‡ºä¸­â€¦');
    const payload={ userId:code, displayName:name, instrument:currentInstrument, note:selectedNotes.join(','), velocity:1, sessionId:'demo', email };
    const controller=new AbortController(); const timer=setTimeout(()=>controller.abort(),6000);
    try{
      const r=await fetch(WEBHOOK,{ method:'POST', headers:{'Content-Type':'text/plain'}, body:JSON.stringify(payload), signal:controller.signal });
      clearTimeout(timer);
      if(r.headers.get('content-type')?.includes('application/json')){
        const data = await r.json();
        if(data.ok){ setStatus('âœ… å·²é€å‡ºæˆåŠŸï¼Œå¯é€€å‡ºæ­¤ä»‹é¢'); enterHardLock(); }
        else{
          let msg='âŒ é€å‡ºå¤±æ•—'; const err=String(data.error||'');
          if(err.includes('duplicate+deadline_passed')) msg='ğŸ“… æ‚¨å·²å¡«å¯«éå›‰ï¼Œé‡è¦çš„æ˜¯ï¼Œå·²éå¡«å¯«æˆªæ­¢æ—¥äº†ğŸ’”';
          else if(err.includes('duplicate+code_not_found')) msg='ğŸ” æ‚¨å·²å¡«å¯«éå›‰ï¼Œä¸”æ‚¨è¼¸å…¥çš„é€™çµ„ä»£è™Ÿæˆ‘æ‰¾å°‹ä¸åˆ°ï¼Œæˆ‘æ„Ÿåˆ°è¬åˆ†æŠ±æ­‰ğŸ‘€';
          else if(err==='duplicate') msg='ğŸ“ å·²å¡«å¯«éå›‰ï¼Œæƒ³è¦é‡æ–°å¡«å¯«è«‹æ´½ã„Ÿå’ªğŸ™';
          else if(err==='email_required') msg='âš ï¸ Emailç¼ºå°‘æˆ–æ ¼å¼ä¸æ­£ç¢ºï¼Œå†å¹«æˆ‘ä»”ç´°çœ‹çœ‹å¥½å’ªğŸ“§';
          else if(err==='email_domain_invalid') msg='ğŸ” Emailç¶²åŸŸç„¡æ³•æ”¶ä¿¡ï¼Œè«‹ç¢ºèªæ‹¼å­—æˆ–æ”¹ç”¨å¦ä¸€å€‹Emailï¼Œè·ªæ±‚ğŸ™‡â€â™‚ï¸';
          else if(err==='deadline_passed') msg='ğŸ“£ éå¸¸æŠ±æ­‰ï¼Œå·²éäº†å¡«å¯«æˆªæ­¢æ—¥ï¼Œä½†é‚„æ˜¯å¯ä»¥åœ¨é€™ç©è€å”·ğŸ‘£';
          else if(err==='code_not_found') msg='ğŸ” æ‰¾å°‹ä¸åˆ°ä»£è™Ÿï¼Œè«‹æ´½æ–°äººå”·ğŸ¤µğŸ»â€â™‚ï¸ğŸ‘°ğŸ»â€â™€ï¸';
          else if(err==='busy') msg='âš ï¸ ç³»çµ±å¿™ç¢Œï¼Œè«‹ç¨å¾Œå†è©¦ï¼Œçµ¦å®ƒé€²æ“Šçš„é‡æ–°æ•´ç†ğŸ’‹';
          setStatus(msg);
        }
      }else{
        if(r.ok){ setStatus('âœ… å·²é€å‡ºæˆåŠŸï¼Œå¯é€€å‡ºæ­¤ä»‹é¢'); enterHardLock(); }
        else{ setStatus('âŒ é€å‡ºå¤±æ•—'); }
      }
    }catch(e){ setStatus('âŒ é€å‡ºé€¾æ™‚æˆ–å¤±æ•—'); }
  });

  function enterHardLock(){
    hardLocked=true;
    $('#displayName').disabled=true; $('#code').disabled=true; $('#email').disabled=true;
    $('#instrument').disabled=true;  $('#resetBtn').disabled=true; $('#lockBtn').disabled=true;
    $('#lockScreen').style.display='block';
  }

  window.addEventListener('resize', ()=>{ if(currentInstrument==='piano') sizePiano(); });
  window.addEventListener('orientationchange', ()=>{ if(currentInstrument==='piano') sizePiano(); });

  // å•Ÿå‹•
  window.addEventListener('DOMContentLoaded', ()=>{
    renderPiano();
    setStatus('ç­‰å¾…å•Ÿç”¨è²éŸ³â€¦');
    validateLockBtn();
    $('#guideOverlay').classList.remove('hidden');
  });
  </script>
</body>
</html>
