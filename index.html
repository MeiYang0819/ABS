<!doctype html>
<html lang="zh-Hant">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>多樂器鍵盤（修正版：取樣可載、無延音）</title>
<style>
  body{font-family:system-ui,-apple-system,"Noto Sans TC",sans-serif;margin:0;padding:16px;background:#f6f7fb;}
  .panel{background:#fff;border-radius:14px;box-shadow:0 10px 25px rgba(0,0,0,.08);padding:14px;}
  #status{background:#eef1f6;border-radius:10px;padding:10px;margin-top:10px;font-size:14px;white-space:pre-wrap}
  .row{display:flex;gap:10px;align-items:center;margin-top:8px;flex-wrap:wrap}
  input,select{padding:8px 10px;font-size:14px}
  .kb-wrap{overflow-x:auto;background:#eceff4;border-radius:14px;margin-top:12px}
  #keyboard{position:relative;height:220px;min-width:720px;user-select:none;-webkit-user-select:none}
  .white{position:absolute;bottom:0;height:100%;background:linear-gradient(#fff,#e6e7ea 70%,#d1d3d8);
    border-radius:0 0 10px 10px;box-shadow:inset 0 -8px 10px rgba(0,0,0,.12),inset 0 1px 0 rgba(255,255,255,.9),0 1px 0 rgba(0,0,0,.05);} 
  .white.active{filter:brightness(1.08)}
  .black{position:absolute;bottom:38%;height:62%;background:linear-gradient(#2f2f2f,#0c0c0c);border-radius:0 0 8px 8px;z-index:3}
  .black.active{filter:brightness(1.25)}
  .label{position:absolute;bottom:8px;left:50%;transform:translateX(-50%);font-size:11px;color:#7a8396;background:#fff9;border:1px solid #e4e7ef;padding:2px 6px;border-radius:8px}
</style>
<body>
  <div class="panel">
    <h2>多樂器鍵盤（修正版：取樣可載、無延音）</h2>

    <div class="row">
      <label>顯示名稱：</label>
      <input id="displayName" placeholder="例如：小明" style="flex:1">
      <label>樂器：</label>
      <select id="instrument">
        <option value="piano" selected>鋼琴</option>
        <option value="guitar-electric">電吉他</option>
        <option value="guitar-acoustic">木吉他</option>
        <option value="violin">小提琴</option>
        <option value="cello">大提琴</option>
        <option value="flute">長笛</option>
        <option value="saxophone">薩克斯風</option>
      </select>
    </div>

    <p id="status">尚未初始化（第一次點琴鍵會自動載入）</p>
    <div class="kb-wrap"><div id="keyboard"></div></div>
  </div>

  <!-- Tone.js 主 CDN + 備援 -->
  <script src="https://cdn.jsdelivr.net/npm/tone@14.8.49/build/Tone.min.js"></script>
  <script>
    if (!window.Tone) {
      const s = document.createElement('script');
      s.src = "https://unpkg.com/tone@14.8.49/build/Tone.min.js";
      document.head.appendChild(s);
    }
  </script>

  <script>
    // ===== 固定 Webhook（請替換為你自己的） =====
    const WEBHOOK = "https://script.google.com/macros/s/AKfycbw3rDKy-mjN93ValBMs28ndCFv5IbqjupDgn9rHvqYOqJwo5If3DdB1zVervdluT8YW/exec";

    const $ = s => document.querySelector(s);
    const statusEl = $('#status');

    let engineReady = false;   // Tone 是否啟動
    let sampler = null;        // 取樣器（成功時）
    let synthFallback = null;  // 內建合成器（取樣失敗時）

    // ===== 23 鍵（C3~B4；移除最右 C5 與 A#4）=====
    const START_OCTAVE=3, OCTAVES=2, INCLUDE_TOP_C=true;
    function whites(){
      const order=["C","D","E","F","G","A","B"], notes=[];
      for(let o=START_OCTAVE;o<START_OCTAVE+OCTAVES;o++){ for(const n of order) notes.push(n+o); }
      if(INCLUDE_TOP_C) notes.push("C"+(START_OCTAVE+OCTAVES));
      notes.pop(); return notes;
    }
    const WHITE=whites(), BLACK_MAP={"C":"C#","D":"D#","F":"F#","G":"G#","A":"A#"};

    function buildKeyboard(){
      const kb=$('#keyboard'); kb.innerHTML='';
      const total=WHITE.length, keyW=100/total;

      WHITE.forEach((note,i)=>{
        const w=document.createElement('div'); w.className='white'; w.dataset.note=note;
        w.style.left=`${i*keyW}%`; w.style.width=`${keyW}%`;
        if(note[0]==='C'||note[0]==='G'){ const lab=document.createElement('div'); lab.className='label'; lab.textContent=note; w.appendChild(lab); }
        kb.appendChild(w);
      });

      WHITE.forEach((note,i)=>{
        const l=note[0]; let s=BLACK_MAP[l]?BLACK_MAP[l]+note.slice(1):null;
        if(l==='A' && i===WHITE.length-1) s=null; if(!s) return;
        const b=document.createElement('div'); b.className='black'; b.dataset.note=s;
        b.style.left=`calc(${i*keyW}% + ${keyW*0.66}%)`; b.style.width=`${keyW*0.64}%`;
        kb.appendChild(b);
      });

      const kbEl = $('#keyboard');
      kbEl.addEventListener('pointerdown', async e=>{
        const t=e.target.closest('.white,.black'); if(!t) return;
        t.setPointerCapture?.(e.pointerId);
        await onKeyDown(t.dataset.note, t);
      });
      kbEl.addEventListener('pointerup', e=>{
        const t=e.target.closest('.white,.black'); if(!t) return;
        onKeyUp(t.dataset.note, t);
      });
    }

    function setStatus(msg){
      const toneOK = !!window.Tone;
      const eng = engineReady ? (Tone.context?.state||'running?') : 'not started';
      statusEl.textContent = `${msg}\nTone.js載入：${toneOK}｜AudioContext：${eng}`;
    }

    async function ensureEngine(){
      if (engineReady) return;
      let tries = 0;
      while (!window.Tone && tries++ < 40) { await new Promise(r=>setTimeout(r,100)); }
      if (!window.Tone) { setStatus('無法載入 Tone.js（CDN 被擋？）'); throw new Error('Tone not loaded'); }
      await Tone.start(); // 由使用者手勢啟動
      engineReady = true;
    }

    // === 修正重點：正確的音色目錄 + 多取樣對映，並改用 sampler.loaded ===
    const INSTRUMENT_BASE = {
      'piano': 'piano',
      'guitar-electric': 'guitar-electric',
      'guitar-acoustic': 'guitar-acoustic',
      'violin': 'violin',
      'cello': 'cello',
      'flute': 'flute',
      'saxophone': 'saxophone'
    };

    // 用少量跨八度的取樣，Tone 會自動轉調補齊其他音
    const DEFAULT_URLS = {
      'A1': 'A1.mp3',
      'C2': 'C2.mp3', 'D#2': 'Ds2.mp3', 'F#2': 'Fs2.mp3', 'A2': 'A2.mp3',
      'C3': 'C3.mp3', 'D#3': 'Ds3.mp3', 'F#3': 'Fs3.mp3', 'A3': 'A3.mp3',
      'C4': 'C4.mp3', 'D#4': 'Ds4.mp3', 'F#4': 'Fs4.mp3', 'A4': 'A4.mp3',
      'C5': 'C5.mp3'
    };

    async function ensureInstrument(){
      if (sampler || synthFallback) return;
      const type = $('#instrument').value;
      const folder = INSTRUMENT_BASE[type] || 'piano';
      const baseUrl = `https://tonejs.github.io/audio/${folder}/`;

      try {
        sampler = new Tone.Sampler({ urls: DEFAULT_URLS, release: 1, baseUrl, onload:()=>{} }).toDestination();
        await sampler.loaded; // 等待載入完成（v14）
        setStatus(`音源已載入 ✅（${$('#instrument').selectedOptions[0].text}）`);
      } catch (e) {
        sampler = null;
        synthFallback = new Tone.PolySynth(Tone.Synth).toDestination();
        setStatus(`⚠️ 無法載入取樣，改用內建合成器（嗶聲）`);
      }
    }

    async function onKeyDown(note, el){
      el.classList.add('active');
      try{
        await ensureEngine();
        await ensureInstrument();
        playNote(note);
        log(note);
      }catch(err){
        setStatus('初始化失敗：'+err.message+'\n建議：重新整理或換無痕/換網路');
      }
    }
    function onKeyUp(note, el){
      el.classList.remove('active');
      // 已移除延音功能：不做持續，交由 triggerAttackRelease 的固定長度
    }

    // === 已移除延音：改為固定時值 ===
    const NOTE_DURATION = '8n';
    function playNote(note, vel=0.9){
      if (sampler) {
        sampler.triggerAttackRelease(note, NOTE_DURATION, undefined, vel);
      } else if (synthFallback) {
        synthFallback.triggerAttackRelease(note, NOTE_DURATION, undefined, vel);
      }
    }

    function log(note, vel=0.9){
      const payload = {
        userId:"guest", // 之後串 LIFF 會改為實際 userId
        displayName: $('#displayName').value || 'Guest',
        instrument: $('#instrument').value,
        note, velocity: vel, sessionId: 'demo'
      };
      fetch(WEBHOOK, {
        method: 'POST',
        headers: {'Content-Type':'text/plain;charset=UTF-8'},
        body: JSON.stringify(payload)
      })
      .then(r=>r.text())
      .then(txt=> setStatus(`已記錄：${note}｜回應：${txt}`))
      .catch(err=> setStatus('記錄失敗：'+err.message));
    }

    // 樂器切換時重建取樣器
    $('#instrument').addEventListener('change', ()=>{
      sampler = null; synthFallback = null;
      setStatus('已切換樂器，請點琴鍵載入音源…');
    });

    // 生成鍵盤
    (function init(){ buildKeyboard(); setStatus('尚未初始化（第一次點琴鍵會自動載入）'); })();
  </script>
</body>
</html>
