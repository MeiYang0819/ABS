<!doctype html>
<html lang="zh-Hant">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>互動音符</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700&display=swap" rel="stylesheet">
<style>
  :root{
    --rim:#e4e7ef; --ink:#0f172a; --kb-h:280px; --sep:2px;
    --stroke:rgba(0,0,0,.18); --glow:rgba(255,255,255,.65);
  }
  *{
    box-sizing:border-box;
    font-family:"Zen Maru Gothic","Noto Sans TC",system-ui,-apple-system,sans-serif !important;
    -webkit-text-stroke:.35px var(--stroke);
    text-shadow:0 1px 0 var(--glow);
  }
  html,body{ margin:0; color:var(--ink);
    background:linear-gradient(135deg,#e6dfff 0%, #dcd4ff 100%); }
  .panel{
    max-width:1060px;margin:22px auto;
    background:rgba(255,255,255,.58);
    border:1px solid rgba(255,255,255,.65);
    border-radius:16px; padding:18px 18px 26px;
    box-shadow:0 10px 30px rgba(98,76,171,.12);
    backdrop-filter:blur(10px) saturate(120%);
  }
  h2{
    margin:4px 0 20px; text-align:center;
    font-size:2.8rem; font-weight:700; letter-spacing:1px;
    -webkit-text-stroke:.7px var(--stroke);
    text-shadow:0 3px 4px rgba(255,255,255,.85);
  }

  /* 第二行：等寬 */
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .row label{opacity:.92;white-space:nowrap;font-weight:400;-webkit-text-stroke:0;text-shadow:none}
  .row input,.row select,.row button{
    padding:8px 10px; border:1px solid var(--rim); border-radius:10px;
    height:38px; font-size:14px; background:#fff;
    -webkit-text-stroke:.25px rgba(0,0,0,.12);
    text-shadow:0 1px 0 rgba(255,255,255,.5);
  }
  .row input{width:100px;font-weight:400;-webkit-text-stroke:0;text-shadow:none}
  .row select{width:120px;text-align:center;text-align-last:center;-webkit-text-stroke:0;text-shadow:none}
  .row select option{text-align:center}
  .row button{width:120px;cursor:pointer;font-weight:600}
  .row button:disabled{opacity:.55;cursor:not-allowed}

  /* 狀態列置中，只顯示取樣/錯誤 */
  #status{
    background:#eef2f7;border:1px solid var(--rim);
    border-radius:12px;padding:10px;margin-top:10px;
    font-size:14px;white-space:pre-wrap;color:#334155;text-align:center;
  }

  /* 鍵盤外框 / 指板外框（共用容器） */
  .kb-wrap{
    overflow-x:auto; -webkit-overflow-scrolling:touch;
    background:linear-gradient(180deg,#f7f2ff 0%, #ede9fe 100%);
    border:1px solid var(--rim); border-radius:14px; margin-top:14px;
  }
  #keyboard{ position:relative; height:var(--kb-h);
    user-select:none; -webkit-user-select:none; touch-action:pan-x; }

  /* ====== 鋼琴樣式 ====== */
  .white{
    position:absolute; bottom:0; height:100%;
    background:linear-gradient(#ffffff,#eceef3 72%,#d9dde5);
    border-radius:0 0 12px 12px;
    box-shadow:inset 0 -12px 16px rgba(0,0,0,.12),
               inset 0 1px 0 rgba(255,255,255,.9),
               0 1px 0 rgba(0,0,0,.04);
  }
  .white::after{
    content:""; position:absolute; top:0; bottom:0; right:0; width:var(--sep);
    background:linear-gradient(transparent,#cfd3dc 50%,transparent);
  }
  .white:first-child::before{
    content:""; position:absolute; top:0; bottom:0; left:0; width:var(--sep);
    background:linear-gradient(transparent,#cfd3dc 50%,transparent);
  }
  .white.active{filter:brightness(1.06)}
  .black{
    position:absolute; bottom:38%; height:62%; width:6.4%;
    background:linear-gradient(#2d2f36,#0e0f13);
    border:1px solid #0b0d11; border-top:none;
    border-radius:0 0 10px 10px; z-index:5;
    box-shadow:inset 0 -6px 10px rgba(0,0,0,.45),
               0 3px 10px rgba(0,0,0,.35);
  }
  .black.active{filter:brightness(1.22)}
  .label{
    position:absolute; bottom:12px; left:50%; transform:translateX(-50%);
    font-size:11px; color:#475569; background:#ffffffee; border:1px solid var(--rim);
    padding:2px 6px; border-radius:8px;
    -webkit-text-stroke:.25px rgba(0,0,0,.12);
    text-shadow:0 1px 0 rgba(255,255,255,.6);
  }

  /* ====== 吉他指板樣式 ====== */
  .fretboard{ position:relative; display:grid; grid-auto-flow:column;
    grid-auto-columns:64px; height:var(--kb-h); background:linear-gradient(#f2ecff,#e6defe); }
  .fret-col{ position:relative; border-left:2px solid rgba(0,0,0,.12); }
  .nut{ position:absolute; left:0; top:0; bottom:0; width:6px;
    background:linear-gradient(#ddd,#bbb); border-right:2px solid #9aa0a6; z-index:3; }
  .string{
    position:absolute; left:0; right:0; height:2px; background:linear-gradient(#666,#333);
    opacity:.85;
  }
  .marker{
    position:absolute; bottom:12px; left:50%; transform:translateX(-50%);
    font-size:12px; color:#6b7280; background:#ffffffd0; border:1px solid var(--rim);
    padding:1px 6px; border-radius:999px;
  }
  .note-btn{
    position:absolute; width:28px; height:28px; border-radius:50%;
    background:#ffffff; border:2px solid #8b5cf6; box-shadow:0 2px 8px rgba(0,0,0,.15);
    display:flex; align-items:center; justify-content:center; font-size:12px; color:#4c1d95; cursor:pointer;
    transform:translate(-50%,-50%);
  }
  .note-btn:active, .note-btn.active{ filter:brightness(1.1); }

  /* ==== 解鎖彈跳視窗 ==== */
  #unlockOverlay{
    position: fixed; inset: 0; z-index: 9999;
    display: flex; align-items: center; justify-content: center;
    background: rgba(17,24,39,.35); backdrop-filter: blur(3px);
  }
  #unlockCard{
    min-width:260px; max-width:90vw;
    background:rgba(255,255,255,.92);
    border:1px solid rgba(255,255,255,.8);
    border-radius:14px; padding:18px 18px 16px;
    box-shadow:0 16px 40px rgba(0,0,0,.18);
    text-align:center;
  }
  #unlockCard #unlockBtn{
    margin-top:12px;
    width:160px; height:40px;
    border-radius:10px; border:1px solid var(--rim);
    background:#fff; cursor:pointer; font-weight:600;
  }
</style>
<body>
  <div class="panel">
    <h2>互動音符</h2>

    <div class="row">
      <label for="displayName">親友姓名：</label>
      <input id="displayName" placeholder="例如：小明" />

      <label for="code">取得代號：</label>
      <input id="code" placeholder="請輸入代號" />

      <label for="lastNote">紀錄：</label>
      <input id="lastNote" placeholder="尚未彈奏" readonly />

      <label for="instrument">樂器轉換：</label>
      <select id="instrument">
        <option value="piano" selected>鋼琴</option>
        <option value="guitar">吉他</option>
      </select>

      <button id="lockBtn" disabled>確認鎖定</button>
    </div>

    <p id="status">尚未初始化</p>

    <div class="kb-wrap"><div id="keyboard"></div></div>
  </div>

  <!-- 彈跳 Overlay -->
  <div id="unlockOverlay">
    <div id="unlockCard">
      <div style="font-size:16px;opacity:.9">請開啟音量並點擊下方按鈕啟用聲音</div>
      <div style="font-size:12px;opacity:.7;margin-top:6px">iPhone 請確認側邊靜音鍵關閉</div>
      <button id="unlockBtn">啟用聲音</button>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/tone@14.8.49/build/Tone.min.js"></script>
  <script>
    const WEBHOOK = "YOUR_GAS_WEBHOOK_URL";

    const $ = s => document.querySelector(s);
    const setStatus = m => $('#status').textContent = m;

    let audioCtx=null, sampler=null, samplerReady=false, unlocked=false;
    let currentInstrument='piano', lastNote='';

    const PIANO_BASE=new URL('./piano/',location.href).href;
    const PIANO_URLS={'A1':'A1.mp3','C2':'C2.mp3','D#2':'Ds2.mp3','F#2':'Fs2.mp3','A2':'A2.mp3',
                      'C3':'C3.mp3','D#3':'Ds3.mp3','F#3':'Fs3.mp3','A3':'A3.mp3',
                      'C4':'C4.mp3','D#4':'Ds4.mp3','F#4':'Fs4.mp3','A4':'A4.mp3','C5':'C5.mp3'};
    const GUITAR_BASE=new URL('./guitar/',location.href).href;
    const GUITAR_URLS={'E2':'E2.wav','A2':'A2.wav','D3':'D3.wav','G3':'G3.wav','B3':'B3.wav','E4':'E4.wav'};

    const WHITE=["C3","D3","E3","F3","G3","A3","B3","C4","D4","E4","F4","G4","A4","B4"];
    const BLACK_AFTER={ 'C':'C#','D':'D#','F':'F#','G':'G#','A':'A#' };
    const MIN_WHITE_PX=64, TOTAL_WHITE=WHITE.length;

    const TUNING_MIDI = [40,45,50,55,59,64];
    const NOTE_NAMES = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
    const FRETS = 13;

    function midiToNoteName(midi){
      const n = NOTE_NAMES[midi % 12];
      const octave = Math.floor(midi/12) - 1;
      return n.replace('♯','#') + octave;
    }

    async function unlockAudio(){
      try{
        const Ctx=window.webkitAudioContext||window.AudioContext;
        if(!audioCtx) audioCtx=new Ctx({latencyHint:'interactive'});
        if(audioCtx.state!=='running') await audioCtx.resume();
        Tone.setContext(new Tone.Context(audioCtx));
        await Tone.start();
        loadSampler(currentInstrument);
        unlocked=true;
        $('#unlockOverlay').style.display='none';
        setStatus('音訊已啟用，音色載入中…');
      }catch(e){ setStatus('啟用失敗：'+e.message); }
    }

    function loadSampler(inst='piano'){
      sampler?.dispose?.(); sampler=null; samplerReady=false;
      let urls=PIANO_URLS, base=PIANO_BASE, label='鋼琴';
      if(inst==='guitar'){ urls=GUITAR_URLS; base=GUITAR_BASE; label='吉他'; }
      setStatus(label+'取樣載入中…');
      sampler=new Tone.Sampler({
        urls, release:1, baseUrl:base,
        onload:()=>{ samplerReady=true; setStatus(label+'取樣已載入 ✅'); }
      }).toDestination();
    }

    function trigger(note){
      if(!samplerReady){ setStatus('音色載入中…'); return; }
      sampler.triggerAttackRelease(note,'8n');
      lastNote = note;
      $('#lastNote').value = note;
      $('#lockBtn').disabled = false;

      const payload={userId:'guest',displayName:$('#displayName').value||'Guest',
                     instrument:currentInstrument,note:note,velocity:1,sessionId:'demo'};
      fetch(WEBHOOK,{method:'POST',headers:{'Content-Type':'text/plain'},body:JSON.stringify(payload)})
        .catch(err=>setStatus('記錄失敗：'+err.message));
    }

    function renderPiano(){
      const kb=$('#keyboard'); kb.innerHTML='';
      kb.className=''; sizePiano();
      const keyW=100/TOTAL_WHITE;

      WHITE.forEach((note,i)=>{
        const w=document.createElement('div'); w.className='white'; w.dataset.note=note;
        w.style.left=`${i*keyW}%`; w.style.width=`${keyW}%`;
        if(note[0]==='C'||note[0]==='G'){
          const lab=document.createElement('div'); lab.className='label'; lab.textContent=note; w.appendChild(lab);
        }
        kb.appendChild(w);
      });

      WHITE.forEach((note,i)=>{
        const l=note[0],sharp=BLACK_AFTER[l]?BLACK_AFTER[l]+note.slice(1):null;
        if(!sharp||(l==='A'&&i===TOTAL_WHITE-1)) return;
        const b=document.createElement('div'); b.className='black'; b.dataset.note=sharp;
        b.style.left=`calc(${i*keyW}% + ${keyW*0.68}%)`;
        kb.appendChild(b);
      });

      kb.addEventListener('pointerdown',onPianoDown);
      kb.addEventListener('pointerup',onPianoUp);
      kb.addEventListener('touchstart',onPianoTouchStart,{passive:true});
      kb.addEventListener('touchend',onPianoTouchEnd,{passive:true});
    }
    function onPianoDown(e){
      const k=e.target?.closest('.black,.white'); if(!k) return;
      if(!unlocked) unlockAudio();
      trigger(k.dataset.note); k.classList.add('active');
    }
    function onPianoUp(e){ const k=e.target?.closest('.black,.white'); if(k) k.classList.remove('active'); }
    function onPianoTouchStart(e){ const t=e.touches[0]; const el=document.elementFromPoint(t.clientX,t.clientY); onPianoDown({target:el}); }
    function onPianoTouchEnd(e){ const t=e.changedTouches[0]; const el=document.elementFromPoint(t.clientX,t.clientY); onPianoUp({target:el}); }
    function sizePiano(){
      const wrap=document.querySelector('.kb-wrap');
      const kb=document.querySelector('#keyboard');
      const wrapW=wrap.clientWidth;
      const sep=parseInt(getComputedStyle(kb).getPropertyValue('--sep')||'2');
      const minW=TOTAL_WHITE*(MIN_WHITE_PX+sep);
      kb.style.width=(wrapW>=minW?wrapW-1:minW)+'px';
      kb.style.height='var(--kb-h)';
    }

    function renderGuitar(){
      const kb=$('#keyboard'); kb.innerHTML='';
      kb.className='fretboard'; kb.style.height='var(--kb-h)';

      for(let f=0; f<FRETS; f++){
        const col=document.createElement('div'); col.className='fret-col';
        if(f===0){ const nut=document.createElement('div'); nut.className='nut'; col.appendChild(nut); }
        for(let s=0; s<6; s++){
          const y=(s+1)*(100/7);
          const str=document.createElement('div'); str.className='string'; str.style.top=`calc(${y}%)`; col.appendChild(str);
          const midi=TUNING_MIDI[5-s]+f; const note=midiToNoteName(midi);
          const btn=document.createElement('div'); btn.className='note-btn'; btn.dataset.note=note;
          btn.style.top=`calc(${y}%)`; btn.style.left=f===0?'22px':'32px';
          btn.addEventListener('pointerdown',ev=>{ if(!unlocked) unlockAudio(); trigger(note); btn.classList.add('active'); });
          btn.addEventListener('pointerup',()=>btn.classList.remove('active'));
          col.appendChild(btn);
        }
        if([3,5,7,9,12].includes(f)){
          const mk=document.createElement('div'); mk.className='marker'; mk.textContent=f; mk.style.left='50%'; mk.style.bottom='8px'; col.appendChild(mk);
        }
        kb.appendChild(col);
      }
      kb.style.minWidth=(FRETS*64+16)+'px';
    }

    $('#instrument').addEventListener('change', ()=>{currentInstrument=$('#instrument').value;loadSampler(currentInstrument);if(currentInstrument==='guitar')renderGuitar();else renderPiano();});
    $('#unlockBtn').addEventListener('click', unlockAudio, {once:true});
    window.addEventListener('resize', ()=>{if(currentInstrument==='piano') sizePiano();});
    window.addEventListener('orientationchange', ()=>{if(currentInstrument==='piano') sizePiano();});
    window.addEventListener('DOMContentLoaded', ()=>{renderPiano();sizePiano();setStatus('初始化完成。請先啟用聲音或點擊琴鍵/指板。');});
  </script>
</body>
</html>
