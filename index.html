<!doctype html>
<html lang="zh-Hant">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>多樂器鍵盤（穩定出聲／無延音｜鋼琴取樣）</title>
<style>
  body{font-family:system-ui,-apple-system,"Noto Sans TC",sans-serif;margin:0;padding:16px;background:#f6f7fb;}
  .panel{background:#fff;border-radius:14px;box-shadow:0 10px 25px rgba(0,0,0,.08);padding:14px;}
  #status{background:#eef1f6;border-radius:10px;padding:10px;margin-top:10px;font-size:14px;white-space:pre-wrap}
  .row{display:flex;gap:10px;align-items:center;margin-top:8px;flex-wrap:wrap}
  input{padding:8px 10px;font-size:14px}
  .kb-wrap{overflow-x:auto;background:#eceff4;border-radius:14px;margin-top:12px}
  #keyboard{position:relative;height:220px;min-width:720px;user-select:none;-webkit-user-select:none}
  .white{position:absolute;bottom:0;height:100%;background:linear-gradient(#fff,#e6e7ea 70%,#d1d3d8);
    border-radius:0 0 10px 10px;box-shadow:inset 0 -8px 10px rgba(0,0,0,.12),inset 0 1px 0 rgba(255,255,255,.9),0 1px 0 rgba(0,0,0,.05);}
  .white.active{filter:brightness(1.08)}
  .black{position:absolute;bottom:38%;height:62%;background:linear-gradient(#2f2f2f,#0c0c0c);border-radius:0 0 8px 8px;z-index:3}
  .black.active{filter:brightness(1.25)}
  .label{position:absolute;bottom:8px;left:50%;transform:translateX(-50%);font-size:11px;color:#7a8396;background:#fff9;border:1px solid #e4e7ef;padding:2px 6px;border-radius:8px}
</style>
<body>
  <div class="panel">
    <h2>多樂器鍵盤（穩定出聲／無延音｜鋼琴取樣）</h2>

    <div class="row">
      <label>顯示名稱：</label>
      <input id="displayName" placeholder="例如：小明" style="flex:1">
    </div>

    <p id="status">尚未初始化（第一次點琴鍵會自動載入）</p>
    <div class="kb-wrap"><div id="keyboard"></div></div>
  </div>

  <!-- Tone.js 主 CDN + 備援 -->
  <script src="https://cdn.jsdelivr.net/npm/tone@14.8.49/build/Tone.min.js"></script>
  <script>
    if (!window.Tone) {
      const s = document.createElement('script');
      s.src = "https://unpkg.com/tone@14.8.49/build/Tone.min.js";
      document.head.appendChild(s);
    }
  </script>
  <!-- 高品質鋼琴取樣（穩定，避免 buffer 未載入） -->
  <script src="https://cdn.jsdelivr.net/npm/@tonejs/piano@0.2.0/build/Piano.js"></script>

  <script>
    // ===== 請改成你的 Webhook =====
    const WEBHOOK = "https://script.google.com/macros/s/AKfycbw3rDKy-mjN93ValBMs28ndCFv5IbqjupDgn9rHvqYOqJwo5If3DdB1zVervdluT8YW/exec";

    const $ = s => document.querySelector(s);
    const statusEl = $('#status');

    let engineReady = false; // Tone 是否啟動
    let piano = null;        // 鋼琴
    let pianoReady = false;  // 鋼琴是否載入
    const NOTE_DURATION_MS = Tone.Time('8n').toMilliseconds(); // 無延音，固定時值
    const pendingNotes = []; // 載入前暫存按鍵

    // ===== 23 鍵（C3~B4；移除最右 C5 與 A#4）=====
    const START_OCTAVE=3, OCTAVES=2, INCLUDE_TOP_C=true;
    function whites(){
      const order=["C","D","E","F","G","A","B"], notes=[];
      for(let o=START_OCTAVE;o<START_OCTAVE+OCTAVES;o++){ for(const n of order) notes.push(n+o); }
      if(INCLUDE_TOP_C) notes.push("C"+(START_OCTAVE+OCTAVES));
      notes.pop(); return notes;
    }
    const WHITE=whites(), BLACK_MAP={"C":"C#","D":"D#","F":"F#","G":"G#","A":"A#"};

    function buildKeyboard(){
      const kb=$('#keyboard'); kb.innerHTML='';
      const total=WHITE.length, keyW=100/total;

      WHITE.forEach((note,i)=>{
        const w=document.createElement('div'); w.className='white'; w.dataset.note=note;
        w.style.left=`${i*keyW}%`; w.style.width=`${keyW}%`;
        if(note[0]==='C'||note[0]==='G'){ const lab=document.createElement('div'); lab.className='label'; lab.textContent=note; w.appendChild(lab); }
        kb.appendChild(w);
      });

      WHITE.forEach((note,i)=>{
        const l=note[0]; let s=BLACK_MAP[l]?BLACK_MAP[l]+note.slice(1):null;
        if(l==='A' && i===WHITE.length-1) s=null; if(!s) return;
        const b=document.createElement('div'); b.className='black'; b.dataset.note=s;
        b.style.left=`calc(${i*keyW}% + ${keyW*0.66}%)`; b.style.width=`${keyW*0.64}%`;
        kb.appendChild(b);
      });

      const kbEl = $('#keyboard');
      kbEl.addEventListener('pointerdown', async e=>{
        const t=e.target.closest('.white,.black'); if(!t) return;
        t.setPointerCapture?.(e.pointerId);
        await onKeyDown(t.dataset.note, t);
      });
      kbEl.addEventListener('pointerup', e=>{
        const t=e.target.closest('.white,.black'); if(!t) return;
        onKeyUp(t.dataset.note, t);
      });
    }

    function setStatus(msg){
      const toneOK = !!window.Tone;
      const eng = engineReady ? (Tone.context?.state||'running?') : 'not started';
      statusEl.textContent = `${msg}\nTone.js載入：${toneOK}｜AudioContext：${eng}`;
    }

    async function ensureEngine(){
      if (engineReady) return;
      let tries = 0;
      while (!window.Tone && tries++ < 60) { await new Promise(r=>setTimeout(r,100)); }
      if (!window.Tone) { setStatus('無法載入 Tone.js（CDN 被擋？）'); throw new Error('Tone not loaded'); }
      await Tone.start(); // 必須由使用者手勢觸發
      engineReady = true;
    }

    async function ensurePiano(){
      if (pianoReady) return;
      piano = new Piano({ velocities: 2 }); // 輕量且自然
      piano.toDestination();
      await piano.load(); // === 關鍵：等取樣載入完成 ===
      pianoReady = true;
      setStatus('鋼琴音源已載入 ✅');
      // 播放排隊中的音
      while (pendingNotes.length) {
        const n = pendingNotes.shift();
        playNote(n);
      }
    }

    async function onKeyDown(note, el){
      el.classList.add('active');
      try{
        await ensureEngine();
        await ensurePiano();
        playNote(note);
        log(note);
      }catch(err){
        setStatus('初始化失敗：'+err.message+'\n建議：重新整理或換無痕/換網路');
      }
    }

    function onKeyUp(note, el){
      el.classList.remove('active');
      // 無延音：固定時值，由計時器 keyUp
    }

    function playNote(note, vel=0.9){
      if (!pianoReady) { pendingNotes.push(note); return; }
      piano.keyDown({ note, velocity: vel });
      setTimeout(()=> piano.keyUp({ note }), NOTE_DURATION_MS);
    }

    function log(note, vel=0.9){
      const payload = {
        userId:"guest", // 後續會換成 LIFF 的真實 userId
        displayName: $('#displayName').value || 'Guest',
        note, velocity: vel, instrument: 'piano', sessionId: 'demo'
      };
      fetch(WEBHOOK, {
        method: 'POST',
        headers: {'Content-Type':'text/plain;charset=UTF-8'},
        body: JSON.stringify(payload)
      })
      .then(r=>r.text())
      .then(txt=> setStatus(`已記錄：${note}｜回應：${txt}`))
      .catch(err=> setStatus('記錄失敗：'+err.message));
    }

    (function init(){ buildKeyboard(); setStatus('尚未初始化（第一次點琴鍵會自動載入）'); })();
  </script>
</body>
</html>
