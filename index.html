<!doctype html>
<html lang="zh-Hant">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>互動音符</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700&display=swap" rel="stylesheet">
<style>
  :root{
    --rim:#e4e7ef; --ink:#0f172a; --kb-h:280px; --sep:2px;
    --stroke:rgba(0,0,0,.18); --glow:rgba(255,255,255,.65);
  }
  *{box-sizing:border-box;font-family:"Zen Maru Gothic","Noto Sans TC",system-ui,-apple-system,sans-serif !important;}
  html,body{margin:0;color:var(--ink);background:linear-gradient(135deg,#e6dfff 0%, #dcd4ff 100%);}
  .panel{max-width:1060px;margin:22px auto;background:rgba(255,255,255,.58);border:1px solid rgba(255,255,255,.65);
    border-radius:16px;padding:18px 18px 26px;box-shadow:0 10px 30px rgba(98,76,171,.12);backdrop-filter:blur(10px) saturate(120%);}
  h2{margin:4px 0 20px;text-align:center;font-size:2.8rem;font-weight:700;letter-spacing:1px;}

  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .row input,.row select,.row button{height:38px;font-size:14px;border:1px solid var(--rim);border-radius:10px;background:#fff;}
  .row input{width:90px;}
  .row select{width:auto;min-width:80px;text-align:center;text-align-last:center;}
  #resetBtn,#lockBtn{width:80px;font-weight:600;cursor:pointer;}
  #lockBtn:disabled{opacity:.55;cursor:not-allowed}

  #status{background:#eef2f7;border:1px solid var(--rim);border-radius:12px;padding:10px;margin-top:10px;
    font-size:14px;white-space:pre-wrap;color:#334155;text-align:center;}

  .kb-wrap{overflow-x:auto;-webkit-overflow-scrolling:touch;background:linear-gradient(180deg,#f7f2ff 0%, #ede9fe 100%);
    border:1px solid var(--rim);border-radius:14px;margin-top:14px;}
  #keyboard{position:relative;height:var(--kb-h);user-select:none;touch-action:pan-x;}

  /* 鋼琴樣式（略） */
  .white{position:absolute;bottom:0;height:100%;background:linear-gradient(#fff,#eceef3 72%,#d9dde5);
    border-radius:0 0 12px 12px;}
  .black{position:absolute;bottom:38%;height:62%;background:linear-gradient(#2d2f36,#0e0f13);
    border:1px solid #0b0d11;border-top:none;border-radius:0 0 10px 10px;z-index:5;transform:translateX(-50%);}
  .label{position:absolute;bottom:12px;left:50%;transform:translateX(-50%);font-size:11px;color:#475569;}

  /* 吉他指板樣式 */
  .fretboard{position:relative;display:grid;grid-auto-flow:column;grid-auto-columns:64px;height:var(--kb-h);
    background:linear-gradient(#f5f3ff,#ede9fe);}
  .fret-col{position:relative;border-left:2px solid rgba(0,0,0,.15);}
  .nut{position:absolute;left:0;top:0;bottom:0;width:6px;background:linear-gradient(#ddd,#bbb);
    border-right:2px solid #9aa0a6;z-index:3;}
  .string{position:absolute;left:0;right:0;transform-origin:center;
    background:linear-gradient(#444,#111);opacity:.9;}
  .string.vibrate{animation:vibrate .15s ease-out;}
  @keyframes vibrate{
    0%{transform:translateY(0);}
    25%{transform:translateY(-2px);}
    50%{transform:translateY(0);}
    75%{transform:translateY(2px);}
    100%{transform:translateY(0);}
  }
  .marker{position:absolute;left:50%;transform:translateX(-50%);bottom:6px;font-size:12px;
    color:#6b7280;background:#ffffffd0;border-radius:999px;padding:1px 6px;}
  footer{text-align:center;margin:20px 0;color:#555;font-size:13px;}
</style>
<body>
  <div class="panel">
    <h2>互動音符</h2>
    <div class="row">
      <input id="displayName" placeholder="姓名" />
      <input id="code" placeholder="代號" />
      <select id="instrument"><option value="piano">鋼琴</option><option value="guitar">吉他</option></select>
      <input id="notes" placeholder="音符紀錄" readonly />
      <button id="resetBtn">重設</button>
      <button id="lockBtn" disabled>鎖定</button>
    </div>
    <p id="status">尚未初始化</p>
    <div class="kb-wrap"><div id="keyboard"></div></div>
  </div>
  <footer>© Copyright 2025 MY‘s Version:b1.0.0</footer>

  <div id="unlockOverlay"><div id="unlockCard">
    <div>請開啟音量並點擊下方按鈕啟用聲音</div>
    <div style="font-size:12px;opacity:.7;margin-top:6px">iPhone 請確認側邊靜音鍵關閉</div>
    <button id="unlockBtn">確定啟用聲音</button>
  </div></div>

  <script src="https://cdn.jsdelivr.net/npm/tone@14.8.49/build/Tone.min.js"></script>
  <script>
    const WEBHOOK="YOUR_WEBHOOK_URL";
    const $=s=>document.querySelector(s);
    const setStatus=m=>$('#status').textContent=m;
    let unlocked=false,audioCtx=null,sampler=null,samplerReady=false,currentInstrument='piano';
    let notes=[];

    const PIANO_BASE=new URL('./piano/',location.href).href;
    const PIANO_URLS={'A1':'A1.mp3','C2':'C2.mp3','D#2':'Ds2.mp3','F#2':'Fs2.mp3','A2':'A2.mp3',
                      'C3':'C3.mp3','D#3':'Ds3.mp3','F#3':'Fs3.mp3','A3':'A3.mp3',
                      'C4':'C4.mp3','D#4':'Ds4.mp3','F#4':'Fs4.mp3','A4':'A4.mp3','C5':'C5.mp3'};
    const GUITAR_BASE=new URL('./guitar/',location.href).href;
    const GUITAR_URLS={'E2':'E2.wav','A2':'A2.wav','D3':'D3.wav','G3':'G3.wav','B3':'B3.wav','E4':'E4.wav'};
    const WHITE=["C3","D3","E3","F3","G3","A3","B3","C4","D4","E4","F4","G4","A4","B4"];
    const BLACK_AFTER={'C':'C#','D':'D#','F':'F#','G':'G#','A':'A#'};const TOTAL_WHITE=WHITE.length;
    const TUNING_MIDI=[40,45,50,55,59,64];const NOTE_NAMES=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
    const FRETS=12;

    function midiToNoteName(m){const n=NOTE_NAMES[m%12];const o=Math.floor(m/12)-1;return n+o;}

    async function unlockAudio(){
      const Ctx=window.AudioContext||window.webkitAudioContext;
      if(!audioCtx) audioCtx=new Ctx({latencyHint:'interactive'});
      if(audioCtx.state!=='running') await audioCtx.resume();
      Tone.setContext(new Tone.Context(audioCtx));await Tone.start();
      loadSampler(currentInstrument);unlocked=true;$('#unlockOverlay').style.display='none';
      setStatus('音訊已啟用，音色載入中…');
    }

    function loadSampler(inst='piano'){
      sampler?.dispose?.();sampler=null;samplerReady=false;
      let urls=PIANO_URLS,base=PIANO_BASE,label='鋼琴';
      if(inst==='guitar'){urls=GUITAR_URLS;base=GUITAR_BASE;label='吉他';}
      setStatus(label+'取樣載入中…');
      sampler=new Tone.Sampler({urls,release:1,baseUrl:base,onload:()=>{samplerReady=true;setStatus(label+'取樣已載入 ✅');}}).toDestination();
    }

    function trigger(note){
      if(!samplerReady){setStatus('音色載入中…');return;}
      sampler.triggerAttackRelease(note,'8n');
      if(notes.length<3){notes.push(note);$('#notes').value=notes.join(', ');}
      $('#lockBtn').disabled=(notes.length<3);
    }

    function renderPiano(){
      const kb=$('#keyboard');kb.innerHTML='';kb.className='';const keyW=100/TOTAL_WHITE;
      WHITE.forEach((note,i)=>{const w=document.createElement('div');w.className='white';w.dataset.note=note;
        w.style.left=`${i*keyW}%`;w.style.width=`${keyW}%`;if(note[0]==='C'||note[0]==='G'){
          const lab=document.createElement('div');lab.className='label';lab.textContent=note;w.appendChild(lab);}kb.appendChild(w);});
      WHITE.forEach((note,i)=>{const l=note[0],sharp=BLACK_AFTER[l]?BLACK_AFTER[l]+note.slice(1):null;
        if(!sharp||(l==='A'&&i===TOTAL_WHITE-1))return;
        const b=document.createElement('div');b.className='black';b.dataset.note=sharp;
        b.style.left=`calc(${i*keyW+keyW/2}%)`;b.style.width=`${keyW*0.62}%`;kb.appendChild(b);});
      kb.onpointerdown=e=>{const k=e.target.closest('.white,.black');if(!k)return;if(!unlocked)unlockAudio();trigger(k.dataset.note);k.classList.add('active');};
      kb.onpointerup=e=>{const k=e.target.closest('.white,.black');if(k)k.classList.remove('active');};
    }

    function renderGuitar(){
      const kb=$('#keyboard');kb.innerHTML='';kb.className='fretboard';
      for(let f=0;f<=FRETS;f++){
        const col=document.createElement('div');col.className='fret-col';if(f===0){const nut=document.createElement('div');nut.className='nut';col.appendChild(nut);}
        for(let s=0;s<6;s++){const y=(s+1)*14;const str=document.createElement('div');str.className='string';str.style.top=y+'%';
          str.style.height=(6-s)*1.2+1+'px';col.appendChild(str);
          str.addEventListener('pointerdown',()=>{if(!unlocked)unlockAudio();const midi=TUNING_MIDI[5-s]+f;const note=midiToNoteName(midi);
            trigger(note);str.classList.add('vibrate');setTimeout(()=>str.classList.remove('vibrate'),200);});
        }
        if([3,5,7,9,12].includes(f)){const mk=document.createElement('div');mk.className='marker';mk.textContent=f;col.appendChild(mk);}
        kb.appendChild(col);
      }
      kb.style.minWidth=(FRETS*64+16)+'px';
    }

    $('#instrument').addEventListener('change',()=>{currentInstrument=$('#instrument').value;loadSampler(currentInstrument);
      if(currentInstrument==='guitar')renderGuitar();else renderPiano();});
    $('#unlockBtn').addEventListener('click',unlockAudio,{once:true});
    $('#resetBtn').addEventListener('click',()=>{notes=[];$('#notes').value='';$('#lockBtn').disabled=true;setStatus(currentInstrument==='piano'?'鋼琴取樣已載入 ✅':'吉他取樣已載入 ✅');});
    $('#lockBtn').addEventListener('click',()=>{const payload={userId:'guest',displayName:$('#displayName').value||'Guest',
        instrument:currentInstrument,note:notes.join(', '),velocity:1,sessionId:'demo'};
      fetch(WEBHOOK,{method:'POST',headers:{'Content-Type':'text/plain'},body:JSON.stringify(payload)});
      setStatus('已送出，可以退出囉');$('#lockBtn').disabled=true;document.querySelectorAll('input,select,button').forEach(el=>el.disabled=true);});
    window.addEventListener('DOMContentLoaded',()=>{renderPiano();setStatus('初始化完成。請先啟用聲音或點擊琴鍵/指板。');});
  </script>
</body>
</html>
