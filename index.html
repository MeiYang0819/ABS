<!doctype html>
<html lang="zh-Hant">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>互動音符</title>
<style>
  :root{
    --page:#f6f7fb; --panel:#fff; --rim:#e4e7ef; --ink:#0f172a;
    --kb-h:280px;            /* 直向鍵盤高度 */
    --sep:2px;
    --header-h:140px;        /* 直向頂部（標題+輸入+狀態）估計高度 */
  }

  *{box-sizing:border-box}
  html,body{margin:0;background:var(--page);color:var(--ink);font-family:system-ui,-apple-system,"Noto Sans TC",sans-serif}
  .panel{max-width:1060px;margin:22px auto;background:var(--panel);border-radius:16px;padding:18px 18px 26px;box-shadow:0 10px 30px rgba(0,0,0,.08)}
  h2{margin:4px 0 12px; text-align:center;}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  input{padding:8px 10px;border:1px solid var(--rim);border-radius:10px;min-width:220px;width:100%}
  #status{background:#eef2f7;border:1px solid var(--rim);border-radius:12px;padding:10px;margin-top:10px;font-size:14px;white-space:pre-wrap;color:#334155}

  /* 直向可水平捲動；橫向寬度夠時不捲動 */
  .kb-wrap{
    overflow-x:auto;
    -webkit-overflow-scrolling:touch;
    touch-action:pan-x;
    background:#e9edf4;border:1px solid var(--rim);border-radius:14px;margin-top:14px
  }

  /* 鍵盤容器：寬度由 JS 設定（直向＝最小寬、橫向＝容器寬） */
  #keyboard{
    position:relative;height:var(--kb-h);
    user-select:none;-webkit-user-select:none;
  }

  /* white keys — 用偽元素當分隔線，不吃寬度 */
  .white{
    position:absolute;bottom:0;height:100%;
    background:linear-gradient(#ffffff,#eceef3 72%,#d9dde5);
    border-radius:0 0 12px 12px;
    box-shadow:inset 0 -12px 16px rgba(0,0,0,.12),inset 0 1px 0 rgba(255,255,255,.9),0 1px 0 rgba(0,0,0,.04);
  }
  .white::after{
    content:""; position:absolute; top:0; bottom:0; right:0; width:var(--sep);
    background:linear-gradient(transparent,#cfd3dc 50%,transparent);
  }
  .white:first-child::before{
    content:""; position:absolute; top:0; bottom:0; left:0; width:var(--sep);
    background:linear-gradient(transparent,#cfd3dc 50%,transparent);
  }
  .white.active{filter:brightness(1.06)}

  /* black keys */
  .black{position:absolute;bottom:38%;height:62%;
    width:6.4%;
    background:linear-gradient(#2d2f36,#0e0f13);
    border:1px solid #0b0d11;border-top:none;
    border-radius:0 0 10px 10px;z-index:5;
    box-shadow:inset 0 -6px 10px rgba(0,0,0,.45),0 3px 10px rgba(0,0,0,.35);
  }
  .black.active{filter:brightness(1.22)}

  .label{position:absolute;bottom:12px;left:50%;transform:translateX(-50%);
    font-size:11px;color:#475569;background:#ffffffee;border:1px solid var(--rim);
    padding:2px 6px;border-radius:8px}

  /* 解鎖遮罩 */
  #unlockOverlay{
    position:fixed; inset:0; background:rgba(0,0,0,.55); color:#fff;
    display:flex; align-items:center; justify-content:center; z-index:9999;
  }
  #unlockCard{
    background:#0b1220; padding:18px 20px; border-radius:16px; width:min(92%,420px);
    box-shadow:0 18px 45px rgba(0,0,0,.5); text-align:center
  }
  #unlockCard button{
    margin-top:12px; padding:10px 14px; border-radius:12px; border:0; cursor:pointer
  }

  /* ========= 橫向緊湊版 ========= */
  @media (orientation: landscape){
    :root{
      /* 頂部區塊縮小；鍵盤高度吃滿視窗高（扣掉頂部與安全區） */
      --header-h: 72px;
      --kb-h: calc(100dvh - var(--header-h) - 16px - env(safe-area-inset-bottom, 0px));
    }
    .panel{
      max-width:100vw; margin:0; border-radius:0; padding:10px 10px 12px;
      box-shadow:none;
    }
    h2{ margin:2px 0 6px; font-size:20px; }
    .row{ gap:8px; }
    input{ min-width:0; }
    #status{ margin-top:6px; font-size:13px; }
    .kb-wrap{
      margin-top:8px; border-radius:12px;
      overflow-x:hidden;  /* 橫向剛好，不需要卷軸 */
    }
    .label{ font-size:10px; bottom:8px; } /* 標籤略小，讓鍵面更寬 */
  }
</style>
<body>
  <div class="panel">
    <h2>互動音符</h2>
    <div class="row">
      <label for="displayName">顯示名稱：</label>
      <input id="displayName" placeholder="例如：小明" />
    </div>
    <p id="status">尚未初始化</p>
    <div class="kb-wrap"><div id="keyboard"></div></div>
  </div>

  <div id="unlockOverlay">
    <div id="unlockCard">
      <div style="font-size:16px;opacity:.9">請開啟音量並點擊下方按鈕啟用聲音</div>
      <div style="font-size:12px;opacity:.7;margin-top:6px">iPhone 請確認側邊靜音鍵關閉</div>
      <button id="unlockBtn">啟用聲音</button>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/tone@14.8.49/build/Tone.min.js"></script>
  <script>
    const WEBHOOK = "https://script.google.com/macros/s/AKfycbw3rDKy-mjN93ValBMs28ndCFv5IbqjupDgn9rHvqYOqJwo5If3DdB1zVervdluT8YW/exec";
    const $ = s => document.querySelector(s);
    const setStatus = m => $('#status').textContent = m;

    // 只用取樣（無嗶、無合成器）
    let audioCtx=null, sampler=null, samplerReady=false, unlocked=false;

    // 鍵盤配置
    const WHITE=["C3","D3","E3","F3","G3","A3","B3","C4","D4","E4","F4","G4","A4","B4"];
    const BLACK_AFTER={ 'C':'C#','D':'D#','F':'F#','G':'G#','A':'A#' };
    const TOTAL_WHITE = WHITE.length;
    const PORTRAIT_MIN_KEY_PX = 64; // 直向每個白鍵的最小寬度

    // 取樣路徑
    const BASE = new URL('./piano/', location.href).href;
    const URLS = {
      'A1':'A1.mp3','C2':'C2.mp3','D#2':'Ds2.mp3','F#2':'Fs2.mp3','A2':'A2.mp3',
      'C3':'C3.mp3','D#3':'Ds3.mp3','F#3':'Fs3.mp3','A3':'A3.mp3',
      'C4':'C4.mp3','D#4':'Ds4.mp3','F#4':'Fs4.mp3','A4':'A4.mp3','C5':'C5.mp3'
    };

    function unlockAudio(){
      try{
        const Ctx = window.webkitAudioContext || window.AudioContext;
        if(!audioCtx) audioCtx = new Ctx({ latencyHint:'interactive' });
        if(audioCtx.state!=='running') audioCtx.resume();
        Tone.setContext(new Tone.Context(audioCtx));
        Tone.start();
        loadSampler();
        unlocked=true;
        $('#unlockOverlay').style.display='none';
        setStatus('音訊已啟用，音色載入中…');
      }catch(e){ setStatus('啟用失敗：'+e.message); }
    }

    function loadSampler(){
      if(sampler||samplerReady) return;
      sampler = new Tone.Sampler({
        urls:URLS, release:1, baseUrl:BASE,
        onload:()=>{ samplerReady=true; setStatus('鋼琴取樣已載入 ✅'); }
      }).toDestination();
    }

    function playNote(note){
      if(!samplerReady) { setStatus('音色載入中…'); return; }
      sampler.triggerAttackRelease(note,'8n');
    }

    function buildKeyboard(){
      const kb=$('#keyboard'); kb.innerHTML='';
      sizeKeyboard(); // 先確定寬度

      const keyW = 100 / TOTAL_WHITE;

      // 白鍵
      WHITE.forEach((note,i)=>{
        const w=document.createElement('div'); w.className='white'; w.dataset.note=note;
        w.style.left=`${i*keyW}%`; w.style.width=`${keyW}%`;
        if(note[0]==='C'||note[0]==='G'){
          const lab=document.createElement('div'); lab.className='label'; lab.textContent=note; w.appendChild(lab);
        }
        kb.appendChild(w);
      });

      // 黑鍵
      WHITE.forEach((note,i)=>{
        const l=note[0], sharp=BLACK_AFTER[l]?BLACK_AFTER[l]+note.slice(1):null;
        if(!sharp || (l==='A' && i===TOTAL_WHITE-1)) return;
        const b=document.createElement('div'); b.className='black'; b.dataset.note=sharp;
        b.style.left=`calc(${i*keyW}% + ${keyW*0.68}%)`;
        kb.appendChild(b);
      });

      setStatus(`初始化完成｜白鍵 ${TOTAL_WHITE}`);

      const down=el=>{
        const k=el?.closest('.black,.white'); if(!k) return;
        if(!unlocked) unlockAudio();
        playNote(k.dataset.note);
        log(k.dataset.note);
        k.classList.add('active');
      };
      const up=el=>{ const k=el?.closest('.black,.white'); if(k) k.classList.remove('active'); };

      // 允許原生水平捲動（直向時）
      const opts={passive:true};
      kb.addEventListener('pointerdown',e=>down(e.target),opts);
      kb.addEventListener('pointerup',e=>up(e.target),opts);
      kb.addEventListener('touchstart',e=>{
        const t=(e.touches&&e.touches[0])||(e.changedTouches&&e.changedTouches[0]);
        const el=t?document.elementFromPoint(t.clientX,t.clientY):e.target;
        down(el);
      },opts);
      kb.addEventListener('touchend',e=>{
        const t=e.changedTouches&&e.changedTouches[0]; if(!t) return;
        const el=document.elementFromPoint(t.clientX,t.clientY);
        up(el);
      },opts);
      kb.addEventListener('mousedown',e=>down(e.target),opts);
      kb.addEventListener('mouseup',e=>up(e.target),opts);
    }

    // 直向：鍵盤最小寬度 = 14*64px → 需要就有水平卷軸
    // 橫向：鍵盤寬度 = 容器寬（-2px 防止圓角/小數誤差吃掉右側）
    function sizeKeyboard(){
      const wrap = document.querySelector('.kb-wrap');
      const kb   = document.querySelector('#keyboard');
      const wrapW = Math.floor(wrap.clientWidth);
      const isLandscape = window.matchMedia('(orientation: landscape)').matches;
      const portraitMin = TOTAL_WHITE * PORTRAIT_MIN_KEY_PX;

      if (isLandscape){
        kb.style.width = (wrapW - 2) + 'px';
      }else{
        kb.style.width = (wrapW >= portraitMin ? (wrapW - 2) : portraitMin) + 'px';
      }
    }

    function log(n){
      const payload={userId:'guest',displayName:$('#displayName').value||'Guest',instrument:'piano',note:n,velocity:1,sessionId:'demo'};
      fetch(WEBHOOK,{method:'POST',headers:{'Content-Type':'text/plain'},body:JSON.stringify(payload)})
        .then(r=>r.text()).then(txt=>setStatus(`已記錄：${n}｜回應：${txt}`))
        .catch(err=>setStatus('記錄失敗：'+err.message));
    }

    window.addEventListener('resize', sizeKeyboard);
    window.addEventListener('orientationchange', sizeKeyboard);

    window.addEventListener('DOMContentLoaded', ()=>{
      buildKeyboard();
      $('#unlockBtn').addEventListener('click', unlockAudio, {once:true});
      sizeKeyboard();
    });
  </script>
</body>
</html>
