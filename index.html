<!doctype html>
<html lang="zh-Hant">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>å¤šæ¨‚å™¨éµç›¤ï¼ˆè‡ªå‹•åˆå§‹åŒ–ï¼‰</title>
<style>
  body{font-family:system-ui,-apple-system,"Noto Sans TC",sans-serif;margin:0;padding:16px;background:#f6f7fb;}
  .panel{background:#fff;border-radius:14px;box-shadow:0 10px 25px rgba(0,0,0,.08);padding:14px;}
  #status{background:#f2f4f8;border-radius:10px;padding:10px;margin-top:10px;font-size:14px}
  .row{display:flex;gap:10px;align-items:center;margin-top:8px;flex-wrap:wrap}
  input,select{padding:8px 10px;font-size:14px}
  .kb-wrap{overflow-x:auto;background:#eceff4;border-radius:14px;margin-top:12px}
  #keyboard{position:relative;height:220px;min-width:720px;user-select:none;-webkit-user-select:none}
  .white{position:absolute;bottom:0;height:100%;background:linear-gradient(#fff,#e6e7ea 70%,#d1d3d8);
    border-radius:0 0 10px 10px;box-shadow:inset 0 -8px 10px rgba(0,0,0,.12),inset 0 1px 0 rgba(255,255,255,.9),0 1px 0 rgba(0,0,0,.05);}
  .white.active{filter:brightness(1.08)}
  .black{position:absolute;bottom:38%;height:62%;background:linear-gradient(#2f2f2f,#0c0c0c);border-radius:0 0 8px 8px;z-index:3}
  .black.active{filter:brightness(1.25)}
  .label{position:absolute;bottom:8px;left:50%;transform:translateX(-50%);font-size:11px;color:#7a8396;background:#fff9;border:1px solid #e4e7ef;padding:2px 6px;border-radius:8px}
</style>
<body>
  <div class="panel">
    <h2>å¤šæ¨‚å™¨éµç›¤ï¼ˆè‡ªå‹•åˆå§‹åŒ–ï¼‰</h2>

    <div class="row">
      <label>é¡¯ç¤ºåç¨±ï¼š</label>
      <input id="displayName" placeholder="ä¾‹å¦‚ï¼šå°æ˜" style="flex:1">
      <label>æ¨‚å™¨ï¼š</label>
      <select id="instrument">
        <option value="piano">é‹¼ç´</option>
        <option value="electric-guitar">é›»å‰ä»–</option>
        <option value="acoustic-guitar">æœ¨å‰ä»–</option>
        <option value="violin">å°æç´</option>
        <option value="viola">ä¸­æç´</option>
        <option value="cello">å¤§æç´</option>
        <option value="flute">é•·ç¬›</option>
        <option value="alto-saxophone">è–©å…‹æ–¯é¢¨</option>
      </select>
      <label style="display:flex;align-items:center;gap:6px;">
        <input type="checkbox" id="sustain"> å»¶éŸ³
      </label>
    </div>

    <p id="status">å°šæœªåˆå§‹åŒ–ï¼ˆç¬¬ä¸€æ¬¡é»ç´éµæ™‚è‡ªå‹•è¼‰å…¥ï¼‰</p>
    <div class="kb-wrap"><div id="keyboard"></div></div>
  </div>

  <!-- Tone.js -->
  <script src="https://cdn.jsdelivr.net/npm/tone@14.8.49/build/Tone.min.js"></script>

  <script>
    const $ = s => document.querySelector(s);
    const statusEl = $('#status');
    let sampler = null;
    let sustainOn = false;
    let isReady = false;

    // ğŸ”´ æŠŠé€™è£¡æ›æˆä½ è‡ªå·±çš„ /exec URL
    const WEBHOOK = "https://script.google.com/macros/s/AKfycbw3rDKy-mjN93ValBMs28ndCFv5IbqjupDgn9rHvqYOqJwo5If3DdB1zVervdluT8YW/exec";

    const START_OCTAVE=3, OCTAVES=2, INCLUDE_TOP_C=true;
    function whites(){
      const order=["C","D","E","F","G","A","B"], notes=[];
      for(let o=START_OCTAVE;o<START_OCTAVE+OCTAVES;o++){ for(const n of order) notes.push(n+o); }
      if(INCLUDE_TOP_C) notes.push("C"+(START_OCTAVE+OCTAVES));
      notes.pop(); return notes; // å»æ‰æœ€å³ç™½
    }
    const WHITE=whites(), BLACK_MAP={"C":"C#","D":"D#","F":"F#","G":"G#","A":"A#"};

    function buildKeyboard(){
      const kb=$('#keyboard'); kb.innerHTML='';
      const total=WHITE.length, keyW=100/total;
      WHITE.forEach((note,i)=>{
        const w=document.createElement('div'); w.className='white'; w.dataset.note=note;
        w.style.left=`${i*keyW}%`; w.style.width=`${keyW}%`;
        if(note[0]==='C'||note[0]==='G'){ const lab=document.createElement('div'); lab.className='label'; lab.textContent=note; w.appendChild(lab); }
        kb.appendChild(w);
      });
      WHITE.forEach((note,i)=>{
        const l=note[0]; let s=BLACK_MAP[l]?BLACK_MAP[l]+note.slice(1):null;
        if(l==='A' && i===WHITE.length-1) s=null; if(!s) return;
        const b=document.createElement('div'); b.className='black'; b.dataset.note=s;
        b.style.left=`calc(${i*keyW}% + ${keyW*0.66}%)`; b.style.width=`${keyW*0.64}%`;
        kb.appendChild(b);
      });
      kb.addEventListener('pointerdown',e=>{ const t=e.target.closest('.white,.black'); if(!t) return; keyOn(t,t.dataset.note);});
      kb.addEventListener('pointerup',e=>{ const t=e.target.closest('.white,.black'); if(!t) return; keyOff(t,t.dataset.note);});
    }

    async function ensureReady(){
      if(isReady) return;
      await Tone.start();
      const type=$('#instrument').value;
      const baseMap={
        "piano":"salamander","electric-guitar":"electric-guitar","acoustic-guitar":"acoustic-guitar",
        "violin":"violin","viola":"viola","cello":"cello","flute":"flute","alto-saxophone":"alto-saxophone"
      };
      const base=baseMap[type]||"salamander";
      sampler=new Tone.Sampler({ urls:{"C4":"C4.mp3"}, release:1, baseUrl:`https://tonejs.github.io/audio/${base}/` }).toDestination();
      await sampler.load().catch(()=>{});
      isReady=true;
      statusEl.textContent=`éŸ³æºå·²è¼‰å…¥ âœ…ï¼ˆ${$('#instrument').selectedOptions[0].text}ï¼‰`;
    }

    function keyOn(el,note){
      el.classList.add('active');
      playLocal(note,0.9);
      logToWebhook(note,0.9);
    }
    function keyOff(el,note){ el.classList.remove('active'); if(!sustainOn) stopNote(note); }

    async function playLocal(note,v=0.9){
      await ensureReady();
      sampler.triggerAttack(note, undefined, v);
      if(!sustainOn) sampler.triggerRelease(note,"+0.25");
    }
    function stopNote(note){ if(sampler) sampler.triggerRelease(note); }

    function logToWebhook(note,v=0.9){
      const payload={userId:"guest",displayName:$('#displayName').value||'Guest',instrument:$('#instrument').value,note,velocity:v,sessionId:"demo"};
      fetch(WEBHOOK,{method:"POST",headers:{"Content-Type":"text/plain;charset=UTF-8"},body:JSON.stringify(payload)})
        .then(r=>r.text()).then(txt=>statusEl.textContent=`å·²è¨˜éŒ„ï¼š${note}ï½œå›æ‡‰ï¼š${txt}`)
        .catch(err=>statusEl.textContent="è¨˜éŒ„å¤±æ•—ï¼š"+err.message);
    }

    $('#sustain').addEventListener('change',e=>{sustainOn=e.target.checked;});
    $('#instrument').addEventListener('change',()=>{sampler=null;isReady=false;statusEl.textContent='å·²åˆ‡æ›æ¨‚å™¨ï¼Œè«‹å†æ¬¡é»ç´éµè¼‰å…¥';});
    buildKeyboard();
  </script>
</body>
</html>
