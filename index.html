# index.html（前端）

> 注意：依你的要求，前端目前 **不改動**（維持你提供的可用版本）。如需把「逾時訊息」改成「可能已送達，請勿重複送出」等微文案，再告訴我，我會在不影響其它行為的前提下微調。

```html
<!doctype html>
<html lang="zh-Hant">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>🎶互動音符</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700&display=swap" rel="stylesheet">
<style>
/* ===== 調色盤與尺寸（欄位寬度可在這裡改） ===== */
:root{
  --brand:#D4BFAA;   /* 主色：整頁底色 */
  --title:#A68A7C;   /* 標題字色 */
  --neutral:#E4E4E4; /* 區塊背景 */
  --soft:#F5F1EC;    /* 內頁/容器底 */
  --accent:#BFA5A0;  /* 提亮色（載入完成） */
  --rim:#E4E4E4;
  --ink:#0f172a;

  --w-displayName: 96px;   /* 親友姓名 input */
  --w-email:      261px;   /* 電子郵件 input */
  --w-code:        96px;   /* 取得代號 input */
  --w-instrument:  96px;   /* 樂器轉換 select */
  --w-lastNote:   125px;   /* 音符紀錄 input（桌機） */
  --w-lastNote-m: 160px;   /* 音符紀錄 input（手機直向，可調） */

  --label-w:88px;          /* 統一每個 label 的寬度，確保左緣對齊 */
  --gap:10px;              /* 兩個項目間的水平間距 */
  --kb-h:280px;            /* 樂器區高度 */
  --sep:2px;
  --stroke:rgba(0,0,0,.18);
  --glow:rgba(255,255,255,.65);
}

*{
  box-sizing:border-box;
  font-family:"Zen Maru Gothic","Noto Sans TC",system-ui,-apple-system,sans-serif !important;
  -webkit-text-stroke:.35px var(--stroke);
  text-shadow:0 1px 0 var(--glow);
}

/* === 全站改為粗體（保留你的需求）=== */
html,body{ margin:0; color:var(--ink); background:var(--brand); font-weight:700; }

/* 只有「操作說明」彈窗維持原樣（不粗體、不描邊） */
#guideOverlay .dialog, #guideOverlay .dialog *{
  font-weight:500 !important;
  -webkit-text-stroke:0 !important;
  text-shadow:none !important;
}

.bg-notes{ position:fixed; inset:0; width:100%; height:100%; object-fit:cover; opacity:.60; mix-blend-mode:multiply; filter:contrast(1.1); pointer-events:none; z-index:0; }

/* 容器 */
.panel{ position:relative; z-index:1; max-width:1060px; margin:22px auto; background:var(--neutral); border:1px solid var(--neutral); border-radius:16px; padding:18px 18px 26px; box-shadow:0 10px 26px rgba(0,0,0,.10); backdrop-filter:blur(8px) saturate(115%); }

/* 標題 */
h2{ margin:4px 0 20px; text-align:center; font-size:2.8rem; font-weight:700; letter-spacing:1px; color:var(--title); -webkit-text-stroke:.6px rgba(0,0,0,.12); text-shadow:0 3px 4px rgba(255,255,255,.75); }

/* 控制列 */
.row{ display:flex; gap:var(--gap); align-items:center; flex-wrap:wrap; margin-top:10px; }
.row label{ width:var(--label-w); opacity:.92; white-space:nowrap; font-weight:700; -webkit-text-stroke:0; text-shadow:none; }
.row input,.row select,.row button{ height:38px; font-size:14px; background:#fff; padding:8px 10px; border:1px solid var(--rim); border-radius:10px; -webkit-text-stroke:.25px rgba(0,0,0,.12); text-shadow:0 1px 0 rgba(255,255,255,.5); }

/* 欄位寬度 */
#displayName{ width:var(--w-displayName); }
#email{       width:var(--w-email); }
#code{        width:var(--w-code); }
#instrument{  width:var(--w-instrument); }
#lastNote{    width:var(--w-lastNote); text-align:center; letter-spacing:.3px; }
#lastNote::placeholder{ text-align:center; }

/* 「音符紀錄」與上方「電子郵件」左緣對齊（桌機用） */
@media (min-width: 861px){
  .align-to-email{ margin-left: calc(var(--w-displayName) - var(--w-instrument)); }
}

/* 按鈕 */
.row select option{text-align:center}
.row button{ width:120px; cursor:pointer; font-weight:700; }
.btn-compact{ width:60px !important; }
.row button:disabled{ opacity:.55; cursor:not-allowed; }

/* ===== 狀態列（統一用 🎸 已載入 ✅ 的顏色與效果） ===== */
#status{
  background: var(--soft);
  border:1px solid var(--neutral);
  border-radius:12px;
  padding:10px; margin-top:10px;
  font-size:14px; white-space:pre-wrap; text-align:center;
  color: var(--accent) !important;
  font-weight: 700;
  -webkit-text-stroke: .35px rgba(0,0,0,.10);
  text-shadow:
    0 1px 0 rgba(255,255,255,.85),
    0 3px 6px rgba(0,0,0,.04);
}
#status.ok,#status.busy,#status.err{
  color: var(--accent) !important;
  font-weight: 700;
  -webkit-text-stroke: .35px rgba(0,0,0,.10);
  text-shadow:
    0 1px 0 rgba(255,255,255,.85),
    0 3px 6px rgba(0,0,0,.04);
}

/* 鍵盤外框：✅ 需要時可水平卷軸 */
.kb-wrap{
  overflow-x:auto;
  -webkit-overflow-scrolling:touch;
  background:var(--soft); border:1px solid var(--rim); border-radius:14px; margin-top:14px;
}
#keyboard{
  position:relative; height:var(--kb-h);
  user-select:none; -webkit-user-select:none;
  touch-action: pan-x pan-y;
}

/* ===== 鋼琴 ===== */
.white{ position:absolute; bottom:0; height:100%; background:linear-gradient(#ffffff,#eceef3 72%,#d9dde5); border-radius:0 0 12px 12px; box-shadow:inset 0 -12px 16px rgba(0,0,0,.12), inset 0 1px 0 rgba(255,255,255,.9), 0 1px 0 rgba(0,0,0,.04); }
.white::after{ content:""; position:absolute; top:0; bottom:0; right:0; width:var(--sep); background:linear-gradient(transparent,#cfd3dc 50%,transparent); }
.white:first-child::before{ content:""; position:absolute; top:0; bottom:0; left:0; width:var(--sep); background:linear-gradient(transparent,#cfd3dc 50%,transparent); }
.white.active{ filter:brightness(1.06); }
.black{ position:absolute; bottom:38%; height:62%; background:linear-gradient(#2d2f36,#0e0f13); border:1px solid #0b0d11; border-top:none; border-radius:0 0 10px 10px; z-index:5; box-shadow:inset 0 -6px 10px rgba(0,0,0,.45), 0 3px 10px rgba(0,0,0,.35); transform: translateX(-50%); }
.black.active{ filter:brightness(1.22); }
.label{ position:absolute; bottom:12px; left:50%; transform:translateX(-50%); font-size:11px; color:#475569; background:#ffffffee; border:1px solid var(--rim); padding:2px 6px; border-radius:8px; }

/* ===== 吉他（繞銅弦 + 震動保留） ===== */
.fretboard{ position:relative; display:grid; grid-template-columns: repeat(13, 1fr); width:100%; height:var(--kb-h); background:linear-gradient(180deg,#6b4f2e 0%, #5b4429 50%, #533c24 100%); border-radius:12px; box-shadow:inset 0 10px 20px rgba(0,0,0,.25), inset 0 -8px 16px rgba(0,0,0,.2); }
.head{ position:absolute; left:0; top:0; bottom:0; width:86px; z-index:2; background:linear-gradient(180deg, rgba(0,0,0,.12), transparent 40%),linear-gradient(180deg,#7a5534 0%, #6b4f2e 55%, #5a3f24 100%); border-right:1px solid rgba(40,22,8,.35); box-shadow: inset -8px 0 16px rgba(0,0,0,.18); border-radius:12px 0 0 12px; pointer-events:none; }
.nut{ position:absolute; left:86px; top:0; bottom:0; width:8px; z-index:3; background:linear-gradient(180deg,#e5e1d6,#c9c5ba); box-shadow: inset -1px 0 0 rgba(0,0,0,.35), inset 1px 0 0 rgba(255,255,255,.6); border-right:2px solid rgba(120,120,120,.5); pointer-events:none; }
.bridge{ position:absolute; right:0; top:0; bottom:0; width:10px; z-index:2; background:linear-gradient(180deg,#b9b6ad,#8f8c83); box-shadow: inset 1px 0 0 rgba(255,255,255,.5), inset -1px 0 0 rgba(0,0,0,.25); pointer-events:none; border-left:1px solid rgba(0,0,0,.18); }
.fret-col{ position:relative; background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.02)); box-shadow: inset -2px 0 0 rgba(255,255,255,.18), inset -4px 0 0 rgba(0,0,0,.28); }

/* —— 弦本體：兩層繞線條紋 + 筒形高光 + 邊緣陰影 —— */
.string{
  --sw: 2px;                               /* 粗細不變 */
  position:absolute; left:94px; right:0; height:0; z-index:3;
  border-top: var(--sw) solid transparent; /* 由偽元素畫出弦體 */
  transform-origin:center;
  filter:drop-shadow(0 1px 0 rgba(0,0,0,.18));
  background: linear-gradient(90deg, rgba(255,255,255,0) 0%, rgba(255,255,255,.45) 50%, rgba(255,255,255,0) 100%);
  background-size:160px 1px; background-repeat:no-repeat; background-position:-160px 0;
}
.string::before{
  content:""; position:absolute; left:0; right:0;
  top: calc(var(--sw) * -0.5); height: var(--sw);
  background:
    repeating-linear-gradient(90deg, #caa56b 0 2.4px, #906a3d 2.4px 3.1px),
    repeating-linear-gradient(90deg, rgba(255,255,255,.08) 0 2.4px, rgba(0,0,0,.10) 2.4px 3.1px),
    linear-gradient(180deg, rgba(255,255,255,.70), rgba(255,255,255,.15) 55%, rgba(0,0,0,.18) 100%);
  border-radius:999px; opacity:.98; pointer-events:none;
}
.string::after{
  content:""; position:absolute; left:0; right:0;
  top: calc(var(--sw) * -0.5 + 0.2px); height: calc(var(--sw) * .25);
  background: linear-gradient(180deg, rgba(255,255,255,.55), rgba(255,255,255,0));
  pointer-events:none; border-radius:999px; opacity:.9;
}
.string[data-s="2"]{ --sw:2.5px; } .string[data-s="3"]{ --sw:3px; } .string[data-s="4"]{ --sw:3.5px; } .string[data-s="5"]{ --sw:4px; }

/* 琴頭區段也套用繞銅外觀 */
.head-line{ --sw:2px; position:absolute; left:0; width:86px; height:0; z-index:2; border-top: var(--sw) solid transparent; filter:drop-shadow(0 1px 0 rgba(0,0,0,.06)); pointer-events:none; }
.head-line::before{
  content:""; position:absolute; left:0; right:0; top: calc(var(--sw) * -0.5); height: var(--sw);
  background:
    repeating-linear-gradient(90deg, #caa56b 0 2.4px, #906a3d 2.4px 3.1px),
    repeating-linear-gradient(90deg, rgba(255,255,255,.08) 0 2.4px, rgba(0,0,0,.10) 2.4px 3.1px),
    linear-gradient(180deg, rgba(255,255,255,.70), rgba(255,255,255,.15) 55%, rgba(0,0,0,.18) 100%);
  border-radius:999px; opacity:.98;
}
.head-line::after{
  content:""; position:absolute; left:0; right:0; top: calc(var(--sw) * -0.5 + 0.2px); height: calc(var(--sw) * .25);
  background: linear-gradient(180deg, rgba(255,255,255,.55), rgba(255,255,255,0));
  border-radius:999px; opacity:.9;
}
.head-line[data-s="2"]{ --sw:2.5px; } .head-line[data-s="3"]{ --sw:3px; } .head-line[data-s="4"]{ --sw:3.5px; } .head-line[data-s="5"]{ --sw:4px; }

/* 觸控區與震動動畫（保留） */
.hit-row{ position:absolute; left:0; right:0; height:28px; transform:translateY(-50%); background:transparent; cursor:pointer; z-index:4; }
@media (pointer:coarse){ .hit-row{ height:34px; } }
.string.vibrate{ animation: vibrCurve 360ms ease-out, shine 360ms ease-out; }
@keyframes vibrCurve{
  0%{transform:translateY(0)} 10%{transform:translateY(-3.2px)} 20%{transform:translateY(0)}
  30%{transform:translateY(2.6px)} 45%{transform:translateY(0)} 60%{transform:translateY(-1.8px)}
  75%{transform:translateY(0.6px)} 100%{transform:translateY(0)}
}
@keyframes shine{ 0%{ background-position:-160px 0; opacity:.95 } 100%{ background-position:160px 0; opacity:.96 } }

/* Overlay */
.overlay{ position:fixed; inset:0; z-index:9999; display:flex; align-items:center; justify-content:center; background:rgba(17,24,39,.35); backdrop-filter:blur(3px); }
.overlay.hidden{ display:none; }
.dialog{ min-width:300px; max-width:92vw; background:var(--soft); border:1px solid var(--neutral); border-radius:14px; padding:18px; box-shadow:0 18px 44px rgba(0,0,0,.18); text-align:center; }
.dialog h3{ margin:0 0 8px; font-size:18px; color:#6b5e52; } /* 標題維持可讀 */
.dialog p.ios-hint{ margin:6px 0; line-height:1.6; font-size:15px; color:#d11; }

.dialog .actions{ display:flex; gap:10px; justify-content:center; margin-top:12px; }
.dialog button{ width:120px; height:38px; border-radius:10px; border:1px solid var(--rim); background:#fff; cursor:pointer; font-weight:700; }
.dialog button.primary{ background:#fff; }

#lockScreen{ position:fixed; inset:0; z-index:9998; display:none; background:transparent; }
footer{ max-width:1060px;margin:8px auto 22px; text-align:center; color:#6b5e52; font-size:12px; opacity:.9; }

/* =============== 📱手機直向：一組「名稱＋input」一行 =============== */
@media (orientation:portrait){
  .row-line2, .row-line3{ width:100%; gap:12px; }
  .pair{ display:flex; align-items:center; gap:var(--gap); width:100%; }
  .actions-inline{ display:flex; gap:var(--gap); }

  /* 強制每組獨占一行 */
  .row-line2 .pair, .row-line3 .pair, .row-line3 .actions-inline{ flex: 0 0 100%; }

  /* 直向不需要位移對齊 */
  .align-to-email{ margin-left:0 !important; }

  /* 音符紀錄 input 在直向略小（可用 --w-lastNote-m 自行微調） */
  #lastNote{ width:var(--w-lastNote-m); }
}

/* 橫向：維持你要的同行排列（預設即符合） */
</style>

<body>
  <!-- 背景音符 -->
  <img class="bg-notes" src="./assets/notes.png?v=4" alt="">
  <div class="panel">
    <h2>🎼互動音符🎼</h2>

    <!-- 第 1 行：姓名 → Email → 代號 -->
    <div class="row row-line2">
      <div class="pair">
        <label for="displayName">親友姓名：</label>
        <input id="displayName" placeholder="例：張咩揚" />
      </div>
      <div class="pair">
        <label for="email">電子郵件：</label>
        <input id="email" placeholder="hey fill in your@email" inputmode="email" />
      </div>
      <div class="pair">
        <label for="code">取得代號：</label>
        <input id="code" placeholder="請輸入代號" />
      </div>
    </div>

    <!-- 第 2 行：樂器 → 音符紀錄 → 重設 → 鎖定 -->
    <div class="row row-line3">
      <div class="pair">
        <label for="instrument">樂器轉換：</label>
        <select id="instrument">
          <option value="piano" selected>鋼琴</option>
          <option value="guitar">吉他</option>
        </select>
      </div>
      <div class="pair">
        <label for="lastNote" class="align-to-email">音符紀錄：</label>
        <input id="lastNote" placeholder="— , — , —" readonly />
      </div>
      <div class="actions-inline">
        <button id="resetBtn" type="button" class="btn-compact">重設</button>
        <button id="lockBtn"  type="button" class="btn-compact" disabled>鎖定</button>
      </div>
    </div>

    <p id="status">尚未初始化</p>

    <div class="kb-wrap"><div id="keyboard"></div></div>
  </div>

  <!-- 彈跳視窗 ①：操作說明（不變） -->
  <div id="guideOverlay" class="overlay" role="dialog" aria-modal="true" aria-labelledby="guideTitle">
    <div class="dialog">
      <h3 id="guideTitle">📍操作說明📍</h3>
      <p>🔻填入姓名、Email與取得的代號</p><p>↓</p>
      <p>🔻可選擇鋼琴或吉他中的三個音階</p><p>↓</p>
      <p>🔻三個音階確認後，一定要按鎖定</p><p>↓</p>
      <p>🔻鎖定完成後，會有通知是否成功</p><p>↓</p>
      <p>🔻若成功即可退出介面；反之再試</p><p>↓</p>
      <p>❗️沒按鎖定就是沒有送出就是彈個寂寞</p>
      <div class="actions"><button id="guideOk" class="primary">了解</button></div>
    </div>
  </div>

  <!-- 彈跳視窗 ②：啟用聲音 / 音色載入 -->
  <div id="unlockOverlay" class="overlay hidden" role="dialog" aria-modal="true" aria-labelledby="unlockTitle">
    <div class="dialog">
      <h3 id="unlockTitle">啟用聲音</h3>
      <p class="ios-hint">iPhone請確保側邊「靜音鍵」有開啟響鈴模式</p>
      <div class="actions">
        <button id="cancelUnlock">取消</button>
        <button id="confirmUnlock" class="primary">確定</button>
      </div>
    </div>
  </div>

  <div id="lockScreen" aria-hidden="true"></div>
  <footer>© Copyright 2025 MY‘s system Version:b1.0.1</footer>

  <script src="https://cdn.jsdelivr.net/npm/tone@14.8.49/build/Tone.min.js"></script>
  <script>
  /* ===== 主程式（邏輯不動） ===== */
  const WEBHOOK = "https://script.google.com/macros/s/AKfycbwNWz3qmx5r9lDG6KClfjideaOn_xN8AK0H0Ie5Ra68rUURv8TktIgjiuKxdqDVeLPA/exec";
  const $ = s => document.querySelector(s);
  const setStatus = m => {
    const el = $('#status'); el.textContent = m;
    el.classList.remove('ok','busy','err');
    if(/已載入/.test(m)) el.classList.add('ok');
    else if(/送出中/.test(m)) el.classList.add('busy');
    else if(/❌|失敗|逾時|找尋不到|已過|格式不正確|忙碌/.test(m)) el.classList.add('err');
  };

  let audioCtx=null, sampler=null, samplerReady=false, unlocked=false, hardLocked=false;
  let currentInstrument='piano';
  let selectedNotes = [];

  const PIANO_BASE  = new URL('./piano/',  location.href).href;
  const GUITAR_BASE = new URL('./guitar/', location.href).href;
  const PIANO_URLS  = {'A1':'A1.mp3','C2':'C2.mp3','D#2':'Ds2.mp3','F#2':'Fs2.mp3','A2':'A2.mp3','C3':'C3.mp3','D#3':'Ds3.mp3','F#3':'Fs3.mp3','A3':'A3.mp3','C4':'C4.mp3','D#4':'Ds4.mp3','F#4':'Fs4.mp3','A4':'A4.mp3','C5':'C5.mp3'};
  const GUITAR_URLS = {'E2':'E2.wav','A2':'A2.wav','D3':'D3.wav','G3':'G3.wav','B3':'B3.wav','E4':'E4.wav'};

  const WHITE=["C3","D3","E3","F3","G3","A3","B3","C4","D4","E4","F4","G4","A4","B4"];
  const BLACK_AFTER={ 'C':'C#','D':'D#','F':'F#','G':'G#','A':'A#' };
  const MIN_WHITE_PX=64, TOTAL_WHITE=WHITE.length;

  const TUNING_MIDI = [40,45,50,55,59,64];
  const NOTE_NAMES = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];

  function validEmail(v){ return /.+@.+\..+/.test((v||'').trim()); }

  async function unlockAudio(){
    try{
      const Ctx=window.webkitAudioContext||window.AudioContext;
      if(!audioCtx) audioCtx=new Ctx({latencyHint:'interactive'});
      if(audioCtx.state!=='running') await audioCtx.resume();
      Tone.setContext(new Tone.Context(audioCtx));
      await Tone.start();
      loadSampler(currentInstrument);
      unlocked=true;
      $('#unlockOverlay').classList.add('hidden');
    }catch(e){ setStatus('啟用失敗：'+e.message); }
  }

  function loadSampler(inst='piano'){
    sampler?.dispose?.(); sampler=null; samplerReady=false;
    let urls=PIANO_URLS, base=PIANO_BASE, label='🎹 ';
    if(inst==='guitar'){ urls=GUITAR_URLS; base=GUITAR_BASE; label='🎸 '; }
    setStatus(label+'載入中…');
    sampler=new Tone.Sampler({
      urls, release:1, baseUrl:base,
      onload:()=>{ samplerReady=true; setStatus(label+'已載入 ✅'); }
    }).toDestination();
  }

  function refreshNotesDisplay(){
    const parts=[selectedNotes[0]||'—', selectedNotes[1]||'—', selectedNotes[2]||'—'];
    $('#lastNote').value = parts.join(' , ');
  }

  function trigger(note){
    if(hardLocked) return;
    if(!samplerReady){ setStatus('音色載入中…'); return; }
    sampler.triggerAttackRelease(note,'8n');
    if(selectedNotes.length<3) selectedNotes.push(note); else selectedNotes[2]=note;
    refreshNotesDisplay(); validateLockBtn();
  }

  function validateLockBtn(){
    const nameOk = ($('#displayName').value||'').trim().length>0;
    const codeOk = ($('#code').value||'').trim().length>0;
    const emailOk = validEmail($('#email').value);
    const notesOk = selectedNotes.length===3;
    $('#lockBtn').disabled = !(nameOk && codeOk && emailOk && notesOk);
  }

  /* === 鋼琴 === */
  function renderPiano(){
    const kb=$('#keyboard'); kb.innerHTML=''; kb.className='';
    sizePiano();
    const keyW=100/TOTAL_WHITE;

    WHITE.forEach((note,i)=>{
      const w=document.createElement('div'); w.className='white'; w.dataset.note=note;
      w.style.left=(i*keyW)+'%'; w.style.width=keyW+'%';
      if(note[0]==='C'||note[0]==='G'){ const lab=document.createElement('div'); lab.className='label'; lab.textContent=note; w.appendChild(lab); }
      w.addEventListener('pointerdown', ()=>{
        if(hardLocked) return;
        if(!unlocked){ $('#unlockOverlay').classList.remove('hidden'); return; }
        trigger(note); w.classList.add('active');
      });
      w.addEventListener('pointerup', ()=>w.classList.remove('active'));
      kb.appendChild(w);
    });

    WHITE.forEach((note,i)=>{
      const l=note[0], sharp = BLACK_AFTER[l]? (BLACK_AFTER[l]+note.slice(1)) : null;
      if(!sharp || (l==='A' && i===TOTAL_WHITE-1)) return;
      const b=document.createElement('div'); b.className='black'; b.dataset.note=sharp;
      const blackWidthPct = keyW*0.62;
      b.style.width = blackWidthPct+'%'; b.style.left=((i+1)*keyW)+'%';
      b.addEventListener('pointerdown', ()=>{
        if(hardLocked) return;
        if(!unlocked){ $('#unlockOverlay').classList.remove('hidden'); return; }
        trigger(sharp); b.classList.add('active');
      });
      b.addEventListener('pointerup', ()=>b.classList.remove('active'));
      kb.appendChild(b);
    });
  }

  function sizePiano(){
    const wrap=document.querySelector('.kb-wrap');
    const kb=document.querySelector('#keyboard');
    const wrapW=wrap.clientWidth;
    const sep=parseInt(getComputedStyle(kb).getPropertyValue('--sep')||'2',10);
    const minW=WHITE.length*(MIN_WHITE_PX+sep);
    kb.style.width=(wrapW>=minW?wrapW-1:minW)+'px';  /* 直向不足會可滑 */
    kb.style.height='var(--kb-h)';
  }

  /* === 吉他 === */
  function renderGuitar(){
    const kb=$('#keyboard'); kb.innerHTML=''; kb.className='fretboard'; kb.style.height='var(--kb-h)';

    const head=document.createElement('div'); head.className='head'; kb.appendChild(head);
    const nut =document.createElement('div');  nut.className='nut';  kb.appendChild(nut);
    const bridge=document.createElement('div'); bridge.className='bridge'; kb.appendChild(bridge);

    for(let s=0;s<6;s++){
      const y=(s+1)*(100/7);
      const str=document.createElement('div'); str.className='string'; str.dataset.s=String(s); str.style.top=`${y}%`; kb.appendChild(str);
      const hline=document.createElement('div'); hline.className='head-line'; hline.dataset.s=String(s); hline.style.top=`${y}%`; kb.appendChild(hline);
    }

    // 13 個空格（第 13 空格為雙點，且不發聲）
    for(let f=1; f<=13; f++){
      const col=document.createElement('div'); col.className='fret-col';

      // 六條 hit 區（好按）
      for(let s=0; s<6; s++){
        const y=(s+1)*(100/7);
        const hit=document.createElement('div'); hit.className='hit-row'; hit.style.top=`${y}%`; col.appendChild(hit);
      }

      // 品位定位點：單點 4/6/8/10；第 13 空格雙點
      if([4,6,8,10].includes(f)){
        const dot=document.createElement('div');
        dot.style.cssText='position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:16px;height:16px;border-radius:50%;background:#dbc6a4;opacity:.9;box-shadow:0 1px 0 rgba(0,0,0,.35);pointer-events:none;';
        col.appendChild(dot);
      }else if(f===13){
        const dot1=document.createElement('div');
        dot1.style.cssText='position:absolute;left:50%;top:38%;transform:translate(-50%,-50%);width:14px;height:14px;border-radius:50%;background:#dbc6a4;opacity:.9;box-shadow:0 1px 0 rgba(0,0,0,.35);pointer-events:none;';
        const dot2=document.createElement('div');
        dot2.style.cssText='position:absolute;left:50%;top:62%;transform:translate(-50%,-50%);width:14px;height:14px;border-radius:50%;background:#dbc6a4;opacity:.9;box-shadow:0 1px 0 rgba(0,0,0,.35);pointer-events:none;';
        col.appendChild(dot1); col.appendChild(dot2);
      }

      col.addEventListener('pointerdown',(ev)=>{
        if(hardLocked) return;
        if(!unlocked){ $('#unlockOverlay').classList.remove('hidden'); return; }

        const rect = col.getBoundingClientRect();
        const y = ev.clientY - rect.top;
        const slot = rect.height/7;
        let idx = Math.round(y/slot - 1);
        idx = Math.max(0, Math.min(5, idx));

        if(f<=12){
          const midi = TUNING_MIDI[5-idx] + f;
          const note = NOTE_NAMES[midi % 12] + (Math.floor(midi/12) - 1);
          trigger(note);
        }

        const target = kb.querySelector(`.string[data-s="${idx}"]`);
        if(target){
          target.classList.remove('vibrate'); void target.offsetWidth;
          target.classList.add('vibrate');
          setTimeout(()=>target.classList.remove('vibrate'), 380);
        }
      });

      kb.appendChild(col);
    }
  }

  /* === 事件與流程 === */
  $('#instrument').addEventListener('change', ()=>{
    if(hardLocked) return;
    currentInstrument=$('#instrument').value;
    loadSampler(currentInstrument);
    if(currentInstrument==='guitar') renderGuitar(); else renderPiano();
    validateLockBtn();
  });
  $('#displayName').addEventListener('input', validateLockBtn);
  $('#code').addEventListener('input', validateLockBtn);
  $('#email').addEventListener('input', validateLockBtn);

  $('#resetBtn').addEventListener('click', ()=>{
    if(hardLocked) return;
    if(selectedNotes.length>0){ selectedNotes.pop(); refreshNotesDisplay(); validateLockBtn(); }
  });

  // 視窗流程：操作說明 → 啟用聲音
  $('#guideOk').addEventListener('click', ()=>{
    $('#guideOverlay').classList.add('hidden');
    $('#unlockOverlay').classList.remove('hidden');
  });
  $('#cancelUnlock').addEventListener('click', ()=>{ $('#unlockOverlay').classList.add('hidden'); });
  $('#confirmUnlock').addEventListener('click', unlockAudio, {once:true});
  window.addEventListener('keydown', (e)=>{
    if(e.key==='Escape'){
      $('#guideOverlay').classList.add('hidden');
      $('#unlockOverlay').classList.add('hidden');
    }
  });

  // 鎖定：成功才鎖
  $('#lockBtn').addEventListener('click', async ()=>{
    if(hardLocked) return;
    const name=($('#displayName').value||'').trim();
    const code=($('#code').value||'').trim();
    const email=($('#email').value||'').trim();
    if(!name||!code||!validEmail(email)||selectedNotes.length!==3){
      alert('請填姓名、代號、Email 並彈滿 3 個音再鎖定'); return;
    }
    setStatus('⏳ 送出中…');
    const payload={ userId:code, displayName:name, instrument:currentInstrument, note:selectedNotes.join(','), velocity:1, sessionId:'demo', email };
    const controller=new AbortController(); const timer=setTimeout(()=>controller.abort(),6000);
    try{
      const r=await fetch(WEBHOOK,{ method:'POST', headers:{'Content-Type':'text/plain'}, body:JSON.stringify(payload), signal:controller.signal });
      clearTimeout(timer);
      if(r.headers.get('content-type')?.includes('application/json')){
        const data = await r.json();
        if(data.ok){ setStatus('✅ 已送出成功，可退出此介面'); enterHardLock(); }
        else{
          let msg='❌ 送出失敗'; const err=String(data.error||'');
          if(err.includes('duplicate+deadline_passed')) msg='📅 您已填寫過囉，重要的是，已過填寫截止日了💔';
          else if(err.includes('duplicate+code_not_found')) msg='🔎 您已填寫過囉，且您輸入的這組代號我找尋不到，我感到萬分抱歉👀';
          else if(err==='duplicate') msg='📝 已填寫過囉，想要重新填寫請洽ㄟ咪🙏';
          else if(err==='email_required') msg='⚠️ Email缺少或格式不正確，再幫我仔細看看好咪📧';
          else if(err==='email_domain_invalid') msg='🔐 Email網域無法收信，請確認拼字或改用另一個Email，跪求🙇‍♂️';
          else if(err==='deadline_passed') msg='📣 非常抱歉，已過了填寫截止日，但還是可以在這玩耍呢👣';
          else if(err==='code_not_found') msg='🔎 找尋不到代號，請洽新人唷🤵🏻‍♂️👰🏻‍♀️';
          else if(err==='busy') msg='⚠️ 系統忙碌，請稍後再試，給它進擊的重新整理💋';
          setStatus(msg);
        }
      }else{
        if(r.ok){ setStatus('✅ 已送出成功，可退出此介面'); enterHardLock(); }
        else{ setStatus('❌ 送出失敗'); }
      }
    }catch(e){ setStatus('❌ 送出逾時或失敗'); }
  });

  function enterHardLock(){
    hardLocked=true;
    $('#displayName').disabled=true; $('#code').disabled=true; $('#email').disabled=true;
    $('#instrument').disabled=true;  $('#resetBtn').disabled=true; $('#lockBtn').disabled=true;
    $('#lockScreen').style.display='block';
  }

  window.addEventListener('resize', ()=>{ if(currentInstrument==='piano') sizePiano(); });
  window.addEventListener('orientationchange', ()=>{ if(currentInstrument==='piano') sizePiano(); });

  // 啟動
  window.addEventListener('DOMContentLoaded', ()=>{
    renderPiano();
    setStatus('等待啟用聲音…');
    validateLockBtn();
    $('#guideOverlay').classList.remove('hidden');
  });
  </script>
</body>
</html>
```

---

# Code.gs（後端）

> 新增功能（**不改 doGet/doPost 名稱與回傳格式**、不改既有欄位）：
>
> 1. **快速入表排程（Fast‑Ack v2）**：在入佇列後新增「一次性 5 秒觸發」的 worker，通常 1–5 秒內寫入。
> 2. **對刪工具**：加入自訂選單「資料一致性 → 刪除選取列（對刪）」；以 **第1欄時間戳** 當作共用 rowId，同步刪除 logs 與 locks 的對應列（以 LockService 確保一致）。
> 3. 其它程式結構維持原樣；時間驅動 1 分鐘保底觸發仍保留。

```javascript
/**** Code.gs – 後端驅動欄位寬度 + 標題SVG + 既有 Fast-Ack 佇列 + 快速入表 + 對刪工具 ****/

const SHEET_LOGS   = 'logs';     // timestamp|userId|displayName|instrument|note|velocity|sessionId
const SHEET_LOCKS  = 'locks';    // usedAt|email|code|status
const SHEET_GUESTS = 'guests';   // A:南方姓名 B:女方姓名 C:代號 D:結婚日期 E:截止日期
const TZ           = 'Asia/Taipei';
const TIME_FMT     = 'yyyy-MM-dd HH:mm:ss';

// 管理設定
const ADMIN_TOKEN   = 'CHANGE_ME_SECRET_TOKEN'; // 要用 config_save 再改
const UI_CONFIG_KEY = 'ui.config';
const UI_DEFAULTS = {
  widths: { displayName:152, email:304, lastNote:170, code:152 },
  titleText: '互動音符',
  titleColor: '#A68A7C'
};

/* ===== 工具 ===== */
function json_(obj){ return ContentService.createTextOutput(JSON.stringify(obj)).setMimeType(ContentService.MimeType.JSON); }
function text_(s){ return ContentService.createTextOutput(String(s||'')).setMimeType(ContentService.MimeType.TEXT); }
function normalizeEmail_(v){ if(!v) return ''; v=String(v).trim().toLowerCase(); return /.+@.+\..+/.test(v) ? v : ''; }
function makeKey_(code,email){ return `${code}||${email}`; }
function formatNow_(){ return Utilities.formatDate(new Date(), TZ, TIME_FMT); }

/* ===== UI 設定存取 ===== */
function getUiConfig_(){
  const sp = PropertiesService.getScriptProperties();
  const raw = sp.getProperty(UI_CONFIG_KEY);
  if(!raw) return UI_DEFAULTS;
  try{
    const obj = JSON.parse(raw);
    const out = { ...UI_DEFAULTS, ...obj };
    out.widths = { ...UI_DEFAULTS.widths, ...(obj.widths||{}) };
    return out;
  }catch(_){ return UI_DEFAULTS; }
}
function saveUiConfig_(obj){
  const sp = PropertiesService.getScriptProperties();
  const cfg = getUiConfig_();
  const next = { ...cfg, ...obj };
  if (obj.widths) next.widths = { ...cfg.widths, ...obj.widths };
  sp.setProperty(UI_CONFIG_KEY, JSON.stringify(next));
  return next;
}

/* ===== 標題 SVG ===== */
function buildTitleSvg_(cfg){
  const W = 720, H = 84;
  const color = cfg.titleColor || '#A68A7C';
  const text = cfg.titleText || '互動音符';
  const noteFill = '#9b8bb3';
  const noteStroke = '#6f6283';
  const svg = `
  <svg xmlns="http://www.w3.org/2000/svg" width="${W}" height="${H}" viewBox="0 0 ${W} ${H}">
    <defs>
      <filter id="softShadow" x="-20%" y="-50%" width="140%" height="200%">
        <feOffset dx="0" dy="2"/><feGaussianBlur stdDeviation="3"/>
        <feColorMatrix type="matrix"
          values="0 0 0 0 0
                  0 0 0 0 0
                  0 0 0 0 0
                  0 0 0 0.25 0"/>
        <feBlend in="SourceGraphic" mode="normal"/>
      </filter>
    </defs>
    <g transform="translate(60,42) scale(1.1)" opacity="0.92" filter="url(#softShadow)">
      <path d="M0,-16 L0,-50 L16,-52 L16,-20 C16,-10 8,-1  -2,2 C-10,4 -18,0 -18,-8 C-18,-16 -10,-20 0,-16 Z"
            fill="${noteFill}" stroke="${noteStroke}" stroke-width="1.2"/>
    </g>
    <g transform="translate(${W-60},42) scale(-1.1,1.1)" opacity="0.92" filter="url(#softShadow)">
      <path d="M0,-16 L0,-50 L16,-52 L16,-20 C16,-10 8,-1  -2,2 C-10,4 -18,0 -18,-8 C-18,-16 -10,-20 0,-16 Z"
            fill="${noteFill}" stroke="${noteStroke}" stroke-width="1.2"/>
    </g>
    <text x="${W/2}" y="52" text-anchor="middle"
          style="font:700 44px 'Zen Maru Gothic','Noto Sans TC',sans-serif; fill:${color};
                 paint-order:stroke; stroke:rgba(0,0,0,.12); stroke-width:1;">
      ${text}
    </text>
  </svg>`;
  return svg;
}

/* ===== GET / POST 入口 ===== */
function doGet(e){
  const p = e?.parameter || {};
  const action = String(p.action||'').toLowerCase();

  if(action==='config'){
    const cfg = getUiConfig_();
    return json_({ ok:true, widths: cfg.widths, title: { text: cfg.titleText, color: cfg.titleColor } });
  }
  if(action==='title_svg'){
    const svg = buildTitleSvg_(getUiConfig_());
    return ContentService.createTextOutput(svg).setMimeType(ContentService.MimeType.SVG);
  }
  if(action==='status'){
    const code  = String(p.code || '').trim();
    const email = normalizeEmail_(p.email);
    if (!code || !email) return json_({ ok:false, error:'missing_params' });
    const ss    = SpreadsheetApp.getActive();
    const locks = getOrCreateLocksSheet_(ss);
    const used  = hasUsed_(locks, code, email);
    const sp    = PropertiesService.getScriptProperties();
    const inflight = !!sp.getProperty('inflight.' + makeKey_(code, email));
    return json_({ ok:true, status: used ? 'used' : (inflight ? 'inflight' : 'none') });
  }
  return text_('ok');
}

function doPost(e){
  const params = e?.parameter || {};
  if ((params.action||'').toLowerCase()==='config_save'){
    if (params.token !== ADMIN_TOKEN) return json_({ ok:false, error:'unauthorized' });
    let body={};
    try{ body = JSON.parse(e?.postData?.contents||'{}'); }catch(_){ return json_({ ok:false, error:'invalid_json' }); }
    const next = saveUiConfig_(body||{});
    return json_({ ok:true, widths: next.widths });
  }
  return handleFormPost_(e); // 原送單流程
}

/* ===== 你的送單流程（原封保留 + 快速入表排程） ===== */
function handleFormPost_(e){
  const out = (obj) => json_(obj);

  let data = {};
  try { data = JSON.parse(e?.postData?.contents || '{}'); }
  catch (_err) { return out({ ok:false, error:'invalid_json' }); }

  const code  = String(data.userId || '').trim();
  const email = normalizeEmail_(data.email);
  if (!email) return out({ ok:false, error:'email_required' });

  try { if (!checkEmailDomain_(email)) return out({ ok:false, error:'email_domain_invalid' }); }
  catch (_e){}

  try{
    const ss    = SpreadsheetApp.getActive();
    const logs  = ss.getSheetByName(SHEET_LOGS);
    if (!logs)  return out({ ok:false, error:'logs_sheet_not_found' });
    const locks = getOrCreateLocksSheet_(ss);

    const guest = getGuestStatus_(ss, code);
    const sp    = PropertiesService.getScriptProperties();
    const key   = makeKey_(code, email);
    const isInflight = !!sp.getProperty('inflight.' + key);
    const isUsed     = hasUsed_(locks, code, email);
    const duplicate  = isInflight || isUsed;

    let error = '';
    if (duplicate && guest.deadlinePassed)       error = 'duplicate+deadline_passed';
    else if (duplicate && !guest.exists)         error = 'duplicate+code_not_found';
    else if (!guest.exists)                      error = 'code_not_found';
    else if (guest.deadlinePassed)               error = 'deadline_passed';
    else if (duplicate)                          error = 'duplicate';
    if (error) return out({ ok:false, error });

    const nowStr = formatNow_();
    const qid = `${Date.now()}_${Utilities.getUuid().slice(0,8)}`;
    const payload = {
      qid, key,
      row: [
        nowStr,
        data.userId || '',
        data.displayName || '',
        data.instrument || 'piano',
        data.note || '',
        (data.velocity !== undefined && data.velocity !== null) ? data.velocity : '',
        data.sessionId || ''
      ],
      lockRow: [ nowStr, email, code, 'used' ]
    };

    const lock = LockService.getScriptLock();
    if (!lock.tryLock(300)) return out({ ok:false, error:'busy' });
    try{
      sp.setProperty('q.' + qid, JSON.stringify(payload));
      sp.setProperty('inflight.' + key, String(Date.now()));
    } finally { lock.releaseLock(); }

    // 保底每分鐘觸發
    ensureWorkerTrigger_();
    // ⏩ 快速入表：排一個「一次性、約 5 秒後」的觸發器，通常 1–5 秒內就會寫入
    scheduleQuickFlush_(5000);

    return out({ ok:true });
  }catch(err){
    Logger.log('doPost error: ' + err);
    return out({ ok:false, error:'server_error' });
  }
}

/* ===== 背景 worker ===== */
function workerProcessQueue(){
  const sp   = PropertiesService.getScriptProperties();
  const all  = sp.getProperties();
  const qKeys = Object.keys(all).filter(k => k.startsWith('q.'));
  if (qKeys.length === 0) return;

  const lock = LockService.getScriptLock();
  if (!lock.tryLock(20000)) return;
  try {
    const ss    = SpreadsheetApp.getActive();
    const logs  = ss.getSheetByName(SHEET_LOGS);
    const locks = getOrCreateLocksSheet_(ss);
    if (!logs) { qKeys.forEach(k => moveToErrorQueue_(k, 'logs_sheet_not_found')); return; }

    for (const qk of qKeys) {
      const raw = sp.getProperty(qk);
      if (!raw) continue;

      let item;
      try { item = JSON.parse(raw); }
      catch (_e) { moveToErrorQueue_(qk, 'bad_queue_json'); continue; }

      const { qid, key, row, lockRow } = item;
      const code  = lockRow?.[2] || '';
      const email = lockRow?.[1] || '';

      if (hasUsed_(locks, code, email)) { cleanupEntry_(qk, key); continue; }

      try { logs.appendRow(row); }
      catch (e1){ Logger.log('append logs failed: ' + e1); moveToErrorQueue_(qk, 'append_logs_failed'); continue; }

      try { locks.appendRow(lockRow); }
      catch (e2){ Logger.log('append locks failed: ' + e2); sp.setProperty('qw.' + qid, 'locks_mark_failed@' + new Date().toISOString()); }

      cleanupEntry_(qk, key);
    }
  } finally { try{ lock.releaseLock(); }catch(_e){} }
}

/* ===== 快速入表：一次性觸發器 ===== */
function scheduleQuickFlush_(delayMs){
  try{
    const ms = Math.max(3000, Number(delayMs)||5000);
    const sp = PropertiesService.getScriptProperties();
    const last = Number(sp.getProperty('flush.last')||0);
    const now  = Date.now();
    // 節流：3 秒內不重複建一次性觸發器
    if (now - last < 3000) return;
    ScriptApp.newTrigger('workerProcessQueue').timeBased().after(ms).create();
    sp.setProperty('flush.last', String(now));
  }catch(e){ Logger.log('scheduleQuickFlush_ error: ' + e); }
}

/* ===== 其他工具 ===== */
function getOrCreateLocksSheet_(ss){
  let sh = ss.getSheetByName(SHEET_LOCKS);
  if (!sh) { sh = ss.insertSheet(SHEET_LOCKS); sh.appendRow(['usedAt','email','code','status']); }
  else {
    const head = sh.getRange(1,1,1,4).getValues()[0];
    if ((head[0]+'').toLowerCase()!=='usedat' || (head[1]+'').toLowerCase()!=='email'){
      sh.getRange(1,1,1,4).setValues([['usedAt','email','code','status']]);
    }
  }
  return sh;
}
function hasUsed_(locksSheet, code, email){
  const lastRow = locksSheet.getLastRow();
  if (lastRow <= 1) return false;
  const emailRange = locksSheet.getRange(2,2,lastRow-1,1);
  const hits = emailRange.createTextFinder(email).findAll();
  if (!hits || hits.length===0) return false;
  for (const m of hits){
    const r = m.getRow();
    const codeCell   = String(locksSheet.getRange(r,3).getValue()).trim();
    const statusCell = String(locksSheet.getRange(r,4).getValue()||'').toLowerCase();
    if (codeCell===code && statusCell!=='revoked') return true;
  }
  return false;
}
function ensureWorkerTrigger_(){
  const exists = ScriptApp.getProjectTriggers().some(t => t.getHandlerFunction()==='workerProcessQueue');
  if (!exists) ScriptApp.newTrigger('workerProcessQueue').timeBased().everyMinutes(1).create();
}
function cleanupEntry_(qKey, inflightKey){
  const sp = PropertiesService.getScriptProperties();
  try{ sp.deleteProperty(qKey); }catch(_e){}
  if (inflightKey) try{ sp.deleteProperty('inflight.' + inflightKey); }catch(_e){}
}
function moveToErrorQueue_(qKey, reason){
  try{
    const sp = PropertiesService.getScriptProperties();
    const raw = sp.getProperty(qKey); if (!raw) return;
    const item = JSON.parse(raw);
    sp.deleteProperty(qKey);
    sp.setProperty('qe.' + (item?.qid || qKey.slice(2)), reason + '@' + new Date().toISOString());
    if (item?.key) sp.deleteProperty('inflight.' + item.key);
  }catch(e){ Logger.log('moveToErrorQueue_ failed for ' + qKey + ': ' + e); }
}

/* ===== guests / DNS 檢查（保留） ===== */
function getGuestStatus_(ss, code){
  const result={ exists:false, deadlinePassed:false };
  if(!code) return result;
  const sh=ss.getSheetByName(SHEET_GUESTS); if(!sh) return result;
  const lastRow=sh.getLastRow(); if(lastRow<2) return result;
  const rng=sh.getRange(2,3,lastRow-1,3).getValues();
  let found=null;
  for (let i=0;i<rng.length;i++){ const c=String(rng[i][0]||'').trim(); if(c===code){ found=rng[i]; break; } }
  if(!found) return result;
  result.exists=true;
  const dl=rng[rng.indexOf(found)][2] || found[2];
  let deadline=(dl instanceof Date)? dl : new Date(dl);
  if(isNaN(deadline.getTime())) return result;
  if(deadline.getHours()===0 && deadline.getMinutes()===0 && deadline.getSeconds()===0){
    deadline=new Date(deadline.getFullYear(),deadline.getMonth(),deadline.getDate(),23,59,59);
  }
  if(new Date().getTime()>deadline.getTime()) result.deadlinePassed=true;
  return result;
}
function checkEmailDomain_(email){
  const domain = String(email).split('@')[1] || '';
  if (!domain) return false;
  const sp = PropertiesService.getScriptProperties();
  const key='mxcache.'+domain, raw=sp.getProperty(key);
  const now=Date.now(), TTL=24*60*60*1000;
  if(raw){
    const [flag,ts]=raw.split('@');
    if(Number(ts) && (now-Number(ts)<TTL)) return flag==='1';
  }
  const hasMX = hasDnsRecord_(domain,'MX');
  const ok = hasMX || hasDnsRecord_(domain,'A');
  sp.setProperty(key,(ok?'1':'0')+'@'+String(now));
  return ok;
}
function hasDnsRecord_(name,type){
  try{
    const url='https://dns.google/resolve?name='+encodeURIComponent(name)+'&type='+encodeURIComponent(type);
    const res=UrlFetchApp.fetch(url,{ muteHttpExceptions:true, followRedirects:true, validateHttpsCertificates:true });
    const body=JSON.parse(res.getContentText()||'{}');
    if(body.Status!==0) return false;
    const answers=body.Answer||[];
    if(!answers.length) return false;
    if(type==='MX') return answers.some(a=>Number(a.type)===15);
    if(type==='A')  return answers.some(a=>Number(a.type)===1);
    return false;
  }catch(_){ return false; }
}

/* ===== 對刪工具：自訂選單 & 同步刪除（以時間戳為 rowId） ===== */
function onOpen(){
  try{
    SpreadsheetApp.getUi()
      .createMenu('資料一致性')
      .addItem('刪除選取列（對刪）', 'deleteSelectedRowWithPair_')
      .addToUi();
  }catch(e){ Logger.log('onOpen menu error: '+e); }
}

function deleteSelectedRowWithPair_(){
  const ss = SpreadsheetApp.getActive();
  const sh = ss.getActiveSheet();
  if (!sh) return;
  const row = sh.getActiveRange().getRow();
  if (row<=1) return; // 跳過表頭
  const ts = String(sh.getRange(row,1).getValue()).trim();
  if (!ts) return;
  deleteByTimestampPair_(ss, ts);
}

function deleteByTimestampPair_(ss, ts){
  const lock = LockService.getScriptLock();
  if (!lock.tryLock(20000)) return;
  try{
    deleteInSheetByTs_(ss.getSheetByName(SHEET_LOGS), ts);
    deleteInSheetByTs_(ss.getSheetByName(SHEET_LOCKS), ts);
  }finally{ try{ lock.releaseLock(); }catch(_e){} }
}

function deleteInSheetByTs_(sh, ts){
  if (!sh) return;
  const last = sh.getLastRow();
  if (last <= 1) return;
  const arr = sh.getRange(2,1,last-1,1).getValues().map(r=>String(r[0]).trim());
  const idx = arr.findIndex(v=>v===ts);
  if (idx>=0) sh.deleteRow(idx+2);
}
```
