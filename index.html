# ‰∫íÂãïÈü≥Á¨¶ b1.0.2 ‚Äì Email ÈôêÂ°´‰∏ÄÊ¨° + guests ‰ª£Ëôü/Êà™Ê≠¢Êó•Ê™¢Ê†∏ + ÊåáÊùø/Âº¶ÈÖçËâ≤ÔºàÂÆåÊï¥‰∫§‰ªòÔºâ

> Ë™™ÊòéÔºöÂú® **‰∏çÊîπÂãï‰∏ª Webhook Â∞çÂ§ñ‰ªãÈù¢Ëàá `logs` ‰∏ÉÊ¨Ñ** ÁöÑÂâçÊèê‰∏ãÔºåÊñ∞Â¢û‰∏â‰ª∂‰∫ãÔºö
>
> 1. **Email ‰∏ÄÊ¨°ÊÄßÈéñÔºàduplicate Ê™¢Êü•Ôºâ** ‰ªçÂú®Âêå‰∏Ä‰ªΩË©¶ÁÆóË°®ÂÖßÁî® `locks` Â∑•‰ΩúË°®ÂÆåÊàêÔºà‰∏çÂè¶ÈñãË©¶ÁÆóË°®Ôºâ„ÄÇ
> 2. **guests Ê™¢Ê†∏**ÔºöÊñºËº∏ÂÖ•‰ª£ËôüÊôÇÔºå‰º∫ÊúçÁ´ØÊü• `guests`ÔºàC Ê¨Ñ=‰ª£ËôüÔºåËá™Á¨¨ 2 ÂàóËµ∑ÔºâÔºåËã•Êâæ‰∏çÂà∞‚ÜíÊèêÁ§∫„ÄåÊâæÂ∞ã‰∏çÂà∞‰ª£Ëôü,Ë´ãÊ¥ΩÊñ∞‰∫∫„ÄçÔºõËã• E Ê¨ÑÔºàÊà™Ê≠¢Êó•ÔºâÂ∑≤ÈÅé‚ÜíÊèêÁ§∫„ÄåÂ∑≤Âà∞‰∫ÜÊà™Ê≠¢Êó•Âõâ„Äç„ÄÇÂÖ©ËÄÖÁöÜÊúÉ **Á¶ÅÊ≠¢ÈÄÅÂá∫**Ôºà‰ªçÂèØÂΩàÁê¥‰ΩÜ‰∏çË®òÈåÑÔºâ„ÄÇ
> 3. **Âêâ‰ªñÂ§ñËßÄ**ÔºöÊåáÊùøÂíñÂï°Ëâ≤„ÄÅÁê¥Âº¶ÈáëËâ≤„ÄÇ
>
> Áõ∏ÂÆπÊÄßÔºöÊñ∞Â¢û‰∫Ü `doPost` ÁöÑ„ÄåÈ†êÊ™¢„ÄçÊ®°ÂºèÔºà`action:'precheck'`ÔºâÔºåËÄÅÁâàÂè™ÈÄÅÊúÄÁµÇË≥áÊñôÁöÑÊµÅÁ®ã‰∏çÂèóÂΩ±ÈüøÔºõÊúÄÁµÇÈÄÅÂá∫ÊôÇ‰º∫ÊúçÁ´Ø‰ªçÊúÉÂÜçÂÅöÂêåÊ®£Ê™¢Ê†∏‰ª•Èò≤ÁπûÈÅé„ÄÇ

---

## 1) ÂâçÁ´ØÔºàHTML/JSÔºâ‚Äî Email Ê¨Ñ‰Ωç„ÄÅ‰ª£ËôüÈ†êÊ™¢„ÄÅÁ¶ÅÈÄÅÈÇèËºØ„ÄÅÂíñÂï°Ëâ≤ÊåáÊùøÔºãÈáëËâ≤Áê¥Âº¶

* Êñ∞Â¢û **Email** Ëº∏ÂÖ•Ê°ÜÔºà‰ªª‰Ωï Email ‰æõÈ©óË≠âÂîØ‰∏ÄÔºâ„ÄÇ
* Âú® **Ëº∏ÂÖ•ÊàñÊîπÂãï‰ª£ËôüÊôÇ** Ëß∏Áôº„ÄåÈ†êÊ™¢„ÄçÔºöÂëºÂè´ `WEBHOOK` ÁöÑ `doPost` Â∏∂ `{action:'precheck', code}`„ÄÇ
* ‰º∫ÊúçÁ´ØÂõûË¶ÜÔºö

  * `{ok:true}` ‚Üí ‰ª£ËôüÂ≠òÂú®‰∏îÊú™ÈÅéÊà™Ê≠¢Ôºå**ÂÖÅË®±ÈÄÅÂá∫**„ÄÇ
  * `{ok:false, error:'code_not_found'}` ‚Üí ÊèêÁ§∫‰∏ÄÊ¨°„ÄåÊâæÂ∞ã‰∏çÂà∞‰ª£Ëôü,Ë´ãÊ¥ΩÊñ∞‰∫∫„ÄçÔºå**Á¶ÅÊ≠¢ÈÄÅÂá∫**„ÄÇ
  * `{ok:false, error:'deadline_passed'}` ‚Üí ÊèêÁ§∫‰∏ÄÊ¨°„ÄåÂ∑≤Âà∞‰∫ÜÊà™Ê≠¢Êó•Âõâ„ÄçÔºå**Á¶ÅÊ≠¢ÈÄÅÂá∫**„ÄÇ
* Âç≥‰ΩøË¢´Á¶ÅÊ≠¢ÈÄÅÂá∫Ôºå**‰ªçÂèØÂΩàÁê¥**Ôºà‰∏çÂΩ±ÈüøÊú¨Âú∞Êí≠ÊîæÔºâÔºõÈéñÂÆöÊåâÈàïÊúÉ‰øùÊåÅ disabled„ÄÇ
* ÊúÄÁµÇÈÄÅÂá∫ÊôÇËã•‰º∫ÊúçÁ´ØÂà§ÂÆö `duplicate/email_required/code_not_found/deadline_passed`ÔºåÊúÉÂú®ÁãÄÊÖãÂàóÈ°ØÁ§∫Â∞çÊáâË®äÊÅØ„ÄÇ
* Ê®£ÂºèÔºöÊåáÊùøÂíñÂï°Ëâ≤„ÄÅÁê¥Âº¶ÈáëËâ≤ÔºàÂê´Áê¥È†≠Ê∑°Á∑öÔºâ„ÄÇ

> Â∞á‰∏ãÂàóÊï¥ÊÆµË¶ÜËìã‰Ω†ÁöÑ HTML Ê™îÂç≥ÂèØ„ÄÇ

```html
<!doctype html>
<html lang="zh-Hant">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>üé∂‰∫íÂãïÈü≥Á¨¶</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700&display=swap" rel="stylesheet">
<style>
  :root{ --rim:#e4e7ef; --ink:#0f172a; --kb-h:280px; --sep:2px; --stroke:rgba(0,0,0,.18); --glow:rgba(255,255,255,.65); }
  *{ box-sizing:border-box; font-family:"Zen Maru Gothic","Noto Sans TC",system-ui,-apple-system,sans-serif !important; -webkit-text-stroke:.35px var(--stroke); text-shadow:0 1px 0 var(--glow); }
  html,body{ margin:0; color:var(--ink); background:linear-gradient(135deg,#e6dfff 0%, #dcd4ff 100%); }
  .panel{ max-width:1060px;margin:22px auto;background:rgba(255,255,255,.58);border:1px solid rgba(255,255,255,.65);border-radius:16px; padding:18px 18px 26px;box-shadow:0 10px 30px rgba(98,76,171,.12);backdrop-filter:blur(10px) saturate(120%); }
  h2{ margin:4px 0 20px; text-align:center; font-size:2.8rem; font-weight:700; letter-spacing:1px; -webkit-text-stroke:.7px var(--stroke); text-shadow:0 3px 4px rgba(255,255,255,.85); }

  /* ÊéßÂà∂Âàó */
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .row label{opacity:.92;white-space:nowrap;font-weight:400;-webkit-text-stroke:0;text-shadow:none}
  .row input,.row select,.row button{
    height:38px; font-size:14px; background:#fff; padding:8px 10px;
    border:1px solid var(--rim); border-radius:10px;
    -webkit-text-stroke:.25px rgba(0,0,0,.12); text-shadow:0 1px 0 rgba(255,255,255,.5);
  }
  #displayName,#email,#code,#lastNote{ width:152px; font-weight:400; -webkit-text-stroke:0; text-shadow:none }
  .row select{ width:auto; min-width:88px; text-align:center; text-align-last:center; -webkit-text-stroke:0; text-shadow:none; }
  .row select option{text-align:center}
  .row button{ width:120px; cursor:pointer; font-weight:600 }
  .btn-compact{ width:60px !important; }
  .row button:disabled{opacity:.55;cursor:not-allowed}

  /* ÁãÄÊÖãÂàó */
  #status{ background:#eef2f7;border:1px solid var(--rim); border-radius:12px;padding:10px;margin-top:10px; font-size:14px;white-space:pre-wrap;color:#334155;text-align:center; }

  .kb-wrap{ overflow-x:hidden; background:linear-gradient(180deg,#f7f2ff 0%, #ede9fe 100%); border:1px solid var(--rim); border-radius:14px; margin-top:14px; }
  #keyboard{ position:relative; height:var(--kb-h); user-select:none; -webkit-user-select:none; touch-action:none; }

  /* ===== ÈãºÁê¥ÔºàÈªëÈçµÁΩÆ‰∏≠Ôºâ ===== */
  .white{
    position:absolute; bottom:0; height:100%;
    background:linear-gradient(#ffffff,#eceef3 72%,#d9dde5);
    border-radius:0 0 12px 12px;
    box-shadow:inset 0 -12px 16px rgba(0,0,0,.12),
               inset 0 1px 0 rgba(255,255,255,.9),
               0 1px 0 rgba(0,0,0,.04);
  }
  .white::after{ content:""; position:absolute; top:0; bottom:0; right:0; width:var(--sep); background:linear-gradient(transparent,#cfd3dc 50%,transparent); }
  .white:first-child::before{ content:""; position:absolute; top:0; bottom:0; left:0; width:var(--sep); background:linear-gradient(transparent,#cfd3dc 50%,transparent); }
  .white.active{filter:brightness(1.06)}
  .black{
    position:absolute; bottom:38%; height:62%;
    background:linear-gradient(#2d2f36,#0e0f13);
    border:1px solid #0b0d11; border-top:none;
    border-radius:0 0 10px 10px; z-index:5;
    box-shadow:inset 0 -6px 10px rgba(0,0,0,.45), 0 3px 10px rgba(0,0,0,.35);
    transform: translateX(-50%);
  }
  .black.active{filter:brightness(1.22)}
  .label{
    position:absolute; bottom:12px; left:50%; transform:translateX(-50%);
    font-size:11px; color:#475569; background:#ffffffee; border:1px solid var(--rim);
    padding:2px 6px; border-radius:8px;
  }

  /* ===== Âêâ‰ªñÔºàÂíñÂï°Ëâ≤ÊåáÊùø„ÄÅÈáëËâ≤Âº¶Ôºõ1‚Äì12 ÂìÅÂèØÂΩàÔºåÂ§ö 1 Á©∫Ê†ºÔºõÊï¥Ê¢ùÂº¶Ôºâ ===== */
  .fretboard{
    position:relative; display:grid; grid-template-columns: repeat(13, 1fr);
    width:100%; height:var(--kb-h);
    background:linear-gradient(180deg,#6b4f2e 0%, #5b4429 50%, #533c24 100%);
    border-radius:12px;
    box-shadow:inset 0 10px 20px rgba(0,0,0,.25), inset 0 -8px 16px rgba(0,0,0,.2);
  }
  .head{
    position:absolute; left:0; top:0; bottom:0; width:86px; z-index:2;
    background:
      linear-gradient(180deg, rgba(0,0,0,.12), transparent 40%),
      linear-gradient(180deg,#7a5534 0%, #6b4f2e 55%, #5a3f24 100%);
    border-right:1px solid rgba(40,22,8,.35); box-shadow: inset -8px 0 16px rgba(0,0,0,.18);
    border-radius:12px 0 0 12px; pointer-events:none;
  }
  .nut{ position:absolute; left:86px; top:0; bottom:0; width:8px; z-index:3;
    background:linear-gradient(180deg,#e5e1d6,#c9c5ba);
    box-shadow: inset -1px 0 0 rgba(0,0,0,.35), inset 1px 0 0 rgba(255,255,255,.6);
    border-right:2px solid rgba(120,120,120,.5); pointer-events:none; }
  .bridge{ position:absolute; right:0; top:0; bottom:0; width:10px; z-index:2;
    background:linear-gradient(180deg,#b9b6ad,#8f8c83);
    box-shadow: inset 1px 0 0 rgba(255,255,255,.5), inset -1px 0 0 rgba(0,0,0,.25);
    pointer-events:none; border-left:1px solid rgba(0,0,0,.18); }

  .fret-col{ position:relative; background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.02));
    box-shadow: inset -2px 0 0 rgba(255,255,255,.18), inset -4px 0 0 rgba(0,0,0,.28);} 

  /* ÈáëËâ≤Âº¶ */
  .string{ position:absolute; left:94px; right:0; height:0; z-index:3; border-top:2px solid #d4af37; opacity:.96; filter:drop-shadow(0 1px 0 rgba(0,0,0,.18)); transform-origin:center; background: linear-gradient(90deg, rgba(255,255,255,0) 0%, rgba(255,255,255,.35) 50%, rgba(255,255,255,0) 100%); background-size: 160px 1px; background-repeat:no-repeat; background-position:-160px 0; }
  .string[data-s="2"]{ border-top-width:2.5px; }
  .string[data-s="3"]{ border-top-width:3px; }
  .string[data-s="4"]{ border-top-width:3.5px; }
  .string[data-s="5"]{ border-top-width:4px; }

  .head-line{ position:absolute; left:0; width:86px; height:0; border-top:2px solid rgba(212,175,55,.55); filter:drop-shadow(0 1px 0 rgba(0,0,0,.06)); pointer-events:none; z-index:2; }
  .head-line[data-s="2"]{ border-top-width:2.5px; }
  .head-line[data-s="3"]{ border-top-width:3px; }
  .head-line[data-s="4"]{ border-top-width:3.5px; }
  .head-line[data-s="5"]{ border-top-width:4px; }

  .hit-row{ position:absolute; left:0; right:0; height:28px; transform:translateY(-50%); background:transparent; cursor:pointer; z-index:4; }
  @media (pointer:coarse){ .hit-row{ height:34px; } }

  .string.vibrate{ animation: vibrCurve 360ms ease-out, shine 360ms ease-out; }
  @keyframes vibrCurve{ 0%{transform:translateY(0)} 10%{transform:translateY(-3.2px)} 20%{transform:translateY(0)} 30%{transform:translateY(2.6px)} 45%{transform:translateY(0)} 60%{transform:translateY(-1.8px)} 75%{transform:translateY(0.6px)} 100%{transform:translateY(0)} }
  @keyframes shine{ 0%{ background-position:-160px 0; opacity:.95 } 100%{ background-position:160px 0; opacity:.96 } }

  .overlay{ position:fixed; inset:0; z-index:9999; display:flex; align-items:center; justify-content:center; background:rgba(17,24,39,.35); backdrop-filter:blur(3px); }
  .overlay.hidden{ display:none; }
  .dialog{ min-width:300px; max-width:92vw; background:rgba(255,255,255,.96); border:1px solid rgba(255,255,255,.85); border-radius:14px; padding:18px; box-shadow:0 18px 44px rgba(0,0,0,.18); text-align:center; }
  .dialog h3{ margin:0 0 8px; font-size:18px; }
  .dialog p{ margin:6px 0; line-height:1.6; }
  .dialog .actions{ display:flex; gap:10px; justify-content:center; margin-top:12px; }
  .dialog button{ width:120px; height:38px; border-radius:10px; border:1px solid var(--rim); background:#fff; cursor:pointer; font-weight:600; }
  .dialog button.primary{ background:#f8f5ff; }

  #lockScreen{ position:fixed; inset:0; z-index:9998; display:none; background:transparent; }
  footer{ max-width:1060px;margin:8px auto 22px; text-align:center; color:#475569; font-size:12px; opacity:.9; }
</style>
<body>
  <div class="panel">
    <h2>üéº‰∫íÂãïÈü≥Á¨¶üéº</h2>

    <div class="row">
      <label for="displayName">Ë¶™ÂèãÂßìÂêçÔºö</label>
      <input id="displayName" placeholder="‰æãÔºöÂºµÂí©Êèö" />

      <label for="email">EmailÔºö</label>
      <input id="email" placeholder="your@email" inputmode="email" />

      <label for="code">ÂèñÂæó‰ª£ËôüÔºö</label>
      <input id="code" placeholder="Ë´ãËº∏ÂÖ•‰ª£Ëôü" />

      <label for="instrument">Ê®ÇÂô®ËΩâÊèõÔºö</label>
      <select id="instrument">
        <option value="piano" selected>ÈãºÁê¥</option>
        <option value="guitar">Âêâ‰ªñ</option>
      </select>

      <label for="lastNote">Èü≥Á¨¶Á¥ÄÈåÑÔºö</label>
      <input id="lastNote" placeholder="‚Äî , ‚Äî , ‚Äî" readonly />

      <button id="resetBtn" type="button" class="btn-compact">ÈáçË®≠</button>
      <button id="lockBtn" type="button" class="btn-compact" disabled>ÈéñÂÆö</button>
    </div>

    <p id="status">Â∞öÊú™ÂàùÂßãÂåñ</p>

    <div class="kb-wrap"><div id="keyboard"></div></div>
  </div>

  <!-- ÂΩàË∑≥Ë¶ñÁ™ó ‚ë†ÔºöÊìç‰ΩúË™™Êòé -->
  <div id="guideOverlay" class="overlay" role="dialog" aria-modal="true" aria-labelledby="guideTitle">
    <div class="dialog">
      <h3 id="guideTitle">üìçÊìç‰ΩúË™™Êòéüìç</h3>
      <p>üîªÂ°´ÂÖ•ÂßìÂêç„ÄÅEmail ËàáÂèñÂæóÁöÑ‰ª£Ëôü</p><p>‚Üì</p>
      <p>üîªÈôêÂÆöÂêåÁ®ÆÊ®ÇÂô®ÈÅ∏‰∏âÂÄãÈü≥</p><p>‚Üì</p>
      <p>üîª‰∏âÂÄãÈü≥Á¢∫Ë™çÂæåÂèØÊåâÈéñÂÆö</p><p>‚Üì</p>
      <p>üîªË∑≥ÈÄöÁü•Â∑≤ÂÆåÊàêÂç≥ÂèØÈÄÄÂá∫</p><p>‚Üì</p>
      <p>‚ùóÔ∏èÊ≤íÊåâÈéñÂÆöÂ∞±ÊòØÊ≤íÊúâÈÄÅÂá∫Â∞±ÊòØÂΩàÂÄãÂØÇÂØû</p>
      <div class="actions"><button id="guideOk" class="primary">‰∫ÜËß£</button></div>
    </div>
  </div>

  <!-- ÂΩàË∑≥Ë¶ñÁ™ó ‚ë°ÔºöÂïüÁî®ËÅ≤Èü≥ / Èü≥Ëâ≤ËºâÂÖ• -->
  <div id="unlockOverlay" class="overlay hidden" role="dialog" aria-modal="true" aria-labelledby="unlockTitle">
    <div class="dialog">
      <h3 id="unlockTitle">ÂïüÁî®ËÅ≤Èü≥</h3>
      <p>Ë´ãÈñãÂïüÈü≥Èáè‰∏¶ÈªûÊìä„ÄåÁ¢∫ÂÆö„ÄçÂïüÁî®ËÅ≤Èü≥</p>
      <p style="font-size:12px;opacity:.72;">iPhoneË´ãÁ¢∫Ë™çÂÅ¥ÈÇäÈùúÈü≥ÈçµÈ†àÈóúÈñâ</p>
      <div class="actions">
        <button id="cancelUnlock">ÂèñÊ∂à</button>
        <button id="confirmUnlock" class="primary">Á¢∫ÂÆö</button>
      </div>
    </div>
  </div>

  <div id="lockScreen" aria-hidden="true"></div>

  <footer>¬© Copyright 2025 MY‚Äòs system Version:b1.0.2</footer>

  <script src="https://cdn.jsdelivr.net/npm/tone@14.8.49/build/Tone.min.js"></script>
  <script>
    /* ===== ‰∏ªÁ®ãÂºèÔºà‰∏çÊîπÂ∞çÂ§ñÊé•Âè£ÔºõÊñ∞Â¢û email/È†êÊ™¢/Á¶ÅÈÄÅÔºâ ===== */
    const WEBHOOK = "https://script.google.com/macros/s/AKfycbw3rDKy-mjN93ValBMs28ndCFv5IbqjupDgn9rHvqYOqJwo5If3DdB1zVervdluT8YW/exec";
    const $ = s => document.querySelector(s);
    const setStatus = m => $('#status').textContent = m;

    let audioCtx=null, sampler=null, samplerReady=false, unlocked=false, hardLocked=false;
    let currentInstrument='piano';
    let selectedNotes = [];

    const PIANO_BASE=new URL('./piano/',location.href).href;
    const PIANO_URLS={'A1':'A1.mp3','C2':'C2.mp3','D#2':'Ds2.mp3','F#2':'Fs2.mp3','A2':'A2.mp3','C3':'C3.mp3','D#3':'Ds3.mp3','F#3':'Fs3.mp3','A3':'A3.mp3','C4':'C4.mp3','D#4':'Ds4.mp3','F#4':'Fs4.mp3','A4':'A4.mp3','C5':'C5.mp3'};
    const GUITAR_BASE=new URL('./guitar/',location.href).href;
    const GUITAR_URLS={'E2':'E2.wav','A2':'A2.wav','D3':'D3.wav','G3':'G3.wav','B3':'B3.wav','E4':'E4.wav'};

    const WHITE=["C3","D3","E3","F3","G3","A3","B3","C4","D4","E4","F4","G4","A4","B4"];
    const BLACK_AFTER={ 'C':'C#','D':'D#','F':'F#','G':'G#','A':'A#' };
    const MIN_WHITE_PX=64, TOTAL_WHITE=WHITE.length;

    // Âêâ‰ªñÔºàËá™‰∏ãËÄå‰∏äÔºâ
    const TUNING_MIDI = [40,45,50,55,59,64]; // E2 A2 D3 G3 B3 E4
    const NOTE_NAMES = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
    const FRETS = 12; // 1~12 ÂìÅÔºàÁ¨¨ 13 Á©∫Ê†º‰∏çÁôºËÅ≤Ôºâ

    function midiToNoteName(midi){ const n = NOTE_NAMES[midi % 12]; const octave = Math.floor(midi/12) - 1; return n + octave; }
    function validEmail(v){ return /.+@.+\..+/.test((v||'').trim()); }

    // === guests È†êÊ™¢ÁãÄÊÖã ===
    let submitAllowed = null; // null=Êú™Áü•, true=ÂèØÈÄÅ, false=Á¶ÅÈÄÅ
    let notifiedNF = false;   // code_not_found Â∑≤ÊèêÁ§∫ÈÅé
    let notifiedDL = false;   // deadline_passed Â∑≤ÊèêÁ§∫ÈÅé
    let lastCheckedCode = '';

    async function precheckCode(){
      const code = ($('#code').value||'').trim();
      if(!code){ submitAllowed=null; validateLockBtn(); return; }
      if(code===lastCheckedCode && submitAllowed!==null) { validateLockBtn(); return; }
      try{
        const r=await fetch(WEBHOOK,{method:'POST',headers:{'Content-Type':'text/plain'},body:JSON.stringify({action:'precheck', code})});
        let ok=false, err='';
        if(r.headers.get('content-type')?.includes('application/json')){
          const j = await r.json(); ok=!!j.ok; err=j.error||'';
        } else { ok=r.ok; }
        if(ok){ submitAllowed=true; }
        else if(err==='code_not_found'){ submitAllowed=false; if(!notifiedNF){ alert('ÊâæÂ∞ã‰∏çÂà∞‰ª£Ëôü,Ë´ãÊ¥ΩÊñ∞‰∫∫'); notifiedNF=true; } }
        else if(err==='deadline_passed'){ submitAllowed=false; if(!notifiedDL){ alert('Â∑≤Âà∞‰∫ÜÊà™Ê≠¢Êó•Âõâ'); notifiedDL=true; } }
        else { submitAllowed=false; }
      }catch(e){ submitAllowed=false; }
      finally{ lastCheckedCode=code; validateLockBtn(); }
    }

    async function unlockAudio(){
      try{
        const Ctx=window.webkitAudioContext||window.AudioContext;
        if(!audioCtx) audioCtx=new Ctx({latencyHint:'interactive'});
        if(audioCtx.state!=='running') await audioCtx.resume();
        Tone.setContext(new Tone.Context(audioCtx));
        await Tone.start();
        loadSampler(currentInstrument);
        unlocked=true;
        $('#unlockOverlay').classList.add('hidden');
      }catch(e){ setStatus('ÂïüÁî®Â§±ÊïóÔºö'+e.message); }
    }

    function loadSampler(inst='piano'){
      sampler?.dispose?.(); sampler=null; samplerReady=false;
      let urls=PIANO_URLS, base=PIANO_BASE, label='üéπ ';
      if(inst==='guitar'){ urls=GUITAR_URLS; base=GUITAR_BASE; label='üé∏ '; }
      setStatus(label+'ËºâÂÖ•‰∏≠‚Ä¶');
      sampler=new Tone.Sampler({ urls, release:1, baseUrl:base, onload:()=>{ samplerReady=true; setStatus(label+'Â∑≤ËºâÂÖ• ‚úÖ'); } }).toDestination();
    }

    function refreshNotesDisplay(){
      const parts = [selectedNotes[0]||'‚Äî', selectedNotes[1]||'‚Äî', selectedNotes[2]||'‚Äî'];
      $('#lastNote').value = parts.join(' , ');
    }

    function trigger(note){
      if(hardLocked) return;
      if(!samplerReady){ setStatus('Èü≥Ëâ≤ËºâÂÖ•‰∏≠‚Ä¶'); return; }
      sampler.triggerAttackRelease(note,'8n');
      if(selectedNotes.length < 3) selectedNotes.push(note); else selectedNotes[2] = note;
      refreshNotesDisplay(); validateLockBtn();
    }

    function validateLockBtn(){
      const nameOk = ($('#displayName').value || '').trim().length > 0;
      const codeOk = ($('#code').value || '').trim().length > 0;
      const emailOk = validEmail($('#email').value);
      const notesOk = selectedNotes.length === 3;
      const allow = (submitAllowed===true);
      $('#lockBtn').disabled = !(nameOk && codeOk && emailOk && notesOk && allow);
    }

    /* === ÈãºÁê¥ÔºàÈªëÈçµÁΩÆ‰∏≠Ôºâ === */
    function renderPiano(){
      const kb=$('#keyboard'); kb.innerHTML=''; kb.className=''; sizePiano();
      const keyW=100/TOTAL_WHITE;

      WHITE.forEach((note,i)=>{
        const w=document.createElement('div'); w.className='white'; w.dataset.note=note;
        w.style.left=`${i*keyW}%`; w.style.width=`${keyW}%`;
        if(note[0]==='C'||note[0]==='G'){ const lab=document.createElement('div'); lab.className='label'; lab.textContent=note; w.appendChild(lab); }
        w.addEventListener('pointerdown', ()=>{ if(hardLocked) return; if(!unlocked){ $('#unlockOverlay').classList.remove('hidden'); return; } trigger(note); w.classList.add('active'); });
        w.addEventListener('pointerup', ()=>w.classList.remove('active'));
        kb.appendChild(w);
      });

      WHITE.forEach((note,i)=>{
        const l=note[0],sharp=BLACK_AFTER[l]?BLACK_AFTER[l]+note.slice(1):null;
        if(!sharp||(l==='A'&&i===TOTAL_WHITE-1)) return;
        const b=document.createElement('div'); b.className='black'; b.dataset.note=sharp;
        const blackWidthPct = keyW*0.62;
        b.style.width = `${blackWidthPct}%`;
        b.style.left  = `${(i+1)*keyW}%`;
        b.addEventListener('pointerdown', ()=>{ if(hardLocked) return; if(!unlocked){ $('#unlockOverlay').classList.remove('hidden'); return; } trigger(sharp); b.classList.add('active'); });
        b.addEventListener('pointerup', ()=>b.classList.remove('active'));
        kb.appendChild(b);
      });
    }

    function sizePiano(){
      const wrap=document.querySelector('.kb-wrap'); const kb=document.querySelector('#keyboard');
      const wrapW=wrap.clientWidth; const sep=parseInt(getComputedStyle(kb).getPropertyValue('--sep')||'2');
      const minW=WHITE.length*(64+sep); kb.style.width=(wrapW>=minW?wrapW-1:minW)+'px'; kb.style.height='var(--kb-h)';
    }

    /* === Âêâ‰ªñÔºàÂíñÂï°ÊåáÊùø+ÈáëËâ≤Âº¶Ôºõ13 Á©∫Ê†ºÔºõ1‚Äì12 ÂìÅÂèØÂΩàÔºâ === */
    function renderGuitar(){
      const kb=$('#keyboard'); kb.innerHTML=''; kb.className='fretboard'; kb.style.height='var(--kb-h)';

      const head=document.createElement('div'); head.className='head'; kb.appendChild(head);
      const nut =document.createElement('div');  nut.className='nut';  kb.appendChild(nut);
      const bridge=document.createElement('div'); bridge.className='bridge'; kb.appendChild(bridge);

      for(let s=0;s<6;s++){
        const y=(s+1)*(100/7);
        const str=document.createElement('div'); str.className='string'; str.dataset.s=String(s); str.style.top=`calc(${y}%)`; kb.appendChild(str);
        const hline=document.createElement('div'); hline.className='head-line'; hline.dataset.s=String(s); hline.style.top=`calc(${y}%)`; kb.appendChild(hline);
      }

      for(let f=1; f<=13; f++){
        const col=document.createElement('div'); col.className='fret-col';

        for(let s=0; s<6; s++){
          const y=(s+1)*(100/7);
          const hit=document.createElement('div'); hit.className='hit-row'; hit.style.top=`calc(${y}%)`; col.appendChild(hit);
        }

        if([4,6,8,10].includes(f)){
          const dot=document.createElement('div');
          dot.style.cssText='position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:16px;height:16px;border-radius:50%;background:#dbc6a4;opacity:.9;box-shadow:0 1px 0 rgba(0,0,0,.35);pointer-events:none;';
          col.appendChild(dot);
        }

        if(f===13){
          const up=document.createElement('div');
          const down=document.createElement('div');
          const base='position:absolute;left:50%;transform:translate(-50%,-50%);width:16px;height:16px;border-radius:50%;background:#dbc6a4;opacity:.9;box-shadow:0 1px 0 rgba(0,0,0,.35);pointer-events:none;';
          up.style.cssText   = base + 'top:calc(100% * 1.5 / 7);';
          down.style.cssText = base + 'top:calc(100% * 5.6 / 7);';
          col.appendChild(up); col.appendChild(down);
        }

        col.addEventListener('pointerdown',(ev)=>{
          if(hardLocked) return;
          if(!unlocked){ $('#unlockOverlay').classList.remove('hidden'); return; }

          const rect = col.getBoundingClientRect();
          const y = ev.clientY - rect.top; const slot = rect.height/7;
          let idx = Math.round(y/slot - 1); idx = Math.max(0, Math.min(5, idx));

          if(f<=FRETS){
            const midi = TUNING_MIDI[5-idx] + f;
            const note = midiToNoteName(midi);
            trigger(note);
          }

          const target = kb.querySelector(`.string[data-s="${idx}"]`);
          if(target){ target.classList.remove('vibrate'); void target.offsetWidth; target.classList.add('vibrate'); setTimeout(()=>target.classList.remove('vibrate'), 380); }
        });

        kb.appendChild(col);
      }
    }

    /* ‰∫ã‰ª∂ËàáÊµÅÁ®ã */
    $('#instrument').addEventListener('change', ()=>{
      if(hardLocked) return;
      currentInstrument=$('#instrument').value;
      loadSampler(currentInstrument);
      if(currentInstrument==='guitar') renderGuitar(); else renderPiano();
      validateLockBtn();
    });
    $('#displayName').addEventListener('input', validateLockBtn);
    $('#email').addEventListener('input', validateLockBtn);
    $('#code').addEventListener('input', ()=>{ submitAllowed=null; precheckCode(); });
    $('#code').addEventListener('blur', precheckCode);

    $('#resetBtn').addEventListener('click', ()=>{ if(hardLocked) return; if(selectedNotes.length>0){ selectedNotes.pop(); refreshNotesDisplay(); validateLockBtn(); } });

    $('#guideOk').addEventListener('click', ()=>{ $('#guideOverlay').classList.add('hidden'); $('#unlockOverlay').classList.remove('hidden'); });
    $('#cancelUnlock').addEventListener('click', ()=>{ $('#unlockOverlay').classList.add('hidden'); });
    $('#confirmUnlock').addEventListener('click', unlockAudio, {once:true});
    window.addEventListener('keydown', (e)=>{ if(e.key==='Escape'){ $('#guideOverlay').classList.add('hidden'); $('#unlockOverlay').classList.add('hidden'); } });

    $('#lockBtn').addEventListener('click', async ()=>{
      if(hardLocked) return;
      if(submitAllowed!==true){ alert(notifiedDL? 'Â∑≤Âà∞‰∫ÜÊà™Ê≠¢Êó•Âõâ' : 'ÊâæÂ∞ã‰∏çÂà∞‰ª£Ëôü,Ë´ãÊ¥ΩÊñ∞‰∫∫'); return; }
      const name=($('#displayName').value||'').trim();
      const code=($('#code').value||'').trim();
      const email=($('#email').value||'').trim();
      if(!name||!code||!validEmail(email)||selectedNotes.length!==3){ alert('Ë´ãÂ°´ÂßìÂêç„ÄÅ‰ª£Ëôü„ÄÅEmail ‰∏¶ÂΩàÊªø 3 ÂÄãÈü≥ÂÜçÈéñÂÆö'); return; }
      setStatus('ÈÄÅÂá∫‰∏≠‚Ä¶'); enterHardLock();
      const payload={ userId: code, displayName: name, instrument: currentInstrument, note: selectedNotes.join(','), velocity: 1, sessionId: 'demo', email };
      const controller=new AbortController(); const timer=setTimeout(()=>controller.abort(),6000);
      try{
        const r=await fetch(WEBHOOK,{method:'POST',headers:{'Content-Type':'text/plain'},body:JSON.stringify(payload),signal:controller.signal});
        clearTimeout(timer);
        let msg = 'Â∑≤ÈÄÅÂá∫ÊàêÂäüÔºåÂèØÈÄÄÂá∫Ê≠§‰ªãÈù¢';
        if(r.headers.get('content-type')?.includes('application/json')){
          const data = await r.json();
          if(!data.ok){
            if(data.error==='duplicate') msg='Â∑≤Â°´ÂØ´ÈÅéÔºåËã•Ë¶ÅÂà™Èô§Ë´ãÊâæÁÆ°ÁêÜËÄÖ';
            else if(data.error==='email_required') msg='Email Áº∫Â∞ëÊàñÊ†ºÂºè‰∏çÊ≠£Á¢∫ÔºàÂ∑≤ÈéñÂÆöÔºâ';
            else if(data.error==='code_not_found') msg='ÊâæÂ∞ã‰∏çÂà∞‰ª£Ëôü,Ë´ãÊ¥ΩÊñ∞‰∫∫';
            else if(data.error==='deadline_passed') msg='Â∑≤Âà∞‰∫ÜÊà™Ê≠¢Êó•Âõâ';
            else msg='ÈÄÅÂá∫Â§±ÊïóÔºàÂ∑≤ÈéñÂÆöÔºâ';
          }
        }else if(!r.ok){ msg='ÈÄÅÂá∫Â§±ÊïóÔºàÂ∑≤ÈéñÂÆöÔºâ'; }
        setStatus(msg);
      }catch(e){ setStatus('ÈÄÅÂá∫ÈÄæÊôÇÊàñÂ§±ÊïóÔºàÂ∑≤ÈéñÂÆöÔºâ'); }
    });

    function enterHardLock(){
      hardLocked=true; $('#displayName').disabled=true; $('#email').disabled=true; $('#code').disabled=true; $('#instrument').disabled=true; $('#resetBtn').disabled=true; $('#lockBtn').disabled=true; $('#lockScreen').style.display='block';
    }

    window.addEventListener('resize', ()=>{ if(currentInstrument==='piano') sizePiano(); });
    window.addEventListener('orientationchange', ()=>{ if(currentInstrument==='piano') sizePiano(); });

    window.addEventListener('DOMContentLoaded', ()=>{
      renderPiano(); setStatus('Á≠âÂæÖÂïüÁî®ËÅ≤Èü≥‚Ä¶'); validateLockBtn();
      $('#guideOverlay').classList.remove('hidden');
    });
  </script>
</body>
</html>
```

---

## 2) Apps ScriptÔºàCode.gsÔºâ‚Äî guests Ê™¢Ê†∏ + Email ÈôêÂ°´‰∏ÄÊ¨°ÔºàÂêå‰∏Ä‰ªΩË©¶ÁÆóË°®Ôºâ

* **‰∏çÊîπÂ∞çÂ§ñÊé•Âè£**Ôºö`doGet()` ‰ªçÂõû "ok"Ôºõ`doPost()` ‰ªçÂõû `{ok:true}` Êàñ `{ok:false, error:...}`„ÄÇ
* **Â∑•‰ΩúË°®**Ôºö

  * `logs`ÔºàÊó¢ÊúâÔºåÂõ∫ÂÆö 7 Ê¨ÑÔºâÔºö`timestamp | userId | displayName | instrument | note | velocity | sessionId`
  * `guests`ÔºàÊó¢ÊúâÔºâÔºöA=ÂçóÊñπÂßìÂêç„ÄÅB=Â•≥ÊñπÂßìÂêç„ÄÅC=‰ª£ËôüÔºàËá™ C2 Ëµ∑Ôºâ„ÄÅD=ÁµêÂ©öÊó•Êúü„ÄÅE=Êà™Ê≠¢Êó•Êúü
  * `locks`ÔºàÊñ∞Â¢ûÊñºÂêå‰∏Ä‰ªΩË©¶ÁÆóË°®Ôºå‰∏çÂè¶ÈñãÔºâÔºö`code | email | usedAt | status`
* **ÊµÅÁ®ã**Ôºö

  * **È†êÊ™¢**ÔºöËã• `action:'precheck'`ÔºåÂè™ÂÅö guests Ê™¢Ê†∏ ‚Üí Âõû `{ok:true}` Êàñ `{ok:false, error:'code_not_found'|'deadline_passed'}`„ÄÇ
  * **ÊúÄÁµÇÈÄÅÂá∫**ÔºöÂÖàÊ™¢ `email`„ÄÅÂÜçÊ™¢ guestsÔºà‰ª£ËôüÂ≠òÂú®‰∏îÊú™ÈÅéÊúüÔºâÔºåÂÜçÊ™¢ `locks`Ôºà`(code,email)` Êú™‰ΩøÁî®Ôºâ‚Üí ÈéñÂÆö ‚Üí ÂØ´ÂÖ• `logs` ‰∏ÉÊ¨Ñ ‚Üí `{ok:true}`„ÄÇ

> Ë¶ÜËìã‰Ω†ÁöÑ **Code.gs**Ôºö

```javascript
const SHEET_NAME = 'logs';
const LOCKS_SHEET_NAME = 'locks';
const GUESTS_SHEET_NAME = 'guests';

// ÂÅ•Â∫∑Ê™¢Êü•
function doGet(e) {
  return ContentService.createTextOutput('ok')
    .setMimeType(ContentService.MimeType.TEXT);
}

function doPost(e) {
  const out = (obj) => ContentService.createTextOutput(JSON.stringify(obj))
                    .setMimeType(ContentService.MimeType.JSON);
  const ss = SpreadsheetApp.getActive();
  const logsSheet = ss.getSheetByName(SHEET_NAME);
  if (!logsSheet) return out({ ok:false, error:'Sheet logs not found' });

  let data = {};
  try { data = JSON.parse(e.postData.contents || '{}'); }
  catch (err) { return out({ ok:false, error:'Invalid JSON' }); }

  const code = (data.userId || data.code || '').toString().trim();
  const email = normalizeEmail(data.email);

  // === Ê®°Âºè AÔºöÈ†êÊ™¢ÔºàËº∏ÂÖ•‰ª£ËôüÂç≥Ê™¢Êü• guests ËàáÊà™Ê≠¢Êó•Ôºâ ===
  if (data.action === 'precheck') {
    const chk = checkGuestCode_(code);
    if (!chk.found) return out({ ok:false, error:'code_not_found' });
    if (chk.deadlinePassed) return out({ ok:false, error:'deadline_passed' });
    return out({ ok:true });
  }

  // === Ê®°Âºè BÔºöÊúÄÁµÇÈÄÅÂá∫ÔºàÂÆåÊï¥È©óË≠âÔºâ ===
  if (!email) return out({ ok:false, error:'email_required' });

  // guests Ê™¢Ê†∏Ôºö‰ª£ËôüÂ≠òÂú®‰∏îÊú™ÈÅéÊúü
  const chk = checkGuestCode_(code);
  if (!chk.found) return out({ ok:false, error:'code_not_found' });
  if (chk.deadlinePassed) return out({ ok:false, error:'deadline_passed' });

  // locks Èôê‰∏ÄÊ¨°ÔºàÂêå‰∏Ä code+emailÔºâ
  const locksSheet = getOrCreateLocksSheet_();
  if (hasUsed_(locksSheet, code, email)) return out({ ok:false, error:'duplicate' });
  appendLock_(locksSheet, code, email);

  // ÂØ´ÂÖ• logs ‰∏ÉÊ¨ÑÔºàÂõ∫ÂÆöÈ†ÜÂ∫èÔºâ
  const row = [
    new Date(),
    data.userId || '',
    data.displayName || '',
    data.instrument || 'piano',
    data.note || '',
    data.velocity ?? '',
    data.sessionId || ''
  ];
  try {
    logsSheet.appendRow(row);
  } catch (err) {
    try { removeLastLockIfMatches_(locksSheet, code, email); } catch (e2) {}
    return out({ ok:false, error:'append_failed' });
  }

  return out({ ok:true });
}

/** guests Ê™¢Ê†∏ÔºöÊâæ C Ê¨Ñ‰ª£ËôüÔºåÂèñ E Ê¨ÑÊà™Ê≠¢Êó•ÊòØÂê¶Â∑≤ÈÅé **/
function checkGuestCode_(code){
  const ss = SpreadsheetApp.getActive();
  const sh = ss.getSheetByName(GUESTS_SHEET_NAME);
  if (!sh) return { found:false, deadlinePassed:false };
  const last = sh.getLastRow();
  if (last < 2) return { found:false, deadlinePassed:false };
  const codes = sh.getRange(2, 3, last-1, 1).getValues(); // C2:C
  for (var i=0; i<codes.length; i++){
    const c = String(codes[i][0]||'').trim();
    if (c && c === code){
      const rowIdx = i + 2;
      const deadlineVal = sh.getRange(rowIdx, 5).getValue(); // E=Êà™Ê≠¢Êó•
      const passed = isDeadlinePassed_(deadlineVal);
      return { found:true, deadlinePassed: passed };
    }
  }
  return { found:false, deadlinePassed:false };
}

function isDeadlinePassed_(deadlineVal){
  if (!deadlineVal) return false; // Ê≤íÂ°´Êà™Ê≠¢Êó•Ë¶ñÁÇ∫Êú™ÈÅéÊúü
  const tz = SpreadsheetApp.getActive().getSpreadsheetTimeZone() || 'Asia/Taipei';
  const now = new Date();
  let d = deadlineVal instanceof Date ? new Date(deadlineVal) : new Date(deadlineVal);
  if (isNaN(d.getTime())) return false; // Ëß£ÊûêÂ§±ÊïóË¶ñÁÇ∫Êú™ÈÅéÊúüÔºàÈÅøÂÖçË™§ÊÆ∫Ôºâ
  // Ë¶ñÁÇ∫„ÄåÊà™Ê≠¢Êó• 23:59:59„ÄçÁµêÊùü
  d.setHours(23,59,59,999);
  return now.getTime() > d.getTime();
}

/** locksÔºöÂêå‰∏Ä‰ªΩË©¶ÁÆóË°®Ôºå‰∏çÂè¶Èñã **/
function normalizeEmail(v){ if (!v) return ''; v = String(v).trim().toLowerCase(); return /.+@.+\..+/.test(v) ? v : ''; }
function getOrCreateLocksSheet_(){
  const ss = SpreadsheetApp.getActive();
  let sh = ss.getSheetByName(LOCKS_SHEET_NAME);
  if (!sh) { sh = ss.insertSheet(LOCKS_SHEET_NAME); sh.appendRow(['code','email','usedAt','status']); }
  return sh;
}
function hasUsed_(locksSheet, code, email){
  const rng = locksSheet.getDataRange();
  const values = rng.getValues();
  for (var i=1;i<values.length;i++){
    var row = values[i];
    if (String(row[0]).trim() === code && String(row[1]).trim().toLowerCase() === email) {
      if ((row[3]||'').toString().toLowerCase() !== 'revoked') return true;
    }
  }
  return false;
}
function appendLock_(locksSheet, code, email){ locksSheet.appendRow([code, email, new Date(), 'used']); }
function removeLastLockIfMatches_(locksSheet, code, email){
  const lastRow = locksSheet.getLastRow();
  if (lastRow <= 1) return;
  const row = locksSheet.getRange(lastRow,1,1,4).getValues()[0];
  if (String(row[0]).trim() === code && String(row[1]).trim().toLowerCase() === email) {
    locksSheet.deleteRow(lastRow);
  }
}
```

---

## 3) È©óÊî∂ÈáçÈªû

* [x] `guests` C Ê¨Ñ‰ª£ËôüÊâæ‰∏çÂà∞ ‚Üí ÂâçÁ´ØÂΩà‰∏ÄÊ¨°ÊèêÁ§∫„ÄåÊâæÂ∞ã‰∏çÂà∞‰ª£Ëôü,Ë´ãÊ¥ΩÊñ∞‰∫∫„ÄçÔºå`ÈéñÂÆö` ÊåâÈàï‰øùÊåÅ disabledÔºõ‰º∫ÊúçÁ´ØÊúÄÁµÇÈÄÅÂá∫‰πüÊúÉÊìã‰∏ã‰∏¶Âõû `{ok:false,error:'code_not_found'}`„ÄÇ
* [x] `guests` E Ê¨ÑÊà™Ê≠¢Êó•Â∑≤ÈÅé ‚Üí ÂâçÁ´ØÂΩà‰∏ÄÊ¨°ÊèêÁ§∫„ÄåÂ∑≤Âà∞‰∫ÜÊà™Ê≠¢Êó•Âõâ„ÄçÔºå`ÈéñÂÆö` disabledÔºõ‰º∫ÊúçÁ´ØÊúÄÁµÇÈÄÅÂá∫Âõû `{ok:false,error:'deadline_passed'}`„ÄÇ
* [x] Email ÈôêÂ°´‰∏ÄÊ¨°ÔºöÂêå `(code,email)` Á¨¨‰∫åÊ¨°ÈÄÅÂá∫Âõû `{ok:false,error:'duplicate'}`„ÄÇ
* [x] **Âêå‰∏Ä‰ªΩË©¶ÁÆóË°®**Ôºö`logs`ÔºàË®òÈåÑÈü≥Á¨¶Ôºâ„ÄÅ`guests`ÔºàÊñ∞‰∫∫/‰ª£Ëôü/Êó•ÊúüÔºâ„ÄÅ`locks`Ôºà‰∏ÄÊ¨°ÊÄßÈéñÔºâ„ÄÇ
* [x] ‰ªçÂèØËá™Áî±ÂΩàÁê¥Ôºà‰∏çÂΩ±ÈüøÊú¨Âú∞Êí≠ÊîæÔºâÔºåÂÉÖÁ¶ÅÊ≠¢ÈÄÅÂá∫„ÄÇ
* [x] Â∞çÂ§ñÊé•Âè£Ëàá `logs` ‰∏ÉÊ¨ÑÊú™ËÆä„ÄÇ
