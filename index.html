<!doctype html>
<html lang="zh-Hant">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ğŸ¼äº’å‹•éŸ³ç¬¦ğŸ¼</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700&display=swap" rel="stylesheet">
<style>
  :root{ --rim:#e4e7ef; --ink:#0f172a; --kb-h:280px; --sep:2px; --stroke:rgba(0,0,0,.18); --glow:rgba(255,255,255,.65); }
  *{ box-sizing:border-box; font-family:"Zen Maru Gothic","Noto Sans TC",system-ui,-apple-system,sans-serif !important; -webkit-text-stroke:.35px var(--stroke); text-shadow:0 1px 0 var(--glow); }
  html,body{ margin:0; color:var(--ink); background:linear-gradient(135deg,#e6dfff 0%, #dcd4ff 100%); }
  .panel{ max-width:1060px;margin:22px auto;background:rgba(255,255,255,.58);border:1px solid rgba(255,255,255,.65);border-radius:16px; padding:18px 18px 26px;box-shadow:0 10px 30px rgba(98,76,171,.12);backdrop-filter:blur(10px) saturate(120%); }
  h2{ margin:4px 0 20px; text-align:center; font-size:2.8rem; font-weight:700; letter-spacing:1px; -webkit-text-stroke:.7px var(--stroke); text-shadow:0 3px 4px rgba(255,255,255,.85); }

  /* æ§åˆ¶åˆ—ï¼ˆè¦ªå‹â†’ä»£è™Ÿâ†’æ¨‚å™¨â†’éŸ³ç¬¦â†’é‡è¨­â†’é–å®šï¼‰ */
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .row label{opacity:.92;white-space:nowrap;font-weight:400;-webkit-text-stroke:0;text-shadow:none}
  .row input,.row select,.row button{
    height:38px; font-size:14px; background:#fff; padding:8px 10px;
    border:1px solid var(--rim); border-radius:10px;
    -webkit-text-stroke:.25px rgba(0,0,0,.12); text-shadow:0 1px 0 rgba(255,255,255,.5);
  }
  /* è¼¸å…¥æ¡†çµ±ä¸€ 96px */
  #displayName,#code,#lastNote{ width:96px; font-weight:400; -webkit-text-stroke:0; text-shadow:none }
  /* é¸å–®ç½®ä¸­ã€è‡ªé©æ‡‰ */
  .row select{ width:auto; min-width:88px; text-align:center; text-align-last:center; -webkit-text-stroke:0; text-shadow:none; }
  .row select option{text-align:center}
  /* é‡è¨­/é–å®š 60px */
  .row button{ width:120px; cursor:pointer; font-weight:600 }
  .btn-compact{ width:60px !important; }
  .row button:disabled{opacity:.55;cursor:not-allowed}

  /* ç‹€æ…‹åˆ— */
  #status{ background:#eef2f7;border:1px solid var(--rim); border-radius:12px;padding:10px;margin-top:10px; font-size:14px;white-space:pre-wrap;color:#334155;text-align:center; }

  .kb-wrap{ overflow-x:hidden; background:linear-gradient(180deg,#f7f2ff 0%, #ede9fe 100%); border:1px solid var(--rim); border-radius:14px; margin-top:14px; }
  #keyboard{ position:relative; height:var(--kb-h); user-select:none; -webkit-user-select:none; touch-action:none; } /* touch-action:none æ”¹å–„é»æ“Šå‘½ä¸­ */

  /* ===== é‹¼ç´ï¼ˆé»‘éµç²¾æº–ç½®ä¸­ï¼‰ ===== */
  .white{
    position:absolute; bottom:0; height:100%;
    background:linear-gradient(#ffffff,#eceef3 72%,#d9dde5);
    border-radius:0 0 12px 12px;
    box-shadow:inset 0 -12px 16px rgba(0,0,0,.12),
               inset 0 1px 0 rgba(255,255,255,.9),
               0 1px 0 rgba(0,0,0,.04);
  }
  .white::after{ content:""; position:absolute; top:0; bottom:0; right:0; width:var(--sep); background:linear-gradient(transparent,#cfd3dc 50%,transparent); }
  .white:first-child::before{ content:""; position:absolute; top:0; bottom:0; left:0; width:var(--sep); background:linear-gradient(transparent,#cfd3dc 50%,transparent); }
  .white.active{filter:brightness(1.06)}
  .black{
    position:absolute; bottom:38%; height:62%;
    background:linear-gradient(#2d2f36,#0e0f13);
    border:1px solid #0b0d11; border-top:none;
    border-radius:0 0 10px 10px; z-index:5;
    box-shadow:inset 0 -6px 10px rgba(0,0,0,.45), 0 3px 10px rgba(0,0,0,.35);
    transform: translateX(-50%); /* ä»¥ left ç‚ºä¸­å¿ƒ */
  }
  .black.active{filter:brightness(1.22)}
  .label{
    position:absolute; bottom:12px; left:50%; transform:translateX(-50%);
    font-size:11px; color:#475569; background:#ffffffee; border:1px solid var(--rim);
    padding:2px 6px; border-radius:8px; -webkit-text-stroke:.25px rgba(0,0,0,.12); text-shadow:0 1px 0 rgba(255,255,255,.6);
  }

  /* ===== å‰ä»–ï¼ˆ1~12 å“ï¼›æ•´æ¢å¼¦å¯é»ï¼›æ›²ç·šå¼æŒ¯å‹•ï¼›ç´é ­å»¶ä¼¸å¼¦ï¼‰ ===== */
  .fretboard{
    position:relative; display:grid; grid-template-columns: repeat(12, 1fr);
    width:100%; height:var(--kb-h); background:#ececf3; border-radius:12px;
  }
  /* å·¦å´æœ¨è³ªé ­æ•èˆ‡ä¸Šæ• */
  .head{
    position:absolute; left:0; top:0; bottom:0; width:86px; z-index:2;
    background:
      linear-gradient(180deg, rgba(0,0,0,.08), transparent 40%),
      linear-gradient(180deg,#f0d6b8 0%, #e4c29a 55%, #d8b283 100%);
    border-right:1px solid rgba(120,90,60,.35); box-shadow: inset -8px 0 16px rgba(0,0,0,.08);
    border-radius:12px 0 0 12px; pointer-events:none;
  }
  .nut{
    position:absolute; left:86px; top:0; bottom:0; width:8px; z-index:3;
    background:linear-gradient(180deg,#e5e1d6,#c9c5ba);
    box-shadow: inset -1px 0 0 rgba(0,0,0,.25), inset 1px 0 0 rgba(255,255,255,.6);
    border-right:2px solid rgba(120,120,120,.45); pointer-events:none;
  }
  /* é ­æ•å€æ·¡æ·¡çš„å»¶ä¼¸å¼¦ï¼ˆä¸æ¶æˆ²ï¼‰ */
  .head-strings{
    position:absolute; left:0; width:86px; top:0; bottom:0; z-index:2; pointer-events:none;
    background:
      repeating-linear-gradient(
        to bottom,
        rgba(80,80,80,.25) 0px, rgba(80,80,80,.25) 1px, transparent 1px, transparent 12.5%
      );
    mix-blend-mode:multiply; opacity:.35;
    border-radius:12px 0 0 12px;
  }

  .fret-col{
    position:relative; background:linear-gradient(180deg,#f7f7fb,#ececf3);
    box-shadow: inset -2px 0 0 rgba(170,170,170,.95), inset -4px 0 0 rgba(255,255,255,.55);
  }

  /* å…­æ¢å¼¦ï¼ˆè¦–è¦ºç·šï¼‰ */
  .string{
    position:absolute; left:0; right:0; height:0; z-index:1;
    border-top:2px solid #6b7280; opacity:.9; filter:drop-shadow(0 1px 0 rgba(0,0,0,.1));
    transform-origin:center;
    /* æ¨¡æ“¬æ²¿å¼¦ç§»å‹•çš„å¾®å…‰ */
    background:
      linear-gradient(90deg, rgba(255,255,255,0) 0%, rgba(255,255,255,.35) 50%, rgba(255,255,255,0) 100%);
    background-size: 160px 1px;
    background-repeat: no-repeat;
    background-position: -160px 0;
  }
  /* ä¾å¼¦èª¿ç²—ç´°ï¼ˆä¸Šç´°ä¸‹ç²—ï¼‰ */
  .string[data-s="0"]{ border-top-width:2px; }
  .string[data-s="1"]{ border-top-width:2px; }
  .string[data-s="2"]{ border-top-width:2.5px; }
  .string[data-s="3"]{ border-top-width:3px; }
  .string[data-s="4"]{ border-top-width:3.5px; }
  .string[data-s="5"]{ border-top-width:4px; }

  /* é€æ˜çš„å¤§ hit å€ï¼ˆæé«˜å‘½ä¸­ç‡ï¼Œä¸æ”¹è¦–è¦ºï¼‰ */
  .hit-row{
    position:absolute; left:0; right:0; height:28px;
    transform:translateY(-50%); background:transparent; cursor:pointer;
  }
  @media (pointer:coarse){ .hit-row{ height:34px; } }

  /* æ›²ç·šå¼ï¼ˆè¿‘ä¼¼æ­£å¼¦ã€è¡°æ¸›ï¼‰æŒ¯å‹• + å¾®å…‰æƒé */
  .string.vibrate{
    animation: vibrCurve 360ms ease-out, shine 360ms ease-out;
  }
  @keyframes vibrCurve{
    0%   { transform:translateY(0); }
    10%  { transform:translateY(-3.2px); }
    20%  { transform:translateY(0); }
    30%  { transform:translateY(2.6px); }
    45%  { transform:translateY(0); }
    60%  { transform:translateY(-1.8px); }
    75%  { transform:translateY(0.6px); }
    100% { transform:translateY(0); }
  }
  @keyframes shine{
    0%{ background-position: -160px 0; opacity:.95; }
    100%{ background-position: 160px 0; opacity:.9; }
  }

  /* ===== å…©å€‹å½ˆè·³è¦–çª— ===== */
  .overlay{
    position: fixed; inset: 0; z-index: 9999;
    display:flex; align-items:center; justify-content:center;
    background: rgba(17,24,39,.35); backdrop-filter: blur(3px);
  }
  .overlay.hidden{ display:none; }
  .dialog{
    min-width: 300px; max-width: 92vw; background: rgba(255,255,255,.96);
    border:1px solid rgba(255,255,255,.85); border-radius:14px; padding:18px;
    box-shadow:0 18px 44px rgba(0,0,0,.18); text-align:center;
  }
  .dialog h3{ margin:0 0 8px; font-size:18px; }
  .dialog p{ margin:6px 0; line-height:1.6; }
  .dialog .actions{ display:flex; gap:10px; justify-content:center; margin-top:12px; }
  .dialog button{ width:120px; height:38px; border-radius:10px; border:1px solid var(--rim); background:#fff; cursor:pointer; font-weight:600; }
  .dialog button.primary{ background:#f8f5ff; }

  /* é–å®šå¾Œé®ç½© */
  #lockScreen{ position:fixed; inset:0; z-index:9998; display:none; background:transparent; }

  footer{ max-width:1060px;margin:8px auto 22px; text-align:center; color:#475569; font-size:12px; opacity:.9; }
</style>
<body>
  <div class="panel">
    <h2>ğŸ¼äº’å‹•éŸ³ç¬¦ğŸ¼</h2>

    <!-- æ’åºï¼šè¦ªå‹å§“åï½œå–å¾—ä»£è™Ÿï½œæ¨‚å™¨è½‰æ›ï½œéŸ³ç¬¦ç´€éŒ„ï½œé‡è¨­ï½œé–å®š -->
    <div class="row">
      <label for="displayName">è¦ªå‹å§“åï¼š</label>
      <input id="displayName" placeholder="ä¾‹å¦‚ï¼šå¼µå’©æš" />

      <label for="code">å–å¾—ä»£è™Ÿï¼š</label>
      <input id="code" placeholder="è«‹è¼¸å…¥ä»£è™Ÿ" />

      <label for="instrument">æ¨‚å™¨è½‰æ›ï¼š</label>
      <select id="instrument">
        <option value="piano" selected>é‹¼ç´</option>
        <option value="guitar">å‰ä»–</option>
      </select>

      <label for="lastNote">éŸ³ç¬¦ç´€éŒ„ï¼š</label>
      <input id="lastNote" placeholder="â€” , â€” , â€”" readonly />

      <button id="resetBtn" type="button" class="btn-compact">é‡è¨­</button>
      <button id="lockBtn" type="button" class="btn-compact" disabled>é–å®š</button>
    </div>

    <p id="status">å°šæœªåˆå§‹åŒ–</p>

    <div class="kb-wrap"><div id="keyboard"></div></div>
  </div>

  <!-- å½ˆè·³è¦–çª— â‘ ï¼šæ“ä½œèªªæ˜ -->
  <div id="guideOverlay" class="overlay" role="dialog" aria-modal="true" aria-labelledby="guideTitle">
    <div class="dialog">
      <h3 id="guideTitle">ğŸ“æ“ä½œèªªæ˜ğŸ“</h3>
      <p>ğŸ”»å¡«å…¥å§“ååŠå–å¾—çš„ä»£è™Ÿ</p>
      <p>â†“</p>
      <p>ğŸ”»é™å®šåŒä¸€ç¨®æ¨‚å™¨é¸ä¸‰å€‹éŸ³</p>
      <p>â†“</p>
      <p>ğŸ”»ä¸‰å€‹éŸ³ç¢ºèªå¾Œå³æŒ‰é–å®š</p>
      <p>â†“</p>
      <p>ğŸ”»è·³é€šçŸ¥å·²å®Œæˆå³å¯é€€å‡º</p>
      <p>â†“</p>
      <p>â—ï¸æœ€å¾Œè‹¥æ²’æŒ‰é–å®šä¸æœƒé€å‡º</p>
      <div class="actions">
        <button id="guideOk" class="primary">äº†è§£</button>
      </div>
    </div>
  </div>

  <!-- å½ˆè·³è¦–çª— â‘¡ï¼šå•Ÿç”¨è²éŸ³ / éŸ³è‰²è¼‰å…¥ -->
  <div id="unlockOverlay" class="overlay hidden" role="dialog" aria-modal="true" aria-labelledby="unlockTitle">
    <div class="dialog">
      <h3 id="unlockTitle">ğŸ“å•Ÿç”¨è²éŸ³ğŸ“</h3>
      <p>è«‹é–‹å•ŸéŸ³é‡ä¸¦é»æ“Šã€Œç¢ºå®šã€å•Ÿç”¨è²éŸ³</p>
      <p style="font-size:12px;opacity:.72;">iPhoneè«‹ç¢ºèªå´é‚ŠéœéŸ³éµé—œé–‰</p>
      <div class="actions">
        <button id="cancelUnlock">å–æ¶ˆ</button>
        <button id="confirmUnlock" class="primary">ç¢ºå®š</button>
      </div>
    </div>
  </div>

  <div id="lockScreen" aria-hidden="true"></div>

  <footer>Â© Copyright 2025 MYâ€˜s Version:b1.0.0</footer>

  <script src="https://cdn.jsdelivr.net/npm/tone@14.8.49/build/Tone.min.js"></script>
  <script>
    /* ===== ä¸»ç¨‹å¼ï¼ˆç¶­æŒæ—¢æœ‰è¡Œç‚ºï¼‰ ===== */
    const WEBHOOK = "https://script.google.com/macros/s/AKfycbw3rDKy-mjN93ValBMs28ndCFv5IbqjupDgn9rHvqYOqJwo5If3DdB1zVervdluT8YW/exec";
    const $ = s => document.querySelector(s);
    const setStatus = m => $('#status').textContent = m;

    let audioCtx=null, sampler=null, samplerReady=false, unlocked=false, hardLocked=false;
    let currentInstrument='piano';
    let selectedNotes = [];

    const PIANO_BASE=new URL('./piano/',location.href).href;
    const PIANO_URLS={'A1':'A1.mp3','C2':'C2.mp3','D#2':'Ds2.mp3','F#2':'Fs2.mp3','A2':'A2.mp3','C3':'C3.mp3','D#3':'Ds3.mp3','F#3':'Fs3.mp3','A3':'A3.mp3','C4':'C4.mp3','D#4':'Ds4.mp3','F#4':'Fs4.mp3','A4':'A4.mp3','C5':'C5.mp3'};
    const GUITAR_BASE=new URL('./guitar/',location.href).href;
    const GUITAR_URLS={'E2':'E2.wav','A2':'A2.wav','D3':'D3.wav','G3':'G3.wav','B3':'B3.wav','E4':'E4.wav'};

    const WHITE=["C3","D3","E3","F3","G3","A3","B3","C4","D4","E4","F4","G4","A4","B4"];
    const BLACK_AFTER={ 'C':'C#','D':'D#','F':'F#','G':'G#','A':'A#' };
    const MIN_WHITE_PX=64, TOTAL_WHITE=WHITE.length;

    // å‰ä»–
    const TUNING_MIDI = [40,45,50,55,59,64]; // E2 A2 D3 G3 B3 E4ï¼ˆè‡ªä¸‹è€Œä¸Šï¼‰
    const NOTE_NAMES = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
    const FRETS = 12; // 1~12 å“

    function midiToNoteName(midi){ const n = NOTE_NAMES[midi % 12]; const octave = Math.floor(midi/12) - 1; return n + octave; }

    // ===== è§£é–éŸ³è¨Š =====
    async function unlockAudio(){
      try{
        const Ctx=window.webkitAudioContext||window.AudioContext;
        if(!audioCtx) audioCtx=new Ctx({latencyHint:'interactive'});
        if(audioCtx.state!=='running') await audioCtx.resume();
        Tone.setContext(new Tone.Context(audioCtx));
        await Tone.start();
        loadSampler(currentInstrument);
        unlocked=true;
        $('#unlockOverlay').classList.add('hidden');
      }catch(e){ setStatus('å•Ÿç”¨å¤±æ•—ï¼š'+e.message); }
    }

    function loadSampler(inst='piano'){
      sampler?.dispose?.(); sampler=null; samplerReady=false;
      let urls=PIANO_URLS, base=PIANO_BASE, label='ğŸ¹ é‹¼ç´';
      if(inst==='guitar'){ urls=GUITAR_URLS; base=GUITAR_BASE; label='ğŸ¸ å‰ä»–'; }
      setStatus(label+'å–æ¨£è¼‰å…¥ä¸­â€¦');
      sampler=new Tone.Sampler({
        urls, release:1, baseUrl:base,
        onload:()=>{ samplerReady=true; setStatus(label+'å·²è¼‰å…¥ âœ…'); }
      }).toDestination();
    }

    function refreshNotesDisplay(){
      const parts = [selectedNotes[0]||'â€”', selectedNotes[1]||'â€”', selectedNotes[2]||'â€”'];
      $('#lastNote').value = parts.join(' , ');
    }

    function trigger(note){
      if(hardLocked) return;
      if(!samplerReady){ setStatus('éŸ³è‰²è¼‰å…¥ä¸­â€¦'); return; }
      sampler.triggerAttackRelease(note,'8n');

      if(selectedNotes.length < 3) selectedNotes.push(note);
      else selectedNotes[2] = note;

      refreshNotesDisplay();
      validateLockBtn();
    }

    function validateLockBtn(){
      const nameOk = ($('#displayName').value || '').trim().length > 0;
      const codeOk = ($('#code').value || '').trim().length > 0;
      const notesOk = selectedNotes.length === 3;
      $('#lockBtn').disabled = !(nameOk && codeOk && notesOk);
    }

    /* ===== é‹¼ç´æ¸²æŸ“ï¼ˆé»‘éµç½®ä¸­ï¼‰ ===== */
    function renderPiano(){
      const kb=$('#keyboard'); kb.innerHTML=''; kb.className=''; sizePiano();
      const keyW=100/TOTAL_WHITE;

      // ç™½éµ
      WHITE.forEach((note,i)=>{
        const w=document.createElement('div'); w.className='white'; w.dataset.note=note;
        w.style.left=`${i*keyW}%`; w.style.width=`${keyW}%`;
        if(note[0]==='C'||note[0]==='G'){ const lab=document.createElement('div'); lab.className='label'; lab.textContent=note; w.appendChild(lab); }
        w.addEventListener('pointerdown', ()=>{
          if(hardLocked) return;
          if(!unlocked){ $('#unlockOverlay').classList.remove('hidden'); return; }
          trigger(note); w.classList.add('active');
        });
        w.addEventListener('pointerup', ()=>w.classList.remove('active'));
        kb.appendChild(w);
      });

      // é»‘éµï¼ˆç½®ä¸­ï¼‰
      WHITE.forEach((note,i)=>{
        const l=note[0],sharp=BLACK_AFTER[l]?BLACK_AFTER[l]+note.slice(1):null;
        if(!sharp||(l==='A'&&i===TOTAL_WHITE-1)) return;
        const b=document.createElement('div'); b.className='black'; b.dataset.note=sharp;
        const blackWidthPct = keyW*0.62;
        b.style.width = `${blackWidthPct}%`;
        b.style.left  = `${(i+1)*keyW}%`;
        b.addEventListener('pointerdown', ()=>{
          if(hardLocked) return;
          if(!unlocked){ $('#unlockOverlay').classList.remove('hidden'); return; }
          trigger(sharp); b.classList.add('active');
        });
        b.addEventListener('pointerup', ()=>b.classList.remove('active'));
        kb.appendChild(b);
      });
    }

    function sizePiano(){
      const wrap=document.querySelector('.kb-wrap'); const kb=document.querySelector('#keyboard');
      const wrapW=wrap.clientWidth; const sep=parseInt(getComputedStyle(kb).getPropertyValue('--sep')||'2');
      const minW=WHITE.length*(64+sep); kb.style.width=(wrapW>=minW?wrapW-1:minW)+'px'; kb.style.height='var(--kb-h)';
    }

    /* ===== å‰ä»–ï¼š1~12 å“ï¼›æ•´æ¢å¼¦ hitï¼›å°±è¿‘å¸é™„ï¼›æ•´æ’æ›²ç·šæŒ¯å‹• ===== */
    function renderGuitar(){
      const kb=$('#keyboard'); kb.innerHTML=''; kb.className='fretboard'; kb.style.height='var(--kb-h)';

      // è£é£¾ï¼ˆé ­æ•ã€ä¸Šæ•ã€é ­æ•å»¶ä¼¸å¼¦ï¼‰
      const head=document.createElement('div'); head.className='head'; kb.appendChild(head);
      const headStr=document.createElement('div'); headStr.className='head-strings'; kb.appendChild(headStr);
      const nut =document.createElement('div');  nut.className='nut';  kb.appendChild(nut);

      // 12 å€‹å“
      for(let f=1; f<=FRETS; f++){
        const col=document.createElement('div'); col.className='fret-col';

        for(let s=0; s<6; s++){
          const y=(s+1)*(100/7);

          // é¡¯ç¤ºç”¨çš„å¼¦
          const str=document.createElement('div');
          str.className='string';
          str.dataset.s = String(s);
          str.style.top=`calc(${y}%)`;
          col.appendChild(str);

          // å¤§çš„ hit å€ï¼ˆæé«˜å‘½ä¸­ï¼‰
          const hit=document.createElement('div');
          hit.className='hit-row';
          hit.style.top=`calc(${y}%)`;
          col.appendChild(hit);
        }

        // äº‹ä»¶ä»£ç†ï¼šæ•´å€‹æ¬„ä½è¨ˆç®—ã€Œæœ€è¿‘å¼¦ã€
        col.addEventListener('pointerdown',(ev)=>{
          if(hardLocked) return;
          if(!unlocked){ $('#unlockOverlay').classList.remove('hidden'); return; }

          const rect = col.getBoundingClientRect();
          const y    = ev.clientY - rect.top;
          const slot = rect.height/7;
          let idx = Math.round(y/slot - 1); // 0~5
          idx = Math.max(0, Math.min(5, idx));

          // ç™¼è²ï¼ˆè©²å“è©²å¼¦ï¼‰
          const midi = TUNING_MIDI[5-idx] + f;
          const note = midiToNoteName(midi);
          trigger(note);

          // åŒä¸€æ¢å¼¦æ•´æ’æ›²ç·šæŒ¯å‹• + å¾®å…‰æƒé
          document.querySelectorAll(`.fret-col .string[data-s="${idx}"]`).forEach(el=>{
            el.classList.remove('vibrate'); // é‡æ–°è§¸ç™¼å‹•ç•«
            void el.offsetWidth;
            el.classList.add('vibrate');
            setTimeout(()=>el.classList.remove('vibrate'), 380);
          });
        });

        // æŒ‡æ¿åœ“é»ï¼š3/5/7/9ã€12ï¼ˆé›™é»ï¼‰
        if([3,5,7,9].includes(f)){
          const dot=document.createElement('div');
          dot.style.cssText='position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:16px;height:16px;border-radius:50%;background:#7a7f89;opacity:.85;box-shadow:0 1px 0 rgba(0,0,0,.25);pointer-events:none;';
          col.appendChild(dot);
        }
        if(f===12){
          const dd=document.createElement('div');
          dd.style.cssText='position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:16px;height:16px;border-radius:50%;background:#7a7f89;opacity:.85;box-shadow:0 1px 0 rgba(0,0,0,.25);pointer-events:none;';
          const before=document.createElement('div'), after=document.createElement('div');
          Object.assign(before.style,{position:'absolute',width:'16px',height:'16px',borderRadius:'50%',background:'#7a7f89',top:'50%',transform:'translateY(-50%)',left:'-14px',boxShadow:'0 1px 0 rgba(0,0,0,.25)'} );
          Object.assign(after .style,{position:'absolute',width:'16px',height:'16px',borderRadius:'50%',background:'#7a7f89',top:'50%',transform:'translateY(-50%)',right:'-14px',boxShadow:'0 1px 0 rgba(0,0,0,.25)'} );
          dd.appendChild(before); dd.appendChild(after); col.appendChild(dd);
        }

        kb.appendChild(col);
      }
    }

    /* äº‹ä»¶ */
    $('#instrument').addEventListener('change', ()=>{
      if(hardLocked) return;
      currentInstrument=$('#instrument').value;
      loadSampler(currentInstrument);
      if(currentInstrument==='guitar') renderGuitar(); else renderPiano();
      validateLockBtn();
    });
    $('#displayName').addEventListener('input', validateLockBtn);
    $('#code').addEventListener('input', validateLockBtn);

    // é‡è¨­ï¼šå€’é€€ 1 é¡†éŸ³
    $('#resetBtn').addEventListener('click', ()=>{
      if(hardLocked) return;
      if(selectedNotes.length>0){ selectedNotes.pop(); refreshNotesDisplay(); validateLockBtn(); }
    });

    // å½ˆè·³è¦–çª—ï¼šæ“ä½œèªªæ˜ â†’ é—œé–‰å¾Œè‡ªå‹•é–‹éŸ³è‰²è¦–çª—
    $('#guideOk').addEventListener('click', ()=>{
      $('#guideOverlay').classList.add('hidden');
      $('#unlockOverlay').classList.remove('hidden');  // ç›´æ¥æ‰“é–‹ç¬¬äºŒå€‹
    });

    // å½ˆè·³è¦–çª—ï¼šå•Ÿç”¨è²éŸ³
    $('#cancelUnlock').addEventListener('click', ()=>{ $('#unlockOverlay').classList.add('hidden'); });
    $('#confirmUnlock').addEventListener('click', unlockAudio, {once:true});

    window.addEventListener('keydown', (e)=>{ if(e.key==='Escape'){ $('#guideOverlay').classList.add('hidden'); $('#unlockOverlay').classList.add('hidden'); } });

    // é–å®šï¼šç«‹åˆ»é– UIï¼Œå†é€è³‡æ–™
    $('#lockBtn').addEventListener('click', async ()=>{
      if(hardLocked) return;
      const name = ($('#displayName').value||'').trim();
      const code = ($('#code').value||'').trim();
      if(!name || !code || selectedNotes.length!==3){ alert('è«‹å¡«å§“åã€ä»£è™Ÿä¸¦å½ˆæ»¿ 3 å€‹éŸ³å†é–å®š'); return; }

      setStatus('é€å‡ºä¸­â€¦');
      enterHardLock();

      const payload={ userId: code, displayName: name, instrument: currentInstrument, note: selectedNotes.join('|'), velocity: 1, sessionId: 'demo' };
      const controller = new AbortController(); const timer = setTimeout(()=>controller.abort(), 6000);

      try{
        const r = await fetch(WEBHOOK,{ method:'POST', headers:{'Content-Type':'text/plain'}, body: JSON.stringify(payload), signal: controller.signal });
        clearTimeout(timer);
        setStatus(r.ok ? 'å·²é€å‡ºéŸ³ç¬¦ï¼Œå¯é€€å‡ºæ­¤ä»‹é¢' : 'é€å‡ºå¤±æ•—ï¼ˆå·²é–å®šï¼‰');
      }catch(e){ setStatus('é€å‡ºé€¾æ™‚æˆ–å¤±æ•—ï¼ˆå·²é–å®šï¼‰'); }
    });

    function enterHardLock(){
      hardLocked = true;
      $('#displayName').disabled = true;
      $('#code').disabled = true;
      $('#instrument').disabled = true;
      $('#resetBtn').disabled = true;
      $('#lockBtn').disabled = true;
      $('#lockScreen').style.display = 'block';
    }

    window.addEventListener('resize', ()=>{ if(currentInstrument==='piano') sizePiano(); });
    window.addEventListener('orientationchange', ()=>{ if(currentInstrument==='piano') sizePiano(); });

    window.addEventListener('DOMContentLoaded', ()=>{
      renderPiano();                  // é è¨­é¡¯ç¤ºé‹¼ç´
      setStatus('ç­‰å¾…å•Ÿç”¨è²éŸ³â€¦');
      validateLockBtn();
      // ä¸€é€²ä¾†å…ˆé¡¯ç¤ºã€Œæ“ä½œèªªæ˜ã€è¦–çª—
      $('#guideOverlay').classList.remove('hidden');
    });
  </script>
</body>
</html>
