<!doctype html>
<html lang="zh-Hant">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>🎼互動音符</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    /* === 站內配色與欄寬（最常改）=== */
    /* ✅ 可調整：主配色、欄寬、陰影、間距 */
    :root{
      --brand:#D4BFAA;     /* ✅ 可調整：頁面背景主色 */
      --title:#A68A7C;     /* ✅ 可調整：標題字色 */
      --neutral:#E4E4E4;   /* ✅ 可調整：面板底色/邊框色 */
      --soft:#F5F1EC;      /* ✅ 可調整：狀態列/鍵盤底色 */
      --accent:#BFA5A0;    /* ✅ 可調整：重點文字顏色 */
      --rim:#E4E4E4;       /* ✅ 可調整：輸入框邊框色 */
      --ink:#0f172a;       /* ✅ 可調整：內文字色 */

      /* ✅ 可調整：各欄位寬度（桌機） */
      --w-displayName: 96px;
      --w-email: 261px;
      --w-code: 96px;
      --w-instrument: 96px;
      --w-lastNote: 125px;
      --w-lastNote-m: 160px;

      /* ✅ 可調整：排版間距 */
      --label-w:88px;   /* 標籤寬 */
      --gap:10px;       /* 欄間距 */
      --kb-h:280px;     /* 樂器高度 */
      --sep:2px;        /* 白鍵分隔線寬 */

      /* 🧩 進階可調：整體描邊/高光（改了會影響全站視覺） */
      --stroke:rgba(0,0,0,.18);
      --glow:rgba(255,255,255,.65);

      /* ✅ 可調整：提示按鈕與備註字級 */
      --w-hintbtn: 160px; /* 說明按鈕寬度 */
      --hint-fz: 12px;    /* 備註字體大小 */
      --hint-maxw: 520px; /* 備註最大寬度 */
    }

    /* === 全站字體與粗細（常改）=== */
    /* 🧩 進階可調：若想關閉整站粗體/描邊，改這裡 */
    *{ box-sizing:border-box; font-family:"Zen Maru Gothic","Noto Sans TC",system-ui,-apple-system,sans-serif !important; -webkit-text-stroke:.35px var(--stroke); text-shadow:0 1px 0 var(--glow); }
    html,body{ margin:0; color:var(--ink); background:var(--brand); font-weight:700; }
    /* 🔒 請勿更動流程：操作說明維持原樣（不粗體） */
    #guideOverlay .dialog, #guideOverlay .dialog *{ font-weight:500 !important; -webkit-text-stroke:0 !important; text-shadow:none !important; }

    /* === 版面容器（次常改）=== */
    /* ✅ 可調整：外框、圓角、陰影 */
    .bg-notes{ position:fixed; inset:0; width:100%; height:100%; object-fit:cover; opacity:.60; mix-blend-mode:multiply; filter:contrast(1.1); pointer-events:none; z-index:0; }
    .panel{ position:relative; z-index:1; max-width:1060px; margin:22px auto; background:var(--neutral); border:1px solid var(--neutral); border-radius:16px; padding:18px 18px 26px; box-shadow:0 10px 26px rgba(0,0,0,.10); backdrop-filter:blur(8px) saturate(115%); }

    /* === 標題（次常改）=== */
    /* ✅ 可調整：字級、陰影、描邊 */
    h2{ margin:4px 0 20px; text-align:center; font-size:2.8rem; font-weight:700; letter-spacing:1px; color:var(--title); -webkit-text-stroke:.6px rgba(0,0,0,.12); text-shadow:0 3px 4px rgba(255,255,255,.75); }

    /* === 表單列（常改）=== */
    /* ✅ 可調整：欄位高度、圓角、陰影 */
    .row{ display:flex; gap:var(--gap); align-items:center; flex-wrap:wrap; margin-top:10px; }
    .row label{ width:var(--label-w); opacity:.92; white-space:nowrap; font-weight:700; -webkit-text-stroke:0; text-shadow:none; }
    .row input,.row select,.row button{
      height:38px; font-size:14px; background:#fff; padding:8px 10px; border:1px solid var(--rim); border-radius:10px;
      -webkit-text-stroke:.25px rgba(0,0,0,.12); text-shadow:0 1px 0 rgba(255,255,255,.5);
    }
    /* ✅ 可調整：微立體陰影 */
    .row input,.row select{ box-shadow: 0 2px 0 rgba(0,0,0,.08), 0 2px 8px rgba(0,0,0,.04); }

    /* 欄位寬度（常改）*/
    #displayName{ width:var(--w-displayName); }  /* ✅ 可調整 */
    #email{ width:var(--w-email); }              /* ✅ 可調整 */
    #code{ width:var(--w-code); }                /* ✅ 可調整 */
    #instrument{ width:var(--w-instrument); }    /* ✅ 可調整 */
    #lastNote{ width:var(--w-lastNote); text-align:center; letter-spacing:.3px; } /* ✅ 可調整 */
    #lastNote::placeholder{ text-align:center; }

    /* 「音符紀錄」與上方「電子郵件」左緣對齊（桌機） */
    @media (min-width: 861px){ .align-to-email{ margin-left: calc(var(--w-displayName) - var(--w-instrument)); } } /* ✅ 可調整 */

    /* === 按鈕（常改）=== */
    .row select option{text-align:center}
    .row button{
      width:120px; cursor:pointer; font-weight:700;
      transition: transform .08s ease, box-shadow .08s ease, filter .08s ease;
      box-shadow: 0 2px 0 rgba(0,0,0,.15), 0 2px 8px rgba(0,0,0,.06);
    }
    .btn-compact{ width:60px !important; } /* ✅ 可調整：縮版按鈕寬度 */

    /* NEW: 說明按鈕（請點我）可自訂寬度，維持同高度 */
    #hintBtn{ width: var(--w-hintbtn) !important; } /* ✅ 可調整 */

    /* 互動狀態 */
    /* ✅ 可調整：互動視覺（改陰影/縮放） */
    .row button:disabled{ opacity:.55; cursor:not-allowed; }
    .row button:active, .row button.pressed{ transform: translateY(1px) scale(.99); box-shadow: 0 1px 0 rgba(0,0,0,.18), 0 1px 4px rgba(0,0,0,.06); filter: brightness(.98); }

    /* === 狀態列（常改）=== */
    /* ✅ 可調整：狀態列外觀 */
    #status{
      background: var(--soft); border:1px solid var(--neutral); border-radius:12px; padding:10px; margin-top:10px; font-size:14px;
      white-space:pre-wrap; text-align:center; color: var(--accent) !important; font-weight:700;
      -webkit-text-stroke:.35px rgba(0,0,0,.10);
      text-shadow:0 1px 0 rgba(255,255,255,.85), 0 3px 6px rgba(0,0,0,.04);
    }
    #status.ok,#status.busy,#status.err{
      color: var(--accent) !important; font-weight:700; -webkit-text-stroke:.35px rgba(0,0,0,.10);
      text-shadow:0 1px 0 rgba(255,255,255,.85), 0 3px 6px rgba(0,0,0,.04);
    }

    /* === NEW: 備註小浮層（與鎖定同排，按鈕點擊後顯示） === */
    /* ✅ 可調整：浮層寬、陰影、位置 */
    .actions-inline{ display:flex; gap:var(--gap); position:relative; }
    .hint-popover{
      position:absolute; right:0; top:44px;
      z-index:50;
      max-width: var(--hint-maxw); min-width: 260px;
      padding:10px 12px;
      font-size:var(--hint-fz); line-height:1.45; color:var(--accent);
      background:#fff; border:1px solid var(--accent); border-radius:12px;
      box-shadow:0 8px 24px rgba(0,0,0,.10), 0 2px 8px rgba(0,0,0,.06);
      display:none; white-space:normal;
      --arrow-x: calc(100% - 24px); /* 🧩 進階可調：箭頭預設位置 */
    }
    .hint-popover.show{ display:block; }
    /* ✅ 可調整：箭頭樣式 */
    .hint-popover::before{
      content:""; position:absolute; left:var(--arrow-x); top:-8px;
      transform:translateX(-50%);
      width:0; height:0; border-left:8px solid transparent; border-right:8px solid transparent; border-bottom:8px solid var(--accent);
    }
    .hint-popover::after{
      content:""; position:absolute; left:var(--arrow-x); top:-7px;
      transform:translateX(-50%);
      width:0; height:0; border-left:7px solid transparent; border-right:7px solid transparent; border-bottom:7px solid #fff;
    }

    /* === 鍵盤容器（次常改）=== */
    /* ✅ 可調整：邊框/圓角 */
    .kb-wrap{ overflow-x:auto; -webkit-overflow-scrolling:touch; background:var(--soft); border:1px solid var(--rim); border-radius:14px; margin-top:14px; }
    #keyboard{ position:relative; height:var(--kb-h); user-select:none; -webkit-user-select:none; touch-action: pan-x pan-y; }

    /* === 鋼琴樣式（幾乎不改）=== */
    /* 🔒 請勿更動流程：細緻光影比例，改了音感覺易失衡 */
    .white{ position:absolute; bottom:0; height:100%; background:linear-gradient(#ffffff,#eceef3 72%,#d9dde5); border-radius:0 0 12px 12px; box-shadow:inset 0 -12px 16px rgba(0,0,0,.12), inset 0 1px 0 rgba(255,255,255,.9), 0 1px 0 rgba(0,0,0,.04); }
    .white::after{ content:""; position:absolute; top:0; bottom:0; right:0; width:var(--sep); background:linear-gradient(transparent,#cfd3dc 50%,transparent); }
    .white:first-child::before{ content:""; position:absolute; top:0; bottom:0; left:0; width:var(--sep); background:linear-gradient(transparent,#cfd3dc 50%,transparent); }
    .white.active{ filter:brightness(1.06); }
    .black{ position:absolute; bottom:38%; height:62%; background:linear-gradient(#2d2f36,#0e0f13); border:1px solid #0b0d11; border-top:none; border-radius:0 0 10px 10px; z-index:5; box-shadow:inset 0 -6px 10px rgba(0,0,0,.45), 0 3px 10px rgba(0,0,0,.35); transform: translateX(-50%); }
    .black.active{ filter:brightness(1.22); }

    /* === 吉他樣式（幾乎不改）=== */
    /* 🔒 請勿更動流程：光影/結構和點擊區已調校 */
    .fretboard{ position:relative; display:grid; grid-template-columns: repeat(13, 1fr); width:100%; height:var(--kb-h); background:linear-gradient(180deg,#6b4f2e 0%, #5b4429 50%, #533c24 100%); border-radius:12px; box-shadow:inset 0 10px 20px rgba(0,0,0,.25), inset 0 -8px 16px rgba(0,0,0,.2); }
    .head{ position:absolute; left:0; top:0; bottom:0; width:86px; z-index:2; background:linear-gradient(180deg, rgba(0,0,0,.12), transparent 40%),linear-gradient(180deg,#7a5534 0%, #6b4f2e 55%, #5a3f24 100%); box-shadow: inset -8px 0 16px rgba(0,0,0,.18); border-radius:12px 0 0 12px; pointer-events:none; }
    .nut{ position:absolute; left:86px; top:0; bottom:0; width:8px; z-index:3; background:linear-gradient(180deg,#e5e1d6,#c9c5ba); box-shadow: inset -1px 0 0 rgba(0,0,0,.35), inset 1px 0 0 rgba(255,255,255,.6); border-right:2px solid rgba(120,120,120,.5); pointer-events:none; }
    .bridge{ position:absolute; right:0; top:0; bottom:0; width:10px; z-index:2; background:linear-gradient(180deg,#b9b6ad,#8f8c83); box-shadow: inset 1px 0 0 rgba(255,255,255,.5), inset -1px 0 0 rgba(0,0,0,.25); pointer-events:none; border-left:1px solid rgba(0,0,0,.18); }
    .fret-col{ position:relative; background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.02)); box-shadow: inset -2px 0 0 rgba(255,255,255,.18), inset -4px 0 0 rgba(0,0,0,.28); }
    /* 弦繞紋與高光 */
    .string{ --sw:2px; position:absolute; left:94px; right:0; height:0; z-index:3; border-top: var(--sw) solid transparent; transform-origin:center; filter:drop-shadow(0 1px 0 rgba(0,0,0,.18)); background: linear-gradient(90deg, rgba(255,255,255,0) 0%, rgba(255,255,255,.45) 50%, rgba(255,255,255,0) 100%); background-size:160px 1px; background-repeat:no-repeat; background-position:-160px 0; }
    .string::before{ content:""; position:absolute; left:0; right:0; top: calc(var(--sw) * -0.5); height: var(--sw); background: repeating-linear-gradient(90deg, #caa56b 0 2.4px, #906a3d 2.4px 3.1px), repeating-linear-gradient(90deg, rgba(255,255,255,.08) 0 2.4px, rgba(0,0,0,.10) 2.4px 3.1px), linear-gradient(180deg, rgba(255,255,255,.70), rgba(255,255,255,.15) 55%, rgba(0,0,0,.18) 100%); border-radius:999px; opacity:.98; pointer-events:none; }
    .string::after{ content:""; position:absolute; left:0; right:0; top: calc(var(--sw) * -0.5 + 0.2px); height: calc(var(--sw) * .25); background: linear-gradient(180deg, rgba(255,255,255,.55), rgba(255,255,255,0)); pointer-events:none; border-radius:999px; opacity:.9; }
    .string[data-s="2"]{ --sw:2.5px; }
    .string[data-s="3"]{ --sw:3px; }
    .string[data-s="4"]{ --sw:3.5px; }
    .string[data-s="5"]{ --sw:4px; }
    .head-line{ --sw:2px; position:absolute; left:0; width:86px; height:0; z-index:2; border-top: var(--sw) solid transparent; filter:drop-shadow(0 1px 0 rgba(0,0,0,.06)); pointer-events:none; }
    .head-line::before{ content:""; position:absolute; left:0; right:0; top: calc(var(--sw) * -0.5); height: var(--sw); background: repeating-linear-gradient(90deg, #caa56b 0 2.4px, #906a3d 2.4px 3.1px), repeating-linear-gradient(90deg, rgba(255,255,255,.08) 0 2.4px, rgba(0,0,0,.10) 2.4px 3.1px), linear-gradient(180deg, rgba(255,255,255,.55), rgba(255,255,255,0)); border-radius:999px; opacity:.98; }
    .head-line::after{ content:""; position:absolute; left:0; right:0; top: calc(var(--sw) * -0.5 + 0.2px); height: calc(var(--sw) * .25); background: linear-gradient(180deg, rgba(255,255,255,.55), rgba(255,255,255,0)); border-radius:999px; opacity:.9; }
    .head-line[data-s="2"]{ --sw:2.5px; }
    .head-line[data-s="3"]{ --sw:3px; }
    .head-line[data-s="4"]{ --sw:3.5px; }
    .head-line[data-s="5"]{ --sw:4px; }

    /* 觸控區與震動動畫（幾乎不改） */
    /* 🔒 請勿更動流程：點擊/動畫節奏 */
    .hit-row{ position:absolute; left:0; right:0; height:28px; transform:translateY(-50%); background:transparent; cursor:pointer; z-index:4; }
    @media (pointer:coarse){ .hit-row{ height:34px; } }
    .string.vibrate{ animation: vibrCurve 360ms ease-out, shine 360ms ease-out; }
    @keyframes vibrCurve{ 0%{transform:translateY(0)} 10%{transform:translateY(-3.2px)} 20%{transform:translateY(0)} 30%{transform:translateY(2.6px)} 45%{transform:translateY(0)} 60%{transform:translateY(-1.8px)} 75%{transform:translateY(0.6px)} 100%{transform:translateY(0)} }
    @keyframes shine{ 0%{ background-position:-160px 0; opacity:.95 } 100%{ background-position:160px 0; opacity:.96 } }

    /* === Overlay（兩個彈跳視窗樣式，偶爾會改）=== */
    /* ✅ 可調整：遮罩透明度、圓角、陰影 */
    .overlay{ position:fixed; inset:0; z-index:9999; display:flex; align-items:center; justify-content:center; background:rgba(17,24,39,.35); backdrop-filter:blur(3px); pointer-events:auto; }
    .overlay.hidden{ display:none; }
    .dialog{ min-width:300px; max-width:92vw; background:var(--soft); border:1px solid var(--neutral); border-radius:14px; padding:18px; box-shadow:0 18px 44px rgba(0,0,0,.18); text-align:center; pointer-events:auto; }
    .dialog h3{ margin:0 0 8px; font-size:18px; color:#6b5e52; }
    .dialog p.ios-hint{ margin:6px 0; line-height:1.6; font-size:13px; color:#d11; }
    .dialog .actions{ display:flex; gap:10px; justify-content:center; margin-top:12px; }
    .dialog button{ width:120px; height:38px; border-radius:10px; border:1px solid var(--rim); background:#fff; cursor:pointer; font-weight:700; }
    .dialog button.primary{ background:#fff; }

    #lockScreen{ position:fixed; inset:0; z-index:9998; display:none; background:transparent; }

    footer{ max-width:1060px;margin:8px auto 22px; text-align:center; color:#6b5e52; font-size:12px; opacity:.9; }

    /* === 手機直向（只調整直向，不動其他）=== */
    /* ✅ 可調整：直向排版比例 */
    @media (orientation:portrait){
      .row-line2, .row-line3{ width:100%; gap:12px; }
      .pair{ display:flex; align-items:center; gap:var(--gap); width:100%; }
      .actions-inline{ display:flex; gap:var(--gap); }
      .row-line2 .pair, .row-line3 .pair, .row-line3 .actions-inline{ flex: 0 0 100%; }
      .align-to-email{ margin-left:0 !important; }
      #lastNote{ width:var(--w-lastNote-m); }
    }
  </style>

  <body>
    <!-- === 背景圖（次常改）=== -->
    <!-- ✅ 可調整：背景圖檔案/版本 -->
    <img class="bg-notes" src="./assets/notes.png?v=4" alt="">
    <div class="panel">
      <h2>🎵互動音符🎵</h2>

      <!-- === 第 1 行（姓名 / Email / 代號）=== -->
      <div class="row row-line2">
        <div class="pair">
          <label for="displayName">親友姓名：</label>
          <input id="displayName" placeholder="例：張咩揚" />
        </div>
        <div class="pair">
          <label for="email">電子郵件：</label>
          <input id="email" placeholder="hey fill in your@email" inputmode="email" />
          <!-- ✅ 可調整（JS 會動態塞選項）：常見網域選單 -->
          <datalist id="emailDomains"></datalist>
        </div>
        <div class="pair">
          <label for="code">取得代號：</label>
          <input id="code" placeholder="請輸入代號" />
        </div>
      </div>

      <!-- === 第 2 行（樂器 / 音符紀錄 / 重設 / 鎖定 + 說明按鈕）=== -->
      <div class="row row-line3">
        <div class="pair">
          <label for="instrument">樂器轉換：</label>
          <select id="instrument">
            <option value="piano" selected>鋼琴</option>
            <option value="guitar">吉他</option>
          </select>
        </div>

        <div class="pair">
          <label for="lastNote" class="align-to-email">音符紀錄：</label>
          <input id="lastNote" placeholder="— , — , —" readonly />
        </div>

        <div class="actions-inline">
          <button id="resetBtn" type="button" class="btn-compact">重設</button>
          <button id="lockBtn" type="button" class="btn-compact" disabled>鎖定</button>
          <!-- NEW：與鎖定同排的說明觸發按鈕 -->
          <button id="hintBtn" type="button" class="btn-compact" aria-expanded="false" aria-controls="hintPopover" title="點我查看備註">先點我查看好咪🥺</button>
          <!-- NEW：備註小浮層 -->
          <div id="hintPopover" class="hint-popover" role="note" aria-live="polite">
            按「鎖定」後請稍候，本人有缺陷導致速度較慢🥲<br>
            確認送出成功，下方「狀態列」會立即通知您溜🎉
          </div>
        </div>
      </div>

      <!-- === 狀態列 === -->
      <p id="status">尚未初始化</p>

      <!-- === 樂器容器 === -->
      <div class="kb-wrap"><div id="keyboard"></div></div>
    </div>

    <!-- === 彈跳視窗 ①：操作說明（最先看到）=== -->
    <div id="guideOverlay" class="overlay" role="dialog" aria-modal="true" aria-labelledby="guideTitle">
      <div class="dialog">
        <h3 id="guideTitle">📍操作說明📍</h3>
        <p>🔻填入姓名、Email與取得的代號</p><p>↓</p>
        <p>🔻可選擇鋼琴或吉他中的三個音階</p><p>↓</p>
        <p>🔻三個音階確認後，一定要按鎖定</p><p>↓</p>
        <p>🔻鎖定完成後，會有通知是否成功</p><p>↓</p>
        <p>🔺若成功即可退出介面；反之再試</p><p>↓</p>
        <p>❗️沒按鎖定就是沒有送出就是彈個寂寞</p>
        <div class="actions"><button id="guideOk" class="primary">了解</button></div>
      </div>
    </div>

    <!-- === 彈跳視窗 ②：啟用聲音（第二個看到）=== -->
    <div id="unlockOverlay" class="overlay hidden" role="dialog" aria-modal="true" aria-labelledby="unlockTitle">
      <div class="dialog">
        <h3 id="unlockTitle">啟用聲音</h3>
        <p class="ios-hint">iPhone請確保側邊「靜音鍵」有開啟響鈴模式</p>
        <div class="actions">
          <button id="cancelUnlock">取消</button>
          <button id="confirmUnlock" class="primary">確定</button>
        </div>
      </div>
    </div>

    <div id="lockScreen" aria-hidden="true"></div>
    <footer>© Copyright 2025 MY‘s System Version:b1.0.227</footer>

    <!-- === 音源庫（不動即可）=== -->
    <script src="https://cdn.jsdelivr.net/npm/tone@14.8.49/build/Tone.min.js"></script>
    <script>
      /* === 常用參數（最常改）=== */
      const WEBHOOK = "https://script.google.com/macros/s/AKfycbzOzSU88Hk_gNazFyU8QqD1fdJgZ-j0GAcFcvIII5ptxsEX1rTR1pm6gYNexmQhydc9/exec"; // ✅ 可調整：你的 Apps Script 獨立版執行網址
      const TIMEOUT_MS = 10000;     // ✅ 可調整：POST 逾時（毫秒）
      const PRECHECK = true;        // ✅ 可調整：送出前是否先撞 /status
      const $ = s => document.querySelector(s); // 🔒 請勿更動流程：便捷選擇器

      /* ✅ 可調整：常見 Email 網域（會用來產生 datalist 補全） */
      const COMMON_DOMAINS = [
        'gmail.com','hotmail.com','outlook.com','icloud.com',
        'msn.com','live.com','yahoo.com.tw'
      ];

      /* === 一次性信箱黑名單 === */
      /* ✅ 可調整：想放寬可刪/減；想更嚴可新增 */
      const DISPOSABLE_DOMAINS = new Set([
        'mailinator.com','guerrillamail.com','sharklasers.com','10minutemail.com',
        'tempmail.com','tempmail.dev','temp-mail.org','moakt.com','yopmail.com',
        'throwawaymail.com','trashmail.com','maildrop.cc','dispostable.com','mail-temp.com'
      ]);

      /* === Email 檢核 === */
      /* 🔒 請勿更動流程：這段和後端對應，影響鎖定鍵可用性 */
      function validEmail(v){
        const s=(v||'').trim();
        if(!/^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/.test(s)) return false;
        if(/\.\./.test(s)) return false;
        const [local,domain] = s.split('@');
        if(/^[0-9]+$/.test(local)) return false;
        if(/[._%+-]$/.test(local)) return false;
        const labels = (domain||'').split('.');
        if(labels.some(l=>!l || l.length>63 || /^-/.test(l) || /-$/.test(l))) return false;
        const tld = labels[labels.length-1]||'';
        if(!/^[A-Za-z]{2,24}$/.test(tld)) return false;
        const d = (domain||'').toLowerCase();
        for(const bad of DISPOSABLE_DOMAINS){ if(d===bad || d.endsWith('.'+bad)) return false; }
        return true;
      }

      /* === 狀態列 === */
      /* 🧩 進階可調：要改判斷關鍵字/樣式，可改這裡與上方 CSS */
      const setStatus = m => {
        const el = $('#status'); el.textContent = m; el.classList.remove('ok','busy','err');
        if(/已載入/.test(m)) el.classList.add('ok');
        else if(/送出中/.test(m)) el.classList.add('busy');
        else if(/❌|失敗|逾時|找尋不到|已過|格式不正確|忙碌/.test(m)) el.classList.add('err');
      };

      /* === 全域變數 === */
      /* 🔒 請勿更動流程：音源/鎖定/選音邏輯 */
      let audioCtx=null, sampler=null, samplerReady=false, unlocked=false, hardLocked=false;
      let currentInstrument='piano';
      let selectedNotes = [];
      let selectedInsts = [];

      /* === 音色路徑 === */
      /* ✅ 可調整：如音色檔存放路徑不同，可改 baseUrl 或檔名表 */
      const PIANO_BASE = new URL('./piano/', location.href).href;
      const GUITAR_BASE = new URL('./guitar/', location.href).href;
      const PIANO_URLS = {'A1':'A1.mp3','C2':'C2.mp3','D#2':'Ds2.mp3','F#2':'Fs2.mp3','A2':'A2.mp3','C3':'C3.mp3','D#3':'Ds3.mp3','F#3':'Fs3.mp3','A3':'A3.mp3','C4':'C4.mp3','D#4':'Ds4.mp3','F#4':'Fs4.mp3','A4':'A4.mp3','C5':'C5.mp3'};
      const GUITAR_URLS = {'E2':'E2.wav','A2':'A2.wav','D3':'D3.wav','G3':'G3.wav','B3':'B3.wav','E4':'E4.wav'};

      /* === 鋼琴音階 === */
      /* 🔒 請勿更動流程：鍵位計算依賴這些設定 */
      const WHITE=["C3","D3","E3","F3","G3","A3","B3","C4","D4","E4","F4","G4","A4","B4"];
      const BLACK_AFTER={ 'C':'C#','D':'D#','F':'F#','G':'G#','A':'A#' };
      const MIN_WHITE_PX=64, TOTAL_WHITE=WHITE.length;

      /* === 吉他音名計算 === */
      /* 🔒 請勿更動流程：音高轉換依賴這些設定 */
      const TUNING_MIDI = [40,45,50,55,59,64];
      const NOTE_NAMES = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];

      /* === 快速查詢 === */
      /* 🔒 請勿更動流程：與後端 /status 對應 */
      async function getStatusFast(code, email, signal){
        try{
          const url = WEBHOOK + '?action=status&code=' + encodeURIComponent(code) + '&email=' + encodeURIComponent(email);
          const r = await fetch(url, { method:'GET', cache:'no-store', signal });
          if(!r.ok) return { ok:false };
          const j = await r.json();
          return { ok:true, status: j.status || 'none' };
        }catch(_){ return { ok:false }; }
      }

      /* === 啟用音訊 === */
      /* 🔒 請勿更動流程：行動裝置互動限制需要用戶手勢解鎖 */
      async function unlockAudio(){
        try{
          const Ctx=window.webkitAudioContext||window.AudioContext;
          if(!audioCtx) audioCtx=new Ctx({latencyHint:'interactive'});
          if(audioCtx.state!=='running') await audioCtx.resume();
          Tone.setContext(new Tone.Context(audioCtx));
          await Tone.start();
          loadSampler(currentInstrument);
          unlocked=true;
          $('#unlockOverlay').classList.add('hidden');
        }catch(e){ setStatus('啟用失敗：'+e.message); }
      }

      // === 音色檔存在性探測（進階偵錯） ================================
      // ✅ 可調整：timeoutMs（探測逾時毫秒）
      // 回傳 true/false，不拋錯；只用來提醒是否 404 / CORS。
      async function probeAsset(url, timeoutMs=6000){ // ✅ 可調整
        try{
          const ctl = new AbortController();
          const t = setTimeout(()=>ctl.abort(), timeoutMs);
          // 先 HEAD；若主機不支援 HEAD 再退回 GET
          let r = await fetch(url, { method:'HEAD', cache:'no-store', signal:ctl.signal });
          if(!r.ok || Number(r.headers.get('content-length'))===0){
            r = await fetch(url, { method:'GET', cache:'no-store', signal:ctl.signal });
          }
          clearTimeout(t);
          return r.ok;
        }catch(_){ return false; }
      }

      /* === 切換音色 === */
      /* 🔒 請勿更動流程：音源載入與狀態聯動（加入逾時保底＋檔案探測） */
      function loadSampler(inst='piano'){
        sampler?.dispose?.(); sampler=null; samplerReady=false;

        // ✅ 可調整：暱稱圖示與庫來源
        let urls=PIANO_URLS, base=PIANO_BASE, label='🎹 ';
        if(inst==='guitar'){ urls=GUITAR_URLS; base=GUITAR_BASE; label='🎸 '; }

        setStatus(label+'載入中…');

        // ① 探測其中一個檔案是否存在（避免永遠卡住）
        const firstKey = Object.keys(urls)[0];
        const testUrl  = base + urls[firstKey];
        probeAsset(testUrl, 5000 /* ✅ 可調整：探測逾時 */).then(ok=>{
          if(!ok){
            setStatus(
              '⚠️ 無法讀取音色檔\n'//請檢查路徑/大小寫/CORS：\n' + testUrl （目錄需與此頁同層；檔名表要跟實檔一致：如 D#4→Ds4.mp3）
            );
          }
        });

        // ② 建立 Sampler（正常會觸發 onload）
        try{
          sampler=new Tone.Sampler({
            urls,
            release:1,                 // ✅ 可調整：釋放尾音
            baseUrl:base,
            onload:()=>{               // 載入成功
              samplerReady=true;
              setStatus(label+'已載入 ✅');
            }
          }).toDestination();
        }catch(e){
          setStatus('❌ 音色初始化失敗：'+e.message);
          return;
        }

        // ③ 看門狗：超過 N 秒仍未 ready，顯示可操作的排錯提示
        const WATCH_MS=9000;           // ✅ 可調整：載入逾時判定毫秒
        setTimeout(()=>{
          if(!samplerReady){
            setStatus(
              '⏱️ 載入超時\n' // 可能原因檔案路徑不對 / 大小寫不符（主機區分大小寫 目錄位置不同（目前 baseUrl：'+ base +'）不同網域造成 CORS 擋住 檔名表與實際檔名不一致（例：D#4 → Ds4.mp3）
            );
          }
        }, WATCH_MS);
      }

      /* === 三音顯示 === */
      /* 🔒 請勿更動流程 */
      function refreshNotesDisplay(){ const parts=[selectedNotes[0]||'—', selectedNotes[1]||'—', selectedNotes[2]||'—']; $('#lastNote').value = parts.join(' , '); }

      /* === 播音 === */
      /* 🔒 請勿更動流程 */
      function trigger(note){
        if(hardLocked) return;
        if(!samplerReady){ setStatus('音色載入中…'); return; }
        sampler.triggerAttackRelease(note,'8n');
        if(selectedNotes.length<3){ selectedNotes.push(note); selectedInsts.push(currentInstrument); }
        else { selectedNotes[2]=note; selectedInsts[2]=currentInstrument; }
        refreshNotesDisplay(); validateLockBtn();
      }

      /* === 鎖定鍵可用性 === */
      /* 🔒 請勿更動流程：這裡與 validEmail 互鎖 */
      function validateLockBtn(){
        const nameOk = ($('#displayName').value||'').trim().length>0;
        const codeOk = ($('#code').value||'').trim().length>0;
        const emailOk = validEmail($('#email').value);
        const notesOk = selectedNotes.length===3;
        $('#lockBtn').disabled = !(nameOk && codeOk && emailOk && notesOk);
      }

      /* === 事件綁定（表單） === */
      /* 🔒 請勿更動流程 */
      $('#instrument').addEventListener('change', ()=>{
        if(hardLocked) return;
        currentInstrument=$('#instrument').value;
        loadSampler(currentInstrument);
        if(currentInstrument==='guitar') renderGuitar(); else renderPiano();
        validateLockBtn();
      });
      $('#displayName').addEventListener('input', validateLockBtn);
      $('#code').addEventListener('input', validateLockBtn);

      /* ✅ Email 輸入：含 @ 時動態建立「完整 email」候選清單；否則移除 list */
      /* ✅ 可調整：如要固定顯示所有網域，可把 startsWith 的濾掉 */
      const emailInput = $('#email');
      const emailList  = $('#emailDomains');
      $('#email').addEventListener('input', ()=>{
        const v = emailInput.value;
        if(v.includes('@')){
          const [local,frag=''] = v.split('@');
          const lowerFrag = frag.toLowerCase();
          const options = (local ? COMMON_DOMAINS : [])
            .filter(d => d.startsWith(lowerFrag))
            .map(d => `<option value="${local}@${d}"></option>`)
            .join('');
          emailList.innerHTML = options || (local ? COMMON_DOMAINS.map(d=>`<option value="${local}@${d}"></option>`).join('') : '');
          emailInput.setAttribute('list','emailDomains');
        }else{
          emailInput.removeAttribute('list');
          emailList.innerHTML = '';
        }
        validateLockBtn();
      });

      /* === 重設 === */
      /* 🔒 請勿更動流程 */
      $('#resetBtn').addEventListener('click', ()=>{
        if(hardLocked) return;
        if(selectedNotes.length>0){ selectedNotes.pop(); selectedInsts.pop(); refreshNotesDisplay(); validateLockBtn(); }
      });

      /* === 說明按鈕 → 小浮層 === */
      /* 🧩 進階可調：若想固定顯示/改位置，可改 positionArrow 與 CSS 變數 */
      const hintBtn = $('#hintBtn');
      const hintPop = $('#hintPopover');

      function positionArrow(){
        const popRect = hintPop.getBoundingClientRect();
        const btnRect = hintBtn.getBoundingClientRect();
        const x = (btnRect.left + btnRect.width/2) - popRect.left;
        const clamped = Math.max(16, Math.min(popRect.width-16, x));
        hintPop.style.setProperty('--arrow-x', clamped + 'px');
      }
      function closeHint(){ hintPop.classList.remove('show'); hintBtn.setAttribute('aria-expanded','false'); }
      hintBtn.addEventListener('click', (e)=>{
        const showing = hintPop.classList.toggle('show');
        hintBtn.setAttribute('aria-expanded', showing ? 'true' : 'false');
        if(showing){ positionArrow(); }
        e.stopPropagation();
      });
      document.addEventListener('click', (e)=>{
        if(!hintPop.classList.contains('show')) return;
        const within = hintPop.contains(e.target) || hintBtn.contains(e.target);
        if(!within) closeHint();
      });
      window.addEventListener('resize', ()=>{ if(hintPop.classList.contains('show')) positionArrow(); });
      window.addEventListener('orientationchange', ()=>{ setTimeout(()=>{ if(hintPop.classList.contains('show')) positionArrow(); }, 250); });
      window.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeHint(); });

      /* === 兩個彈跳視窗（事件委派＋touchend 支援，iOS 可點）=== */
      /* 🔒 請勿更動流程 */
      function hide(el){ el.classList.add('hidden'); }
      function show(el){ el.classList.remove('hidden'); }
      ['click','touchend'].forEach(evt=>{
        document.addEventListener(evt,(e)=>{
          const t = e.target;
          if(t.id==='guideOk'){
            hide(document.getElementById('guideOverlay'));
            show(document.getElementById('unlockOverlay'));
            e.preventDefault();
          }else if(t.id==='cancelUnlock'){
            hide(document.getElementById('unlockOverlay'));
            e.preventDefault();
          }else if(t.id==='confirmUnlock'){
            unlockAudio(); hide(document.getElementById('unlockOverlay'));
            e.preventDefault();
          }
        }, {passive:true});
      });

      /* === 送出（鎖定） === */
      /* 🔒 請勿更動流程：與後端錯誤碼對應；訊息內容可微調 */
      $('#lockBtn').addEventListener('click', async ()=>{
        if(hardLocked) return;
        const name=($('#displayName').value||'').trim();
        const code=($('#code').value||'').trim();
        const email=($('#email').value||'').trim();
        if(!name||!code||!validEmail(email)||selectedNotes.length!==3){ alert('請填姓名、代號、Email 並彈滿 3 個音再鎖定'); return; }

        if(PRECHECK){
          try{
            const pre = await getStatusFast(code, email);
            if(pre.ok){
              if(pre.status==='used'){
                // ✅ 不 return，讓後端精準判斷（duplicate+deadline_passed / duplicate+code_not_found）
                setStatus('📝 已填寫過，正在確認是否已過期或代號問題…');
              }else if(pre.status==='inflight'){
                setStatus('🕒 資料處理中，請勿重複送出⛔');
                return;
              }
            }
          }catch(_e){}
        }

        setStatus('⏳ 送出中…');
        const instrumentField = selectedInsts.length ? selectedInsts.join(',') : currentInstrument;
        const payload={ userId:code, displayName:name, instrument:instrumentField, note:selectedNotes.join(','), velocity:1, sessionId:'demo', email };

        const controller=new AbortController();
        const timer=setTimeout(()=>controller.abort(),TIMEOUT_MS);
        try{
          const r=await fetch(WEBHOOK,{ method:'POST', headers:{'Content-Type':'text/plain'}, body:JSON.stringify(payload), signal:controller.signal });
          clearTimeout(timer);
          if(r.headers.get('content-type')?.includes('application/json')){
            const data = await r.json();
            if(data.ok){ setStatus('✅ 已送出成功，可退安囉'); enterHardLock(); }
            else{
              let msg='❌ 送出失敗'; const err=String(data.error||'');
              if(err.includes('duplicate+deadline_passed')) msg='📅 已填寫過囉，且已過截止日💔';
              else if(err.includes('duplicate+code_not_found')) msg='🔎 已填寫過囉，且代號不存在👀';
              else if(err==='duplicate') msg='📝 已填寫過囉，想要更換音階請洽ㄟ咪🙏';
              else if(err==='email_required') msg='⚠️ Email缺少或格式不正確，跪求真正的mail🙇‍♂️';
              else if(err==='email_domain_invalid') msg='🌐 Email網域無法收信，請確認拼字或更換📮';
              else if(err==='deadline_passed') msg='📣 已過填寫截止日，但還可在這玩耍唷👣';
              else if(err==='code_not_found') msg='🔎 找尋不到代號，請洽新人🤵🏻‍♂️👰🏻‍♀️';
              else if(err==='busy') msg='⚠️ 系統忙碌，稍後再試🌀';
              setStatus(msg);
            }
          }else{
            if(r.ok){ setStatus('✅ 已送出成功，可退安囉'); enterHardLock(); }
            else{ setStatus('❌ 送出失敗'); }
          }
        }catch(e){
          try{
            const post = await getStatusFast(code, email);
            if(post.ok){
              if(post.status==='used'){ setStatus('✅ 已送出成功，可退安唷'); enterHardLock(); return; }
              if(post.status==='inflight'){ setStatus('⏳ 可能已送達，伺服器處理中，請勿重複送出⛔'); return; }
            }
          }catch(_e){}
          setStatus('❌ 送出逾時或失敗');
        }
      });

      /* === 成功後凍結畫面 === */
      /* 🔒 請勿更動流程 */
      function enterHardLock(){
        hardLocked=true;
        $('#displayName').disabled=true; $('#code').disabled=true; $('#email').disabled=true; $('#instrument').disabled=true;
        $('#resetBtn').disabled=true; $('#lockBtn').disabled=true;
        $('#lockScreen').style.display='block';
      }

      /* === 鋼琴繪製（移除鍵帽標籤）=== */
      /* 🔒 請勿更動流程 */
      function renderPiano(){
        const kb=$('#keyboard'); kb.innerHTML=''; kb.className='';
        sizePiano();
        const keyW=100/TOTAL_WHITE;
        WHITE.forEach((note,i)=>{
          const w=document.createElement('div'); w.className='white'; w.dataset.note=note;
          w.style.left=(i*keyW)+'%'; w.style.width=keyW+'%';
          w.addEventListener('pointerdown', ()=>{ if(hardLocked) return; if(!unlocked){ $('#unlockOverlay').classList.remove('hidden'); return; } trigger(note); w.classList.add('active'); });
          w.addEventListener('pointerup', ()=>w.classList.remove('active'));
          kb.appendChild(w);
        });
        WHITE.forEach((note,i)=>{
          const l=note[0], sharp = BLACK_AFTER[l]? (BLACK_AFTER[l]+note.slice(1)) : null;
          if(!sharp || (l==='A' && i===TOTAL_WHITE-1)) return;
          const b=document.createElement('div'); b.className='black'; b.dataset.note=sharp;
          const blackWidthPct = keyW*0.62; b.style.width = blackWidthPct+'%'; b.style.left=((i+1)*keyW)+'%';
          b.addEventListener('pointerdown', ()=>{ if(hardLocked) return; if(!unlocked){ $('#unlockOverlay').classList.remove('hidden'); return; } trigger(sharp); b.classList.add('active'); });
          b.addEventListener('pointerup', ()=>b.classList.remove('active'));
          kb.appendChild(b);
        });
      }

      /* === 鋼琴尺寸 === */
      /* 🔒 請勿更動流程 */
      function sizePiano(){
        const wrap=document.querySelector('.kb-wrap'); const kb=document.querySelector('#keyboard');
        const wrapW=wrap.clientWidth; const sep=parseInt(getComputedStyle(kb).getPropertyValue('--sep')||'2',10);
        const minW=WHITE.length*(MIN_WHITE_PX+sep);
        kb.style.width=(wrapW>=minW?wrapW-1:minW)+'px'; kb.style.height='var(--kb-h)';
      }

      /* === 吉他繪製 === */
      /* 🔒 請勿更動流程 */
      function renderGuitar(){
        const kb=$('#keyboard'); kb.innerHTML=''; kb.className='fretboard'; kb.style.height='var(--kb-h)';
        const head=document.createElement('div'); head.className='head'; kb.appendChild(head);
        const nut =document.createElement('div');  nut.className='nut';  kb.appendChild(nut);
        const bridge=document.createElement('div'); bridge.className='bridge'; kb.appendChild(bridge);
        for(let s=0;s<6;s++){
          const y=(s+1)*(100/7);
          const str=document.createElement('div'); str.className='string'; str.dataset.s=String(s); str.style.top = `${y}%`; kb.appendChild(str);
          const hline=document.createElement('div'); hline.className='head-line'; hline.dataset.s=String(s); hline.style.top = `${y}%`; kb.appendChild(hline);
        }
        for(let f=1; f<=13; f++){
          const col=document.createElement('div'); col.className='fret-col';
          for(let s=0; s<6; s++){
            const y=(s+1)*(100/7);
            const hit=document.createElement('div'); hit.className='hit-row'; hit.style.top = `${y}%`; col.appendChild(hit);
          }
          if([4,6,8,10].includes(f)){
            const dot=document.createElement('div'); dot.style.cssText='position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:16px;height:16px;border-radius:50%;background:#dbc6a4;opacity:.9;box-shadow:0 1px 0 rgba(0,0,0,.35);pointer-events:none;'; col.appendChild(dot);
          }else if(f===13){
            const dot1=document.createElement('div'); dot1.style.cssText='position:absolute;left:50%;top:38%;transform:translate(-50%,-50%);width:14px;height:14px;border-radius:50%;background:#dbc6a4;opacity:.9;box-shadow:0 1px 0 rgba(0,0,0,.35);pointer-events:none;';
            const dot2=document.createElement('div'); dot2.style.cssText='position:absolute;left:50%;top:62%;transform:translate(-50%,-50%);width:14px;height:14px;border-radius:50%;background:#dbc6a4;opacity:.9;box-shadow:0 1px 0 rgba(0,0,0,.35);pointer-events:none;';
            col.appendChild(dot1); col.appendChild(dot2);
          }
          col.addEventListener('pointerdown',(ev)=>{
            if(hardLocked) return;
            if(!unlocked){ $('#unlockOverlay').classList.remove('hidden'); return; }
            const rect = col.getBoundingClientRect();
            const y = ev.clientY - rect.top;
            const slot = rect.height/7;
            let idx = Math.round(y/slot - 1);
            idx = Math.max(0, Math.min(5, idx));
            if(f<=12){
              const midi = TUNING_MIDI[5-idx] + f;
              const note = NOTE_NAMES[midi % 12] + (Math.floor(midi/12) - 1);
              trigger(note);
            }
            const target = kb.querySelector(`.string[data-s="${idx}"]`);
            if(target){
              target.classList.remove('vibrate'); void target.offsetWidth; target.classList.add('vibrate');
              setTimeout(()=>target.classList.remove('vibrate'), 380);
            }
          });
          kb.appendChild(col);
        }
      }

      /* === 視窗尺寸 === */
      /* 🔒 請勿更動流程 */
      window.addEventListener('resize', ()=>{ if(currentInstrument==='piano') sizePiano(); });
      window.addEventListener('orientationchange', ()=>{ if(currentInstrument==='piano') sizePiano(); });

      /* === 初始化 === */
      /* 🔒 請勿更動流程 */
      window.addEventListener('DOMContentLoaded', ()=>{
        renderPiano(); setStatus('等待啟用聲音…'); validateLockBtn();
        $('#guideOverlay').classList.remove('hidden');
      });
    </script>
  </body>
</html>

